/**
 * ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู - SAM PRO
 * ุชุทููุฑ: MOHANNAD AHMAD
 * ุงูููู ุงูุฑุฆูุณู ููุชุทุจูู
 */

// ุจูุงูุงุช ุงูุชุทุจูู (ูุญุงูุงุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช)
let appData = {
    customers: [
        {
            id: 1,
            name: 'ุฃุญูุฏ ูุญูุฏ',
            phone: '0123456789',
            email: 'ahmed@example.com',
            address: 'ุฏูุดู - ุงููุฒุฉ',
            taxNumber: '12345',
            creditLimit: 100000,
            currentBalance: 15000,
            createdAt: '2025-01-01',
            lastTransactionDate: null,
            totalSales: 0,
            totalPayments: 0,
            transactionCount: 0,
            balances: {
                'SYP': 15000
            }
        },
        {
            id: 2,
            name: 'ูุงุทูุฉ ุนูู',
            phone: '0987654321',
            email: 'fatima@example.com',
            address: 'ุญูุจ - ุงูุตุงูุญูู',
            taxNumber: '67890',
            creditLimit: 50000,
            currentBalance: -5000,
            createdAt: '2025-01-02',
            lastTransactionDate: null,
            totalSales: 0,
            totalPayments: 0,
            transactionCount: 0,
            balances: {
                'SYP': -5000
            }
        }
    ],
    suppliers: [
        {
            id: 1,
            name: 'ุดุฑูุฉ ุงูุฃูู ููุชุฌุงุฑุฉ',
            phone: '0111222333',
            email: 'amal@company.com',
            address: 'ุฏูุดู - ุงูุชุฌุงุฑุฉ',
            taxNumber: '11111',
            currentBalance: 25000,
            createdAt: '2025-01-01',
            lastTransactionDate: null,
            totalPurchases: 0,
            totalPayments: 0,
            transactionCount: 0,
            balances: {
                'SYP': 25000
            }
        }
    ],
    products: [
        {
            id: 1,
            code: 'P001',
            name: 'ูุงุจุชูุจ ุฏูู',
            description: 'ูุงุจุชูุจ ุฏูู ุงูุณุจุงูุฑูู 15',
            unit: 'ูุทุนุฉ',
            costPrice: 800000,
            sellingPrice: 1000000,
            quantity: 10,
            minQuantity: 5,
            warehouseId: 1,
            category: 'ุฅููุชุฑูููุงุช'
        },
        {
            id: 2,
            code: 'P002',
            name: 'ูุงูุณ ูุงุณููู',
            description: 'ูุงูุณ ูุงุณููู ููุฌูุชู',
            unit: 'ูุทุนุฉ',
            costPrice: 15000,
            sellingPrice: 20000,
            quantity: 3,
            minQuantity: 10,
            warehouseId: 1,
            category: 'ุฅูุณุณูุงุฑุงุช'
        }
    ],
    warehouses: [
        {
            id: 1,
            name: 'ุงููุฎุฒู ุงูุฑุฆูุณู',
            location: 'ุฏูุดู - ุงูููุทูุฉ ุงูุตูุงุนูุฉ',
            manager: 'ูุญูุฏ ุฃุญูุฏ',
            phone: '0123456789'
        }
    ],
    invoices: [
        {
            id: 1,
            invoiceNumber: 'SALE-2025-0001',
            invoiceType: 'sale',
            invoiceDate: '2025-01-15',
            customerId: 1,
            subtotal: 1000000,
            discountRate: 5,
            discountAmount: 50000,
            taxRate: 10,
            taxAmount: 95000,
            totalAmount: 1045000,
            paidAmount: 500000,
            remainingAmount: 545000,
            status: 'confirmed',
            notes: 'ูุงุชูุฑุฉ ูุจูุนุงุช ุชุฌุฑูุจูุฉ',
            items: [
                {
                    productId: 1,
                    quantity: 1,
                    unitPrice: 1000000,
                    totalAmount: 1000000
                }
            ],
            createdAt: '2025-01-15T10:30:00.000Z'
        },
        {
            id: 2,
            invoiceNumber: 'SALE-2025-0002',
            invoiceType: 'sale',
            invoiceDate: '2025-01-16',
            customerId: 2,
            subtotal: 125000,
            discountRate: 0,
            discountAmount: 0,
            taxRate: 10,
            taxAmount: 12500,
            totalAmount: 137500,
            paidAmount: 137500,
            remainingAmount: 0,
            status: 'confirmed',
            notes: 'ูุงุชูุฑุฉ ูุจูุนุงุช ูุฏููุนุฉ ุจุงููุงูู',
            items: [
                {
                    productId: 3,
                    quantity: 1,
                    unitPrice: 50000,
                    totalAmount: 50000
                },
                {
                    productId: 4,
                    quantity: 3,
                    unitPrice: 25000,
                    totalAmount: 75000
                }
            ],
            createdAt: '2025-01-16T14:20:00.000Z'
        },
        {
            id: 3,
            invoiceNumber: 'PUR-2025-0001',
            invoiceType: 'purchase',
            invoiceDate: '2025-01-14',
            supplierId: 1,
            subtotal: 8100000,
            discountRate: 2,
            discountAmount: 162000,
            taxRate: 10,
            taxAmount: 793800,
            totalAmount: 8731800,
            paidAmount: 5000000,
            remainingAmount: 3731800,
            status: 'confirmed',
            notes: 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูู ุงูููุฑุฏ ุงูุฑุฆูุณู',
            items: [
                {
                    productId: 1,
                    quantity: 10,
                    unitPrice: 750000,
                    totalAmount: 7500000
                },
                {
                    productId: 2,
                    quantity: 50,
                    unitPrice: 12000,
                    totalAmount: 600000
                }
            ],
            createdAt: '2025-01-14T09:15:00.000Z'
        }
    ],
    payments: [
        {
            id: 1,
            paymentNumber: 'REC-2025-001',
            paymentType: 'receipt',
            paymentDate: '2025-01-15',
            customerId: 1,
            amount: 500000,
            paymentMethod: 'cash',
            referenceNumber: '',
            bankName: '',
            notes: 'ุฏูุนุฉ ุนูู ุญุณุงุจ ุงููุงุชูุฑุฉ',
            status: 'confirmed',
            createdAt: '2025-01-15'
        },
        {
            id: 2,
            paymentNumber: 'PAY-2025-001',
            paymentType: 'payment',
            paymentDate: '2025-01-14',
            supplierId: 1,
            amount: 200000,
            paymentMethod: 'bank',
            referenceNumber: 'TRF123456',
            bankName: 'ุงูุจูู ุงูุชุฌุงุฑู ุงูุณูุฑู',
            notes: 'ุฏูุนุฉ ููููุฑุฏ',
            status: 'confirmed',
            createdAt: '2025-01-14'
        }
    ],
    journalEntries: [
        {
            id: 1,
            entryDate: '2025-01-15',
            entryType: 'invoice',
            description: 'ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู INV-2025-001',
            debitAccount: 'ุงูุนููุงุก',
            creditAccount: 'ุงููุจูุนุงุช',
            debitAmount: 1045000,
            creditAmount: 1045000,
            referenceType: 'invoice',
            referenceId: 1,
            createdAt: '2025-01-15'
        },
        {
            id: 2,
            entryDate: '2025-01-15',
            entryType: 'payment',
            description: 'ุณูุฏ ูุจุถ ุฑูู REC-2025-001',
            debitAccount: 'ุงูุตูุฏูู',
            creditAccount: 'ุงูุนููุงุก',
            debitAmount: 500000,
            creditAmount: 500000,
            referenceType: 'payment',
            referenceId: 1,
            createdAt: '2025-01-15'
        }
    ],
    settings: {
        companyName: 'ุดุฑูุฉ SAM PRO',
        companyAddress: 'ุฏูุดู - ุณูุฑูุง',
        companyPhone: '+963-998-171-954',
        companyEmail: 'info@sampro.sy',
        taxNumber: '123456789',
        currency: 'SYP',
        currencySymbol: 'ู.ุณ',
        taxRate: 10,
        password: '123',
        autoBackup: 'disabled',
        logoUrl: '',
        nextInvoiceNumber: {
            sale: 2,
            purchase: 1
        },
        nextPaymentNumber: {
            receipt: 2,
            payment: 2
        },
        developer: {
            name: 'MOHANNAD AHMAD',
            phone: '+963-998-171-954',
            email: 'mohannad.ahmad@example.com'
        }
    }
};

/**
 * ุฅูุดุงุก ูุนุฑู ูุฑูุฏ
 */
function generateId() {
    // ุงุณุชุฎุฏุงู timestamp ูุน ุฑูู ุนุดูุงุฆู ูุถูุงู ุงููุฑุงุฏุฉ
    return Date.now() + Math.floor(Math.random() * 1000);
}

/**
 * ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ุฃูุซุฑ ุชุนููุฏุงู (UUID-like)
 */
function generateUniqueId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ุญูุธ ุงูุจูุงูุงุช ูู localStorage ูุน ุงูุชุญูู ูู ุงูุตุญุฉ
function saveData() {
    try {
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
        if (!appData) {
            throw new Error('ุงูุจูุงูุงุช ุบูุฑ ููุฌูุฏุฉ');
        }

        // ุงูุชุญูู ูู ุงูููุงูู ุงูุฃุณุงุณูุฉ
        if (!appData.products) appData.products = [];
        if (!appData.warehouses) appData.warehouses = [];
        if (!appData.customers) appData.customers = [];
        if (!appData.suppliers) appData.suppliers = [];
        if (!appData.inventoryMovements) appData.inventoryMovements = [];

        // ุชูุธูู ุงูุจูุงูุงุช ูู ุงูููู ุงููุงุฑุบุฉ ุฃู ุบูุฑ ุงูุตุญูุญุฉ
        appData.products = appData.products.filter(p => p && p.id && p.name);
        appData.warehouses = appData.warehouses.filter(w => w && w.id && w.name);
        appData.customers = appData.customers.filter(c => c && c.id && c.name);
        appData.suppliers = appData.suppliers.filter(s => s && s.id && s.name);
        appData.inventoryMovements = appData.inventoryMovements.filter(m => m && m.id && m.productId);

        // ูุญุงููุฉ ุงูุญูุธ
        const dataString = JSON.stringify(appData);
        localStorage.setItem('samProData', dataString);

        // ุงูุชุญูู ูู ูุฌุงุญ ุงูุญูุธ
        const savedData = localStorage.getItem('samProData');
        if (!savedData) {
            throw new Error('ูุดู ูู ุญูุธ ุงูุจูุงูุงุช');
        }

        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');
        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);

        // ูุญุงููุฉ ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
        try {
            const backupData = JSON.stringify(appData);
            localStorage.setItem('samProData_backup_' + Date.now(), backupData);
            console.log('๐พ ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ');
        } catch (backupError) {
            console.error('โ ูุดู ูู ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', backupError);
        }

        throw error;
    }
}

// ุชุญููู ุงูุจูุงูุงุช ูู localStorage
function loadData() {
    console.log('๐ ุชุญููู ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู...');

    const savedData = localStorage.getItem('samProData');
    if (savedData) {
        try {
            appData = JSON.parse(savedData);
            console.log('โ ุชู ุชุญููู ุงูุจูุงูุงุช ุจูุฌุงุญ');

            // ุงูุชุญูู ูู ูุฌูุฏ ุงูููุงูู ุงูุฃุณุงุณูุฉ
            if (!appData.settings) appData.settings = {};
            if (!appData.customers) appData.customers = [];
            if (!appData.suppliers) appData.suppliers = [];
            if (!appData.products) appData.products = [];
            if (!appData.warehouses) appData.warehouses = [];
            if (!appData.invoices) appData.invoices = [];
            if (!appData.payments) appData.payments = [];
            if (!appData.journalEntries) appData.journalEntries = [];
            if (!appData.inventoryMovements) appData.inventoryMovements = [];
            if (!appData.users) appData.users = [];

            // ุชููุฆุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
            if (!appData.settings.currency) appData.settings.currency = 'SYP';
            if (!appData.settings.currencySymbol) appData.settings.currencySymbol = 'ู.ุณ';
            if (!appData.settings.taxRate) appData.settings.taxRate = 0;
            if (!appData.settings.nextInvoiceNumber) {
                appData.settings.nextInvoiceNumber = { sale: 1, purchase: 1 };
            }
            if (!appData.settings.exchangeRates) appData.settings.exchangeRates = {};

            console.log('โ ุชู ุงูุชุญูู ูู ุงูููุงูู ุงูุฃุณุงุณูุฉ');

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            console.log('๐ง ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุจูุงูุงุช...');
            initializeDefaultData();
        }
    } else {
        console.log('๐ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ - ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ...');
        initializeDefaultData();
    }
}

/**
 * ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ
 */
function initializeDefaultData() {
    console.log('๐ง ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ...');

    appData = {
        settings: {
            companyName: 'ุดุฑูุฉ ุณุงู ุจุฑู',
            companyAddress: '',
            companyPhone: '+963-998-171-954',
            companyEmail: '',
            taxNumber: '',
            currency: 'SYP',
            currencySymbol: 'ู.ุณ',
            taxRate: 0,
            password: '123',
            enableMultiCurrency: false,
            exchangeRates: {},
            nextInvoiceNumber: { sale: 1, purchase: 1 }
        },
        customers: [],
        suppliers: [],
        products: [],
        warehouses: [
            {
                id: 1,
                name: 'ุงููุฎุฒู ุงูุฑุฆูุณู',
                location: 'ุงูููุชุจ ุงูุฑุฆูุณู',
                manager: 'ูุฏูุฑ ุงููุฎุฒู',
                phone: '',
                createdAt: new Date().toISOString().split('T')[0]
            }
        ],
        invoices: [],
        payments: [],
        journalEntries: [],
        inventoryMovements: [],
        users: [
            {
                id: 1,
                username: 'admin',
                password: '123',
                fullName: 'ุงููุฏูุฑ ุงูุนุงู',
                email: 'admin@sampro.com',
                role: 'admin',
                permissions: {
                    dashboard: true,
                    customers: true,
                    suppliers: true,
                    products: true,
                    warehouses: true,
                    salesInvoices: true,
                    purchaseInvoices: true,
                    receipts: true,
                    payments: true,
                    inventory: true,
                    reports: true,
                    journal: true,
                    settings: true,
                    backup: true,
                    users: true
                },
                isActive: true,
                createdAt: '2025-01-14',
                lastLogin: null
            },
            {
                id: 2,
                username: 'user',
                password: '123',
                fullName: 'ูุณุชุฎุฏู ุนุงุฏู',
                email: 'user@sampro.com',
                role: 'user',
                permissions: {
                    dashboard: true,
                    customers: true,
                    suppliers: true,
                    products: true,
                    warehouses: true,
                    salesInvoices: true,
                    purchaseInvoices: true,
                    receipts: true,
                    payments: true,
                    inventory: true,
                    reports: true,
                    journal: true,
                    settings: false,
                    backup: false,
                    users: false
                },
                isActive: true,
                createdAt: '2025-01-14',
                lastLogin: null
            }
        ]
    };

    console.log('โ ุชู ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ');
    saveData();
}

/**
 * ุงูุชุญูู ูู ุตุญุฉ ุงููุธุงู ูุฅุตูุงุญ ุงููุดุงูู
 */
function validateAndFixSystemIssues() {
    console.log('๐ ุจุฏุก ุงูุชุญูู ูู ุตุญุฉ ุงููุธุงู...');

    try {
        let issuesFound = 0;
        let issuesFixed = 0;
        const issues = [];

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (!appData) {
            issues.push('ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ููุฌูุฏุฉ');
            return { success: false, issues };
        }

        // ุงูุชุญูู ูู ุงูููุงูู ุงูุฃุณุงุณูุฉ
        if (!appData.products) {
            appData.products = [];
            issuesFixed++;
            issues.push('ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุงุฆูุฉ ุงูุฃุตูุงู ุงูููููุฏุฉ');
        }

        if (!appData.warehouses) {
            appData.warehouses = [];
            issuesFixed++;
            issues.push('ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุงุฆูุฉ ุงููุฎุงุฒู ุงูููููุฏุฉ');
        }

        if (!appData.inventoryMovements) {
            appData.inventoryMovements = [];
            issuesFixed++;
            issues.push('ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุงุฆูุฉ ุญุฑูุงุช ุงููุฎุฒูู ุงูููููุฏุฉ');
        }

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุฃุตูุงู
        appData.products.forEach((product, index) => {
            if (!product.id) {
                product.id = generateId();
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุนุฑู ููุตูู ูู ุงูููุฑุณ ${index}`);
            }

            if (!product.name || product.name.trim() === '') {
                product.name = `ุตูู ${product.id}`;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ุงุณู ููุตูู ${product.id}`);
            }

            if (!product.code || product.code.trim() === '') {
                product.code = `P${product.id}`;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ููุฏ ููุตูู ${product.name}`);
            }

            if (typeof product.quantity !== 'number' || isNaN(product.quantity)) {
                product.quantity = 0;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ูููุฉ ุงูุตูู ${product.name}`);
            }

            if (typeof product.minQuantity !== 'number' || isNaN(product.minQuantity)) {
                product.minQuantity = 0;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ุงูุญุฏ ุงูุฃุฏูู ููุตูู ${product.name}`);
            }

            if (typeof product.costPrice !== 'number' || isNaN(product.costPrice)) {
                product.costPrice = 0;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ุณุนุฑ ุงูุชูููุฉ ููุตูู ${product.name}`);
            }

            if (typeof product.sellingPrice !== 'number' || isNaN(product.sellingPrice)) {
                product.sellingPrice = 0;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ุณุนุฑ ุงูุจูุน ููุตูู ${product.name}`);
            }

            if (!product.unit || product.unit.trim() === '') {
                product.unit = 'ูุทุนุฉ';
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุญุฏุฉ ููุตูู ${product.name}`);
            }

            // ุงูุชุญูู ูู ูุฌูุฏ ุงููุฎุฒู
            if (product.warehouseId && !appData.warehouses.find(w => w.id === product.warehouseId)) {
                if (appData.warehouses.length > 0) {
                    product.warehouseId = appData.warehouses[0].id;
                    issuesFixed++;
                    issues.push(`ุชู ุฅุตูุงุญ: ุชุนููู ูุฎุฒู ุตุญูุญ ููุตูู ${product.name}`);
                }
            }
        });

        // ุงูุชุญูู ูู ุชูุฑุงุฑ ุฃููุงุฏ ุงูุฃุตูุงู
        const productCodes = {};
        appData.products.forEach(product => {
            if (productCodes[product.code]) {
                product.code = `${product.code}_${product.id}`;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ููุฏ ููุฑุฑ ููุตูู ${product.name}`);
            } else {
                productCodes[product.code] = true;
            }
        });

        // ุงูุชุญูู ูู ุตุญุฉ ุงููุฎุงุฒู
        appData.warehouses.forEach((warehouse, index) => {
            if (!warehouse.id) {
                warehouse.id = generateId();
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ูุนุฑู ูููุฎุฒู ูู ุงูููุฑุณ ${index}`);
            }

            if (!warehouse.name || warehouse.name.trim() === '') {
                warehouse.name = `ูุฎุฒู ${warehouse.id}`;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ุงุณู ูููุฎุฒู ${warehouse.id}`);
            }
        });

        // ุงูุชุญูู ูู ุตุญุฉ ุญุฑูุงุช ุงููุฎุฒูู
        appData.inventoryMovements = appData.inventoryMovements.filter(movement => {
            if (!movement.id || !movement.productId || !movement.warehouseId) {
                issuesFound++;
                issues.push(`ุชู ุญุฐู: ุญุฑูุฉ ูุฎุฒูู ุบูุฑ ุตุญูุญุฉ`);
                return false;
            }

            // ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู ูุงููุฎุฒู
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

            if (!product || !warehouse) {
                issuesFound++;
                issues.push(`ุชู ุญุฐู: ุญุฑูุฉ ูุฎุฒูู ูุตูู ุฃู ูุฎุฒู ูุญุฐูู`);
                return false;
            }

            // ุชุตุญูุญ ุงูุจูุงูุงุช ุงูููููุฏุฉ
            if (typeof movement.quantity !== 'number' || isNaN(movement.quantity)) {
                movement.quantity = 0;
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุชุตุญูุญ ูููุฉ ูู ุญุฑูุฉ ุงููุฎุฒูู`);
            }

            if (!movement.date) {
                movement.date = new Date().toISOString().split('T')[0];
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ุชุงุฑูุฎ ูุญุฑูุฉ ุงููุฎุฒูู`);
            }

            if (!movement.movementType) {
                movement.movementType = 'adjustment';
                issuesFixed++;
                issues.push(`ุชู ุฅุตูุงุญ: ุฅุถุงูุฉ ููุน ูุญุฑูุฉ ุงููุฎุฒูู`);
            }

            return true;
        });

        // ุญูุธ ุงูุจูุงูุงุช ุงููุตุญุญุฉ
        if (issuesFixed > 0) {
            try {
                saveData();
                console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุงููุตุญุญุฉ');
            } catch (saveError) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ุงููุตุญุญุฉ:', saveError);
                issues.push('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ุงููุตุญุญุฉ');
            }
        }

        console.log(`โ ุงูุชูู ุงูุชุญูู ูู ุงููุธุงู: ${issuesFound} ูุดุงูู ูุฌุฏุชุ ${issuesFixed} ูุดููุฉ ุชู ุฅุตูุงุญูุง`);

        return {
            success: true,
            issuesFound,
            issuesFixed,
            issues
        };

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุตุญุฉ ุงููุธุงู:', error);
        return {
            success: false,
            error: error.message,
            issues: ['ุฎุทุฃ ุนุงู ูู ุงูุชุญูู ูู ุงููุธุงู']
        };
    }
}

/**
 * ุชุดุบูู ูุญุต ุดุงูู ูููุธุงู ูุฅุตูุงุญ ุงููุดุงูู
 */
function runSystemDiagnostics() {
    console.log('๐ง ุจุฏุก ูุญุต ุงููุธุงู ุงูุดุงูู...');

    // ุฅูุดุงุก ูุงูุฐุฉ ููุจุซูุฉ ูุนุฑุถ ูุชุงุฆุฌ ุงููุญุต
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'systemDiagnosticsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-tools me-2"></i>
                        ูุญุต ูุฅุตูุงุญ ุงููุธุงู
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="diagnosticsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ุฌุงุฑู ุงููุญุต...</span>
                            </div>
                            <p class="mt-2">ุฌุงุฑู ูุญุต ุงููุธุงู ูุฅุตูุงุญ ุงููุดุงูู...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="runDiagnosticsAgain" onclick="startDiagnostics()" style="display: none;">
                        <i class="fas fa-redo me-2"></i>ุฅุนุงุฏุฉ ุงููุญุต
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // ุจุฏุก ุงููุญุต
    setTimeout(() => {
        startDiagnostics();
    }, 500);

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชุดุบูู ุนูููุฉ ุงููุญุต ุงููุนููุฉ
 */
function startDiagnostics() {
    const content = document.getElementById('diagnosticsContent');
    const runAgainBtn = document.getElementById('runDiagnosticsAgain');

    try {
        // ุชุดุบูู ูุญุต ุงููุธุงู
        const result = validateAndFixSystemIssues();

        let html = '';

        if (result.success) {
            html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>ุชู ุงููุญุต ุจูุฌุงุญ!</strong>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4>${result.issuesFound || 0}</h4>
                                <small>ูุดุงูู ุชู ุงูุชุดุงููุง</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>${result.issuesFixed || 0}</h4>
                                <small>ูุดุงูู ุชู ุฅุตูุงุญูุง</small>
                            </div>
                        </div>
                    </div>
                </div>

                ${result.issues && result.issues.length > 0 ? `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                ุชูุงุตูู ุงููุญุต
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                ${result.issues.map(issue => `
                                    <li class="list-group-item">
                                        <i class="fas fa-${issue.includes('ุชู ุฅุตูุงุญ') ? 'check text-success' : issue.includes('ุชู ุญุฐู') ? 'trash text-warning' : 'info-circle text-info'} me-2"></i>
                                        ${issue}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                ` : `
                    <div class="alert alert-success">
                        <i class="fas fa-thumbs-up me-2"></i>
                        ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ูุดุงูู ูู ุงููุธุงู. ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ!
                    </div>
                `}

                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        ุชู ุงููุญุต ูู: ${new Date().toLocaleString('ar-SY')}
                    </small>
                </div>
            `;
        } else {
            html = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุญุต!</strong>
                    <br>
                    ${result.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}
                </div>

                ${result.issues && result.issues.length > 0 ? `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ุชูุงุตูู ุงูุฃุฎุทุงุก</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                ${result.issues.map(issue => `
                                    <li class="list-group-item text-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        ${issue}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        content.innerHTML = html;

        // ุฅุธูุงุฑ ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุต
        if (runAgainBtn) {
            runAgainBtn.style.display = 'inline-block';
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ุฃู ุฎุทุฃ
        if (result.success) {
            if (result.issuesFixed > 0) {
                showSuccessToast(`ุชู ุฅุตูุงุญ ${result.issuesFixed} ูุดููุฉ ูู ุงููุธุงู`);
            } else {
                showSuccessToast('ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ');
            }
        } else {
            showErrorToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุต ุงููุธุงู');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุดุบูู ุงููุญุต:', error);
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>ุฎุทุฃ ูู ุชุดุบูู ุงููุญุต:</strong>
                <br>
                ${error.message}
            </div>
        `;

        if (runAgainBtn) {
            runAgainBtn.style.display = 'inline-block';
        }
    }
}

/**
 * ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู ุจุฏูุฉ
 */
function refreshInventoryCalculations() {
    console.log('๐ ุจุฏุก ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู...');

    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    const originalText = button.innerHTML;

    // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู
    button.disabled = true;
    icon.classList.add('fa-spin');
    button.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>ุฌุงุฑู ุงูุชุญุฏูุซ...';

    try {
        let updatedProductsCount = 0;
        let deletedMovementsCount = 0;

        // ุฅุฒุงูุฉ ุญุฑูุงุช ุงูููุชุฌุงุช ุงููุญุฐููุฉ
        if (appData.inventoryMovements) {
            const initialMovementsCount = appData.inventoryMovements.length;

            appData.inventoryMovements = appData.inventoryMovements.filter(movement => {
                const product = appData.products.find(p => p.id === movement.productId);
                const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

                // ุงูุงุญุชูุงุธ ุจุงูุญุฑูุฉ ููุท ุฅุฐุง ูุงู ุงูููุชุฌ ูุงููุฎุฒู ููุฌูุฏูู ูุบูุฑ ูุญุฐูููู
                return product && warehouse && product.isActive !== false && warehouse.isActive !== false;
            });

            deletedMovementsCount = initialMovementsCount - appData.inventoryMovements.length;
        }

        // ุฅุนุงุฏุฉ ุญุณุงุจ ูููุงุช ุงูููุชุฌุงุช ุจูุงุกู ุนูู ุงูุญุฑูุงุช ุงูุตุญูุญุฉ
        appData.products.forEach(product => {
            if (product.isActive === false) return; // ุชุฌุงูู ุงูููุชุฌุงุช ุงููุญุฐููุฉ

            // ุงูุญุตูู ุนูู ุฌููุน ุญุฑูุงุช ูุฐุง ุงูููุชุฌ
            const productMovements = (appData.inventoryMovements || []).filter(m =>
                m.productId === product.id &&
                m.warehouseId === product.warehouseId
            );

            // ุญุณุงุจ ุงููููุฉ ุงูุตุญูุญุฉ ูุน ูุนุงูุฌุฉ ุดุงููุฉ ูุฌููุน ุฃููุงุน ุงูุญุฑูุงุช
            let calculatedQuantity = 0;
            let totalIn = 0;
            let totalOut = 0;

            productMovements.forEach(movement => {
                const quantity = parseFloat(movement.quantity) || 0;

                // ูุนุงูุฌุฉ ุดุงููุฉ ูุฏูููุฉ ูุฌููุน ุฃููุงุน ุงูุญุฑูุงุช
                switch (movement.movementType) {
                    case 'in':
                    case 'purchase':
                    case 'return_sale':
                    case 'transfer_in':
                        totalIn += Math.abs(quantity);
                        calculatedQuantity += Math.abs(quantity);
                        break;

                    case 'out':
                    case 'sale':
                    case 'return_purchase':
                    case 'transfer_out':
                        totalOut += Math.abs(quantity);
                        calculatedQuantity -= Math.abs(quantity);
                        break;

                    case 'adjustment':
                        // ุงูุชุณููุฉ ูููู ุฃู ุชููู ููุฌุจุฉ ุฃู ุณุงูุจุฉ
                        if (quantity >= 0) {
                            totalIn += quantity;
                            calculatedQuantity += quantity;
                        } else {
                            totalOut += Math.abs(quantity);
                            calculatedQuantity += quantity; // quantity ุณุงูุจ ุจุงููุนู
                        }
                        break;

                    case 'transfer':
                        // ุงูุชุญููู ุจูู ุงููุฎุงุฒู
                        if (movement.warehouseId === product.warehouseId) {
                            // ุฅุฎุฑุงุฌ ูู ุงููุฎุฒู ุงูุญุงูู
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                        } else if (movement.toWarehouseId === product.warehouseId) {
                            // ุฅุฏุฎุงู ูููุฎุฒู ุงูุญุงูู
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                        }
                        break;

                    default:
                        // ูุนุงูุฌุฉ ุงูุฃููุงุน ุงููุฏููุฉ ููุชูุงูู ูุน ุงููุณุฎ ุงูุณุงุจูุฉ
                        if (movement.movementType.includes('in') || quantity > 0) {
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                        } else {
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                        }
                        console.warn(`โ๏ธ ููุน ุญุฑูุฉ ุบูุฑ ูุนุฑูู: ${movement.movementType} ููููุชุฌ ${product.name}`);
                }
            });

            // ุงูุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุง ุชููู ุณุงูุจุฉ
            calculatedQuantity = Math.max(0, calculatedQuantity);

            // ุชุญุฏูุซ ุงููููุฉ ุฅุฐุง ูุงูุช ูุฎุชููุฉ
            const currentQuantity = parseFloat(product.quantity) || 0;
            if (Math.abs(currentQuantity - calculatedQuantity) > 0.001) {
                console.log(`๐ฆ ุชุญุฏูุซ ูููุฉ ${product.name}: ${currentQuantity} โ ${calculatedQuantity}`);
                product.quantity = calculatedQuantity;
                product.totalIn = totalIn;
                product.totalOut = totalOut;
                product.lastUpdated = new Date().toISOString();
                updatedProductsCount++;
            }
        });

        // ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
        saveData();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุงูุชุญุฏูุซุงุช
        setTimeout(() => {
            showPage('inventory');

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
            const message = `ุชู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู ุจูุฌุงุญ!\n\n` +
                          `โข ุชู ุชุญุฏูุซ ${updatedProductsCount} ููุชุฌ\n` +
                          `โข ุชู ุญุฐู ${deletedMovementsCount} ุญุฑูุฉ ููููุชุฌุงุช ุงููุญุฐููุฉ\n` +
                          `โข ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฏุฎุงูุงุช ูุงูุฅุฎุฑุงุฌุงุช ูุงูุตุงูู ุจุฏูุฉ`;

            showSuccessToast('ุชู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู ุจูุฌุงุญ!');

            // ุฅุธูุงุฑ ุชูุงุตูู ุงูุชุญุฏูุซ ูู ูุญุฏุฉ ุงูุชุญูู
            console.log('โ ุชู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู:', {
                'ููุชุฌุงุช ูุญุฏุซุฉ': updatedProductsCount,
                'ุญุฑูุงุช ูุญุฐููุฉ': deletedMovementsCount,
                'ุฅุฌูุงูู ุงูููุชุฌุงุช ุงููุดุทุฉ': appData.products.filter(p => p.isActive !== false).length,
                'ุฅุฌูุงูู ุงูุญุฑูุงุช': appData.inventoryMovements?.length || 0
            });

        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู:', error);

        // ุงุณุชุนุงุฏุฉ ุงูุฒุฑ
        button.disabled = false;
        icon.classList.remove('fa-spin');
        button.innerHTML = originalText;

        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ูุงุฆูุฉ ุงูุนููุงุก ุฅูู Excel
 */
function exportCustomersToExcel() {
    console.log('๐ ุชุตุฏูุฑ ูุงุฆูุฉ ุงูุนููุงุก ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ููุฏ ุงูุนููู',
            'ุงุณู ุงูุนููู',
            'ุฑูู ุงููุงุชู',
            'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
            'ุงูุนููุงู',
            'ุงููุฏููุฉ',
            'ุงูุฑุตูุฏ ุงูุญุงูู',
            'ุฅุฌูุงูู ุงููุจูุนุงุช',
            'ุฅุฌูุงูู ุงููุฏููุนุงุช',
            'ุชุงุฑูุฎ ุงูุฅูุดุงุก',
            'ุขุฎุฑ ูุนุงููุฉ',
            'ุงูุญุงูุฉ'
        ];

        const data = appData.customers.map(customer => [
            customer.code || customer.id,
            customer.name,
            customer.phone || '-',
            customer.email || '-',
            customer.address || '-',
            customer.city || '-',
            formatCurrency(customer.currentBalance || 0),
            formatCurrency(customer.totalSales || 0),
            formatCurrency(customer.totalPayments || 0),
            customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('ar-SY') : '-',
            customer.lastTransactionDate ? new Date(customer.lastTransactionDate).toLocaleDateString('ar-SY') : '-',
            customer.isActive !== false ? 'ูุดุท' : 'ุบูุฑ ูุดุท'
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ูุงุฆูุฉ ุงูุนููุงุก');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงูุนููุงุก');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summaryData = [
            ['ููุฎุต ูุงุฆูุฉ ุงูุนููุงุก'],
            [''],
            ['ุฅุฌูุงูู ุนุฏุฏ ุงูุนููุงุก', appData.customers.length],
            ['ุงูุนููุงุก ุงููุดุทูู', appData.customers.filter(c => c.isActive !== false).length],
            ['ุงูุนููุงุก ุบูุฑ ุงููุดุทูู', appData.customers.filter(c => c.isActive === false).length],
            ['ุฅุฌูุงูู ุงูุฃุฑุตุฏุฉ ุงููุฏููุฉ', formatCurrency(appData.customers.reduce((sum, c) => sum + Math.max(0, c.currentBalance || 0), 0))],
            ['ุฅุฌูุงูู ุงูุฃุฑุตุฏุฉ ุงูุฏุงุฆูุฉ', formatCurrency(Math.abs(appData.customers.reduce((sum, c) => sum + Math.min(0, c.currentBalance || 0), 0)))],
            ['ุฅุฌูุงูู ุงููุจูุนุงุช', formatCurrency(appData.customers.reduce((sum, c) => sum + (c.totalSales || 0), 0))],
            ['ุฅุฌูุงูู ุงููุฏููุนุงุช', formatCurrency(appData.customers.reduce((sum, c) => sum + (c.totalPayments || 0), 0))],
            [''],
            ['ุชุงุฑูุฎ ุงูุชูุฑูุฑ', new Date().toLocaleDateString('ar-SY')],
            ['ููุช ุงูุชูุฑูุฑ', new Date().toLocaleTimeString('ar-SY')]
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุฆูุฉ_ุงูุนููุงุก_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูุนููุงุก ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูุนููุงุก ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูุนููุงุก ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ูุงุฆูุฉ ุงูููุฑุฏูู ุฅูู Excel
 */
function exportSuppliersToExcel() {
    console.log('๐ ุชุตุฏูุฑ ูุงุฆูุฉ ุงูููุฑุฏูู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ููุฏ ุงูููุฑุฏ',
            'ุงุณู ุงูููุฑุฏ',
            'ุฑูู ุงููุงุชู',
            'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
            'ุงูุนููุงู',
            'ุงููุฏููุฉ',
            'ุงูุฑุตูุฏ ุงูุญุงูู',
            'ุฅุฌูุงูู ุงููุดุชุฑูุงุช',
            'ุฅุฌูุงูู ุงููุฏููุนุงุช',
            'ุชุงุฑูุฎ ุงูุฅูุดุงุก',
            'ุขุฎุฑ ูุนุงููุฉ',
            'ุงูุญุงูุฉ'
        ];

        const data = appData.suppliers.map(supplier => [
            supplier.code || supplier.id,
            supplier.name,
            supplier.phone || '-',
            supplier.email || '-',
            supplier.address || '-',
            supplier.city || '-',
            formatCurrency(supplier.currentBalance || 0),
            formatCurrency(supplier.totalPurchases || 0),
            formatCurrency(supplier.totalPayments || 0),
            supplier.createdAt ? new Date(supplier.createdAt).toLocaleDateString('ar-SY') : '-',
            supplier.lastTransactionDate ? new Date(supplier.lastTransactionDate).toLocaleDateString('ar-SY') : '-',
            supplier.isActive !== false ? 'ูุดุท' : 'ุบูุฑ ูุดุท'
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ูุงุฆูุฉ ุงูููุฑุฏูู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงูููุฑุฏูู');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summaryData = [
            ['ููุฎุต ูุงุฆูุฉ ุงูููุฑุฏูู'],
            [''],
            ['ุฅุฌูุงูู ุนุฏุฏ ุงูููุฑุฏูู', appData.suppliers.length],
            ['ุงูููุฑุฏูู ุงููุดุทูู', appData.suppliers.filter(s => s.isActive !== false).length],
            ['ุงูููุฑุฏูู ุบูุฑ ุงููุดุทูู', appData.suppliers.filter(s => s.isActive === false).length],
            ['ุฅุฌูุงูู ุงูุฃุฑุตุฏุฉ ุงููุฏููุฉ', formatCurrency(appData.suppliers.reduce((sum, s) => sum + Math.max(0, s.currentBalance || 0), 0))],
            ['ุฅุฌูุงูู ุงูุฃุฑุตุฏุฉ ุงูุฏุงุฆูุฉ', formatCurrency(Math.abs(appData.suppliers.reduce((sum, s) => sum + Math.min(0, s.currentBalance || 0), 0)))],
            ['ุฅุฌูุงูู ุงููุดุชุฑูุงุช', formatCurrency(appData.suppliers.reduce((sum, s) => sum + (s.totalPurchases || 0), 0))],
            ['ุฅุฌูุงูู ุงููุฏููุนุงุช', formatCurrency(appData.suppliers.reduce((sum, s) => sum + (s.totalPayments || 0), 0))],
            [''],
            ['ุชุงุฑูุฎ ุงูุชูุฑูุฑ', new Date().toLocaleDateString('ar-SY')],
            ['ููุช ุงูุชูุฑูุฑ', new Date().toLocaleTimeString('ar-SY')]
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุฆูุฉ_ุงูููุฑุฏูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูููุฑุฏูู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูููุฑุฏูู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ูุงุฆูุฉ ุงูููุฑุฏูู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ูุงุฆูุฉ ุงููุฎุงุฒู ุฅูู Excel
 */
function exportWarehousesToExcel() {
    console.log('๐ ุชุตุฏูุฑ ูุงุฆูุฉ ุงููุฎุงุฒู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ููุฏ ุงููุฎุฒู',
            'ุงุณู ุงููุฎุฒู',
            'ุงููููุน',
            'ุงููุฏูุฑ',
            'ุฑูู ุงููุงุชู',
            'ุนุฏุฏ ุงูุฃุตูุงู',
            'ูููุฉ ุงููุฎุฒูู',
            'ุงูุณุนุฉ ุงููุตูู',
            'ุงููุณุจุฉ ุงููุณุชุฎุฏูุฉ',
            'ุชุงุฑูุฎ ุงูุฅูุดุงุก',
            'ุงูุญุงูุฉ',
            'ููุงุญุธุงุช'
        ];

        const data = appData.warehouses.map(warehouse => {
            const warehouseProducts = appData.products.filter(p => p.warehouseId === warehouse.id);
            const productsCount = warehouseProducts.length;
            const totalValue = warehouseProducts.reduce((sum, p) => sum + ((p.quantity || 0) * (p.costPrice || 0)), 0);
            const usagePercentage = warehouse.maxCapacity > 0 ?
                ((productsCount / warehouse.maxCapacity) * 100).toFixed(1) + '%' : '-';

            return [
                warehouse.code || warehouse.id,
                warehouse.name,
                warehouse.location || '-',
                warehouse.manager || '-',
                warehouse.phone || '-',
                productsCount,
                formatCurrency(totalValue),
                warehouse.maxCapacity || '-',
                usagePercentage,
                warehouse.createdAt ? new Date(warehouse.createdAt).toLocaleDateString('ar-SY') : '-',
                warehouse.isActive !== false ? 'ูุดุท' : 'ุบูุฑ ูุดุท',
                warehouse.notes || '-'
            ];
        });

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ูุงุฆูุฉ ุงููุฎุงุฒู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงููุฎุงุฒู');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const totalProducts = appData.products.length;
        const totalValue = appData.products.reduce((sum, p) => sum + ((p.quantity || 0) * (p.costPrice || 0)), 0);

        const summaryData = [
            ['ููุฎุต ูุงุฆูุฉ ุงููุฎุงุฒู'],
            [''],
            ['ุฅุฌูุงูู ุนุฏุฏ ุงููุฎุงุฒู', appData.warehouses.length],
            ['ุงููุฎุงุฒู ุงููุดุทุฉ', appData.warehouses.filter(w => w.isActive !== false).length],
            ['ุงููุฎุงุฒู ุบูุฑ ุงููุดุทุฉ', appData.warehouses.filter(w => w.isActive === false).length],
            ['ุฅุฌูุงูู ุงูุฃุตูุงู', totalProducts],
            ['ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู', formatCurrency(totalValue)],
            ['ูุชูุณุท ุงูุฃุตูุงู ููู ูุฎุฒู', (totalProducts / appData.warehouses.length).toFixed(1)],
            ['ูุชูุณุท ูููุฉ ุงููุฎุฒู', formatCurrency(totalValue / appData.warehouses.length)],
            [''],
            ['ุชุงุฑูุฎ ุงูุชูุฑูุฑ', new Date().toLocaleDateString('ar-SY')],
            ['ููุช ุงูุชูุฑูุฑ', new Date().toLocaleTimeString('ar-SY')]
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต');

        // ุฅุถุงูุฉ ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู ููู ูุฎุฒู
        const detailsData = [
            ['ุงููุฎุฒู', 'ุงูุตูู', 'ุงููููุฉ', 'ุงููุญุฏุฉ', 'ุณุนุฑ ุงูุชูููุฉ', 'ูููุฉ ุงููุฎุฒูู', 'ุงูุญุฏ ุงูุฃุฏูู', 'ุญุงูุฉ ุงููุฎุฒูู']
        ];

        appData.warehouses.forEach(warehouse => {
            const warehouseProducts = appData.products.filter(p => p.warehouseId === warehouse.id);
            warehouseProducts.forEach(product => {
                const stockValue = (product.quantity || 0) * (product.costPrice || 0);
                const isLowStock = (product.quantity || 0) <= (product.minQuantity || 0);
                const stockStatus = (product.quantity || 0) === 0 ? 'ููุฏ ุงููุฎุฒูู' :
                                   isLowStock ? 'ูุฎุฒูู ููุฎูุถ' : 'ูุฎุฒูู ุขูู';

                detailsData.push([
                    warehouse.name,
                    product.name,
                    product.quantity || 0,
                    product.unit || '-',
                    product.costPrice || 0,
                    stockValue,
                    product.minQuantity || 0,
                    stockStatus
                ]);
            });
        });

        const detailsSheet = XLSX.utils.aoa_to_sheet(detailsData);
        XLSX.utils.book_append_sheet(workbook, detailsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุฆูุฉ_ุงููุฎุงุฒู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงููุฎุงุฒู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ูุงุฆูุฉ ุงููุฎุงุฒู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ูุงุฆูุฉ ุงููุฎุงุฒู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุนุฏูู ุณูุฏ ูุจุถ
 */
function editReceipt(receiptId) {
    console.log('โ๏ธ ุชุนุฏูู ุณูุฏ ุงููุจุถ ID:', receiptId);

    const receipt = appData.payments.find(p => p.id === receiptId && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุนุฏูู
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุณูุฏ ุงููุจุถ ุฑูู ${receipt.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReceiptForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptNumber" class="form-label">ุฑูู ุงูุณูุฏ</label>
                                <input type="text" class="form-control" id="editReceiptNumber" value="${receipt.paymentNumber}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editReceiptDate" value="${receipt.paymentDate}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCustomer" required>
                                    <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                                    ${appData.customers.map(c =>
                                        `<option value="${c.id}" ${c.id === receipt.customerId ? 'selected' : ''}>${c.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editReceiptAmount" value="${receipt.amount}" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash" ${receipt.paymentMethod === 'cash' ? 'selected' : ''}>ููุฏู</option>
                                    <option value="bank" ${receipt.paymentMethod === 'bank' ? 'selected' : ''}>ุชุญููู ุจููู</option>
                                    <option value="check" ${receipt.paymentMethod === 'check' ? 'selected' : ''}>ุดูู</option>
                                    <option value="card" ${receipt.paymentMethod === 'card' ? 'selected' : ''}>ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCurrency" required>
                                    <option value="SYP" ${receipt.currency === 'SYP' ? 'selected' : ''}>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD" ${receipt.currency === 'USD' ? 'selected' : ''}>ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR" ${receipt.currency === 'EUR' ? 'selected' : ''}>ููุฑู (โฌ)</option>
                                    <option value="TRY" ${receipt.currency === 'TRY' ? 'selected' : ''}>ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR" ${receipt.currency === 'SAR' ? 'selected' : ''}>ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED" ${receipt.currency === 'AED' ? 'selected' : ''}>ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                    <option value="LBP" ${receipt.currency === 'LBP' ? 'selected' : ''}>ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                    <option value="GBP" ${receipt.currency === 'GBP' ? 'selected' : ''}>ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="editReceiptReference" value="${receipt.referenceNumber || ''}" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptBankName" class="form-label">ุงุณู ุงูุจูู</label>
                            <input type="text" class="form-control" id="editReceiptBankName" value="${receipt.bankName || ''}">
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptStatus" class="form-label">ุงูุญุงูุฉ</label>
                            <select class="form-select" id="editReceiptStatus">
                                <option value="pending" ${receipt.status === 'pending' ? 'selected' : ''}>ูุนูู</option>
                                <option value="confirmed" ${receipt.status === 'confirmed' ? 'selected' : ''}>ูุคูุฏ</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveReceiptChanges(${receiptId})">ุญูุธ ุงูุชุบููุฑุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุชุบููุฑุงุช ุณูุฏ ุงููุจุถ
 */
function saveReceiptChanges(receiptId) {
    const receipt = appData.payments.find(p => p.id === receiptId);
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
    const date = document.getElementById('editReceiptDate').value;
    const customerId = parseInt(document.getElementById('editReceiptCustomer').value);
    const amount = parseFloat(document.getElementById('editReceiptAmount').value);
    const method = document.getElementById('editReceiptMethod').value;
    const currency = document.getElementById('editReceiptCurrency').value;
    const reference = document.getElementById('editReceiptReference').value.trim();
    const bankName = document.getElementById('editReceiptBankName').value.trim();
    const notes = document.getElementById('editReceiptNotes').value.trim();
    const status = document.getElementById('editReceiptStatus').value;

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!date || !customerId || !amount || amount <= 0 || !method || !currency) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    // ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ ููุชุฑุงุฌุน ูู ุญุงูุฉ ุงูุฎุทุฃ
    const oldData = { ...receipt };

    try {
        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุณูุฏ
        receipt.paymentDate = date;
        receipt.customerId = customerId;
        receipt.amount = amount;
        receipt.paymentMethod = method;
        receipt.currency = currency;
        receipt.referenceNumber = reference;
        receipt.bankName = bankName;
        receipt.notes = notes;
        receipt.status = status;
        receipt.updatedAt = new Date().toISOString();

        // ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู ุฅุฐุง ุชุบูุฑ ุงููุจูุบ ุฃู ุงูุนููู
        if (oldData.customerId !== customerId || oldData.amount !== amount) {
            // ุฅูุบุงุก ุชุฃุซูุฑ ุงูุณูุฏ ุงููุฏูู
            const oldCustomer = appData.customers.find(c => c.id === oldData.customerId);
            if (oldCustomer) {
                oldCustomer.currentBalance = (oldCustomer.currentBalance || 0) + oldData.amount;
            }

            // ุชุทุจูู ุชุฃุซูุฑ ุงูุณูุฏ ุงูุฌุฏูุฏ
            const newCustomer = appData.customers.find(c => c.id === customerId);
            if (newCustomer) {
                newCustomer.currentBalance = (newCustomer.currentBalance || 0) - amount;
            }
        }

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editReceiptModal'));
        modal.hide();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        showPage('receipts');

        alert('ุชู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ ุจูุฌุงุญ');
        console.log('โ ุชู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ:', receipt.paymentNumber);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ:', error);

        // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงููุฏููุฉ
        Object.assign(receipt, oldData);

        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุณูุฏ ุงููุจุถ: ' + error.message);
    }
}

/**
 * ุญุฐู ุณูุฏ ูุจุถ
 */
function deleteReceipt(receiptId) {
    console.log('๐๏ธ ุญุฐู ุณูุฏ ุงููุจุถ ID:', receiptId);

    const receipt = appData.payments.find(p => p.id === receiptId && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        return;
    }

    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const customerName = customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ';

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณูุฏ ุงููุจุถ ุฑูู ${receipt.paymentNumber}ุ\n\nุงูุนููู: ${customerName}\nุงููุจูุบ: ${formatCurrency(receipt.amount, receipt.currency)}\nุงูุชุงุฑูุฎ: ${receipt.paymentDate}\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุคุซุฑ ุนูู ุฑุตูุฏ ุงูุนููู.`)) {

        try {
            // ุฅูุบุงุก ุชุฃุซูุฑ ุงูุณูุฏ ุนูู ุฑุตูุฏ ุงูุนููู
            if (customer && receipt.status === 'confirmed') {
                customer.currentBalance = (customer.currentBalance || 0) + receipt.amount;
                console.log(`๐ฐ ุชู ุชุนุฏูู ุฑุตูุฏ ุงูุนููู ${customer.name}: +${receipt.amount}`);
            }

            // ุญุฐู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฑุชุจุทุฉ
            if (appData.journalEntries) {
                const entriesCountBefore = appData.journalEntries.length;
                appData.journalEntries = appData.journalEntries.filter(entry =>
                    entry.reference !== receipt.paymentNumber
                );
                const entriesCountAfter = appData.journalEntries.length;
                console.log(`๐ ุชู ุญุฐู ${entriesCountBefore - entriesCountAfter} ููุฏ ูุญุงุณุจู`);
            }

            // ุญุฐู ุงูุณูุฏ ูู ุงููุงุฆูุฉ
            const receiptIndex = appData.payments.findIndex(p => p.id === receiptId);
            if (receiptIndex > -1) {
                appData.payments.splice(receiptIndex, 1);
            }

            // ุญูุธ ุงูุจูุงูุงุช
            saveData();

            // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
            showPage('receipts');

            alert('ุชู ุญุฐู ุณูุฏ ุงููุจุถ ุจูุฌุงุญ');
            console.log('โ ุชู ุญุฐู ุณูุฏ ุงููุจุถ:', receipt.paymentNumber);

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญุฐู ุณูุฏ ุงููุจุถ:', error);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุณูุฏ ุงููุจุถ: ' + error.message);
        }
    }
}

/**
 * ุชุญุฏูุซ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ
 */
function refreshReceiptsData() {
    console.log('๐ ุชุญุฏูุซ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ...');

    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    const originalText = button.innerHTML;

    // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู
    button.disabled = true;
    icon.classList.add('fa-spin');
    button.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>ุฌุงุฑู ุงูุชุญุฏูุซ...';

    try {
        // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ
        let updatedCount = 0;
        let deletedCount = 0;

        appData.payments = appData.payments.filter(payment => {
            if (payment.paymentType !== 'receipt') return true;

            // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููู
            const customer = appData.customers.find(c => c.id === payment.customerId);
            if (!customer) {
                console.log(`โ๏ธ ุญุฐู ุณูุฏ ูุจุถ ุจุฏูู ุนููู: ${payment.paymentNumber}`);
                deletedCount++;
                return false;
            }

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
            if (!payment.amount || payment.amount <= 0) {
                console.log(`โ๏ธ ุชุตุญูุญ ูุจูุบ ุณูุฏ ุงููุจุถ: ${payment.paymentNumber}`);
                payment.amount = 0;
                updatedCount++;
            }

            if (!payment.currency) {
                payment.currency = 'SYP';
                updatedCount++;
            }

            if (!payment.status) {
                payment.status = 'pending';
                updatedCount++;
            }

            return true;
        });

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        setTimeout(() => {
            showPage('receipts');

            const message = `ุชู ุชุญุฏูุซ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ!\n\n` +
                          `โข ุชู ุชุญุฏูุซ ${updatedCount} ุณูุฏ\n` +
                          `โข ุชู ุญุฐู ${deletedCount} ุณูุฏ ุบูุฑ ุตุญูุญ`;

            if (updatedCount > 0 || deletedCount > 0) {
                alert(message);
            }

            console.log('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ:', {
                'ุณูุฏุงุช ูุญุฏุซุฉ': updatedCount,
                'ุณูุฏุงุช ูุญุฐููุฉ': deletedCount
            });

        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ:', error);

        // ุงุณุชุนุงุฏุฉ ุงูุฒุฑ
        button.disabled = false;
        icon.classList.remove('fa-spin');
        button.innerHTML = originalText;

        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุจูุงูุงุช: ' + error.message);
    }
}

/**
 * ุชุญุฏูุซ ุญุณุงุจุงุช ุญุฑูุฉ ุงููุฎุฒู
 */
function refreshWarehouseMovements(warehouseId) {
    console.log('๐ ุชุญุฏูุซ ุญุณุงุจุงุช ุญุฑูุฉ ุงููุฎุฒู ID:', warehouseId);

    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    const originalText = button.innerHTML;

    // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู
    button.disabled = true;
    icon.classList.add('fa-spin');
    button.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>ุฌุงุฑู ุงูุชุญุฏูุซ...';

    try {
        const warehouse = appData.warehouses.find(w => w.id === warehouseId);
        if (!warehouse) {
            throw new Error('ุงููุฎุฒู ุบูุฑ ููุฌูุฏ');
        }

        let updatedProductsCount = 0;
        let deletedMovementsCount = 0;
        let recalculatedCount = 0;

        // ุชูุธูู ุญุฑูุงุช ุงููุฎุฒูู ูู ุงูุจูุงูุงุช ุงููุญุฐููุฉ
        if (appData.inventoryMovements) {
            const initialMovementsCount = appData.inventoryMovements.length;

            appData.inventoryMovements = appData.inventoryMovements.filter(movement => {
                // ุงูุชุญูู ูู ูุฌูุฏ ุงูููุชุฌ ูุงููุฎุฒู
                const product = appData.products.find(p => p.id === movement.productId);
                const movementWarehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

                // ุงูุงุญุชูุงุธ ุจุงูุญุฑูุฉ ููุท ุฅุฐุง ูุงู ุงูููุชุฌ ูุงููุฎุฒู ููุฌูุฏูู ูุบูุฑ ูุญุฐูููู
                const isValid = product && movementWarehouse &&
                               product.isActive !== false &&
                               movementWarehouse.isActive !== false &&
                               movement.isDeleted !== true;

                if (!isValid && movement.warehouseId === warehouseId) {
                    console.log(`๐๏ธ ุญุฐู ุญุฑูุฉ ุบูุฑ ุตุญูุญุฉ: ${movement.reference || movement.id}`);
                }

                return isValid;
            });

            deletedMovementsCount = initialMovementsCount - appData.inventoryMovements.length;
        }

        // ุฅุนุงุฏุฉ ุญุณุงุจ ูููุงุช ุงูููุชุฌุงุช ูู ูุฐุง ุงููุฎุฒู
        const warehouseProducts = appData.products.filter(p =>
            p.warehouseId === warehouseId && p.isActive !== false
        );

        warehouseProducts.forEach(product => {
            // ุงูุญุตูู ุนูู ุฌููุน ุญุฑูุงุช ูุฐุง ุงูููุชุฌ ูู ูุฐุง ุงููุฎุฒู
            const productMovements = (appData.inventoryMovements || []).filter(m =>
                m.productId === product.id &&
                m.warehouseId === warehouseId &&
                m.isDeleted !== true
            );

            // ุญุณุงุจ ุงููููุฉ ูู ุงูุญุฑูุงุช ูุน ูุนุงูุฌุฉ ุดุงููุฉ ูุฏูููุฉ
            let calculatedQuantity = 0;
            let totalIn = 0;
            let totalOut = 0;

            productMovements.forEach(movement => {
                const quantity = parseFloat(movement.quantity) || 0;

                // ูุนุงูุฌุฉ ุดุงููุฉ ูุฌููุน ุฃููุงุน ุงูุญุฑูุงุช
                switch (movement.movementType) {
                    case 'in':
                    case 'purchase':
                    case 'return_sale':
                    case 'transfer_in':
                        totalIn += Math.abs(quantity);
                        calculatedQuantity += Math.abs(quantity);
                        break;

                    case 'out':
                    case 'sale':
                    case 'return_purchase':
                    case 'transfer_out':
                    case 'damage':
                        totalOut += Math.abs(quantity);
                        calculatedQuantity -= Math.abs(quantity);
                        break;

                    case 'adjustment':
                        // ุงูุชุณููุฉ ูููู ุฃู ุชููู ููุฌุจุฉ ุฃู ุณุงูุจุฉ
                        if (quantity >= 0) {
                            totalIn += quantity;
                            calculatedQuantity += quantity;
                        } else {
                            totalOut += Math.abs(quantity);
                            calculatedQuantity += quantity; // quantity ุณุงูุจ ุจุงููุนู
                        }
                        break;

                    case 'transfer':
                        // ุงูุชุญููู ุจูู ุงููุฎุงุฒู
                        if (movement.warehouseId === product.warehouseId) {
                            // ุฅุฎุฑุงุฌ ูู ุงููุฎุฒู ุงูุญุงูู
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                        } else if (movement.toWarehouseId === product.warehouseId) {
                            // ุฅุฏุฎุงู ูููุฎุฒู ุงูุญุงูู
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                        }
                        break;

                    default:
                        // ูุนุงูุฌุฉ ุงูุฃููุงุน ุงููุฏููุฉ ููุชูุงูู ูุน ุงููุณุฎ ุงูุณุงุจูุฉ
                        if (quantity > 0) {
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                        } else {
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                        }
                        console.warn(`โ๏ธ ููุน ุญุฑูุฉ ุบูุฑ ูุนุฑูู: ${movement.movementType} ููููุชุฌ ${product.name}`);
                }
            });

            // ุฅุถุงูุฉ ุฅุฎุฑุงุฌุงุช ูู ููุงุชูุฑ ุงููุจูุนุงุช ุงููุคูุฏุฉ
            const salesFromInvoices = (appData.invoices || [])
                .filter(inv =>
                    inv.invoiceType === 'sale' &&
                    inv.status === 'confirmed' &&
                    inv.isDeleted !== true
                )
                .reduce((sum, inv) => {
                    const item = inv.items.find(item => item.productId === product.id);
                    return sum + (item ? item.quantity : 0);
                }, 0);

            calculatedQuantity -= salesFromInvoices;
            totalOut += salesFromInvoices;

            // ุงูุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุง ุชููู ุณุงูุจุฉ
            calculatedQuantity = Math.max(0, calculatedQuantity);

            // ุชุญุฏูุซ ุงููููุฉ ุฅุฐุง ูุงูุช ูุฎุชููุฉ
            const currentQuantity = parseFloat(product.quantity) || 0;
            if (Math.abs(currentQuantity - calculatedQuantity) > 0.001) {
                console.log(`๐ฆ ุชุญุฏูุซ ูููุฉ ${product.name}: ${currentQuantity} โ ${calculatedQuantity}`);
                product.quantity = calculatedQuantity;
                product.totalIn = totalIn;
                product.totalOut = totalOut;
                product.lastCalculated = new Date().toISOString();
                updatedProductsCount++;
                recalculatedCount++;
            }
        });

        // ุญูุธ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
        saveData();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        setTimeout(() => {
            showWarehouseProductMovements(warehouseId);

            // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ
            const message = `ุชู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒู ุจูุฌุงุญ!\n\n` +
                          `โข ุชู ุชุญุฏูุซ ${updatedProductsCount} ููุชุฌ\n` +
                          `โข ุชู ุญุฐู ${deletedMovementsCount} ุญุฑูุฉ ุบูุฑ ุตุญูุญุฉ\n` +
                          `โข ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ${recalculatedCount} ูููุฉ\n` +
                          `โข ุชู ุงุญุชุณุงุจ ุงูุฅุฎุฑุงุฌุงุช ูู ุงููุจูุนุงุช`;

            if (updatedProductsCount > 0 || deletedMovementsCount > 0) {
                alert(message);
            }

            console.log('โ ุชู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒู:', {
                'ููุชุฌุงุช ูุญุฏุซุฉ': updatedProductsCount,
                'ุญุฑูุงุช ูุญุฐููุฉ': deletedMovementsCount,
                'ูููุงุช ูุนุงุฏ ุญุณุงุจูุง': recalculatedCount,
                'ูุฎุฒู': warehouse.name
            });

        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒู:', error);

        // ุงุณุชุนุงุฏุฉ ุงูุฒุฑ
        button.disabled = false;
        icon.classList.remove('fa-spin');
        button.innerHTML = originalText;

        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒู: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ ุชููุงุฆูุงู ูู ุงูููุงุชูุฑ ูุงูุณูุฏุงุช
 */
function generateJournalEntriesFromTransactions() {
    console.log('๐ ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ ูู ุงููุนุงููุงุช...');

    if (!appData.journalEntries) {
        appData.journalEntries = [];
    }

    let generatedCount = 0;

    // 1. ุฅูุดุงุก ูููุฏ ูู ุงูููุงุชูุฑ
    if (appData.invoices && appData.invoices.length > 0) {
        appData.invoices.forEach(invoice => {
            if (invoice.status === 'confirmed' && invoice.isDeleted !== true) {
                const existingEntry = appData.journalEntries.find(entry =>
                    entry.referenceType === 'invoice' &&
                    entry.referenceId === invoice.invoiceNumber
                );

                if (!existingEntry) {
                    const client = invoice.invoiceType === 'sale' ?
                        appData.customers.find(c => c.id === invoice.customerId) :
                        appData.suppliers.find(s => s.id === invoice.supplierId);

                    const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';

                    if (invoice.invoiceType === 'sale') {
                        // ููุฏ ูุงุชูุฑุฉ ุงููุจูุนุงุช
                        const salesEntry = {
                            id: generateId(),
                            entryDate: invoice.invoiceDate,
                            entryType: 'sale_invoice',
                            description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                            debitAccount: `ุงูุนููุงุก - ${clientName}`,
                            creditAccount: 'ุงููุจูุนุงุช',
                            debitAmount: invoice.totalAmount,
                            creditAmount: invoice.totalAmount,
                            currency: invoice.currency || 'SYP',
                            referenceType: 'invoice',
                            referenceId: invoice.invoiceNumber,
                            invoiceId: invoice.id,
                            customerId: invoice.customerId,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(salesEntry);
                        generatedCount++;

                        // ููุฏ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (ุฅุฐุง ูุงูุช ููุงู ุฃุตูุงู)
                        if (invoice.items && invoice.items.length > 0) {
                            let totalCost = 0;
                            invoice.items.forEach(item => {
                                const product = appData.products.find(p => p.id === item.productId);
                                if (product && product.costPrice) {
                                    totalCost += item.quantity * product.costPrice;
                                }
                            });

                            if (totalCost > 0) {
                                const costEntry = {
                                    id: generateId(),
                                    entryDate: invoice.invoiceDate,
                                    entryType: 'cost_of_goods_sold',
                                    description: `ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ - ูุงุชูุฑุฉ ${invoice.invoiceNumber}`,
                                    debitAccount: 'ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ',
                                    creditAccount: 'ุงููุฎุฒูู',
                                    debitAmount: totalCost,
                                    creditAmount: totalCost,
                                    currency: invoice.currency || 'SYP',
                                    referenceType: 'invoice',
                                    referenceId: invoice.invoiceNumber + '_cost',
                                    invoiceId: invoice.id,
                                    createdAt: new Date().toISOString(),
                                    source: 'auto_generated'
                                };

                                appData.journalEntries.push(costEntry);
                                generatedCount++;
                            }
                        }

                    } else {
                        // ููุฏ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
                        const purchaseEntry = {
                            id: generateId(),
                            entryDate: invoice.invoiceDate,
                            entryType: 'purchase_invoice',
                            description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                            debitAccount: 'ุงููุดุชุฑูุงุช',
                            creditAccount: `ุงูููุฑุฏูู - ${clientName}`,
                            debitAmount: invoice.totalAmount,
                            creditAmount: invoice.totalAmount,
                            currency: invoice.currency || 'SYP',
                            referenceType: 'invoice',
                            referenceId: invoice.invoiceNumber,
                            invoiceId: invoice.id,
                            supplierId: invoice.supplierId,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(purchaseEntry);
                        generatedCount++;
                    }
                }
            }
        });
    }

    // 2. ุฅูุดุงุก ูููุฏ ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน
    if (appData.payments && appData.payments.length > 0) {
        appData.payments.forEach(payment => {
            if (payment.status === 'confirmed' && payment.isDeleted !== true) {
                const existingEntry = appData.journalEntries.find(entry =>
                    entry.referenceType === payment.paymentType &&
                    entry.referenceId === payment.paymentNumber
                );

                if (!existingEntry) {
                    const client = payment.paymentType === 'receipt' ?
                        appData.customers.find(c => c.id === payment.customerId) :
                        appData.suppliers.find(s => s.id === payment.supplierId);

                    const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';

                    if (payment.paymentType === 'receipt') {
                        // ููุฏ ุณูุฏ ุงููุจุถ
                        const receiptEntry = {
                            id: generateId(),
                            entryDate: payment.paymentDate,
                            entryType: 'receipt',
                            description: `ุณูุฏ ูุจุถ ุฑูู ${payment.paymentNumber} - ${clientName}`,
                            debitAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' :
                                         payment.paymentMethod === 'bank' ? 'ุงูุจูู' :
                                         payment.paymentMethod === 'check' ? 'ุงูุดููุงุช ุชุญุช ุงูุชุญุตูู' :
                                         'ุญุณุงุจุงุช ุฃุฎุฑู',
                            creditAccount: `ุงูุนููุงุก - ${clientName}`,
                            debitAmount: payment.amount,
                            creditAmount: payment.amount,
                            currency: payment.currency || 'SYP',
                            referenceType: 'receipt',
                            referenceId: payment.paymentNumber,
                            paymentId: payment.id,
                            customerId: payment.customerId,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(receiptEntry);
                        generatedCount++;

                    } else {
                        // ููุฏ ุณูุฏ ุงูุฏูุน
                        const paymentEntry = {
                            id: generateId(),
                            entryDate: payment.paymentDate,
                            entryType: 'payment',
                            description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber} - ${clientName}`,
                            debitAccount: `ุงูููุฑุฏูู - ${clientName}`,
                            creditAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' :
                                          payment.paymentMethod === 'bank' ? 'ุงูุจูู' :
                                          payment.paymentMethod === 'check' ? 'ุงูุดููุงุช ุงููุฏููุนุฉ' :
                                          'ุญุณุงุจุงุช ุฃุฎุฑู',
                            debitAmount: payment.amount,
                            creditAmount: payment.amount,
                            currency: payment.currency || 'SYP',
                            referenceType: 'payment',
                            referenceId: payment.paymentNumber,
                            paymentId: payment.id,
                            supplierId: payment.supplierId,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(paymentEntry);
                        generatedCount++;
                    }
                }
            }
        });
    }

    // 3. ุฅูุดุงุก ูููุฏ ูู ุญุฑูุงุช ุงููุฎุฒูู (ุงุฎุชูุงุฑู)
    if (appData.inventoryMovements && appData.inventoryMovements.length > 0) {
        appData.inventoryMovements.forEach(movement => {
            if (movement.isDeleted !== true && movement.unitPrice > 0) {
                const existingEntry = appData.journalEntries.find(entry =>
                    entry.referenceType === 'movement' &&
                    entry.referenceId === (movement.reference || movement.id)
                );

                if (!existingEntry) {
                    const product = appData.products.find(p => p.id === movement.productId);
                    const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

                    const productName = product ? product.name : 'ุบูุฑ ูุญุฏุฏ';
                    const warehouseName = warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ';
                    const totalValue = movement.quantity * movement.unitPrice;

                    if (movement.movementType === 'in') {
                        const inventoryInEntry = {
                            id: generateId(),
                            entryDate: movement.date,
                            entryType: 'inventory_in',
                            description: `ุฅุฏุฎุงู ูุฎุฒูู - ${productName} - ${warehouseName}`,
                            debitAccount: 'ุงููุฎุฒูู',
                            creditAccount: movement.reference || 'ุญุณุงุจ ูุคูุช',
                            debitAmount: totalValue,
                            creditAmount: totalValue,
                            currency: 'SYP',
                            referenceType: 'movement',
                            referenceId: movement.reference || movement.id,
                            movementId: movement.id,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(inventoryInEntry);
                        generatedCount++;

                    } else if (movement.movementType === 'out') {
                        const inventoryOutEntry = {
                            id: generateId(),
                            entryDate: movement.date,
                            entryType: 'inventory_out',
                            description: `ุฅุฎุฑุงุฌ ูุฎุฒูู - ${productName} - ${warehouseName}`,
                            debitAccount: 'ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ',
                            creditAccount: 'ุงููุฎุฒูู',
                            debitAmount: totalValue,
                            creditAmount: totalValue,
                            currency: 'SYP',
                            referenceType: 'movement',
                            referenceId: movement.reference || movement.id,
                            movementId: movement.id,
                            createdAt: new Date().toISOString(),
                            source: 'auto_generated'
                        };

                        appData.journalEntries.push(inventoryOutEntry);
                        generatedCount++;
                    }
                }
            }
        });
    }

    console.log(`โ ุชู ุฅูุดุงุก ${generatedCount} ููุฏ ูุญุงุณุจู ุฌุฏูุฏ`);

    if (generatedCount > 0) {
        saveData();
        console.log('๐พ ุชู ุญูุธ ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูุฌุฏูุฏุฉ');
    }

    return generatedCount;
}

/**
 * ุชูุธูู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูููุฑุฑุฉ ุฃู ุบูุฑ ุงูุตุญูุญุฉ
 */
function cleanupJournalEntries() {
    console.log('๐งน ุชูุธูู ุงููููุฏ ุงููุญุงุณุจูุฉ...');

    if (!appData.journalEntries) {
        appData.journalEntries = [];
        return 0;
    }

    const initialCount = appData.journalEntries.length;

    // ุฅุฒุงูุฉ ุงููููุฏ ุงูููุฑุฑุฉ
    const uniqueEntries = [];
    const seenReferences = new Set();

    appData.journalEntries.forEach(entry => {
        const referenceKey = `${entry.referenceType}_${entry.referenceId}`;

        if (!seenReferences.has(referenceKey)) {
            seenReferences.add(referenceKey);
            uniqueEntries.push(entry);
        } else {
            console.log(`๐๏ธ ุญุฐู ููุฏ ููุฑุฑ: ${referenceKey}`);
        }
    });

    // ุฅุฒุงูุฉ ุงููููุฏ ุงูุชู ูุง ุชุญุชูู ุนูู ูุฑุงุฌุน ุตุญูุญุฉ
    const validEntries = uniqueEntries.filter(entry => {
        // ุงูุชุญูู ูู ุตุญุฉ ูููุฏ ุงูููุงุชูุฑ
        if (entry.referenceType === 'invoice' && entry.invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === entry.invoiceId);
            if (!invoice || invoice.isDeleted === true || invoice.status !== 'confirmed') {
                console.log(`๐๏ธ ุญุฐู ููุฏ ูุงุชูุฑุฉ ุบูุฑ ุตุญูุญ: ${entry.referenceId}`);
                return false;
            }
        }

        // ุงูุชุญูู ูู ุตุญุฉ ูููุฏ ุงูุณูุฏุงุช
        if ((entry.referenceType === 'receipt' || entry.referenceType === 'payment') && entry.paymentId) {
            const payment = appData.payments.find(pay => pay.id === entry.paymentId);
            if (!payment || payment.isDeleted === true || payment.status !== 'confirmed') {
                console.log(`๐๏ธ ุญุฐู ููุฏ ุณูุฏ ุบูุฑ ุตุญูุญ: ${entry.referenceId}`);
                return false;
            }
        }

        // ุงูุชุญูู ูู ุตุญุฉ ูููุฏ ุญุฑูุงุช ุงููุฎุฒูู
        if (entry.referenceType === 'movement' && entry.movementId) {
            const movement = appData.inventoryMovements.find(mov => mov.id === entry.movementId);
            if (!movement || movement.isDeleted === true) {
                console.log(`๐๏ธ ุญุฐู ููุฏ ุญุฑูุฉ ูุฎุฒูู ุบูุฑ ุตุญูุญ: ${entry.referenceId}`);
                return false;
            }
        }

        return true;
    });

    appData.journalEntries = validEntries;
    const cleanedCount = initialCount - validEntries.length;

    console.log(`โ ุชู ุชูุธูู ${cleanedCount} ููุฏ ูุญุงุณุจู`);

    if (cleanedCount > 0) {
        saveData();
    }

    return cleanedCount;
}

/**
 * ุชุญุฏูุซ ุดุงูู ูุฏูุชุฑ ุงูููููุฉ
 */
function refreshJournalEntries() {
    console.log('๐ ุชุญุฏูุซ ุดุงูู ูุฏูุชุฑ ุงูููููุฉ...');

    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    const originalText = button.innerHTML;

    // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุชุญููู
    button.disabled = true;
    icon.classList.add('fa-spin');
    button.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>ุฌุงุฑู ุงูุชุญุฏูุซ...';

    try {
        // ุชูุธูู ุงููููุฏ ุงููุฏููุฉ
        const cleanedCount = cleanupJournalEntries();

        // ุฅูุดุงุก ูููุฏ ุฌุฏูุฏุฉ
        const generatedCount = generateJournalEntriesFromTransactions();

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        setTimeout(() => {
            showPage('journal');

            const message = `ุชู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ุจูุฌุงุญ!\n\n` +
                          `โข ุชู ุชูุธูู ${cleanedCount} ููุฏ ูุฏูู\n` +
                          `โข ุชู ุฅูุดุงุก ${generatedCount} ููุฏ ุฌุฏูุฏ\n` +
                          `โข ุฅุฌูุงูู ุงููููุฏ: ${appData.journalEntries.length}`;

            if (cleanedCount > 0 || generatedCount > 0) {
                alert(message);
            }

            console.log('โ ุชู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ:', {
                'ูููุฏ ููุธูุฉ': cleanedCount,
                'ูููุฏ ุฌุฏูุฏุฉ': generatedCount,
                'ุฅุฌูุงูู ุงููููุฏ': appData.journalEntries.length
            });

        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ:', error);

        // ุงุณุชุนุงุฏุฉ ุงูุฒุฑ
        button.disabled = false;
        icon.classList.remove('fa-spin');
        button.innerHTML = originalText;

        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ: ' + error.message);
    }
}

// ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุจุฏุก ุงูุชุทุจูู
loadData();

// ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช
setTimeout(() => {
    if (appData && appData.customers && appData.suppliers) {
        console.log('๐ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุจุนุฏ ุชุญููู ุงูุจูุงูุงุช...');
        recalculateAllBalances();
    }
}, 1000);

// ========== ูุธุงู ุงูุซูู ุงููุถูุก ูุงููุธูู ==========

/**
 * ุชุจุฏูู ุงูุซูู ุจูู ุงููุถูุก ูุงููุธูู
 */
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);

    // ุชุญุฏูุซ ุฃููููุฉ ุงูุซูู
    updateThemeIcon(newTheme);
}

/**
 * ุชุญุฏูุซ ุฃููููุฉ ุงูุซูู
 */
function updateThemeIcon(theme) {
    const themeIcon = document.getElementById('theme-icon');
    if (themeIcon) {
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-sun me-2';
            // ุชุญุฏูุซ ุงููุต ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
            const parentLink = themeIcon.closest('a');
            if (parentLink) {
                parentLink.innerHTML = '<i class="fas fa-sun me-2" id="theme-icon"></i>ุงูุซูู ุงููุถูุก';
            }
        } else {
            themeIcon.className = 'fas fa-moon me-2';
            // ุชุญุฏูุซ ุงููุต ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
            const parentLink = themeIcon.closest('a');
            if (parentLink) {
                parentLink.innerHTML = '<i class="fas fa-moon me-2" id="theme-icon"></i>ุงูุซูู ุงููุธูู';
            }
        }
    }
}

/**
 * ุชุญููู ุงูุซูู ุงููุญููุธ
 */
function loadSavedTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

/**
 * ุชุทุจูู ุงูุซูู ุนูู ุงูููุงูุฐ ุงูููุจุซูุฉ
 */
function applyThemeToModal(modal) {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    if (currentTheme === 'dark') {
        modal.classList.add('dark-theme');
    }
}

// ุชุญููู ุงูุซูู ุนูุฏ ุจุฏุก ุงูุชุทุจูู
document.addEventListener('DOMContentLoaded', function() {
    loadSavedTheme();
});

// ========== ูุธุงุฆู ุงูุชุตููุฉ ุงููุชูุฏูุฉ ==========

/**
 * ุชุทุจูู ููุงุชุฑ ููุงุชูุฑ ุงููุจูุนุงุช
 */
function applySalesInvoicesFilter() {
    const customerFilter = document.getElementById('customerFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const fromDate = document.getElementById('salesFromDate')?.value || '';
    const toDate = document.getElementById('salesToDate')?.value || '';
    const searchText = document.getElementById('salesSearch')?.value.toLowerCase() || '';

    let filteredInvoices = appData.invoices.filter(inv => inv.invoiceType === 'sale');

    // ุชุทุจูู ููุชุฑ ุงูุนููู
    if (customerFilter) {
        filteredInvoices = filteredInvoices.filter(inv => inv.customerId == customerFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุญุงูุฉ
    if (statusFilter) {
        filteredInvoices = filteredInvoices.filter(inv => inv.status === statusFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.invoiceDate >= fromDate);
    }
    if (toDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.invoiceDate <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredInvoices = filteredInvoices.filter(inv => {
            const customer = appData.customers.find(c => c.id === inv.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';
            const invoiceNumber = inv.invoiceNumber.toLowerCase();

            return invoiceNumber.includes(searchText) || customerName.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateSalesInvoicesTable(filteredInvoices);
}

/**
 * ูุณุญ ููุงุชุฑ ููุงุชูุฑ ุงููุจูุนุงุช
 */
function clearSalesInvoicesFilter() {
    const customerFilter = document.getElementById('customerFilter');
    const statusFilter = document.getElementById('statusFilter');
    const fromDate = document.getElementById('salesFromDate');
    const toDate = document.getElementById('salesToDate');
    const searchText = document.getElementById('salesSearch');

    if (customerFilter) customerFilter.value = '';
    if (statusFilter) statusFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';

    // ุนุฑุถ ุฌููุน ุงูููุงุชูุฑ
    const allSalesInvoices = appData.invoices.filter(inv => inv.invoiceType === 'sale');
    updateSalesInvoicesTable(allSalesInvoices);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ููุงุชูุฑ ุงููุจูุนุงุช
 */
function updateSalesInvoicesTable(invoices) {
    const tableContainer = document.querySelector('#main-content .card:last-child .card-body');
    if (!tableContainer) return;

    if (invoices.length > 0) {
        tableContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th>ุงูุนููู</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                            <th>ุงููุฏููุน</th>
                            <th>ุงููุชุจูู</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${getSalesInvoicesRows(invoices)}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        tableContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                <p class="text-muted">ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                <button class="btn btn-primary" onclick="clearSalesInvoicesFilter()">
                    <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                </button>
            </div>
        `;
    }
}

/**
 * ุชุทุจูู ููุงุชุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช
 */
function applyPurchaseInvoicesFilter() {
    const supplierFilter = document.getElementById('supplierFilter')?.value || '';
    const statusFilter = document.getElementById('purchaseStatusFilter')?.value || '';
    const fromDate = document.getElementById('purchaseFromDate')?.value || '';
    const toDate = document.getElementById('purchaseToDate')?.value || '';
    const searchText = document.getElementById('purchaseSearch')?.value.toLowerCase() || '';

    let filteredInvoices = appData.invoices.filter(inv => inv.invoiceType === 'purchase');

    // ุชุทุจูู ููุชุฑ ุงูููุฑุฏ
    if (supplierFilter) {
        filteredInvoices = filteredInvoices.filter(inv => inv.supplierId == supplierFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุญุงูุฉ
    if (statusFilter) {
        filteredInvoices = filteredInvoices.filter(inv => inv.status === statusFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.invoiceDate >= fromDate);
    }
    if (toDate) {
        filteredInvoices = filteredInvoices.filter(inv => inv.invoiceDate <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredInvoices = filteredInvoices.filter(inv => {
            const supplier = appData.suppliers.find(s => s.id === inv.supplierId);
            const supplierName = supplier ? supplier.name.toLowerCase() : '';
            const invoiceNumber = inv.invoiceNumber.toLowerCase();

            return invoiceNumber.includes(searchText) || supplierName.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updatePurchaseInvoicesTable(filteredInvoices);
}

/**
 * ูุณุญ ููุงุชุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช
 */
function clearPurchaseInvoicesFilter() {
    const supplierFilter = document.getElementById('supplierFilter');
    const statusFilter = document.getElementById('purchaseStatusFilter');
    const fromDate = document.getElementById('purchaseFromDate');
    const toDate = document.getElementById('purchaseToDate');
    const searchText = document.getElementById('purchaseSearch');

    if (supplierFilter) supplierFilter.value = '';
    if (statusFilter) statusFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';

    // ุนุฑุถ ุฌููุน ุงูููุงุชูุฑ
    const allPurchaseInvoices = appData.invoices.filter(inv => inv.invoiceType === 'purchase');
    updatePurchaseInvoicesTable(allPurchaseInvoices);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ููุงุชูุฑ ุงููุดุชุฑูุงุช
 */
function updatePurchaseInvoicesTable(invoices) {
    const tableContainer = document.getElementById('purchaseInvoicesTableContainer') ||
                          document.querySelector('#main-content .card:last-child .card-body');
    if (!tableContainer) return;

    if (invoices.length > 0) {
        tableContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th>ุงูููุฑุฏ</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                            <th>ุงููุฏููุน</th>
                            <th>ุงููุชุจูู</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${getPurchaseInvoicesRows(invoices)}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        tableContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                <p class="text-muted">ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                <button class="btn btn-primary" onclick="clearPurchaseInvoicesFilter()">
                    <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                </button>
            </div>
        `;
    }
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ููุงุชูุฑ ุงููุจูุนุงุช
 */
function updateSalesInvoicesTable(invoices) {
    const tableContainer = document.getElementById('salesInvoicesTableContainer') ||
                          document.querySelector('#main-content .card:last-child .card-body');
    if (!tableContainer) return;

    if (invoices.length > 0) {
        tableContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                            <th>ุงูุนููู</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                            <th>ุงููุฏููุน</th>
                            <th>ุงููุชุจูู</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${getSalesInvoicesRows(invoices)}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        tableContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                <p class="text-muted">ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                <button class="btn btn-primary" onclick="clearSalesInvoicesFilter()">
                    <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                </button>
            </div>
        `;
    }
}

/**
 * ุชุทุจูู ููุงุชุฑ ุงูุนููุงุก
 */
function applyCustomersFilter() {
    const searchText = document.getElementById('customerSearch')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('customerTypeFilter')?.value || '';
    const cityFilter = document.getElementById('customerCityFilter')?.value || '';

    let filteredCustomers = appData.customers;

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredCustomers = filteredCustomers.filter(customer => {
            const name = customer.name.toLowerCase();
            const phone = customer.phone.toLowerCase();
            const email = (customer.email || '').toLowerCase();

            return name.includes(searchText) || phone.includes(searchText) || email.includes(searchText);
        });
    }

    // ุชุทุจูู ููุชุฑ ุงูููุน
    if (typeFilter) {
        filteredCustomers = filteredCustomers.filter(customer => customer.type === typeFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงููุฏููุฉ
    if (cityFilter) {
        filteredCustomers = filteredCustomers.filter(customer => customer.city === cityFilter);
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateCustomersTable(filteredCustomers);
}

/**
 * ุชุทุจูู ููุงุชุฑ ุงูููุฑุฏูู
 */
function applySuppliersFilter() {
    const searchText = document.getElementById('supplierSearch')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('supplierTypeFilter')?.value || '';
    const balanceFilter = document.getElementById('supplierBalanceFilter')?.value || '';

    let filteredSuppliers = appData.suppliers;

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredSuppliers = filteredSuppliers.filter(supplier => {
            const name = supplier.name.toLowerCase();
            const phone = (supplier.phone || '').toLowerCase();
            const email = (supplier.email || '').toLowerCase();

            return name.includes(searchText) || phone.includes(searchText) || email.includes(searchText);
        });
    }

    // ุชุทุจูู ููุชุฑ ุงูููุน
    if (typeFilter) {
        filteredSuppliers = filteredSuppliers.filter(supplier => supplier.type === typeFilter);
    }

    // ุชุทุจูู ููุชุฑ ุญุงูุฉ ุงูุฑุตูุฏ
    if (balanceFilter) {
        filteredSuppliers = filteredSuppliers.filter(supplier => {
            const balance = supplier.currentBalance || 0;
            switch (balanceFilter) {
                case 'positive': return balance > 0;
                case 'negative': return balance < 0;
                case 'zero': return balance === 0;
                default: return true;
            }
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateSuppliersTable(filteredSuppliers);
}

/**
 * ูุณุญ ููุงุชุฑ ุงูููุฑุฏูู
 */
function clearSuppliersFilter() {
    const searchInput = document.getElementById('supplierSearch');
    const typeFilter = document.getElementById('supplierTypeFilter');
    const balanceFilter = document.getElementById('supplierBalanceFilter');

    if (searchInput) searchInput.value = '';
    if (typeFilter) typeFilter.value = '';
    if (balanceFilter) balanceFilter.value = '';

    // ุนุฑุถ ุฌููุน ุงูููุฑุฏูู
    updateSuppliersTable(appData.suppliers);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุงูููุฑุฏูู
 */
function updateSuppliersTable(suppliers) {
    const tableContainer = document.querySelector('#suppliersTable tbody') ||
                          document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (suppliers.length > 0) {
        tableContainer.innerHTML = suppliers.map(supplier => `
            <tr>
                <td>
                    <strong>${supplier.name}</strong>
                    ${supplier.taxNumber ? `<br><small class="text-muted">ุงูุฑูู ุงูุถุฑูุจู: ${supplier.taxNumber}</small>` : ''}
                </td>
                <td>${supplier.phone || '-'}</td>
                <td>${supplier.email || '-'}</td>
                <td>
                    <span class="badge bg-${supplier.currentBalance > 0 ? 'success' : supplier.currentBalance < 0 ? 'danger' : 'secondary'}">
                        ${formatCurrency(supplier.currentBalance || 0)}
                        ${supplier.currentBalance > 0 ? '(ุฏุงุฆู)' : supplier.currentBalance < 0 ? '(ูุฏูู)' : '(ูุชูุงุฒู)'}
                    </span>
                </td>
                <td>${supplier.createdAt}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editSupplier(${supplier.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewSupplierStatement(${supplier.id})" title="ูุดู ุญุณุงุจ">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${supplier.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-truck fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ููุฑุฏูู ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearSuppliersFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุชุทุจูู ููุงุชุฑ ุงูุฃุตูุงู
 */
function applyProductsFilter() {
    const searchText = document.getElementById('productSearch')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('productCategoryFilter')?.value || '';
    const warehouseFilter = document.getElementById('productWarehouseFilter')?.value || '';
    const stockFilter = document.getElementById('productStockFilter')?.value || '';

    let filteredProducts = appData.products;

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredProducts = filteredProducts.filter(product => {
            const name = product.name.toLowerCase();
            const code = product.code.toLowerCase();
            const description = (product.description || '').toLowerCase();

            return name.includes(searchText) || code.includes(searchText) || description.includes(searchText);
        });
    }

    // ุชุทุจูู ููุชุฑ ุงููุฆุฉ
    if (categoryFilter) {
        filteredProducts = filteredProducts.filter(product => product.category === categoryFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงููุฎุฒู
    if (warehouseFilter) {
        filteredProducts = filteredProducts.filter(product => product.warehouseId == warehouseFilter);
    }

    // ุชุทุจูู ููุชุฑ ุญุงูุฉ ุงููุฎุฒูู
    if (stockFilter) {
        filteredProducts = filteredProducts.filter(product => {
            const quantity = product.quantity || 0;
            const minQuantity = product.minQuantity || 0;

            switch (stockFilter) {
                case 'low': return quantity <= minQuantity && quantity > 0;
                case 'normal': return quantity > minQuantity;
                case 'out': return quantity === 0;
                default: return true;
            }
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateProductsTable(filteredProducts);
}

/**
 * ูุณุญ ููุงุชุฑ ุงูุฃุตูุงู
 */
function clearProductsFilter() {
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('productCategoryFilter');
    const warehouseFilter = document.getElementById('productWarehouseFilter');
    const stockFilter = document.getElementById('productStockFilter');

    if (searchInput) searchInput.value = '';
    if (categoryFilter) categoryFilter.value = '';
    if (warehouseFilter) warehouseFilter.value = '';
    if (stockFilter) stockFilter.value = '';

    // ุนุฑุถ ุฌููุน ุงูุฃุตูุงู
    updateProductsTable(appData.products);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุงูุฃุตูุงู
 */
function updateProductsTable(products) {
    const tableContainer = document.querySelector('#productsTable tbody') ||
                          document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (products.length > 0) {
        tableContainer.innerHTML = products.map(product => {
            const isLowStock = product.quantity <= product.minQuantity;
            return `
                <tr class="${isLowStock ? 'table-warning' : ''}">
                    <td><strong>${product.code}</strong></td>
                    <td>
                        ${product.name}
                        ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                    </td>
                    <td>${product.unit}</td>
                    <td>${formatCurrency(product.costPrice)}</td>
                    <td>${formatCurrency(product.sellingPrice)}</td>
                    <td>
                        <span class="badge bg-${isLowStock ? 'danger' : 'success'}">
                            ${product.quantity} ${product.unit}
                        </span>
                    </td>
                    <td>${product.minQuantity} ${product.unit}</td>
                    <td>
                        ${isLowStock ? '<i class="fas fa-exclamation-triangle text-warning" title="ูุฎุฒูู ููุฎูุถ"></i>' : '<i class="fas fa-check-circle text-success" title="ูุฎุฒูู ุขูู"></i>'}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})" title="ุชุนุฏูู">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewProductMovements(${product.id})" title="ุญุฑูุฉ ุงููุฎุฒูู">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="fas fa-boxes fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ุฃุตูุงู ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearProductsFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุชุทุจูู ููุงุชุฑ ุณูุฏุงุช ุงููุจุถ
 */
function applyReceiptsFilter() {
    const customerFilter = document.getElementById('receiptCustomerFilter')?.value || '';
    const methodFilter = document.getElementById('receiptMethodFilter')?.value || '';
    const fromDate = document.getElementById('receiptFromDate')?.value || '';
    const toDate = document.getElementById('receiptToDate')?.value || '';
    const searchText = document.getElementById('receiptSearch')?.value.toLowerCase() || '';

    let filteredReceipts = appData.payments.filter(p => p.paymentType === 'receipt');

    // ุชุทุจูู ููุชุฑ ุงูุนููู
    if (customerFilter) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.customerId == customerFilter);
    }

    // ุชุทุจูู ููุชุฑ ุทุฑููุฉ ุงูุฏูุน
    if (methodFilter) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.paymentMethod === methodFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.paymentDate >= fromDate);
    }
    if (toDate) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.paymentDate <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredReceipts = filteredReceipts.filter(receipt => {
            const customer = appData.customers.find(c => c.id === receipt.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';
            const receiptNumber = receipt.paymentNumber.toLowerCase();

            return receiptNumber.includes(searchText) || customerName.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateReceiptsTable(filteredReceipts);
}

/**
 * ูุณุญ ููุงุชุฑ ุณูุฏุงุช ุงููุจุถ
 */
function clearReceiptsFilter() {
    const customerFilter = document.getElementById('receiptCustomerFilter');
    const methodFilter = document.getElementById('receiptMethodFilter');
    const fromDate = document.getElementById('receiptFromDate');
    const toDate = document.getElementById('receiptToDate');
    const searchText = document.getElementById('receiptSearch');

    if (customerFilter) customerFilter.value = '';
    if (methodFilter) methodFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';

    // ุนุฑุถ ุฌููุน ุณูุฏุงุช ุงููุจุถ
    const allReceipts = appData.payments.filter(p => p.paymentType === 'receipt');
    updateReceiptsTable(allReceipts);
}

/**
 * ุชุทุจูู ููุงุชุฑ ุณูุฏุงุช ุงูุฏูุน
 */
function applyPaymentsFilter() {
    const supplierFilter = document.getElementById('paymentSupplierFilter')?.value || '';
    const methodFilter = document.getElementById('paymentMethodFilter')?.value || '';
    const fromDate = document.getElementById('paymentFromDate')?.value || '';
    const toDate = document.getElementById('paymentToDate')?.value || '';
    const searchText = document.getElementById('paymentSearch')?.value.toLowerCase() || '';

    let filteredPayments = appData.payments.filter(p => p.paymentType === 'payment');

    // ุชุทุจูู ููุชุฑ ุงูููุฑุฏ
    if (supplierFilter) {
        filteredPayments = filteredPayments.filter(payment => payment.supplierId == supplierFilter);
    }

    // ุชุทุจูู ููุชุฑ ุทุฑููุฉ ุงูุฏูุน
    if (methodFilter) {
        filteredPayments = filteredPayments.filter(payment => payment.paymentMethod === methodFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredPayments = filteredPayments.filter(payment => payment.paymentDate >= fromDate);
    }
    if (toDate) {
        filteredPayments = filteredPayments.filter(payment => payment.paymentDate <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredPayments = filteredPayments.filter(payment => {
            const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
            const supplierName = supplier ? supplier.name.toLowerCase() : '';
            const paymentNumber = payment.paymentNumber.toLowerCase();

            return paymentNumber.includes(searchText) || supplierName.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updatePaymentsTable(filteredPayments);
}

/**
 * ูุณุญ ููุงุชุฑ ุณูุฏุงุช ุงูุฏูุน
 */
function clearPaymentsFilter() {
    const supplierFilter = document.getElementById('paymentSupplierFilter');
    const methodFilter = document.getElementById('paymentMethodFilter');
    const fromDate = document.getElementById('paymentFromDate');
    const toDate = document.getElementById('paymentToDate');
    const searchText = document.getElementById('paymentSearch');

    if (supplierFilter) supplierFilter.value = '';
    if (methodFilter) methodFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';

    // ุนุฑุถ ุฌููุน ุณูุฏุงุช ุงูุฏูุน
    const allPayments = appData.payments.filter(p => p.paymentType === 'payment');
    updatePaymentsTable(allPayments);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุณูุฏุงุช ุงููุจุถ
 */
function updateReceiptsTable(receipts) {
    const tableContainer = document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (receipts.length > 0) {
        tableContainer.innerHTML = receipts.map(receipt => {
            const customer = appData.customers.find(c => c.id === receipt.customerId);
            return `
                <tr>
                    <td><strong>${receipt.paymentNumber}</strong></td>
                    <td>${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                    <td>${receipt.paymentDate}</td>
                    <td>${formatCurrency(receipt.amount)}</td>
                    <td>${getPaymentMethodText(receipt.paymentMethod)}</td>
                    <td>${receipt.referenceNumber || '-'}</td>
                    <td><span class="badge bg-${getStatusColor(receipt.status)}">${getStatusText(receipt.status)}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewReceipt(${receipt.id})" title="ุนุฑุถ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="printReceipt(${receipt.id})" title="ุทุจุงุนุฉ">
                                <i class="fas fa-print"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-info" onclick="editReceipt(${receipt.id})" title="ุชุนุฏูู">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReceipt(${receipt.id})" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-hand-holding-usd fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ุณูุฏุงุช ูุจุถ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearReceiptsFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุณูุฏุงุช ุงูุฏูุน
 */
function updatePaymentsTable(payments) {
    const tableContainer = document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (payments.length > 0) {
        tableContainer.innerHTML = payments.map(payment => {
            const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
            return `
                <tr>
                    <td><strong>${payment.paymentNumber}</strong></td>
                    <td>${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                    <td>${payment.paymentDate}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                    <td>${payment.referenceNumber || '-'}</td>
                    <td><span class="badge bg-${getStatusColor(payment.status)}">${getStatusText(payment.status)}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})" title="ุนุฑุถ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="printPayment(${payment.id})" title="ุทุจุงุนุฉ">
                                <i class="fas fa-print"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-info" onclick="editPayment(${payment.id})" title="ุชุนุฏูู">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id})" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ุณูุฏุงุช ุฏูุน ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearPaymentsFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุงูุญุตูู ุนูู ูุต ุทุฑููุฉ ุงูุฏูุน
 */
function getPaymentMethodText(method) {
    const methods = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };
    return methods[method] || method;
}

/**
 * ุชุทุจูู ููุงุชุฑ ุฏูุชุฑ ุงูููููุฉ
 */
function applyJournalFilter() {
    console.log('๐ ุชุทุจูู ููุงุชุฑ ุฏูุชุฑ ุงูููููุฉ...');

    // ุฌูุน ุฌููุน ุงูููุงุชุฑ
    const typeFilter = document.getElementById('journalTypeFilter')?.value || '';
    const fromDate = document.getElementById('journalFromDate')?.value || '';
    const toDate = document.getElementById('journalToDate')?.value || '';
    const currencyFilter = document.getElementById('journalCurrencyFilter')?.value || '';
    const accountFilter = document.getElementById('journalAccountFilter')?.value || '';
    const searchText = document.getElementById('journalSearch')?.value.toLowerCase() || '';
    const amountRange = document.getElementById('journalAmountRange')?.value || '';
    const balanceFilter = document.getElementById('journalBalanceFilter')?.value || '';
    const clientFilter = document.getElementById('journalClientFilter')?.value || '';
    const referenceFilter = document.getElementById('journalReferenceFilter')?.value.toLowerCase() || '';
    const sortOrder = document.getElementById('journalSortOrder')?.value || 'date_desc';

    // ุงูุญุตูู ุนูู ุฌููุน ุงููููุฏ ูู ูุตุงุฏุฑ ูุฎุชููุฉ (ููุณ ููุทู getJournalEntriesRows)
    let allEntries = [];

    // 1. ุงููููุฏ ุงููุฏููุฉ ุงูููุฌูุฏุฉ
    if (appData.journalEntries && appData.journalEntries.length > 0) {
        allEntries = [...appData.journalEntries];
    }

    // 2. ูููุฏ ูู ุงูููุงุชูุฑ
    if (appData.invoices && appData.invoices.length > 0) {
        appData.invoices.forEach(invoice => {
            if (invoice.status === 'confirmed' && invoice.isDeleted !== true) {
                const client = invoice.invoiceType === 'sale' ?
                    appData.customers.find(c => c.id === invoice.customerId) :
                    appData.suppliers.find(s => s.id === invoice.supplierId);

                const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';
                const invoiceTypeText = invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช';

                if (invoice.invoiceType === 'sale') {
                    allEntries.push({
                        entryDate: invoice.invoiceDate,
                        entryType: 'sale_invoice',
                        description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                        debitAccount: `ุงูุนููุงุก - ${clientName}`,
                        creditAccount: 'ุงููุจูุนุงุช',
                        debitAmount: invoice.totalAmount,
                        creditAmount: invoice.totalAmount,
                        currency: invoice.currency || 'SYP',
                        referenceType: 'invoice',
                        referenceId: invoice.invoiceNumber,
                        source: 'invoice',
                        customerId: invoice.customerId,
                        invoiceId: invoice.id
                    });
                } else {
                    allEntries.push({
                        entryDate: invoice.invoiceDate,
                        entryType: 'purchase_invoice',
                        description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                        debitAccount: 'ุงููุดุชุฑูุงุช',
                        creditAccount: `ุงูููุฑุฏูู - ${clientName}`,
                        debitAmount: invoice.totalAmount,
                        creditAmount: invoice.totalAmount,
                        currency: invoice.currency || 'SYP',
                        referenceType: 'invoice',
                        referenceId: invoice.invoiceNumber,
                        source: 'invoice',
                        supplierId: invoice.supplierId,
                        invoiceId: invoice.id
                    });
                }
            }
        });
    }

    // 3. ูููุฏ ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน
    if (appData.payments && appData.payments.length > 0) {
        appData.payments.forEach(payment => {
            if (payment.status === 'confirmed' && payment.isDeleted !== true) {
                const client = payment.paymentType === 'receipt' ?
                    appData.customers.find(c => c.id === payment.customerId) :
                    appData.suppliers.find(s => s.id === payment.supplierId);

                const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';

                if (payment.paymentType === 'receipt') {
                    allEntries.push({
                        entryDate: payment.paymentDate,
                        entryType: 'receipt',
                        description: `ุณูุฏ ูุจุถ ุฑูู ${payment.paymentNumber} - ${clientName}`,
                        debitAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                        creditAccount: `ุงูุนููุงุก - ${clientName}`,
                        debitAmount: payment.amount,
                        creditAmount: payment.amount,
                        currency: payment.currency || 'SYP',
                        referenceType: 'receipt',
                        referenceId: payment.paymentNumber,
                        source: 'payment',
                        customerId: payment.customerId,
                        paymentId: payment.id
                    });
                } else {
                    allEntries.push({
                        entryDate: payment.paymentDate,
                        entryType: 'payment',
                        description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber} - ${clientName}`,
                        debitAccount: `ุงูููุฑุฏูู - ${clientName}`,
                        creditAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                        debitAmount: payment.amount,
                        creditAmount: payment.amount,
                        currency: payment.currency || 'SYP',
                        referenceType: 'payment',
                        referenceId: payment.paymentNumber,
                        source: 'payment',
                        supplierId: payment.supplierId,
                        paymentId: payment.id
                    });
                }
            }
        });
    }

    console.log(`๐ ุฅุฌูุงูู ุงููููุฏ ูุจู ุงูููุชุฑุฉ: ${allEntries.length}`);

    // ุชุทุจูู ุงูููุงุชุฑ
    let filteredEntries = allEntries;

    // ููุชุฑ ููุน ุงูุนูููุฉ
    if (typeFilter) {
        filteredEntries = filteredEntries.filter(entry => {
            switch (typeFilter) {
                case 'sale_invoice':
                    return entry.entryType === 'sale_invoice';
                case 'purchase_invoice':
                    return entry.entryType === 'purchase_invoice';
                case 'invoice':
                    return entry.entryType === 'sale_invoice' || entry.entryType === 'purchase_invoice';
                case 'receipt':
                    return entry.entryType === 'receipt';
                case 'payment':
                    return entry.entryType === 'payment';
                case 'all_payments':
                    return entry.entryType === 'receipt' || entry.entryType === 'payment';
                case 'inventory_in':
                    return entry.entryType === 'inventory_in';
                case 'inventory_out':
                    return entry.entryType === 'inventory_out';
                case 'inventory_transfer':
                    return entry.entryType === 'inventory_transfer';
                case 'inventory_adjustment':
                    return entry.entryType === 'inventory_adjustment';
                case 'adjustment':
                    return entry.entryType === 'adjustment';
                case 'opening':
                    return entry.entryType === 'opening';
                case 'closing':
                    return entry.entryType === 'closing';
                case 'manual':
                    return entry.entryType === 'manual';
                default:
                    return true;
            }
        });
    }

    // ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredEntries = filteredEntries.filter(entry => {
            const entryDate = entry.entryDate || entry.date;
            return entryDate >= fromDate;
        });
    }
    if (toDate) {
        filteredEntries = filteredEntries.filter(entry => {
            const entryDate = entry.entryDate || entry.date;
            return entryDate <= toDate;
        });
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู ุงููุญุณู
    if (searchText) {
        filteredEntries = filteredEntries.filter(entry => {
            const description = (entry.description || '').toLowerCase();
            const debitAccount = (entry.debitAccount || '').toLowerCase();
            const creditAccount = (entry.creditAccount || '').toLowerCase();
            const reference = (entry.reference || entry.referenceNumber || '').toLowerCase();
            const entryNumber = (entry.entryNumber || '').toLowerCase();
            const entryDate = (entry.entryDate || entry.date || '').toLowerCase();
            const amount = (entry.debitAmount || entry.creditAmount || 0).toString();
            const currency = (entry.currency || '').toLowerCase();

            return description.includes(searchText) ||
                   debitAccount.includes(searchText) ||
                   creditAccount.includes(searchText) ||
                   reference.includes(searchText) ||
                   entryNumber.includes(searchText) ||
                   entryDate.includes(searchText) ||
                   amount.includes(searchText) ||
                   currency.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู ูุน ุงูุฅุญุตุงุฆูุงุช
    updateJournalTable(filteredEntries);

    // ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูููุชุฑุฉ
    showJournalFilterStats(filteredEntries);
}

/**
 * ูุณุญ ููุงุชุฑ ุฏูุชุฑ ุงูููููุฉ
 */
function clearJournalFilter() {
    // ูุณุญ ููุงุชุฑ ุฏูุชุฑ ุงูููููุฉ ุงููุญุณูุฉ
    const typeFilter = document.getElementById('journalTypeFilter');
    const fromDate = document.getElementById('journalFromDate');
    const toDate = document.getElementById('journalToDate');
    const searchText = document.getElementById('journalSearch');
    const currencyFilter = document.getElementById('journalCurrencyFilter');
    const accountFilter = document.getElementById('journalAccountFilter');

    if (typeFilter) typeFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';
    if (currencyFilter) currencyFilter.value = '';
    if (accountFilter) accountFilter.value = '';

    // ุนุฑุถ ุฌููุน ุงููููุฏ
    updateJournalTable(appData.journalEntries || []);
    showJournalFilterStats(appData.journalEntries || []);

    console.log('๐ ุชู ูุณุญ ุฌููุน ููุงุชุฑ ุฏูุชุฑ ุงูููููุฉ');
}

/**
 * ุนุฑุถ ุฅุญุตุงุฆูุงุช ููุชุฑุฉ ุฏูุชุฑ ุงูููููุฉ
 */
function showJournalFilterStats(entries) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    let totalDebit = 0;
    let totalCredit = 0;
    const currencyTotals = {};
    const typeCounts = {};

    entries.forEach(entry => {
        const debitAmount = entry.debitAmount || 0;
        const creditAmount = entry.creditAmount || 0;
        const currency = entry.currency || 'SYP';
        const entryType = entry.entryType || 'other';

        totalDebit += debitAmount;
        totalCredit += creditAmount;

        // ุฅุญุตุงุฆูุงุช ุงูุนููุงุช
        if (!currencyTotals[currency]) {
            currencyTotals[currency] = { debit: 0, credit: 0, count: 0 };
        }
        currencyTotals[currency].debit += debitAmount;
        currencyTotals[currency].credit += creditAmount;
        currencyTotals[currency].count++;

        // ุฅุญุตุงุฆูุงุช ุฃููุงุน ุงููููุฏ
        typeCounts[entryType] = (typeCounts[entryType] || 0) + 1;
    });

    // ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
    const statsContainer = document.getElementById('journalFilterStats');
    if (statsContainer) {
        const currencyStatsHtml = Object.keys(currencyTotals).map(currency => {
            const stats = currencyTotals[currency];
            const symbol = getCurrencySymbol(currency);
            return `
                <div class="col-md-3 mb-2">
                    <div class="card border-primary">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">${currency} ${symbol}</h6>
                            <small class="text-muted">
                                ูุฏูู: ${formatCurrency(stats.debit)} ${symbol}<br>
                                ุฏุงุฆู: ${formatCurrency(stats.credit)} ${symbol}<br>
                                ุนุฏุฏ ุงููููุฏ: ${stats.count}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        statsContainer.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-info mb-2">
                        <strong>ุฅุฌูุงูู ุงููููุฏ ุงููููุชุฑุฉ:</strong> ${entries.length} ููุฏ<br>
                        <strong>ุฅุฌูุงูู ุงููุฏูู:</strong> ${formatCurrency(totalDebit)}<br>
                        <strong>ุฅุฌูุงูู ุงูุฏุงุฆู:</strong> ${formatCurrency(totalCredit)}<br>
                        <strong>ุงููุฑู:</strong> ${formatCurrency(Math.abs(totalDebit - totalCredit))}
                        ${totalDebit !== totalCredit ? '<span class="text-warning"> (ุบูุฑ ูุชูุงุฒู)</span>' : '<span class="text-success"> (ูุชูุงุฒู)</span>'}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        ${currencyStatsHtml}
                    </div>
                </div>
            </div>
        `;
    }
}







/**
 * ุชุญุฏูุซ ุฌุฏูู ุฏูุชุฑ ุงูููููุฉ
 */
function updateJournalTable(entries) {
    const tableContainer = document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (entries.length > 0) {
        let totalDebit = 0;
        let totalCredit = 0;

        // ุชุฑุชูุจ ุงููููุฏ ุญุณุจ ุงูุชุงุฑูุฎ
        const sortedEntries = entries.sort((a, b) => new Date(a.entryDate || a.date) - new Date(b.entryDate || b.date));

        tableContainer.innerHTML = sortedEntries.map((entry, index) => {
            const debitAmount = entry.debitAmount || 0;
            const creditAmount = entry.creditAmount || 0;

            totalDebit += debitAmount;
            totalCredit += creditAmount;

            // ุชุญุฏูุฏ ููุน ุงูุนูููุฉ ูููููุง
            const entryTypeInfo = getEntryTypeInfo(entry);
            const currencySymbol = entry.currency ? getCurrencySymbol(entry.currency) : 'ู.ุณ';

            return `
                <tr class="journal-entry-row">
                    <td>
                        <strong>${formatDate(entry.entryDate || entry.date)}</strong>
                        <br><small class="text-muted">${entry.createdAt ? formatDateTime(entry.createdAt).split(' ')[1] : ''}</small>
                    </td>
                    <td>
                        <span class="badge bg-${entryTypeInfo.color} fs-6">
                            <i class="${entryTypeInfo.icon} me-1"></i>
                            ${entryTypeInfo.text}
                        </span>
                    </td>
                    <td>
                        <div class="fw-bold">${entry.description}</div>
                        ${entry.referenceType ? `<small class="text-muted">ูุฑุฌุน: ${entry.referenceType}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-danger bg-opacity-10 text-danger">
                            <i class="fas fa-arrow-up me-1"></i>
                            ${entry.debitAccount}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-success bg-opacity-10 text-success">
                            <i class="fas fa-arrow-down me-1"></i>
                            ${entry.creditAccount}
                        </span>
                    </td>
                    <td class="text-end">
                        <strong class="text-danger">
                            ${debitAmount > 0 ? formatCurrency(debitAmount, entry.currency) : '-'}
                        </strong>
                    </td>
                    <td class="text-end">
                        <strong class="text-success">
                            ${creditAmount > 0 ? formatCurrency(creditAmount, entry.currency) : '-'}
                        </strong>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">
                            ${entry.referenceId || entry.reference || (index + 1)}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');

        // ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช - ุนุฑุถ ุจุฏูู ุฑูุฒ ุนููุฉ ุฅุฐุง ูุงูุช ุนููุงุช ูุฎุชูุทุฉ
        const totalDebitElement = document.getElementById('totalDebit');
        const totalCreditElement = document.getElementById('totalCredit');

        // ุงูุชุญูู ูู ูุฌูุฏ ุนููุงุช ูุชุนุฏุฏุฉ ูู ุงููุชุงุฆุฌ
        const currencies = [...new Set(entries.map(entry => entry.currency || 'SYP'))];
        const currencyDisplay = currencies.length === 1 ? ` ${getCurrencySymbol(currencies[0])}` : '';

        if (totalDebitElement) totalDebitElement.textContent = formatCurrency(totalDebit) + currencyDisplay;
        if (totalCreditElement) totalCreditElement.textContent = formatCurrency(totalCredit) + currencyDisplay;

        // ุฅุถุงูุฉ ุตู ุงูุชูุงุฒู
        const balanceClass = Math.abs(totalDebit - totalCredit) < 0.01 ? 'text-success' : 'text-danger';
        const balanceIcon = Math.abs(totalDebit - totalCredit) < 0.01 ? 'fa-check-circle' : 'fa-exclamation-triangle';

        tableContainer.innerHTML += `
            <tr class="table-warning">
                <td colspan="5" class="text-center">
                    <strong>
                        <i class="fas ${balanceIcon} me-2"></i>
                        ุญุงูุฉ ุงูุชูุงุฒู:
                        <span class="${balanceClass}">
                            ${Math.abs(totalDebit - totalCredit) < 0.01 ? 'ูุชูุงุฒู' : 'ุบูุฑ ูุชูุงุฒู'}
                        </span>
                    </strong>
                </td>
                <td class="text-end"><strong>${formatCurrency(totalDebit)}${currencyDisplay}</strong></td>
                <td class="text-end"><strong>${formatCurrency(totalCredit)}${currencyDisplay}</strong></td>
                <td class="text-center">
                    <span class="badge ${Math.abs(totalDebit - totalCredit) < 0.01 ? 'bg-success' : 'bg-danger'}">
                        ุงููุฑู: ${formatCurrency(Math.abs(totalDebit - totalCredit))}${currencyDisplay}
                    </span>
                </td>
            </tr>
        `;

    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-5">
                    <i class="fas fa-book fa-4x mb-3 text-muted"></i>
                    <h4>ูุง ุชูุฌุฏ ูููุฏ ูุญุงุณุจูุฉ</h4>
                    <p class="mb-3">ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฏ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ ุงููุญุฏุฏุฉ</p>
                    <button class="btn btn-primary" onclick="clearJournalFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                    <button class="btn btn-outline-success ms-2" onclick="showPage('sales-invoices')">
                        <i class="fas fa-plus me-2"></i>ุฅุถุงูุฉ ูุงุชูุฑุฉ
                    </button>
                </td>
            </tr>
        `;

        // ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุฌูุงููุงุช
        const totalDebitElement = document.getElementById('totalDebit');
        const totalCreditElement = document.getElementById('totalCredit');
        if (totalDebitElement) totalDebitElement.textContent = '0.00';
        if (totalCreditElement) totalCreditElement.textContent = '0.00';
    }
}

/**
 * ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ
 */
function addInvoiceItem() {
    console.log('โ ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ...');

    const tableBody = document.getElementById('invoiceItemsTable');
    if (!tableBody) {
        console.error('โ ุฌุฏูู ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏ');
        alert('ุฎุทุฃ: ุฌุฏูู ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
        return;
    }

    console.log('๐ฆ ุนุฏุฏ ุงูุฃุตูุงู ุงููุชุงุญุฉ:', appData.products.length);

    if (appData.products.length === 0) {
        alert('ูุง ุชูุฌุฏ ุฃุตูุงู ูุชุงุญุฉ. ูุฑุฌู ุฅุถุงูุฉ ุฃุตูุงู ุฃููุงู ูู ุตูุญุฉ ุงูุฃุตูุงู.');
        return;
    }

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <select class="form-select item-product" onchange="updateItemPrice(this)" required>
                <option value="">ุงุฎุชุฑ ุงูุตูู</option>
                ${appData.products.map(p => `<option value="${p.id}" data-price="${p.sellingPrice}" data-unit="${p.unit}">${p.name} (${p.quantity} ${p.unit})</option>`).join('')}
            </select>
        </td>
        <td>
            <input type="number" class="form-control item-quantity" min="1" step="1" value="1" onchange="calculateItemTotal(this)" required>
        </td>
        <td>
            <input type="number" class="form-control item-price" min="0" step="0.01" value="0" onchange="calculateItemTotal(this)" required>
        </td>
        <td>
            <input type="number" class="form-control item-discount" min="0" max="100" step="0.01" value="0" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <span class="item-total fw-bold">0.00</span>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeInvoiceItem(this)" title="ุญุฐู ุงูุนูุตุฑ">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tableBody.appendChild(row);
    console.log('โ ุชู ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ. ุงูุนุฏุฏ ุงูุญุงูู:', tableBody.children.length);

    // ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
    calculateInvoiceTotals();
}

/**
 * ุญุฐู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ
 */
function removeInvoiceItem(button) {
    const row = button.closest('tr');
    if (row) {
        row.remove();
        calculateInvoiceTotals();
        console.log('ุชู ุญุฐู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ');
    }
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุตูู ุนูุฏ ุงุฎุชูุงุฑู
 */
function updateItemPrice(selectElement) {
    console.log('๐ฐ ุชุญุฏูุซ ุณุนุฑ ุงูุตูู...');

    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const productId = selectElement.value;
    const price = selectedOption.getAttribute('data-price') || 0;
    const unit = selectedOption.getAttribute('data-unit') || '';
    const row = selectElement.closest('tr');
    const priceInput = row.querySelector('.item-price');
    const quantityInput = row.querySelector('.item-quantity');

    console.log('๐ ูุนูููุงุช ุงูุตูู:', { productId, price, unit });

    if (priceInput) {
        priceInput.value = parseFloat(price).toFixed(2);
        console.log('โ ุชู ุชุญุฏูุซ ุงูุณุนุฑ ุฅูู:', price);
    }

    // ุงูุชุญูู ูู ุงููููุฉ ุงููุชุงุญุฉ
    if (productId && quantityInput) {
        const product = appData.products.find(p => p.id == productId);
        if (product) {
            const requestedQuantity = parseFloat(quantityInput.value) || 1;
            if (requestedQuantity > product.quantity) {
                alert(`ุชุญุฐูุฑ: ุงููููุฉ ุงููุทููุจุฉ (${requestedQuantity}) ุฃูุจุฑ ูู ุงููููุฉ ุงููุชุงุญุฉ (${product.quantity} ${product.unit})`);
                quantityInput.value = Math.min(requestedQuantity, product.quantity);
            }
        }
    }

    calculateItemTotal(priceInput || selectElement);
}

/**
 * ุญุณุงุจ ุฅุฌูุงูู ุงูุนูุตุฑ
 */
function calculateItemTotal(element) {
    console.log('๐งฎ ุญุณุงุจ ุฅุฌูุงูู ุงูุนูุตุฑ...');

    const row = element.closest('tr');
    if (!row) {
        console.error('โ ูุง ูููู ุงูุนุซูุฑ ุนูู ุงูุตู');
        return;
    }

    const quantityInput = row.querySelector('.item-quantity');
    const priceInput = row.querySelector('.item-price');
    const discountInput = row.querySelector('.item-discount');
    const totalSpan = row.querySelector('.item-total');

    if (!quantityInput || !priceInput || !totalSpan) {
        console.error('โ ุนูุงุตุฑ ุงูุตู ููููุฏุฉ');
        return;
    }

    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const discount = discountInput ? parseFloat(discountInput.value) || 0 : 0;

    console.log('๐ ููู ุงูุนูุตุฑ:', { quantity, price, discount });

    const subtotal = quantity * price;
    const discountAmount = subtotal * (discount / 100);
    const total = subtotal - discountAmount;

    console.log('๐ฐ ุงูุญุณุงุจุงุช:', { subtotal, discountAmount, total });

    // ุนุฑุถ ุงููุจูุบ ุจุฏูู ุฑูุฒ ุนููุฉ ุฅุฐุง ูู ุชุญุฏุฏ ุนููุฉ
    totalSpan.textContent = `${total.toFixed(2)}`;

    console.log('โ ุชู ุชุญุฏูุซ ุฅุฌูุงูู ุงูุนูุตุฑ:', total);

    calculateInvoiceTotals();
}

/**
 * ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ
 */
function calculateInvoiceTotals() {
    console.log('๐งฎ ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ...');

    const rows = document.querySelectorAll('#invoiceItemsTable tr');
    let subtotal = 0;

    console.log('๐ ุนุฏุฏ ุตููู ุงูุนูุงุตุฑ:', rows.length);

    rows.forEach((row, index) => {
        const totalSpan = row.querySelector('.item-total');
        if (totalSpan) {
            const itemTotal = parseFloat(totalSpan.textContent.replace(/[^\d.-]/g, '')) || 0;
            subtotal += itemTotal;
            console.log(`๐ฆ ุงูุนูุตุฑ ${index + 1}: ${itemTotal}`);
        }
    });

    console.log('๐ฐ ุงููุฌููุน ุงููุฑุนู:', subtotal);

    const discountPercentageElement = document.getElementById('discountPercentage');
    const taxPercentageElement = document.getElementById('taxPercentage');

    const discountPercentage = discountPercentageElement ? parseFloat(discountPercentageElement.value) || 0 : 0;
    const taxPercentage = taxPercentageElement ? parseFloat(taxPercentageElement.value) || 0 : 0;

    console.log('๐ ุงููุณุจ:', { discountPercentage, taxPercentage });

    const discountAmount = subtotal * (discountPercentage / 100);
    const taxableAmount = subtotal - discountAmount;
    const taxAmount = taxableAmount * (taxPercentage / 100);
    const totalAmount = taxableAmount + taxAmount;

    console.log('๐ฐ ุงูุญุณุงุจุงุช ุงูููุงุฆูุฉ:', { subtotal, discountAmount, taxAmount, totalAmount });

    // ุชุญุฏูุซ ุงูุนุฑุถ ุจุฏูู ุฑูุฒ ุนููุฉ
    const subtotalElement = document.getElementById('subtotalAmount');
    const discountAmountElement = document.getElementById('discountAmount');
    const taxAmountElement = document.getElementById('taxAmount');
    const totalAmountElement = document.getElementById('totalAmount');

    if (subtotalElement) subtotalElement.textContent = `${subtotal.toFixed(2)}`;
    if (discountAmountElement) discountAmountElement.textContent = `${discountAmount.toFixed(2)}`;
    if (taxAmountElement) taxAmountElement.textContent = `${taxAmount.toFixed(2)}`;
    if (totalAmountElement) totalAmountElement.textContent = `${totalAmount.toFixed(2)}`;

    console.log('โ ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุฅุฌูุงููุงุช');

    return { subtotal, discountAmount, taxAmount, totalAmount };
}

/**
 * ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููู/ุงูููุฑุฏ ุญุณุจ ููุน ุงููุงุชูุฑุฉ
 */
function updateClientOptions() {
    console.log('๐ ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููู/ุงูููุฑุฏ...');

    const invoiceType = document.getElementById('invoiceType').value;
    const clientSelect = document.getElementById('clientSelect');
    const clientLabel = document.getElementById('clientLabel');

    if (!clientSelect || !clientLabel) {
        console.warn('โ๏ธ ุนูุงุตุฑ ุงูุนููู ุบูุฑ ููุฌูุฏุฉ');
        return;
    }

    clientSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ</option>';

    if (invoiceType === 'sale') {
        clientLabel.textContent = 'ุงูุนููู';
        console.log('๐ ุนุฏุฏ ุงูุนููุงุก:', appData.customers.length);

        if (appData.customers && appData.customers.length > 0) {
            appData.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                clientSelect.appendChild(option);
            });
            console.log('โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก');
        } else {
            console.warn('โ๏ธ ูุง ุชูุฌุฏ ุนููุงุก');
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ูุง ุชูุฌุฏ ุนููุงุก - ุงุถุบุท "ุฅุตูุงุญ ูุดููุฉ ุงูุญูุธ"';
            option.disabled = true;
            clientSelect.appendChild(option);
        }
    } else if (invoiceType === 'purchase') {
        clientLabel.textContent = 'ุงูููุฑุฏ';
        console.log('๐ ุนุฏุฏ ุงูููุฑุฏูู:', appData.suppliers.length);

        if (appData.suppliers && appData.suppliers.length > 0) {
            appData.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                clientSelect.appendChild(option);
            });
            console.log('โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูููุฑุฏูู');
        } else {
            console.warn('โ๏ธ ูุง ุชูุฌุฏ ููุฑุฏูู');
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ูุง ุชูุฌุฏ ููุฑุฏูู - ุงุถุบุท "ุฅุตูุงุญ ูุดููุฉ ุงูุญูุธ"';
            option.disabled = true;
            clientSelect.appendChild(option);
        }
    }

    // ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ
    if (invoiceType) {
        const invoiceNumber = generateInvoiceNumber(invoiceType);
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        if (invoiceNumberInput) {
            invoiceNumberInput.value = invoiceNumber;
            console.log('โ ุชู ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ:', invoiceNumber);
        }
    }
}

/**
 * ุชุญุฏูุซ ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ ุงููุญุฏุฏ
 */
function updateClientInfo() {
    const invoiceType = document.getElementById('invoiceType')?.value;
    const clientSelect = document.getElementById('clientSelect');
    const clientInfo = document.getElementById('clientInfo');
    const invoiceCurrency = document.getElementById('invoiceCurrency');

    if (!clientSelect || !clientInfo) {
        return;
    }

    const clientId = parseInt(clientSelect.value);
    if (!clientId) {
        clientInfo.innerHTML = '<span class="text-muted">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ ูุนุฑุถ ุงููุนูููุงุช</span>';
        return;
    }

    let client = null;
    if (invoiceType === 'sale') {
        client = appData.customers.find(c => c.id === clientId);
    } else if (invoiceType === 'purchase') {
        client = appData.suppliers.find(s => s.id === clientId);
    }

    if (!client) {
        clientInfo.innerHTML = '<span class="text-danger">ุงูุนููู/ุงูููุฑุฏ ุบูุฑ ููุฌูุฏ</span>';
        return;
    }

    // ุชุญุฏูุซ ุนููุฉ ุงููุงุชูุฑุฉ ุฅูู ุนููุฉ ุงูุนููู/ุงูููุฑุฏ ุงูุงูุชุฑุงุถูุฉ
    if (client.currency && invoiceCurrency) {
        invoiceCurrency.value = client.currency;
        updateCurrencyDisplay();
    }

    // ุนุฑุถ ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ
    const balance = client.currentBalance || 0;
    const balanceText = balance > 0 ?
        `<span class="text-danger">${formatCurrency(Math.abs(balance))} ${getCurrencySymbol(client.currency || 'SYP')} (ูุฏูู)</span>` :
        balance < 0 ?
        `<span class="text-success">${formatCurrency(Math.abs(balance))} ${getCurrencySymbol(client.currency || 'SYP')} (ุฏุงุฆู)</span>` :
        `<span class="text-muted">${formatCurrency(0)} ${getCurrencySymbol(client.currency || 'SYP')} (ูุชูุงุฒู)</span>`;

    const creditLimit = client.creditLimit || 0;
    const creditLimitText = creditLimit > 0 ?
        `<span class="text-info">ุญุฏ ุงูุงุฆุชูุงู: ${formatCurrency(creditLimit)} ${getCurrencySymbol(client.currency || 'SYP')}</span>` : '';

    clientInfo.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">ุงููุงุชู:</small> ${client.phone || 'ุบูุฑ ูุญุฏุฏ'}<br>
                <small class="text-muted">ุงูุจุฑูุฏ:</small> ${client.email || 'ุบูุฑ ูุญุฏุฏ'}
            </div>
            <div class="col-md-6">
                <small class="text-muted">ุงูุฑุตูุฏ ุงูุญุงูู:</small> ${balanceText}<br>
                ${creditLimitText}
            </div>
        </div>
        ${client.currency && client.currency !== 'SYP' ?
            `<div class="mt-2"><span class="badge bg-info">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ: ${getCurrencyName(client.currency)} (${getCurrencySymbol(client.currency)})</span></div>` :
            ''
        }
    `;

    console.log(`โ ุชู ุชุญุฏูุซ ูุนูููุงุช ${invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'}:`, client.name);
}

/**
 * ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ
 */
function initializeCreateInvoicePage() {
    console.log('๐ ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ...');

    // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู
    const today = getCurrentDateForInput();
    const invoiceDateInput = document.getElementById('invoiceDate');
    if (invoiceDateInput) {
        invoiceDateInput.value = today;
        console.log('๐ ุชู ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู:', today);
    } else {
        console.warn('โ๏ธ ุญูู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏ');
    }

    // ุชุนููู ุชุงุฑูุฎ ุงูุงุณุชุญูุงู (ุจุนุฏ 30 ููู)
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    const dueDateInput = document.getElementById('dueDate');
    if (dueDateInput) {
        const dueDateFormatted = formatDateForDB(dueDate);
        dueDateInput.value = dueDateFormatted;
        console.log('๐ ุชู ุชุนููู ุชุงุฑูุฎ ุงูุงุณุชุญูุงู:', dueDateFormatted);
    }

    // ุชุนููู ูุณุจุฉ ุงูุถุฑูุจุฉ ุงูุงูุชุฑุงุถูุฉ
    const taxPercentageInput = document.getElementById('taxPercentage');
    if (taxPercentageInput && appData.settings.taxRate) {
        taxPercentageInput.value = appData.settings.taxRate;
        console.log('๐ฐ ุชู ุชุนููู ูุณุจุฉ ุงูุถุฑูุจุฉ ุงูุงูุชุฑุงุถูุฉ:', appData.settings.taxRate);
    }

    // ุฅุถุงูุฉ ุนูุตุฑ ูุงุญุฏ ุงูุชุฑุงุถู
    setTimeout(() => {
        console.log('โ ุฅุถุงูุฉ ุนูุตุฑ ุงูุชุฑุงุถู...');
        addInvoiceItem();
        console.log('โ ุชู ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุจูุฌุงุญ');
    }, 200);
}

/**
 * ุงุฎุชุจุงุฑ ุญูุธ ุงูููุงุชูุฑ
 */
function testInvoiceSave() {
    console.log('๐งช ุงุฎุชุจุงุฑ ุญูุธ ุงูููุงุชูุฑ...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ุงููุทููุจุฉ
    const requiredElements = [
        'invoiceType',
        'clientSelect',
        'invoiceDate',
        'invoiceItemsTable'
    ];

    const missingElements = [];
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            missingElements.push(id);
        } else {
            console.log(`โ ${id}: ููุฌูุฏ`);
        }
    });

    if (missingElements.length > 0) {
        console.error('โ ุนูุงุตุฑ ููููุฏุฉ:', missingElements);
        alert(`ุนูุงุตุฑ ููููุฏุฉ ูู ุงููููุฐุฌ: ${missingElements.join(', ')}`);
        return false;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ุงุฎุชุจุงุฑ
    if (!appData.customers || appData.customers.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุนููุงุก');
        if (confirm('ูุง ุชูุฌุฏ ุนููุงุก. ูู ุชุฑูุฏ ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉุ')) {
            createSampleData();
            return true;
        }
        return false;
    }

    if (!appData.products || appData.products.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุฃุตูุงู');
        if (confirm('ูุง ุชูุฌุฏ ุฃุตูุงู. ูู ุชุฑูุฏ ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉุ')) {
            createSampleData();
            return true;
        }
        return false;
    }

    console.log('โ ุฌููุน ุงูุนูุงุตุฑ ุงููุทููุจุฉ ููุฌูุฏุฉ');
    console.log('โ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุชููุฑุฉ');
    console.log('๐ ุงููุธุงู ุฌุงูุฒ ูุญูุธ ุงูููุงุชูุฑ');

    return true;
}

/**
 * ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ
 */
function createSampleData() {
    console.log('๐ง ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ...');

    // ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู
    if (!appData.customers || appData.customers.length === 0) {
        appData.customers = [
            {
                id: 1,
                name: 'ุฃุญูุฏ ูุญูุฏ',
                phone: '0991234567',
                email: 'ahmed@example.com',
                address: 'ุฏูุดู - ุงููุฒุฉ',
                taxNumber: '123456789',
                creditLimit: 10000,
                currency: appData.settings.currency || 'SYP',
                currentBalance: 0,
                createdAt: new Date().toISOString().split('T')[0]
            },
            {
                id: 2,
                name: 'ูุงุทูุฉ ุนูู',
                phone: '0992345678',
                email: 'fatima@example.com',
                address: 'ุญูุจ - ุงูุดูุจุงุก',
                taxNumber: '987654321',
                creditLimit: 15000,
                currency: appData.settings.currency || 'SYP',
                currentBalance: 0,
                createdAt: new Date().toISOString().split('T')[0]
            }
        ];
        console.log('โ ุชู ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู');
    }

    // ุฅุถุงูุฉ ููุฑุฏูู ุชุฌุฑูุจููู
    if (!appData.suppliers || appData.suppliers.length === 0) {
        appData.suppliers = [
            {
                id: 1,
                name: 'ุดุฑูุฉ ุงูุชูุฑูุฏุงุช ุงููุชูุฏูุฉ',
                phone: '0113456789',
                email: 'supplies@example.com',
                address: 'ุฏูุดู - ุงูุชุฌุงุฑุฉ',
                taxNumber: '555666777',
                currency: appData.settings.currency || 'SYP',
                currentBalance: 0,
                createdAt: new Date().toISOString().split('T')[0]
            }
        ];
        console.log('โ ุชู ุฅุถุงูุฉ ููุฑุฏูู ุชุฌุฑูุจููู');
    }

    // ุฅุถุงูุฉ ุฃุตูุงู ุชุฌุฑูุจูุฉ
    if (!appData.products || appData.products.length === 0) {
        appData.products = [
            {
                id: 1,
                name: 'ูุงุจุชูุจ ุฏูู',
                code: 'DELL001',
                category: 'ุฅููุชุฑูููุงุช',
                unit: 'ูุทุนุฉ',
                purchasePrice: 800,
                sellingPrice: 1000,
                quantity: 10,
                minQuantity: 2,
                warehouseId: 1,
                createdAt: new Date().toISOString().split('T')[0]
            },
            {
                id: 2,
                name: 'ูุงูุณ ูุงุณููู',
                code: 'MOUSE001',
                category: 'ุฅูุณุณูุงุฑุงุช',
                unit: 'ูุทุนุฉ',
                purchasePrice: 15,
                sellingPrice: 25,
                quantity: 50,
                minQuantity: 10,
                warehouseId: 1,
                createdAt: new Date().toISOString().split('T')[0]
            },
            {
                id: 3,
                name: 'ููุจูุฑุฏ ูููุงูููู',
                code: 'KB001',
                category: 'ุฅูุณุณูุงุฑุงุช',
                unit: 'ูุทุนุฉ',
                purchasePrice: 40,
                sellingPrice: 60,
                quantity: 25,
                minQuantity: 5,
                warehouseId: 1,
                createdAt: new Date().toISOString().split('T')[0]
            }
        ];
        console.log('โ ุชู ุฅุถุงูุฉ ุฃุตูุงู ุชุฌุฑูุจูุฉ');
    }

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();
    console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ');

    alert('ุชู ุฅูุดุงุก ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุจูุฌุงุญ!\n\n- 2 ุนููู\n- 1 ููุฑุฏ\n- 3 ุฃุตูุงู\n\nููููู ุงูุขู ุฅูุดุงุก ุงูููุงุชูุฑ.');

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
    showPage('create-invoice');
}

/**
 * ุงุฎุชุจุงุฑ ุณุฑูุน ูุญูุธ ุงูููุงุชูุฑ
 */
function quickTest() {
    console.log('๐ ุงุฎุชุจุงุฑ ุณุฑูุน ูุญูุธ ุงูููุงุชูุฑ...');

    // ุฅูุดุงุก ุงูุจูุงูุงุช ุฅุฐุง ูู ุชูุฌุฏ
    if (!appData.customers || appData.customers.length === 0 || !appData.products || appData.products.length === 0) {
        createSampleData();
        setTimeout(() => {
            performQuickTest();
        }, 500);
    } else {
        performQuickTest();
    }
}

/**
 * ุชูููุฐ ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน
 */
function performQuickTest() {
    console.log('โก ุชูููุฐ ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน...');

    // ููุก ุงููููุฐุฌ ุชููุงุฆูุงู
    fillFormAutomatically();

    // ุงูุชุธุงุฑ ูููู ุซู ูุญุงููุฉ ุงูุญูุธ
    setTimeout(() => {
        console.log('๐พ ูุญุงููุฉ ุญูุธ ุงููุงุชูุฑุฉ...');

        if (confirm('ูู ุชุฑูุฏ ุญูุธ ูุงุชูุฑุฉ ุชุฌุฑูุจูุฉ ุงูุขูุ')) {
            const result = saveInvoiceSimple('confirmed');

            if (result) {
                console.log('๐ ูุฌุญ ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน!');
                alert('๐ ูุฌุญ ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน!\n\nุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ. ุงููุธุงู ูุนูู ุจุดูู ูุซุงูู!');
            } else {
                console.log('โ ูุดู ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน');
                alert('โ ูุดู ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน\n\nูุฑุฌู ุงูุชุญูู ูู ุงูุจูุงูุงุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        }
    }, 1000);
}

/**
 * ูุณุญ ููุงุชุฑ ุงูุนููุงุก
 */
function clearCustomersFilter() {
    const searchInput = document.getElementById('customerSearch');
    const typeFilter = document.getElementById('customerTypeFilter');
    const cityFilter = document.getElementById('customerCityFilter');

    if (searchInput) searchInput.value = '';
    if (typeFilter) typeFilter.value = '';
    if (cityFilter) cityFilter.value = '';

    // ุนุฑุถ ุฌููุน ุงูุนููุงุก
    updateCustomersTable(appData.customers);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุงูุนููุงุก
 */
function updateCustomersTable(customers) {
    const tableContainer = document.querySelector('#customersTable tbody') ||
                          document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (customers.length > 0) {
        tableContainer.innerHTML = customers.map(customer => `
            <tr>
                <td><strong>${customer.name}</strong></td>
                <td>${customer.phone}</td>
                <td>${customer.email || 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${formatCurrency(customer.balance || 0)}</td>
                <td>${formatCurrency(customer.creditLimit || 0)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${customer.id})" title="ุชุนุฏูู">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${customer.id})" title="ุญุฐู">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="showPage('customer-statement')" title="ูุดู ุญุณุงุจ">
                        <i class="fas fa-file-alt"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ุนููุงุก ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearCustomersFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุนุฑุถ ุตูุญุฉ ูุนููุฉ
 */
function showPage(pageName) {
    console.log('๐ ุชุญููู ุงูุตูุญุฉ:', pageName);

    // ุฅุฎูุงุก ุฃู ุฅุธูุงุฑ ุดุฑูุท ุงูุชููู ุญุณุจ ุงูุตูุญุฉ
    const navbar = document.querySelector('nav.navbar');
    if (navbar) {
        if (pageName === 'login') {
            navbar.style.display = 'none';
        } else {
            navbar.style.display = 'block';
        }
    }

    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู (ูุง ุนุฏุง ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู)
    if (pageName !== 'login') {
        if (!checkLogin()) {
            console.log('๐ ูุดู ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎููุ ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู');
            return;
        }

        // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ููุตูุญุงุช ุงููุญููุฉ
        if (!checkPagePermission(pageName)) {
            console.log('๐ ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐู ุงูุตูุญุฉ:', pageName);
            alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐู ุงูุตูุญุฉ');
            showPage('dashboard'); // ุฅุนุงุฏุฉ ุชูุฌูู ูููุญุฉ ุงูุชุญูู
            return;
        }
    }

    const mainContent = document.getElementById('main-content');

    switch(pageName) {
        case 'dashboard':
            mainContent.innerHTML = getDashboardHTML();
            break;
        case 'customers':
            mainContent.innerHTML = getCustomersHTML();
            break;
        case 'add-customer':
            mainContent.innerHTML = getAddCustomerHTML();
            break;
        case 'suppliers':
            mainContent.innerHTML = getSuppliersHTML();
            break;
        case 'products':
            mainContent.innerHTML = getProductsHTML();
            break;
        case 'create-invoice':
            mainContent.innerHTML = getCreateInvoiceHTML();
            setTimeout(() => {
                initializeCreateInvoicePage();
            }, 100);
            break;
        case 'create-custom-invoice':
            mainContent.innerHTML = getCreateCustomInvoiceHTML();
            setTimeout(() => {
                initializeCreateCustomInvoicePage();
            }, 100);
            break;
        case 'customer-supplier-balances':
            mainContent.innerHTML = getCustomerSupplierBalancesHTML();
            setTimeout(() => {
                initializeCustomerSupplierBalancesPage();
            }, 100);
            break;
        case 'usd-balances-report':
            mainContent.innerHTML = getUSDBalancesReportHTML();
            setTimeout(() => {
                initializeUSDBalancesReport();
            }, 100);
            break;
        case 'backup':
            mainContent.innerHTML = getBackupRestoreHTML();
            setTimeout(() => {
                initializeBackupRestorePage();
            }, 100);
            break;
        case 'add-supplier':
            mainContent.innerHTML = getAddSupplierHTML();
            break;
        case 'warehouses':
            mainContent.innerHTML = getWarehousesHTML();
            break;
        case 'inventory':
            mainContent.innerHTML = getInventoryHTML();
            break;
        case 'inventory-details':
            mainContent.innerHTML = getInventoryDetailsHTML();
            break;
        case 'sales-invoices':
            mainContent.innerHTML = getSalesInvoicesHTML();
            break;
        case 'purchase-invoices':
            mainContent.innerHTML = getPurchaseInvoicesHTML();
            break;
        case 'receipts':
            mainContent.innerHTML = getReceiptsHTML();
            break;
        case 'payments':
            mainContent.innerHTML = getPaymentsHTML();
            break;
        case 'journal':
            mainContent.innerHTML = getJournalHTML();
            // ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
            setTimeout(() => updateJournalTable(appData.journalEntries || []), 100);
            break;
        case 'customer-statement':
            mainContent.innerHTML = getCustomerStatementHTML();
            break;
        case 'sales-report':
            mainContent.innerHTML = getSalesReportHTML();
            break;
        case 'purchase-report':
            mainContent.innerHTML = getPurchaseReportHTML();
            break;
        case 'currency-balances':
            mainContent.innerHTML = getCurrencyBalancesHTML();
            // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ ูุน ุชุฃุฎูุฑ ุจุณูุท ููุชุฃูุฏ ูู ุชุญููู ุงูุนูุงุตุฑ
            setTimeout(() => {
                console.log('๐ ุชุญููู ุตูุญุฉ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ...');
                updateCurrencyBalancesTable();
                console.log('โ ุชู ุชุญููู ุตูุญุฉ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ');
            }, 200);
            break;
        case 'customer-payments-report':
            mainContent.innerHTML = getCustomerPaymentsReportHTML();
            break;
        case 'supplier-payments-report':
            mainContent.innerHTML = getSupplierPaymentsReportHTML();
            break;
        case 'supplier-statement':
            mainContent.innerHTML = getSupplierStatementHTML();
            break;
        case 'add-product':
            mainContent.innerHTML = getAddProductHTML();
            break;
        case 'settings':
            mainContent.innerHTML = getSettingsHTML();
            break;
        case 'login':
            mainContent.innerHTML = getLoginHTML();
            break;
        case 'backup':
            mainContent.innerHTML = getBackupHTML();
            break;
        case 'users':
            mainContent.innerHTML = getUsersHTML();
            // ุชุญุฏูุซ ุฌุฏูู ุงููุณุชุฎุฏููู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
            setTimeout(() => refreshUsers(), 100);
            break;
        default:
            mainContent.innerHTML = getComingSoonHTML(pageName);
    }
    
    // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุฃุญุฏุงุซ
    initializePageEvents();
}

/**
 * ููุญุฉ ุงูุชุญูู
 */
function getDashboardHTML() {
    console.log('๐ ุชุญููู ููุญุฉ ุงูุชุญูู...');

    const stats = calculateStats();

    // ุงูุญุตูู ุนูู ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู ุจุฏูุฉ ูุญุณูุฉ
    const lowStockProducts = appData.products.filter(product => {
        const quantity = parseFloat(product.quantity) || 0;
        const minQuantity = parseFloat(product.minQuantity) || 0;
        const isActive = product.isActive !== false;

        // ุงูุชุฃูุฏ ูู ุฃู ุงูุญุฏ ุงูุฃุฏูู ูุญุฏุฏ ูููุทูู
        const validMinQuantity = minQuantity > 0 ? minQuantity : 1;

        return isActive && quantity <= validMinQuantity;
    }).sort((a, b) => {
        // ุชุฑุชูุจ ุญุณุจ ูุณุชูู ุงูุฎุทูุฑุฉ (ุงูุฃูู ูููุฉ ุฃููุงู)
        const aQuantity = parseFloat(a.quantity) || 0;
        const bQuantity = parseFloat(b.quantity) || 0;
        return aQuantity - bQuantity;
    }).slice(0, 10); // ุนุฑุถ ุฃูู 10 ููุชุฌุงุช ููุท
    
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    ููุญุฉ ุงูุชุญูู
                </h1>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-right-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ุงูุนููุงุก</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.customersCount}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-right-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุงูููุฑุฏูู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.suppliersCount}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-truck fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-right-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ุงูุฃุตูุงู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.productsCount}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-boxes fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-right-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุงูููุงุชูุฑ</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.invoicesCount}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ูุงููุฉ -->
        <div class="row mb-4">
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-right-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุฅุฌูุงูู ุงููุจูุนุงุช</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${formatCurrency(stats.totalSales)}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-right-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุงููุฏููุนุงุช ุงููุนููุฉ</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${formatCurrency(stats.pendingPayments)}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-right-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">ููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${lowStockProducts.length}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ุขุฎุฑ ุงูููุงุชูุฑ -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">ุขุฎุฑ ุงูููุงุชูุฑ</h6>
                        <button class="btn btn-sm btn-primary" onclick="showPage('sales-invoices')">ุนุฑุถ ุงููู</button>
                    </div>
                    <div class="card-body">
                        ${getRecentInvoicesTable()}
                    </div>
                </div>
            </div>

            <!-- ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู
                            <span class="badge bg-warning">${lowStockProducts.length}</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        ${getLowStockProductsList(lowStockProducts)}
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
 */
function calculateStats() {
    console.log('๐ ุญุณุงุจ ุฅุญุตุงุฆูุงุช ููุญุฉ ุงูุชุญูู...');

    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData.customers) appData.customers = [];
    if (!appData.suppliers) appData.suppliers = [];
    if (!appData.products) appData.products = [];
    if (!appData.invoices) appData.invoices = [];
    if (!appData.payments) appData.payments = [];

    // ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูููุงุชูุฑ
    const salesInvoices = appData.invoices.filter(inv => inv.invoiceType === 'sale' && inv.status === 'confirmed');
    const purchaseInvoices = appData.invoices.filter(inv => inv.invoiceType === 'purchase' && inv.status === 'confirmed');

    const totalSales = salesInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
    const totalPurchases = purchaseInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
    const pendingPayments = appData.invoices.reduce((sum, inv) => sum + (inv.remainingAmount || 0), 0);

    // ุญุณุงุจ ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู ุจุฏูุฉ ูุญุณูุฉ
    const lowStockProducts = appData.products.filter(product => {
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุชูุธูููุง
        const quantity = parseFloat(product.quantity) || 0;
        const minQuantity = parseFloat(product.minQuantity) || 0;
        const isActive = product.isActive !== false; // ุงูุชุฑุงุถู true ุฅุฐุง ูู ููู ูุญุฏุฏ

        // ุงูุชุฃูุฏ ูู ุฃู ุงูุญุฏ ุงูุฃุฏูู ูุญุฏุฏ ูููุทูู
        const validMinQuantity = minQuantity > 0 ? minQuantity : 1; // ุงูุชุฑุงุถู 1 ุฅุฐุง ูู ููู ูุญุฏุฏ

        // ุงูููุชุฌ ููุฎูุถ ุงููุฎุฒูู ุฅุฐุง ูุงูุช ุงููููุฉ ุฃูู ูู ุฃู ุชุณุงูู ุงูุญุฏ ุงูุฃุฏูู
        const isLowStock = quantity <= validMinQuantity;

        // ุชุณุฌูู ุชูุงุตูู ูููุฑุงูุจุฉ
        if (isLowStock && isActive) {
            console.log(`โ๏ธ ููุชุฌ ููุฎูุถ ุงููุฎุฒูู: ${product.name} - ุงููููุฉ: ${quantity}, ุงูุญุฏ ุงูุฃุฏูู: ${validMinQuantity}`);
        }

        return isActive && isLowStock;
    });

    // ุญุณุงุจ ุงูููุชุฌุงุช ููุฏ ูุฎุฒูููุง
    const outOfStockProducts = appData.products.filter(product => {
        const quantity = parseFloat(product.quantity) || 0;
        const isActive = product.isActive !== false;
        return isActive && quantity === 0;
    });

    // ุญุณุงุจ ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู
    const totalInventoryValue = appData.products.reduce((sum, product) => {
        const quantity = parseFloat(product.quantity) || 0;
        const costPrice = parseFloat(product.costPrice) || 0;
        return sum + (quantity * costPrice);
    }, 0);

    // ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
    const totalCustomerBalance = appData.customers.reduce((sum, customer) => {
        return sum + (parseFloat(customer.currentBalance) || 0);
    }, 0);

    const totalSupplierBalance = appData.suppliers.reduce((sum, supplier) => {
        return sum + (parseFloat(supplier.currentBalance) || 0);
    }, 0);

    const stats = {
        customersCount: appData.customers.filter(c => c.isActive !== false).length,
        suppliersCount: appData.suppliers.filter(s => s.isActive !== false).length,
        productsCount: appData.products.filter(p => p.isActive !== false).length,
        warehousesCount: appData.warehouses ? appData.warehouses.filter(w => w.isActive !== false).length : 0,
        invoicesCount: appData.invoices.length,
        totalSales: totalSales,
        totalPurchases: totalPurchases,
        pendingPayments: pendingPayments,
        lowStockProductsCount: lowStockProducts.length,
        outOfStockProductsCount: outOfStockProducts.length,
        totalInventoryValue: totalInventoryValue,
        totalCustomerBalance: totalCustomerBalance,
        totalSupplierBalance: totalSupplierBalance,
        // ุฅุถุงูุฉ ุชูุงุตูู ุฅุถุงููุฉ ูููุฑุงูุจุฉ
        activeProductsCount: appData.products.filter(p => p.isActive !== false).length,
        totalProductsCount: appData.products.length
    };

    // ุงูุชุญูู ูู ุฏูุฉ ูููุงุช ุงูููุชุฌุงุช ูุชุญุฏูุซูุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
    validateAndUpdateProductQuantities();

    console.log('โ ุชู ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช:', {
        'ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู': stats.lowStockProductsCount,
        'ุงูููุชุฌุงุช ููุฏ ูุฎุฒูููุง': stats.outOfStockProductsCount,
        'ุฅุฌูุงูู ุงูููุชุฌุงุช ุงููุดุทุฉ': stats.activeProductsCount,
        'ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู': stats.totalInventoryValue
    });

    return stats;
}

/**
 * ุงูุชุญูู ูู ุฏูุฉ ูููุงุช ุงูููุชุฌุงุช ูุชุญุฏูุซูุง ุจูุงุกู ุนูู ุญุฑูุงุช ุงููุฎุฒูู - ูุญุณู ูุฏููู
 */
function validateAndUpdateProductQuantities() {
    console.log('๐ ุงูุชุญูู ูู ุฏูุฉ ูููุงุช ุงูููุชุฌุงุช...');

    if (!appData.products || !appData.inventoryMovements) {
        console.log('โ๏ธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ูุชููุฑุฉ');
        return { updated: 0, errors: 0, total: 0 };
    }

    let updatedCount = 0;
    let errorCount = 0;

    appData.products.forEach(product => {
        try {
            // ุญุณุงุจ ุงููููุฉ ุงููุนููุฉ ูู ุญุฑูุงุช ุงููุฎุฒูู ูุน ูุนุงูุฌุฉ ุดุงููุฉ
            const productMovements = appData.inventoryMovements.filter(m =>
                m.productId === product.id &&
                m.warehouseId === product.warehouseId &&
                m.isDeleted !== true
            );

            let calculatedQuantity = 0;
            let totalIn = 0;
            let totalOut = 0;

            productMovements.forEach(movement => {
                const quantity = parseFloat(movement.quantity) || 0;

                // ูุนุงูุฌุฉ ุดุงููุฉ ูุฌููุน ุฃููุงุน ุงูุญุฑูุงุช
                switch (movement.movementType) {
                    case 'in':
                    case 'purchase':
                    case 'return_sale':
                    case 'transfer_in':
                        totalIn += Math.abs(quantity);
                        calculatedQuantity += Math.abs(quantity);
                        break;

                    case 'out':
                    case 'sale':
                    case 'return_purchase':
                    case 'transfer_out':
                        totalOut += Math.abs(quantity);
                        calculatedQuantity -= Math.abs(quantity);
                        break;

                    case 'adjustment':
                        // ุงูุชุณููุฉ ูููู ุฃู ุชููู ููุฌุจุฉ ุฃู ุณุงูุจุฉ
                        if (quantity >= 0) {
                            totalIn += quantity;
                            calculatedQuantity += quantity;
                        } else {
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity); // ุทุฑุญ ุงููููุฉ ุงูุณุงูุจุฉ
                        }
                        break;

                    case 'transfer':
                        // ุงูุชุญููู ุจูู ุงููุฎุงุฒู
                        if (movement.warehouseId === product.warehouseId) {
                            // ุฅุฎุฑุงุฌ ูู ุงููุฎุฒู ุงูุญุงูู
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                        } else if (movement.toWarehouseId === product.warehouseId) {
                            // ุฅุฏุฎุงู ูููุฎุฒู ุงูุญุงูู
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                        }
                        break;

                    default:
                        console.warn(`โ๏ธ ููุน ุญุฑูุฉ ุบูุฑ ูุนุฑูู: ${movement.movementType} ููููุชุฌ ${product.name}`);
                }
            });

            // ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูููุงุช ุณุงูุจุฉ
            calculatedQuantity = Math.max(0, calculatedQuantity);

            // ููุงุฑูุฉ ุงููููุฉ ุงููุญุณูุจุฉ ูุน ุงููููุฉ ุงููุณุฌูุฉ
            const currentQuantity = parseFloat(product.quantity) || 0;
            const difference = Math.abs(calculatedQuantity - currentQuantity);

            if (difference > 0.001) { // ุชุญูู ุฎุทุฃ ุตุบูุฑ ููุฃุฑูุงู ุงูุนุดุฑูุฉ
                console.log(`๐ ุชุญุฏูุซ ูููุฉ ุงูููุชุฌ ${product.name}:`, {
                    'ุงููููุฉ ุงูุญุงููุฉ': currentQuantity,
                    'ุงููููุฉ ุงููุญุณูุจุฉ': calculatedQuantity,
                    'ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช': totalIn,
                    'ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช': totalOut,
                    'ุนุฏุฏ ุงูุญุฑูุงุช': productMovements.length
                });

                product.quantity = calculatedQuantity;
                product.lastQuantityUpdate = new Date().toISOString();
                updatedCount++;
            }

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุญุณุงุจ ูููุฉ ุงูููุชุฌ ${product.name}:`, error);
            errorCount++;
        }
    });

    if (updatedCount > 0 || errorCount > 0) {
        if (updatedCount > 0) {
            saveData();
            console.log(`โ ุชู ุชุญุฏูุซ ${updatedCount} ููุชุฌ ุจูุฌุงุญ`);
        }
        if (errorCount > 0) {
            console.warn(`โ๏ธ ุญุฏุซุช ุฃุฎุทุงุก ูู ${errorCount} ููุชุฌ`);
        }
    } else {
        console.log('โ ุฌููุน ูููุงุช ุงูููุชุฌุงุช ุตุญูุญุฉ');
    }

    return {
        updated: updatedCount,
        errors: errorCount,
        total: appData.products.length
    };
}

/**
 * ุฅุนุงุฏุฉ ุญุณุงุจ ูุชุตุญูุญ ุฌููุน ูููุงุช ุงูุฃุตูุงู - ูุธููุฉ ุดุงููุฉ
 */
function recalculateAllProductQuantities() {
    console.log('๐ ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ูููุงุช ุงูุฃุตูุงู...');

    if (!appData.products || !appData.inventoryMovements) {
        console.log('โ๏ธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ูุชููุฑุฉ');
        showErrorToast('ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ูุชููุฑุฉ');
        return;
    }

    let correctedCount = 0;
    let errorCount = 0;
    const corrections = [];

    try {
        appData.products.forEach(product => {
            try {
                // ุญุณุงุจ ุงููููุฉ ุงููุนููุฉ ูู ุญุฑูุงุช ุงููุฎุฒูู
                const productMovements = appData.inventoryMovements.filter(m =>
                    m.productId === product.id &&
                    m.warehouseId === product.warehouseId &&
                    m.isDeleted !== true
                );

                let calculatedQuantity = 0;
                let totalIn = 0;
                let totalOut = 0;

                productMovements.forEach(movement => {
                    const quantity = parseFloat(movement.quantity) || 0;

                    switch (movement.movementType) {
                        case 'in':
                        case 'purchase':
                        case 'return_sale':
                        case 'transfer_in':
                            totalIn += Math.abs(quantity);
                            calculatedQuantity += Math.abs(quantity);
                            break;

                        case 'out':
                        case 'sale':
                        case 'return_purchase':
                        case 'transfer_out':
                        case 'damage':
                            totalOut += Math.abs(quantity);
                            calculatedQuantity -= Math.abs(quantity);
                            break;

                        case 'adjustment':
                            if (quantity >= 0) {
                                totalIn += quantity;
                                calculatedQuantity += quantity;
                            } else {
                                totalOut += Math.abs(quantity);
                                calculatedQuantity -= Math.abs(quantity);
                            }
                            break;

                        case 'transfer':
                            if (movement.warehouseId === product.warehouseId) {
                                totalOut += Math.abs(quantity);
                                calculatedQuantity -= Math.abs(quantity);
                            } else if (movement.toWarehouseId === product.warehouseId) {
                                totalIn += Math.abs(quantity);
                                calculatedQuantity += Math.abs(quantity);
                            }
                            break;
                    }
                });

                // ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูููุงุช ุณุงูุจุฉ
                calculatedQuantity = Math.max(0, calculatedQuantity);

                const currentQuantity = parseFloat(product.quantity) || 0;
                const difference = Math.abs(calculatedQuantity - currentQuantity);

                if (difference > 0.001) {
                    corrections.push({
                        productName: product.name,
                        productCode: product.code,
                        oldQuantity: currentQuantity,
                        newQuantity: calculatedQuantity,
                        difference: calculatedQuantity - currentQuantity,
                        totalIn: totalIn,
                        totalOut: totalOut,
                        movementsCount: productMovements.length
                    });

                    product.quantity = calculatedQuantity;
                    product.lastQuantityUpdate = new Date().toISOString();
                    correctedCount++;
                }

            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุญุณุงุจ ูููุฉ ุงูููุชุฌ ${product.name}:`, error);
                errorCount++;
            }
        });

        // ุญูุธ ุงูุจูุงูุงุช ุฅุฐุง ุชู ุงูุชุตุญูุญ
        if (correctedCount > 0) {
            saveData();
            console.log(`โ ุชู ุชุตุญูุญ ${correctedCount} ููุชุฌ`);

            // ุฅุธูุงุฑ ุชูุฑูุฑ ุงูุชุตุญูุญุงุช
            showQuantityCorrectionsReport(corrections);

            // ุชุญุฏูุซ ุงูุนุฑุถ
            if (typeof updateProductsDisplay === 'function') {
                updateProductsDisplay();
            }

            showSuccessToast(`ุชู ุชุตุญูุญ ูููุงุช ${correctedCount} ููุชุฌ ุจูุฌุงุญ`);
        } else {
            console.log('โ ุฌููุน ุงููููุงุช ุตุญูุญุฉ - ูุง ุญุงุฌุฉ ููุชุตุญูุญ');
            showInfoToast('ุฌููุน ูููุงุช ุงูุฃุตูุงู ุตุญูุญุฉ');
        }

        if (errorCount > 0) {
            console.warn(`โ๏ธ ุญุฏุซุช ุฃุฎุทุงุก ูู ${errorCount} ููุชุฌ`);
            showWarningToast(`ุญุฏุซุช ุฃุฎุทุงุก ูู ${errorCount} ููุชุฌ`);
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ุนุงู ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงููููุงุช:', error);
        showErrorToast('ุญุฏุซ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงููููุงุช: ' + error.message);
    }

    return {
        corrected: correctedCount,
        errors: errorCount,
        total: appData.products.length,
        corrections: corrections
    };
}

/**
 * ุนุฑุถ ุชูุฑูุฑ ุชุตุญูุญุงุช ุงููููุงุช
 */
function showQuantityCorrectionsReport(corrections) {
    if (!corrections || corrections.length === 0) return;

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'quantityCorrectionsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>
                        ุชูุฑูุฑ ุชุตุญูุญ ุงููููุงุช
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        ุชู ุชุตุญูุญ ูููุงุช <strong>${corrections.length}</strong> ููุชุฌ ุจูุงุกู ุนูู ุญุฑูุงุช ุงููุฎุฒูู
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ุงูุตูู</th>
                                    <th>ุงูููุฏ</th>
                                    <th>ุงููููุฉ ุงูุณุงุจูุฉ</th>
                                    <th>ุงููููุฉ ุงููุตุญุญุฉ</th>
                                    <th>ุงููุฑู</th>
                                    <th>ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช</th>
                                    <th>ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช</th>
                                    <th>ุนุฏุฏ ุงูุญุฑูุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${corrections.map(correction => `
                                    <tr>
                                        <td><strong>${correction.productName}</strong></td>
                                        <td>${correction.productCode}</td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">${correction.oldQuantity}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">${correction.newQuantity}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-${correction.difference > 0 ? 'primary' : 'warning'}">
                                                ${correction.difference > 0 ? '+' : ''}${correction.difference.toFixed(2)}
                                            </span>
                                        </td>
                                        <td class="text-center text-success">+${correction.totalIn}</td>
                                        <td class="text-center text-danger">-${correction.totalOut}</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">${correction.movementsCount}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ุฅุฌูุงูู ุงูุชุตุญูุญุงุช</h6>
                                    <h4 class="text-success">${corrections.length}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ุฒูุงุฏุงุช</h6>
                                    <h4 class="text-primary">${corrections.filter(c => c.difference > 0).length}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ููุตุงู</h6>
                                    <h4 class="text-warning">${corrections.filter(c => c.difference < 0).length}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" onclick="exportCorrectionsToExcel(${JSON.stringify(corrections).replace(/"/g, '&quot;')})">
                        <i class="fas fa-file-excel me-2"></i>
                        ุชุตุฏูุฑ Excel
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุฌุฏูู ุขุฎุฑ ุงูููุงุชูุฑ
 */
function getRecentInvoicesTable() {
    if (appData.invoices.length === 0) {
        return '<p class="text-center text-muted">ูุง ุชูุฌุฏ ููุงุชูุฑ ุญุชู ุงูุขู</p>';
    }

    const recentInvoices = appData.invoices.slice(-5).reverse();

    let html = `
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                        <th>ุงูููุน</th>
                        <th>ุงูุนููู/ุงูููุฑุฏ</th>
                        <th>ุงููุจูุบ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุญุงูุฉ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    recentInvoices.forEach(invoice => {
        const customer = appData.customers.find(c => c.id === invoice.customerId);
        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
        const clientName = customer ? customer.name : (supplier ? supplier.name : '-');

        html += `
            <tr>
                <td>${invoice.invoiceNumber}</td>
                <td>
                    <span class="badge bg-${invoice.invoiceType === 'sale' ? 'success' : 'info'}">
                        ${invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'}
                    </span>
                </td>
                <td>${clientName}</td>
                <td>${formatCurrency(invoice.totalAmount)}</td>
                <td>${invoice.invoiceDate}</td>
                <td>
                    <span class="badge bg-${getStatusColor(invoice.status)}">
                        ${getStatusText(invoice.status)}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    return html;
}

/**
 * ูุงุฆูุฉ ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู ุงููุญุณูุฉ
 */
function getLowStockProductsList(products) {
    console.log('๐ฆ ุนุฑุถ ูุงุฆูุฉ ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู:', products.length);

    if (products.length === 0) {
        return `
            <div class="text-center text-success py-4">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h6>ุฌููุน ุงูููุชุฌุงุช ูู ูุณุชูู ุขูู</h6>
                <small class="text-muted">ูุง ุชูุฌุฏ ููุชุฌุงุช ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชูููู</small>
            </div>
        `;
    }

    // ุชุฑุชูุจ ุงูููุชุฌุงุช ุญุณุจ ูุณุชูู ุงูุฎุทูุฑุฉ (ุงูุฃูู ูููุฉ ุฃููุงู)
    const sortedProducts = products.sort((a, b) => {
        const aQuantity = parseFloat(a.quantity) || 0;
        const bQuantity = parseFloat(b.quantity) || 0;
        return aQuantity - bQuantity;
    });

    let html = '';
    sortedProducts.forEach((product, index) => {
        const quantity = parseFloat(product.quantity) || 0;
        const minQuantity = parseFloat(product.minQuantity) || 0;
        const warehouse = appData.warehouses.find(w => w.id === product.warehouseId);

        // ุชุญุฏูุฏ ูุณุชูู ุงูุฎุทูุฑุฉ
        let alertLevel = 'danger';
        let alertIcon = 'fas fa-exclamation-triangle';
        let alertText = 'ููุฏ ุงููุฎุฒูู';

        if (quantity > 0) {
            if (quantity <= minQuantity * 0.5) {
                alertLevel = 'danger';
                alertIcon = 'fas fa-exclamation-triangle';
                alertText = 'ูุฎุฒูู ููุฎูุถ ุฌุฏุงู';
            } else {
                alertLevel = 'warning';
                alertIcon = 'fas fa-exclamation-circle';
                alertText = 'ูุฎุฒูู ููุฎูุถ';
            }
        }

        html += `
            <div class="d-flex align-items-center border-bottom py-2 ${index < 3 ? 'bg-light' : ''}"
                 onclick="showProductDetails(${product.id})" style="cursor: pointer;">
                <div class="me-2">
                    <i class="${alertIcon} text-${alertLevel}" title="${alertText}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${product.name}</div>
                    <small class="text-muted">
                        ${product.code} | ${warehouse ? warehouse.name : 'ูุฎุฒู ุบูุฑ ูุญุฏุฏ'}
                    </small>
                    <div class="mt-1">
                        <small class="text-muted">
                            ุงูุญุฏ ุงูุฃุฏูู: ${minQuantity} ${product.unit || 'ูุทุนุฉ'}
                        </small>
                    </div>
                </div>
                <div class="text-end">
                    <div>
                        <span class="badge bg-${alertLevel} mb-1">
                            ${quantity} ${product.unit || 'ูุทุนุฉ'}
                        </span>
                    </div>
                    <div>
                        <small class="text-muted">
                            ${quantity === 0 ? 'ููุฏ ุงููุฎุฒูู' :
                              quantity <= minQuantity * 0.5 ? 'ุญุฑุฌ ุฌุฏุงู' : 'ูุญุชุงุฌ ุชูููู'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });

    // ุฅุถุงูุฉ ุฒุฑ ูุนุฑุถ ุฌููุน ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู
    html += `
        <div class="text-center mt-3">
            <button class="btn btn-outline-warning btn-sm" onclick="showAllLowStockProducts()">
                <i class="fas fa-list me-2"></i>
                ุนุฑุถ ุฌููุน ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู (${products.length})
            </button>
        </div>
    `;

    return html;
}

/**
 * ุนุฑุถ ุชูุงุตูู ููุชุฌ ูุนูู
 */
function showProductDetails(productId) {
    console.log(`๐ฆ ุนุฑุถ ุชูุงุตูู ุงูููุชุฌ ID: ${productId}`);

    const product = appData.products.find(p => p.id === productId);
    if (!product) {
        alert('ุงูููุชุฌ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุงูุฃุตูุงู ูุน ุชูููุฒ ุงูููุชุฌ ุงููุญุฏุฏ
    showPage('products');

    // ุชูููุฒ ุงูููุชุฌ ูู ุงูุฌุฏูู ุจุนุฏ ุชุญููู ุงูุตูุญุฉ
    setTimeout(() => {
        const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
        if (productRow) {
            productRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            productRow.classList.add('table-warning');
            setTimeout(() => {
                productRow.classList.remove('table-warning');
            }, 3000);
        }
    }, 500);
}

/**
 * ุนุฑุถ ุฌููุน ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู
 */
function showAllLowStockProducts() {
    console.log('๐ฆ ุนุฑุถ ุฌููุน ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู');

    // ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุงูุฃุตูุงู ูุน ุชุทุจูู ููุชุฑ ุงููุฎุฒูู ุงูููุฎูุถ
    showPage('products');

    // ุชุทุจูู ููุชุฑ ุงููุฎุฒูู ุงูููุฎูุถ ุจุนุฏ ุชุญููู ุงูุตูุญุฉ
    setTimeout(() => {
        const stockFilter = document.getElementById('productStockFilter');
        if (stockFilter) {
            stockFilter.value = 'low';
            applyProductsFilter();
        }
    }, 500);
}

/**
 * ุตูุญุฉ ุงูุนููุงุก
 */
function getCustomersHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-users me-2"></i>
                        ูุงุฆูุฉ ุงูุนููุงุก
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showPage('add-customer')">
                            <i class="fas fa-plus me-2"></i>
                            ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportCustomersToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printContent('customers', 'ูุงุฆูุฉ ุงูุนููุงุก')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุงุฆูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">ุงูุจุญุซ</label>
                        <input type="text" class="form-control" id="customerSearch" placeholder="ุงูุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุฑูู ุงููุงุชู..." onkeyup="applyCustomersFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ููุน ุงูุนููู</label>
                        <select class="form-select" id="customerTypeFilter" onchange="applyCustomersFilter()">
                            <option value="">ุฌููุน ุงูุฃููุงุน</option>
                            <option value="individual">ูุฑุฏ</option>
                            <option value="company">ุดุฑูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุงููุฏููุฉ</label>
                        <select class="form-select" id="customerCityFilter" onchange="applyCustomersFilter()">
                            <option value="">ุฌููุน ุงููุฏู</option>
                            ${[...new Set(appData.customers.map(c => c.city).filter(city => city))].map(city =>
                                `<option value="${city}">${city}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-primary" onclick="applyCustomersFilter()">
                                <i class="fas fa-search me-2"></i>
                                ุจุญุซ
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearCustomersFilter()">
                                <i class="fas fa-times me-2"></i>
                                ูุณุญ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูุนููุงุก -->
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="customersTable">
                        <thead class="table-light">
                            <tr>
                                <th>ุงูุงุณู</th>
                                <th>ุงููุงุชู</th>
                                <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                <th>ุงูุฑุตูุฏ ุงูุญุงูู</th>
                                <th>ุญุฏ ุงูุงุฆุชูุงู</th>
                                <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getCustomersTableRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตููู ุฌุฏูู ุงูุนููุงุก
 */
function getCustomersTableRows() {
    if (appData.customers.length === 0) {
        return '<tr><td colspan="7" class="text-center text-muted">ูุง ุชูุฌุฏ ุนููุงุก</td></tr>';
    }

    let html = '';
    appData.customers.forEach(customer => {
        html += `
            <tr>
                <td>
                    <strong>${customer.name}</strong>
                    ${customer.taxNumber ? `<br><small class="text-muted">ุงูุฑูู ุงูุถุฑูุจู: ${customer.taxNumber}</small>` : ''}
                </td>
                <td>${customer.phone || '-'}</td>
                <td>${customer.email || '-'}</td>
                <td>
                    <span class="badge bg-${customer.currentBalance > 0 ? 'danger' : customer.currentBalance < 0 ? 'success' : 'secondary'}">
                        ${formatCurrency(customer.currentBalance)}
                        ${customer.currentBalance > 0 ? '(ูุฏูู)' : customer.currentBalance < 0 ? '(ุฏุงุฆู)' : '(ูุชูุงุฒู)'}
                    </span>
                </td>
                <td>${formatCurrency(customer.creditLimit)}</td>
                <td>${customer.createdAt}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${customer.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewCustomerStatement(${customer.id})" title="ูุดู ุญุณุงุจ">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${customer.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตูุญุฉ ุฅุถุงูุฉ ุนููู
 */
function getAddCustomerHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-user-plus me-2"></i>
                        ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
                    </h1>
                    <button class="btn btn-outline-secondary" onclick="showPage('customers')">
                        <i class="fas fa-arrow-right me-2"></i>
                        ุงูุนูุฏุฉ ูููุงุฆูุฉ
                    </button>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>
                            ุจูุงูุงุช ุงูุนููู
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="addCustomerForm" onsubmit="addCustomer(event)">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">
                                        <i class="fas fa-user me-1"></i>
                                        ุงุณู ุงูุนููู <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="customerPhone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>
                                        ุฑูู ุงููุงุชู
                                    </label>
                                    <input type="tel" class="form-control" id="customerPhone">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerEmail" class="form-label">
                                        <i class="fas fa-envelope me-1"></i>
                                        ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
                                    </label>
                                    <input type="email" class="form-control" id="customerEmail">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="customerTaxNumber" class="form-label">
                                        <i class="fas fa-receipt me-1"></i>
                                        ุงูุฑูู ุงูุถุฑูุจู
                                    </label>
                                    <input type="text" class="form-control" id="customerTaxNumber">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="customerAddress" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    ุงูุนููุงู
                                </label>
                                <textarea class="form-control" id="customerAddress" rows="3"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customerCreditLimit" class="form-label">
                                        <i class="fas fa-credit-card me-1"></i>
                                        ุญุฏ ุงูุงุฆุชูุงู
                                    </label>
                                    <input type="number" class="form-control" id="customerCreditLimit" min="0" step="0.01" value="0">
                                </div>
                                <div class="col-md-6 mb-3" ${appData.settings.enableMultiCurrency ? '' : 'style="display: none;"'}>
                                    <label for="customerCurrency" class="form-label">
                                        <i class="fas fa-coins me-1"></i>
                                        ุงูุนููุฉ
                                    </label>
                                    <select class="form-select" id="customerCurrency">
                                        <option value="${appData.settings.currency || 'SYP'}">${getCurrencySymbol(appData.settings.currency || 'SYP')}</option>
                                        ${appData.settings.enableMultiCurrency ? `
                                            <option value="USD">$ (ุงูุฏููุงุฑ ุงูุฃูุฑููู)</option>
                                            <option value="EUR">โฌ (ุงูููุฑู)</option>
                                            <option value="SAR">ุฑ.ุณ (ุงูุฑูุงู ุงูุณุนูุฏู)</option>
                                            <option value="AED">ุฏ.ุฅ (ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู)</option>
                                            <option value="EGP">ุฌ.ู (ุงูุฌููู ุงููุตุฑู)</option>
                                            <option value="JOD">ุฏ.ุฃ (ุงูุฏููุงุฑ ุงูุฃุฑุฏูู)</option>
                                            <option value="LBP">ู.ู (ุงูููุฑุฉ ุงููุจูุงููุฉ)</option>
                                            <option value="TRY">โบ (ุงูููุฑุฉ ุงูุชุฑููุฉ)</option>
                                            <option value="GBP">ยฃ (ุงูุฌููู ุงูุฅุณุชุฑูููู)</option>
                                        ` : ''}
                                    </select>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="showPage('customers')">
                                    <i class="fas fa-times me-2"></i>
                                    ุฅูุบุงุก
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุงูุนููู
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุงูููุฑุฏูู
 */
function getSuppliersHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-truck me-2"></i>
                        ูุงุฆูุฉ ุงูููุฑุฏูู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showPage('add-supplier')">
                            <i class="fas fa-plus me-2"></i>
                            ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportSuppliersToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printContent('suppliers', 'ูุงุฆูุฉ ุงูููุฑุฏูู')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุงุฆูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">ุงูุจุญุซ</label>
                        <input type="text" class="form-control" id="supplierSearch" placeholder="ุงูุจุญุซ ุจุงุณู ุงูููุฑุฏ ุฃู ุฑูู ุงููุงุชู..." onkeyup="applySuppliersFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ููุน ุงูููุฑุฏ</label>
                        <select class="form-select" id="supplierTypeFilter" onchange="applySuppliersFilter()">
                            <option value="">ุฌููุน ุงูุฃููุงุน</option>
                            <option value="individual">ูุฑุฏ</option>
                            <option value="company">ุดุฑูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุญุงูุฉ ุงูุฑุตูุฏ</label>
                        <select class="form-select" id="supplierBalanceFilter" onchange="applySuppliersFilter()">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="positive">ุฏุงุฆู</option>
                            <option value="negative">ูุฏูู</option>
                            <option value="zero">ูุชูุงุฒู</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-primary" onclick="applySuppliersFilter()">
                                <i class="fas fa-search me-2"></i>
                                ุจุญุซ
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearSuppliersFilter()">
                                <i class="fas fa-times me-2"></i>
                                ูุณุญ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="suppliersTable">
                        <thead class="table-light">
                            <tr>
                                <th>ุงูุงุณู</th>
                                <th>ุงููุงุชู</th>
                                <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                <th>ุงูุฑุตูุฏ ุงูุญุงูู</th>
                                <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getSuppliersTableRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตููู ุฌุฏูู ุงูููุฑุฏูู
 */
function getSuppliersTableRows() {
    if (appData.suppliers.length === 0) {
        return '<tr><td colspan="6" class="text-center text-muted">ูุง ุชูุฌุฏ ููุฑุฏูู</td></tr>';
    }

    let html = '';
    appData.suppliers.forEach(supplier => {
        html += `
            <tr>
                <td>
                    <strong>${supplier.name}</strong>
                    ${supplier.taxNumber ? `<br><small class="text-muted">ุงูุฑูู ุงูุถุฑูุจู: ${supplier.taxNumber}</small>` : ''}
                </td>
                <td>${supplier.phone || '-'}</td>
                <td>${supplier.email || '-'}</td>
                <td>
                    <span class="badge bg-${supplier.currentBalance > 0 ? 'success' : supplier.currentBalance < 0 ? 'danger' : 'secondary'}">
                        ${formatCurrency(supplier.currentBalance)}
                        ${supplier.currentBalance > 0 ? '(ุฏุงุฆู)' : supplier.currentBalance < 0 ? '(ูุฏูู)' : '(ูุชูุงุฒู)'}
                    </span>
                </td>
                <td>${supplier.createdAt}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editSupplier(${supplier.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewSupplierStatement(${supplier.id})" title="ูุดู ุญุณุงุจ">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${supplier.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตูุญุฉ ุงูุฃุตูุงู
 */
function getProductsHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-boxes me-2"></i>
                        ูุงุฆูุฉ ุงูุฃุตูุงู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showPage('add-product')">
                            <i class="fas fa-plus me-2"></i>
                            ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ
                        </button>
                        <button class="btn btn-outline-warning" onclick="recalculateAllProductQuantities()" title="ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงููููุงุช ูู ุญุฑูุงุช ุงููุฎุฒูู">
                            <i class="fas fa-calculator me-2"></i>
                            ุฅุนุงุฏุฉ ุญุณุงุจ ุงููููุงุช
                        </button>
                        <button class="btn btn-outline-info" onclick="validateAndUpdateProductQuantities()" title="ุงูุชุญูู ูู ุฏูุฉ ุงููููุงุช">
                            <i class="fas fa-check-double me-2"></i>
                            ุงูุชุญูู ูู ุงููููุงุช
                        </button>
                        <button class="btn btn-outline-success" onclick="printContent('products', 'ูุงุฆูุฉ ุงูุฃุตูุงู')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุงุฆูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ุงูุจุญุซ</label>
                        <input type="text" class="form-control" id="productSearch" placeholder="ุงูุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ..." onkeyup="applyProductsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงููุฆุฉ</label>
                        <select class="form-select" id="productCategoryFilter" onchange="applyProductsFilter()">
                            <option value="">ุฌููุน ุงููุฆุงุช</option>
                            ${[...new Set(appData.products.map(p => p.category).filter(cat => cat))].map(category =>
                                `<option value="${category}">${category}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงููุฎุฒู</label>
                        <select class="form-select" id="productWarehouseFilter" onchange="applyProductsFilter()">
                            <option value="">ุฌููุน ุงููุฎุงุฒู</option>
                            ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุญุงูุฉ ุงููุฎุฒูู</label>
                        <select class="form-select" id="productStockFilter" onchange="applyProductsFilter()">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="low">ูุฎุฒูู ููุฎูุถ</option>
                            <option value="normal">ูุฎุฒูู ุขูู</option>
                            <option value="out">ููุฏ ุงููุฎุฒูู</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-primary" onclick="applyProductsFilter()">
                                <i class="fas fa-search me-2"></i>
                                ุจุญุซ
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearProductsFilter()">
                                <i class="fas fa-times me-2"></i>
                                ูุณุญ
                            </button>
                            <button class="btn btn-outline-success ms-2" onclick="exportProductsToExcel()">
                                <i class="fas fa-file-excel me-2"></i>
                                Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="productsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ุงูููุฏ</th>
                                <th>ุงูุงุณู</th>
                                <th>ุงููุญุฏุฉ</th>
                                <th>ุณุนุฑ ุงูุชูููุฉ</th>
                                <th>ุณุนุฑ ุงูุจูุน</th>
                                <th>ุงููููุฉ</th>
                                <th>ุงูุญุฏ ุงูุฃุฏูู</th>
                                <th>ุงูุญุงูุฉ</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getProductsTableRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตููู ุฌุฏูู ุงูุฃุตูุงู
 */
function getProductsTableRows() {
    if (appData.products.length === 0) {
        return '<tr><td colspan="9" class="text-center text-muted">ูุง ุชูุฌุฏ ุฃุตูุงู</td></tr>';
    }

    let html = '';
    appData.products.forEach(product => {
        const isLowStock = product.quantity <= product.minQuantity;
        html += `
            <tr class="${isLowStock ? 'table-warning' : ''}">
                <td><strong>${product.code}</strong></td>
                <td>
                    ${product.name}
                    ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                </td>
                <td>${product.unit}</td>
                <td>${formatCurrency(product.costPrice)}</td>
                <td>${formatCurrency(product.sellingPrice)}</td>
                <td>
                    <span class="badge bg-${isLowStock ? 'danger' : 'success'}">
                        ${product.quantity} ${product.unit}
                    </span>
                </td>
                <td>${product.minQuantity} ${product.unit}</td>
                <td>
                    ${isLowStock ? '<i class="fas fa-exclamation-triangle text-warning" title="ูุฎุฒูู ููุฎูุถ"></i>' : '<i class="fas fa-check-circle text-success" title="ูุฎุฒูู ุขูู"></i>'}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewProductMovements(${product.id})" title="ุญุฑูุฉ ุงููุฎุฒูู">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตูุญุฉ ูุฑูุจุงู
 */
function getComingSoonHTML(pageName) {
    return `
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card shadow">
                    <div class="card-body py-5">
                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                        <h3 class="text-muted">ูุฑูุจุงู</h3>
                        <p class="text-muted">ูุฐู ุงูุตูุญุฉ ููุฏ ุงูุชุทููุฑ</p>
                        <p class="text-muted">ุงูุตูุญุฉ ุงููุทููุจุฉ: <strong>${pageName}</strong></p>
                        <button class="btn btn-primary" onclick="showPage('dashboard')">
                            <i class="fas fa-home me-2"></i>
                            ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตููู ุฌุฏูู ุงููุฎุงุฒู
 */
function getWarehousesTableRows() {
    if (appData.warehouses.length === 0) {
        return '<tr><td colspan="6" class="text-center text-muted">ูุง ุชูุฌุฏ ูุฎุงุฒู</td></tr>';
    }

    let html = '';
    appData.warehouses.forEach(warehouse => {
        const productsCount = appData.products.filter(p => p.warehouseId === warehouse.id).length;
        html += `
            <tr>
                <td><strong>${warehouse.name}</strong></td>
                <td>${warehouse.location || '-'}</td>
                <td>${warehouse.manager || '-'}</td>
                <td>${warehouse.phone || '-'}</td>
                <td><span class="badge bg-info">${productsCount}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-info" onclick="showWarehouseProductMovements(${warehouse.id})" title="ุญุฑูุฉ ุงูุฃุตูุงู ุงูููุตูุฉ">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editWarehouse(${warehouse.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteWarehouse(${warehouse.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตููู ุฌุฏูู ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุงููุญุณู
 */
function getInventoryDetailsRows() {
    const movements = appData.inventoryMovements || [];

    if (movements.length === 0) {
        return '<tr><td colspan="11" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู</td></tr>';
    }

    // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
    const sortedMovements = movements.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    sortedMovements.forEach((movement, index) => {
        const product = appData.products.find(p => p.id === movement.productId);
        const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

        const typeText = {
            'in': 'ุฅุฏุฎุงู',
            'out': 'ุฅุฎุฑุงุฌ',
            'transfer': 'ุชุญููู',
            'adjustment': 'ุชุณููุฉ',
            'sale': 'ูุจูุนุงุช',
            'purchase': 'ูุดุชุฑูุงุช',
            'return': 'ูุฑุชุฌุนุงุช'
        };

        const typeColor = {
            'in': 'success',
            'out': 'danger',
            'transfer': 'info',
            'adjustment': 'warning',
            'sale': 'primary',
            'purchase': 'secondary',
            'return': 'dark'
        };

        const typeIcon = {
            'in': 'fa-arrow-up',
            'out': 'fa-arrow-down',
            'transfer': 'fa-exchange-alt',
            'adjustment': 'fa-balance-scale',
            'sale': 'fa-shopping-cart',
            'purchase': 'fa-shopping-bag',
            'return': 'fa-undo'
        };

        // ุชุญุฏูุฏ ุณุจุจ ุงูุญุฑูุฉ ุจูุงุกู ุนูู ุงููุฑุฌุน
        let reason = movement.reference || '-';
        let reasonClass = '';

        if (movement.reference) {
            if (movement.reference.includes('ูุงุชูุฑุฉ')) {
                reason = movement.reference;
                reasonClass = 'text-primary';
            } else if (movement.reference.includes('ุชุญููู')) {
                reason = movement.reference;
                reasonClass = 'text-info';
            } else if (movement.reference.includes('ุชุณููุฉ')) {
                reason = movement.reference;
                reasonClass = 'text-warning';
            }
        }

        // ุชุญุฏูุฏ ุงููุณุชุฎุฏู (ุงูุชุฑุงุถู)
        const user = movement.userId ? 'ูุณุชุฎุฏู ' + movement.userId : 'ุงููุธุงู';

        html += `
            <tr class="movement-row" data-movement-type="${movement.movementType}" data-product-id="${movement.productId}" data-warehouse-id="${movement.warehouseId}">
                <td class="text-center">
                    <small>${movement.date}</small>
                </td>
                <td class="text-center">
                    <span class="badge bg-${typeColor[movement.movementType]} d-flex align-items-center justify-content-center" style="min-width: 80px;">
                        <i class="fas ${typeIcon[movement.movementType]} me-1"></i>
                        ${typeText[movement.movementType] || movement.movementType}
                    </span>
                </td>
                <td>
                    <div class="d-flex flex-column">
                        <strong class="text-dark">${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</strong>
                        <small class="text-muted">${product ? product.code : '-'}</small>
                    </div>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</span>
                </td>
                <td class="text-center">
                    <strong class="text-${movement.movementType === 'out' ? 'danger' : 'success'}">
                        ${movement.movementType === 'out' ? '-' : '+'}${movement.quantity}
                    </strong>
                </td>
                <td class="text-center">
                    <small class="text-muted">${product ? product.unit : '-'}</small>
                </td>
                <td class="text-end">
                    ${formatCurrency(movement.unitPrice || 0)}
                </td>
                <td class="text-end">
                    <strong>${formatCurrency(movement.totalAmount || (movement.quantity * (movement.unitPrice || 0)))}</strong>
                </td>
                <td class="${reasonClass}">
                    <small>${reason}</small>
                </td>
                <td class="text-center">
                    <small class="text-muted">${user}</small>
                </td>
                <td>
                    <small class="text-muted">${movement.notes || '-'}</small>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตููู ุฌุฏูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function getInventoryMovementsRows() {
    const movements = appData.inventoryMovements || [];

    if (movements.length === 0) {
        return '<tr><td colspan="9" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู</td></tr>';
    }

    let html = '';
    movements.forEach(movement => {
        const product = appData.products.find(p => p.id === movement.productId);
        const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

        const typeText = {
            'in': 'ุฅุฏุฎุงู',
            'out': 'ุฅุฎุฑุงุฌ',
            'transfer': 'ุชุญููู',
            'adjustment': 'ุชุณููุฉ'
        };

        const typeColor = {
            'in': 'success',
            'out': 'danger',
            'transfer': 'info',
            'adjustment': 'warning'
        };

        html += `
            <tr>
                <td>${movement.date}</td>
                <td><span class="badge bg-${typeColor[movement.movementType]}">${typeText[movement.movementType]}</span></td>
                <td>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</td>
                <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                <td>${movement.quantity}</td>
                <td>${formatCurrency(movement.unitPrice)}</td>
                <td>${formatCurrency(movement.totalAmount)}</td>
                <td>${movement.reference}</td>
                <td>${movement.notes || '-'}</td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตููู ุฌุฏูู ููุงุชูุฑ ุงููุจูุนุงุช
 */
function getSalesInvoicesRows(invoices) {
    let html = '';
    invoices.forEach(invoice => {
        const customer = appData.customers.find(c => c.id === invoice.customerId);
        html += `
            <tr>
                <td><strong>${invoice.invoiceNumber}</strong></td>
                <td>${customer ? customer.name : '-'}</td>
                <td>${invoice.invoiceDate}</td>
                <td>${formatCurrency(invoice.totalAmount)}</td>
                <td>${formatCurrency(invoice.paidAmount)}</td>
                <td>${formatCurrency(invoice.remainingAmount)}</td>
                <td><span class="badge bg-${getStatusColor(invoice.status)}">${getStatusText(invoice.status)}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${invoice.id})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printInvoice(${invoice.id})" title="ุทุจุงุนุฉ">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="editInvoice(${invoice.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoice(${invoice.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุตููู ุฌุฏูู ููุงุชูุฑ ุงููุดุชุฑูุงุช
 */
function getPurchaseInvoicesRows(invoices) {
    let html = '';
    invoices.forEach(invoice => {
        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
        html += `
            <tr>
                <td><strong>${invoice.invoiceNumber}</strong></td>
                <td>${supplier ? supplier.name : '-'}</td>
                <td>${invoice.invoiceDate}</td>
                <td>${formatCurrency(invoice.totalAmount)}</td>
                <td>${formatCurrency(invoice.paidAmount)}</td>
                <td>${formatCurrency(invoice.remainingAmount)}</td>
                <td><span class="badge bg-${getStatusColor(invoice.status)}">${getStatusText(invoice.status)}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${invoice.id})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printInvoice(${invoice.id})" title="ุทุจุงุนุฉ">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="editInvoice(${invoice.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoice(${invoice.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

/**
 * ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
 */
function addCustomer(event) {
    event.preventDefault();

    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('customers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุถุงูุฉ ุงูุนููุงุก');
        return;
    }

    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const email = document.getElementById('customerEmail').value.trim();
    const taxNumber = document.getElementById('customerTaxNumber').value.trim();
    const address = document.getElementById('customerAddress').value.trim();
    const creditLimit = parseFloat(document.getElementById('customerCreditLimit').value) || 0;
    const currency = document.getElementById('customerCurrency')?.value || appData.settings.currency || 'SYP';

    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
    if (appData.customers.some(c => c.name === name)) {
        alert('ููุฌุฏ ุนููู ุจููุณ ุงูุงุณู ูุณุจูุงู');
        return;
    }

    const newCustomer = {
        id: Date.now(),
        name: name,
        phone: phone,
        email: email,
        address: address,
        taxNumber: taxNumber,
        creditLimit: creditLimit,
        currency: currency,
        currentBalance: 0,
        createdAt: new Date().toISOString().split('T')[0]
    };

    appData.customers.push(newCustomer);
    saveData();

    alert('ุชู ุฅุถุงูุฉ ุงูุนููู ุจูุฌุงุญ');
    showPage('customers');
}

/**
 * ุญุฐู ุนููู
 */
function deleteCustomer(customerId) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('customers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูุนููุงุก');
        return;
    }

    const customer = appData.customers.find(c => c.id === customerId);
    if (!customer) return;

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนููู "${customer.name}"ุ`)) {
        // ุงูุชุญูู ูู ูุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ
        const hasInvoices = appData.invoices.some(inv => inv.customerId === customerId);
        if (hasInvoices) {
            alert('ูุง ูููู ุญุฐู ุงูุนููู ููุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ ุจู');
            return;
        }

        appData.customers = appData.customers.filter(c => c.id !== customerId);
        saveData();

        alert('ุชู ุญุฐู ุงูุนููู ุจูุฌุงุญ');
        showPage('customers');
    }
}

/**
 * ุชุตููุฉ ุงูุนููุงุก
 */
function filterCustomers() {
    const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
    const table = document.getElementById('customersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();

        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

/**
 * ุชูุณูู ุงูุนููุฉ ูุน ุฏูุฉ ูุญุณูุฉ
 */
function formatCurrency(amount, currency = null, decimals = 2) {
    // ุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช
    if (isNaN(amount) || amount === null || amount === undefined) {
        amount = 0;
    }

    // ุชุญููู ุฅูู ุฑูู ูุชุทุจูู ุงูุฏูุฉ
    const numericAmount = parseFloat(amount);

    // ุชุฌูุจ ูุดุงูู ุงููุงุตูุฉ ุงูุนุงุฆูุฉ
    const factor = Math.pow(10, decimals);
    const roundedAmount = Math.round((numericAmount + Number.EPSILON) * factor) / factor;

    // ุชูุณูู ุงูุฑูู ูุน ููุงุตู ุงูุขูุงู
    const formattedNumber = new Intl.NumberFormat('ar-SY', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
        useGrouping: true
    }).format(roundedAmount);

    // ุฅุถุงูุฉ ุฑูุฒ ุงูุนููุฉ ุฅุฐุง ุชู ุชุญุฏูุฏูุง
    if (currency) {
        const currencySymbol = getCurrencySymbol(currency);
        return `${formattedNumber} ${currencySymbol}`;
    }

    return formattedNumber;
}

/**
 * ุชูุณูู ุงูุฃุฑูุงู ูุน ุฏูุฉ ูุญุณูุฉ
 */
function formatNumber(number, decimals = 2) {
    if (isNaN(number) || number === null || number === undefined) return '0.00';

    // ุงูุชุนุงูู ูุน ุงูุฃุฑูุงู ุงููุจูุฑุฉ ูุงูุตุบูุฑุฉ
    const num = parseFloat(number);

    // ุชุฌูุจ ูุดุงูู ุงููุงุตูุฉ ุงูุนุงุฆูุฉ
    const factor = Math.pow(10, decimals);
    const rounded = Math.round((num + Number.EPSILON) * factor) / factor;

    return rounded.toFixed(decimals);
}

/**
 * ุญุณุงุจ ุฏููู ูููุณุจุฉ ุงููุฆููุฉ
 */
function calculatePercentage(value, total, decimals = 2) {
    if (!total || total === 0) return 0;

    const percentage = (value / total) * 100;
    return parseFloat(formatNumber(percentage, decimals));
}

/**
 * ุญุณุงุจ ุฏููู ููุฎุตู
 */
function calculateDiscount(amount, discountPercent, decimals = 2) {
    if (!amount || !discountPercent) return 0;

    const discount = preciseMultiply(amount, discountPercent) / 100;
    return parseFloat(formatNumber(discount, decimals));
}

/**
 * ุญุณุงุจ ุฏููู ููุถุฑูุจุฉ
 */
function calculateTax(amount, taxPercent, decimals = 2) {
    if (!amount || !taxPercent) return 0;

    const tax = preciseMultiply(amount, taxPercent) / 100;
    return parseFloat(formatNumber(tax, decimals));
}

/**
 * ุฌูุน ุฏููู ููุฃุฑูุงู (ุชุฌูุจ ูุดุงูู ุงููุงุตูุฉ ุงูุนุงุฆูุฉ)
 */
function preciseAdd(...numbers) {
    let sum = 0;
    const decimals = 6; // ุฏูุฉ ุฏุงุฎููุฉ ุนุงููุฉ

    numbers.forEach(num => {
        if (!isNaN(num) && num !== null && num !== undefined) {
            sum += parseFloat(num);
        }
    });

    // ุชูุฑูุจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ
    const factor = Math.pow(10, decimals);
    return Math.round((sum + Number.EPSILON) * factor) / factor;
}

/**
 * ุทุฑุญ ุฏููู ููุฃุฑูุงู
 */
function preciseSubtract(a, b) {
    if (isNaN(a) || a === null || a === undefined) a = 0;
    if (isNaN(b) || b === null || b === undefined) b = 0;

    const decimals = 6;
    const factor = Math.pow(10, decimals);

    return Math.round(((parseFloat(a) - parseFloat(b)) + Number.EPSILON) * factor) / factor;
}

/**
 * ุถุฑุจ ุฏููู ููุฃุฑูุงู
 */
function preciseMultiply(a, b, decimals = 6) {
    if (isNaN(a) || a === null || a === undefined) a = 0;
    if (isNaN(b) || b === null || b === undefined) b = 0;

    const result = parseFloat(a) * parseFloat(b);
    const factor = Math.pow(10, decimals);

    return Math.round((result + Number.EPSILON) * factor) / factor;
}

/**
 * ูุณูุฉ ุฏูููุฉ ููุฃุฑูุงู
 */
function preciseDivide(a, b, decimals = 6) {
    if (isNaN(a) || a === null || a === undefined) a = 0;
    if (isNaN(b) || b === null || b === undefined || b === 0) return 0;

    const result = parseFloat(a) / parseFloat(b);
    const factor = Math.pow(10, decimals);

    return Math.round((result + Number.EPSILON) * factor) / factor;
}

/**
 * ุงูุญุตูู ุนูู ุงูุนููุงุช ุงููุชุงุญุฉ ูู ุงููุธุงู
 */
function getAvailableCurrencies() {
    const currencies = new Set();

    // ุฅุถุงูุฉ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ
    currencies.add(appData.settings.currency || 'SYP');

    // ุฅุถุงูุฉ ุงูุนููุงุช ูู ุงูุนููุงุก
    if (appData.customers) {
        appData.customers.forEach(customer => {
            if (customer.currency) {
                currencies.add(customer.currency);
            }
        });
    }

    // ุฅุถุงูุฉ ุงูุนููุงุช ูู ุงูููุฑุฏูู
    if (appData.suppliers) {
        appData.suppliers.forEach(supplier => {
            if (supplier.currency) {
                currencies.add(supplier.currency);
            }
        });
    }

    // ุฅุถุงูุฉ ุงูุนููุงุช ูู ุงูููุงุชูุฑ
    if (appData.invoices) {
        appData.invoices.forEach(invoice => {
            if (invoice.currency) {
                currencies.add(invoice.currency);
            }
        });
    }

    // ุฅุถุงูุฉ ุงูุนููุงุช ูู ุงููุฏููุนุงุช
    if (appData.receipts) {
        appData.receipts.forEach(receipt => {
            if (receipt.currency) {
                currencies.add(receipt.currency);
            }
        });
    }

    if (appData.payments) {
        appData.payments.forEach(payment => {
            if (payment.currency) {
                currencies.add(payment.currency);
            }
        });
    }

    return Array.from(currencies).sort();
}

/**
 * ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงูุญุณุงุจุงุช ุงููุชุงุญุฉ
 */
function getAvailableAccounts() {
    const accounts = new Set();

    // ุฅุถุงูุฉ ุงูุญุณุงุจุงุช ูู ุงููููุฏ ุงููุญุงุณุจูุฉ
    if (appData.journalEntries) {
        appData.journalEntries.forEach(entry => {
            if (entry.debitAccount) {
                accounts.add(entry.debitAccount);
            }
            if (entry.creditAccount) {
                accounts.add(entry.creditAccount);
            }
        });
    }

    return Array.from(accounts).sort();
}

/**
 * ุงูุญุตูู ุนูู ููู ุงูุญุงูุฉ
 */
function getStatusColor(status) {
    switch(status) {
        case 'confirmed': return 'success';
        case 'draft': return 'warning';
        case 'cancelled': return 'danger';
        case 'paid': return 'info';
        default: return 'secondary';
    }
}

/**
 * ุงูุญุตูู ุนูู ูุต ุงูุญุงูุฉ
 */
function getStatusText(status) {
    switch(status) {
        case 'confirmed': return 'ูุคูุฏุฉ';
        case 'draft': return 'ูุณูุฏุฉ';
        case 'cancelled': return 'ููุบูุฉ';
        case 'paid': return 'ูุฏููุนุฉ';
        default: return status;
    }
}

/**
 * ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
 */
function addNewProduct(event) {
    event.preventDefault();

    const code = document.getElementById('productCode').value.trim();
    const name = document.getElementById('productName').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    const unit = document.getElementById('productUnit').value;
    const category = document.getElementById('productCategory').value;
    const warehouseId = parseInt(document.getElementById('productWarehouse').value);
    const costPrice = parseFloat(document.getElementById('productCostPrice').value);
    const sellingPrice = parseFloat(document.getElementById('productSellingPrice').value);
    const quantity = parseFloat(document.getElementById('productQuantity').value);
    const minQuantity = parseFloat(document.getElementById('productMinQuantity').value);
    const barcode = document.getElementById('productBarcode').value.trim();

    if (!code || !name || !unit || !warehouseId || costPrice < 0 || sellingPrice < 0 || quantity < 0 || minQuantity < 0) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ ุจููู ุตุญูุญุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ
    if (appData.products.some(p => p.code === code)) {
        alert('ููุฌุฏ ููุชุฌ ุจููุณ ุงูููุฏ ูุณุจูุงู');
        return;
    }

    const newProduct = {
        id: Date.now(),
        code: code,
        name: name,
        description: description,
        unit: unit,
        category: category,
        warehouseId: warehouseId,
        costPrice: costPrice,
        sellingPrice: sellingPrice,
        quantity: quantity,
        minQuantity: minQuantity,
        barcode: barcode,
        isActive: true,
        createdAt: new Date().toISOString().split('T')[0]
    };

    appData.products.push(newProduct);

    // ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู ูููููุฉ ุงูุฃูููุฉ
    if (quantity > 0) {
        addInventoryMovement({
            productId: newProduct.id,
            warehouseId: warehouseId,
            movementType: 'in',
            quantity: quantity,
            unitPrice: costPrice,
            reference: 'ุฅุฏุฎุงู ุฃููู',
            notes: 'ูููุฉ ุฃูููุฉ ุนูุฏ ุฅุถุงูุฉ ุงูููุชุฌ'
        });
    }

    saveData();

    alert('ุชู ุฅุถุงูุฉ ุงูููุชุฌ ุจูุฌุงุญ');
    showPage('products');
}

/**
 * ุนุฑุถ ุญุฑูุฉ ุงูุฃุตูุงู ุงูููุตูุฉ ููุฎุฒู ูุนูู
 */
function showWarehouseProductMovements(warehouseId) {
    console.log(`๐ ุนุฑุถ ุญุฑูุฉ ุงูุฃุตูุงู ุงูููุตูุฉ ูููุฎุฒู ID: ${warehouseId}`);

    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) {
        alert('ุงููุฎุฒู ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุงูุญุตูู ุนูู ุฌููุน ุงูููุชุฌุงุช ูู ูุฐุง ุงููุฎุฒู
    const warehouseProducts = appData.products.filter(p => p.warehouseId === warehouseId);

    // ุงูุญุตูู ุนูู ุฌููุน ุญุฑูุงุช ุงููุฎุฒูู ููุฐุง ุงููุฎุฒู
    const warehouseMovements = (appData.inventoryMovements || []).filter(m => m.warehouseId === warehouseId);

    // ุฅูุดุงุก ุชูุฑูุฑ ููุตู ููู ููุชุฌ
    let reportHTML = `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-chart-line me-2"></i>
                        ุญุฑูุฉ ุงูุฃุตูุงู ุงูููุตูุฉ - ${warehouse.name}
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" onclick="showPage('warehouses')">
                            <i class="fas fa-arrow-right me-2"></i>
                            ุงูุนูุฏุฉ ูููุฎุงุฒู
                        </button>
                        <button class="btn btn-warning" onclick="refreshWarehouseMovements(${warehouseId})" title="ุชุญุฏูุซ ุญุณุงุจุงุช ุงูุญุฑูุฉ">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ ุงูุญุณุงุจุงุช
                        </button>
                        <button class="btn btn-outline-success" onclick="exportWarehouseMovementsToExcel(${warehouseId})">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-primary" onclick="printWarehouseMovements(${warehouseId})">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ูุนูููุงุช ุงููุฎุฒู -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-warehouse me-2"></i>
                    ูุนูููุงุช ุงููุฎุฒู
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>ุงุณู ุงููุฎุฒู:</strong> ${warehouse.name}
                    </div>
                    <div class="col-md-3">
                        <strong>ุงููููุน:</strong> ${warehouse.location || '-'}
                    </div>
                    <div class="col-md-3">
                        <strong>ุงููุฏูุฑ:</strong> ${warehouse.manager || '-'}
                    </div>
                    <div class="col-md-3">
                        <strong>ุนุฏุฏ ุงูุฃุตูุงู:</strong> <span class="badge bg-info">${warehouseProducts.length}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ ูุญุณูุฉ -->
        ${generateWarehouseStatistics(warehouseId, warehouseMovements, warehouseProducts)}
    `;

    // ุฅุถุงูุฉ ุชูุงุตูู ูู ููุชุฌ
    if (warehouseProducts.length > 0) {
        reportHTML += `
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>
                        ุชูุงุตูู ุญุฑูุฉ ุงูุฃุตูุงู
                    </h5>
                </div>
                <div class="card-body">
        `;

        warehouseProducts.forEach(product => {
            // ููุชุฑุฉ ุงูุญุฑูุงุช ููููุชุฌ ุงูุญุงูู (ุงุณุชุจุนุงุฏ ุงููุญุฐููุฉ)
            const productMovements = warehouseMovements.filter(m =>
                m.productId === product.id &&
                m.isDeleted !== true
            );

            // ุญุณุงุจ ุงูุฅุฏุฎุงูุงุช (ุดุฑุงุกุ ุฅุฑุฌุงุน ูุจูุนุงุชุ ุชุญููู ุฏุงุฎูุ ุชุณููุฉ ููุฌุจุฉ)
            const totalIn = productMovements.filter(m =>
                m.movementType === 'in' ||
                (m.movementType === 'adjustment' && m.quantity > 0) ||
                m.movementType === 'return_sale' ||
                m.movementType === 'transfer_in'
            ).reduce((sum, m) => sum + Math.abs(m.quantity), 0);

            // ุญุณุงุจ ุงูุฅุฎุฑุงุฌุงุช (ุจูุนุ ุฅุฑุฌุงุน ูุดุชุฑูุงุชุ ุชุญููู ุฎุงุฑุฌุ ุชุณููุฉ ุณุงูุจุฉุ ุชูู)
            const totalOut = productMovements.filter(m =>
                m.movementType === 'out' ||
                (m.movementType === 'adjustment' && m.quantity < 0) ||
                m.movementType === 'return_purchase' ||
                m.movementType === 'transfer_out' ||
                m.movementType === 'damage' ||
                m.movementType === 'sale'
            ).reduce((sum, m) => sum + Math.abs(m.quantity), 0);

            // ุฅุถุงูุฉ ุฅุฎุฑุงุฌุงุช ูู ููุงุชูุฑ ุงููุจูุนุงุช
            const salesFromInvoices = (appData.invoices || [])
                .filter(inv =>
                    inv.invoiceType === 'sale' &&
                    inv.status === 'confirmed' &&
                    inv.isDeleted !== true
                )
                .reduce((sum, inv) => {
                    const item = inv.items.find(item => item.productId === product.id);
                    return sum + (item ? item.quantity : 0);
                }, 0);

            const totalOutWithSales = totalOut + salesFromInvoices;
            const netMovement = totalIn - totalOutWithSales;

            reportHTML += `
                <div class="accordion mb-3" id="product-${product.id}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse-${product.id}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <div>
                                        <strong>${product.name}</strong>
                                        <span class="text-muted">(${product.code})</span>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary me-2">ุงููููุฉ ุงูุญุงููุฉ: ${product.quantity}</span>
                                        <span class="badge bg-success me-2">ุฅุฏุฎุงู: ${totalIn}</span>
                                        <span class="badge bg-danger me-2">ุฅุฎุฑุงุฌ: ${totalOutWithSales}</span>
                                        <span class="badge bg-warning me-2">ูุจูุนุงุช: ${salesFromInvoices}</span>
                                        <span class="badge bg-${netMovement >= 0 ? 'info' : 'warning'}">ุงูุตุงูู: ${netMovement}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse-${product.id}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                ${getProductMovementsTable(product, productMovements)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        reportHTML += `
                </div>
            </div>
        `;
    } else {
        reportHTML += `
            <div class="card shadow">
                <div class="card-body text-center">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">ูุง ุชูุฌุฏ ุฃุตูุงู ูู ูุฐุง ุงููุฎุฒู</h5>
                </div>
            </div>
        `;
    }

    // ุนุฑุถ ุงูุชูุฑูุฑ
    document.getElementById('main-content').innerHTML = reportHTML;
}

/**
 * ุฅูุดุงุก ุฅุญุตุงุฆูุงุช ุงููุฎุฒู ุงููุญุณูุฉ
 */
function generateWarehouseStatistics(warehouseId, warehouseMovements, warehouseProducts) {
    console.log('๐ ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงููุฎุฒู ุงููุญุณูุฉ...');

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ุงูุฃุณุงุณูุฉ
    let totalIn = 0, totalOut = 0, totalTransferIn = 0, totalTransferOut = 0;
    let totalAdjustmentPositive = 0, totalAdjustmentNegative = 0;
    let totalValue = 0, totalMovements = 0;

    // ุญุณุงุจ ุฅุฎุฑุงุฌุงุช ูู ููุงุชูุฑ ุงููุจูุนุงุช
    let totalSalesFromInvoices = 0;
    (appData.invoices || [])
        .filter(inv =>
            inv.invoiceType === 'sale' &&
            inv.status === 'confirmed' &&
            inv.isDeleted !== true
        )
        .forEach(inv => {
            inv.items.forEach(item => {
                const product = warehouseProducts.find(p => p.id === item.productId);
                if (product) {
                    totalSalesFromInvoices += item.quantity;
                }
            });
        });

    // ุชุญููู ุญุฑูุงุช ุงููุฎุฒูู
    warehouseMovements.forEach(movement => {
        if (movement.isDeleted === true) return;

        const quantity = Math.abs(parseFloat(movement.quantity) || 0);
        const unitPrice = parseFloat(movement.unitPrice) || 0;
        const value = quantity * unitPrice;

        totalMovements++;
        totalValue += value;

        switch (movement.movementType) {
            case 'in':
                totalIn += quantity;
                break;
            case 'out':
                totalOut += quantity;
                break;
            case 'transfer_in':
            case 'transfer':
                if (movement.quantity > 0) {
                    totalTransferIn += quantity;
                } else {
                    totalTransferOut += quantity;
                }
                break;
            case 'transfer_out':
                totalTransferOut += quantity;
                break;
            case 'adjustment':
                if (movement.quantity > 0) {
                    totalAdjustmentPositive += quantity;
                } else {
                    totalAdjustmentNegative += quantity;
                }
                break;
        }
    });

    // ุญุณุงุจ ุงูุตุงูู
    const netIn = totalIn + totalTransferIn + totalAdjustmentPositive;
    const netOut = totalOut + totalTransferOut + totalAdjustmentNegative + totalSalesFromInvoices;
    const netMovement = netIn - netOut;

    // ุญุณุงุจ ูููุฉ ุงููุฎุฒูู ุงูุญุงููุฉ
    const currentStockValue = warehouseProducts.reduce((sum, product) => {
        return sum + ((product.quantity || 0) * (product.costPrice || 0));
    }, 0);

    return `
        <div class="row mb-4">
            <!-- ุงูุฅุฏุฎุงูุงุช -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-up fa-2x mb-2"></i>
                        <h4>${totalIn.toFixed(2)}</h4>
                        <small>ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช</small>
                    </div>
                </div>
            </div>

            <!-- ุงูุฅุฎุฑุงุฌุงุช -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-danger text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-down fa-2x mb-2"></i>
                        <h4>${totalOut.toFixed(2)}</h4>
                        <small>ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช</small>
                    </div>
                </div>
            </div>

            <!-- ุงูุชุญูููุงุช ุงูุฏุงุฎูุฉ -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-right fa-2x mb-2"></i>
                        <h4>${totalTransferIn.toFixed(2)}</h4>
                        <small>ุชุญูููุงุช ุฏุงุฎูุฉ</small>
                    </div>
                </div>
            </div>

            <!-- ุงูุชุญูููุงุช ุงูุฎุงุฑุฌุฉ -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-warning text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-left fa-2x mb-2"></i>
                        <h4>${totalTransferOut.toFixed(2)}</h4>
                        <small>ุชุญูููุงุช ุฎุงุฑุฌุฉ</small>
                    </div>
                </div>
            </div>

            <!-- ุงููุจูุนุงุช ูู ุงูููุงุชูุฑ -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                        <h4>${totalSalesFromInvoices.toFixed(2)}</h4>
                        <small>ูุจูุนุงุช ูู ุงูููุงุชูุฑ</small>
                    </div>
                </div>
            </div>

            <!-- ุงูุตุงูู -->
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card bg-${netMovement >= 0 ? 'secondary' : 'dark'} text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-balance-scale fa-2x mb-2"></i>
                        <h4>${netMovement.toFixed(2)}</h4>
                        <small>ุตุงูู ุงูุญุฑูุฉ</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูุชุณููุงุช -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="card-title text-success">ุชุณููุงุช ููุฌุจุฉ</h6>
                        <h4 class="text-success">${totalAdjustmentPositive.toFixed(2)}</h4>
                        <small class="text-muted">ุฒูุงุฏุฉ ูู ุงููุฎุฒูู</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h6 class="card-title text-danger">ุชุณููุงุช ุณุงูุจุฉ</h6>
                        <h4 class="text-danger">${Math.abs(totalAdjustmentNegative).toFixed(2)}</h4>
                        <small class="text-muted">ููุต ูู ุงููุฎุฒูู</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="card-title text-info">ุฅุฌูุงูู ุงูุญุฑูุงุช</h6>
                        <h4 class="text-info">${totalMovements}</h4>
                        <small class="text-muted">ุนุฏุฏ ุงูุญุฑูุงุช</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="card-title text-primary">ูููุฉ ุงููุฎุฒูู</h6>
                        <h4 class="text-primary">${formatCurrency(currentStockValue)}</h4>
                        <small class="text-muted">ุงููููุฉ ุงูุญุงููุฉ</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ููุตู -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    ููุฎุต ููุตู ููุญุฑูุฉ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">ุฅุฌูุงูู ุงูุฏุงุฎู:</h6>
                        <ul class="list-unstyled ms-3">
                            <li>โข ุฅุฏุฎุงูุงุช ูุจุงุดุฑุฉ: <strong>${totalIn.toFixed(2)}</strong></li>
                            <li>โข ุชุญูููุงุช ุฏุงุฎูุฉ: <strong>${totalTransferIn.toFixed(2)}</strong></li>
                            <li>โข ุชุณููุงุช ููุฌุจุฉ: <strong>${totalAdjustmentPositive.toFixed(2)}</strong></li>
                            <li class="border-top pt-2 mt-2">
                                <strong>ุงููุฌููุน: ${netIn.toFixed(2)}</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">ุฅุฌูุงูู ุงูุฎุงุฑุฌ:</h6>
                        <ul class="list-unstyled ms-3">
                            <li>โข ุฅุฎุฑุงุฌุงุช ูุจุงุดุฑุฉ: <strong>${totalOut.toFixed(2)}</strong></li>
                            <li>โข ุชุญูููุงุช ุฎุงุฑุฌุฉ: <strong>${totalTransferOut.toFixed(2)}</strong></li>
                            <li>โข ุชุณููุงุช ุณุงูุจุฉ: <strong>${Math.abs(totalAdjustmentNegative).toFixed(2)}</strong></li>
                            <li>โข ูุจูุนุงุช ูู ุงูููุงุชูุฑ: <strong>${totalSalesFromInvoices.toFixed(2)}</strong></li>
                            <li class="border-top pt-2 mt-2">
                                <strong>ุงููุฌููุน: ${netOut.toFixed(2)}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-${netMovement >= 0 ? 'success' : 'warning'} mb-0">
                            <strong>ุตุงูู ุงูุญุฑูุฉ: ${netMovement.toFixed(2)}</strong>
                            ${netMovement >= 0 ?
                                ' - ุงููุฎุฒู ูู ุญุงูุฉ ุฒูุงุฏุฉ' :
                                ' - ุงููุฎุฒู ูู ุญุงูุฉ ููุต'
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุฅูุดุงุก ุฌุฏูู ุญุฑูุงุช ููุชุฌ ูุนูู
 */
function getProductMovementsTable(product, movements) {
    if (movements.length === 0) {
        return `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle me-2"></i>
                ูุง ุชูุฌุฏ ุญุฑูุงุช ููุฐุง ุงูุตูู
            </div>
        `;
    }

    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ููุน ุงูุญุฑูุฉ</th>
                        <th>ุงููููุฉ</th>
                        <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                        <th>ุงููุฌููุน</th>
                        <th>ุงููุฑุฌุน</th>
                        <th>ููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody>
    `;

    movements.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(movement => {
        const typeText = {
            'in': 'ุฅุฏุฎุงู',
            'out': 'ุฅุฎุฑุงุฌ',
            'transfer': 'ุชุญููู',
            'adjustment': 'ุชุณููุฉ'
        };

        const typeColor = {
            'in': 'success',
            'out': 'danger',
            'transfer': 'info',
            'adjustment': 'warning'
        };

        tableHTML += `
            <tr>
                <td>${movement.date}</td>
                <td><span class="badge bg-${typeColor[movement.movementType]}">${typeText[movement.movementType]}</span></td>
                <td>${movement.quantity}</td>
                <td>${formatCurrency(movement.unitPrice || 0)}</td>
                <td>${formatCurrency(movement.totalAmount || 0)}</td>
                <td>${movement.reference || '-'}</td>
                <td>${movement.notes || '-'}</td>
            </tr>
        `;
    });

    tableHTML += `
                </tbody>
            </table>
        </div>
    `;

    return tableHTML;
}

/**
 * ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู
 */
function addInventoryMovement(movement) {
    if (!appData.inventoryMovements) {
        appData.inventoryMovements = [];
    }

    const newMovement = {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        productId: movement.productId,
        warehouseId: movement.warehouseId,
        movementType: movement.movementType, // 'in', 'out', 'transfer', 'adjustment'
        quantity: movement.quantity,
        unitPrice: movement.unitPrice || 0,
        totalAmount: movement.quantity * (movement.unitPrice || 0),
        reference: movement.reference || '',
        notes: movement.notes || '',
        createdAt: new Date().toISOString()
    };

    appData.inventoryMovements.push(newMovement);

    // ุชุญุฏูุซ ูููุฉ ุงูููุชุฌ
    const product = appData.products.find(p => p.id === movement.productId);
    if (product) {
        if (movement.movementType === 'in') {
            product.quantity += movement.quantity;
        } else if (movement.movementType === 'out') {
            product.quantity -= movement.quantity;
        }
    }
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู
 */
function showAddMovementModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addMovementModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMovementForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="movementType" class="form-label">ููุน ุงูุญุฑูุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="movementType" required>
                                    <option value="">ุงุฎุชุฑ ููุน ุงูุญุฑูุฉ</option>
                                    <option value="in">ุฅุฏุฎุงู</option>
                                    <option value="out">ุฅุฎุฑุงุฌ</option>
                                    <option value="adjustment">ุชุณููุฉ</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movementProduct" class="form-label">ุงูููุชุฌ <span class="text-danger">*</span></label>
                                <select class="form-select" id="movementProduct" required>
                                    <option value="">ุงุฎุชุฑ ุงูููุชุฌ</option>
                                    ${appData.products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="movementWarehouse" class="form-label">ุงููุฎุฒู <span class="text-danger">*</span></label>
                                <select class="form-select" id="movementWarehouse" required>
                                    <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
                                    ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movementQuantity" class="form-label">ุงููููุฉ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="movementQuantity" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="movementUnitPrice" class="form-label">ุณุนุฑ ุงููุญุฏุฉ</label>
                                <input type="number" class="form-control" id="movementUnitPrice" min="0" step="0.01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="movementReference" class="form-label">ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="movementReference">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="movementNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="movementNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryMovement()">ุญูุธ ุงูุญุฑูุฉ</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุญุฑูุฉ ุงููุฎุฒูู
 */
function saveInventoryMovement() {
    const movementType = document.getElementById('movementType').value;
    const productId = parseInt(document.getElementById('movementProduct').value);
    const warehouseId = parseInt(document.getElementById('movementWarehouse').value);
    const quantity = parseFloat(document.getElementById('movementQuantity').value);
    const unitPrice = parseFloat(document.getElementById('movementUnitPrice').value) || 0;
    const reference = document.getElementById('movementReference').value.trim();
    const notes = document.getElementById('movementNotes').value.trim();

    if (!movementType || !productId || !warehouseId || quantity <= 0) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุชููุฑ ุงููููุฉ ูู ุญุงูุฉ ุงูุฅุฎุฑุงุฌ
    if (movementType === 'out') {
        const product = appData.products.find(p => p.id === productId);
        if (product && product.quantity < quantity) {
            alert(`ุงููููุฉ ุงููุชุงุญุฉ: ${product.quantity} ${product.unit}`);
            return;
        }
    }

    addInventoryMovement({
        productId: productId,
        warehouseId: warehouseId,
        movementType: movementType,
        quantity: quantity,
        unitPrice: unitPrice,
        reference: reference,
        notes: notes
    });

    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('addMovementModal'));
    modal.hide();

    alert('ุชู ุญูุธ ุญุฑูุฉ ุงููุฎุฒูู ุจูุฌุงุญ');
    showPage('inventory');
}

/**
 * ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ
 */
function addSupplier(event) {
    event.preventDefault();

    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('suppliers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุถุงูุฉ ุงูููุฑุฏูู');
        return;
    }

    const name = document.getElementById('supplierName').value.trim();
    const phone = document.getElementById('supplierPhone').value.trim();
    const email = document.getElementById('supplierEmail').value.trim();
    const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
    const address = document.getElementById('supplierAddress').value.trim();
    const currency = document.getElementById('supplierCurrency')?.value || appData.settings.currency || 'SYP';

    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูููุฑุฏ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
    if (appData.suppliers.some(s => s.name === name)) {
        alert('ููุฌุฏ ููุฑุฏ ุจููุณ ุงูุงุณู ูุณุจูุงู');
        return;
    }

    const newSupplier = {
        id: Date.now(),
        name: name,
        phone: phone,
        email: email,
        address: address,
        taxNumber: taxNumber,
        currency: currency,
        currentBalance: 0,
        createdAt: new Date().toISOString().split('T')[0]
    };

    appData.suppliers.push(newSupplier);
    saveData();

    alert('ุชู ุฅุถุงูุฉ ุงูููุฑุฏ ุจูุฌุงุญ');
    showPage('suppliers');
}

/**
 * ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ
 */
function addWarehouse() {
    const name = document.getElementById('warehouseName').value.trim();
    const location = document.getElementById('warehouseLocation').value.trim();
    const manager = document.getElementById('warehouseManager').value.trim();
    const phone = document.getElementById('warehousePhone').value.trim();

    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุฎุฒู');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
    if (appData.warehouses.some(w => w.name === name)) {
        alert('ููุฌุฏ ูุฎุฒู ุจููุณ ุงูุงุณู ูุณุจูุงู');
        return;
    }

    const newWarehouse = {
        id: Date.now(),
        name: name,
        location: location,
        manager: manager,
        phone: phone,
        isActive: true,
        createdAt: new Date().toISOString().split('T')[0]
    };

    appData.warehouses.push(newWarehouse);
    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('addWarehouseModal'));
    modal.hide();

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
    showPage('warehouses');

    alert('ุชู ุฅุถุงูุฉ ุงููุฎุฒู ุจูุฌุงุญ');
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุฅุถุงูุฉ ูุฎุฒู
 */
function showAddWarehouseModal() {
    const modal = new bootstrap.Modal(document.getElementById('addWarehouseModal'));
    modal.show();
}

/**
 * ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููู/ุงูููุฑุฏ ูู ูุงุชูุฑุฉ
 */
function updateClientOptions() {
    const invoiceType = document.getElementById('invoiceType').value;
    const clientSelect = document.getElementById('clientSelect');
    const clientLabel = document.getElementById('clientLabel');

    // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ
    clientSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ</option>';

    if (invoiceType === 'sale') {
        clientLabel.textContent = 'ุงูุนููู';
        appData.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            clientSelect.appendChild(option);
        });
    } else if (invoiceType === 'purchase') {
        clientLabel.textContent = 'ุงูููุฑุฏ';
        appData.suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier.id;
            option.textContent = supplier.name;
            clientSelect.appendChild(option);
        });
    }

    // ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ
    updateInvoiceNumber();
}

/**
 * ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ
 */
function updateInvoiceNumber() {
    const invoiceType = document.getElementById('invoiceType').value;
    const invoiceNumber = document.getElementById('invoiceNumber');

    if (invoiceType) {
        const prefix = invoiceType === 'sale' ? 'SALE' : 'PUR';
        const year = new Date().getFullYear();
        const count = appData.invoices.filter(inv => inv.invoiceType === invoiceType).length + 1;
        invoiceNumber.value = `${prefix}-${year}-${count.toString().padStart(3, '0')}`;
    } else {
        invoiceNumber.value = '';
    }
}

/**
 * ุฅุถุงูุฉ ุนูุตุฑ ูููุงุชูุฑุฉ - ูุณุฎุฉ ูุญุณูุฉ ููุชูุงููุฉ
 */
function addInvoiceItem() {
    console.log('โ ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ...');

    const tableBody = document.getElementById('invoiceItemsTable');
    if (!tableBody) {
        console.error('โ ุฌุฏูู ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏ');
        alert('ุฎุทุฃ: ุฌุฏูู ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏ');
        return;
    }

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <select class="form-select item-product" required onchange="updateItemPrice(this)">
                <option value="">ุงุฎุชุฑ ุงูุตูู</option>
                ${appData.products.map(p => `<option value="${p.id}" data-price="${p.sellingPrice}">${p.name}</option>`).join('')}
            </select>
        </td>
        <td>
            <textarea class="form-control item-specifications" rows="2" placeholder="ุฃุฏุฎู ุงูููุงุตูุงุช (ุงุฎุชูุงุฑู)"></textarea>
        </td>
        <td>
            <input type="number" class="form-control item-quantity" min="1" step="0.01" value="1" required onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control item-price" min="0" step="0.01" required onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control item-discount" min="0" max="100" step="0.01" value="0" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <span class="item-total">0.00 ู.ุณ</span>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeInvoiceItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tableBody.appendChild(row);
    console.log('โ ุชู ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ');
}

/**
 * ุญุฐู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ
 */
function removeInvoiceItem(button) {
    const row = button.closest('tr');
    row.remove();
    calculateInvoiceTotals();
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุนูุตุฑ ุนูุฏ ุงุฎุชูุงุฑ ุงูุตูู
 */
function updateItemPrice(select) {
    console.log('๐ฐ ุชุญุฏูุซ ุณุนุฑ ุงูุนูุตุฑ...');

    const selectedOption = select.options[select.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    const row = select.closest('tr');
    const priceInput = row.querySelector('.item-price');

    if (price && priceInput) {
        priceInput.value = price;
        console.log('โ ุชู ุชุญุฏูุซ ุงูุณุนุฑ:', price);
        calculateItemTotal(priceInput);
    }
}

/**
 * ุญุณุงุจ ุฅุฌูุงูู ุงูุนูุตุฑ
 */
function calculateItemTotal(input) {
    console.log('๐งฎ ุญุณุงุจ ุฅุฌูุงูู ุงูุนูุตุฑ...');

    const row = input.closest('tr');
    const quantity = parseFloat(row.querySelector('.item-quantity')?.value) || 0;
    const unitPrice = parseFloat(row.querySelector('.item-price')?.value) || 0;
    const discountPercent = parseFloat(row.querySelector('.item-discount')?.value) || 0;

    const subtotal = quantity * unitPrice;
    const discountAmount = subtotal * (discountPercent / 100);
    const total = subtotal - discountAmount;

    const totalElement = row.querySelector('.item-total');
    if (totalElement) {
        totalElement.textContent = `${total.toFixed(2)} ู.ุณ`;
    }

    console.log('โ ุชู ุญุณุงุจ ุงููุฌููุน:', { quantity, unitPrice, discountPercent, total });
    calculateInvoiceTotals();
}

/**
 * ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ
 */
function calculateInvoiceTotals() {
    console.log('๐ฐ ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ ุจุฏูุฉ ูุญุณูุฉ...');

    // ุฌูุน ูุฌุงููุน ุงูุนูุงุตุฑ ุจุงุณุชุฎุฏุงู ุญุณุงุจุงุช ุฏูููุฉ
    const itemRows = document.querySelectorAll('#invoiceItemsTable tr');
    let subtotalItems = [];

    itemRows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity')?.value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-price')?.value) || 0;
        const discountPercent = parseFloat(row.querySelector('.item-discount')?.value) || 0;

        // ุญุณุงุจ ุฏููู ููู ุนูุตุฑ
        const itemSubtotal = preciseMultiply(quantity, unitPrice);
        const itemDiscountAmount = calculateDiscount(itemSubtotal, discountPercent);
        const itemTotal = preciseSubtract(itemSubtotal, itemDiscountAmount);

        subtotalItems.push(itemTotal);

        // ุชุญุฏูุซ ุนุฑุถ ุงููุฌููุน ููุนูุตุฑ
        const itemTotalElement = row.querySelector('.item-total');
        if (itemTotalElement) {
            itemTotalElement.textContent = formatCurrency(itemTotal);
        }
    });

    // ุญุณุงุจ ุงููุฌููุน ุงููุฑุนู ุงูุฅุฌูุงูู
    const subtotal = preciseAdd(...subtotalItems);

    // ุญุณุงุจ ุงูุฎุตู ุงูุนุงู ูุงูุถุฑูุจุฉ
    const discountPercent = parseFloat(document.getElementById('discountPercentage')?.value) || 0;
    const taxPercent = parseFloat(document.getElementById('taxPercentage')?.value) || 0;

    const discountAmount = calculateDiscount(subtotal, discountPercent);
    const taxableAmount = preciseSubtract(subtotal, discountAmount);
    const taxAmount = calculateTax(taxableAmount, taxPercent);
    const totalAmount = preciseAdd(taxableAmount, taxAmount);

    // ุชุญุฏูุซ ุงูุนุฑุถ ูุน ุงูุชูุณูู ุงููุญุณู
    const subtotalElement = document.getElementById('subtotalAmount');
    const discountAmountElement = document.getElementById('discountAmount');
    const taxAmountElement = document.getElementById('taxAmount');
    const totalAmountElement = document.getElementById('totalAmount');

    if (subtotalElement) subtotalElement.textContent = formatCurrency(subtotal);
    if (discountAmountElement) discountAmountElement.textContent = formatCurrency(discountAmount);
    if (taxAmountElement) taxAmountElement.textContent = formatCurrency(taxAmount);
    if (totalAmountElement) totalAmountElement.textContent = formatCurrency(totalAmount);

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ ุฅุฐุง ูุงู ูุชุงุญุงู
    const currencySelect = document.getElementById('invoiceCurrency');
    if (currencySelect) {
        updateInvoiceCurrencyDisplay(currencySelect.value, getCurrencySymbol(currencySelect.value));
    }

    console.log('โ ุชู ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุจุฏูุฉ:', {
        subtotal: formatNumber(subtotal),
        discountAmount: formatNumber(discountAmount),
        taxAmount: formatNumber(taxAmount),
        totalAmount: formatNumber(totalAmount)
    });

    return {
        subtotal,
        discountAmount,
        taxAmount,
        totalAmount,
        itemsCount: subtotalItems.length
    };
}

/**
 * ุชููุฆุฉ ุฃุญุฏุงุซ ุงูุตูุญุฉ
 */
function initializePageEvents() {
    // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุชูููุญุงุช
    const tooltips = document.querySelectorAll('[title]');
    tooltips.forEach(element => {
        element.setAttribute('data-bs-toggle', 'tooltip');
        new bootstrap.Tooltip(element);
    });

    // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู ููุญููู
    const today = getCurrentDateForInput();
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        if (!input.value && input.id.includes('Date') && !input.id.includes('due')) {
            input.value = today;
        }
    });
}

/**
 * ูุธุงุฆู ูุคูุชุฉ ููุตูุญุงุช ูุงูุนูููุงุช
 */

// ูุธุงุฆู ุงูุนููุงุก
function editCustomer(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('customers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุงูุนููุงุก');
        return;
    }

    const customer = appData.customers.find(c => c.id === id);
    if (!customer) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงูุนููู
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editCustomerModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุงูุนููู: ${customer.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงุณู ุงูุนููู *</label>
                                    <input type="text" class="form-control" id="editCustomerName" value="${customer.name}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุฑูู ุงููุงุชู</label>
                                    <input type="tel" class="form-control" id="editCustomerPhone" value="${customer.phone || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                    <input type="email" class="form-control" id="editCustomerEmail" value="${customer.email || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฑูู ุงูุถุฑูุจู</label>
                                    <input type="text" class="form-control" id="editCustomerTaxNumber" value="${customer.taxNumber || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ุงูุนููุงู</label>
                            <textarea class="form-control" id="editCustomerAddress" rows="2">${customer.address || ''}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุญุฏ ุงูุงุฆุชูุงูู</label>
                                    <input type="number" class="form-control" id="editCustomerCreditLimit" value="${customer.creditLimit || 0}" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฑุตูุฏ ุงูุญุงูู</label>
                                    <input type="number" class="form-control" id="editCustomerBalance" value="${customer.currentBalance || 0}" step="0.01" readonly>
                                    <small class="form-text text-muted">ูุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุชููุงุฆูุงู ูู ุงูููุงุชูุฑ ูุงูุฏูุนุงุช</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editCustomerNotes" rows="2">${customer.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="updateCustomer(${id})">ุญูุธ ุงูุชุบููุฑุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function updateCustomer(id) {
    const customer = appData.customers.find(c => c.id === id);
    if (!customer) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู');
        return;
    }

    // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
    const name = document.getElementById('editCustomerName').value.trim();
    const phone = document.getElementById('editCustomerPhone').value.trim();
    const email = document.getElementById('editCustomerEmail').value.trim();
    const taxNumber = document.getElementById('editCustomerTaxNumber').value.trim();
    const address = document.getElementById('editCustomerAddress').value.trim();
    const creditLimit = parseFloat(document.getElementById('editCustomerCreditLimit').value) || 0;
    const notes = document.getElementById('editCustomerNotes').value.trim();

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู (ุฅุฐุง ุชู ุชุบููุฑู)
    if (name !== customer.name) {
        const existingCustomer = appData.customers.find(c => c.name === name && c.id !== id);
        if (existingCustomer) {
            alert('ููุฌุฏ ุนููู ุขุฎุฑ ุจููุณ ุงูุงุณู');
            return;
        }
    }

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู
    customer.name = name;
    customer.phone = phone;
    customer.email = email;
    customer.taxNumber = taxNumber;
    customer.address = address;
    customer.creditLimit = creditLimit;
    customer.notes = notes;
    customer.updatedAt = new Date().toISOString().split('T')[0];

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
    modal.hide();

    alert('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ุจูุฌุงุญ');
    showPage('customers'); // ุฅุนุงุฏุฉ ุชุญููู ุตูุญุฉ ุงูุนููุงุก
}

function viewCustomerStatement(id) {
    showPage('customer-statement');
    // ูููู ุฅุถุงูุฉ ููุทู ูุชุญุฏูุฏ ุงูุนููู ุชููุงุฆูุงู
}

// ูุธุงุฆู ุงูููุฑุฏูู
function editSupplier(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('suppliers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุงูููุฑุฏูู');
        return;
    }

    const supplier = appData.suppliers.find(s => s.id === id);
    if (!supplier) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุฑุฏ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงูููุฑุฏ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editSupplierModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุงูููุฑุฏ: ${supplier.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSupplierForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงุณู ุงูููุฑุฏ *</label>
                                    <input type="text" class="form-control" id="editSupplierName" value="${supplier.name}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุฑูู ุงููุงุชู</label>
                                    <input type="tel" class="form-control" id="editSupplierPhone" value="${supplier.phone || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                    <input type="email" class="form-control" id="editSupplierEmail" value="${supplier.email || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฑูู ุงูุถุฑูุจู</label>
                                    <input type="text" class="form-control" id="editSupplierTaxNumber" value="${supplier.taxNumber || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ุงูุนููุงู</label>
                            <textarea class="form-control" id="editSupplierAddress" rows="2">${supplier.address || ''}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฑุตูุฏ ุงูุญุงูู</label>
                                    <input type="number" class="form-control" id="editSupplierBalance" value="${supplier.currentBalance || 0}" step="0.01" readonly>
                                    <small class="form-text text-muted">ูุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุชููุงุฆูุงู ูู ุงูููุงุชูุฑ ูุงูุฏูุนุงุช</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editSupplierNotes" rows="2">${supplier.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="updateSupplier(${id})">ุญูุธ ุงูุชุบููุฑุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function updateSupplier(id) {
    const supplier = appData.suppliers.find(s => s.id === id);
    if (!supplier) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุฑุฏ');
        return;
    }

    // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
    const name = document.getElementById('editSupplierName').value.trim();
    const phone = document.getElementById('editSupplierPhone').value.trim();
    const email = document.getElementById('editSupplierEmail').value.trim();
    const taxNumber = document.getElementById('editSupplierTaxNumber').value.trim();
    const address = document.getElementById('editSupplierAddress').value.trim();
    const notes = document.getElementById('editSupplierNotes').value.trim();

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูููุฑุฏ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู (ุฅุฐุง ุชู ุชุบููุฑู)
    if (name !== supplier.name) {
        const existingSupplier = appData.suppliers.find(s => s.name === name && s.id !== id);
        if (existingSupplier) {
            alert('ููุฌุฏ ููุฑุฏ ุขุฎุฑ ุจููุณ ุงูุงุณู');
            return;
        }
    }

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ
    supplier.name = name;
    supplier.phone = phone;
    supplier.email = email;
    supplier.taxNumber = taxNumber;
    supplier.address = address;
    supplier.notes = notes;
    supplier.updatedAt = new Date().toISOString().split('T')[0];

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
    modal.hide();

    alert('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ ุจูุฌุงุญ');
    showPage('suppliers'); // ุฅุนุงุฏุฉ ุชุญููู ุตูุญุฉ ุงูููุฑุฏูู
}

function viewSupplierStatement(id) {
    showPage('supplier-statement');
    // ูููู ุฅุถุงูุฉ ููุทู ูุชุญุฏูุฏ ุงูููุฑุฏ ุชููุงุฆูุงู
}

function deleteSupplier(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('suppliers')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูููุฑุฏูู');
        return;
    }

    const supplier = appData.suppliers.find(s => s.id === id);
    if (!supplier) return;

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุฑุฏ "${supplier.name}"ุ`)) {
        // ุงูุชุญูู ูู ูุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ
        const hasInvoices = appData.invoices.some(inv => inv.supplierId === id);
        if (hasInvoices) {
            alert('ูุง ูููู ุญุฐู ุงูููุฑุฏ ููุฌูุฏ ููุงุชูุฑ ูุฑุชุจุทุฉ ุจู');
            return;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุฏูุนุงุช ูุฑุชุจุทุฉ
        const hasPayments = appData.payments.some(pay => pay.supplierId === id);
        if (hasPayments) {
            alert('ูุง ูููู ุญุฐู ุงูููุฑุฏ ููุฌูุฏ ุฏูุนุงุช ูุฑุชุจุทุฉ ุจู');
            return;
        }

        appData.suppliers = appData.suppliers.filter(s => s.id !== id);
        saveData();
        showPage('suppliers');
        alert('ุชู ุญุฐู ุงูููุฑุฏ ุจูุฌุงุญ');
    }
}

// ูุธุงุฆู ุงูุฃุตูุงู - ูุญุณูุฉ
function editProduct(id) {
    console.log('โ๏ธ ูุชุญ ูุงูุฐุฉ ุชุนุฏูู ุงูุตูู ID:', id);

    // ุงูุชุญูู ูู ุตุญุฉ ุงููุนุฑู
    if (!id || isNaN(id)) {
        showErrorToast('ูุนุฑู ุงูุตูู ุบูุฑ ุตุญูุญ');
        return;
    }

    // ุงูุจุญุซ ุนู ุงูุตูู
    const product = appData.products.find(p => p.id == id);
    if (!product) {
        showErrorToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุตูู ุงููุทููุจ');
        return;
    }

    // ุงูุชุญูู ูู ุญุงูุฉ ุงูุตูู
    if (product.isActive === false) {
        showWarningToast('ูุฐุง ุงูุตูู ูุญุฐูู - ูุง ูููู ุชุนุฏููู');
        return;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุฎุงุฒู
    if (!appData.warehouses || appData.warehouses.length === 0) {
        showErrorToast('ูุง ุชูุฌุฏ ูุฎุงุฒู ูุชุงุญุฉ - ูุฑุฌู ุฅุถุงูุฉ ูุฎุฒู ุฃููุงู');
        return;
    }

    try {
        // ุฅุฒุงูุฉ ุฃู ูุงูุฐุฉ ุชุนุฏูู ููุฌูุฏุฉ ูุณุจูุงู
        const existingModal = document.getElementById('editProductModal');
        if (existingModal) {
            existingModal.remove();
        }

        // ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงูุตูู ูุน ูุนุงูุฌุฉ ูุญุณูุฉ ููุฃุฎุทุงุก
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'editProductModal';
        modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุงูุตูู: ${product.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ููุฏ ุงูุตูู *</label>
                                    <input type="text" class="form-control" id="editProductCode" value="${product.code}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงุณู ุงูุตูู *</label>
                                    <input type="text" class="form-control" id="editProductName" value="${product.name}" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ุงููุตู</label>
                            <textarea class="form-control" id="editProductDescription" rows="2">${product.description || ''}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ุงููุญุฏุฉ</label>
                                    <input type="text" class="form-control" id="editProductUnit" value="${product.unit || 'ูุทุนุฉ'}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ุงููุฆุฉ</label>
                                    <input type="text" class="form-control" id="editProductCategory" value="${product.category || ''}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ุงููุฎุฒู</label>
                                    <select class="form-select" id="editProductWarehouse" required>
                                        ${appData.warehouses.map(w => `
                                            <option value="${w.id}" ${w.id === product.warehouseId ? 'selected' : ''}>${w.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุณุนุฑ ุงูุชูููุฉ</label>
                                    <input type="number" class="form-control" id="editProductCostPrice" value="${product.costPrice || 0}" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุณุนุฑ ุงูุจูุน</label>
                                    <input type="number" class="form-control" id="editProductSellingPrice" value="${product.sellingPrice || 0}" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงููููุฉ ุงูุญุงููุฉ</label>
                                    <input type="number" class="form-control" id="editProductQuantity" value="${product.quantity || 0}" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุญุฏ ุงูุฃุฏูู</label>
                                    <input type="number" class="form-control" id="editProductMinQuantity" value="${product.minQuantity || 0}" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ุงูุจุงุฑููุฏ</label>
                            <input type="text" class="form-control" id="editProductBarcode" value="${product.barcode || ''}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct(${id})">ุญูุธ ุงูุชุบููุฑุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

        // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
        modal.addEventListener('hidden.bs.modal', function() {
            try {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            } catch (removeError) {
                console.error('โ ุฎุทุฃ ูู ุฅุฒุงูุฉ ุงููุงูุฐุฉ:', removeError);
            }
        });

        console.log('โ ุชู ูุชุญ ูุงูุฐุฉ ุชุนุฏูู ุงูุตูู ุจูุฌุงุญ');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงูุตูู:', error);
        showErrorToast('ุญุฏุซ ุฎุทุฃ ูู ูุชุญ ูุงูุฐุฉ ุงูุชุนุฏูู: ' + error.message);

        // ุชูุธูู ุฃู ุนูุงุตุฑ ูุชุจููุฉ
        const existingModal = document.getElementById('editProductModal');
        if (existingModal) {
            try {
                existingModal.remove();
            } catch (cleanupError) {
                console.error('โ ุฎุทุฃ ูู ุชูุธูู ุงููุงูุฐุฉ:', cleanupError);
            }
        }
    }
}

function updateProduct(id) {
    console.log('๐พ ุชุญุฏูุซ ุจูุงูุงุช ุงูุตูู ID:', id);

    // ุงูุชุญูู ูู ุตุญุฉ ุงููุนุฑู
    if (!id || (typeof id !== 'number' && isNaN(parseInt(id)))) {
        showErrorToast('ูุนุฑู ุงูุตูู ุบูุฑ ุตุญูุญ');
        console.error('โ ูุนุฑู ุงูุตูู ุบูุฑ ุตุญูุญ:', id);
        return;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData || !appData.products || !Array.isArray(appData.products)) {
        showErrorToast('ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ - ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ');
        console.error('โ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ูุชููุฑุฉ');
        return;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
    const product = appData.products.find(p => p.id == id); // ุงุณุชุฎุฏุงู == ููููุงุฑูุฉ ุงููุฑูุฉ
    if (!product) {
        showErrorToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุตูู ุงููุทููุจ');
        console.error('โ ุงูุตูู ุบูุฑ ููุฌูุฏุ ID:', id);
        return;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ุงููููุฐุฌ
    const codeElement = document.getElementById('editProductCode');
    const nameElement = document.getElementById('editProductName');
    const descriptionElement = document.getElementById('editProductDescription');
    const unitElement = document.getElementById('editProductUnit');
    const categoryElement = document.getElementById('editProductCategory');
    const warehouseElement = document.getElementById('editProductWarehouse');
    const costPriceElement = document.getElementById('editProductCostPrice');
    const sellingPriceElement = document.getElementById('editProductSellingPrice');
    const quantityElement = document.getElementById('editProductQuantity');
    const minQuantityElement = document.getElementById('editProductMinQuantity');
    const barcodeElement = document.getElementById('editProductBarcode');

    if (!codeElement || !nameElement || !warehouseElement) {
        showErrorToast('ุฎุทุฃ ูู ุงููููุฐุฌ - ูุฑุฌู ุฅุนุงุฏุฉ ูุชุญ ูุงูุฐุฉ ุงูุชุนุฏูู');
        return;
    }

    // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ ูุน ุงูุชุญูู ูู ุงูุฃูุงู
    const code = codeElement.value.trim();
    const name = nameElement.value.trim();
    const description = descriptionElement ? descriptionElement.value.trim() : '';
    const unit = unitElement ? unitElement.value.trim() : 'ูุทุนุฉ';
    const category = categoryElement ? categoryElement.value.trim() : '';
    const warehouseId = parseInt(warehouseElement.value);
    const costPrice = costPriceElement ? (parseFloat(costPriceElement.value) || 0) : 0;
    const sellingPrice = sellingPriceElement ? (parseFloat(sellingPriceElement.value) || 0) : 0;
    const quantity = quantityElement ? (parseFloat(quantityElement.value) || 0) : 0;
    const minQuantity = minQuantityElement ? (parseFloat(minQuantityElement.value) || 0) : 0;
    const barcode = barcodeElement ? barcodeElement.value.trim() : '';

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!code || !name) {
        showErrorToast('ูุฑุฌู ุฅุฏุฎุงู ููุฏ ูุงุณู ุงูุตูู');
        return;
    }

    if (!warehouseId || isNaN(warehouseId)) {
        showErrorToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฎุฒู');
        return;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุงููุฎุฒู
    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) {
        showErrorToast('ุงููุฎุฒู ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ (ุฅุฐุง ุชู ุชุบููุฑู)
    if (code !== product.code) {
        const existingProduct = appData.products.find(p => p.code === code && p.id !== id);
        if (existingProduct) {
            showErrorToast('ููุฌุฏ ุตูู ุขุฎุฑ ุจููุณ ุงูููุฏ: ' + code);
            return;
        }
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุฃุณุนุงุฑ
    if (costPrice < 0 || sellingPrice < 0) {
        showErrorToast('ูุง ูููู ุฃู ุชููู ุงูุฃุณุนุงุฑ ุณุงูุจุฉ');
        return;
    }

    if (quantity < 0 || minQuantity < 0) {
        showErrorToast('ูุง ูููู ุฃู ุชููู ุงููููุงุช ุณุงูุจุฉ');
        return;
    }

    try {
        // ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ ููููุงุฑูุฉ
        const oldData = { ...product };

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุตูู ุจุฃูุงู
        product.code = code;
        product.name = name;
        product.description = description;
        product.unit = unit || 'ูุทุนุฉ';
        product.category = category;
        product.warehouseId = warehouseId;
        product.costPrice = costPrice;
        product.sellingPrice = sellingPrice;
        product.quantity = quantity;
        product.minQuantity = minQuantity;
        product.barcode = barcode;
        product.updatedAt = new Date().toISOString();
        product.lastModified = new Date().toISOString();

        // ุฅูุดุงุก ุญุฑูุฉ ูุฎุฒูู ุฅุฐุง ุชุบูุฑุช ุงููููุฉ
        if (oldData.quantity !== quantity) {
            const quantityDifference = quantity - oldData.quantity;
            const movementRecord = {
                id: generateId(),
                productId: id,
                warehouseId: warehouseId,
                movementType: 'adjustment',
                quantity: quantityDifference, // ุงููุฑู ุงููุนูู (ููุฌุจ ุฃู ุณุงูุจ)
                unitPrice: costPrice,
                totalAmount: Math.abs(quantityDifference) * costPrice,
                date: new Date().toISOString().split('T')[0],
                movement_date: new Date().toISOString(),
                reference: `ุชุนุฏูู ูุฏูู - ุชุบููุฑ ูู ${oldData.quantity} ุฅูู ${quantity}`,
                notes: `ุชุนุฏูู ุงููููุฉ ูู ูุงุฆูุฉ ุงูุฃุตูุงู - ${quantityDifference > 0 ? 'ุฒูุงุฏุฉ' : 'ููุต'} ${Math.abs(quantityDifference)}`,
                userId: 'admin'
            };

            // ุฅุถุงูุฉ ุงูุญุฑูุฉ ุฅูู ูุงุฆูุฉ ุญุฑูุงุช ุงููุฎุฒูู
            if (!appData.inventoryMovements) {
                appData.inventoryMovements = [];
            }
            appData.inventoryMovements.push(movementRecord);

            console.log('๐ ุชู ุชุณุฌูู ุญุฑูุฉ ุงููุฎุฒูู:', movementRecord);
        }

        // ุฅูุดุงุก ุณุฌู ุชุบููุฑ ููุชุชุจุน
        const changeRecord = {
            id: generateId(),
            productId: id,
            changeDate: new Date().toISOString(),
            changeType: 'product_update',
            oldData: oldData,
            newData: {
                code, name, description, unit, category, warehouseId,
                costPrice, sellingPrice, quantity, minQuantity, barcode
            },
            userId: 'admin'
        };

        // ุฅุถุงูุฉ ุงูุณุฌู ุฅูู ูุงุฆูุฉ ุงูุชุบููุฑุงุช
        if (!appData.productChanges) {
            appData.productChanges = [];
        }
        appData.productChanges.push(changeRecord);

        // ุญูุธ ุงูุจูุงูุงุช ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ
        try {
            saveData();
            console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');
        } catch (saveError) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', saveError);

            // ูุญุงููุฉ ุญูุธ ุจุฏููุฉ
            try {
                localStorage.setItem('sam_pro_data_backup', JSON.stringify(appData));
                console.log('๐พ ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ');
                showWarningToast('ุชู ุงูุญูุธ ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
            } catch (backupError) {
                console.error('โ ูุดู ูู ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', backupError);
                showErrorToast('ูุดู ูู ุญูุธ ุงูุจูุงูุงุช - ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู');
                return; // ุฅููุงู ุงูุนูููุฉ ูู ุญุงูุฉ ูุดู ุงูุญูุธ
            }
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ ุจุฃูุงู
        try {
            const modalElement = document.getElementById('editProductModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    // ุฅุบูุงู ูุฏูู ุฅุฐุง ูุดู Bootstrap
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
        } catch (modalError) {
            console.error('โ ุฎุทุฃ ูู ุฅุบูุงู ุงููุงูุฐุฉ:', modalError);
        }

        // ุชุญุฏูุซ ุงูุตูุญุฉ ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
        try {
            updateProductsDisplay();
            console.log('โ ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุฃุตูุงู ุจูุฌุงุญ');
        } catch (displayError) {
            console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฑุถ:', displayError);
            showWarningToast('ุชู ุญูุธ ุงูุชุนุฏูู ูููู ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฑุถ');
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุญู ุจุฏูู
            setTimeout(() => {
                try {
                    showPage('products');
                } catch (pageError) {
                    console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ:', pageError);
                    location.reload(); // ุฅุนุงุฏุฉ ุชุญููู ูุงูู ููุตูุญุฉ
                }
            }, 1000);
        }

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุน ุชูุงุตูู ุงูุชุบููุฑ
        const changes = [];
        if (oldData.name !== name) changes.push(`ุงูุงุณู: ${oldData.name} โ ${name}`);
        if (oldData.code !== code) changes.push(`ุงูููุฏ: ${oldData.code} โ ${code}`);
        if (oldData.quantity !== quantity) changes.push(`ุงููููุฉ: ${oldData.quantity} โ ${quantity}`);
        if (oldData.costPrice !== costPrice) changes.push(`ุณุนุฑ ุงูุชูููุฉ: ${oldData.costPrice} โ ${costPrice}`);
        if (oldData.sellingPrice !== sellingPrice) changes.push(`ุณุนุฑ ุงูุจูุน: ${oldData.sellingPrice} โ ${sellingPrice}`);
        if (oldData.warehouseId !== warehouseId) {
            const oldWarehouse = appData.warehouses.find(w => w.id === oldData.warehouseId);
            const newWarehouse = appData.warehouses.find(w => w.id === warehouseId);
            changes.push(`ุงููุฎุฒู: ${oldWarehouse?.name || 'ุบูุฑ ูุญุฏุฏ'} โ ${newWarehouse?.name || 'ุบูุฑ ูุญุฏุฏ'}`);
        }

        let successMessage = 'ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุตูู ุจูุฌุงุญ!';
        if (changes.length > 0) {
            console.log('๐ ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:', changes);
        }

        showSuccessToast('ุชู ุชุญุฏูุซ ุงูุตูู ุจูุฌุงุญ!');
        console.log('โ ุชู ุชุญุฏูุซ ุงูุตูู:', product.name);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุตูู:', error);
        showErrorToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุตูู: ' + error.message);

        // ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
        try {
            const backupData = localStorage.getItem('sam_pro_data_backup');
            if (backupData) {
                console.log('๐ ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');
                // ูููู ุฅุถุงูุฉ ููุทู ุงูุงุณุชุนุงุฏุฉ ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
            }
        } catch (restoreError) {
            console.error('โ ูุดู ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', restoreError);
        }
    }
}

/**
 * ุชุญุฏูุซ ุนุฑุถ ุงูุฃุตูุงู ุฏูู ุฅุนุงุฏุฉ ุชุญููู ูุงูู ููุตูุญุฉ - ูุญุณู
 */
function updateProductsDisplay() {
    console.log('๐ ุชุญุฏูุซ ุนุฑุถ ุงูุฃุตูุงู...');

    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (!appData || !appData.products) {
            console.error('โ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุบูุฑ ูุชููุฑุฉ');
            showErrorToast('ุฎุทุฃ ูู ุงูุจูุงูุงุช - ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ');
            setTimeout(() => showPage('products'), 1000);
            return;
        }

        // ุชุญุฏูุซ ุฌุฏูู ุงูุฃุตูุงู ุฅุฐุง ูุงู ููุฌูุฏุงู
        const productsTableBody = document.querySelector('#productsTable tbody');
        if (productsTableBody) {
            try {
                // ุงูุชุญูู ูู ูุฌูุฏ ูุธููุฉ getProductsTableRows
                if (typeof getProductsTableRows !== 'function') {
                    console.error('โ ูุธููุฉ getProductsTableRows ุบูุฑ ููุฌูุฏุฉ');
                    productsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-warning">ุฎุทุฃ ูู ูุธููุฉ ุงูุนุฑุถ - ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ</td></tr>';
                    setTimeout(() => showPage('products'), 2000);
                    return;
                }

                const productsRows = getProductsTableRows();
                if (productsRows && productsRows.trim() !== '') {
                    productsTableBody.innerHTML = productsRows;
                    console.log('โ ุชู ุชุญุฏูุซ ุฌุฏูู ุงูุฃุตูุงู');
                } else {
                    console.warn('โ๏ธ ูู ูุชู ุฅูุดุงุก ุตููู ุงูุฌุฏูู');
                    productsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ูุง ุชูุฌุฏ ุฃุตูุงู ููุนุฑุถ</td></tr>';
                }
            } catch (tableError) {
                console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฌุฏูู ุงูุฃุตูุงู:', tableError);
                productsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช - ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ</td></tr>';
                showErrorToast('ุฎุทุฃ ูู ุชุญุฏูุซ ุฌุฏูู ุงูุฃุตูุงู');
            }
        } else {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฌุฏูู ุงูุฃุตูุงู ูู ุงูุตูุญุฉ');
        }

        // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฃุตูุงู ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
        try {
            const activeProducts = appData.products.filter(p => p.isActive !== false);

            // ุฅุฌูุงูู ุงูุฃุตูุงู
            const totalProductsElement = document.getElementById('totalProducts');
            if (totalProductsElement) {
                totalProductsElement.textContent = activeProducts.length;
            }

            // ุงูุฃุตูุงู ููุฎูุถุฉ ุงููุฎุฒูู
            const lowStockProductsElement = document.getElementById('lowStockProducts');
            if (lowStockProductsElement) {
                const lowStockCount = activeProducts.filter(p =>
                    (p.quantity || 0) <= (p.minQuantity || 0) &&
                    (p.minQuantity || 0) > 0
                ).length;
                lowStockProductsElement.textContent = lowStockCount;
            }

            // ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู
            const totalValueElement = document.getElementById('totalValue');
            if (totalValueElement) {
                const totalValue = activeProducts.reduce((sum, p) => {
                    const quantity = parseFloat(p.quantity) || 0;
                    const costPrice = parseFloat(p.costPrice) || 0;
                    return sum + (quantity * costPrice);
                }, 0);
                totalValueElement.textContent = formatCurrency(totalValue);
            }

            console.log('โ ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฃุตูุงู');

        } catch (statsError) {
            console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช:', statsError);
            showWarningToast('ุชู ุชุญุฏูุซ ุงูุฌุฏูู ูููู ุญุฏุซ ุฎุทุฃ ูู ุงูุฅุญุตุงุฆูุงุช');
        }

        // ุชุญุฏูุซ ุนุฏุงุฏุงุช ุฃุฎุฑู ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
        try {
            // ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฃุตูุงู ูู ุงูุดุฑูุท ุงูุฌุงูุจู
            const sidebarProductsCount = document.querySelector('.sidebar .products-count');
            if (sidebarProductsCount) {
                sidebarProductsCount.textContent = appData.products.filter(p => p.isActive !== false).length;
            }

            // ุชุญุฏูุซ ุฃู ุนุฏุงุฏุงุช ุฃุฎุฑู
            const allProductCounters = document.querySelectorAll('[data-counter="products"]');
            allProductCounters.forEach(counter => {
                counter.textContent = appData.products.filter(p => p.isActive !== false).length;
            });

        } catch (countersError) {
            console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช ุงูุฅุถุงููุฉ:', countersError);
        }

        console.log('โ ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุฃุตูุงู ุจูุฌุงุญ');

    } catch (error) {
        console.error('โ ุฎุทุฃ ุนุงู ูู ุชุญุฏูุซ ุนุฑุถ ุงูุฃุตูุงู:', error);
        showErrorToast('ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฑุถ - ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ');

        // ูุญุงููุฉ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ
        setTimeout(() => {
            try {
                showPage('products');
            } catch (reloadError) {
                console.error('โ ูุดู ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ:', reloadError);
                location.reload(); // ุฅุนุงุฏุฉ ุชุญููู ูุงูู ููุตูุญุฉ ูุญู ุฃุฎูุฑ
            }
        }, 2000);
    }
}

/**
 * ุนุฑุถ ุญุฑูุฉ ุตูู ููุตูุฉ
 */
function viewProductMovements(productId) {
    console.log(`๐ ุนุฑุถ ุญุฑูุฉ ุงูุตูู ุงูููุตูุฉ ID: ${productId}`);

    const product = appData.products.find(p => p.id === productId);
    if (!product) {
        alert('ุงูุตูู ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุงูุญุตูู ุนูู ุฌููุน ุญุฑูุงุช ูุฐุง ุงูุตูู
    const productMovements = (appData.inventoryMovements || []).filter(m => m.productId === productId);

    // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
    productMovements.sort((a, b) => new Date(b.date) - new Date(a.date));

    // ุฅูุดุงุก ูุงูุฐุฉ ููุจุซูุฉ ูุนุฑุถ ุงูุชูุงุตูู
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'productMovementsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>
                        ุญุฑูุฉ ุงูุตูู ุงูููุตูุฉ: ${product.name}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ูุนูููุงุช ุงูุตูู -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                ูุนูููุงุช ุงูุตูู
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ุงูููุฏ:</strong> ${product.code}
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงููุญุฏุฉ:</strong> ${product.unit}
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงููููุฉ ุงูุญุงููุฉ:</strong>
                                    <span class="badge bg-${product.quantity <= product.minQuantity ? 'danger' : 'success'}">
                                        ${product.quantity} ${product.unit}
                                    </span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงูุญุฏ ุงูุฃุฏูู:</strong> ${product.minQuantity} ${product.unit}
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <strong>ุณุนุฑ ุงูุชูููุฉ:</strong> ${formatCurrency(product.costPrice)}
                                </div>
                                <div class="col-md-4">
                                    <strong>ุณุนุฑ ุงูุจูุน:</strong> ${formatCurrency(product.sellingPrice)}
                                </div>
                                <div class="col-md-4">
                                    <strong>ุฅุฌูุงูู ุงูุญุฑูุงุช:</strong>
                                    <span class="badge bg-info">${productMovements.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุฅุญุตุงุฆูุงุช ุงูุญุฑูุฉ -->
                    ${generateMovementStats(productMovements)}

                    <!-- ุฌุฏูู ุงูุญุฑูุงุช -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                ุชูุงุตูู ุงูุญุฑูุงุช
                            </h6>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-success" onclick="exportProductMovementsToExcel(${productId})">
                                    <i class="fas fa-file-excel me-1"></i>
                                    Excel
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="printProductMovements(${productId})">
                                    <i class="fas fa-print me-1"></i>
                                    ุทุจุงุนุฉ
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ุงูุชุงุฑูุฎ</th>
                                            <th>ููุน ุงูุญุฑูุฉ</th>
                                            <th>ุงููุฎุฒู</th>
                                            <th>ุงููููุฉ</th>
                                            <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                            <th>ุฅุฌูุงูู ุงููููุฉ</th>
                                            <th>ุงููุฑุฌุน</th>
                                            <th>ุงูููุงุญุธุงุช</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${generateProductMovementsRows(productMovements)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุฅูุดุงุก ุฅุญุตุงุฆูุงุช ุญุฑูุฉ ุงูุตูู
 */
function generateMovementStats(movements) {
    if (movements.length === 0) {
        return `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                ูุง ุชูุฌุฏ ุญุฑูุงุช ููุฐุง ุงูุตูู
            </div>
        `;
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    let totalIn = 0, totalOut = 0, totalValue = 0;
    const movementTypes = {};
    const monthlyStats = {};

    movements.forEach(movement => {
        const quantity = parseFloat(movement.quantity) || 0;
        const unitPrice = parseFloat(movement.unitPrice) || 0;
        const value = quantity * unitPrice;

        if (movement.movementType === 'in') {
            totalIn += quantity;
        } else if (movement.movementType === 'out') {
            totalOut += quantity;
        }

        totalValue += value;

        // ุฅุญุตุงุฆูุงุช ุฃููุงุน ุงูุญุฑูุงุช
        if (!movementTypes[movement.movementType]) {
            movementTypes[movement.movementType] = { count: 0, quantity: 0, value: 0 };
        }
        movementTypes[movement.movementType].count++;
        movementTypes[movement.movementType].quantity += quantity;
        movementTypes[movement.movementType].value += value;

        // ุฅุญุตุงุฆูุงุช ุดูุฑูุฉ
        const month = movement.date.substring(0, 7); // YYYY-MM
        if (!monthlyStats[month]) {
            monthlyStats[month] = { in: 0, out: 0, value: 0 };
        }
        if (movement.movementType === 'in') {
            monthlyStats[month].in += quantity;
        } else if (movement.movementType === 'out') {
            monthlyStats[month].out += quantity;
        }
        monthlyStats[month].value += value;
    });

    const netMovement = totalIn - totalOut;
    const typeNames = {
        'in': 'ุฅุฏุฎุงู',
        'out': 'ุฅุฎุฑุงุฌ',
        'transfer': 'ุชุญููู',
        'adjustment': 'ุชุณููุฉ'
    };

    return `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-up fa-2x mb-2"></i>
                        <h5>${totalIn}</h5>
                        <small>ุฅุฌูุงูู ุงูุฅุฏุฎุงู</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-arrow-down fa-2x mb-2"></i>
                        <h5>${totalOut}</h5>
                        <small>ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌ</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-${netMovement >= 0 ? 'info' : 'warning'} text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-balance-scale fa-2x mb-2"></i>
                        <h5>${netMovement}</h5>
                        <small>ุตุงูู ุงูุญุฑูุฉ</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                        <h5>${formatCurrency(totalValue)}</h5>
                        <small>ุฅุฌูุงูู ุงููููุฉ</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    ุฅุญุตุงุฆูุงุช ุฃููุงุน ุงูุญุฑูุงุช
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    ${Object.keys(movementTypes).map(type => `
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>${typeNames[type] || type}:</strong></span>
                                <span>
                                    ${movementTypes[type].count} ุญุฑูุฉ |
                                    ${movementTypes[type].quantity} ูุญุฏุฉ |
                                    ${formatCurrency(movementTypes[type].value)}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

/**
 * ุฅูุดุงุก ุตููู ุฌุฏูู ุญุฑูุงุช ุงูุตูู
 */
function generateProductMovementsRows(movements) {
    if (movements.length === 0) {
        return '<tr><td colspan="8" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ููุฐุง ุงูุตูู</td></tr>';
    }

    const typeText = {
        'in': 'ุฅุฏุฎุงู',
        'out': 'ุฅุฎุฑุงุฌ',
        'transfer': 'ุชุญููู',
        'adjustment': 'ุชุณููุฉ'
    };

    const typeColor = {
        'in': 'success',
        'out': 'danger',
        'transfer': 'info',
        'adjustment': 'warning'
    };

    return movements.map(movement => {
        const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
        const quantity = parseFloat(movement.quantity) || 0;
        const unitPrice = parseFloat(movement.unitPrice) || 0;
        const totalValue = quantity * unitPrice;

        return `
            <tr>
                <td>${formatDateTime(movement.date)}</td>
                <td>
                    <span class="badge bg-${typeColor[movement.movementType] || 'secondary'}">
                        ${typeText[movement.movementType] || movement.movementType}
                    </span>
                </td>
                <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                <td>
                    <span class="badge bg-${movement.movementType === 'in' ? 'success' : 'danger'}">
                        ${movement.movementType === 'in' ? '+' : '-'}${quantity}
                    </span>
                </td>
                <td>${formatCurrency(unitPrice)}</td>
                <td>${formatCurrency(totalValue)}</td>
                <td>${movement.reference || '-'}</td>
                <td>${movement.notes || '-'}</td>
            </tr>
        `;
    }).join('');
}

/**
 * ุชุตุฏูุฑ ุญุฑูุงุช ุงูุตูู ุฅูู Excel
 */
function exportProductMovementsToExcel(productId) {
    console.log(`๐ ุชุตุฏูุฑ ุญุฑูุงุช ุงูุตูู ุฅูู Excel: ${productId}`);

    const product = appData.products.find(p => p.id === productId);
    if (!product) {
        alert('ุงูุตูู ุบูุฑ ููุฌูุฏ');
        return;
    }

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const movements = (appData.inventoryMovements || []).filter(m => m.productId === productId);
        movements.sort((a, b) => new Date(b.date) - new Date(a.date));

        // ุฅูุดุงุก ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const data = [
            ['ุชูุฑูุฑ ุญุฑูุฉ ุงูุตูู ุงูููุตู'],
            [''],
            ['ูุนูููุงุช ุงูุตูู:'],
            ['ุงูููุฏ', product.code],
            ['ุงูุงุณู', product.name],
            ['ุงููุญุฏุฉ', product.unit],
            ['ุงููููุฉ ุงูุญุงููุฉ', product.quantity],
            ['ุงูุญุฏ ุงูุฃุฏูู', product.minQuantity],
            ['ุณุนุฑ ุงูุชูููุฉ', product.costPrice],
            ['ุณุนุฑ ุงูุจูุน', product.sellingPrice],
            [''],
            ['ุชูุงุตูู ุงูุญุฑูุงุช:'],
            ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุญุฑูุฉ', 'ุงููุฎุฒู', 'ุงููููุฉ', 'ุณุนุฑ ุงููุญุฏุฉ', 'ุฅุฌูุงูู ุงููููุฉ', 'ุงููุฑุฌุน', 'ุงูููุงุญุธุงุช']
        ];

        const typeText = {
            'in': 'ุฅุฏุฎุงู',
            'out': 'ุฅุฎุฑุงุฌ',
            'transfer': 'ุชุญููู',
            'adjustment': 'ุชุณููุฉ'
        };

        movements.forEach(movement => {
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
            const quantity = parseFloat(movement.quantity) || 0;
            const unitPrice = parseFloat(movement.unitPrice) || 0;
            const totalValue = quantity * unitPrice;

            data.push([
                movement.date,
                typeText[movement.movementType] || movement.movementType,
                warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู',
                quantity,
                unitPrice,
                totalValue,
                movement.reference || '',
                movement.notes || ''
            ]);
        });

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ุญุฑูุฉ ุงูุตูู');

        // ุชุตุฏูุฑ ุงูููู
        const fileName = `ุญุฑูุฉ_ุงูุตูู_${product.code}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุญุฑูุงุช ุงูุตูู ุฅูู Excel ุจูุฌุงุญ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุญุฑูุงุช ุงูุตูู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุจูุงูุงุช');
    }
}

/**
 * ุทุจุงุนุฉ ุญุฑูุงุช ุงูุตูู
 */
function printProductMovements(productId) {
    console.log(`๐จ๏ธ ุทุจุงุนุฉ ุญุฑูุงุช ุงูุตูู: ${productId}`);

    const product = appData.products.find(p => p.id === productId);
    if (!product) {
        alert('ุงูุตูู ุบูุฑ ููุฌูุฏ');
        return;
    }

    const movements = (appData.inventoryMovements || []).filter(m => m.productId === productId);
    movements.sort((a, b) => new Date(b.date) - new Date(a.date));

    // ุฅูุดุงุก ูุญุชูู ุงูุทุจุงุนุฉ
    const printContent = generateProductMovementsPrintHTML(product, movements);

    // ูุชุญ ูุงูุฐุฉ ุทุจุงุนุฉ
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุญุฑูุงุช ุงูุตูู
 */
function generateProductMovementsPrintHTML(product, movements) {
    const settings = appData.settings || {};
    const currentDate = formatDateTime(new Date());

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    let totalIn = 0, totalOut = 0, totalValue = 0;
    movements.forEach(movement => {
        const quantity = parseFloat(movement.quantity) || 0;
        const unitPrice = parseFloat(movement.unitPrice) || 0;

        if (movement.movementType === 'in') {
            totalIn += quantity;
        } else if (movement.movementType === 'out') {
            totalOut += quantity;
        }

        totalValue += quantity * unitPrice;
    });

    const typeText = {
        'in': 'ุฅุฏุฎุงู',
        'out': 'ุฅุฎุฑุงุฌ',
        'transfer': 'ุชุญููู',
        'adjustment': 'ุชุณููุฉ'
    };

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุฑูุฑ ุญุฑูุฉ ุงูุตูู - ${product.name}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                .company-info { margin-bottom: 20px; }
                .product-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                .stats { display: flex; justify-content: space-around; margin-bottom: 20px; }
                .stat-card { text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .text-success { color: #28a745; }
                .text-danger { color: #dc3545; }
                .text-info { color: #17a2b8; }
                .text-warning { color: #ffc107; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ุชูุฑูุฑ ุญุฑูุฉ ุงูุตูู ุงูููุตู</h1>
                <p><strong>${settings.companyName || 'ุงุณู ุงูุดุฑูุฉ'}</strong></p>
                <p>ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${currentDate}</p>
            </div>

            <div class="product-info">
                <h3>ูุนูููุงุช ุงูุตูู</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div><strong>ุงูููุฏ:</strong> ${product.code}</div>
                    <div><strong>ุงูุงุณู:</strong> ${product.name}</div>
                    <div><strong>ุงููุญุฏุฉ:</strong> ${product.unit}</div>
                    <div><strong>ุงููููุฉ ุงูุญุงููุฉ:</strong> ${product.quantity} ${product.unit}</div>
                    <div><strong>ุงูุญุฏ ุงูุฃุฏูู:</strong> ${product.minQuantity} ${product.unit}</div>
                    <div><strong>ุณุนุฑ ุงูุชูููุฉ:</strong> ${formatCurrency(product.costPrice)}</div>
                    <div><strong>ุณุนุฑ ุงูุจูุน:</strong> ${formatCurrency(product.sellingPrice)}</div>
                    <div><strong>ุนุฏุฏ ุงูุญุฑูุงุช:</strong> ${movements.length}</div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h4 class="text-success">ุฅุฌูุงูู ุงูุฅุฏุฎุงู</h4>
                    <p>${totalIn} ${product.unit}</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-danger">ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌ</h4>
                    <p>${totalOut} ${product.unit}</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-info">ุตุงูู ุงูุญุฑูุฉ</h4>
                    <p>${totalIn - totalOut} ${product.unit}</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-warning">ุฅุฌูุงูู ุงููููุฉ</h4>
                    <p>${formatCurrency(totalValue)}</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ููุน ุงูุญุฑูุฉ</th>
                        <th>ุงููุฎุฒู</th>
                        <th>ุงููููุฉ</th>
                        <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                        <th>ุฅุฌูุงูู ุงููููุฉ</th>
                        <th>ุงููุฑุฌุน</th>
                        <th>ุงูููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    ${movements.map(movement => {
                        const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
                        const quantity = parseFloat(movement.quantity) || 0;
                        const unitPrice = parseFloat(movement.unitPrice) || 0;
                        const totalValue = quantity * unitPrice;

                        return `
                            <tr>
                                <td>${movement.date}</td>
                                <td class="text-${movement.movementType === 'in' ? 'success' : 'danger'}">
                                    ${typeText[movement.movementType] || movement.movementType}
                                </td>
                                <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                                <td class="text-${movement.movementType === 'in' ? 'success' : 'danger'}">
                                    ${movement.movementType === 'in' ? '+' : '-'}${quantity}
                                </td>
                                <td>${formatCurrency(unitPrice)}</td>
                                <td>${formatCurrency(totalValue)}</td>
                                <td>${movement.reference || '-'}</td>
                                <td>${movement.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="footer">
                <p>ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ ${settings.companyName || 'ูุธุงู SAM PRO'} - ${currentDate}</p>
            </div>
        </body>
        </html>
    `;
}

function deleteProduct(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('products')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูุฃุตูุงู');
        return;
    }

    // ุงุณุชุฎุฏุงู ุงููุงูุฐุฉ ุงููุชูุฏูุฉ ูุญุฐู ุงูุตูู
    showProductDeletionDialog(id);
}

// ูุธุงุฆู ุงููุฎุงุฒู
function editWarehouse(id) {
    console.log('โ๏ธ ุชุนุฏูู ุงููุฎุฒู ID:', id);

    const warehouse = appData.warehouses.find(w => w.id === id);
    if (!warehouse) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุฎุฒู');
        return;
    }

    // ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงููุฎุฒู
    const warehouseProducts = appData.products.filter(p => p.warehouseId === id && p.isActive !== false);
    const totalProducts = warehouseProducts.length;
    const totalValue = warehouseProducts.reduce((sum, p) => sum + ((p.quantity || 0) * (p.costPrice || 0)), 0);
    const lowStockProducts = warehouseProducts.filter(p => (p.quantity || 0) <= (p.minQuantity || 0)).length;

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงููุฎุฒู ุงููุญุณูุฉ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editWarehouseModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-warehouse me-2"></i>
                        ุชุนุฏูู ุงููุฎุฒู: ${warehouse.name}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ุฅุญุตุงุฆูุงุช ุงููุฎุฒู -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-2x mb-2"></i>
                                    <h5>${totalProducts}</h5>
                                    <small>ุฅุฌูุงูู ุงูุฃุตูุงู</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                    <h6>${formatCurrency(totalValue)}</h6>
                                    <small>ูููุฉ ุงููุฎุฒูู</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                    <h5>${lowStockProducts}</h5>
                                    <small>ุฃุตูุงู ููุฎูุถุฉ</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar fa-2x mb-2"></i>
                                    <h6>${warehouse.createdAt || 'ุบูุฑ ูุญุฏุฏ'}</h6>
                                    <small>ุชุงุฑูุฎ ุงูุฅูุดุงุก</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ูููุฐุฌ ุงูุชุนุฏูู -->
                    <form id="editWarehouseForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงุณู ุงููุฎุฒู <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editWarehouseName" value="${warehouse.name}" required>
                                <div class="form-text">ูุฌุจ ุฃู ูููู ุงูุงุณู ูุฑูุฏุงู</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ููุฏ ุงููุฎุฒู</label>
                                <input type="text" class="form-control" id="editWarehouseCode" value="${warehouse.code || ''}" placeholder="ููุฏ ุงุฎุชูุงุฑู">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููููุน</label>
                                <input type="text" class="form-control" id="editWarehouseLocation" value="${warehouse.location || ''}" placeholder="ุนููุงู ุงููุฎุฒู">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููุฏููุฉ</label>
                                <input type="text" class="form-control" id="editWarehouseCity" value="${warehouse.city || ''}" placeholder="ุงููุฏููุฉ">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููุฏูุฑ</label>
                                <input type="text" class="form-control" id="editWarehouseManager" value="${warehouse.manager || ''}" placeholder="ุงุณู ูุฏูุฑ ุงููุฎุฒู">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุฑูู ุงููุงุชู</label>
                                <input type="tel" class="form-control" id="editWarehousePhone" value="${warehouse.phone || ''}" placeholder="ุฑูู ุงููุงุชู">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุณุนุฉ ุงููุตูู</label>
                                <input type="number" class="form-control" id="editWarehouseCapacity" value="${warehouse.maxCapacity || ''}" min="0" placeholder="ุนุฏุฏ ุงูุฃุตูุงู ุงููุตูู">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุญุงูุฉ</label>
                                <select class="form-select" id="editWarehouseStatus">
                                    <option value="true" ${warehouse.isActive !== false ? 'selected' : ''}>ูุดุท</option>
                                    <option value="false" ${warehouse.isActive === false ? 'selected' : ''}>ุบูุฑ ูุดุท</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editWarehouseNotes" rows="3" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ">${warehouse.notes || ''}</textarea>
                        </div>

                        <!-- ุชุญุฐูุฑ ุนูุฏ ุชุบููุฑ ุงูุญุงูุฉ -->
                        <div class="alert alert-warning" id="statusWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>ุชุญุฐูุฑ:</strong> ุชุนุทูู ุงููุฎุฒู ุณูุคุซุฑ ุนูู ุฌููุน ุงูุฃุตูุงู ุงููุฑุชุจุทุฉ ุจู (${totalProducts} ุตูู).
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ุฅูุบุงุก
                    </button>
                    <button type="button" class="btn btn-info" onclick="showWarehouseProductMovements(${id})">
                        <i class="fas fa-chart-line me-2"></i>ุญุฑูุฉ ุงูุฃุตูุงู
                    </button>
                    <button type="button" class="btn btn-primary" onclick="updateWarehouse(${id})">
                        <i class="fas fa-save me-2"></i>ุญูุธ ุงูุชุบููุฑุงุช
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุถุงูุฉ ูุณุชูุน ูุชุบููุฑ ุงูุญุงูุฉ
    document.getElementById('editWarehouseStatus').addEventListener('change', function() {
        const warning = document.getElementById('statusWarning');
        if (this.value === 'false' && totalProducts > 0) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    });

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function updateWarehouse(id) {
    console.log('๐พ ุชุญุฏูุซ ุจูุงูุงุช ุงููุฎุฒู ID:', id);

    const warehouse = appData.warehouses.find(w => w.id === id);
    if (!warehouse) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุฎุฒู');
        return;
    }

    // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ ุงููุญุณู
    const name = document.getElementById('editWarehouseName').value.trim();
    const code = document.getElementById('editWarehouseCode').value.trim();
    const location = document.getElementById('editWarehouseLocation').value.trim();
    const city = document.getElementById('editWarehouseCity').value.trim();
    const manager = document.getElementById('editWarehouseManager').value.trim();
    const phone = document.getElementById('editWarehousePhone').value.trim();
    const maxCapacity = parseInt(document.getElementById('editWarehouseCapacity').value) || null;
    const isActive = document.getElementById('editWarehouseStatus').value === 'true';
    const notes = document.getElementById('editWarehouseNotes').value.trim();

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุฎุฒู');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู (ุฅุฐุง ุชู ุชุบููุฑู)
    if (name !== warehouse.name) {
        const existingWarehouse = appData.warehouses.find(w => w.name === name && w.id !== id);
        if (existingWarehouse) {
            alert('ููุฌุฏ ูุฎุฒู ุขุฎุฑ ุจููุณ ุงูุงุณู');
            return;
        }
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูููุฏ (ุฅุฐุง ุชู ุฅุฏุฎุงูู)
    if (code && code !== warehouse.code) {
        const existingCode = appData.warehouses.find(w => w.code === code && w.id !== id);
        if (existingCode) {
            alert('ููุฌุฏ ูุฎุฒู ุขุฎุฑ ุจููุณ ุงูููุฏ');
            return;
        }
    }

    // ุงูุชุญูู ูู ุงูุณุนุฉ ุงููุตูู
    const currentProductsCount = appData.products.filter(p => p.warehouseId === id && p.isActive !== false).length;
    if (maxCapacity && maxCapacity < currentProductsCount) {
        if (!confirm(`ุงูุณุนุฉ ุงููุตูู ุงููุญุฏุฏุฉ (${maxCapacity}) ุฃูู ูู ุนุฏุฏ ุงูุฃุตูุงู ุงูุญุงููุฉ (${currentProductsCount}). ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`)) {
            return;
        }
    }

    // ุงูุชุญูู ูู ุชุฃุซูุฑ ุชุนุทูู ุงููุฎุฒู
    if (!isActive && warehouse.isActive !== false && currentProductsCount > 0) {
        if (!confirm(`ุชุนุทูู ูุฐุง ุงููุฎุฒู ุณูุคุซุฑ ุนูู ${currentProductsCount} ุตูู. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`)) {
            return;
        }
    }

    try {
        // ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ ููุชุฑุงุฌุน ูู ุญุงูุฉ ุงูุฎุทุฃ
        const oldData = { ...warehouse };

        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุฎุฒู
        warehouse.name = name;
        warehouse.code = code;
        warehouse.location = location;
        warehouse.city = city;
        warehouse.manager = manager;
        warehouse.phone = phone;
        warehouse.maxCapacity = maxCapacity;
        warehouse.isActive = isActive;
        warehouse.notes = notes;
        warehouse.updatedAt = new Date().toISOString();

        // ุฅุฐุง ุชู ุชุนุทูู ุงููุฎุฒูุ ุชุนุทูู ุฌููุน ุงูุฃุตูุงู ุงููุฑุชุจุทุฉ ุจู
        if (!isActive && oldData.isActive !== false) {
            const warehouseProducts = appData.products.filter(p => p.warehouseId === id);
            warehouseProducts.forEach(product => {
                product.isActive = false;
                product.updatedAt = new Date().toISOString();
            });

            console.log(`โ๏ธ ุชู ุชุนุทูู ${warehouseProducts.length} ุตูู ูุฑุชุจุท ุจุงููุฎุฒู`);
        }

        // ุฅุฐุง ุชู ุชูุนูู ุงููุฎุฒูุ ุชูุนูู ุฌููุน ุงูุฃุตูุงู ุงููุฑุชุจุทุฉ ุจู
        if (isActive && oldData.isActive === false) {
            const warehouseProducts = appData.products.filter(p => p.warehouseId === id);
            warehouseProducts.forEach(product => {
                product.isActive = true;
                product.updatedAt = new Date().toISOString();
            });

            console.log(`โ ุชู ุชูุนูู ${warehouseProducts.length} ุตูู ูุฑุชุจุท ุจุงููุฎุฒู`);
        }

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editWarehouseModal'));
        modal.hide();

        // ุฅุนุงุฏุฉ ุชุญููู ุตูุญุฉ ุงููุฎุงุฒู
        showPage('warehouses');

        alert('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุฎุฒู ุจูุฌุงุญ');
        console.log('โ ุชู ุชุญุฏูุซ ุงููุฎุฒู:', warehouse.name);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุฎุฒู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุฎุฒู: ' + error.message);
    }
}

function deleteWarehouse(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('warehouses')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงููุฎุงุฒู');
        return;
    }

    // ุงุณุชุฎุฏุงู ุงููุงูุฐุฉ ุงููุชูุฏูุฉ ูุญุฐู ุงููุฎุฒู
    showWarehouseDeletionDialog(id);
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุงููุฎุฒู
 */
function getWarehouseName(warehouseId) {
    const warehouse = appData.warehouses ? appData.warehouses.find(w => w.id === warehouseId) : null;
    return warehouse ? warehouse.name : 'ูุฎุฒู ุบูุฑ ูุญุฏุฏ';
}

/**
 * ุฅุนุงุฏุฉ ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ
 */
function recalculateInvoiceTotals(invoice) {
    if (!invoice || !invoice.items) return;

    // ุญุณุงุจ ุงููุฌููุน ุงููุฑุนู
    invoice.subtotal = invoice.items.reduce((sum, item) => sum + (item.totalAmount || 0), 0);

    // ุญุณุงุจ ุงูุฎุตู
    const discountAmount = invoice.subtotal * ((invoice.discountRate || 0) / 100);
    invoice.discountAmount = discountAmount;

    // ุญุณุงุจ ุงูุถุฑูุจุฉ
    const taxableAmount = invoice.subtotal - discountAmount;
    const taxAmount = taxableAmount * ((invoice.taxRate || 0) / 100);
    invoice.taxAmount = taxAmount;

    // ุงููุฌููุน ุงูููุงุฆู
    invoice.totalAmount = taxableAmount + taxAmount;
    invoice.remainingAmount = invoice.totalAmount - (invoice.paidAmount || 0);

    console.log(`๐ ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ ${invoice.invoiceNumber}:`, {
        subtotal: invoice.subtotal,
        discountAmount: invoice.discountAmount,
        taxAmount: invoice.taxAmount,
        totalAmount: invoice.totalAmount
    });
}

/**
 * ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
 */
function hasPermission(permission) {
    // ูู ุงููุณุฎุฉ ุงูุญุงููุฉุ ุฌููุน ุงููุณุชุฎุฏููู ูุฏููู ุฌููุน ุงูุตูุงุญูุงุช
    // ูููู ุชุทููุฑ ูุฐู ุงููุธููุฉ ูุงุญูุงู ูุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช
    return true;
}

/**
 * ููู ุตูู ุฅูู ูุฎุฒู ุขุฎุฑ
 */
function transferProductToWarehouse(productId, newWarehouseId) {
    const product = appData.products.find(p => p.id === productId);
    const newWarehouse = appData.warehouses.find(w => w.id === newWarehouseId);

    if (!product || !newWarehouse) {
        alert('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุตูู ุฃู ุงููุฎุฒู ุงููุทููุจ');
        return false;
    }

    const oldWarehouse = appData.warehouses.find(w => w.id === product.warehouseId);
    const oldWarehouseName = oldWarehouse ? oldWarehouse.name : 'ูุฎุฒู ุบูุฑ ูุญุฏุฏ';

    // ุชุญุฏูุซ ูุฎุฒู ุงูุตูู
    product.warehouseId = newWarehouseId;

    // ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู ููููู
    const transferMovement = {
        id: Date.now(),
        movementType: 'transfer',
        movementDate: new Date().toISOString().split('T')[0],
        productId: productId,
        warehouseId: newWarehouseId,
        fromWarehouseId: oldWarehouse ? oldWarehouse.id : null,
        quantity: product.quantity,
        unitCost: product.costPrice || 0,
        totalCost: (product.quantity || 0) * (product.costPrice || 0),
        referenceType: 'transfer',
        referenceNumber: `TRANS-${Date.now()}`,
        notes: `ููู ูู ${oldWarehouseName} ุฅูู ${newWarehouse.name}`,
        createdAt: new Date().toISOString()
    };

    if (!appData.inventoryMovements) {
        appData.inventoryMovements = [];
    }
    appData.inventoryMovements.push(transferMovement);

    console.log(`๐ฆ ุชู ููู ุงูุตูู "${product.name}" ูู "${oldWarehouseName}" ุฅูู "${newWarehouse.name}"`);
    return true;
}

/**
 * ุญุฐู ุขูู ููุตูู ูุน ุฎูุงุฑุงุช ูุชูุฏูุฉ
 */
function safeDeleteProduct(productId, options = {}) {
    const product = appData.products.find(p => p.id === productId);
    if (!product) return false;

    const {
        forceDelete = false,
        transferToWarehouse = null,
        removeFromInvoices = false,
        removeMovements = false
    } = options;

    try {
        // ุงูุชุญูู ูู ุงูุงุฑุชุจุงุทุงุช
        const relatedInvoices = appData.invoices ? appData.invoices.filter(inv =>
            inv.items && inv.items.some(item => item.productId === productId)
        ) : [];

        const relatedMovements = appData.inventoryMovements ?
            appData.inventoryMovements.filter(mov => mov.productId === productId) : [];

        if (!forceDelete && (relatedInvoices.length > 0 || relatedMovements.length > 0)) {
            return {
                success: false,
                message: 'ููุฌุฏ ุงุฑุชุจุงุทุงุช ูุน ุงูุตูู',
                relatedInvoices: relatedInvoices.length,
                relatedMovements: relatedMovements.length
            };
        }

        // ุฅุฒุงูุฉ ูู ุงูููุงุชูุฑ ุฅุฐุง ุทููุจ ุฐูู
        if (removeFromInvoices && relatedInvoices.length > 0) {
            relatedInvoices.forEach(invoice => {
                invoice.items = invoice.items.filter(item => item.productId !== productId);
                recalculateInvoiceTotals(invoice);
            });
        }

        // ุฅุฒุงูุฉ ุญุฑูุงุช ุงููุฎุฒูู ุฅุฐุง ุทููุจ ุฐูู
        if (removeMovements && relatedMovements.length > 0) {
            appData.inventoryMovements = appData.inventoryMovements.filter(mov => mov.productId !== productId);
        }

        // ุญุฐู ุงูุตูู
        appData.products = appData.products.filter(p => p.id !== productId);

        return {
            success: true,
            message: 'ุชู ุญุฐู ุงูุตูู ุจูุฌุงุญ',
            removedInvoiceItems: removeFromInvoices ? relatedInvoices.length : 0,
            removedMovements: removeMovements ? relatedMovements.length : 0
        };

    } catch (error) {
        console.error('ุฎุทุฃ ูู ุญุฐู ุงูุตูู:', error);
        return {
            success: false,
            message: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุตูู'
        };
    }
}

/**
 * ุญุฐู ุขูู ูููุฎุฒู ูุน ุฎูุงุฑุงุช ูุชูุฏูุฉ
 */
function safeDeleteWarehouse(warehouseId, options = {}) {
    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return { success: false, message: 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุฎุฒู' };

    // ุงูุชุญูู ูู ุฃูู ููุณ ุงููุฎุฒู ุงููุญูุฏ
    if (appData.warehouses.length <= 1) {
        return { success: false, message: 'ูุง ูููู ุญุฐู ุงููุฎุฒู ุงููุญูุฏ ูู ุงููุธุงู' };
    }

    const {
        transferToWarehouseId = null,
        forceDelete = false
    } = options;

    try {
        // ุงูุนุซูุฑ ุนูู ุงูุฃุตูุงู ูุงูุญุฑูุงุช ุงููุฑุชุจุทุฉ
        const relatedProducts = appData.products ? appData.products.filter(p => p.warehouseId === warehouseId) : [];
        const relatedMovements = appData.inventoryMovements ?
            appData.inventoryMovements.filter(mov => mov.warehouseId === warehouseId) : [];

        if (!forceDelete && relatedProducts.length > 0 && !transferToWarehouseId) {
            return {
                success: false,
                message: 'ููุฌุฏ ุฃุตูุงู ูุฑุชุจุทุฉ ุจุงููุฎุฒู',
                relatedProducts: relatedProducts.length,
                relatedMovements: relatedMovements.length
            };
        }

        // ููู ุงูุฃุตูุงู ุฅูู ูุฎุฒู ุขุฎุฑ
        if (relatedProducts.length > 0) {
            const targetWarehouseId = transferToWarehouseId || appData.warehouses.find(w => w.id !== warehouseId)?.id;

            if (!targetWarehouseId) {
                return { success: false, message: 'ูุง ููุฌุฏ ูุฎุฒู ุขุฎุฑ ูููู ุงูุฃุตูุงู ุฅููู' };
            }

            relatedProducts.forEach(product => {
                transferProductToWarehouse(product.id, targetWarehouseId);
            });
        }

        // ุชุญุฏูุซ ุญุฑูุงุช ุงููุฎุฒูู
        if (relatedMovements.length > 0) {
            const targetWarehouseId = transferToWarehouseId || appData.warehouses.find(w => w.id !== warehouseId)?.id;
            relatedMovements.forEach(movement => {
                movement.warehouseId = targetWarehouseId;
            });
        }

        // ุญุฐู ุงููุฎุฒู
        appData.warehouses = appData.warehouses.filter(w => w.id !== warehouseId);

        return {
            success: true,
            message: 'ุชู ุญุฐู ุงููุฎุฒู ุจูุฌุงุญ',
            transferredProducts: relatedProducts.length,
            updatedMovements: relatedMovements.length
        };

    } catch (error) {
        console.error('ุฎุทุฃ ูู ุญุฐู ุงููุฎุฒู:', error);
        return {
            success: false,
            message: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฎุฒู'
        };
    }
}

/**
 * ุงูุชุญูู ูู ุฅููุงููุฉ ุญุฐู ุงููุฎุฒู
 */
function canDeleteWarehouse(warehouseId) {
    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return { canDelete: false, reason: 'ุงููุฎุฒู ุบูุฑ ููุฌูุฏ' };

    if (appData.warehouses.length <= 1) {
        return { canDelete: false, reason: 'ูุง ูููู ุญุฐู ุงููุฎุฒู ุงููุญูุฏ' };
    }

    const relatedProducts = appData.products ? appData.products.filter(p => p.warehouseId === warehouseId) : [];
    const relatedMovements = appData.inventoryMovements ?
        appData.inventoryMovements.filter(mov => mov.warehouseId === warehouseId) : [];

    return {
        canDelete: true,
        hasRelatedData: relatedProducts.length > 0 || relatedMovements.length > 0,
        relatedProducts: relatedProducts.length,
        relatedMovements: relatedMovements.length,
        alternativeWarehouses: appData.warehouses.filter(w => w.id !== warehouseId)
    };
}

/**
 * ุงูุชุญูู ูู ุฅููุงููุฉ ุญุฐู ุงูุตูู
 */
function canDeleteProduct(productId) {
    const product = appData.products.find(p => p.id === productId);
    if (!product) return { canDelete: false, reason: 'ุงูุตูู ุบูุฑ ููุฌูุฏ' };

    const relatedInvoices = appData.invoices ? appData.invoices.filter(inv =>
        inv.items && inv.items.some(item => item.productId === productId)
    ) : [];

    const relatedMovements = appData.inventoryMovements ?
        appData.inventoryMovements.filter(mov => mov.productId === productId) : [];

    return {
        canDelete: true,
        hasRelatedData: relatedInvoices.length > 0 || relatedMovements.length > 0,
        relatedInvoices: relatedInvoices.length,
        relatedMovements: relatedMovements.length,
        invoiceNumbers: relatedInvoices.map(inv => inv.invoiceNumber)
    };
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ุญุฐู ุงููุฎุฒู ูุน ุฎูุงุฑุงุช ูุชูุฏูุฉ
 */
function showWarehouseDeletionDialog(warehouseId) {
    const checkResult = canDeleteWarehouse(warehouseId);

    if (!checkResult.canDelete) {
        alert(`โ ${checkResult.reason}`);
        return;
    }

    const warehouse = appData.warehouses.find(w => w.id === warehouseId);

    if (!checkResult.hasRelatedData) {
        // ุญุฐู ูุจุงุดุฑ ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช ูุฑุชุจุทุฉ
        if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุฎุฒู "${warehouse.name}"ุ`)) {
            const result = safeDeleteWarehouse(warehouseId, { forceDelete: true });
            if (result.success) {
                saveData();
                showPage('warehouses');
                alert(result.message);
            } else {
                alert(`โ ${result.message}`);
            }
        }
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุญุฐู ูุชูุฏูุฉ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'deleteWarehouseModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ุญุฐู ุงููุฎุฒู: ${warehouse.name}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ููุฌุฏ ุจูุงูุงุช ูุฑุชุจุทุฉ ุจูุฐุง ุงููุฎุฒู
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                                    <h6>ุงูุฃุตูุงู ุงููุฑุชุจุทุฉ</h6>
                                    <span class="badge bg-primary fs-6">${checkResult.relatedProducts}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-exchange-alt fa-2x text-info mb-2"></i>
                                    <h6>ุญุฑูุงุช ุงููุฎุฒูู</h6>
                                    <span class="badge bg-info fs-6">${checkResult.relatedMovements}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-warehouse me-2"></i>
                            ููู ุงูุจูุงูุงุช ุฅูู ุงููุฎุฒู:
                        </label>
                        <select class="form-select" id="targetWarehouseSelect">
                            <option value="">ุงุฎุชุฑ ุงููุฎุฒู ุงููุณุชูุฏู</option>
                            ${checkResult.alternativeWarehouses.map(w =>
                                `<option value="${w.id}">${w.name} - ${w.location || 'ุจุฏูู ูููุน'}</option>`
                            ).join('')}
                        </select>
                        <div class="form-text">
                            ุณูุชู ููู ุฌููุน ุงูุฃุตูุงู ูุญุฑูุงุช ุงููุฎุฒูู ุฅูู ุงููุฎุฒู ุงููุญุฏุฏ
                        </div>
                    </div>

                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ุฅูุบุงุก
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeWarehouseDeletion(${warehouseId})">
                        <i class="fas fa-trash me-2"></i>ุญุฐู ุงููุฎุฒู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชูููุฐ ุญุฐู ุงููุฎุฒู
 */
function executeWarehouseDeletion(warehouseId) {
    const targetWarehouseId = document.getElementById('targetWarehouseSelect')?.value;

    if (!targetWarehouseId) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฎุฒู ุงููุณุชูุฏู ูููู ุงูุจูุงูุงุช');
        return;
    }

    const result = safeDeleteWarehouse(warehouseId, {
        transferToWarehouseId: parseInt(targetWarehouseId),
        forceDelete: true
    });

    if (result.success) {
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteWarehouseModal'));
        modal.hide();

        // ุชุญุฏูุซ ุงูุตูุญุฉ
        showPage('warehouses');

        // ุฑุณุงูุฉ ูุฌุงุญ
        alert(`โ ${result.message}

๐ ุชู ุชูููุฐ:
- ููู ${result.transferredProducts} ุตูู
- ุชุญุฏูุซ ${result.updatedMovements} ุญุฑูุฉ ูุฎุฒูู`);
    } else {
        alert(`โ ${result.message}`);
    }
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ุญุฐู ุงูุตูู ูุน ุฎูุงุฑุงุช ูุชูุฏูุฉ
 */
function showProductDeletionDialog(productId) {
    const checkResult = canDeleteProduct(productId);

    if (!checkResult.canDelete) {
        alert(`โ ${checkResult.reason}`);
        return;
    }

    const product = appData.products.find(p => p.id === productId);

    if (!checkResult.hasRelatedData) {
        // ุญุฐู ูุจุงุดุฑ ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช ูุฑุชุจุทุฉ
        if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุตูู "${product.name}"ุ`)) {
            const result = safeDeleteProduct(productId, { forceDelete: true });
            if (result.success) {
                saveData();
                showPage('products');
                alert(result.message);
            } else {
                alert(`โ ${result.message}`);
            }
        }
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุญุฐู ูุชูุฏูุฉ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'deleteProductModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ุญุฐู ุงูุตูู: ${product.name}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ููุฌุฏ ุจูุงูุงุช ูุฑุชุจุทุฉ ุจูุฐุง ุงูุตูู
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-invoice fa-2x text-primary mb-2"></i>
                                    <h6>ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ</h6>
                                    <span class="badge bg-primary fs-6">${checkResult.relatedInvoices}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-exchange-alt fa-2x text-info mb-2"></i>
                                    <h6>ุญุฑูุงุช ุงููุฎุฒูู</h6>
                                    <span class="badge bg-info fs-6">${checkResult.relatedMovements}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${checkResult.relatedInvoices > 0 ? `
                    <div class="mb-3">
                        <h6><i class="fas fa-file-invoice me-2"></i>ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ:</h6>
                        <div class="alert alert-info">
                            ${checkResult.invoiceNumbers.slice(0, 5).join(', ')}
                            ${checkResult.invoiceNumbers.length > 5 ? ` ู ${checkResult.invoiceNumbers.length - 5} ูุงุชูุฑุฉ ุฃุฎุฑู` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="removeFromInvoices">
                            <label class="form-check-label" for="removeFromInvoices">
                                <i class="fas fa-trash-alt me-2 text-danger"></i>
                                ุฅุฒุงูุฉ ุงูุตูู ูู ุฌููุน ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ
                            </label>
                            <div class="form-text text-danger">
                                ุชุญุฐูุฑ: ุณูุคุซุฑ ูุฐุง ุนูู ุฏูุฉ ุงูููุงุชูุฑ ูุฅุฌูุงููุงุชูุง
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="removeMovements">
                            <label class="form-check-label" for="removeMovements">
                                <i class="fas fa-trash-alt me-2 text-danger"></i>
                                ุญุฐู ุฌููุน ุญุฑูุงุช ุงููุฎุฒูู ุงููุฑุชุจุทุฉ
                            </label>
                            <div class="form-text text-danger">
                                ุชุญุฐูุฑ: ุณูุคุซุฑ ูุฐุง ุนูู ุชุงุฑูุฎ ุญุฑูุฉ ุงููุฎุฒูู
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ุฅูุบุงุก
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeProductDeletion(${productId})">
                        <i class="fas fa-trash me-2"></i>ุญุฐู ุงูุตูู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชูููุฐ ุญุฐู ุงูุตูู
 */
function executeProductDeletion(productId) {
    const removeFromInvoices = document.getElementById('removeFromInvoices')?.checked || false;
    const removeMovements = document.getElementById('removeMovements')?.checked || false;

    const result = safeDeleteProduct(productId, {
        forceDelete: true,
        removeFromInvoices: removeFromInvoices,
        removeMovements: removeMovements
    });

    if (result.success) {
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteProductModal'));
        modal.hide();

        // ุชุญุฏูุซ ุงูุตูุญุฉ
        showPage('products');

        // ุฑุณุงูุฉ ูุฌุงุญ
        alert(`โ ${result.message}

๐ ุชู ุชูููุฐ:
- ุญุฐู ุงูุตูู ูู ุงููุธุงู
- ุฅุฒุงูุฉ ${result.removedInvoiceItems} ุนูุตุฑ ูู ุงูููุงุชูุฑ
- ุญุฐู ${result.removedMovements} ุญุฑูุฉ ูุฎุฒูู`);
    } else {
        alert(`โ ${result.message}`);
    }
}

// ูุธููุฉ ุญุฐู ุงููุงุชูุฑุฉ
function deleteInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) return;

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุงุชูุฑุฉ "${invoice.invoiceNumber}"ุ`)) {
        // ุงูุชุญูู ูู ูุฌูุฏ ุฏูุนุงุช ูุฑุชุจุทุฉ
        const hasPayments = appData.payments.some(pay => pay.invoiceId === id);
        if (hasPayments) {
            alert('ูุง ูููู ุญุฐู ุงููุงุชูุฑุฉ ููุฌูุฏ ุฏูุนุงุช ูุฑุชุจุทุฉ ุจูุง');
            return;
        }

        // ุงูุชุญูู ูู ุญุงูุฉ ุงููุงุชูุฑุฉ
        if (invoice.status === 'confirmed') {
            if (!confirm('ูุฐู ุงููุงุชูุฑุฉ ูุคูุฏุฉ. ุญุฐููุง ุณูุคุซุฑ ุนูู ุงููุฎุฒูู ูุงูุญุณุงุจุงุช. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ')) {
                return;
            }
        }

        appData.invoices = appData.invoices.filter(inv => inv.id !== id);
        saveData();

        // ุชุญุฏูุซ ุงูุตูุญุฉ ุงูููุงุณุจุฉ
        if (invoice.invoiceType === 'sale') {
            showPage('sales-invoices');
        } else {
            showPage('purchase-invoices');
        }

        alert('ุชู ุญุฐู ุงููุงุชูุฑุฉ ุจูุฌุงุญ');
    }
}

// ูุธุงุฆู ุงูููุงุชูุฑ
function createInvoice(event) {
    if (event) {
        event.preventDefault();
    }
    console.log('๐ ูุญุงููุฉ ุญูุธ ุงููุงุชูุฑุฉ ููุคูุฏุฉ...');

    return saveInvoiceSimple('confirmed');
}

/**
 * ุญูุธ ุงููุงุชูุฑุฉ - ูุณุฎุฉ ูุจุณุทุฉ ููุนุงูุฉ
 */
function saveInvoiceSimple(status = 'draft') {
    console.log('๐ ุจุฏุก ุญูุธ ุงููุงุชูุฑุฉ ุงููุจุณุท...', { status });

    try {
        // ุฌูุน ุงูุจูุงูุงุช ูุจุงุดุฑุฉ
        const invoiceType = document.getElementById('invoiceType')?.value;
        const clientId = parseInt(document.getElementById('clientSelect')?.value);
        const invoiceDate = document.getElementById('invoiceDate')?.value;
        const dueDate = document.getElementById('dueDate')?.value || '';
        const notes = document.getElementById('invoiceNotes')?.value || '';

        console.log('๐ ุงูุจูุงูุงุช ุงููุฌูุนุฉ:', { invoiceType, clientId, invoiceDate, dueDate, notes });

        // ุงูุชุญูู ุงูุณุฑูุน
        if (!invoiceType) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงููุงุชูุฑุฉ');
            return false;
        }

        if (!clientId || isNaN(clientId)) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ' + (invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'));
            return false;
        }

        if (!invoiceDate) {
            alert('ูุฑุฌู ุชุญุฏูุฏ ุชุงุฑูุฎ ุงููุงุชูุฑุฉ');
            return false;
        }

        // ุฌูุน ุงูุนูุงุตุฑ
        const items = [];
        const itemRows = document.querySelectorAll('#invoiceItemsTable tr');

        console.log('๐ฆ ุนุฏุฏ ุงูุนูุงุตุฑ:', itemRows.length);

        if (itemRows.length === 0) {
            alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุตุฑ ูุงุญุฏ ุนูู ุงูุฃูู ูููุงุชูุฑุฉ');
            return false;
        }

        let hasValidItems = false;
        itemRows.forEach((row, index) => {
            const productSelect = row.querySelector('.item-product');
            const quantityInput = row.querySelector('.item-quantity');
            const priceInput = row.querySelector('.item-price');
            const discountInput = row.querySelector('.item-discount');

            console.log(`๐ ูุญุต ุงูุตู ${index + 1}:`, {
                productSelect: productSelect ? `ููุฌูุฏ (${productSelect.value})` : 'ููููุฏ',
                quantityInput: quantityInput ? `ููุฌูุฏ (${quantityInput.value})` : 'ููููุฏ',
                priceInput: priceInput ? `ููุฌูุฏ (${priceInput.value})` : 'ููููุฏ',
                discountInput: discountInput ? `ููุฌูุฏ (${discountInput.value})` : 'ููููุฏ'
            });

            if (productSelect && quantityInput && priceInput) {
                const productId = parseInt(productSelect.value);
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitPrice = parseFloat(priceInput.value) || 0;
                const discount = parseFloat(discountInput?.value) || 0;

                console.log(`๐ ููู ุงูุตู ${index + 1}:`, { productId, quantity, unitPrice, discount });

                if (productId && !isNaN(productId) && quantity > 0 && unitPrice >= 0) {
                    const subtotal = quantity * unitPrice;
                    const discountAmount = subtotal * (discount / 100);
                    const totalAmount = subtotal - discountAmount;

                    items.push({
                        productId: productId,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        discount: discount,
                        totalAmount: totalAmount
                    });
                    hasValidItems = true;
                    console.log(`โ ุนูุตุฑ ${index + 1} ูุถุงู ุจูุฌุงุญ:`, { productId, quantity, unitPrice, discount, totalAmount });
                } else {
                    console.warn(`โ๏ธ ุนูุตุฑ ุบูุฑ ุตุญูุญ ูู ุงูุตู ${index + 1}:`, { productId, quantity, unitPrice, discount });
                }
            } else {
                console.warn(`โ๏ธ ุนูุงุตุฑ ููููุฏุฉ ูู ุงูุตู ${index + 1}`);
            }
        });

        if (!hasValidItems) {
            alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุงุตุฑ ุตุญูุญุฉ ูููุงุชูุฑุฉ');
            return false;
        }

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const subtotal = items.reduce((sum, item) => sum + item.totalAmount, 0);
        const discountRate = parseFloat(document.getElementById('discountPercentage')?.value) || 0;
        const taxRate = parseFloat(document.getElementById('taxPercentage')?.value) || 0;

        const discountAmount = subtotal * (discountRate / 100);
        const taxAmount = (subtotal - discountAmount) * (taxRate / 100);
        const totalAmount = subtotal - discountAmount + taxAmount;

        console.log('๐ฐ ุงูุฅุฌูุงููุงุช:', { subtotal, discountAmount, taxAmount, totalAmount });

        // ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ
        const invoiceNumber = generateInvoiceNumber(invoiceType);
        console.log('๐ข ุฑูู ุงููุงุชูุฑุฉ:', invoiceNumber);

        // ุฅูุดุงุก ุงููุงุชูุฑุฉ
        const newInvoice = {
            id: Date.now(),
            invoiceNumber: invoiceNumber,
            invoiceType: invoiceType,
            customerId: invoiceType === 'sale' ? clientId : null,
            supplierId: invoiceType === 'purchase' ? clientId : null,
            invoiceDate: invoiceDate,
            dueDate: dueDate,
            items: items,
            subtotal: subtotal,
            discountRate: discountRate,
            discountAmount: discountAmount,
            taxRate: taxRate,
            taxAmount: taxAmount,
            totalAmount: totalAmount,
            paidAmount: 0,
            remainingAmount: totalAmount,
            status: status,
            notes: notes,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        console.log('๐ ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ:', newInvoice);

        // ุชููุฆุฉ ุงูุจูุงูุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ
        if (!appData.invoices) {
            appData.invoices = [];
        }
        if (!appData.settings.nextInvoiceNumber) {
            appData.settings.nextInvoiceNumber = { sale: 1, purchase: 1 };
        }

        // ุญูุธ ุงููุงุชูุฑุฉ
        appData.invoices.push(newInvoice);
        appData.settings.nextInvoiceNumber[invoiceType]++;

        // ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุนููุงุก/ุงูููุฑุฏูู ุนูุฏ ุชุฃููุฏ ุงููุงุชูุฑุฉ
        if (status === 'confirmed') {
            updateBalancesForInvoice(newInvoice);
        }

        console.log('๐พ ุญูุธ ุงูุจูุงูุงุช...');
        saveData();

        // ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุนุฑุถ ุฑูุฒ ุงูุนููุฉ ุจูุถูุญ
        const invoiceCurrency = document.getElementById('invoiceCurrency')?.value || 'SYP';
        const currencySymbol = getCurrencySymbol(invoiceCurrency);
        const currencyName = getCurrencyName(invoiceCurrency);
        const successMessage = `โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ!

๐ ุฑูู ุงููุงุชูุฑุฉ: ${invoiceNumber}
๐ฐ ุงููุจูุบ ุงูุฅุฌูุงูู: ${formatCurrency(totalAmount, invoiceCurrency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ ุนุฏุฏ ุงูุนูุงุตุฑ: ${items.length}
๐ท๏ธ ุงูุญุงูุฉ: ${status === 'confirmed' ? 'ูุคูุฏุฉ' : 'ูุณูุฏุฉ'}

ูู ุชุฑูุฏ ุทุจุงุนุฉ ุงููุงุชูุฑุฉุ`;

        console.log('๐ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ!');

        if (confirm(successMessage)) {
            // ูููู ุฅุถุงูุฉ ูุธููุฉ ุงูุทุจุงุนุฉ ููุง
            alert('ูุธููุฉ ุงูุทุจุงุนุฉ ุณุชุชู ุฅุถุงูุชูุง ูุงุญูุงู');
        }

        // ุงูุนูุฏุฉ ููุงุฆูุฉ ุงูููุงุชูุฑ
        showPage(invoiceType === 'sale' ? 'sales-invoices' : 'purchase-invoices');

        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุงุชูุฑุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ: ' + error.message);
        return false;
    }
}

/**
 * ุญู ูุดููุฉ ุญูุธ ุงูููุงุชูุฑ - ูุธููุฉ ูุจุงุดุฑุฉ
 */
function fixInvoiceSaving() {
    console.log('๐ง ุญู ูุดููุฉ ุญูุธ ุงูููุงุชูุฑ...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData.customers || appData.customers.length === 0 || !appData.products || appData.products.length === 0) {
        console.log('๐ ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ...');
        createSampleData();

        // ุงูุชุธุงุฑ ูููู ุซู ููุก ุงููููุฐุฌ
        setTimeout(() => {
            fillFormAutomatically();
        }, 500);
        return;
    }

    fillFormAutomatically();
}

/**
 * ููุก ุงููููุฐุฌ ุชููุงุฆูุงู ููุงุฎุชุจุงุฑ
 */
function fillFormAutomatically() {
    console.log('๐ ููุก ุงููููุฐุฌ ุชููุงุฆูุงู...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ูู ุงููููุฐุฌ
    const invoiceType = document.getElementById('invoiceType');
    const clientSelect = document.getElementById('clientSelect');
    const invoiceDate = document.getElementById('invoiceDate');
    const itemsTable = document.getElementById('invoiceItemsTable');

    if (!invoiceType || !clientSelect || !invoiceDate || !itemsTable) {
        alert('ูุฑุฌู ุงูุฐูุงุจ ูุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุฃููุงู');
        showPage('create-invoice');
        return;
    }

    // ููุก ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!invoiceType.value) {
        invoiceType.value = 'sale';
        updateClientOptions();
        console.log('โ ุชู ุชุญุฏูุฏ ููุน ุงููุงุชูุฑุฉ: ูุจูุนุงุช');
    }

    // ุงูุชุธุงุฑ ูููู ูุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก
    setTimeout(() => {
        if (!clientSelect.value && appData.customers.length > 0) {
            clientSelect.value = appData.customers[0].id;
            console.log('โ ุชู ุงุฎุชูุงุฑ ุงูุนููู:', appData.customers[0].name);
        }

        if (!invoiceDate.value) {
            invoiceDate.value = new Date().toISOString().split('T')[0];
            console.log('โ ุชู ุชุญุฏูุฏ ุงูุชุงุฑูุฎ');
        }

        // ุฅุถุงูุฉ ุนูุตุฑ ุชุฌุฑูุจู ุฅุฐุง ูู ุชูุฌุฏ ุนูุงุตุฑ
        if (itemsTable.children.length === 0 && appData.products.length > 0) {
            addInvoiceItem();
            console.log('โ ุชู ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ');

            // ููุก ุงูุนูุตุฑ ุงูุฃูู ุชููุงุฆูุงู
            setTimeout(() => {
                const firstRow = itemsTable.querySelector('tr');
                if (firstRow) {
                    const productSelect = firstRow.querySelector('.item-product');
                    const quantityInput = firstRow.querySelector('.item-quantity');
                    const priceInput = firstRow.querySelector('.item-price');

                    console.log('๐ ุนูุงุตุฑ ุงูุตู ุงูุฃูู:', {
                        productSelect: productSelect ? 'ููุฌูุฏ' : 'ููููุฏ',
                        quantityInput: quantityInput ? 'ููุฌูุฏ' : 'ููููุฏ',
                        priceInput: priceInput ? 'ููุฌูุฏ' : 'ููููุฏ'
                    });

                    if (productSelect && appData.products.length > 0) {
                        productSelect.value = appData.products[0].id;
                        console.log('โ ุชู ุงุฎุชูุงุฑ ุงูุตูู:', appData.products[0].name);

                        // ุชุญุฏูุซ ุงูุณุนุฑ ุชููุงุฆูุงู
                        if (priceInput) {
                            priceInput.value = appData.products[0].sellingPrice || 100;
                            console.log('โ ุชู ุชุญุฏูุฏ ุงูุณุนุฑ:', priceInput.value);
                        }
                    }

                    if (quantityInput) {
                        quantityInput.value = 1;
                        console.log('โ ุชู ุชุญุฏูุฏ ุงููููุฉ: 1');
                    }

                    // ุญุณุงุจ ุงููุฌููุน
                    calculateInvoiceTotals();
                }
            }, 200);
        }

        console.log('โ ุชู ุฅุนุฏุงุฏ ุงููููุฐุฌ ููุงุฎุชุจุงุฑ');
        alert('ุชู ุฅุนุฏุงุฏ ุงููููุฐุฌ ุชููุงุฆูุงู!\n\nโ ููุน ุงููุงุชูุฑุฉ: ูุจูุนุงุช\nโ ุงูุนููู: ' + (appData.customers[0]?.name || 'ุบูุฑ ูุญุฏุฏ') + '\nโ ุงูุตูู: ' + (appData.products[0]?.name || 'ุบูุฑ ูุญุฏุฏ') + '\nโ ุงููููุฉ: 1\n\nููููู ุงูุขู ุงูุถุบุท ุนูู "ุญูุธ ูุชุฃููุฏ" ูุงุฎุชุจุงุฑ ุญูุธ ุงููุงุชูุฑุฉ.');

    }, 300);
}

/**
 * ุญูุธ ุงููุงุชูุฑุฉ ููุณูุฏุฉ
 */
function saveInvoiceAsDraft() {
    console.log('๐ ูุญุงููุฉ ุญูุธ ุงููุงุชูุฑุฉ ููุณูุฏุฉ...');
    return saveInvoiceSimple('draft');
}

/**
 * ุญูุธ ุงููุงุชูุฑุฉ
 */
function saveInvoice(status = 'draft') {
    console.log('๐ ุจุฏุก ุนูููุฉ ุญูุธ ุงููุงุชูุฑุฉ...', { status });

    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ
        console.log('๐ ุงูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ุงููููุฐุฌ...');

        const invoiceTypeElement = document.getElementById('invoiceType');
        const clientElement = document.getElementById('clientSelect');
        const dateElement = document.getElementById('invoiceDate');
        const dueDateElement = document.getElementById('dueDate');
        const notesElement = document.getElementById('invoiceNotes');

        console.log('๐ ุนูุงุตุฑ ุงููููุฐุฌ:', {
            invoiceType: invoiceTypeElement ? 'ููุฌูุฏ' : 'ููููุฏ',
            clientSelect: clientElement ? 'ููุฌูุฏ' : 'ููููุฏ',
            invoiceDate: dateElement ? 'ููุฌูุฏ' : 'ููููุฏ',
            dueDate: dueDateElement ? 'ููุฌูุฏ' : 'ููููุฏ',
            notes: notesElement ? 'ููุฌูุฏ' : 'ููููุฏ'
        });

        if (!invoiceTypeElement || !clientElement || !dateElement) {
            console.error('โ ุนูุงุตุฑ ุงููููุฐุฌ ุบูุฑ ููุฌูุฏุฉ');
            alert('ุฎุทุฃ: ุนูุงุตุฑ ุงููููุฐุฌ ุบูุฑ ููุฌูุฏุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return false;
        }

        const invoiceType = invoiceTypeElement.value;
        const clientId = parseInt(clientElement.value);
        const invoiceDate = dateElement.value;
        const dueDate = dueDateElement ? dueDateElement.value : '';
        const notes = notesElement ? notesElement.value.trim() : '';

        console.log('๐ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงููุณุชุฎุฑุฌุฉ:', { invoiceType, clientId, invoiceDate, dueDate, notes });

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (!invoiceType) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงููุงุชูุฑุฉ');
            return false;
        }

        if (!clientId || isNaN(clientId)) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ' + (invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'));
            return false;
        }

        if (!invoiceDate) {
            alert('ูุฑุฌู ุชุญุฏูุฏ ุชุงุฑูุฎ ุงููุงุชูุฑุฉ');
            return false;
        }

        // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ
        console.log('๐ฆ ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ...');
        const items = [];
        const itemRows = document.querySelectorAll('#invoiceItemsTable tr');

        console.log('๐ ุนุฏุฏ ุตููู ุงูุนูุงุตุฑ:', itemRows.length);
        console.log('๐ ุฌุฏูู ุงูุนูุงุตุฑ ููุฌูุฏ:', document.getElementById('invoiceItemsTable') ? 'ูุนู' : 'ูุง');

        if (itemRows.length === 0) {
            console.warn('โ๏ธ ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงููุงุชูุฑุฉ');
            alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุตุฑ ูุงุญุฏ ุนูู ุงูุฃูู ูููุงุชูุฑุฉ\n\nุงุถุบุท ุนูู ุฒุฑ "ุฅุถุงูุฉ ุตูู" ูุฅุถุงูุฉ ุนูุงุตุฑ ูููุงุชูุฑุฉ');
            return false;
        }

        let hasValidItems = false;
        itemRows.forEach((row, index) => {
            console.log(`๐ ูุญุต ุงูุตู ${index + 1}...`);

            const productSelect = row.querySelector('.item-product');
            const specificationsInput = row.querySelector('.item-specifications');
            const quantityInput = row.querySelector('.item-quantity');
            const priceInput = row.querySelector('.item-price');

            console.log(`๐ ุนูุงุตุฑ ุงูุตู ${index + 1}:`, {
                productSelect: productSelect ? `ููุฌูุฏ (${productSelect.value})` : 'ููููุฏ',
                specificationsInput: specificationsInput ? `ููุฌูุฏ (${specificationsInput.value})` : 'ููููุฏ',
                quantityInput: quantityInput ? `ููุฌูุฏ (${quantityInput.value})` : 'ููููุฏ',
                priceInput: priceInput ? `ููุฌูุฏ (${priceInput.value})` : 'ููููุฏ'
            });

            if (productSelect && quantityInput && priceInput) {
                const productId = parseInt(productSelect.value);
                const specifications = specificationsInput ? specificationsInput.value.trim() : '';
                const quantity = parseFloat(quantityInput.value);
                const unitPrice = parseFloat(priceInput.value);

                console.log(`๐ ููู ุงูุตู ${index + 1}:`, { productId, specifications, quantity, unitPrice });

                if (productId && !isNaN(productId) && quantity > 0 && unitPrice >= 0) {
                    const discountInput = row.querySelector('.item-discount');
                    const discount = discountInput ? parseFloat(discountInput.value) || 0 : 0;
                    const subtotal = quantity * unitPrice;
                    const discountAmount = subtotal * (discount / 100);
                    const totalAmount = subtotal - discountAmount;

                    items.push({
                        productId: productId,
                        specifications: specifications,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        discount: discount,
                        totalAmount: totalAmount
                    });
                    hasValidItems = true;
                    console.log(`โ ุนูุตุฑ ุตุญูุญ ูุถุงู:`, { productId, specifications, quantity, unitPrice, discount, totalAmount });
                } else {
                    console.warn(`โ๏ธ ุนูุตุฑ ุบูุฑ ุตุญูุญ ูู ุงูุตู ${index + 1}:`, { productId, specifications, quantity, unitPrice });
                }
            } else {
                console.warn(`โ๏ธ ุนูุงุตุฑ ููููุฏุฉ ูู ุงูุตู ${index + 1}`);
            }
        });

        if (!hasValidItems) {
            console.error('โ ูุง ุชูุฌุฏ ุนูุงุตุฑ ุตุญูุญุฉ ูู ุงููุงุชูุฑุฉ');
            alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุงุตุฑ ุตุญูุญุฉ ูููุงุชูุฑุฉ:\n\n1. ุงุฎุชุฑ ุงูุตูู\n2. ุฃุฏุฎู ุงููููุฉ (ุฃูุจุฑ ูู 0)\n3. ุฃุฏุฎู ุงูุณุนุฑ (0 ุฃู ุฃูุจุฑ)');
            return false;
        }

        console.log('โ ุงูุนูุงุตุฑ ุงููุฌูุนุฉ:', items);

        // ุงูุชุญูู ูู ุชููุฑ ุงููููุฉ ูู ุญุงูุฉ ูุงุชูุฑุฉ ุงููุจูุนุงุช
        if (invoiceType === 'sale' && status === 'confirmed') {
            for (let item of items) {
                const product = appData.products.find(p => p.id === item.productId);
                if (product && product.quantity < item.quantity) {
                    alert(`ุงููููุฉ ุงููุชุงุญุฉ ูู ${product.name}: ${product.quantity} ${product.unit}`);
                    return false;
                }
            }
        }

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        console.log('๐ฐ ุญุณุงุจ ุงูุฅุฌูุงููุงุช...');
        const subtotal = items.reduce((sum, item) => sum + item.totalAmount, 0);
        const discountRateElement = document.getElementById('discountPercentage');
        const taxRateElement = document.getElementById('taxPercentage');

        const discountRate = discountRateElement ? parseFloat(discountRateElement.value) || 0 : 0;
        const discountAmount = subtotal * (discountRate / 100);
        const taxRate = taxRateElement ? parseFloat(taxRateElement.value) || 0 : appData.settings.taxRate || 0;
        const taxAmount = (subtotal - discountAmount) * (taxRate / 100);
        const totalAmount = subtotal - discountAmount + taxAmount;

        console.log('๐ฐ ุงูุญุณุงุจุงุช:', { subtotal, discountRate, discountAmount, taxRate, taxAmount, totalAmount });

        // ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ
        console.log('๐ข ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ...');
        const invoiceNumber = generateInvoiceNumber(invoiceType);
        console.log('โ ุฑูู ุงููุงุชูุฑุฉ ุงููููุฏ:', invoiceNumber);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑูู
        if (!invoiceNumber) {
            console.error('โ ูุดู ูู ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ');
            alert('ุฎุทุฃ: ูุดู ูู ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            return false;
        }

        // ุฅูุดุงุก ุงููุงุชูุฑุฉ
        console.log('๐ ุฅูุดุงุก ูุงุฆู ุงููุงุชูุฑุฉ...');
        const newInvoice = {
            id: Date.now(),
            invoiceNumber: invoiceNumber,
            invoiceType: invoiceType,
            customerId: invoiceType === 'sale' ? clientId : null,
            supplierId: invoiceType === 'purchase' ? clientId : null,
            invoiceDate: invoiceDate,
            dueDate: dueDate,
            items: items,
            subtotal: subtotal,
            discountRate: discountRate,
            discountAmount: discountAmount,
            taxRate: taxRate,
            taxAmount: taxAmount,
            totalAmount: totalAmount,
            paidAmount: 0,
            remainingAmount: totalAmount,
            status: status,
            notes: notes,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        console.log('๐ ุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ:', newInvoice);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
        if (!newInvoice.id || !newInvoice.invoiceNumber || !newInvoice.invoiceType) {
            console.error('โ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุบูุฑ ููุชููุฉ');
            alert('ุฎุทุฃ: ุจูุงูุงุช ุงููุงุชูุฑุฉ ุบูุฑ ููุชููุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            return false;
        }

        // ุชููุฆุฉ ูุตูููุฉ ุงูููุงุชูุฑ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if (!appData.invoices) {
            appData.invoices = [];
            console.log('๐ง ุชู ุชููุฆุฉ ูุตูููุฉ ุงูููุงุชูุฑ');
        }

        // ุญูุธ ุงููุงุชูุฑุฉ
        console.log('๐พ ุญูุธ ุงููุงุชูุฑุฉ ูู ุงููุตูููุฉ...');
        appData.invoices.push(newInvoice);
        console.log('โ ุชู ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ูููุตูููุฉ. ุงูุนุฏุฏ ุงูุญุงูู:', appData.invoices.length);

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
        console.log('๐ค ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ...');
        const currency = newInvoice.currency || appData.settings.currency || 'SYP';

        // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุนูุฏ ุชุฃููุฏ ุงููุงุชูุฑุฉ
        if (status === 'confirmed') {
            updateBalancesForInvoice(newInvoice);
        }

        if (invoiceType === 'sale') {
            updateCustomerData(clientId, totalAmount, currency, invoiceDate);
        } else if (invoiceType === 'purchase') {
            updateSupplierData(clientId, totalAmount, currency, invoiceDate);
        }

        // ุชุญุฏูุซ ุฃุฑูุงู ุงูููุงุชูุฑ
        console.log('๐ข ุชุญุฏูุซ ุฃุฑูุงู ุงูููุงุชูุฑ...');
        if (!appData.settings.nextInvoiceNumber) {
            appData.settings.nextInvoiceNumber = { sale: 1, purchase: 1 };
            console.log('๐ง ุชู ุชููุฆุฉ ุฃุฑูุงู ุงูููุงุชูุฑ');
        }
        appData.settings.nextInvoiceNumber[invoiceType]++;
        console.log('โ ุชู ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ ุงูุชุงูู:', appData.settings.nextInvoiceNumber);

    // ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู (ููุท ููููุงุชูุฑ ุงููุคูุฏุฉ)
    if (status === 'confirmed') {
        addJournalEntry({
            date: invoiceDate,
            description: `ูุงุชูุฑุฉ ${invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'} ุฑูู ${invoiceNumber}`,
            debitAccount: invoiceType === 'sale' ? 'ุงูุนููุงุก' : 'ุงููุดุชุฑูุงุช',
            creditAccount: invoiceType === 'sale' ? 'ุงููุจูุนุงุช' : 'ุงูููุฑุฏูู',
            debitAmount: totalAmount,
            creditAmount: totalAmount,
            reference: invoiceNumber,
            invoiceId: newInvoice.id
        });

        // ุชุญุฏูุซ ุญุฑูุฉ ุงููุฎุฒูู (ููุท ููููุงุชูุฑ ุงููุคูุฏุฉ)
        items.forEach(item => {
            const product = appData.products.find(p => p.id === item.productId);
            if (product) {
                // ุชุญุฏูุซ ูููุฉ ุงูููุชุฌ
                if (invoiceType === 'sale') {
                    product.quantity -= item.quantity;
                } else {
                    product.quantity += item.quantity;
                }

                addInventoryMovement({
                    productId: item.productId,
                    warehouseId: product.warehouseId,
                    movementType: invoiceType === 'sale' ? 'out' : 'in',
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    reference: invoiceNumber,
                    notes: `ูุงุชูุฑุฉ ${invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'} ุฑูู ${invoiceNumber}`
                });
            }
        });
    }

        saveData();
        console.log('ุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage');

        // ุญูุธ ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู
        console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู...');
        try {
            saveData();
            console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู localStorage');
        } catch (saveError) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', saveError);
            alert('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช: ' + saveError.message);
            return false;
        }

        // ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ ูุน ุฎูุงุฑุงุช ูุนุฑุถ ุฑูุฒ ุงูุนููุฉ ุจูุถูุญ
        const statusText = status === 'draft' ? 'ููุณูุฏุฉ' : 'ูุชุฃููุฏูุง';
        const invoiceCurrency = document.getElementById('invoiceCurrency')?.value || 'SYP';
        const currencySymbol = getCurrencySymbol(invoiceCurrency);
        const currencyName = getCurrencyName(invoiceCurrency);
        const successMessage = `โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ!

๐ ุฑูู ุงููุงุชูุฑุฉ: ${invoiceNumber}
๐ฐ ุงููุจูุบ ุงูุฅุฌูุงูู: ${formatCurrency(totalAmount, invoiceCurrency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ ุนุฏุฏ ุงูุนูุงุตุฑ: ${items.length}
๐ ุงูุชุงุฑูุฎ: ${invoiceDate}
๐ท๏ธ ุงูุญุงูุฉ: ${status === 'confirmed' ? 'ูุคูุฏุฉ' : 'ูุณูุฏุฉ'}

ูู ุชุฑูุฏ ุทุจุงุนุฉ ุงููุงุชูุฑุฉุ`;

        console.log('๐ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุจูุฌุงุญ:', newInvoice.id);

        if (confirm(successMessage)) {
            printInvoice(newInvoice.id);
        } else {
            showPage(invoiceType === 'sale' ? 'sales-invoices' : 'purchase-invoices');
        }

        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุงุชูุฑุฉ:', error);
        console.error('โ ุชูุงุตูู ุงูุฎุทุฃ:', error.stack);

        const errorMessage = `ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชูุฑุฉ:

${error.message}

ูุฑุฌู ุงูุชุญูู ูู:
1. ุตุญุฉ ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
2. ูุฌูุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช
3. ูุณุงุญุฉ ุงูุชุฎุฒูู ุงููุชุงุญุฉ

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ูุฑุฌู ุงูุงุชุตุงู ุจุงูุฏุนู ุงูููู.`;

        alert(errorMessage);
        return false;
    }
}

/**
 * ุฅูุดุงุก ุฑูู ูุงุชูุฑุฉ ุฌุฏูุฏ
 */
function generateInvoiceNumber(type) {
    const prefix = type === 'sale' ? 'SALE' : 'PUR';
    const nextNumber = appData.settings.nextInvoiceNumber[type] || 1;
    const year = new Date().getFullYear();
    return `${prefix}-${year}-${String(nextNumber).padStart(4, '0')}`;
}

/**
 * ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู
 */
function addJournalEntry(entry) {
    if (!appData.journalEntries) {
        appData.journalEntries = [];
    }

    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุชุงุฑูุฎ
    const entryDate = entry.date || entry.entryDate || new Date().toISOString().split('T')[0];

    const newEntry = {
        id: Date.now(),
        entryNumber: generateEntryNumber(),
        date: entryDate,
        entryDate: entryDate, // ุฅุถุงูุฉ ุญูู ุงูุชุงุฑูุฎ ุงููุญุฏุฏ
        description: entry.description,
        debitAccount: entry.debitAccount,
        creditAccount: entry.creditAccount,
        debitAmount: parseFloat(entry.debitAmount) || 0,
        creditAmount: parseFloat(entry.creditAmount) || 0,
        currency: entry.currency || appData.settings?.currency || 'SYP',
        reference: entry.reference || entry.referenceNumber || '',
        referenceId: entry.referenceId || null,
        referenceType: entry.referenceType || null,
        entryType: entry.entryType || 'manual',
        invoiceId: entry.invoiceId || null,
        paymentId: entry.paymentId || null,
        createdAt: new Date().toISOString(),
        createdBy: entry.createdBy || 'system'
    };

    appData.journalEntries.push(newEntry);

    console.log('โ ุชู ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู ุฌุฏูุฏ:', {
        entryNumber: newEntry.entryNumber,
        date: newEntry.entryDate,
        description: newEntry.description,
        debitAmount: newEntry.debitAmount,
        creditAmount: newEntry.creditAmount
    });
}

/**
 * ุฅูุดุงุก ุฑูู ููุฏ ุชููุงุฆู
 */
function generateEntryNumber() {
    const year = new Date().getFullYear();
    const nextNumber = (appData.settings?.nextEntryNumber || 1);

    // ุชุญุฏูุซ ุฑูู ุงูููุฏ ุงูุชุงูู
    if (!appData.settings) appData.settings = {};
    appData.settings.nextEntryNumber = nextNumber + 1;

    return `JE-${year}-${String(nextNumber).padStart(4, '0')}`;
}

/**
 * ุฅุนุฏุงุฏ ุญุณุงุจุงุช ุชุนุฏูู ุงููุงุชูุฑุฉ
 */
function setupEditInvoiceCalculations() {
    const modal = document.getElementById('editInvoiceModal');

    // ูุณุชูุนู ุงูุฃุญุฏุงุซ ููุญุณุงุจุงุช
    modal.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-quantity') ||
            e.target.classList.contains('item-price') ||
            e.target.id === 'editDiscountRate' ||
            e.target.id === 'editTaxRate') {
            calculateEditInvoiceTotals();
        }
    });

    modal.addEventListener('change', function(e) {
        if (e.target.classList.contains('item-product')) {
            const row = e.target.closest('tr');
            const productId = parseInt(e.target.value);
            const product = appData.products.find(p => p.id === productId);
            if (product) {
                const priceInput = row.querySelector('.item-price');
                priceInput.value = product.sellingPrice;
                calculateEditInvoiceTotals();
            }
        }
    });
}

/**
 * ุญุณุงุจ ุฅุฌูุงููุงุช ุชุนุฏูู ุงููุงุชูุฑุฉ
 */
function calculateEditInvoiceTotals() {
    const rows = document.querySelectorAll('#editInvoiceItems tr');
    let subtotal = 0;

    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = quantity * price;

        row.querySelector('.item-total').textContent = formatCurrency(total);
        subtotal += total;
    });

    const discountRate = parseFloat(document.getElementById('editDiscountRate').value) || 0;
    const taxRate = parseFloat(document.getElementById('editTaxRate').value) || 0;

    const discountAmount = subtotal * (discountRate / 100);
    const taxAmount = (subtotal - discountAmount) * (taxRate / 100);
    const totalAmount = subtotal - discountAmount + taxAmount;

    document.getElementById('editSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('editDiscountAmount').textContent = formatCurrency(discountAmount);
    document.getElementById('editTaxAmount').textContent = formatCurrency(taxAmount);
    document.getElementById('editTotalAmount').textContent = formatCurrency(totalAmount);
}

/**
 * ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูุชุนุฏูู ุงููุงุชูุฑุฉ
 */
function addEditInvoiceItem() {
    const tbody = document.getElementById('editInvoiceItems');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select class="form-select item-product" required>
                <option value="">ุงุฎุชุฑ ุงูุตูู</option>
                ${appData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
            </select>
        </td>
        <td><input type="number" class="form-control item-quantity" value="1" min="0" step="0.01" required></td>
        <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" required></td>
        <td><span class="item-total">0.00 ู.ุณ</span></td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditInvoiceItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
}

/**
 * ุญุฐู ุนูุตุฑ ูู ุชุนุฏูู ุงููุงุชูุฑุฉ
 */
function removeEditInvoiceItem(button) {
    const row = button.closest('tr');
    row.remove();
    calculateEditInvoiceTotals();
}

/**
 * ุชุญุฏูุซ ุงููุงุชูุฑุฉ
 */
function updateInvoice(invoiceId) {
    const invoice = appData.invoices.find(inv => inv.id === invoiceId);
    if (!invoice) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงุชูุฑุฉ');
        return;
    }

    const oldStatus = invoice.status;
    const clientId = parseInt(document.getElementById('editInvoiceClient').value);
    const invoiceDate = document.getElementById('editInvoiceDate').value;
    const dueDate = document.getElementById('editInvoiceDueDate').value;
    const status = document.getElementById('editInvoiceStatus').value;
    const notes = document.getElementById('editInvoiceNotes').value.trim();

    // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ
    const items = [];
    const itemRows = document.querySelectorAll('#editInvoiceItems tr');

    itemRows.forEach(row => {
        const productId = parseInt(row.querySelector('.item-product').value);
        const quantity = parseFloat(row.querySelector('.item-quantity').value);
        const unitPrice = parseFloat(row.querySelector('.item-price').value);

        if (productId && quantity > 0 && unitPrice >= 0) {
            items.push({
                productId: productId,
                quantity: quantity,
                unitPrice: unitPrice,
                totalAmount: quantity * unitPrice
            });
        }
    });

    if (items.length === 0) {
        alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุตุฑ ูุงุญุฏ ุนูู ุงูุฃูู ูููุงุชูุฑุฉ');
        return;
    }

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    const subtotal = items.reduce((sum, item) => sum + item.totalAmount, 0);
    const discountRate = parseFloat(document.getElementById('editDiscountRate').value) || 0;
    const discountAmount = subtotal * (discountRate / 100);
    const taxRate = parseFloat(document.getElementById('editTaxRate').value) || 0;
    const taxAmount = (subtotal - discountAmount) * (taxRate / 100);
    const totalAmount = subtotal - discountAmount + taxAmount;

    // ุฅุฐุง ูุงูุช ุงููุงุชูุฑุฉ ูุคูุฏุฉ ุณุงุจูุงูุ ูุญุชุงุฌ ูุนูุณ ุชุฃุซูุฑูุง ุนูู ุงููุฎุฒูู
    if (oldStatus === 'confirmed') {
        invoice.items.forEach(item => {
            const product = appData.products.find(p => p.id === item.productId);
            if (product) {
                // ุนูุณ ุงูุญุฑูุฉ ุงูุณุงุจูุฉ
                if (invoice.invoiceType === 'sale') {
                    product.quantity += item.quantity; // ุฅุฑุฌุงุน ุงููููุฉ
                } else {
                    product.quantity -= item.quantity; // ุฅุฒุงูุฉ ุงููููุฉ
                }
            }
        });
    }

    // ุชุญุฏูุซ ุจูุงูุงุช ุงููุงุชูุฑุฉ
    if (invoice.invoiceType === 'sale') {
        invoice.customerId = clientId;
        invoice.supplierId = null;
    } else {
        invoice.supplierId = clientId;
        invoice.customerId = null;
    }

    invoice.invoiceDate = invoiceDate;
    invoice.dueDate = dueDate;
    invoice.items = items;
    invoice.subtotal = subtotal;
    invoice.discountRate = discountRate;
    invoice.discountAmount = discountAmount;
    invoice.taxRate = taxRate;
    invoice.taxAmount = taxAmount;
    invoice.totalAmount = totalAmount;
    invoice.remainingAmount = totalAmount - (invoice.paidAmount || 0);
    invoice.status = status;
    invoice.notes = notes;
    invoice.updatedAt = new Date().toISOString();

    // ุฅุฐุง ุฃุตุจุญุช ุงููุงุชูุฑุฉ ูุคูุฏุฉุ ูุทุจู ุงูุชุฃุซูุฑ ุงูุฌุฏูุฏ ุนูู ุงููุฎุฒูู
    if (status === 'confirmed') {
        items.forEach(item => {
            const product = appData.products.find(p => p.id === item.productId);
            if (product) {
                if (invoice.invoiceType === 'sale') {
                    if (product.quantity < item.quantity) {
                        alert(`ุงููููุฉ ุงููุชุงุญุฉ ูู ${product.name}: ${product.quantity} ${product.unit}`);
                        return;
                    }
                    product.quantity -= item.quantity;
                } else {
                    product.quantity += item.quantity;
                }

                // ุฅุถุงูุฉ ุญุฑูุฉ ูุฎุฒูู ุฌุฏูุฏุฉ
                addInventoryMovement({
                    productId: item.productId,
                    warehouseId: product.warehouseId,
                    movementType: invoice.invoiceType === 'sale' ? 'out' : 'in',
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    reference: invoice.invoiceNumber,
                    notes: `ุชุนุฏูู ูุงุชูุฑุฉ ${invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'} ุฑูู ${invoice.invoiceNumber}`
                });
            }
        });
    }

    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal'));
    modal.hide();

    alert('ุชู ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุจูุฌุงุญ');

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุงูุญุงููุฉ
    const currentPage = invoice.invoiceType === 'sale' ? 'sales-invoices' : 'purchase-invoices';
    showPage(currentPage);
}

/**
 * ุฅูุดุงุก ุฑูู ุณูุฏ ุฌุฏูุฏ
 */
function generatePaymentNumber(type) {
    const prefix = type === 'receipt' ? 'REC' : 'PAY';
    const nextNumber = appData.settings.nextPaymentNumber[type] || 1;
    const year = new Date().getFullYear();
    return `${prefix}-${year}-${String(nextNumber).padStart(4, '0')}`;
}

/**
 * ุชุดุฎูุต ูุดุงูู ุณูุฏุงุช ุงููุจุถ
 */
function diagnoseReceiptIssues() {
    console.log('๐ ุจุฏุก ุชุดุฎูุต ูุดุงูู ุณูุฏุงุช ุงููุจุถ...');

    const issues = [];
    const fixes = [];

    // ูุญุต ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData) {
        issues.push('โ appData ุบูุฑ ููุฌูุฏ');
        fixes.push('ุฅูุดุงุก appData');
    } else {
        console.log('โ appData ููุฌูุฏ');
    }

    // ูุญุต ูุตูููุฉ ุงูุณูุฏุงุช
    if (!appData.payments) {
        issues.push('โ ูุตูููุฉ ุงูุณูุฏุงุช ุบูุฑ ููุฌูุฏุฉ');
        fixes.push('ุฅูุดุงุก ูุตูููุฉ ุงูุณูุฏุงุช');
    } else {
        console.log('โ ูุตูููุฉ ุงูุณูุฏุงุช ููุฌูุฏุฉุ ุงูุนุฏุฏ:', appData.payments.length);
    }

    // ูุญุต ุงูุฅุนุฏุงุฏุงุช
    if (!appData.settings) {
        issues.push('โ ุงูุฅุนุฏุงุฏุงุช ุบูุฑ ููุฌูุฏุฉ');
        fixes.push('ุฅูุดุงุก ุงูุฅุนุฏุงุฏุงุช');
    } else {
        console.log('โ ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏุฉ');
    }

    // ูุญุต ุฃุฑูุงู ุงูุณูุฏุงุช
    if (!appData.settings || !appData.settings.nextPaymentNumber) {
        issues.push('โ ุฃุฑูุงู ุงูุณูุฏุงุช ุบูุฑ ููุฌูุฏุฉ');
        fixes.push('ุฅูุดุงุก ุฃุฑูุงู ุงูุณูุฏุงุช');
    } else {
        console.log('โ ุฃุฑูุงู ุงูุณูุฏุงุช ููุฌูุฏุฉ:', appData.settings.nextPaymentNumber);
    }

    // ูุญุต ุงูุนููุงุก
    if (!appData.customers || appData.customers.length === 0) {
        issues.push('โ ูุง ุชูุฌุฏ ุนููุงุก');
        fixes.push('ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู');
    } else {
        console.log('โ ุงูุนููุงุก ููุฌูุฏููุ ุงูุนุฏุฏ:', appData.customers.length);
    }

    // ูุญุต localStorage
    try {
        const savedData = localStorage.getItem('samProData');
        if (!savedData) {
            issues.push('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ูู localStorage');
            fixes.push('ุญูุธ ุงูุจูุงูุงุช ูู localStorage');
        } else {
            console.log('โ ุงูุจูุงูุงุช ูุญููุธุฉ ูู localStorage');
        }
    } catch (error) {
        issues.push('โ ุฎุทุฃ ูู ุงููุตูู ุฅูู localStorage: ' + error.message);
        fixes.push('ุฅุตูุงุญ ูุดููุฉ localStorage');
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    let message = '๐ ูุชุงุฆุฌ ุงูุชุดุฎูุต:\n\n';

    if (issues.length === 0) {
        message += 'โ ูุง ุชูุฌุฏ ูุดุงูู! ุงููุธุงู ุฌุงูุฒ ููุนูู.\n\n';
        message += `๐ ุฅุญุตุงุฆูุงุช:\n`;
        message += `- ุงูุณูุฏุงุช: ${appData.payments ? appData.payments.length : 0}\n`;
        message += `- ุงูุนููุงุก: ${appData.customers ? appData.customers.length : 0}\n`;
        message += `- ุฑูู ุงูุณูุฏ ุงูุชุงูู: ${appData.settings?.nextPaymentNumber?.receipt || 1}`;
    } else {
        message += 'โ ุงููุดุงูู ุงูููุชุดูุฉ:\n';
        issues.forEach((issue, index) => {
            message += `${index + 1}. ${issue}\n`;
        });

        message += '\n๐ง ุงูุฅุตูุงุญุงุช ุงูููุชุฑุญุฉ:\n';
        fixes.forEach((fix, index) => {
            message += `${index + 1}. ${fix}\n`;
        });

        message += '\nูู ุชุฑูุฏ ุชุทุจูู ุงูุฅุตูุงุญุงุช ุชููุงุฆูุงูุ';

        if (confirm(message)) {
            fixReceiptDataIssues();
        }
    }

    if (issues.length === 0) {
        alert(message);
    }

    console.log('๐ ุงูุชูู ุงูุชุดุฎูุต');
}

/**
 * ุฅุตูุงุญ ูุดุงูู ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ
 */
function fixReceiptDataIssues() {
    console.log('๐ง ุจุฏุก ุฅุตูุงุญ ูุดุงูู ุงูุจูุงูุงุช...');

    let fixesApplied = [];

    // ุฅุตูุงุญ appData
    if (!window.appData) {
        window.appData = {};
        fixesApplied.push('ุฅูุดุงุก appData');
    }

    // ุฅุตูุงุญ ูุตูููุฉ ุงูุณูุฏุงุช
    if (!appData.payments) {
        appData.payments = [];
        fixesApplied.push('ุฅูุดุงุก ูุตูููุฉ ุงูุณูุฏุงุช');
    }

    // ุฅุตูุงุญ ุงูุฅุนุฏุงุฏุงุช
    if (!appData.settings) {
        appData.settings = {};
        fixesApplied.push('ุฅูุดุงุก ุงูุฅุนุฏุงุฏุงุช');
    }

    // ุฅุตูุงุญ ุฃุฑูุงู ุงูุณูุฏุงุช
    if (!appData.settings.nextPaymentNumber) {
        appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
        fixesApplied.push('ุฅูุดุงุก ุฃุฑูุงู ุงูุณูุฏุงุช');
    }

    // ุฅุตูุงุญ ูุตูููุฉ ุงูุนููุงุก
    if (!appData.customers) {
        appData.customers = [];
        fixesApplied.push('ุฅูุดุงุก ูุตูููุฉ ุงูุนููุงุก');
    }

    // ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู ุฅุฐุง ูู ููุฌุฏูุง
    if (appData.customers.length === 0) {
        appData.customers = [
            {
                id: 1,
                name: 'ุนููู ุชุฌุฑูุจู 1',
                phone: '0123456789',
                email: 'customer1@example.com',
                address: 'ุงูุนููุงู ุงูุชุฌุฑูุจู 1',
                currentBalance: 0,
                currency: 'SYP',
                createdAt: new Date().toISOString().split('T')[0]
            },
            {
                id: 2,
                name: 'ุนููู ุชุฌุฑูุจู 2',
                phone: '0987654321',
                email: 'customer2@example.com',
                address: 'ุงูุนููุงู ุงูุชุฌุฑูุจู 2',
                currentBalance: 0,
                currency: 'SYP',
                createdAt: new Date().toISOString().split('T')[0]
            }
        ];
        fixesApplied.push('ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู');
    }

    // ุฅุตูุงุญ ูุตูููุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ
    if (!appData.journalEntries) {
        appData.journalEntries = [];
        fixesApplied.push('ุฅูุดุงุก ูุตูููุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ');
    }

    // ุญูุธ ุงูุจูุงูุงุช
    try {
        saveData();
        fixesApplied.push('ุญูุธ ุงูุจูุงูุงุช ูู localStorage');
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุงูููุตูุญุฉ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ุงูููุตูุญุฉ:', error);
    }

    if (fixesApplied.length > 0) {
        const message = `โ ุชู ุชุทุจูู ุงูุฅุตูุงุญุงุช ุงูุชุงููุฉ:\n\n${fixesApplied.map((fix, index) => `${index + 1}. ${fix}`).join('\n')}\n\nุงููุธุงู ุฌุงูุฒ ุงูุขู ููุนูู!`;
        alert(message);
        console.log('โ ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู');
    } else {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ูุดุงูู ุชุญุชุงุฌ ุฅุตูุงุญ');
    }
}

/**
 * ุงุฎุชุจุงุฑ ุญูุธ ุณูุฏ ุงููุจุถ
 */
function testReceiptSave() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ุญูุธ ุณูุฏ ุงููุจุถ...');

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุฃููุงู
    fixReceiptDataIssues();

    // ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ
    const customerSelect = document.getElementById('receiptCustomer');
    const dateInput = document.getElementById('receiptDate');
    const amountInput = document.getElementById('receiptAmount');
    const currencySelect = document.getElementById('receiptCurrency');
    const methodSelect = document.getElementById('receiptMethod');
    const notesInput = document.getElementById('receiptNotes');

    if (customerSelect && appData.customers.length > 0) {
        customerSelect.value = appData.customers[0].id;
    }

    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    if (amountInput) {
        amountInput.value = '1000';
    }

    if (currencySelect) {
        currencySelect.value = 'SYP';
    }

    if (methodSelect) {
        methodSelect.value = 'cash';
    }

    if (notesInput) {
        notesInput.value = 'ุงุฎุชุจุงุฑ ุญูุธ ุณูุฏ ุงููุจุถ';
    }

    alert('โ ุชู ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ\n\nููููู ุงูุขู ุงูุถุบุท ุนูู "ุญูุธ ุงูุณูุฏ" ูุงุฎุชุจุงุฑ ุงูุนูููุฉ');

    console.log('โ ุงูุชูู ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏ');
}

/**
 * ุงุฎุชุจุงุฑ ูุจุงุดุฑ ูุญูุธ ุณูุฏ ุงููุจุถ
 */
function testDirectSave() {
    console.log('๐งช ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงููุจุงุดุฑ ูุญูุธ ุณูุฏ ุงููุจุถ');

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุฃููุงู
    if (!appData.customers || appData.customers.length === 0) {
        alert('โ ูุง ุชูุฌุฏ ุนููุงุก. ุณูุชู ุฅูุดุงุก ุนููู ุชุฌุฑูุจู...');
        createTestData();
        return;
    }

    // ุฅูุดุงุก ุณูุฏ ุชุฌุฑูุจู ูุจุงุดุฑุฉ
    try {
        const testReceipt = {
            id: Date.now(),
            paymentNumber: `TEST-${Date.now()}`,
            paymentType: 'receipt',
            customerId: appData.customers[0].id,
            paymentDate: new Date().toISOString().split('T')[0],
            amount: 1000,
            currency: 'SYP',
            paymentMethod: 'cash',
            notes: 'ุงุฎุชุจุงุฑ ูุจุงุดุฑ ูุญูุธ ุณูุฏ ุงููุจุถ',
            status: 'confirmed',
            createdAt: new Date().toISOString()
        };

        console.log('๐ ุงูุณูุฏ ุงูุชุฌุฑูุจู:', testReceipt);

        // ุญูุธ ุงูุณูุฏ
        if (!appData.payments) appData.payments = [];
        appData.payments.push(testReceipt);

        // ุญูุธ ูู localStorage
        localStorage.setItem('samProData', JSON.stringify(appData));

        // ุงูุชุญูู ูู ุงูุญูุธ
        const savedData = JSON.parse(localStorage.getItem('samProData'));
        const savedReceipt = savedData.payments.find(p => p.id === testReceipt.id);

        if (savedReceipt) {
            console.log('โ ุชู ุญูุธ ุงูุณูุฏ ุงูุชุฌุฑูุจู ุจูุฌุงุญ');
            alert(`โ ูุฌุญ ุงูุงุฎุชุจุงุฑ ุงููุจุงุดุฑ!\n\nุชู ุญูุธ ุณูุฏ ุชุฌุฑูุจู:\nุฑูู ุงูุณูุฏ: ${testReceipt.paymentNumber}\nุงูุนููู: ${appData.customers[0].name}\nุงููุจูุบ: ${testReceipt.amount} ${testReceipt.currency}\n\nููููู ุงูุขู ุฅูุดุงุก ุณูุฏ ูุจุถ ุนุงุฏู.`);

            // ุชุญุฏูุซ ุงูุตูุญุฉ
            showPage('receipts');
        } else {
            throw new Error('ูุดู ูู ุงูุชุญูู ูู ุญูุธ ุงูุณูุฏ');
        }

    } catch (error) {
        console.error('โ ูุดู ุงูุงุฎุชุจุงุฑ ุงููุจุงุดุฑ:', error);
        alert('โ ูุดู ุงูุงุฎุชุจุงุฑ ุงููุจุงุดุฑ: ' + error.message);
    }
}

/**
 * ูุญุต ุดุงูู ููุดููุฉ ุณูุฏ ุงููุจุถ
 */
function debugReceiptIssue() {
    console.log('๐ ุจุฏุก ูุญุต ุดุงูู ููุดููุฉ ุณูุฏ ุงููุจุถ...');

    const report = {
        timestamp: new Date().toISOString(),
        appData: {
            exists: !!appData,
            customers: appData?.customers?.length || 0,
            payments: appData?.payments?.length || 0,
            settings: !!appData?.settings
        },
        localStorage: {
            available: !!localStorage,
            dataExists: !!localStorage.getItem('samProData'),
            dataSize: localStorage.getItem('samProData')?.length || 0
        },
        dom: {
            receiptCustomer: !!document.getElementById('receiptCustomer'),
            receiptDate: !!document.getElementById('receiptDate'),
            receiptAmount: !!document.getElementById('receiptAmount'),
            receiptCurrency: !!document.getElementById('receiptCurrency'),
            receiptMethod: !!document.getElementById('receiptMethod')
        }
    };

    console.log('๐ ุชูุฑูุฑ ุงูุชุดุฎูุต ุงูุดุงูู:', report);

    // ูุญุต ุงูุนููุงุก ุจุงูุชูุตูู
    if (appData?.customers?.length > 0) {
        console.log('๐ฅ ุชูุงุตูู ุงูุนููุงุก:');
        appData.customers.forEach((customer, index) => {
            console.log(`ุงูุนููู ${index + 1}:`, {
                id: customer.id,
                idType: typeof customer.id,
                name: customer.name,
                hasRequiredFields: !!(customer.id && customer.name)
            });
        });
    }

    // ุงุฎุชุจุงุฑ ุงููููุฐุฌ ุฅุฐุง ูุงู ููุฌูุฏุงู
    const customerSelect = document.getElementById('receiptCustomer');
    if (customerSelect) {
        console.log('๐ ุญุงูุฉ ุงููููุฐุฌ:');
        console.log('- ุนุฏุฏ ุฎูุงุฑุงุช ุงูุนููุงุก:', customerSelect.options.length - 1);
        console.log('- ุงููููุฉ ุงููุญุฏุฏุฉ:', customerSelect.value);
        console.log('- ุงููุต ุงููุญุฏุฏ:', customerSelect.options[customerSelect.selectedIndex]?.text);
    }

    // ุนุฑุถ ุงูุชูุฑูุฑ ูููุณุชุฎุฏู
    const summary = `๐ ุชูุฑูุฑ ุงูุชุดุฎูุต:

๐ง ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:
- appData ููุฌูุฏ: ${report.appData.exists ? 'โ' : 'โ'}
- ุนุฏุฏ ุงูุนููุงุก: ${report.appData.customers}
- ุนุฏุฏ ุงูุณูุฏุงุช: ${report.appData.payments}
- ุงูุฅุนุฏุงุฏุงุช: ${report.appData.settings ? 'โ' : 'โ'}

๐พ ุงูุชุฎุฒูู ุงููุญูู:
- localStorage ูุชุงุญ: ${report.localStorage.available ? 'โ' : 'โ'}
- ุงูุจูุงูุงุช ููุฌูุฏุฉ: ${report.localStorage.dataExists ? 'โ' : 'โ'}
- ุญุฌู ุงูุจูุงูุงุช: ${report.localStorage.dataSize} ุญุฑู

๐ ุนูุงุตุฑ ุงููููุฐุฌ:
- ุงุฎุชูุงุฑ ุงูุนููู: ${report.dom.receiptCustomer ? 'โ' : 'โ'}
- ุงูุชุงุฑูุฎ: ${report.dom.receiptDate ? 'โ' : 'โ'}
- ุงููุจูุบ: ${report.dom.receiptAmount ? 'โ' : 'โ'}
- ุงูุนููุฉ: ${report.dom.receiptCurrency ? 'โ' : 'โ'}
- ุทุฑููุฉ ุงูุฏูุน: ${report.dom.receiptMethod ? 'โ' : 'โ'}

${customerSelect ? `๐ ุงููููุฐุฌ ุงูุญุงูู:
- ุฎูุงุฑุงุช ุงูุนููุงุก: ${customerSelect.options.length - 1}
- ุงููููุฉ ุงููุญุฏุฏุฉ: ${customerSelect.value || 'ูุง ุดูุก'}` : ''}`;

    alert(summary);

    return report;
}

/**
 * ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ูููุฉ ุงูุนููู ุงููุฎุชุงุฑ
 */
function testCustomerSelection() {
    console.log('๐งช ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ูููุฉ ุงูุนููู ุงููุฎุชุงุฑ...');

    const customerSelect = document.getElementById('receiptCustomer');
    if (!customerSelect) {
        alert('โ ุนูุตุฑ ุงุฎุชูุงุฑ ุงูุนููู ุบูุฑ ููุฌูุฏ');
        return;
    }

    const selectionInfo = {
        value: customerSelect.value,
        valueType: typeof customerSelect.value,
        selectedIndex: customerSelect.selectedIndex,
        selectedText: customerSelect.options[customerSelect.selectedIndex]?.text,
        totalOptions: customerSelect.options.length,
        allOptions: Array.from(customerSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text,
            selected: opt.selected
        }))
    };

    console.log('๐ ูุนูููุงุช ุงูุงุฎุชูุงุฑ:', selectionInfo);

    // ุงุฎุชุจุงุฑ ุงูุชุญููู
    const convertedValue = parseInt(customerSelect.value);
    const isValidSelection = customerSelect.value && customerSelect.value !== '' && !isNaN(convertedValue) && convertedValue > 0;

    console.log('๐ ุงุฎุชุจุงุฑ ุงูุชุญููู:', {
        originalValue: customerSelect.value,
        convertedValue: convertedValue,
        isValid: isValidSelection
    });

    // ุงูุจุญุซ ุนู ุงูุนููู
    let customer = null;
    if (isValidSelection && appData.customers) {
        customer = appData.customers.find(c => c.id === convertedValue || c.id == convertedValue);
        console.log('๐ค ูุชูุฌุฉ ุงูุจุญุซ ุนู ุงูุนููู:', customer ? customer.name : 'ุบูุฑ ููุฌูุฏ');
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    const message = `๐ ูุชุงุฆุฌ ุงุฎุชุจุงุฑ ุงุฎุชูุงุฑ ุงูุนููู:

๐ ุงููููุฉ ุงููุฎุชุงุฑุฉ: "${customerSelect.value}"
๐ ุงููุต ุงููุฎุชุงุฑ: "${selectionInfo.selectedText}"
๐ข ุงููููุฉ ุงููุญููุฉ: ${convertedValue}
โ ุตุญุฉ ุงูุงุฎุชูุงุฑ: ${isValidSelection ? 'ุตุญูุญ' : 'ุฎุทุฃ'}
๐ค ุงูุนููู ุงูููุฌูุฏ: ${customer ? customer.name : 'ุบูุฑ ููุฌูุฏ'}

๐ ุฅุฌูุงูู ุงูุฎูุงุฑุงุช: ${selectionInfo.totalOptions - 1} ุนููู`;

    alert(message);

    return {
        isValid: isValidSelection,
        customer: customer,
        selectionInfo: selectionInfo
    };
}

/**
 * ุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงูุนููุงุก ุจุดูู ุตุญูุญ
 */
function forceReloadCustomers() {
    console.log('๐ ุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงูุนููุงุก...');

    const customerSelect = document.getElementById('receiptCustomer');
    if (!customerSelect) {
        alert('โ ุนูุตุฑ ุงุฎุชูุงุฑ ุงูุนููู ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ูุณุญ ุงููุงุฆูุฉ ุชูุงูุงู
    customerSelect.innerHTML = '';

    // ุฅุถุงูุฉ ุงูุฎูุงุฑ ุงูุงูุชุฑุงุถู
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'ุงุฎุชุฑ ุงูุนููู';
    defaultOption.selected = true;
    customerSelect.appendChild(defaultOption);

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุงุก
    if (!appData.customers || appData.customers.length === 0) {
        console.log('โ๏ธ ูุง ุชูุฌุฏ ุนููุงุก ูุฅุถุงูุชูุง');
        const noCustomersOption = document.createElement('option');
        noCustomersOption.value = '';
        noCustomersOption.textContent = 'ูุง ุชูุฌุฏ ุนููุงุก - ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู';
        noCustomersOption.disabled = true;
        customerSelect.appendChild(noCustomersOption);
        return;
    }

    // ุฅุถุงูุฉ ุงูุนููุงุก ูุน ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูุจูุงูุงุช
    console.log('๐ฅ ุฅุถุงูุฉ ุงูุนููุงุก ุฅูู ุงููุงุฆูุฉ...');
    appData.customers.forEach((customer, index) => {
        try {
            if (!customer.id || !customer.name) {
                console.warn(`โ๏ธ ุงูุนููู ${index + 1} ูุญุชูู ุนูู ุจูุงูุงุช ูุงูุตุฉ:`, customer);
                return;
            }

            const option = document.createElement('option');
            option.value = customer.id.toString(); // ุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุต
            option.textContent = customer.name;
            option.setAttribute('data-customer-id', customer.id);
            option.setAttribute('data-customer-name', customer.name);

            customerSelect.appendChild(option);
            console.log(`โ ุชู ุฅุถุงูุฉ ุงูุนููู: ${customer.name} (ID: ${customer.id})`);

        } catch (error) {
            console.error(`โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุนููู ${index + 1}:`, error);
        }
    });

    console.log(`โ ุชู ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงูุนููุงุก: ${customerSelect.options.length - 1} ุนููู`);

    // ุงุฎุชุจุงุฑ ุงููุงุฆูุฉ
    setTimeout(() => {
        console.log('๐งช ุงุฎุชุจุงุฑ ุงููุงุฆูุฉ ุงููุญุฏุซุฉ...');
        console.log('๐ ูุนูููุงุช ุงููุงุฆูุฉ:', {
            totalOptions: customerSelect.options.length,
            currentValue: customerSelect.value,
            selectedIndex: customerSelect.selectedIndex
        });

        alert(`โ ุชู ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงูุนููุงุก ุจูุฌุงุญ!\n\nุนุฏุฏ ุงูุนููุงุก: ${customerSelect.options.length - 1}\n\nููููู ุงูุขู ุงุฎุชูุงุฑ ุนููู ูุญูุธ ุงูุณูุฏ.`);
    }, 100);
}

/**
 * ุฅุตูุงุญ ูุดููุฉ ูุฑุงุกุฉ ูููุฉ ุงูุนููู
 */
function fixCustomerSelectionIssue() {
    console.log('๐ง ุฅุตูุงุญ ูุดููุฉ ูุฑุงุกุฉ ูููุฉ ุงูุนููู...');

    const customerSelect = document.getElementById('receiptCustomer');
    if (!customerSelect) {
        alert('โ ุนูุตุฑ ุงุฎุชูุงุฑ ุงูุนููู ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ูุญุต ุงููููุฉ ุงูุญุงููุฉ
    console.log('๐ ุงููููุฉ ุงูุญุงููุฉ:', {
        value: customerSelect.value,
        selectedIndex: customerSelect.selectedIndex,
        selectedText: customerSelect.options[customerSelect.selectedIndex]?.text
    });

    // ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    console.log('๐ ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฆูุฉ ุงูููุณุฏูุฉ...');

    const currentValue = customerSelect.value;
    customerSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนููู</option>';

    if (appData.customers && appData.customers.length > 0) {
        appData.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id.toString(); // ุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุต
            option.textContent = customer.name;
            if (customer.id.toString() === currentValue) {
                option.selected = true;
            }
            customerSelect.appendChild(option);
        });

        console.log('โ ุชู ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฆูุฉ ุจูุฌุงุญ');
        console.log('๐ ุนุฏุฏ ุงูุฎูุงุฑุงุช:', customerSelect.options.length - 1);

        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
        if (currentValue) {
            customerSelect.value = currentValue;
            console.log('๐ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงููููุฉ:', currentValue);
        }

        // ุงุฎุชุจุงุฑ ุงููุฑุงุกุฉ
        setTimeout(() => {
            const testResult = testCustomerSelection();
            if (testResult.isValid) {
                alert('โ ุชู ุฅุตูุงุญ ูุดููุฉ ูุฑุงุกุฉ ุงูุนููู ุจูุฌุงุญ!');
            } else {
                alert('โ๏ธ ูุง ุชุฒุงู ููุงู ูุดููุฉ ูู ูุฑุงุกุฉ ุงูุนููู. ูุฑุฌู ุงุฎุชูุงุฑ ุนููู ูู ุงููุงุฆูุฉ.');
            }
        }, 100);

    } else {
        alert('โ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
    }
}

/**
 * ุฅุตูุงุญ ูุดุงูู ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ
 */
function fixReceiptDataIssues() {
    console.log('๐ง ูุญุต ูุฅุตูุงุญ ูุดุงูู ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData) {
        console.log('โ๏ธ ุฅุนุงุฏุฉ ุชููุฆุฉ appData...');
        loadData();
    }

    if (!appData.customers) {
        console.log('โ๏ธ ุฅุนุงุฏุฉ ุชููุฆุฉ ูุตูููุฉ ุงูุนููุงุก...');
        appData.customers = [];
    }

    if (!appData.payments) {
        console.log('โ๏ธ ุฅุนุงุฏุฉ ุชููุฆุฉ ูุตูููุฉ ุงูุณูุฏุงุช...');
        appData.payments = [];
    }

    if (!appData.settings) {
        console.log('โ๏ธ ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุฅุนุฏุงุฏุงุช...');
        appData.settings = {};
    }

    if (!appData.settings.nextPaymentNumber) {
        console.log('โ๏ธ ุฅุนุงุฏุฉ ุชููุฆุฉ ุฃุฑูุงู ุงูุณูุฏุงุช...');
        appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
    }

    // ุฅุถุงูุฉ ุนููู ุชุฌุฑูุจู ุฅุฐุง ูู ููุฌุฏ ุนููุงุก
    if (appData.customers.length === 0) {
        console.log('โ๏ธ ุฅุถุงูุฉ ุนููู ุชุฌุฑูุจู...');
        const testCustomer = {
            id: Date.now(),
            name: 'ุนููู ุชุฌุฑูุจู',
            phone: '0991234567',
            email: 'test@example.com',
            address: 'ุนููุงู ุชุฌุฑูุจู',
            currentBalance: 0,
            currency: 'SYP',
            createdAt: new Date().toISOString()
        };
        appData.customers.push(testCustomer);
        saveData();
        console.log('โ ุชู ุฅุถุงูุฉ ุนููู ุชุฌุฑูุจู');

        // ุชุญุฏูุซ ุงููููุฐุฌ ุฅุฐุง ูุงู ููุชูุญุงู
        refreshCustomersDropdown();
    }

    // ุฅุตูุงุญ ูุนุฑูุงุช ุงูุนููุงุก ุฅุฐุง ูุงูุช ูุตูุต
    let fixedCustomers = 0;
    appData.customers.forEach(customer => {
        if (typeof customer.id === 'string' && !isNaN(customer.id)) {
            customer.id = parseInt(customer.id);
            fixedCustomers++;
        }
        if (!customer.id) {
            customer.id = Date.now() + Math.random();
            fixedCustomers++;
        }
    });

    if (fixedCustomers > 0) {
        console.log(`๐ง ุชู ุฅุตูุงุญ ${fixedCustomers} ูุนุฑู ุนููู`);
        saveData();
    }

    console.log('๐ ุญุงูุฉ ุงูุจูุงูุงุช ุจุนุฏ ุงูุฅุตูุงุญ:', {
        customers: appData.customers.length,
        payments: appData.payments.length,
        settings: !!appData.settings,
        nextPaymentNumber: appData.settings.nextPaymentNumber
    });

    console.log('โ ุชู ูุญุต ูุฅุตูุงุญ ุงูุจูุงูุงุช');

    // ุฑุณุงูุฉ ูุฌุงุญ
    alert(`โ ุชู ุฅุตูุงุญ ุงูุจูุงูุงุช ุจูุฌุงุญ!\n\n๐ ุงูุญุงูุฉ ุงูุญุงููุฉ:\nโข ุงูุนููุงุก: ${appData.customers.length}\nโข ุงูุณูุฏุงุช: ${appData.payments.length}\nโข ุงูุฅุนุฏุงุฏุงุช: ูุญุฏุซุฉ\n\nููููู ุงูุขู ุฅูุดุงุก ุณูุฏ ูุจุถ ุฌุฏูุฏ.`);

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช
    showPage('receipts');
}



/**
 * ุชุดุฎูุต ูุดุงูู ุงูุนููุงุก ูู ุณูุฏ ุงููุจุถ
 */
function diagnoseCustomerIssues() {
    console.log('๐ ุจุฏุก ุชุดุฎูุต ูุดุงูู ุงูุนููุงุก...');

    const issues = [];

    // ูุญุต ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData) {
        issues.push('โ appData ุบูุฑ ููุฌูุฏ');
        return issues;
    }

    if (!appData.customers) {
        issues.push('โ appData.customers ุบูุฑ ููุฌูุฏ');
    } else if (!Array.isArray(appData.customers)) {
        issues.push('โ appData.customers ููุณ ูุตูููุฉ');
    } else if (appData.customers.length === 0) {
        issues.push('โ๏ธ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
    } else {
        console.log('โ ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู:', appData.customers.length);

        // ูุญุต ุจูุงูุงุช ุงูุนููุงุก
        appData.customers.forEach((customer, index) => {
            if (!customer.id) {
                issues.push(`โ ุงูุนููู ${index + 1} ูุง ูุญุชูู ุนูู ูุนุฑู`);
            }
            if (!customer.name) {
                issues.push(`โ ุงูุนููู ${index + 1} ูุง ูุญุชูู ุนูู ุงุณู`);
            }
            if (typeof customer.id !== 'number' && typeof customer.id !== 'string') {
                issues.push(`โ๏ธ ุงูุนููู ${customer.name || index + 1} ูุนุฑูู ูู ููุน ุบูุฑ ุตุญูุญ: ${typeof customer.id}`);
            }
        });
    }

    // ูุญุต ุนูุงุตุฑ ุงููููุฐุฌ
    const customerSelect = document.getElementById('receiptCustomer');
    if (!customerSelect) {
        issues.push('โ ุนูุตุฑ ุงุฎุชูุงุฑ ุงูุนููู ุบูุฑ ููุฌูุฏ ูู ุงููููุฐุฌ');
    } else {
        const optionsCount = customerSelect.options.length - 1; // -1 ููุฎูุงุฑ ุงูุงูุชุฑุงุถู
        console.log(`๐ ุนุฏุฏ ุฎูุงุฑุงุช ุงูุนููุงุก ูู ุงููููุฐุฌ: ${optionsCount}`);

        if (optionsCount === 0) {
            issues.push('โ ูุง ุชูุฌุฏ ุฎูุงุฑุงุช ุนููุงุก ูู ุงููููุฐุฌ');
        } else if (appData.customers && optionsCount !== appData.customers.length) {
            issues.push(`โ๏ธ ุนุฏู ุชุทุงุจู: ${appData.customers.length} ุนููุงุก ูู ุงูุจูุงูุงุชุ ${optionsCount} ูู ุงููููุฐุฌ`);
        }
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    if (issues.length === 0) {
        console.log('โ ูุง ุชูุฌุฏ ูุดุงูู ูู ุจูุงูุงุช ุงูุนููุงุก');
        alert('โ ุชุดุฎูุต ุงูุนููุงุก: ูุง ุชูุฌุฏ ูุดุงูู\n\nุฌููุน ุงูุจูุงูุงุช ุณูููุฉ ููููู ุฅูุดุงุก ุณูุฏ ุงููุจุถ ุจูุฌุงุญ.');
    } else {
        console.log('โ ุชู ุงูุนุซูุฑ ุนูู ูุดุงูู:', issues);
        alert(`โ ุชู ุงูุนุซูุฑ ุนูู ุงููุดุงูู ุงูุชุงููุฉ:\n\n${issues.join('\n')}\n\nูุฑุฌู ุงูุถุบุท ุนูู "ุฅุตูุงุญ ุงููุดุงูู" ูุญู ูุฐู ุงููุดุงูู.`);
    }

    return issues;
}

/**
 * ุญูุธ ุณูุฏ ุงููุจุถ - ูุณุฎุฉ ูุจุณุทุฉ ููุจุงุดุฑุฉ
 */
function simpleAddReceipt() {
    console.log('๐ ุจุฏุก ุญูุธ ุณูุฏ ุงููุจุถ - ุงููุณุฎุฉ ุงููุจุณุทุฉ ูุงููุญุณูุฉ');

    try {
        // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ ูุน ูุญุต ุฏููู
        const customerSelect = document.getElementById('receiptCustomer');
        const dateInput = document.getElementById('receiptDate');
        const amountInput = document.getElementById('receiptAmount');
        const currencySelect = document.getElementById('receiptCurrency');
        const methodSelect = document.getElementById('receiptMethod');
        const notesInput = document.getElementById('receiptNotes');

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ
        if (!customerSelect || !dateInput || !amountInput || !currencySelect || !methodSelect) {
            alert('โ ุฎุทุฃ: ุนูุงุตุฑ ุงููููุฐุฌ ุบูุฑ ููุฌูุฏุฉ');
            return;
        }

        // ูุญุต ููุตู ูุงุฎุชูุงุฑ ุงูุนููู
        console.log('๐ ูุญุต ููุตู ูุงุฎุชูุงุฑ ุงูุนููู:', {
            element: !!customerSelect,
            value: customerSelect.value,
            valueLength: customerSelect.value?.length,
            valueType: typeof customerSelect.value,
            selectedIndex: customerSelect.selectedIndex,
            selectedOption: customerSelect.options[customerSelect.selectedIndex],
            selectedText: customerSelect.options[customerSelect.selectedIndex]?.text,
            allOptions: Array.from(customerSelect.options).map(opt => ({
                value: opt.value,
                text: opt.text,
                selected: opt.selected
            }))
        });

        // ุงุณุชุฎุฑุงุฌ ุงูููู ูุน ูุนุงูุฌุฉ ุฎุงุตุฉ ููุนููู
        let customerId = customerSelect.value;

        // ุชูุธูู ูููุฉ ุงูุนููู
        if (customerId) {
            customerId = customerId.toString().trim();
            console.log('๐งน ูููุฉ ุงูุนููู ุจุนุฏ ุงูุชูุธูู:', customerId);
        }

        const date = dateInput.value;
        const amount = amountInput.value;
        const currency = currencySelect.value;
        const method = methodSelect.value;
        const notes = notesInput ? notesInput.value : '';

        console.log('๐ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ:', {
            customerId,
            customerIdType: typeof customerId,
            customerIdLength: customerId?.length,
            date, amount, currency, method, notes
        });

        // ุงูุชุญูู ุงูุฃุณุงุณู ุงููุญุณู ููุนููู
        if (!customerId || customerId === '' || customerId === '0' || customerId === 'undefined' || customerId === 'null') {
            console.error('โ ูุดู ุงูุชุญูู ูู ุงูุนููู:', {
                value: customerId,
                isEmpty: !customerId,
                isEmptyString: customerId === '',
                isZero: customerId === '0'
            });
            alert('โ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ\n\nุชุฃูุฏ ูู:\n- ุงุฎุชูุงุฑ ุนููู ูู ุงููุงุฆูุฉ\n- ุนุฏู ุงุฎุชูุงุฑ "ุงุฎุชุฑ ุงูุนููู"');
            customerSelect.focus();
            customerSelect.style.borderColor = '#dc3545';
            setTimeout(() => customerSelect.style.borderColor = '', 3000);
            return;
        }

        if (!date) {
            alert('โ ูุฑุฌู ุฅุฏุฎุงู ุงูุชุงุฑูุฎ');
            dateInput.focus();
            return;
        }

        if (!amount || parseFloat(amount) <= 0) {
            alert('โ ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ');
            amountInput.focus();
            return;
        }

        if (!currency) {
            alert('โ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ');
            currencySelect.focus();
            return;
        }

        if (!method) {
            alert('โ ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน');
            methodSelect.focus();
            return;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุงุก
        if (!appData.customers || appData.customers.length === 0) {
            alert('โ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
            return;
        }

        // ุงูุจุญุซ ุนู ุงูุนููู ุจุทุฑู ูุชุนุฏุฏุฉ
        console.log('๐ ุงูุจุญุซ ุนู ุงูุนููู...');
        console.log('๐ ุงูุนููุงุก ุงููุชุงุญูู:', appData.customers.map(c => ({
            id: c.id,
            idType: typeof c.id,
            name: c.name
        })));

        let customer = null;

        // ุงูุทุฑููุฉ ุงูุฃููู: ูุทุงุจูุฉ ูุจุงุดุฑุฉ
        customer = appData.customers.find(c => c.id === customerId);
        if (customer) {
            console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู ุจุงููุทุงุจูุฉ ุงููุจุงุดุฑุฉ:', customer.name);
        } else {
            // ุงูุทุฑููุฉ ุงูุซุงููุฉ: ูุทุงุจูุฉ ูุฑูุฉ
            customer = appData.customers.find(c => c.id == customerId);
            if (customer) {
                console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู ุจุงููุทุงุจูุฉ ุงููุฑูุฉ:', customer.name);
            } else {
                // ุงูุทุฑููุฉ ุงูุซุงูุซุฉ: ุชุญููู ุฅูู ุฑูู
                const customerIdNum = parseInt(customerId);
                if (!isNaN(customerIdNum)) {
                    customer = appData.customers.find(c => c.id === customerIdNum || c.id == customerIdNum);
                    if (customer) {
                        console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู ุจุงูุชุญููู ุงูุฑููู:', customer.name);
                    }
                }
            }
        }

        if (!customer) {
            console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู:', {
                searchValue: customerId,
                searchType: typeof customerId,
                availableCustomers: appData.customers.map(c => `${c.name} (ID: ${c.id}, Type: ${typeof c.id})`)
            });
            alert(`โ ุงูุนููู ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช\n\nุงููููุฉ ุงููุฎุชุงุฑุฉ: "${customerId}"\nููุน ุงูุจูุงูุงุช: ${typeof customerId}\n\nุงูุนููุงุก ุงููุชุงุญูู:\n${appData.customers.map(c => `- ${c.name} (ID: ${c.id})`).join('\n')}`);
            return;
        }

        console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู:', customer.name);

        // ุชููุฆุฉ ุงูุจูุงูุงุช
        if (!appData.payments) appData.payments = [];
        if (!appData.settings) appData.settings = {};
        if (!appData.settings.nextPaymentNumber) {
            appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
        }

        // ุฅูุดุงุก ุงูุณูุฏ
        const receiptNumber = `REC-${appData.settings.nextPaymentNumber.receipt}`;
        const newReceipt = {
            id: Date.now(),
            paymentNumber: receiptNumber,
            paymentType: 'receipt',
            customerId: parseInt(customerId),
            paymentDate: date,
            amount: parseFloat(amount),
            currency: currency,
            paymentMethod: method,
            notes: notes,
            status: 'confirmed',
            createdAt: new Date().toISOString()
        };

        console.log('๐ ุงูุณูุฏ ุงูุฌุฏูุฏ:', newReceipt);

        // ุญูุธ ุงูุณูุฏ
        appData.payments.push(newReceipt);
        appData.settings.nextPaymentNumber.receipt++;

        // ุญูุธ ูู localStorage
        localStorage.setItem('samProData', JSON.stringify(appData));

        console.log('โ ุชู ุญูุธ ุงูุณูุฏ ุจูุฌุงุญ');

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addReceiptModal'));
        if (modal) modal.hide();

        // ุฑุณุงูุฉ ูุฌุงุญ
        alert(`โ ุชู ุญูุธ ุณูุฏ ุงููุจุถ ุจูุฌุงุญ!\n\nุฑูู ุงูุณูุฏ: ${receiptNumber}\nุงูุนููู: ${customer.name}\nุงููุจูุบ: ${amount} ${currency}`);

        // ุชุญุฏูุซ ุงูุตูุญุฉ
        showPage('receipts');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุณูุฏ:', error);
        alert('โ ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูุณูุฏ: ' + error.message);
    }
}

/**
 * ุงุฎุชุจุงุฑ ุณุฑูุน ูุญูุธ ุณูุฏ ุงููุจุถ
 */
function quickReceiptTest() {
    console.log('๐งช ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน ูุญูุธ ุณูุฏ ุงููุจุถ...');

    // ูุญุต ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData) {
        alert('โ appData ุบูุฑ ููุฌูุฏ');
        return;
    }

    if (!appData.customers || appData.customers.length === 0) {
        alert('โ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
        return;
    }

    // ูุญุงููุฉ ูุชุญ ุงููููุฐุฌ
    try {
        showAddReceiptModal();

        // ุงูุชุธุงุฑ ูููู ุซู ููุก ุงููููุฐุฌ
        setTimeout(() => {
            const customerSelect = document.getElementById('receiptCustomer');
            const dateInput = document.getElementById('receiptDate');
            const amountInput = document.getElementById('receiptAmount');
            const currencySelect = document.getElementById('receiptCurrency');
            const methodSelect = document.getElementById('receiptMethod');

            if (!customerSelect || !dateInput || !amountInput || !currencySelect || !methodSelect) {
                alert('โ ุนูุงุตุฑ ุงููููุฐุฌ ุบูุฑ ููุฌูุฏุฉ');
                return;
            }

            // ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ
            customerSelect.value = appData.customers[0].id;
            dateInput.value = new Date().toISOString().split('T')[0];
            amountInput.value = '1000';
            currencySelect.value = 'SYP';
            methodSelect.value = 'cash';

            console.log('โ ุชู ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ');
            console.log('๐ ุงูููู:', {
                customer: customerSelect.value,
                date: dateInput.value,
                amount: amountInput.value,
                currency: currencySelect.value,
                method: methodSelect.value
            });

            alert('โ ุชู ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ\n\nููููู ุงูุขู ุงูุถุบุท ุนูู "ุญูุธ ุงูุณูุฏ" ูุงุฎุชุจุงุฑ ุงูุนูููุฉ');

        }, 500);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ:', error);
        alert('โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุงุฎุชุจุงุฑ
 */
function createTestData() {
    console.log('๐งช ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ...');

    // ุฅุถุงูุฉ ุนููุงุก ุชุฌุฑูุจููู
    if (!appData.customers || appData.customers.length === 0) {
        appData.customers = [
            {
                id: 1,
                name: 'ุฃุญูุฏ ูุญูุฏ ุนูู',
                phone: '0991234567',
                email: 'ahmed@example.com',
                address: 'ุฏูุดู - ุงููุฒุฉ',
                currentBalance: 0,
                currency: 'SYP',
                createdAt: new Date().toISOString()
            },
            {
                id: 2,
                name: 'ูุงุทูุฉ ุฃุญูุฏ',
                phone: '0992345678',
                email: 'fatima@example.com',
                address: 'ุญูุจ - ุงูุดูุจุงุก',
                currentBalance: 0,
                currency: 'SYP',
                createdAt: new Date().toISOString()
            },
            {
                id: 3,
                name: 'ูุญูุฏ ุฎุงูุฏ',
                phone: '0993456789',
                email: 'mohammed@example.com',
                address: 'ุญูุต - ุงููุนุฑ',
                currentBalance: 0,
                currency: 'USD',
                createdAt: new Date().toISOString()
            }
        ];
        console.log('โ ุชู ุฅุถุงูุฉ 3 ุนููุงุก ุชุฌุฑูุจููู');
    }

    // ุชููุฆุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData.payments) appData.payments = [];
    if (!appData.settings) appData.settings = {};
    if (!appData.settings.nextPaymentNumber) {
        appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
    }

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();

    alert(`โ ุชู ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุจูุฌุงุญ!\n\n๐ ุงูุจูุงูุงุช ุงููุถุงูุฉ:\nโข ${appData.customers.length} ุนููุงุก\nโข ุฅุนุฏุงุฏุงุช ุงููุธุงู\nโข ุฃุฑูุงู ุงูุณูุฏุงุช\n\nููููู ุงูุขู ุฅูุดุงุก ุณูุฏ ูุจุถ.`);

    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
    showPage('receipts');
}

/**
 * ุงูุญุตูู ุนูู ุงูุญุณุงุจุงุช ุงููุชุงุญุฉ ูู ุฏูุชุฑ ุงูููููุฉ
 */
function getAvailableAccounts() {
    const accounts = new Set();

    if (appData.journalEntries) {
        appData.journalEntries.forEach(entry => {
            if (entry.debitAccount) accounts.add(entry.debitAccount);
            if (entry.creditAccount) accounts.add(entry.creditAccount);
        });
    }

    // ุฅุถุงูุฉ ุญุณุงุจุงุช ุงูุชุฑุงุถูุฉ
    const defaultAccounts = [
        'ุงูุตูุฏูู - ู.ุณ', 'ุงูุตูุฏูู - $', 'ุงูุตูุฏูู - โฌ',
        'ุงูุจูู - ู.ุณ', 'ุงูุจูู - $', 'ุงูุจูู - โฌ',
        'ุงูุนููุงุก', 'ุงูููุฑุฏูู', 'ุงููุจูุนุงุช', 'ุงููุดุชุฑูุงุช',
        'ุงููุตุฑููุงุช ุงูุนููููุฉ', 'ุงูุฅูุฑุงุฏุงุช ุงูุฃุฎุฑู'
    ];

    defaultAccounts.forEach(account => accounts.add(account));

    return Array.from(accounts).sort();
}

/**
 * ุญุณุงุจ ููุฎุต ุฏูุชุฑ ุงูููููุฉ
 */
function calculateJournalSummary() {
    console.log('๐งฎ ุญุณุงุจ ููุฎุต ุฏูุชุฑ ุงูููููุฉ...');

    if (!appData.journalEntries || appData.journalEntries.length === 0) {
        alert('ูุง ุชูุฌุฏ ูููุฏ ูุญุงุณุจูุฉ ูุญุณุงุจ ุงูููุฎุต');
        return;
    }

    // ุชุฌููุน ุงูุจูุงูุงุช ุญุณุจ ุงูุนููุฉ
    const currencyTotals = {};
    const accountBalances = {};

    appData.journalEntries.forEach(entry => {
        const currency = entry.currency || 'SYP';

        // ุชุฌููุน ุงูุฅุฌูุงููุงุช ุญุณุจ ุงูุนููุฉ
        if (!currencyTotals[currency]) {
            currencyTotals[currency] = { debit: 0, credit: 0, entries: 0 };
        }
        currencyTotals[currency].debit += entry.debitAmount || 0;
        currencyTotals[currency].credit += entry.creditAmount || 0;
        currencyTotals[currency].entries++;

        // ุชุฌููุน ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
        const debitAccount = `${entry.debitAccount} - ${getCurrencySymbol(currency)}`;
        const creditAccount = `${entry.creditAccount} - ${getCurrencySymbol(currency)}`;

        if (!accountBalances[debitAccount]) accountBalances[debitAccount] = 0;
        if (!accountBalances[creditAccount]) accountBalances[creditAccount] = 0;

        accountBalances[debitAccount] += entry.debitAmount || 0;
        accountBalances[creditAccount] -= entry.creditAmount || 0;
    });

    // ุฅูุดุงุก ุชูุฑูุฑ ุงูููุฎุต
    let summaryHTML = `
        <div class="modal fade" id="journalSummaryModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-calculator me-2"></i>
                            ููุฎุต ุฏูุชุฑ ุงูููููุฉ ุงูููุตู
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ููุฎุต ุงูุนููุงุช -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">ููุฎุต ุงูุนููุงุช</h6>
                                <div class="row">
    `;

    Object.keys(currencyTotals).forEach(currency => {
        const totals = currencyTotals[currency];
        const symbol = getCurrencySymbol(currency);
        const name = getCurrencyName(currency);
        const balance = totals.debit - totals.credit;
        const balanceClass = Math.abs(balance) < 0.01 ? 'success' : (balance > 0 ? 'warning' : 'info');

        summaryHTML += `
            <div class="col-md-4 mb-3">
                <div class="card border-${balanceClass}">
                    <div class="card-body text-center">
                        <h6 class="card-title">${name} (${symbol})</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">ุฅุฌูุงูู ุงููุฏูู</small>
                                <div class="fw-bold text-danger">${formatCurrency(totals.debit)}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ุฅุฌูุงูู ุงูุฏุงุฆู</small>
                                <div class="fw-bold text-success">${formatCurrency(totals.credit)}</div>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="text-${balanceClass}">
                            <strong>ุงูุฑุตูุฏ: ${formatCurrency(Math.abs(balance))}</strong>
                            <br><small>${Math.abs(balance) < 0.01 ? 'ูุชูุงุฒู' : (balance > 0 ? 'ูุฏูู' : 'ุฏุงุฆู')}</small>
                            <br><small class="text-muted">${totals.entries} ููุฏ</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    summaryHTML += `
                                </div>
                            </div>
                        </div>

                        <!-- ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ุงูุญุณุงุจ</th>
                                                <th>ุงูุฑุตูุฏ</th>
                                                <th>ุงูููุน</th>
                                            </tr>
                                        </thead>
                                        <tbody>
    `;

    Object.keys(accountBalances)
        .filter(account => Math.abs(accountBalances[account]) >= 0.01)
        .sort()
        .forEach(account => {
            const balance = accountBalances[account];
            const balanceType = balance > 0 ? 'ูุฏูู' : 'ุฏุงุฆู';
            const balanceClass = balance > 0 ? 'text-danger' : 'text-success';

            summaryHTML += `
                <tr>
                    <td>${account}</td>
                    <td class="${balanceClass} fw-bold">${formatCurrency(Math.abs(balance))}</td>
                    <td><span class="badge ${balance > 0 ? 'bg-danger' : 'bg-success'}">${balanceType}</span></td>
                </tr>
            `;
        });

    summaryHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-primary" onclick="exportJournalSummary()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ ุงูููุฎุต
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ุฅุถุงูุฉ ุงููุงูุฐุฉ ูุนุฑุถูุง
    const existingModal = document.getElementById('journalSummaryModal');
    if (existingModal) {
        existingModal.remove();
    }

    document.body.insertAdjacentHTML('beforeend', summaryHTML);
    const modal = new bootstrap.Modal(document.getElementById('journalSummaryModal'));
    modal.show();

    console.log('โ ุชู ุนุฑุถ ููุฎุต ุฏูุชุฑ ุงูููููุฉ');
}

/**
 * ุงูุชุญูู ูู ุชูุงุฒู ุฏูุชุฑ ุงูููููุฉ
 */
function validateJournalBalance() {
    console.log('โ๏ธ ุงูุชุญูู ูู ุชูุงุฒู ุฏูุชุฑ ุงูููููุฉ...');

    if (!appData.journalEntries || appData.journalEntries.length === 0) {
        alert('ูุง ุชูุฌุฏ ูููุฏ ูุญุงุณุจูุฉ ููุชุญูู ูููุง');
        return;
    }

    const currencyTotals = {};
    const imbalancedEntries = [];

    appData.journalEntries.forEach(entry => {
        const currency = entry.currency || 'SYP';

        if (!currencyTotals[currency]) {
            currencyTotals[currency] = { debit: 0, credit: 0 };
        }

        const debitAmount = entry.debitAmount || 0;
        const creditAmount = entry.creditAmount || 0;

        currencyTotals[currency].debit += debitAmount;
        currencyTotals[currency].credit += creditAmount;

        // ูุญุต ุชูุงุฒู ุงูููุฏ ุงููุฑุฏู
        if (Math.abs(debitAmount - creditAmount) > 0.01) {
            imbalancedEntries.push({
                id: entry.id,
                description: entry.description,
                debit: debitAmount,
                credit: creditAmount,
                difference: Math.abs(debitAmount - creditAmount),
                currency: currency
            });
        }
    });

    let message = 'โ๏ธ ูุชุงุฆุฌ ูุญุต ุงูุชูุงุฒู:\n\n';
    let hasIssues = false;

    // ูุญุต ุงูุชูุงุฒู ุงูุฅุฌูุงูู ููู ุนููุฉ
    Object.keys(currencyTotals).forEach(currency => {
        const totals = currencyTotals[currency];
        const difference = Math.abs(totals.debit - totals.credit);
        const symbol = getCurrencySymbol(currency);

        if (difference > 0.01) {
            hasIssues = true;
            message += `โ ${getCurrencyName(currency)}: ุบูุฑ ูุชูุงุฒู\n`;
            message += `   ุงููุฏูู: ${formatCurrency(totals.debit)} ${symbol}\n`;
            message += `   ุงูุฏุงุฆู: ${formatCurrency(totals.credit)} ${symbol}\n`;
            message += `   ุงููุฑู: ${formatCurrency(difference)} ${symbol}\n\n`;
        } else {
            message += `โ ${getCurrencyName(currency)}: ูุชูุงุฒู (${formatCurrency(totals.debit)} ${symbol})\n`;
        }
    });

    // ูุญุต ุงููููุฏ ุบูุฑ ุงููุชูุงุฒูุฉ
    if (imbalancedEntries.length > 0) {
        hasIssues = true;
        message += `\nโ๏ธ ูููุฏ ุบูุฑ ูุชูุงุฒูุฉ (${imbalancedEntries.length}):\n`;
        imbalancedEntries.slice(0, 5).forEach(entry => {
            message += `- ${entry.description}: ูุฑู ${formatCurrency(entry.difference)} ${getCurrencySymbol(entry.currency)}\n`;
        });

        if (imbalancedEntries.length > 5) {
            message += `... ู ${imbalancedEntries.length - 5} ูููุฏ ุฃุฎุฑู\n`;
        }
    }

    if (!hasIssues) {
        message += '\n๐ ุฌููุน ุงููููุฏ ูุชูุงุฒูุฉ!';
        alert(message);
    } else {
        message += '\nูู ุชุฑูุฏ ุนุฑุถ ุชูุฑูุฑ ููุตูุ';
        if (confirm(message)) {
            showJournalAnalysis();
        }
    }

    console.log('โ ุงูุชูู ูุญุต ุงูุชูุงุฒู');
}

/**
 * ุชุดุฎูุต ูุดุงูู ุฅุนุฏุงุฏุงุช ุงูุนููุงุช
 */
function diagnoseCurrencySettings() {
    console.log('๐ ุจุฏุก ุชุดุฎูุต ุฅุนุฏุงุฏุงุช ุงูุนููุงุช...');

    const issues = [];
    const fixes = [];

    // ูุญุต ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    if (!appData.settings) {
        issues.push('โ ูุงุฆู ุงูุฅุนุฏุงุฏุงุช ุบูุฑ ููุฌูุฏ');
        fixes.push('ุฅูุดุงุก ูุงุฆู ุงูุฅุนุฏุงุฏุงุช');
    } else {
        console.log('โ ูุงุฆู ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏ');
    }

    // ูุญุต ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ
    if (!appData.settings.currency) {
        issues.push('โ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ ุบูุฑ ูุญุฏุฏุฉ');
        fixes.push('ุชุนููู ุงูููุฑุฉ ุงูุณูุฑูุฉ ูุนููุฉ ุงูุชุฑุงุถูุฉ');
    } else {
        console.log('โ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ:', appData.settings.currency);
    }

    // ูุญุต ุฑูุฒ ุงูุนููุฉ
    if (!appData.settings.currencySymbol) {
        issues.push('โ ุฑูุฒ ุงูุนููุฉ ุบูุฑ ูุญุฏุฏ');
        fixes.push('ุชุนููู ุฑูุฒ ุงูุนููุฉ ุงูุงูุชุฑุงุถู');
    } else {
        console.log('โ ุฑูุฒ ุงูุนููุฉ:', appData.settings.currencySymbol);
    }

    // ูุญุต ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
    if (appData.settings.enableMultiCurrency === undefined) {
        issues.push('โ ุฅุนุฏุงุฏ ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ุบูุฑ ูุญุฏุฏ');
        fixes.push('ุชุนููู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ููุนุทูุฉ ุงูุชุฑุงุถูุงู');
    } else {
        console.log('โ ุงูุนููุงุช ุงููุชุนุฏุฏุฉ:', appData.settings.enableMultiCurrency ? 'ููุนูุฉ' : 'ูุนุทูุฉ');
    }

    // ูุญุต ุฃุณุนุงุฑ ุงูุตุฑู
    if (appData.settings.enableMultiCurrency) {
        if (!appData.settings.exchangeRates) {
            issues.push('โ ุฃุณุนุงุฑ ุงูุตุฑู ุบูุฑ ููุฌูุฏุฉ ุฑุบู ุชูุนูู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ');
            fixes.push('ุฅูุดุงุก ูุงุฆู ุฃุณุนุงุฑ ุงูุตุฑู');
        } else {
            const ratesCount = Object.keys(appData.settings.exchangeRates).filter(key => !key.includes('_updated')).length;
            console.log('โ ุฃุณุนุงุฑ ุงูุตุฑู ููุฌูุฏุฉุ ุงูุนุฏุฏ:', ratesCount);

            if (ratesCount === 0) {
                issues.push('โ ูุง ุชูุฌุฏ ุฃุณุนุงุฑ ุตุฑู ูุญุฏุฏุฉ');
                fixes.push('ุฅุถุงูุฉ ุฃุณุนุงุฑ ุตุฑู ุงูุชุฑุงุถูุฉ');
            }
        }
    }

    // ูุญุต localStorage
    try {
        const savedData = localStorage.getItem('samProData');
        if (!savedData) {
            issues.push('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ูู localStorage');
            fixes.push('ุญูุธ ุงูุจูุงูุงุช ูู localStorage');
        } else {
            const parsedData = JSON.parse(savedData);
            if (!parsedData.settings) {
                issues.push('โ ุงูุฅุนุฏุงุฏุงุช ุบูุฑ ูุญููุธุฉ ูู localStorage');
                fixes.push('ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูู localStorage');
            } else {
                console.log('โ ุงูุฅุนุฏุงุฏุงุช ูุญููุธุฉ ูู localStorage');
            }
        }
    } catch (error) {
        issues.push('โ ุฎุทุฃ ูู ุงููุตูู ุฅูู localStorage: ' + error.message);
        fixes.push('ุฅุตูุงุญ ูุดููุฉ localStorage');
    }

    // ุนุฑุถ ุงููุชุงุฆุฌ
    let message = '๐ ูุชุงุฆุฌ ุชุดุฎูุต ุฅุนุฏุงุฏุงุช ุงูุนููุงุช:\n\n';

    if (issues.length === 0) {
        message += 'โ ูุง ุชูุฌุฏ ูุดุงูู! ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุชุนูู ุจุดูู ุตุญูุญ.\n\n';
        message += `๐ ุฅุญุตุงุฆูุงุช:\n`;
        message += `- ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ: ${appData.settings.currency || 'ุบูุฑ ูุญุฏุฏ'}\n`;
        message += `- ุฑูุฒ ุงูุนููุฉ: ${appData.settings.currencySymbol || 'ุบูุฑ ูุญุฏุฏ'}\n`;
        message += `- ุงูุนููุงุช ุงููุชุนุฏุฏุฉ: ${appData.settings.enableMultiCurrency ? 'ููุนูุฉ' : 'ูุนุทูุฉ'}\n`;
        if (appData.settings.enableMultiCurrency && appData.settings.exchangeRates) {
            const ratesCount = Object.keys(appData.settings.exchangeRates).filter(key => !key.includes('_updated')).length;
            message += `- ุฃุณุนุงุฑ ุงูุตุฑู: ${ratesCount} ุนููุฉ`;
        }
    } else {
        message += 'โ ุงููุดุงูู ุงูููุชุดูุฉ:\n';
        issues.forEach((issue, index) => {
            message += `${index + 1}. ${issue}\n`;
        });

        message += '\n๐ง ุงูุฅุตูุงุญุงุช ุงูููุชุฑุญุฉ:\n';
        fixes.forEach((fix, index) => {
            message += `${index + 1}. ${fix}\n`;
        });

        message += '\nูู ุชุฑูุฏ ุชุทุจูู ุงูุฅุตูุงุญุงุช ุชููุงุฆูุงูุ';

        if (confirm(message)) {
            fixCurrencySettings();
        }
    }

    if (issues.length === 0) {
        alert(message);
    }

    console.log('๐ ุงูุชูู ุชุดุฎูุต ุฅุนุฏุงุฏุงุช ุงูุนููุงุช');
}

/**
 * ุฅุตูุงุญ ูุดุงูู ุฅุนุฏุงุฏุงุช ุงูุนููุงุช
 */
function fixCurrencySettings() {
    console.log('๐ง ุจุฏุก ุฅุตูุงุญ ุฅุนุฏุงุฏุงุช ุงูุนููุงุช...');

    let fixesApplied = [];

    // ุฅุตูุงุญ ูุงุฆู ุงูุฅุนุฏุงุฏุงุช
    if (!appData.settings) {
        appData.settings = {};
        fixesApplied.push('ุฅูุดุงุก ูุงุฆู ุงูุฅุนุฏุงุฏุงุช');
    }

    // ุฅุตูุงุญ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ
    if (!appData.settings.currency) {
        appData.settings.currency = 'SYP';
        fixesApplied.push('ุชุนููู ุงูููุฑุฉ ุงูุณูุฑูุฉ ูุนููุฉ ุงูุชุฑุงุถูุฉ');
    }

    // ุฅุตูุงุญ ุฑูุฒ ุงูุนููุฉ
    if (!appData.settings.currencySymbol) {
        appData.settings.currencySymbol = getCurrencySymbol(appData.settings.currency);
        fixesApplied.push('ุชุนููู ุฑูุฒ ุงูุนููุฉ ุงูุงูุชุฑุงุถู');
    }

    // ุฅุตูุงุญ ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
    if (appData.settings.enableMultiCurrency === undefined) {
        appData.settings.enableMultiCurrency = false;
        fixesApplied.push('ุชุนููู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ููุนุทูุฉ ุงูุชุฑุงุถูุงู');
    }

    // ุฅุตูุงุญ ุฃุณุนุงุฑ ุงูุตุฑู
    if (appData.settings.enableMultiCurrency && !appData.settings.exchangeRates) {
        appData.settings.exchangeRates = {
            'USD': 2500,
            'EUR': 2700,
            'SAR': 667,
            'AED': 680,
            'EGP': 83,
            'JOD': 3521,
            'LBP': 1.67,
            'TRY': 91,
            'GBP': 3125
        };
        fixesApplied.push('ุฅุถุงูุฉ ุฃุณุนุงุฑ ุตุฑู ุงูุชุฑุงุถูุฉ');
    }

    // ุฅุตูุงุญ ูุนุฏู ุงูุถุฑูุจุฉ
    if (!appData.settings.taxRate) {
        appData.settings.taxRate = 0;
        fixesApplied.push('ุชุนููู ูุนุฏู ุถุฑูุจุฉ ุงูุชุฑุงุถู');
    }

    // ุฅุตูุงุญ ูุนูููุงุช ุงูุดุฑูุฉ ุงูุงูุชุฑุงุถูุฉ
    if (!appData.settings.companyName) {
        appData.settings.companyName = 'SAM PRO';
        fixesApplied.push('ุชุนููู ุงุณู ุดุฑูุฉ ุงูุชุฑุงุถู');
    }

    // ุญูุธ ุงูุจูุงูุงุช
    try {
        saveData();
        fixesApplied.push('ุญูุธ ุงูุจูุงูุงุช ูู localStorage');
        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุงูููุตูุญุฉ');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช ุงูููุตูุญุฉ:', error);
    }

    if (fixesApplied.length > 0) {
        const message = `โ ุชู ุชุทุจูู ุงูุฅุตูุงุญุงุช ุงูุชุงููุฉ:\n\n${fixesApplied.map((fix, index) => `${index + 1}. ${fix}`).join('\n')}\n\nุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุฌุงูุฒุฉ ุงูุขู ููุนูู!`;
        alert(message);
        console.log('โ ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ุฅุนุฏุงุฏุงุช ุงูุนููุงุช');

        // ุฅุนุงุฏุฉ ุชุญููู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
        setTimeout(() => {
            showPage('settings');
        }, 1000);
    } else {
        console.log('โน๏ธ ูุง ุชูุฌุฏ ูุดุงูู ุชุญุชุงุฌ ุฅุตูุงุญ');
    }
}

/**
 * ุงุฎุชุจุงุฑ ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุนููุงุช
 */
function testCurrencySettingsSave() {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุนููุงุช...');

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุฃููุงู
    fixCurrencySettings();

    // ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ
    const companyNameInput = document.getElementById('companyName');
    const currencySelect = document.getElementById('currency');
    const enableMultiCurrencyCheckbox = document.getElementById('enableMultiCurrency');

    if (companyNameInput) {
        companyNameInput.value = 'ุดุฑูุฉ ุชุฌุฑูุจูุฉ ููุงุฎุชุจุงุฑ';
    }

    if (currencySelect) {
        currencySelect.value = 'SYP';
    }

    if (enableMultiCurrencyCheckbox) {
        enableMultiCurrencyCheckbox.checked = true;
        // ุชูุนูู ุฌุฏูู ุฃุณุนุงุฑ ุงูุตุฑู
        toggleMultiCurrency();
    }

    // ููุก ุฃุณุนุงุฑ ุงูุตุฑู ุงูุชุฌุฑูุจูุฉ
    const testRates = {
        'USD': 2500,
        'EUR': 2700,
        'SAR': 667,
        'AED': 680
    };

    Object.keys(testRates).forEach(currency => {
        const rateInput = document.getElementById(`rate_${currency}`);
        if (rateInput) {
            rateInput.value = testRates[currency];
        }
    });

    alert('โ ุชู ููุก ุงููููุฐุฌ ุจููู ุชุฌุฑูุจูุฉ\n\nููููู ุงูุขู ุงูุถุบุท ุนูู "ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ" ูุงุฎุชุจุงุฑ ุงูุนูููุฉ');

    console.log('โ ุงูุชูู ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏ');
}

function viewInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงุชูุฑุฉ');
        return;
    }

    // ุนุฑุถ ุชูุงุตูู ุงููุงุชูุฑุฉ ูู ูุงูุฐุฉ ููุจุซูุฉ
    const client = invoice.customerId ?
        appData.customers.find(c => c.id === invoice.customerId) :
        appData.suppliers.find(s => s.id === invoice.supplierId);

    const itemsHtml = invoice.items.map(item => {
        const product = appData.products.find(p => p.id === item.productId);
        return `
            <tr>
                <td>
                    <strong>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</strong>
                    ${item.specifications ? `<br><small class="text-muted">${item.specifications}</small>` : ''}
                </td>
                <td>${item.quantity}</td>
                <td>${formatCurrency(item.unitPrice)}</td>
                <td>${formatCurrency(item.totalAmount)}</td>
            </tr>
        `;
    }).join('');

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'viewInvoiceModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ูุงุชูุฑุฉ ${invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'} ุฑูู ${invoice.invoiceNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>${invoice.invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'}:</strong> ${client ? client.name : 'ุบูุฑ ูุญุฏุฏ'}
                        </div>
                        <div class="col-md-6">
                            <strong>ุงูุชุงุฑูุฎ:</strong> ${invoice.invoiceDate}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู:</strong> ${invoice.dueDate || 'ุบูุฑ ูุญุฏุฏ'}
                        </div>
                        <div class="col-md-6">
                            <strong>ุงูุญุงูุฉ:</strong> <span class="badge bg-${invoice.status === 'confirmed' ? 'success' : 'warning'}">${getStatusText(invoice.status)}</span>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>ุงูุตูู</th>
                                <th>ุงููููุฉ</th>
                                <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                <th>ุงููุฌููุน</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <table class="table">
                                <tr><td><strong>ุงููุฌููุน ุงููุฑุนู:</strong></td><td>${formatCurrency(invoice.subtotal)}</td></tr>
                                <tr><td><strong>ุงูุฎุตู (${invoice.discountRate}%):</strong></td><td>${formatCurrency(invoice.discountAmount)}</td></tr>
                                <tr><td><strong>ุงูุถุฑูุจุฉ (${invoice.taxRate}%):</strong></td><td>${formatCurrency(invoice.taxAmount)}</td></tr>
                                <tr class="table-primary"><td><strong>ุงููุฌููุน ุงูููุงุฆู:</strong></td><td><strong>${formatCurrency(invoice.totalAmount)}</strong></td></tr>
                            </table>
                        </div>
                    </div>

                    ${invoice.notes ? `<div class="mt-3"><strong>ููุงุญุธุงุช:</strong> ${invoice.notes}</div>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="printInvoice(${invoice.id})">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function editInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงุชูุฑุฉ');
        return;
    }

    // ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุชุนุฏูู
    if (invoice.status === 'confirmed') {
        if (!confirm('ูุฐู ุงููุงุชูุฑุฉ ูุคูุฏุฉ. ุงูุชุนุฏูู ุณูุคุซุฑ ุนูู ุงููุฎุฒูู ูุงูุญุณุงุจุงุช. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ')) {
            return;
        }
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุชุนุฏูู ุงููุงุชูุฑุฉ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editInvoiceModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ูุงุชูุฑุฉ ${invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'} ุฑูู ${invoice.invoiceNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editInvoiceType" class="form-label">ููุน ุงููุงุชูุฑุฉ</label>
                                <select class="form-select" id="editInvoiceType" disabled>
                                    <option value="sale" ${invoice.invoiceType === 'sale' ? 'selected' : ''}>ูุงุชูุฑุฉ ูุจูุนุงุช</option>
                                    <option value="purchase" ${invoice.invoiceType === 'purchase' ? 'selected' : ''}>ูุงุชูุฑุฉ ูุดุชุฑูุงุช</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editInvoiceClient" class="form-label">${invoice.invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'}</label>
                                <select class="form-select" id="editInvoiceClient" required>
                                    ${invoice.invoiceType === 'sale' ?
                                        appData.customers.map(c => `<option value="${c.id}" ${c.id === invoice.customerId ? 'selected' : ''}>${c.name}</option>`).join('') :
                                        appData.suppliers.map(s => `<option value="${s.id}" ${s.id === invoice.supplierId ? 'selected' : ''}>${s.name}</option>`).join('')
                                    }
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editInvoiceDate" class="form-label">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</label>
                                <input type="date" class="form-control" id="editInvoiceDate" value="${invoice.invoiceDate}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceDueDate" class="form-label">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                                <input type="date" class="form-control" id="editInvoiceDueDate" value="${invoice.dueDate || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editInvoiceStatus" class="form-label">ุญุงูุฉ ุงููุงุชูุฑุฉ</label>
                                <select class="form-select" id="editInvoiceStatus">
                                    <option value="draft" ${invoice.status === 'draft' ? 'selected' : ''}>ูุณูุฏุฉ</option>
                                    <option value="confirmed" ${invoice.status === 'confirmed' ? 'selected' : ''}>ูุคูุฏุฉ</option>
                                </select>
                            </div>
                        </div>

                        <!-- ุนูุงุตุฑ ุงููุงุชูุฑุฉ -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label">ุนูุงุตุฑ ุงููุงุชูุฑุฉ</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditInvoiceItem()">
                                    <i class="fas fa-plus me-1"></i>ุฅุถุงูุฉ ุนูุตุฑ
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ุงูุตูู</th>
                                            <th>ุงููููุฉ</th>
                                            <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                            <th>ุงููุฌููุน</th>
                                            <th>ุฅุฌุฑุงุกุงุช</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editInvoiceItems">
                                        ${invoice.items.map((item, index) => {
                                            const product = appData.products.find(p => p.id === item.productId);
                                            return `
                                                <tr>
                                                    <td>
                                                        <select class="form-select item-product" required>
                                                            ${appData.products.map(p => `<option value="${p.id}" ${p.id === item.productId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                                        </select>
                                                    </td>
                                                    <td><input type="number" class="form-control item-quantity" value="${item.quantity}" min="0" step="0.01" required></td>
                                                    <td><input type="number" class="form-control item-price" value="${item.unitPrice}" min="0" step="0.01" required></td>
                                                    <td><span class="item-total">${formatCurrency(item.totalAmount)}</span></td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditInvoiceItem(this)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ุงูุญุณุงุจุงุช -->
                        <div class="row">
                            <div class="col-md-6 offset-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6"><strong>ุงููุฌููุน ุงููุฑุนู:</strong></div>
                                            <div class="col-6 text-end" id="editSubtotal">${formatCurrency(invoice.subtotal)}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4">
                                                <label for="editDiscountRate" class="form-label">ุฎุตู (%):</label>
                                                <input type="number" class="form-control form-control-sm" id="editDiscountRate" value="${invoice.discountRate}" min="0" max="100" step="0.01">
                                            </div>
                                            <div class="col-8 text-end pt-4" id="editDiscountAmount">${formatCurrency(invoice.discountAmount)}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4">
                                                <label for="editTaxRate" class="form-label">ุถุฑูุจุฉ (%):</label>
                                                <input type="number" class="form-control form-control-sm" id="editTaxRate" value="${invoice.taxRate}" min="0" max="100" step="0.01">
                                            </div>
                                            <div class="col-8 text-end pt-4" id="editTaxAmount">${formatCurrency(invoice.taxAmount)}</div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6"><strong>ุงููุฌููุน ุงูููุงุฆู:</strong></div>
                                            <div class="col-6 text-end"><strong id="editTotalAmount">${formatCurrency(invoice.totalAmount)}</strong></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editInvoiceNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editInvoiceNotes" rows="3">${invoice.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvoice(${invoice.id})">ุญูุธ ุงูุชุนุฏููุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ ูุญุณุงุจ ุงูุฅุฌูุงููุงุช
    setupEditInvoiceCalculations();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function printInvoice(id) {
    alert('ูุธููุฉ ุทุจุงุนุฉ ุงููุงุชูุฑุฉ ููุฏ ุงูุชุทููุฑ');
}

// ูุธุงุฆู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน
function showAddReceiptModal() {
    console.log('๐ ูุชุญ ูุงูุฐุฉ ุฅุถุงูุฉ ุณูุฏ ูุจุถ...');
    console.log('๐ ุญุงูุฉ ุงูุจูุงูุงุช:', {
        customersCount: appData.customers ? appData.customers.length : 0,
        customers: appData.customers ? appData.customers.map(c => ({ id: c.id, name: c.name })) : []
    });

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุงุก
    if (!appData.customers || appData.customers.length === 0) {
        alert('ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู. ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู ูู ูุงุฆูุฉ ุงูุนููุงุก.');
        showPage('customers');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅุถุงูุฉ ุณูุฏ ูุจุถ ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addReceiptForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="receiptCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                                <select class="form-select" id="receiptCustomer" required>
                                    <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                                    ${appData.customers && appData.customers.length > 0 ?
                                        appData.customers.map(c => `<option value="${c.id}" data-customer-name="${c.name}">${c.name}</option>`).join('') :
                                        '<option value="" disabled>ูุง ุชูุฌุฏ ุนููุงุก - ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู</option>'
                                    }
                                </select>
                                <div class="form-text">ุนุฏุฏ ุงูุนููุงุก ุงููุชุงุญูู: ${appData.customers.length}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="receiptDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="receiptDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="receiptAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="receiptAmount" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="receiptCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="receiptCurrency" required>
                                    <option value="SYP" selected>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR">ููุฑู (โฌ)</option>
                                    <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                    <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                                    <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                    <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                    <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="receiptMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="receiptMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash">ููุฏู</option>
                                    <option value="bank">ุชุญููู ุจููู</option>
                                    <option value="check">ุดูู</option>
                                    <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="receiptReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="receiptReference" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="receiptBank" class="form-label">ุงูุจูู</label>
                                <input type="text" class="form-control" id="receiptBank" placeholder="ุงุณู ุงูุจูู">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="receiptNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="receiptNotes" rows="3" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="simpleAddReceipt()">
                        <i class="fas fa-save me-1"></i>
                        ุญูุธ ุงูุณูุฏ
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="validateAndAddReceipt()">
                        <i class="fas fa-check me-1"></i>
                        ุงูุทุฑููุฉ ุงููุฏููุฉ
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="testCustomerSelection()">
                        <i class="fas fa-user-check me-1"></i>
                        ุงุฎุชุจุงุฑ ุงูุนููู
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="fixCustomerSelectionIssue()">
                        <i class="fas fa-wrench me-1"></i>
                        ุฅุตูุงุญ ุงููุฑุงุกุฉ
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="forceReloadCustomers()">
                        <i class="fas fa-sync-alt me-1"></i>
                        ุฅุนุงุฏุฉ ุชุญููู
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="rebuildReceiptModal()">
                        <i class="fas fa-redo me-1"></i>
                        ุฅุนุงุฏุฉ ุจูุงุก
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุถุงูุฉ ูุณุชูุน ูุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก ุนูุฏ ูุชุญ ุงููุงูุฐุฉ
    modal.addEventListener('shown.bs.modal', function() {
        refreshCustomersDropdown();
    });

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก ูู ุงููููุฐุฌ - ูุณุฎุฉ ูุญุณูุฉ
 */
function refreshCustomersDropdown() {
    const customerSelect = document.getElementById('receiptCustomer');
    if (!customerSelect) {
        console.error('โ ุนูุตุฑ ุงุฎุชูุงุฑ ุงูุนููู ุบูุฑ ููุฌูุฏ');
        return;
    }

    console.log('๐ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก...');
    console.log('๐ ุนุฏุฏ ุงูุนููุงุก:', appData.customers ? appData.customers.length : 0);
    console.log('๐ฅ ุชูุงุตูู ุงูุนููุงุก:', appData.customers ? appData.customers.map(c => ({id: c.id, name: c.name})) : []);

    // ุญูุธ ุงููููุฉ ุงููุฎุชุงุฑุฉ ุญุงููุงู
    const currentValue = customerSelect.value;
    console.log('๐พ ุงููููุฉ ุงููุฎุชุงุฑุฉ ุญุงููุงู:', currentValue);

    // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ ุชูุงูุงู
    customerSelect.innerHTML = '';

    // ุฅุถุงูุฉ ุงูุฎูุงุฑ ุงูุงูุชุฑุงุถู
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'ุงุฎุชุฑ ุงูุนููู';
    defaultOption.selected = true;
    customerSelect.appendChild(defaultOption);

    // ุฅุถุงูุฉ ุงูุนููุงุก
    if (appData.customers && appData.customers.length > 0) {
        let addedCustomers = 0;
        appData.customers.forEach((customer, index) => {
            try {
                if (!customer.id || !customer.name) {
                    console.warn(`โ๏ธ ุงูุนููู ${index + 1} ูุญุชูู ุนูู ุจูุงูุงุช ูุงูุตุฉ:`, customer);
                    return;
                }

                const option = document.createElement('option');
                option.value = customer.id.toString(); // ุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุต
                option.textContent = customer.name;
                option.setAttribute('data-customer-id', customer.id);
                option.setAttribute('data-customer-name', customer.name);

                // ุฅุนุงุฏุฉ ุชุนููู ุงูุงุฎุชูุงุฑ ุฅุฐุง ูุงู ููุฌูุฏุงู
                if (currentValue && customer.id.toString() === currentValue.toString()) {
                    option.selected = true;
                    console.log('๐ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุงุฎุชูุงุฑ:', customer.name);
                }

                customerSelect.appendChild(option);
                addedCustomers++;
                console.log(`โ ุชู ุฅุถุงูุฉ ุงูุนููู ${addedCustomers}: ${customer.name} (ID: ${customer.id})`);

            } catch (error) {
                console.error(`โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุนููู ${index + 1}:`, error);
            }
        });

        console.log(`โ ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนููุงุก ุจูุฌุงุญ: ${addedCustomers} ุนููู`);

        // ุงุฎุชุจุงุฑ ุงููุงุฆูุฉ
        setTimeout(() => {
            console.log('๐งช ุงุฎุชุจุงุฑ ุงููุงุฆูุฉ ุงููุญุฏุซุฉ:', {
                totalOptions: customerSelect.options.length,
                currentValue: customerSelect.value,
                selectedIndex: customerSelect.selectedIndex,
                selectedText: customerSelect.options[customerSelect.selectedIndex]?.text
            });
        }, 100);

    } else {
        const noCustomersOption = document.createElement('option');
        noCustomersOption.value = '';
        noCustomersOption.textContent = 'ูุง ุชูุฌุฏ ุนููุงุก - ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู';
        noCustomersOption.disabled = true;
        customerSelect.appendChild(noCustomersOption);
        console.log('โ๏ธ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
    }

    // ุฅุถุงูุฉ ูุณุชูุน ููุชุบููุฑ ูุชุดุฎูุต ุงููุดููุฉ
    customerSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        const selectedText = this.options[this.selectedIndex]?.text;
        console.log('๐ ุชู ุชุบููุฑ ุงุฎุชูุงุฑ ุงูุนููู:', {
            value: selectedValue,
            text: selectedText,
            selectedIndex: this.selectedIndex
        });

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุงุฎุชูุงุฑ
        if (selectedValue && selectedValue !== '') {
            const customer = appData.customers?.find(c => c.id.toString() === selectedValue.toString());
            if (customer) {
                console.log('โ ุงูุนููู ุงููุฎุชุงุฑ ุตุญูุญ:', customer.name);
            } else {
                console.error('โ ุงูุนููู ุงููุฎุชุงุฑ ุบูุฑ ููุฌูุฏ:', selectedValue);
            }
        }
    });
}

/**
 * ุฅุนุงุฏุฉ ุจูุงุก ูููุฐุฌ ุณูุฏ ุงููุจุถ ุจุงููุงูู
 */
function rebuildReceiptModal() {
    console.log('๐ ุฅุนุงุฏุฉ ุจูุงุก ูููุฐุฌ ุณูุฏ ุงููุจุถ...');

    // ุฅุบูุงู ุงููููุฐุฌ ุงูุญุงูู ุฅุฐุง ูุงู ููุชูุญุงู
    const existingModal = document.getElementById('addReceiptModal');
    if (existingModal) {
        const modalInstance = bootstrap.Modal.getInstance(existingModal);
        if (modalInstance) {
            modalInstance.hide();
        }
        existingModal.remove();
        console.log('๐๏ธ ุชู ุฅุฒุงูุฉ ุงููููุฐุฌ ุงููุฏูู');
    }

    // ุงูุชุธุงุฑ ูุตูุฑ ุซู ุฅุนุงุฏุฉ ูุชุญ ุงููููุฐุฌ
    setTimeout(() => {
        console.log('๐ ูุชุญ ูููุฐุฌ ุฌุฏูุฏ...');
        showAddReceiptModal();

        // ุงูุชุธุงุฑ ุฅุถุงูู ููุชุฃูุฏ ูู ุชุญููู ุงููููุฐุฌ
        setTimeout(() => {
            refreshCustomersDropdown();
            console.log('โ ุชู ุฅุนุงุฏุฉ ุจูุงุก ุงููููุฐุฌ ุจูุฌุงุญ');
            alert('โ ุชู ุฅุนุงุฏุฉ ุจูุงุก ุงููููุฐุฌ ุจูุฌุงุญ!\n\nููููู ุงูุขู ุงุฎุชูุงุฑ ุนููู ูุญูุธ ุงูุณูุฏ.');
        }, 500);
    }, 300);
}

/**
 * ุงูุชุญูู ูู ุตุญุฉ ูููุฐุฌ ุณูุฏ ุงููุจุถ ูุจู ุงูุญูุธ
 */
function validateAndAddReceipt() {
    console.log('๐ ุจุฏุก ุงูุชุญูู ูู ุตุญุฉ ูููุฐุฌ ุณูุฏ ุงููุจุถ...');
    console.log('๐ ุญุงูุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ:', {
        appDataExists: !!appData,
        customersCount: appData?.customers?.length || 0,
        paymentsCount: appData?.payments?.length || 0,
        settingsExists: !!appData?.settings
    });

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ูู ุงููููุฐุฌ
    const customerSelect = document.getElementById('receiptCustomer');
    const dateInput = document.getElementById('receiptDate');
    const amountInput = document.getElementById('receiptAmount');
    const currencySelect = document.getElementById('receiptCurrency');
    const methodSelect = document.getElementById('receiptMethod');

    if (!customerSelect || !dateInput || !amountInput || !currencySelect || !methodSelect) {
        console.error('โ ุนูุงุตุฑ ุงููููุฐุฌ ุบูุฑ ููุฌูุฏุฉ');
        alert('ุฎุทุฃ ูู ุงููููุฐุฌ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        return;
    }

    // ุงูุชุญูู ูู ุงูููู
    const customerId = parseInt(customerSelect.value);
    const customerName = customerSelect.options[customerSelect.selectedIndex]?.text || '';
    const amount = parseFloat(amountInput.value);

    console.log('๐ ููู ุงููููุฐุฌ:', {
        customerId: customerId,
        customerName: customerName,
        date: dateInput.value,
        amount: amount,
        currency: currencySelect.value,
        method: methodSelect.value,
        availableCustomers: appData.customers ? appData.customers.length : 0
    });

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุงุก ูู ุงููุธุงู
    if (!appData.customers || appData.customers.length === 0) {
        alert('ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู. ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู ูู ูุงุฆูุฉ ุงูุนููุงุก.');
        return;
    }

    // ุงูุชุญูู ูู ุงุฎุชูุงุฑ ุงูุนููู ูุน ุชุดุฎูุต ููุตู
    console.log('๐ ูุญุต ุงุฎุชูุงุฑ ุงูุนููู:', {
        customerSelectValue: customerSelect.value,
        customerSelectValueType: typeof customerSelect.value,
        customerId: customerId,
        customerIdType: typeof customerId,
        selectedIndex: customerSelect.selectedIndex,
        selectedText: customerSelect.options[customerSelect.selectedIndex]?.text,
        totalOptions: customerSelect.options.length
    });

    if (!customerSelect.value || customerSelect.value === '' || customerSelect.value === '0') {
        console.error('โ ูู ูุชู ุงุฎุชูุงุฑ ุนููู ูู ุงููุงุฆูุฉ');
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ');
        customerSelect.focus();
        customerSelect.style.borderColor = '#dc3545';
        setTimeout(() => customerSelect.style.borderColor = '', 3000);
        return;
    }

    // ุฅุนุงุฏุฉ ุชุญููู ุงููููุฉ ููุชุฃูุฏ
    const actualCustomerId = parseInt(customerSelect.value);
    if (isNaN(actualCustomerId) || actualCustomerId <= 0) {
        console.error('โ ูููุฉ ุงูุนููู ุบูุฑ ุตุญูุญุฉ:', {
            originalValue: customerSelect.value,
            convertedValue: actualCustomerId
        });
        alert('ูููุฉ ุงูุนููู ุงููุฎุชุงุฑ ุบูุฑ ุตุญูุญุฉ. ูุฑุฌู ุงุฎุชูุงุฑ ุนููู ุขุฎุฑ.');
        customerSelect.focus();
        return;
    }

    console.log('โ ุชู ุงุฎุชูุงุฑ ุนููู ุตุญูุญ:', actualCustomerId);

    // ุงุณุชุฎุฏุงู ุงููููุฉ ุงูุตุญูุญุฉ ููุจุญุซ ุนู ุงูุนููู
    const customer = appData.customers.find(c => c.id === actualCustomerId || c.id == actualCustomerId);
    if (!customer) {
        console.error('โ ุงูุนููู ุบูุฑ ููุฌูุฏ:', {
            selectedId: actualCustomerId,
            originalValue: customerSelect.value,
            availableCustomers: appData.customers.map(c => ({ id: c.id, idType: typeof c.id, name: c.name }))
        });
        alert(`ุงูุนููู ุงููุญุฏุฏ (ID: ${actualCustomerId}) ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.\n\nุงูุนููุงุก ุงููุชุงุญูู:\n${appData.customers.map(c => `- ${c.name} (ID: ${c.id})`).join('\n')}\n\nูุฑุฌู ุงุฎุชูุงุฑ ุนููู ุขุฎุฑ.`);
        customerSelect.focus();
        return;
    }

    // ุงูุชุญูู ูู ุงูุชุงุฑูุฎ
    if (!dateInput.value) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุณูุฏ');
        dateInput.focus();
        return;
    }

    // ุงูุชุญูู ูู ุงููุจูุบ
    if (isNaN(amount) || amount <= 0) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุงูุตูุฑ');
        amountInput.focus();
        return;
    }

    // ุงูุชุญูู ูู ุงูุนููุฉ
    if (!currencySelect.value) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ');
        currencySelect.focus();
        return;
    }

    // ุงูุชุญูู ูู ุทุฑููุฉ ุงูุฏูุน
    if (!methodSelect.value) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน');
        methodSelect.focus();
        return;
    }

    // ุฅุฐุง ุชู ุงูุชุญูู ุจูุฌุงุญุ ุงุณุชุฏุนุงุก ูุธููุฉ ุงูุญูุธ
    console.log('โ ุชู ุงูุชุญูู ูู ุงููููุฐุฌ ุจูุฌุงุญุ ุจุฏุก ุนูููุฉ ุงูุญูุธ...');
    addReceipt();
}

function addReceipt() {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('receipts')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุถุงูุฉ ุณูุฏุงุช ุงููุจุถ');
        return;
    }

    console.log('๐ฐ ุจุฏุก ุญูุธ ุณูุฏ ุงููุจุถ...');
    console.log('๐ ูุญุต ุดุงูู ููุจูุงูุงุช:', {
        appData: !!appData,
        customers: appData?.customers?.length || 0,
        payments: appData?.payments?.length || 0,
        settings: !!appData?.settings,
        nextPaymentNumber: appData?.settings?.nextPaymentNumber,
        localStorage: !!localStorage,
        localStorageData: !!localStorage.getItem('samProData')
    });

    try {
        // ุฌูุน ุงูุจูุงูุงุช ูุน ูุนุงูุฌุฉ ุฃูุถู ููุญููู ุงูููููุฏุฉ
        const customerElement = document.getElementById('receiptCustomer');
        const dateElement = document.getElementById('receiptDate');
        const amountElement = document.getElementById('receiptAmount');
        const currencyElement = document.getElementById('receiptCurrency');
        const methodElement = document.getElementById('receiptMethod');
        const referenceElement = document.getElementById('receiptReference');
        const bankElement = document.getElementById('receiptBankName') || document.getElementById('receiptBank');
        const notesElement = document.getElementById('receiptNotes');

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ุงููุทููุจุฉ
        if (!customerElement || !dateElement || !amountElement || !currencyElement || !methodElement) {
            console.error('โ ุนูุงุตุฑ ุงููููุฐุฌ ููููุฏุฉ:', {
                customer: !!customerElement,
                date: !!dateElement,
                amount: !!amountElement,
                currency: !!currencyElement,
                method: !!methodElement
            });
            throw new Error('ูููุฐุฌ ุณูุฏ ุงููุจุถ ุบูุฑ ููุชูู. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
        }

        const customerId = parseInt(customerElement.value);
        const date = dateElement.value;
        const amount = parseFloat(amountElement.value);
        const currency = currencyElement.value;
        const method = methodElement.value;
        const reference = referenceElement ? referenceElement.value.trim() : '';
        const bank = bankElement ? bankElement.value.trim() : '';
        const notes = notesElement ? notesElement.value.trim() : '';

        console.log('๐ ุจูุงูุงุช ุณูุฏ ุงููุจุถ:', { customerId, date, amount, currency, method, reference, bank, notes });

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ ูุน ุชุดุฎูุต ููุตู
        console.log('๐ ูุญุต ุงูุจูุงูุงุช ุงููุทููุจุฉ:', {
            customerId: customerId,
            customerIdValid: !isNaN(customerId) && customerId > 0,
            date: date,
            dateValid: !!date,
            amount: amount,
            amountValid: !isNaN(amount) && amount > 0,
            currency: currency,
            currencyValid: !!currency && currency.trim() !== '',
            method: method,
            methodValid: !!method && method.trim() !== ''
        });

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุงุก ุฃููุงู
        if (!appData.customers || appData.customers.length === 0) {
            console.error('โ ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู');
            alert('ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู. ูุฑุฌู ุฅุถุงูุฉ ุนููู ุฃููุงู ูู ูุงุฆูุฉ ุงูุนููุงุก.');
            return;
        }

        if (isNaN(customerId) || customerId <= 0) {
            console.error('โ ูู ูุชู ุงุฎุชูุงุฑ ุนููู ุตุญูุญ:', { customerId, type: typeof customerId });
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ');
            document.getElementById('receiptCustomer')?.focus();
            return;
        }

        if (!date || date.trim() === '') {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุณูุฏ');
            document.getElementById('receiptDate')?.focus();
            return;
        }

        if (isNaN(amount) || amount <= 0) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุงูุตูุฑ');
            document.getElementById('receiptAmount')?.focus();
            return;
        }

        if (!currency || currency.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ');
            document.getElementById('receiptCurrency')?.focus();
            return;
        }

        if (!method || method.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน');
            document.getElementById('receiptMethod')?.focus();
            return;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููู ูุน ุฑุณุงูุฉ ููุตูุฉ
        let customer = appData.customers.find(c => c.id === customerId);
        if (!customer) {
            console.error('โ ุงูุนููู ุบูุฑ ููุฌูุฏ:', {
                customerId,
                customerIdType: typeof customerId,
                availableCustomers: appData.customers.map(c => ({ id: c.id, idType: typeof c.id, name: c.name }))
            });

            // ูุญุงููุฉ ุงูุจุญุซ ุจุงููุต ุจุฏูุงู ูู ุงูุฑูู
            const customerByString = appData.customers.find(c => c.id.toString() === customerId.toString());
            if (customerByString) {
                console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู ุจุงูุจุญุซ ุงููุตู:', customerByString);
                customer = customerByString;
            } else {
                alert(`ุงูุนููู ุงููุญุฏุฏ (ID: ${customerId}) ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.\n\nุงูุนููุงุก ุงููุชุงุญูู:\n${appData.customers.map(c => `- ${c.name} (ID: ${c.id})`).join('\n')}\n\nูุฑุฌู ุงุฎุชูุงุฑ ุนููู ุขุฎุฑ ุฃู ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ.`);
                document.getElementById('receiptCustomer')?.focus();
                return;
            }
        }

        console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงูุนููู:', { id: customer.id, name: customer.name });

        // ุชููุฆุฉ ุงูุจูุงูุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ
        if (!appData.payments) {
            appData.payments = [];
            console.log('โ ุชู ุชููุฆุฉ ูุตูููุฉ ุงูุณูุฏุงุช');
        }
        if (!appData.settings) {
            appData.settings = {};
        }
        if (!appData.settings.nextPaymentNumber) {
            appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
            console.log('โ ุชู ุชููุฆุฉ ุฃุฑูุงู ุงูุณูุฏุงุช');
        }

        // ุฅูุดุงุก ุฑูู ุงูุณูุฏ
        const receiptNumber = generatePaymentNumber('receipt');
        console.log('๐ข ุฑูู ุงูุณูุฏ ุงููููุฏ:', receiptNumber);

        if (!receiptNumber) {
            throw new Error('ูุดู ูู ุฅูุดุงุก ุฑูู ุงูุณูุฏ');
        }

        // ุฑูุฒ ุงูุนููุฉ
        const currencySymbols = {
            'SYP': 'ู.ุณ',
            'USD': '$',
            'EUR': 'โฌ',
            'TRY': 'โบ',
            'SAR': 'ุฑ.ุณ',
            'AED': 'ุฏ.ุฅ'
        };

        const newReceipt = {
            id: Date.now(),
            paymentNumber: receiptNumber,
            paymentType: 'receipt',
            customerId: customerId,
            paymentDate: date,
            amount: amount,
            currency: currency,
            currencySymbol: currencySymbols[currency] || currency,
            paymentMethod: method,
            referenceNumber: reference,
            bankName: bank,
            notes: notes,
            status: 'confirmed',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        console.log('๐ ุณูุฏ ุงููุจุถ ุงูุฌุฏูุฏ:', newReceipt);

        // ุญูุธ ุงูุณูุฏ
        appData.payments.push(newReceipt);
        appData.settings.nextPaymentNumber.receipt++;
        console.log('โ ุชู ุฅุถุงูุฉ ุงูุณูุฏ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู
        try {
            updateCustomerPayment(customerId, amount, currency, date);
            console.log('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู');
        } catch (error) {
            console.warn('โ๏ธ ุฎุทุฃ ูู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู:', error);
        }

        // ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู
        if (!appData.journalEntries) {
            appData.journalEntries = [];
            console.log('โ ุชู ุชููุฆุฉ ูุตูููุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ');
        }

        const journalEntry = {
            id: Date.now() + 1,
            entryDate: date,
            entryType: 'payment',
            description: `ุณูุฏ ูุจุถ ุฑูู ${receiptNumber} - ${customer.name}`,
            debitAccount: method === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
            creditAccount: 'ุงูุนููุงุก',
            debitAmount: amount,
            creditAmount: amount,
            currency: currency,
            referenceType: 'payment',
            referenceId: newReceipt.id,
            paymentId: newReceipt.id,
            customerId: customerId,
            createdAt: new Date().toISOString()
        };

        appData.journalEntries.push(journalEntry);
        console.log('๐ ุชู ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู:', journalEntry);

        // ุญูุธ ุงูุจูุงูุงุช ูุน ูุนุงูุฌุฉ ูุญุณูุฉ ููุฃุฎุทุงุก
        try {
            // ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
            if (!appData.payments || !Array.isArray(appData.payments)) {
                appData.payments = [];
                console.log('โ ุชู ุฅุนุงุฏุฉ ุชููุฆุฉ ูุตูููุฉ ุงูุณูุฏุงุช');
            }

            if (!appData.customers || !Array.isArray(appData.customers)) {
                throw new Error('ูุตูููุฉ ุงูุนููุงุก ุบูุฑ ุตุญูุญุฉ - ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ');
            }

            // ุงูุชุญูู ูู ูุฌูุฏ ุงูุณูุฏ ูู ุงููุตูููุฉ
            const receiptExists = appData.payments.find(p => p.id === newReceipt.id);
            if (!receiptExists) {
                throw new Error('ูุดู ูู ุฅุถุงูุฉ ุงูุณูุฏ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
            }

            // ูุญุงููุฉ ุญูุธ ูุชุนุฏุฏุฉ ูุน ุทุฑู ูุฎุชููุฉ
            let saveSuccess = false;
            let saveError = null;

            // ุงูุทุฑููุฉ ุงูุฃููู: ุงูุญูุธ ุงูุนุงุฏู
            try {
                saveData();
                console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจุงูุทุฑููุฉ ุงูุนุงุฏูุฉ');
                saveSuccess = true;
            } catch (error) {
                console.warn('โ๏ธ ูุดู ุงูุญูุธ ุงูุนุงุฏู:', error);
                saveError = error;
            }

            // ุงูุทุฑููุฉ ุงูุซุงููุฉ: ุงูุญูุธ ุงููุจุงุดุฑ
            if (!saveSuccess) {
                try {
                    const dataToSave = JSON.stringify(appData);
                    localStorage.setItem('samProData', dataToSave);
                    console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจุงูุทุฑููุฉ ุงููุจุงุดุฑุฉ');
                    saveSuccess = true;
                } catch (error) {
                    console.warn('โ๏ธ ูุดู ุงูุญูุธ ุงููุจุงุดุฑ:', error);
                    saveError = error;
                }
            }

            // ุงูุทุฑููุฉ ุงูุซุงูุซุฉ: ุญูุธ ุฌุฒุฆู
            if (!saveSuccess) {
                try {
                    // ุญูุธ ุงูุณูุฏุงุช ููุท
                    localStorage.setItem('samProData_payments', JSON.stringify(appData.payments));
                    localStorage.setItem('samProData_customers', JSON.stringify(appData.customers));
                    localStorage.setItem('samProData_settings', JSON.stringify(appData.settings));
                    localStorage.setItem('samProData_journalEntries', JSON.stringify(appData.journalEntries));
                    console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจุงูุทุฑููุฉ ุงูุฌุฒุฆูุฉ');
                    saveSuccess = true;
                } catch (error) {
                    console.warn('โ๏ธ ูุดู ุงูุญูุธ ุงูุฌุฒุฆู:', error);
                    saveError = error;
                }
            }

            if (!saveSuccess) {
                throw new Error('ูุดู ูู ุฌููุน ุทุฑู ุงูุญูุธ: ' + (saveError ? saveError.message : 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
            }

            // ุงูุชุญูู ูู ุงูุญูุธ
            try {
                const savedData = JSON.parse(localStorage.getItem('samProData') || '{}');
                if (savedData.payments && savedData.payments.find(p => p.id === newReceipt.id)) {
                    console.log('โ ุชู ุงูุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');
                } else {
                    // ูุญุงููุฉ ุงุณุชุฑุฏุงุฏ ูู ุงูุญูุธ ุงูุฌุฒุฆู
                    const savedPayments = JSON.parse(localStorage.getItem('samProData_payments') || '[]');
                    if (savedPayments.find(p => p.id === newReceipt.id)) {
                        console.log('โ ุชู ุงูุชุญูู ูู ุงูุญูุธ ุงูุฌุฒุฆู');
                    } else {
                        throw new Error('ูุดู ูู ุงูุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช');
                    }
                }
            } catch (verifyError) {
                console.warn('โ๏ธ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุญูุธ:', verifyError);
                // ูุง ูุฑูู ุฎุทุฃ ููุง ูุฃู ุงูุจูุงูุงุช ูุฏ ุชููู ูุญููุธุฉ ูุนูุงู
            }

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);

            // ูุญุงููุฉ ุฅุฒุงูุฉ ุงูุณูุฏ ุงููุถุงู ูู ุญุงูุฉ ูุดู ุงูุญูุธ
            try {
                const receiptIndex = appData.payments.findIndex(p => p.id === newReceipt.id);
                if (receiptIndex !== -1) {
                    appData.payments.splice(receiptIndex, 1);
                    if (appData.settings && appData.settings.nextPaymentNumber) {
                        appData.settings.nextPaymentNumber.receipt = Math.max(1, appData.settings.nextPaymentNumber.receipt - 1);
                    }
                    console.log('๐ ุชู ุงูุชุฑุงุฌุน ุนู ุฅุถุงูุฉ ุงูุณูุฏ');
                }
            } catch (rollbackError) {
                console.error('โ ุฎุทุฃ ูู ุงูุชุฑุงุฌุน:', rollbackError);
            }

            throw new Error('ูุดู ูู ุญูุธ ุณูุฏ ุงููุจุถ: ' + error.message + '\n\nูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุงุชุตุงู ุจุงูุฏุนู ุงูููู.');
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addReceiptModal'));
        if (modal) {
            modal.hide();
            console.log('โ ุชู ุฅุบูุงู ุงููุงูุฐุฉ');
        } else {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงูุฐุฉ ูุฅุบูุงููุง');
        }

        // ุฑุณุงูุฉ ุงููุฌุงุญ ูุน ุนุฑุถ ุฑูุฒ ุงูุนููุฉ ุจูุถูุญ
        const currencySymbol = getCurrencySymbol(currency);
        const currencyName = getCurrencyName(currency);
        const successMessage = `โ ุชู ุญูุธ ุณูุฏ ุงููุจุถ ุจูุฌุงุญ!

๐ ุฑูู ุงูุณูุฏ: ${receiptNumber}
๐ค ุงูุนููู: ${customer.name}
๐ฐ ุงููุจูุบ: ${formatCurrency(amount, currency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ณ ุทุฑููุฉ ุงูุฏูุน: ${getPaymentMethodText(method)}
๐ ุงูุชุงุฑูุฎ: ${date}

ูู ุชุฑูุฏ ุทุจุงุนุฉ ุงูุณูุฏุ`;

        console.log('๐ ุนูููุฉ ุงูุญูุธ ููุชููุฉ ุจูุฌุงุญ');

        if (confirm(successMessage)) {
            printReceipt(newReceipt.id);
        }

        // ุชุญุฏูุซ ุงูุตูุญุฉ
        showPage('receipts');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุณูุฏ ุงููุจุถ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุณูุฏ ุงููุจุถ: ' + error.message);
    }
}

/**
 * ูุธููุฉ ุญูุธ ุณูุฏ ุงููุจุถ - ูุฑุงุฏู ูู addReceipt
 */
function saveReceipt() {
    return addReceipt();
}

/**
 * ุชุนุฏูู ุณูุฏ ูุจุถ
 */
function editReceipt(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('receipts')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุณูุฏุงุช ุงููุจุถ');
        return;
    }

    console.log('โ๏ธ ุทูุจ ุชุนุฏูู ุณูุฏ ุงููุจุถ:', id);

    // ุงูุจุญุซ ุนู ุงูุณูุฏ
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        console.error('โ ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ:', id);
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุนููู
    const customer = appData.customers.find(c => c.id === receipt.customerId);
    if (!customer) {
        alert('ุงูุนููู ุงููุฑุชุจุท ุจุงูุณูุฏ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุชุนุฏูู
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุณูุฏ ุงููุจุถ ุฑูู ${receipt.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReceiptForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptNumber" class="form-label">ุฑูู ุงูุณูุฏ</label>
                                <input type="text" class="form-control" id="editReceiptNumber" value="${receipt.paymentNumber}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editReceiptDate" value="${receipt.paymentDate}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCustomer" required>
                                    <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                                    ${appData.customers.map(c => `<option value="${c.id}" ${c.id === receipt.customerId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editReceiptAmount" min="0" step="0.01" value="${receipt.amount}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash" ${receipt.paymentMethod === 'cash' ? 'selected' : ''}>ููุฏู</option>
                                    <option value="bank" ${receipt.paymentMethod === 'bank' ? 'selected' : ''}>ุชุญููู ุจููู</option>
                                    <option value="check" ${receipt.paymentMethod === 'check' ? 'selected' : ''}>ุดูู</option>
                                    <option value="card" ${receipt.paymentMethod === 'card' ? 'selected' : ''}>ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCurrency" required>
                                    <option value="SYP" ${receipt.currency === 'SYP' ? 'selected' : ''}>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD" ${receipt.currency === 'USD' ? 'selected' : ''}>ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR" ${receipt.currency === 'EUR' ? 'selected' : ''}>ููุฑู (โฌ)</option>
                                    <option value="TRY" ${receipt.currency === 'TRY' ? 'selected' : ''}>ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR" ${receipt.currency === 'SAR' ? 'selected' : ''}>ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED" ${receipt.currency === 'AED' ? 'selected' : ''}>ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                    <option value="LBP" ${receipt.currency === 'LBP' ? 'selected' : ''}>ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                    <option value="GBP" ${receipt.currency === 'GBP' ? 'selected' : ''}>ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="editReceiptReference" value="${receipt.referenceNumber || ''}" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptBankName" class="form-label">ุงุณู ุงูุจูู</label>
                            <input type="text" class="form-control" id="editReceiptBankName" value="${receipt.bankName || ''}">
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="updateReceipt(${id})">
                        <i class="fas fa-save me-1"></i>
                        ุญูุธ ุงูุชุนุฏููุงุช
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชุญุฏูุซ ุณูุฏ ุงููุจุถ
 */
function updateReceipt(id) {
    console.log('๐พ ุจุฏุก ุชุญุฏูุซ ุณูุฏ ุงููุจุถ:', id);

    try {
        // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
        const customerId = parseInt(document.getElementById('editReceiptCustomer').value);
        const date = document.getElementById('editReceiptDate').value;
        const amount = parseFloat(document.getElementById('editReceiptAmount').value);
        const currency = document.getElementById('editReceiptCurrency').value;
        const method = document.getElementById('editReceiptMethod').value;
        const reference = document.getElementById('editReceiptReference').value.trim();
        const bankName = document.getElementById('editReceiptBankName').value.trim();
        const notes = document.getElementById('editReceiptNotes').value.trim();

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (isNaN(customerId) || customerId <= 0) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู');
            document.getElementById('editReceiptCustomer')?.focus();
            return;
        }

        if (!date || date.trim() === '') {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุณูุฏ');
            document.getElementById('editReceiptDate')?.focus();
            return;
        }

        if (isNaN(amount) || amount <= 0) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุงูุตูุฑ');
            document.getElementById('editReceiptAmount')?.focus();
            return;
        }

        if (!currency || currency.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ');
            document.getElementById('editReceiptCurrency')?.focus();
            return;
        }

        if (!method || method.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน');
            document.getElementById('editReceiptMethod')?.focus();
            return;
        }

        // ุงูุจุญุซ ุนู ุงูุณูุฏ ุงูุฃุตูู
        const originalReceipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
        if (!originalReceipt) {
            alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููู ุงูุฌุฏูุฏ
        const newCustomer = appData.customers.find(c => c.id === customerId);
        if (!newCustomer) {
            alert('ุงูุนููู ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููุชุฑุงุฌุน ูู ุญุงูุฉ ุงูุฎุทุฃ
        const originalData = { ...originalReceipt };

        // ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุงูุฃุตูู ุนูู ุงูุนููู ุงููุฏูู
        if (originalReceipt.customerId) {
            const oldCustomer = appData.customers.find(c => c.id === originalReceipt.customerId);
            if (oldCustomer) {
                // ุทุฑุญ ุงููุจูุบ ุงูุฃุตูู ูู ุฅุฌูุงูู ุงููุฏููุนุงุช ูุฅุถุงูุชู ููุฑุตูุฏ
                const oldCurrency = originalReceipt.currency || 'SYP';
                oldCustomer.totalPayments = Math.max(0, (oldCustomer.totalPayments || 0) - originalReceipt.amount);

                if (!oldCustomer.balances) oldCustomer.balances = {};
                if (!oldCustomer.balances[oldCurrency]) oldCustomer.balances[oldCurrency] = 0;
                oldCustomer.balances[oldCurrency] += originalReceipt.amount;

                if (oldCurrency === (appData.settings.currency || 'SYP')) {
                    oldCustomer.currentBalance = (oldCustomer.currentBalance || 0) + originalReceipt.amount;
                }
            }
        }

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุณูุฏ
        originalReceipt.customerId = customerId;
        originalReceipt.paymentDate = date;
        originalReceipt.amount = amount;
        originalReceipt.currency = currency;
        originalReceipt.paymentMethod = method;
        originalReceipt.referenceNumber = reference;
        originalReceipt.bankName = bankName;
        originalReceipt.notes = notes;
        originalReceipt.updatedAt = new Date().toISOString();

        // ุชุทุจูู ุชุฃุซูุฑ ุงูุณูุฏ ุงููุญุฏุซ ุนูู ุงูุนููู ุงูุฌุฏูุฏ
        updateCustomerPayment(customerId, amount, currency, date);

        // ุชุญุฏูุซ ุงููููุฏ ุงููุญุงุณุจูุฉ
        updateReceiptJournalEntries(id, originalReceipt, newCustomer);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();
        console.log('๐พ ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ');

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editReceiptModal'));
        if (modal) {
            modal.hide();
        }

        // ุฑุณุงูุฉ ุงููุฌุงุญ
        const currencySymbol = getCurrencySymbol(currency);
        const currencyName = getCurrencyName(currency);
        const successMessage = `โ ุชู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ ุจูุฌุงุญ!

๐ ุฑูู ุงูุณูุฏ: ${originalReceipt.paymentNumber}
๐ค ุงูุนููู: ${newCustomer.name}
๐ฐ ุงููุจูุบ: ${formatCurrency(amount, currency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ณ ุทุฑููุฉ ุงูุฏูุน: ${getPaymentMethodText(method)}
๐ ุงูุชุงุฑูุฎ: ${date}`;

        alert(successMessage);

        // ุชุญุฏูุซ ุงูุตูุญุฉ
        showPage('receipts');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุณูุฏ ุงููุจุถ: ' + error.message);
    }
}

/**
 * ุชุญุฏูุซ ุงููููุฏ ุงููุญุงุณุจูุฉ ูุณูุฏ ุงููุจุถ
 */
function updateReceiptJournalEntries(receiptId, receipt, customer) {
    try {
        if (!appData.journalEntries) {
            appData.journalEntries = [];
        }

        // ุญุฐู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฏููุฉ ุงููุฑุชุจุทุฉ ุจุงูุณูุฏ
        appData.journalEntries = appData.journalEntries.filter(entry =>
            entry.paymentId !== receiptId && entry.referenceId !== receiptId
        );

        // ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู ุฌุฏูุฏ
        const journalEntry = {
            id: Date.now() + Math.random(),
            entryDate: receipt.paymentDate,
            entryType: 'payment',
            description: `ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber} - ${customer.name} (ูุญุฏุซ)`,
            debitAccount: receipt.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
            creditAccount: 'ุงูุนููุงุก',
            debitAmount: receipt.amount,
            creditAmount: receipt.amount,
            currency: receipt.currency,
            referenceType: 'payment',
            referenceId: receipt.id,
            paymentId: receipt.id,
            customerId: receipt.customerId,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        appData.journalEntries.push(journalEntry);
        console.log('๐ ุชู ุชุญุฏูุซ ุงูููุฏ ุงููุญุงุณุจู:', journalEntry);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููููุฏ ุงููุญุงุณุจูุฉ:', error);
    }
}

/**
 * ุนุฑุถ ุณูุฏ ูุจุถ
 */
function viewReceipt(id) {
    console.log('๐๏ธ ุนุฑุถ ุณูุฏ ุงููุจุถ:', id);

    // ุงูุจุญุซ ุนู ุงูุณูุฏ
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        console.error('โ ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ:', id);
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุนููู
    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const customerName = customer ? customer.name : 'ุนููู ูุญุฐูู';
    const customerPhone = customer ? customer.phone : '';
    const customerEmail = customer ? customer.email : '';

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุนุฑุถ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'viewReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        ุนุฑุถ ุณูุฏ ุงููุจุถ ุฑูู ${receipt.paymentNumber}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-invoice me-2"></i>
                                        ูุนูููุงุช ุงูุณูุฏ
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>ุฑูู ุงูุณูุฏ:</strong></td>
                                            <td>${receipt.paymentNumber}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุชุงุฑูุฎ:</strong></td>
                                            <td>${formatDate(receipt.paymentDate)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงููุจูุบ:</strong></td>
                                            <td class="text-success">
                                                <strong>${formatCurrency(receipt.amount, receipt.currency)}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุนููุฉ:</strong></td>
                                            <td>${getCurrencyName(receipt.currency)} (${getCurrencySymbol(receipt.currency)})</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุทุฑููุฉ ุงูุฏูุน:</strong></td>
                                            <td>${getPaymentMethodText(receipt.paymentMethod)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุญุงูุฉ:</strong></td>
                                            <td><span class="badge bg-${getStatusColor(receipt.status)}">${getStatusText(receipt.status)}</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user me-2"></i>
                                        ูุนูููุงุช ุงูุนููู
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>ุงูุงุณู:</strong></td>
                                            <td>${customerName}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงููุงุชู:</strong></td>
                                            <td>${customerPhone || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</strong></td>
                                            <td>${customerEmail || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุฑูู ุงููุฑุฌุน:</strong></td>
                                            <td>${receipt.referenceNumber || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุจูู:</strong></td>
                                            <td>${receipt.bankName || '-'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${receipt.notes ? `
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    ุงูููุงุญุธุงุช
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">${receipt.notes}</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                ูุนูููุงุช ุฅุถุงููุฉ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">ุชุงุฑูุฎ ุงูุฅูุดุงุก:</small><br>
                                    <span>${formatDateTime(receipt.createdAt)}</span>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">ุขุฎุฑ ุชุญุฏูุซ:</small><br>
                                    <span>${formatDateTime(receipt.updatedAt || receipt.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                    <button type="button" class="btn btn-success" onclick="printReceipt(${id})">
                        <i class="fas fa-print me-2"></i>
                        ุทุจุงุนุฉ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editReceipt(${id}); bootstrap.Modal.getInstance(document.getElementById('viewReceiptModal')).hide();">
                        <i class="fas fa-edit me-2"></i>
                        ุชุนุฏูู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุทุจุงุนุฉ ุณูุฏ ูุจุถ
 */
function printReceipt(id) {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุณูุฏ ุงููุจุถ:', id);

    // ุงูุจุญุซ ุนู ุงูุณูุฏ
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        console.error('โ ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ:', id);
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุนููู
    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const customerName = customer ? customer.name : 'ุนููู ูุญุฐูู';
    const customerPhone = customer ? customer.phone : '';
    const customerAddress = customer ? customer.address : '';

    // ุฅูุดุงุก ูุญุชูู ุงูุทุจุงุนุฉ
    const printContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber}</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    margin: 0;
                    padding: 20px;
                    background: white;
                    color: #333;
                    direction: rtl;
                }
                .receipt-container {
                    max-width: 800px;
                    margin: 0 auto;
                    border: 2px solid #333;
                    padding: 30px;
                    background: white;
                }
                .header {
                    text-align: center;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .company-name {
                    font-size: 28px;
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .receipt-title {
                    font-size: 24px;
                    font-weight: bold;
                    color: #27ae60;
                    margin-bottom: 10px;
                }
                .receipt-number {
                    font-size: 18px;
                    color: #666;
                }
                .content {
                    margin: 30px 0;
                }
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    padding: 10px;
                    border-bottom: 1px solid #eee;
                }
                .info-label {
                    font-weight: bold;
                    color: #2c3e50;
                    min-width: 120px;
                }
                .info-value {
                    flex: 1;
                    text-align: left;
                }
                .amount-section {
                    background: #f8f9fa;
                    border: 2px solid #27ae60;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 30px 0;
                    text-align: center;
                }
                .amount-label {
                    font-size: 18px;
                    color: #666;
                    margin-bottom: 10px;
                }
                .amount-value {
                    font-size: 32px;
                    font-weight: bold;
                    color: #27ae60;
                }
                .notes-section {
                    margin: 30px 0;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 10px;
                }
                .notes-title {
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .footer {
                    margin-top: 50px;
                    border-top: 2px solid #333;
                    padding-top: 20px;
                    display: flex;
                    justify-content: space-between;
                }
                .signature-box {
                    text-align: center;
                    min-width: 200px;
                }
                .signature-line {
                    border-top: 1px solid #333;
                    margin-top: 50px;
                    padding-top: 10px;
                }
                @media print {
                    body { margin: 0; padding: 10px; }
                    .receipt-container { border: 1px solid #333; padding: 20px; }
                }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                <div class="header">
                    <div class="company-name">${appData.settings?.companyName || 'SAM PRO'}</div>
                    <div class="receipt-title">ุณูุฏ ูุจุถ</div>
                    <div class="receipt-number">ุฑูู ุงูุณูุฏ: ${receipt.paymentNumber}</div>
                </div>

                <div class="content">
                    <div class="info-row">
                        <span class="info-label">ุงูุชุงุฑูุฎ:</span>
                        <span class="info-value">${formatDate(receipt.paymentDate)}</span>
                    </div>

                    <div class="info-row">
                        <span class="info-label">ุงุณู ุงูุนููู:</span>
                        <span class="info-value">${customerName}</span>
                    </div>

                    ${customerPhone ? `
                        <div class="info-row">
                            <span class="info-label">ุฑูู ุงููุงุชู:</span>
                            <span class="info-value">${customerPhone}</span>
                        </div>
                    ` : ''}

                    ${customerAddress ? `
                        <div class="info-row">
                            <span class="info-label">ุงูุนููุงู:</span>
                            <span class="info-value">${customerAddress}</span>
                        </div>
                    ` : ''}

                    <div class="info-row">
                        <span class="info-label">ุทุฑููุฉ ุงูุฏูุน:</span>
                        <span class="info-value">${getPaymentMethodText(receipt.paymentMethod)}</span>
                    </div>

                    <div class="info-row">
                        <span class="info-label">ุงูุนููุฉ:</span>
                        <span class="info-value">${getCurrencyName(receipt.currency)}</span>
                    </div>

                    ${receipt.referenceNumber ? `
                        <div class="info-row">
                            <span class="info-label">ุฑูู ุงููุฑุฌุน:</span>
                            <span class="info-value">${receipt.referenceNumber}</span>
                        </div>
                    ` : ''}

                    ${receipt.bankName ? `
                        <div class="info-row">
                            <span class="info-label">ุงูุจูู:</span>
                            <span class="info-value">${receipt.bankName}</span>
                        </div>
                    ` : ''}
                </div>

                <div class="amount-section">
                    <div class="amount-label">ุงููุจูุบ ุงููุณุชูู</div>
                    <div class="amount-value">${formatCurrency(receipt.amount, receipt.currency)}</div>
                </div>

                ${receipt.notes ? `
                    <div class="notes-section">
                        <div class="notes-title">ุงูููุงุญุธุงุช:</div>
                        <div>${receipt.notes}</div>
                    </div>
                ` : ''}

                <div class="footer">
                    <div class="signature-box">
                        <div>ุชูููุน ุงููุณุชูู</div>
                        <div class="signature-line"></div>
                    </div>
                    <div class="signature-box">
                        <div>ุชูููุน ุงููุญุงุณุจ</div>
                        <div class="signature-line"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
                    ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ SAM PRO - ${new Date().toLocaleDateString('ar-SA')} ${new Date().toLocaleTimeString('ar-SA')}
                </div>
            </div>
        </body>
        </html>
    `;

    // ูุชุญ ูุงูุฐุฉ ุทุจุงุนุฉ ุฌุฏูุฏุฉ
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();

    // ุงูุชุธุงุฑ ุชุญููู ุงููุญุชูู ุซู ุงูุทุจุงุนุฉ
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();

        // ุฅุบูุงู ุงููุงูุฐุฉ ุจุนุฏ ุงูุทุจุงุนุฉ (ุงุฎุชูุงุฑู)
        setTimeout(() => {
            printWindow.close();
        }, 1000);
    };

    console.log('โ ุชู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ ูุณูุฏ ุงููุจุถ');
}

function showAddPaymentModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addPaymentModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅุถุงูุฉ ุณูุฏ ุฏูุน ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentSupplier" class="form-label">ุงูููุฑุฏ <span class="text-danger">*</span></label>
                                <select class="form-select" id="paymentSupplier" required>
                                    <option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>
                                    ${appData.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="paymentDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="paymentAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="paymentAmount" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="paymentCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="paymentCurrency" required>
                                    <option value="SYP" selected>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR">ููุฑู (โฌ)</option>
                                    <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="paymentMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash">ููุฏู</option>
                                    <option value="bank">ุชุญููู ุจููู</option>
                                    <option value="check">ุดูู</option>
                                    <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="paymentReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="paymentReference">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="paymentBank" class="form-label">ุงูุจูู</label>
                                <input type="text" class="form-control" id="paymentBank">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="savePayment()">ุญูุธ ุงูุณูุฏ</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function savePayment() {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('payments')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุถุงูุฉ ุณูุฏุงุช ุงูุฏูุน');
        return;
    }

    console.log('๐ฐ ุจุฏุก ุญูุธ ุณูุฏ ุงูุฏูุน...');

    try {
        const supplierId = parseInt(document.getElementById('paymentSupplier').value);
        const date = document.getElementById('paymentDate').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const currency = document.getElementById('paymentCurrency').value;
        const method = document.getElementById('paymentMethod').value;
        const reference = document.getElementById('paymentReference').value.trim();
        const bank = document.getElementById('paymentBank').value.trim();
        const notes = document.getElementById('paymentNotes').value.trim();

        console.log('๐ ุจูุงูุงุช ุณูุฏ ุงูุฏูุน:', { supplierId, date, amount, currency, method, reference, bank, notes });

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ ูุน ุชุดุฎูุต ููุตู
        console.log('๐ ูุญุต ุงูุจูุงูุงุช ุงููุทููุจุฉ:', {
            supplierId: supplierId,
            supplierIdValid: !isNaN(supplierId) && supplierId > 0,
            date: date,
            dateValid: !!date,
            amount: amount,
            amountValid: !isNaN(amount) && amount > 0,
            currency: currency,
            currencyValid: !!currency && currency.trim() !== '',
            method: method,
            methodValid: !!method && method.trim() !== ''
        });

        if (isNaN(supplierId) || supplierId <= 0) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูููุฑุฏ');
            document.getElementById('paymentSupplier')?.focus();
            return;
        }

        if (!date || date.trim() === '') {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุณูุฏ');
            document.getElementById('paymentDate')?.focus();
            return;
        }

        if (isNaN(amount) || amount <= 0) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุงูุตูุฑ');
            document.getElementById('paymentAmount')?.focus();
            return;
        }

        if (!currency || currency.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ');
            document.getElementById('paymentCurrency')?.focus();
            return;
        }

        if (!method || method.trim() === '') {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน');
            document.getElementById('paymentMethod')?.focus();
            return;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูููุฑุฏ
        const supplier = appData.suppliers.find(s => s.id === supplierId);
        if (!supplier) {
            alert('ุงูููุฑุฏ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุชููุฆุฉ ุงูุจูุงูุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ
        if (!appData.payments) {
            appData.payments = [];
        }
        if (!appData.settings.nextPaymentNumber) {
            appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
        }

        // ุฅูุดุงุก ุฑูู ุงูุณูุฏ
        const paymentNumber = generatePaymentNumber('payment');
        console.log('๐ข ุฑูู ุงูุณูุฏ ุงููููุฏ:', paymentNumber);

        // ุฑูุฒ ุงูุนููุฉ
        const currencySymbols = {
            'SYP': 'ู.ุณ',
            'USD': '$',
            'EUR': 'โฌ',
            'TRY': 'โบ',
            'SAR': 'ุฑ.ุณ',
            'AED': 'ุฏ.ุฅ'
        };

        const newPayment = {
            id: Date.now(),
            paymentNumber: paymentNumber,
            paymentType: 'payment',
            supplierId: supplierId,
            paymentDate: date,
            amount: amount,
            currency: currency,
            currencySymbol: currencySymbols[currency] || currency,
            paymentMethod: method,
            referenceNumber: reference,
            bankName: bank,
            notes: notes,
            status: 'confirmed',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        console.log('๐ ุณูุฏ ุงูุฏูุน ุงูุฌุฏูุฏ:', newPayment);

        // ุงูุชุญูู ูู ูุฌูุฏ ูุตูููุฉ ุงูุณูุฏุงุช
        if (!appData.payments) {
            appData.payments = [];
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุฃุฑูุงู ุงูุณูุฏุงุช
        if (!appData.settings.nextPaymentNumber) {
            appData.settings.nextPaymentNumber = { receipt: 1, payment: 1 };
        }

        // ุญูุธ ุงูุณูุฏ
        appData.payments.push(newPayment);
        appData.settings.nextPaymentNumber.payment++;

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ
        updateSupplierPayment(supplierId, amount, currency, date);

        // ุฅุถุงูุฉ ููุฏ ูุญุงุณุจู
        if (!appData.journalEntries) {
            appData.journalEntries = [];
        }

        const journalEntry = {
            id: Date.now() + 1,
            entryDate: date,
            entryType: 'payment',
            description: `ุณูุฏ ุฏูุน ุฑูู ${paymentNumber} - ${supplier.name}`,
            debitAccount: `ุงูููุฑุฏูู - ${supplier.name} - ${getCurrencySymbol(currency)}`,
            creditAccount: method === 'cash' ? `ุงูุตูุฏูู - ${getCurrencySymbol(currency)}` : `ุงูุจูู - ${getCurrencySymbol(currency)}`,
            debitAmount: amount,
            creditAmount: amount,
            currency: currency,
            referenceType: 'payment',
            referenceId: newPayment.id,
            createdAt: new Date().toISOString()
        };

        appData.journalEntries.push(journalEntry);
        console.log('๐ ุชู ุฅุถุงูุฉ ุงูููุฏ ุงููุญุงุณุจู:', journalEntry);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();
        console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
        modal.hide();

        const currencyText = getCurrencySymbol(currency);
        const successMessage = `โ ุชู ุญูุธ ุณูุฏ ุงูุฏูุน ุจูุฌุงุญ!

๐ ุฑูู ุงูุณูุฏ: ${paymentNumber}
๐ข ุงูููุฑุฏ: ${supplier.name}
๐ฐ ุงููุจูุบ: ${amount.toFixed(2)} ${currencyText}
๐ณ ุทุฑููุฉ ุงูุฏูุน: ${getPaymentMethodText(method)}
๐ ุงูุชุงุฑูุฎ: ${date}

ูู ุชุฑูุฏ ุทุจุงุนุฉ ุงูุณูุฏุ`;

        if (confirm(successMessage)) {
            printPayment(newPayment.id);
        } else {
            showPage('payments');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุณูุฏ ุงูุฏูุน:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุณูุฏ ุงูุฏูุน: ' + error.message);
    }
}

// ูุธุงุฆู ุงูุชูุงุฑูุฑ
function getJournalEntriesRows() {
    // ุฌูุน ุฌููุน ุงููููุฏ ูู ูุตุงุฏุฑ ูุฎุชููุฉ
    let allEntries = [];

    // 1. ุงููููุฏ ุงููุฏููุฉ ุงูููุฌูุฏุฉ
    if (appData.journalEntries && appData.journalEntries.length > 0) {
        allEntries = [...appData.journalEntries];
    }

    // 2. ูููุฏ ูู ุงูููุงุชูุฑ
    if (appData.invoices && appData.invoices.length > 0) {
        appData.invoices.forEach(invoice => {
            if (invoice.status === 'confirmed' && invoice.isDeleted !== true) {
                const client = invoice.invoiceType === 'sale' ?
                    appData.customers.find(c => c.id === invoice.customerId) :
                    appData.suppliers.find(s => s.id === invoice.supplierId);

                const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';
                const invoiceTypeText = invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช';

                if (invoice.invoiceType === 'sale') {
                    // ููุฏ ูุงุชูุฑุฉ ุงููุจูุนุงุช
                    allEntries.push({
                        entryDate: invoice.invoiceDate,
                        entryType: 'sale_invoice',
                        description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                        debitAccount: `ุงูุนููุงุก - ${clientName}`,
                        creditAccount: 'ุงููุจูุนุงุช',
                        debitAmount: invoice.totalAmount,
                        creditAmount: invoice.totalAmount,
                        currency: invoice.currency || 'SYP',
                        referenceType: 'invoice',
                        referenceId: invoice.invoiceNumber,
                        source: 'invoice'
                    });
                } else {
                    // ููุฏ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช
                    allEntries.push({
                        entryDate: invoice.invoiceDate,
                        entryType: 'purchase_invoice',
                        description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber} - ${clientName}`,
                        debitAccount: 'ุงููุดุชุฑูุงุช',
                        creditAccount: `ุงูููุฑุฏูู - ${clientName}`,
                        debitAmount: invoice.totalAmount,
                        creditAmount: invoice.totalAmount,
                        currency: invoice.currency || 'SYP',
                        referenceType: 'invoice',
                        referenceId: invoice.invoiceNumber,
                        source: 'invoice'
                    });
                }
            }
        });
    }

    // 3. ูููุฏ ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน
    if (appData.payments && appData.payments.length > 0) {
        appData.payments.forEach(payment => {
            if (payment.status === 'confirmed' && payment.isDeleted !== true) {
                const client = payment.paymentType === 'receipt' ?
                    appData.customers.find(c => c.id === payment.customerId) :
                    appData.suppliers.find(s => s.id === payment.supplierId);

                const clientName = client ? client.name : 'ุบูุฑ ูุญุฏุฏ';

                if (payment.paymentType === 'receipt') {
                    // ููุฏ ุณูุฏ ุงููุจุถ
                    allEntries.push({
                        entryDate: payment.paymentDate,
                        entryType: 'receipt',
                        description: `ุณูุฏ ูุจุถ ุฑูู ${payment.paymentNumber} - ${clientName}`,
                        debitAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                        creditAccount: `ุงูุนููุงุก - ${clientName}`,
                        debitAmount: payment.amount,
                        creditAmount: payment.amount,
                        currency: payment.currency || 'SYP',
                        referenceType: 'receipt',
                        referenceId: payment.paymentNumber,
                        source: 'payment'
                    });
                } else {
                    // ููุฏ ุณูุฏ ุงูุฏูุน
                    allEntries.push({
                        entryDate: payment.paymentDate,
                        entryType: 'payment',
                        description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber} - ${clientName}`,
                        debitAccount: `ุงูููุฑุฏูู - ${clientName}`,
                        creditAccount: payment.paymentMethod === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                        debitAmount: payment.amount,
                        creditAmount: payment.amount,
                        currency: payment.currency || 'SYP',
                        referenceType: 'payment',
                        referenceId: payment.paymentNumber,
                        source: 'payment'
                    });
                }
            }
        });
    }

    // 4. ูููุฏ ูู ุญุฑูุงุช ุงููุฎุฒูู
    if (appData.inventoryMovements && appData.inventoryMovements.length > 0) {
        appData.inventoryMovements.forEach(movement => {
            if (movement.isDeleted !== true && movement.unitPrice > 0) {
                const product = appData.products.find(p => p.id === movement.productId);
                const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

                const productName = product ? product.name : 'ุบูุฑ ูุญุฏุฏ';
                const warehouseName = warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ';
                const totalValue = movement.quantity * movement.unitPrice;

                const movementTypeText = {
                    'in': 'ุฅุฏุฎุงู ูุฎุฒูู',
                    'out': 'ุฅุฎุฑุงุฌ ูุฎุฒูู',
                    'transfer': 'ุชุญููู ูุฎุฒูู',
                    'adjustment': 'ุชุณููุฉ ูุฎุฒูู'
                };

                if (movement.movementType === 'in') {
                    allEntries.push({
                        entryDate: movement.date,
                        entryType: 'inventory_in',
                        description: `${movementTypeText[movement.movementType]} - ${productName} - ${warehouseName}`,
                        debitAccount: 'ุงููุฎุฒูู',
                        creditAccount: movement.reference || 'ุญุณุงุจ ูุคูุช',
                        debitAmount: totalValue,
                        creditAmount: totalValue,
                        currency: 'SYP',
                        referenceType: 'movement',
                        referenceId: movement.reference || movement.id,
                        source: 'inventory'
                    });
                } else if (movement.movementType === 'out') {
                    allEntries.push({
                        entryDate: movement.date,
                        entryType: 'inventory_out',
                        description: `${movementTypeText[movement.movementType]} - ${productName} - ${warehouseName}`,
                        debitAccount: 'ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ',
                        creditAccount: 'ุงููุฎุฒูู',
                        debitAmount: totalValue,
                        creditAmount: totalValue,
                        currency: 'SYP',
                        referenceType: 'movement',
                        referenceId: movement.reference || movement.id,
                        source: 'inventory'
                    });
                }
            }
        });
    }

    if (allEntries.length === 0) {
        return '<tr><td colspan="9" class="text-center text-muted">ูุง ุชูุฌุฏ ูููุฏ ูุญุงุณุจูุฉ</td></tr>';
    }

    // ุชุฑุชูุจ ุงููููุฏ ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
    allEntries.sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate));

    let html = '';
    let totalDebit = 0;
    let totalCredit = 0;

    allEntries.forEach(entry => {
        totalDebit += entry.debitAmount || 0;
        totalCredit += entry.creditAmount || 0;

        const entryTypeText = {
            'sale_invoice': 'ูุงุชูุฑุฉ ูุจูุนุงุช',
            'purchase_invoice': 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช',
            'receipt': 'ุณูุฏ ูุจุถ',
            'payment': 'ุณูุฏ ุฏูุน',
            'inventory_in': 'ุฅุฏุฎุงู ูุฎุฒูู',
            'inventory_out': 'ุฅุฎุฑุงุฌ ูุฎุฒูู',
            'inventory_transfer': 'ุชุญููู ูุฎุฒูู',
            'inventory_adjustment': 'ุชุณููุฉ ูุฎุฒูู',
            'adjustment': 'ุชุณููุฉ ุนุงูุฉ',
            'opening': 'ุฑุตูุฏ ุงูุชุชุงุญู',
            'closing': 'ุฑุตูุฏ ุฎุชุงูู',
            'manual': 'ููุฏ ูุฏูู'
        };

        const typeColor = {
            'sale_invoice': 'success',
            'purchase_invoice': 'primary',
            'receipt': 'info',
            'payment': 'warning',
            'inventory_in': 'success',
            'inventory_out': 'danger',
            'inventory_transfer': 'info',
            'inventory_adjustment': 'warning',
            'adjustment': 'secondary',
            'opening': 'dark',
            'closing': 'dark',
            'manual': 'light'
        };

        html += `
            <tr>
                <td>${entry.entryDate}</td>
                <td><span class="badge bg-${typeColor[entry.entryType] || 'secondary'}">${entryTypeText[entry.entryType] || entry.entryType}</span></td>
                <td>${entry.description}</td>
                <td>${entry.debitAccount}</td>
                <td>${entry.creditAccount}</td>
                <td>${formatCurrency(entry.debitAmount || 0, entry.currency)}</td>
                <td>${formatCurrency(entry.creditAmount || 0, entry.currency)}</td>
                <td>${getCurrencySymbol(entry.currency || 'SYP')}</td>
                <td>${entry.referenceId || '-'}</td>
            </tr>
        `;
    });

    // ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช
    setTimeout(() => {
        const totalDebitElement = document.getElementById('totalDebit');
        const totalCreditElement = document.getElementById('totalCredit');
        const balanceStatusElement = document.getElementById('balanceStatus');

        // ุงูุชุญูู ูู ูุฌูุฏ ุนููุงุช ูุชุนุฏุฏุฉ ูู ุงููุชุงุฆุฌ
        const currencies = [...new Set(allEntries.map(entry => entry.currency || 'SYP'))];
        const currencyDisplay = currencies.length === 1 ? ` ${getCurrencySymbol(currencies[0])}` : '';

        if (totalDebitElement) totalDebitElement.textContent = formatCurrency(totalDebit) + currencyDisplay;
        if (totalCreditElement) totalCreditElement.textContent = formatCurrency(totalCredit) + currencyDisplay;

        // ุชุญุฏูุซ ุญุงูุฉ ุงูุชูุงุฒู
        if (balanceStatusElement) {
            const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
            balanceStatusElement.innerHTML = isBalanced ?
                '<span class="badge bg-success">ูุชูุงุฒู</span>' :
                '<span class="badge bg-danger">ุบูุฑ ูุชูุงุฒู</span>';
        }

        // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูููุตูุฉ
        const totalEntriesElement = document.getElementById('totalEntries');
        const usedCurrenciesElement = document.getElementById('usedCurrencies');
        const balanceStatusTextElement = document.getElementById('balanceStatusText');

        if (totalEntriesElement) totalEntriesElement.textContent = allEntries.length;
        if (usedCurrenciesElement) usedCurrenciesElement.textContent = currencies.length;
        if (balanceStatusTextElement) {
            const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
            balanceStatusTextElement.textContent = isBalanced ? 'ูุชูุงุฒู' : 'ุบูุฑ ูุชูุงุฒู';
            balanceStatusTextElement.className = isBalanced ? 'text-success' : 'text-danger';
        }
    }, 100);

    return html;
}

function getReceiptsRows(receipts) {
    if (receipts.length === 0) {
        return '<tr><td colspan="8" class="text-center text-muted">ูุง ุชูุฌุฏ ุณูุฏุงุช ูุจุถ</td></tr>';
    }

    let html = '';
    receipts.forEach(receipt => {
        const customer = appData.customers.find(c => c.id === receipt.customerId);
        const methodText = {
            'cash': 'ููุฏู',
            'bank': 'ุชุญููู ุจููู',
            'check': 'ุดูู',
            'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
        };

        html += `
            <tr>
                <td><strong>${receipt.paymentNumber}</strong></td>
                <td>${customer ? customer.name : '-'}</td>
                <td>${receipt.paymentDate}</td>
                <td>${formatCurrency(receipt.amount, receipt.currency)}</td>
                <td><span class="badge bg-info">${methodText[receipt.paymentMethod] || receipt.paymentMethod}</span></td>
                <td>${receipt.referenceNumber || '-'}</td>
                <td><span class="badge bg-${receipt.status === 'confirmed' ? 'success' : 'warning'}">${receipt.status === 'confirmed' ? 'ูุคูุฏ' : 'ูุนูู'}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReceipt(${receipt.id})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printReceipt(${receipt.id})" title="ุทุจุงุนุฉ">
                            <i class="fas fa-print"></i>
                        </button>

                        <button class="btn btn-sm btn-outline-info" onclick="editReceipt(${receipt.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReceipt(${receipt.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

function getPaymentsRows(payments) {
    if (payments.length === 0) {
        return '<tr><td colspan="8" class="text-center text-muted">ูุง ุชูุฌุฏ ุณูุฏุงุช ุฏูุน</td></tr>';
    }

    let html = '';
    payments.forEach(payment => {
        const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
        const methodText = {
            'cash': 'ููุฏู',
            'bank': 'ุชุญููู ุจููู',
            'check': 'ุดูู',
            'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
        };

        html += `
            <tr>
                <td><strong>${payment.paymentNumber}</strong></td>
                <td>${supplier ? supplier.name : '-'}</td>
                <td>${payment.paymentDate}</td>
                <td>${formatCurrency(payment.amount, payment.currency)}</td>
                <td><span class="badge bg-info">${methodText[payment.paymentMethod] || payment.paymentMethod}</span></td>
                <td>${payment.referenceNumber || '-'}</td>
                <td><span class="badge bg-${payment.status === 'confirmed' ? 'success' : 'warning'}">${payment.status === 'confirmed' ? 'ูุคูุฏ' : 'ูุนูู'}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})" title="ุนุฑุถ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printPayment(${payment.id})" title="ุทุจุงุนุฉ">
                            <i class="fas fa-print"></i>
                        </button>

                        <button class="btn btn-sm btn-outline-info" onclick="editPayment(${payment.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id})" title="ุญุฐู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    return html;
}

function loadCustomerStatement() {
    console.log('๐ ุชุญููู ูุดู ุญุณุงุจ ุงูุนููู...');

    const customerId = document.getElementById('statementCustomer').value;
    const fromDate = document.getElementById('statementFromDate').value;
    const toDate = document.getElementById('statementToDate').value;

    if (customerId) {
        document.getElementById('customerInfo').style.display = 'block';
        document.getElementById('noCustomerSelected').style.display = 'none';

        const customer = appData.customers.find(c => c.id == customerId);
        if (customer) {
            console.log('๐ค ุงูุนููู ุงููุญุฏุฏ:', customer.name);

            // ุนุฑุถ ูุนูููุงุช ุงูุนููู
            document.getElementById('customerName').textContent = customer.name;
            document.getElementById('customerAddress').textContent = customer.address || 'ุบูุฑ ูุญุฏุฏ';
            document.getElementById('customerPhone').textContent = customer.phone || 'ุบูุฑ ูุญุฏุฏ';
            document.getElementById('customerEmail').textContent = customer.email || 'ุบูุฑ ูุญุฏุฏ';

            // ุฌูุน ุฌููุน ุงูุญุฑูุงุช ุงููุงููุฉ ููุนููู
            const transactions = [];
            let runningBalance = 0;

            // ุฅุถุงูุฉ ุงูููุงุชูุฑ
            const customerInvoices = appData.invoices.filter(inv =>
                inv.customerId == customerId &&
                inv.status === 'confirmed' &&
                (!fromDate || inv.invoiceDate >= fromDate) &&
                (!toDate || inv.invoiceDate <= toDate)
            );

            customerInvoices.forEach(invoice => {
                const debitAmount = invoice.totalAmount || 0;
                runningBalance += debitAmount;

                transactions.push({
                    date: invoice.invoiceDate,
                    description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber}`,
                    reference: invoice.invoiceNumber,
                    debit: debitAmount,
                    credit: 0,
                    balance: runningBalance,
                    type: 'invoice',
                    id: invoice.id
                });
            });

            // ุฅุถุงูุฉ ุณูุฏุงุช ุงููุจุถ
            const customerReceipts = appData.payments.filter(payment =>
                payment.customerId == customerId &&
                payment.paymentType === 'receipt' &&
                payment.status === 'confirmed' &&
                (!fromDate || payment.paymentDate >= fromDate) &&
                (!toDate || payment.paymentDate <= toDate)
            );

            customerReceipts.forEach(receipt => {
                const creditAmount = receipt.amount || 0;
                runningBalance -= creditAmount;

                const currencyText = receipt.currencySymbol || receipt.currency || 'ู.ุณ';

                transactions.push({
                    date: receipt.paymentDate,
                    description: `ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber} - ${getPaymentMethodText(receipt.paymentMethod)}`,
                    reference: receipt.paymentNumber,
                    debit: 0,
                    credit: creditAmount,
                    balance: runningBalance,
                    type: 'receipt',
                    id: receipt.id,
                    currency: currencyText
                });
            });

            // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงููุชุฑุงููุฉ
            let balance = 0;
            transactions.forEach(transaction => {
                balance += transaction.debit - transaction.credit;
                transaction.balance = balance;
            });

            // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ูู ุงููุงุฌูุฉ
            const previousBalance = 0; // ูููู ุชุญุณููู ูุงุญูุงู ูุญุณุงุจ ุงูุฑุตูุฏ ุงูุณุงุจู
            const currentBalance = balance;

            document.getElementById('previousBalance').textContent = formatCurrency(previousBalance);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);

            // ุชุญุฏูุซ ุฌุฏูู ูุดู ุงูุญุณุงุจ
            const tableBody = document.getElementById('statementTable');
            if (transactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>ูุง ุชูุฌุฏ ุญุฑูุงุช ูู ูุฐู ุงููุชุฑุฉ</td></tr>';
            } else {
                tableBody.innerHTML = transactions.map(transaction => {
                    const balanceClass = transaction.balance > 0 ? 'text-danger' : transaction.balance < 0 ? 'text-success' : 'text-muted';
                    const currencySymbol = transaction.currency || appData.settings.currencySymbol || 'ู.ุณ';

                    return `
                        <tr>
                            <td>${transaction.date}</td>
                            <td>${transaction.description}</td>
                            <td>
                                <span class="badge bg-${transaction.type === 'invoice' ? 'primary' : 'success'}">
                                    ${transaction.reference}
                                </span>
                            </td>
                            <td class="text-end">
                                ${transaction.debit > 0 ? formatCurrency(transaction.debit) : '-'}
                            </td>
                            <td class="text-end">
                                ${transaction.credit > 0 ? formatCurrency(transaction.credit) : '-'}
                            </td>
                            <td class="text-end">
                                <strong class="${balanceClass}">
                                    ${formatCurrency(Math.abs(transaction.balance))} ${transaction.balance < 0 ? '(ุฏุงุฆู)' : '(ูุฏูู)'}
                                </strong>
                            </td>
                        </tr>
                    `;
                }).join('');

                // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
                const totalDebits = transactions.reduce((sum, t) => sum + t.debit, 0);
                const totalCredits = transactions.reduce((sum, t) => sum + t.credit, 0);
                const finalBalance = totalDebits - totalCredits;
                const finalBalanceClass = finalBalance > 0 ? 'text-danger' : finalBalance < 0 ? 'text-success' : 'text-muted';

                tableBody.innerHTML += `
                    <tr class="table-info">
                        <td colspan="3"><strong>ุงูุฅุฌูุงููุงุช:</strong></td>
                        <td class="text-end"><strong>${formatCurrency(totalDebits)}</strong></td>
                        <td class="text-end"><strong>${formatCurrency(totalCredits)}</strong></td>
                        <td class="text-end">
                            <strong class="${finalBalanceClass}">
                                ${formatCurrency(Math.abs(finalBalance))} ${finalBalance < 0 ? '(ุฏุงุฆู)' : '(ูุฏูู)'}
                            </strong>
                        </td>
                    </tr>
                `;
            }

            console.log(`โ ุชู ุชุญููู ูุดู ุงูุญุณุงุจ: ${transactions.length} ุญุฑูุฉุ ุงูุฑุตูุฏ ุงูููุงุฆู: ${formatCurrency(currentBalance)}`);
        }
    } else {
        document.getElementById('customerInfo').style.display = 'none';
        document.getElementById('noCustomerSelected').style.display = 'block';
    }
}

/**
 * ุชุทุจูู ููุงุชุฑ ุญุฑูุฉ ุงููุฎุฒูู
 */
function applyInventoryMovementsFilter() {
    const typeFilter = document.getElementById('movementTypeFilter')?.value || '';
    const productFilter = document.getElementById('productFilter')?.value || '';
    const warehouseFilter = document.getElementById('warehouseFilter')?.value || '';
    const fromDate = document.getElementById('fromDate')?.value || '';
    const toDate = document.getElementById('toDate')?.value || '';
    const searchText = document.getElementById('movementSearch')?.value.toLowerCase() || '';

    let filteredMovements = appData.inventoryMovements || [];

    // ุชุทุจูู ููุชุฑ ููุน ุงูุญุฑูุฉ
    if (typeFilter) {
        filteredMovements = filteredMovements.filter(movement => movement.movementType === typeFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุตูู
    if (productFilter) {
        filteredMovements = filteredMovements.filter(movement => movement.productId == productFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงููุฎุฒู
    if (warehouseFilter) {
        filteredMovements = filteredMovements.filter(movement => movement.warehouseId == warehouseFilter);
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredMovements = filteredMovements.filter(movement => movement.date >= fromDate);
    }
    if (toDate) {
        filteredMovements = filteredMovements.filter(movement => movement.date <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredMovements = filteredMovements.filter(movement => {
            const reference = (movement.reference || '').toLowerCase();
            const notes = (movement.notes || '').toLowerCase();

            return reference.includes(searchText) || notes.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateInventoryMovementsTable(filteredMovements);
}

/**
 * ูุณุญ ููุงุชุฑ ุญุฑูุฉ ุงููุฎุฒูู
 */
function clearInventoryMovementsFilter() {
    const typeFilter = document.getElementById('movementTypeFilter');
    const productFilter = document.getElementById('productFilter');
    const warehouseFilter = document.getElementById('warehouseFilter');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const searchText = document.getElementById('movementSearch');

    if (typeFilter) typeFilter.value = '';
    if (productFilter) productFilter.value = '';
    if (warehouseFilter) warehouseFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchText) searchText.value = '';

    // ุนุฑุถ ุฌููุน ุงูุญุฑูุงุช
    updateInventoryMovementsTable(appData.inventoryMovements || []);
}

/**
 * ุชุทุจูู ููุงุชุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function applyInventoryDetailsFilter() {
    const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
    const productFilter = document.getElementById('detailsProductFilter')?.value || '';
    const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
    const fromDate = document.getElementById('detailsFromDate')?.value || '';
    const toDate = document.getElementById('detailsToDate')?.value || '';
    const searchText = document.getElementById('detailsMovementSearch')?.value.toLowerCase() || '';

    let movements = appData.inventoryMovements || [];

    // ุชุทุจูู ุงูููุงุชุฑ
    if (typeFilter) {
        movements = movements.filter(movement => movement.movementType === typeFilter);
    }

    if (productFilter) {
        movements = movements.filter(movement => movement.productId == productFilter);
    }

    if (warehouseFilter) {
        movements = movements.filter(movement => movement.warehouseId == warehouseFilter);
    }

    if (fromDate) {
        movements = movements.filter(movement => movement.date >= fromDate);
    }

    if (toDate) {
        movements = movements.filter(movement => movement.date <= toDate);
    }

    if (searchText) {
        movements = movements.filter(movement => {
            const reference = (movement.reference || '').toLowerCase();
            const notes = (movement.notes || '').toLowerCase();
            return reference.includes(searchText) || notes.includes(searchText);
        });
    }

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateInventoryDetailsTable(movements);

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    updateInventoryDetailsStats(movements);
}

/**
 * ูุณุญ ููุงุชุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function clearInventoryDetailsFilter() {
    const typeFilter = document.getElementById('detailsMovementTypeFilter');
    const productFilter = document.getElementById('detailsProductFilter');
    const warehouseFilter = document.getElementById('detailsWarehouseFilter');
    const fromDate = document.getElementById('detailsFromDate');
    const toDate = document.getElementById('detailsToDate');
    const searchInput = document.getElementById('detailsMovementSearch');

    if (typeFilter) typeFilter.value = '';
    if (productFilter) productFilter.value = '';
    if (warehouseFilter) warehouseFilter.value = '';
    if (fromDate) fromDate.value = '';
    if (toDate) toDate.value = '';
    if (searchInput) searchInput.value = '';

    // ุนุฑุถ ุฌููุน ุงูุญุฑูุงุช
    updateInventoryDetailsTable(appData.inventoryMovements || []);
    updateInventoryDetailsStats();
}

/**
 * ุนุฑุถ ุงูุฅุฎุฑุงุฌุงุช ููุท
 */
function showOnlyOutMovements() {
    document.getElementById('detailsMovementTypeFilter').value = 'out';
    applyInventoryDetailsFilter();
}

/**
 * ุนุฑุถ ุงูุฅุฏุฎุงูุงุช ููุท
 */
function showOnlyInMovements() {
    document.getElementById('detailsMovementTypeFilter').value = 'in';
    applyInventoryDetailsFilter();
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function updateInventoryDetailsTable(movements) {
    const tableContainer = document.querySelector('#inventoryDetailsTable');
    if (!tableContainer) return;

    if (movements && movements.length > 0) {
        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)
        const sortedMovements = movements.sort((a, b) => new Date(b.date) - new Date(a.date));

        let html = '';
        sortedMovements.forEach((movement, index) => {
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

            const typeText = {
                'in': 'ุฅุฏุฎุงู',
                'out': 'ุฅุฎุฑุงุฌ',
                'transfer': 'ุชุญููู',
                'adjustment': 'ุชุณููุฉ',
                'sale': 'ูุจูุนุงุช',
                'purchase': 'ูุดุชุฑูุงุช',
                'return': 'ูุฑุชุฌุนุงุช'
            };

            const typeColor = {
                'in': 'success',
                'out': 'danger',
                'transfer': 'info',
                'adjustment': 'warning',
                'sale': 'primary',
                'purchase': 'secondary',
                'return': 'dark'
            };

            const typeIcon = {
                'in': 'fa-arrow-up',
                'out': 'fa-arrow-down',
                'transfer': 'fa-exchange-alt',
                'adjustment': 'fa-balance-scale',
                'sale': 'fa-shopping-cart',
                'purchase': 'fa-shopping-bag',
                'return': 'fa-undo'
            };

            let reason = movement.reference || '-';
            let reasonClass = '';

            if (movement.reference) {
                if (movement.reference.includes('ูุงุชูุฑุฉ')) {
                    reasonClass = 'text-primary';
                } else if (movement.reference.includes('ุชุญููู')) {
                    reasonClass = 'text-info';
                } else if (movement.reference.includes('ุชุณููุฉ')) {
                    reasonClass = 'text-warning';
                }
            }

            const user = movement.userId ? 'ูุณุชุฎุฏู ' + movement.userId : 'ุงููุธุงู';

            html += `
                <tr class="movement-row">
                    <td class="text-center">
                        <small>${movement.date}</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-${typeColor[movement.movementType]} d-flex align-items-center justify-content-center" style="min-width: 80px;">
                            <i class="fas ${typeIcon[movement.movementType]} me-1"></i>
                            ${typeText[movement.movementType] || movement.movementType}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong class="text-dark">${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</strong>
                            <small class="text-muted">${product ? product.code : '-'}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</span>
                    </td>
                    <td class="text-center">
                        <strong class="text-${movement.movementType === 'out' ? 'danger' : 'success'}">
                            ${movement.movementType === 'out' ? '-' : '+'}${movement.quantity}
                        </strong>
                    </td>
                    <td class="text-center">
                        <small class="text-muted">${product ? product.unit : '-'}</small>
                    </td>
                    <td class="text-end">
                        ${formatCurrency(movement.unitPrice || 0)}
                    </td>
                    <td class="text-end">
                        <strong>${formatCurrency(movement.totalAmount || (movement.quantity * (movement.unitPrice || 0)))}</strong>
                    </td>
                    <td class="${reasonClass}">
                        <small>${reason}</small>
                    </td>
                    <td class="text-center">
                        <small class="text-muted">${user}</small>
                    </td>
                    <td>
                        <small class="text-muted">${movement.notes || '-'}</small>
                    </td>
                </tr>
            `;
        });

        tableContainer.innerHTML = html;
    } else {
        tableContainer.innerHTML = '<tr><td colspan="11" class="text-center text-muted">ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู</td></tr>';
    }

    // ุชุญุฏูุซ ุนุฏุงุฏ ุงูุญุฑูุงุช
    const countElement = document.getElementById('movementsCount');
    if (countElement) {
        countElement.textContent = movements ? movements.length : 0;
    }
}

/**
 * ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู - ูุญุณู ูุดุงูู
 */
function updateInventoryDetailsStats(movements = null) {
    const allMovements = movements || appData.inventoryMovements || [];

    // ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุดุงููุฉ
    const stats = {
        totalMovements: allMovements.length,
        inMovements: 0,
        outMovements: 0,
        transferMovements: 0,
        adjustmentMovements: 0,
        saleMovements: 0,
        purchaseMovements: 0,
        returnMovements: 0,
        damageMovements: 0,
        totalQuantityIn: 0,
        totalQuantityOut: 0,
        totalValue: 0,
        uniqueProducts: new Set(),
        uniqueWarehouses: new Set(),
        dateRange: { earliest: null, latest: null }
    };

    allMovements.forEach(movement => {
        const quantity = parseFloat(movement.quantity) || 0;
        const unitPrice = parseFloat(movement.unitPrice) || 0;
        const value = Math.abs(quantity) * unitPrice;

        stats.totalValue += value;
        stats.uniqueProducts.add(movement.productId);
        stats.uniqueWarehouses.add(movement.warehouseId);

        // ุชุญุฏูุฏ ูุทุงู ุงูุชูุงุฑูุฎ
        const movementDate = new Date(movement.date);
        if (!stats.dateRange.earliest || movementDate < stats.dateRange.earliest) {
            stats.dateRange.earliest = movementDate;
        }
        if (!stats.dateRange.latest || movementDate > stats.dateRange.latest) {
            stats.dateRange.latest = movementDate;
        }

        // ุชุตููู ุงูุญุฑูุงุช
        switch (movement.movementType) {
            case 'in':
            case 'transfer_in':
                stats.inMovements++;
                stats.totalQuantityIn += Math.abs(quantity);
                break;
            case 'out':
            case 'transfer_out':
                stats.outMovements++;
                stats.totalQuantityOut += Math.abs(quantity);
                break;
            case 'transfer':
                stats.transferMovements++;
                break;
            case 'adjustment':
                stats.adjustmentMovements++;
                if (quantity >= 0) {
                    stats.totalQuantityIn += quantity;
                } else {
                    stats.totalQuantityOut += Math.abs(quantity);
                }
                break;
            case 'sale':
                stats.saleMovements++;
                stats.totalQuantityOut += Math.abs(quantity);
                break;
            case 'purchase':
                stats.purchaseMovements++;
                stats.totalQuantityIn += Math.abs(quantity);
                break;
            case 'return_sale':
                stats.returnMovements++;
                stats.totalQuantityIn += Math.abs(quantity);
                break;
            case 'return_purchase':
                stats.returnMovements++;
                stats.totalQuantityOut += Math.abs(quantity);
                break;
            case 'damage':
                stats.damageMovements++;
                stats.totalQuantityOut += Math.abs(quantity);
                break;
        }
    });

    // ุชุญุฏูุซ ุงูุนูุงุตุฑ ูู ุงูุตูุญุฉ
    const elements = {
        'totalMovements': stats.totalMovements,
        'totalInMovements': stats.inMovements,
        'totalOutMovements': stats.outMovements,
        'totalTransferMovements': stats.transferMovements,
        'totalAdjustmentMovements': stats.adjustmentMovements,
        'totalSaleMovements': stats.saleMovements,
        'totalPurchaseMovements': stats.purchaseMovements,
        'totalReturnMovements': stats.returnMovements,
        'totalDamageMovements': stats.damageMovements,
        'totalQuantityIn': stats.totalQuantityIn.toFixed(2),
        'totalQuantityOut': stats.totalQuantityOut.toFixed(2),
        'netQuantity': (stats.totalQuantityIn - stats.totalQuantityOut).toFixed(2),
        'totalMovementsValue': formatCurrency(stats.totalValue),
        'uniqueProductsCount': stats.uniqueProducts.size,
        'uniqueWarehousesCount': stats.uniqueWarehouses.size
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });

    // ุชุญุฏูุซ ูุทุงู ุงูุชูุงุฑูุฎ
    const dateRangeElement = document.getElementById('movementsDateRange');
    if (dateRangeElement && stats.dateRange.earliest && stats.dateRange.latest) {
        const earliestStr = stats.dateRange.earliest.toLocaleDateString('ar-SY');
        const latestStr = stats.dateRange.latest.toLocaleDateString('ar-SY');
        dateRangeElement.textContent = `ูู ${earliestStr} ุฅูู ${latestStr}`;
    }

    // ุชุญุฏูุซ ูุคุดุฑุงุช ุงูุฃุฏุงุก
    updatePerformanceIndicators(stats);

    return stats;
}

/**
 * ุชุญุฏูุซ ูุคุดุฑุงุช ุงูุฃุฏุงุก
 */
function updatePerformanceIndicators(stats) {
    // ุญุณุงุจ ูุนุฏู ุงูุญุฑูุฉ ุงูููููุฉ
    if (stats.dateRange.earliest && stats.dateRange.latest) {
        const daysDiff = Math.ceil((stats.dateRange.latest - stats.dateRange.earliest) / (1000 * 60 * 60 * 24)) || 1;
        const dailyMovementRate = (stats.totalMovements / daysDiff).toFixed(1);

        const dailyRateElement = document.getElementById('dailyMovementRate');
        if (dailyRateElement) {
            dailyRateElement.textContent = `${dailyMovementRate} ุญุฑูุฉ/ููู`;
        }
    }

    // ุญุณุงุจ ูุชูุณุท ูููุฉ ุงูุญุฑูุฉ
    const avgMovementValue = stats.totalMovements > 0 ? (stats.totalValue / stats.totalMovements) : 0;
    const avgValueElement = document.getElementById('avgMovementValue');
    if (avgValueElement) {
        avgValueElement.textContent = formatCurrency(avgMovementValue);
    }

    // ุญุณุงุจ ูุณุจุฉ ุงูุฅุฏุฎุงู ุฅูู ุงูุฅุฎุฑุงุฌ
    const inOutRatio = stats.totalQuantityOut > 0 ? (stats.totalQuantityIn / stats.totalQuantityOut) : 0;
    const ratioElement = document.getElementById('inOutRatio');
    if (ratioElement) {
        ratioElement.textContent = `${inOutRatio.toFixed(2)}:1`;
        ratioElement.className = `badge ${inOutRatio >= 1 ? 'bg-success' : 'bg-warning'}`;
    }
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function updateInventoryMovementsTable(movements) {
    const tableContainer = document.querySelector('#inventoryMovementsTable') ||
                          document.querySelector('#main-content .table tbody');
    if (!tableContainer) return;

    if (movements.length > 0) {
        let totalIn = 0;
        let totalOut = 0;

        tableContainer.innerHTML = movements.map(movement => {
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
            const totalAmount = movement.quantity * movement.unitPrice;

            if (movement.movementType === 'in') {
                totalIn += totalAmount;
            } else if (movement.movementType === 'out') {
                totalOut += totalAmount;
            }

            return `
                <tr>
                    <td>${movement.date}</td>
                    <td>
                        <span class="badge bg-${movement.movementType === 'in' ? 'success' : movement.movementType === 'out' ? 'danger' : 'warning'}">
                            ${getMovementTypeText(movement.movementType)}
                        </span>
                    </td>
                    <td>${product ? product.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                    <td>${warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                    <td>
                        <span class="badge bg-${movement.movementType === 'in' ? 'success' : 'danger'}">
                            ${movement.movementType === 'in' ? '+' : '-'}${movement.quantity} ${product ? product.unit : ''}
                        </span>
                    </td>
                    <td>${formatCurrency(movement.unitPrice)}</td>
                    <td>${formatCurrency(totalAmount)}</td>
                    <td>${movement.reference || '-'}</td>
                    <td>${movement.notes || '-'}</td>
                </tr>
            `;
        }).join('');

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        tableContainer.innerHTML += `
            <tr class="table-info">
                <td colspan="6"><strong>ุงูุฅุฌูุงููุงุช:</strong></td>
                <td><strong>ุฅุฏุฎุงู: ${formatCurrency(totalIn)}</strong></td>
                <td><strong>ุฅุฎุฑุงุฌ: ${formatCurrency(totalOut)}</strong></td>
                <td><strong>ุงูุตุงูู: ${formatCurrency(totalIn - totalOut)}</strong></td>
            </tr>
        `;

    } else {
        tableContainer.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="fas fa-exchange-alt fa-3x mb-3"></i>
                    <h5>ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</h5>
                    <p>ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ูุณุญูุง</p>
                    <button class="btn btn-primary" onclick="clearInventoryMovementsFilter()">
                        <i class="fas fa-times me-2"></i>ูุณุญ ุงูููุงุชุฑ
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * ุงูุญุตูู ุนูู ูุต ููุน ุงูุญุฑูุฉ
 */
function getMovementTypeText(type) {
    const types = {
        'in': 'ุฅุฏุฎุงู',
        'out': 'ุฅุฎุฑุงุฌ',
        'transfer': 'ุชุญููู',
        'adjustment': 'ุชุณููุฉ'
    };
    return types[type] || type;
}

/**
 * ุงูุญุตูู ุนูู ูุต ุทุฑููุฉ ุงูุฏูุน
 */
function getPaymentMethodText(method) {
    const methods = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };
    return methods[method] || method;
}

/**
 * ุงูุญุตูู ุนูู ูุนูููุงุช ููุน ุงูููุฏ
 */
function getEntryTypeInfo(entry) {
    if (entry.invoiceId || entry.referenceType === 'invoice') {
        return {
            text: 'ูุงุชูุฑุฉ',
            color: 'primary',
            icon: 'fas fa-file-invoice'
        };
    } else if (entry.paymentId || entry.referenceType === 'payment') {
        return {
            text: 'ุณูุฏ',
            color: 'success',
            icon: 'fas fa-money-bill'
        };
    } else {
        return {
            text: 'ุชุณููุฉ',
            color: 'warning',
            icon: 'fas fa-balance-scale'
        };
    }
}

/**
 * ุงูุญุตูู ุนูู ุฑูุฒ ุงูุนููุฉ
 */
function getCurrencySymbol(currency) {
    const symbols = {
        'SYP': 'ู.ุณ',
        'USD': '$',
        'EUR': 'โฌ',
        'TRY': 'โบ',
        'SAR': 'ุฑ.ุณ',
        'AED': 'ุฏ.ุฅ'
    };
    return symbols[currency] || currency;
}

/**
 * ุชูุณูู ุงูุชุงุฑูุฎ ุจุตูุบุฉ ุตุญูุญุฉ
 */
function formatDate(dateString) {
    if (!dateString) return '-';

    try {
        const date = new Date(dateString);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
        if (isNaN(date.getTime())) {
            return dateString; // ุฅุฑุฌุงุน ุงููุต ุงูุฃุตูู ุฅุฐุง ูู ููู ุชุงุฑูุฎุงู ุตุญูุญุงู
        }

        // ุชูุณูู ุงูุชุงุฑูุฎ ุจุตูุบุฉ dd/mm/yyyy
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        return `${day}/${month}/${year}`;
    } catch (error) {
        console.warn('ุฎุทุฃ ูู ุชูุณูู ุงูุชุงุฑูุฎ:', dateString, error);
        return dateString;
    }
}

/**
 * ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ ุงูุญุงูู ุจุชูุณูู ุตุญูุญ ููุฅุฏุฎุงู
 */
function getCurrentDateForInput() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

/**
 * ุชุญููู ุงูุชุงุฑูุฎ ุฅูู ุชูุณูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
 */
function formatDateForDB(dateString) {
    if (!dateString) return getCurrentDateForInput();

    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return getCurrentDateForInput();
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch (error) {
        console.warn('ุฎุทุฃ ูู ุชุญููู ุงูุชุงุฑูุฎ:', dateString, error);
        return getCurrentDateForInput();
    }
}

/**
 * ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช ุจุตูุบุฉ ุตุญูุญุฉ
 */
function formatDateTime(dateString) {
    if (!dateString) return '-';

    try {
        const date = new Date(dateString);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
        if (isNaN(date.getTime())) {
            return dateString;
        }

        // ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช ุจุตูุบุฉ dd/mm/yyyy HH:mm:ss
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
    } catch (error) {
        console.warn('ุฎุทุฃ ูู ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช:', dateString, error);
        return dateString;
    }
}

/**
 * ุชูุณูู ุงูุชุงุฑูุฎ ููุทุจุงุนุฉ ุจุตูุบุฉ ุนุฑุจูุฉ ูุงุถุญุฉ
 */
function formatDateForPrint(dateString) {
    if (!dateString) return '-';

    try {
        const date = new Date(dateString);

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
        if (isNaN(date.getTime())) {
            return dateString;
        }

        // ุชูุณูู ุงูุชุงุฑูุฎ ุจุตูุบุฉ dd/mm/yyyy ูุน ุฃุณูุงุก ุงูุฃุดูุฑ ุงูุนุฑุจูุฉ
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        const arabicMonths = [
            'ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู',
            'ููููู', 'ุฃุบุณุทุณ', 'ุณุจุชูุจุฑ', 'ุฃูุชูุจุฑ', 'ููููุจุฑ', 'ุฏูุณูุจุฑ'
        ];

        const monthName = arabicMonths[date.getMonth()];

        return `${day}/${month}/${year} (${day} ${monthName} ${year})`;
    } catch (error) {
        console.warn('ุฎุทุฃ ูู ุชูุณูู ุงูุชุงุฑูุฎ ููุทุจุงุนุฉ:', dateString, error);
        return dateString;
    }
}

/**
 * ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ุนูุฏ ุฅุถุงูุฉ ูุงุชูุฑุฉ ูุจูุนุงุช
 */
function updateCustomerData(customerId, invoiceAmount, currency = 'SYP', invoiceDate) {
    const customer = appData.customers.find(c => c.id === customerId);
    if (!customer) return;

    // ุชุญุฏูุซ ุขุฎุฑ ุชุงุฑูุฎ ูุนุงููุฉ
    customer.lastTransactionDate = invoiceDate || new Date().toISOString().split('T')[0];

    // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุจูุนุงุช
    customer.totalSales = (customer.totalSales || 0) + invoiceAmount;

    // ุชุญุฏูุซ ุนุฏุฏ ุงููุนุงููุงุช
    customer.transactionCount = (customer.transactionCount || 0) + 1;

    // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ
    if (!customer.balances) customer.balances = {};
    customer.balances[currency] = (customer.balances[currency] || 0) + invoiceAmount;

    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู (ููุนููุฉ ุงูุฑุฆูุณูุฉ)
    if (currency === (appData.settings.currency || 'SYP')) {
        customer.currentBalance = (customer.currentBalance || 0) + invoiceAmount;
    }

    console.log(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ${customer.name}:`, {
        totalSales: customer.totalSales,
        transactionCount: customer.transactionCount,
        balances: customer.balances
    });
}

/**
 * ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ ุนูุฏ ุฅุถุงูุฉ ูุงุชูุฑุฉ ูุดุชุฑูุงุช
 */
function updateSupplierData(supplierId, invoiceAmount, currency = 'SYP', invoiceDate) {
    const supplier = appData.suppliers.find(s => s.id === supplierId);
    if (!supplier) return;

    // ุชุญุฏูุซ ุขุฎุฑ ุชุงุฑูุฎ ูุนุงููุฉ
    supplier.lastTransactionDate = invoiceDate || new Date().toISOString().split('T')[0];

    // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุดุชุฑูุงุช
    supplier.totalPurchases = (supplier.totalPurchases || 0) + invoiceAmount;

    // ุชุญุฏูุซ ุนุฏุฏ ุงููุนุงููุงุช
    supplier.transactionCount = (supplier.transactionCount || 0) + 1;

    // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ
    if (!supplier.balances) supplier.balances = {};
    supplier.balances[currency] = (supplier.balances[currency] || 0) + invoiceAmount;

    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู (ููุนููุฉ ุงูุฑุฆูุณูุฉ)
    if (currency === (appData.settings.currency || 'SYP')) {
        supplier.currentBalance = (supplier.currentBalance || 0) + invoiceAmount;
    }

    console.log(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ ${supplier.name}:`, {
        totalPurchases: supplier.totalPurchases,
        transactionCount: supplier.transactionCount,
        balances: supplier.balances
    });
}

/**
 * ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ุนูุฏ ุฅุถุงูุฉ ุณูุฏ ูุจุถ
 */
function updateCustomerPayment(customerId, paymentAmount, currency = 'SYP', paymentDate) {
    const customer = appData.customers.find(c => c.id === customerId);
    if (!customer) return;

    // ุชุญุฏูุซ ุขุฎุฑ ุชุงุฑูุฎ ูุนุงููุฉ
    customer.lastTransactionDate = paymentDate || new Date().toISOString().split('T')[0];

    // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุฏููุนุงุช
    customer.totalPayments = (customer.totalPayments || 0) + paymentAmount;

    // ุชุญุฏูุซ ุนุฏุฏ ุงููุนุงููุงุช
    customer.transactionCount = (customer.transactionCount || 0) + 1;

    // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ (ุทุฑุญ ุงููุจูุบ ุงููุฏููุน)
    if (!customer.balances) customer.balances = {};
    customer.balances[currency] = (customer.balances[currency] || 0) - paymentAmount;

    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู (ููุนููุฉ ุงูุฑุฆูุณูุฉ)
    if (currency === (appData.settings.currency || 'SYP')) {
        customer.currentBalance = (customer.currentBalance || 0) - paymentAmount;
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฑุตูุฏ ุงูุฅุฌูุงูู ููุนููู ูู ุฌููุน ุงููุนุงููุงุช
    recalculateCustomerBalance(customerId);

    console.log(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ${customer.name} ุจุนุฏ ุงูุฏูุน:`, {
        totalPayments: customer.totalPayments,
        transactionCount: customer.transactionCount,
        balances: customer.balances
    });
}

/**
 * ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ ุนูุฏ ุฅุถุงูุฉ ุณูุฏ ุฏูุน
 */
function updateSupplierPayment(supplierId, paymentAmount, currency = 'SYP', paymentDate) {
    const supplier = appData.suppliers.find(s => s.id === supplierId);
    if (!supplier) return;

    // ุชุญุฏูุซ ุขุฎุฑ ุชุงุฑูุฎ ูุนุงููุฉ
    supplier.lastTransactionDate = paymentDate || new Date().toISOString().split('T')[0];

    // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุฏููุนุงุช
    supplier.totalPayments = (supplier.totalPayments || 0) + paymentAmount;

    // ุชุญุฏูุซ ุนุฏุฏ ุงููุนุงููุงุช
    supplier.transactionCount = (supplier.transactionCount || 0) + 1;

    // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ (ุทุฑุญ ุงููุจูุบ ุงููุฏููุน)
    if (!supplier.balances) supplier.balances = {};
    supplier.balances[currency] = (supplier.balances[currency] || 0) - paymentAmount;

    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู (ููุนููุฉ ุงูุฑุฆูุณูุฉ)
    if (currency === (appData.settings.currency || 'SYP')) {
        supplier.currentBalance = (supplier.currentBalance || 0) - paymentAmount;
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฑุตูุฏ ุงูุฅุฌูุงูู ููููุฑุฏ ูู ุฌููุน ุงููุนุงููุงุช
    recalculateSupplierBalance(supplierId);

    console.log(`โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุฏ ${supplier.name} ุจุนุฏ ุงูุฏูุน:`, {
        totalPayments: supplier.totalPayments,
        transactionCount: supplier.transactionCount,
        balances: supplier.balances
    });
}

/**
 * ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุนููุงุช
 */
function refreshCurrencyBalances() {
    console.log('๐ฐ ุชุญุฏูุซ ุฃุฑุตุฏุฉ ุงูุนููุงุช...');

    // ุฌูุน ุฌููุน ุงูุนููุงุช ุงููุณุชุฎุฏูุฉ
    const currencies = new Set(['SYP']); // ุงูููุฑุฉ ุงูุณูุฑูุฉ ูุนููุฉ ุงูุชุฑุงุถูุฉ

    // ุฌูุน ุงูุนููุงุช ูู ุงูููุงุชูุฑ
    appData.invoices.forEach(invoice => {
        if (invoice.currency) {
            currencies.add(invoice.currency);
        }
    });

    // ุฌูุน ุงูุนููุงุช ูู ุงูุฏูุนุงุช
    appData.payments.forEach(payment => {
        if (payment.currency) {
            currencies.add(payment.currency);
        }
    });

    // ุฑููุฒ ุงูุนููุงุช
    const currencySymbols = {
        'SYP': 'ู.ุณ',
        'USD': '$',
        'EUR': 'โฌ',
        'TRY': 'โบ',
        'SAR': 'ุฑ.ุณ',
        'AED': 'ุฏ.ุฅ'
    };

    const currencyNames = {
        'SYP': 'ููุฑุฉ ุณูุฑูุฉ',
        'USD': 'ุฏููุงุฑ ุฃูุฑููู',
        'EUR': 'ููุฑู',
        'TRY': 'ููุฑุฉ ุชุฑููุฉ',
        'SAR': 'ุฑูุงู ุณุนูุฏู',
        'AED': 'ุฏุฑูู ุฅูุงุฑุงุชู'
    };

    const balanceData = [];
    let totalPositive = 0;
    let totalNegative = 0;

    currencies.forEach(currency => {
        // ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุนููุงุก
        let customerBalance = 0;
        appData.customers.forEach(customer => {
            // ููุงุชูุฑ ุงูุนููู
            const customerInvoices = appData.invoices.filter(inv =>
                inv.customerId === customer.id &&
                inv.status === 'confirmed' &&
                (inv.currency === currency || (!inv.currency && currency === 'SYP'))
            );

            customerInvoices.forEach(invoice => {
                customerBalance += invoice.totalAmount || 0;
            });

            // ุฏูุนุงุช ุงูุนููู
            const customerPayments = appData.payments.filter(payment =>
                payment.customerId === customer.id &&
                payment.paymentType === 'receipt' &&
                payment.status === 'confirmed' &&
                (payment.currency === currency || (!payment.currency && currency === 'SYP'))
            );

            customerPayments.forEach(payment => {
                customerBalance -= payment.amount || 0;
            });
        });

        // ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
        let supplierBalance = 0;
        appData.suppliers.forEach(supplier => {
            // ููุงุชูุฑ ุงูููุฑุฏ
            const supplierInvoices = appData.invoices.filter(inv =>
                inv.supplierId === supplier.id &&
                inv.status === 'confirmed' &&
                (inv.currency === currency || (!inv.currency && currency === 'SYP'))
            );

            supplierInvoices.forEach(invoice => {
                supplierBalance += invoice.totalAmount || 0;
            });

            // ุฏูุนุงุช ุงูููุฑุฏ
            const supplierPayments = appData.payments.filter(payment =>
                payment.supplierId === supplier.id &&
                payment.paymentType === 'payment' &&
                payment.status === 'confirmed' &&
                (payment.currency === currency || (!payment.currency && currency === 'SYP'))
            );

            supplierPayments.forEach(payment => {
                supplierBalance -= payment.amount || 0;
            });
        });

        // ุญุณุงุจ ุฑุตูุฏ ุงูุตูุฏูู
        let cashBalance = 0;
        const cashPayments = appData.payments.filter(payment =>
            payment.paymentMethod === 'cash' &&
            payment.status === 'confirmed' &&
            (payment.currency === currency || (!payment.currency && currency === 'SYP'))
        );

        cashPayments.forEach(payment => {
            if (payment.paymentType === 'receipt') {
                cashBalance += payment.amount || 0;
            } else {
                cashBalance -= payment.amount || 0;
            }
        });

        // ุญุณุงุจ ุฑุตูุฏ ุงูุจูู
        let bankBalance = 0;
        const bankPayments = appData.payments.filter(payment =>
            payment.paymentMethod === 'bank' &&
            payment.status === 'confirmed' &&
            (payment.currency === currency || (!payment.currency && currency === 'SYP'))
        );

        bankPayments.forEach(payment => {
            if (payment.paymentType === 'receipt') {
                bankBalance += payment.amount || 0;
            } else {
                bankBalance -= payment.amount || 0;
            }
        });

        // ุญุณุงุจ ุตุงูู ุงูุฑุตูุฏ
        const netBalance = customerBalance - supplierBalance + cashBalance + bankBalance;

        if (netBalance > 0) totalPositive++;
        if (netBalance < 0) totalNegative++;

        balanceData.push({
            currency,
            symbol: currencySymbols[currency] || currency,
            name: currencyNames[currency] || currency,
            customerBalance,
            supplierBalance,
            cashBalance,
            bankBalance,
            netBalance,
            // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ ููุนููุฉ
            isBaseCurrency: currency === (appData.settings.currency || 'SYP'),
            exchangeRate: appData.settings.exchangeRates ? appData.settings.exchangeRates[currency] : 1.0
        });
    });

    // ุชุญุฏูุซ ุงูุฌุฏูู
    updateCurrencyBalancesTable(balanceData);

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    document.getElementById('totalCurrencies').textContent = currencies.size;
    document.getElementById('positiveCurrencies').textContent = totalPositive;
    document.getElementById('negativeCurrencies').textContent = totalNegative;
    document.getElementById('lastUpdateTime').textContent = formatDateTime(new Date());

    console.log(`โ ุชู ุชุญุฏูุซ ุฃุฑุตุฏุฉ ${currencies.size} ุนููุฉ`);
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุฃุฑุตุฏุฉ ุงูุนููุงุช
 */
function updateCurrencyBalancesTable(balanceData) {
    const tableBody = document.getElementById('currencyBalancesTable');
    const summaryContainer = document.getElementById('currencyBalancesSummary');

    if (!tableBody || !summaryContainer) return;

    // ุชุญุฏูุซ ุงูููุฎุต
    summaryContainer.innerHTML = balanceData.map(data => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card border-left-${data.netBalance >= 0 ? 'success' : 'danger'} shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">${data.name}</div>
                            <div class="h5 mb-0 font-weight-bold ${data.netBalance >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(Math.abs(data.netBalance))} ${data.symbol}
                            </div>
                            <small class="text-muted">${data.netBalance >= 0 ? 'ุฑุตูุฏ ููุฌุจ' : 'ุฑุตูุฏ ุณุงูุจ'}</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // ุชุญุฏูุซ ุงูุฌุฏูู
    if (balanceData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-coins fa-3x mb-3"></i><h5>ูุง ุชูุฌุฏ ุฃุฑุตุฏุฉ ููุนุฑุถ</h5></td></tr>';
    } else {
        tableBody.innerHTML = balanceData.map(data => {
            const netBalanceClass = data.netBalance > 0 ? 'text-success' : data.netBalance < 0 ? 'text-danger' : 'text-muted';
            const statusBadge = data.netBalance > 0 ? 'success' : data.netBalance < 0 ? 'danger' : 'secondary';
            const statusText = data.netBalance > 0 ? 'ููุฌุจ' : data.netBalance < 0 ? 'ุณุงูุจ' : 'ูุชูุงุฒู';

            return `
                <tr>
                    <td>
                        <strong>${data.name}</strong>
                        <br><small class="text-muted">${data.currency}</small>
                        ${data.isBaseCurrency ? '<br><span class="badge bg-success">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ</span>' : ''}
                    </td>
                    <td>
                        <span class="badge bg-primary">${data.symbol}</span>
                        ${data.exchangeRate && data.exchangeRate !== 1.0 ? `<br><small class="text-muted">ุณุนุฑ ุงูุตุฑู: ${data.exchangeRate}</small>` : ''}
                    </td>
                    <td class="text-end">
                        <span class="${data.customerBalance >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(Math.abs(data.customerBalance))} ${data.symbol}
                        </span>
                    </td>
                    <td class="text-end">
                        <span class="${data.supplierBalance >= 0 ? 'text-danger' : 'text-success'}">
                            ${formatCurrency(Math.abs(data.supplierBalance))} ${data.symbol}
                        </span>
                    </td>
                    <td class="text-end">
                        <span class="${data.cashBalance >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(Math.abs(data.cashBalance))} ${data.symbol}
                        </span>
                    </td>
                    <td class="text-end">
                        <span class="${data.bankBalance >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(Math.abs(data.bankBalance))} ${data.symbol}
                        </span>
                    </td>
                    <td class="text-end">
                        <strong class="${netBalanceClass}">
                            ${formatCurrency(Math.abs(data.netBalance))} ${data.symbol}
                        </strong>
                    </td>
                    <td>
                        <span class="badge bg-${statusBadge}">${statusText}</span>
                    </td>
                </tr>
            `;
        }).join('');
    }
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ
 */
function printCurrencyBalances() {
    printContent('currency-balances', 'ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ููุนููุงุช');
}

/**
 * ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ
 */
function exportCurrencyBalances(format) {
    console.log(`๐ค ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ ุจุตูุบุฉ: ${format}`);

    try {
        if (format === 'excel') {
            exportToExcel('currency-balances', 'ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ููุนููุงุช');
        } else {
            printContent('currency-balances', 'ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ููุนููุงุช');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุจุฏูุฉ ูุฌููุน ุงูุนููุงุช ุงููุฏุฎูุฉ
 */
function calculateAccurateBalances() {
    console.log('๐ฐ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงูุฏูููุฉ - ุจุฏุก ุงูุนูููุฉ...');

    const balances = {
        customers: {},
        suppliers: {},
        totals: {},
        currencies: new Set() // ุนููุงุช ูุฏุฎูุฉ ูุนููุงู ููุท
    };

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูู ุงูููุงุชูุฑ ูุงูุฏูุนุงุช
    if (appData.customers) {
        console.log(`๐ฅ ูุนุงูุฌุฉ ${appData.customers.length} ุนููู...`);

        appData.customers.forEach(customer => {
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑุตุฏุฉ ูููุน ุงูุชูุฑุงุฑ
            customer.balances = {};
            customer.currentBalance = 0;
            customer.totalSales = 0;
            customer.totalPayments = 0;
            customer.transactionCount = 0;

            // ุญุณุงุจ ุงูููุงุชูุฑ ุงูุนุงุฏูุฉ ุงููุคูุฏุฉ ููุท
            const customerInvoices = (appData.invoices || []).filter(inv =>
                inv.customerId === customer.id &&
                inv.status === 'confirmed' &&
                inv.invoiceType === 'sale'
            );

            console.log(`๐ ุงูุนููู ${customer.name}: ${customerInvoices.length} ูุงุชูุฑุฉ ุนุงุฏูุฉ`);

            customerInvoices.forEach(invoice => {
                const currency = invoice.currency || 'SYP';
                const amount = parseFloat(invoice.totalAmount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!customer.balances[currency]) customer.balances[currency] = 0;
                    customer.balances[currency] += amount;
                    customer.totalSales += amount;
                    customer.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        customer.currentBalance += amount;
                    }
                }
            });

            // ุญุณุงุจ ุงูููุงุชูุฑ ุงูุฎุงุตุฉ ุงููุคูุฏุฉ ููุท
            const customerCustomInvoices = (appData.customInvoices || []).filter(inv =>
                inv.customerId === customer.id &&
                inv.status === 'confirmed' &&
                inv.invoiceType === 'sale'
            );

            console.log(`๐ ุงูุนููู ${customer.name}: ${customerCustomInvoices.length} ูุงุชูุฑุฉ ุฎุงุตุฉ`);

            customerCustomInvoices.forEach(invoice => {
                const currency = invoice.currency || 'SYP';
                const amount = parseFloat(invoice.totalAmount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!customer.balances[currency]) customer.balances[currency] = 0;
                    customer.balances[currency] += amount;
                    customer.totalSales += amount;
                    customer.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        customer.currentBalance += amount;
                    }
                }
            });

            // ุญุณุงุจ ุงูุฏูุนุงุช (ุณูุฏุงุช ุงููุจุถ) ุงููุคูุฏุฉ ููุท
            const customerPayments = (appData.payments || []).filter(payment =>
                payment.customerId === customer.id &&
                (payment.status === 'confirmed' || !payment.status) && // ูุจูู ุงูุณูุฏุงุช ุจุฏูู ุญุงูุฉ ุฃูุถุงู
                payment.paymentType === 'receipt'
            );

            console.log(`๐ฐ ุงูุนููู ${customer.name}: ${customerPayments.length} ุณูุฏ ูุจุถ`);

            customerPayments.forEach(payment => {
                const currency = payment.currency || 'SYP';
                const amount = parseFloat(payment.amount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!customer.balances[currency]) customer.balances[currency] = 0;
                    customer.balances[currency] -= amount; // ุทุฑุญ ุงููุฏููุนุงุช ูู ุงูุฑุตูุฏ
                    customer.totalPayments += amount;
                    customer.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        customer.currentBalance -= amount;
                    }
                }
            });

            // ุฅุถุงูุฉ ุงูุนููุงุก ููุฃุฑุตุฏุฉ (ููุท ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ ุบูุฑ ุตูุฑูุฉ)
            Object.keys(customer.balances).forEach(currency => {
                const balance = customer.balances[currency];
                if (Math.abs(balance) > 0.01) { // ุชุฌุงูู ุงูุฃุฑุตุฏุฉ ุงูุตุบูุฑุฉ ุฌุฏุงู
                    if (!balances.customers[currency]) {
                        balances.customers[currency] = [];
                    }

                    balances.customers[currency].push({
                        id: customer.id,
                        name: customer.name,
                        balance: balance,
                        lastTransaction: customer.lastTransactionDate,
                        transactionCount: customer.transactionCount,
                        totalSales: customer.totalSales,
                        totalPayments: customer.totalPayments
                    });
                }
            });

            // ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ูุนุงููุฉ
            if (customer.transactionCount > 0) {
                customer.lastTransactionDate = new Date().toISOString().split('T')[0];
            }
        });
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู ูู ุงูููุงุชูุฑ ูุงูุฏูุนุงุช
    if (appData.suppliers) {
        console.log(`๐ช ูุนุงูุฌุฉ ${appData.suppliers.length} ููุฑุฏ...`);

        appData.suppliers.forEach(supplier => {
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑุตุฏุฉ ูููุน ุงูุชูุฑุงุฑ
            supplier.balances = {};
            supplier.currentBalance = 0;
            supplier.totalPurchases = 0;
            supplier.totalPayments = 0;
            supplier.transactionCount = 0;

            // ุญุณุงุจ ุงูููุงุชูุฑ ุงูุนุงุฏูุฉ ุงููุคูุฏุฉ ููุท
            const supplierInvoices = (appData.invoices || []).filter(inv =>
                inv.supplierId === supplier.id &&
                inv.status === 'confirmed' &&
                inv.invoiceType === 'purchase'
            );

            console.log(`๐ ุงูููุฑุฏ ${supplier.name}: ${supplierInvoices.length} ูุงุชูุฑุฉ ุนุงุฏูุฉ`);

            supplierInvoices.forEach(invoice => {
                const currency = invoice.currency || 'SYP';
                const amount = parseFloat(invoice.totalAmount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!supplier.balances[currency]) supplier.balances[currency] = 0;
                    supplier.balances[currency] += amount;
                    supplier.totalPurchases += amount;
                    supplier.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        supplier.currentBalance += amount;
                    }
                }
            });

            // ุญุณุงุจ ุงูููุงุชูุฑ ุงูุฎุงุตุฉ ุงููุคูุฏุฉ ููุท
            const supplierCustomInvoices = (appData.customInvoices || []).filter(inv =>
                inv.supplierId === supplier.id &&
                inv.status === 'confirmed' &&
                inv.invoiceType === 'purchase'
            );

            console.log(`๐ ุงูููุฑุฏ ${supplier.name}: ${supplierCustomInvoices.length} ูุงุชูุฑุฉ ุฎุงุตุฉ`);

            supplierCustomInvoices.forEach(invoice => {
                const currency = invoice.currency || 'SYP';
                const amount = parseFloat(invoice.totalAmount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!supplier.balances[currency]) supplier.balances[currency] = 0;
                    supplier.balances[currency] += amount;
                    supplier.totalPurchases += amount;
                    supplier.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        supplier.currentBalance += amount;
                    }
                }
            });

            // ุญุณุงุจ ุงูุฏูุนุงุช (ุณูุฏุงุช ุงูุฏูุน) ุงููุคูุฏุฉ ููุท
            const supplierPayments = (appData.payments || []).filter(payment =>
                payment.supplierId === supplier.id &&
                (payment.status === 'confirmed' || !payment.status) && // ูุจูู ุงูุณูุฏุงุช ุจุฏูู ุญุงูุฉ ุฃูุถุงู
                payment.paymentType === 'payment'
            );

            console.log(`๐ฐ ุงูููุฑุฏ ${supplier.name}: ${supplierPayments.length} ุณูุฏ ุฏูุน`);

            supplierPayments.forEach(payment => {
                const currency = payment.currency || 'SYP';
                const amount = parseFloat(payment.amount) || 0;

                if (amount > 0) {
                    balances.currencies.add(currency);

                    if (!supplier.balances[currency]) supplier.balances[currency] = 0;
                    supplier.balances[currency] -= amount; // ุทุฑุญ ุงููุฏููุนุงุช ูู ุงูุฑุตูุฏ
                    supplier.totalPayments += amount;
                    supplier.transactionCount++;

                    // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                    if (currency === (appData.settings.currency || 'SYP')) {
                        supplier.currentBalance -= amount;
                    }
                }
            });

            // ุฅุถุงูุฉ ุงูููุฑุฏูู ููุฃุฑุตุฏุฉ (ููุท ุงูุฐูู ูุฏููู ุฃุฑุตุฏุฉ ุบูุฑ ุตูุฑูุฉ)
            Object.keys(supplier.balances).forEach(currency => {
                const balance = supplier.balances[currency];
                if (Math.abs(balance) > 0.01) { // ุชุฌุงูู ุงูุฃุฑุตุฏุฉ ุงูุตุบูุฑุฉ ุฌุฏุงู
                    if (!balances.suppliers[currency]) {
                        balances.suppliers[currency] = [];
                    }

                    balances.suppliers[currency].push({
                        id: supplier.id,
                        name: supplier.name,
                        balance: balance,
                        lastTransaction: supplier.lastTransactionDate,
                        transactionCount: supplier.transactionCount,
                        totalPurchases: supplier.totalPurchases,
                        totalPayments: supplier.totalPayments
                    });
                }
            });

            // ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ูุนุงููุฉ
            if (supplier.transactionCount > 0) {
                supplier.lastTransactionDate = new Date().toISOString().split('T')[0];
            }
        });
    }

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช ููู ุนููุฉ ูุน ุงูุชูููุฒ ุจูู ุงูุฅุฏุฎุงูุงุช ูุงูุฅุฎุฑุงุฌุงุช
    Array.from(balances.currencies).forEach(currency => {
        const customerData = balances.customers[currency] || [];
        const supplierData = balances.suppliers[currency] || [];

        // ุญุณุงุจ ุฅุฏุฎุงูุงุช ูุฅุฎุฑุงุฌุงุช ุงูุนููุงุก
        let customerInflows = 0;  // ุงูููุงุชูุฑ (ูุฏูู)
        let customerOutflows = 0; // ุงููุฏููุนุงุช (ุฏุงุฆู)

        customerData.forEach(customer => {
            if (customer.balance > 0) {
                customerInflows += customer.balance;
            } else {
                customerOutflows += Math.abs(customer.balance);
            }
        });

        // ุญุณุงุจ ุฅุฏุฎุงูุงุช ูุฅุฎุฑุงุฌุงุช ุงูููุฑุฏูู
        let supplierInflows = 0;  // ุงููุฏููุนุงุช ููููุฑุฏูู (ูุฏูู)
        let supplierOutflows = 0; // ุงูููุงุชูุฑ ูู ุงูููุฑุฏูู (ุฏุงุฆู)

        supplierData.forEach(supplier => {
            if (supplier.balance > 0) {
                supplierOutflows += supplier.balance;
            } else {
                supplierInflows += Math.abs(supplier.balance);
            }
        });

        const customerTotal = customerInflows - customerOutflows;
        const supplierTotal = supplierOutflows - supplierInflows;

        balances.totals[currency] = {
            customers: customerTotal,
            suppliers: supplierTotal,
            customerInflows: customerInflows,
            customerOutflows: customerOutflows,
            supplierInflows: supplierInflows,
            supplierOutflows: supplierOutflows,
            net: customerTotal - supplierTotal // ุงูุนููุงุก ูุฏููููุ ุงูููุฑุฏูู ุฏุงุฆููู
        };
    });

    console.log('โ ุชู ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุจุฏูุฉ:', balances);
    return balances;
}

/**
 * ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูุนููู ูู ุฌููุน ุงููุนุงููุงุช
 */
function recalculateCustomerBalance(customerId) {
    const customer = appData.customers.find(c => c.id === customerId);
    if (!customer) return;

    console.log(`๐ ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูุนููู: ${customer.name}`);

    // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑุตุฏุฉ
    customer.balances = {};
    customer.currentBalance = 0;
    customer.totalSales = 0;
    customer.totalPayments = 0;
    customer.transactionCount = 0;

    // ุญุณุงุจ ููุงุชูุฑ ุงููุจูุนุงุช
    const customerInvoices = (appData.invoices || []).filter(inv =>
        inv.customerId === customerId &&
        inv.status === 'confirmed' &&
        inv.invoiceType === 'sale'
    );

    customerInvoices.forEach(invoice => {
        const currency = invoice.currency || 'SYP';
        const amount = invoice.totalAmount || 0;

        if (!customer.balances[currency]) customer.balances[currency] = 0;
        customer.balances[currency] += amount;
        customer.totalSales += amount;
        customer.transactionCount++;

        // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
        if (currency === (appData.settings.currency || 'SYP')) {
            customer.currentBalance += amount;
        }
    });

    // ุญุณุงุจ ุณูุฏุงุช ุงููุจุถ
    const customerPayments = (appData.payments || []).filter(payment =>
        payment.customerId === customerId &&
        payment.status === 'confirmed' &&
        payment.paymentType === 'receipt'
    );

    customerPayments.forEach(payment => {
        const currency = payment.currency || 'SYP';
        const amount = payment.amount || 0;

        if (!customer.balances[currency]) customer.balances[currency] = 0;
        customer.balances[currency] -= amount;
        customer.totalPayments += amount;
        customer.transactionCount++;

        // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
        if (currency === (appData.settings.currency || 'SYP')) {
            customer.currentBalance -= amount;
        }
    });

    console.log(`โ ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูุนููู ${customer.name}:`, {
        balances: customer.balances,
        currentBalance: customer.currentBalance,
        totalSales: customer.totalSales,
        totalPayments: customer.totalPayments,
        transactionCount: customer.transactionCount
    });
}

/**
 * ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูููุฑุฏ ูู ุฌููุน ุงููุนุงููุงุช
 */
function recalculateSupplierBalance(supplierId) {
    const supplier = appData.suppliers.find(s => s.id === supplierId);
    if (!supplier) return;

    console.log(`๐ ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูููุฑุฏ: ${supplier.name}`);

    // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑุตุฏุฉ
    supplier.balances = {};
    supplier.currentBalance = 0;
    supplier.totalPurchases = 0;
    supplier.totalPayments = 0;
    supplier.transactionCount = 0;

    // ุญุณุงุจ ููุงุชูุฑ ุงููุดุชุฑูุงุช
    const supplierInvoices = (appData.invoices || []).filter(inv =>
        inv.supplierId === supplierId &&
        inv.status === 'confirmed' &&
        inv.invoiceType === 'purchase'
    );

    supplierInvoices.forEach(invoice => {
        const currency = invoice.currency || 'SYP';
        const amount = invoice.totalAmount || 0;

        if (!supplier.balances[currency]) supplier.balances[currency] = 0;
        supplier.balances[currency] += amount;
        supplier.totalPurchases += amount;
        supplier.transactionCount++;

        // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
        if (currency === (appData.settings.currency || 'SYP')) {
            supplier.currentBalance += amount;
        }
    });

    // ุญุณุงุจ ุณูุฏุงุช ุงูุฏูุน
    const supplierPayments = (appData.payments || []).filter(payment =>
        payment.supplierId === supplierId &&
        payment.status === 'confirmed' &&
        payment.paymentType === 'payment'
    );

    supplierPayments.forEach(payment => {
        const currency = payment.currency || 'SYP';
        const amount = payment.amount || 0;

        if (!supplier.balances[currency]) supplier.balances[currency] = 0;
        supplier.balances[currency] -= amount;
        supplier.totalPayments += amount;
        supplier.transactionCount++;

        // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
        if (currency === (appData.settings.currency || 'SYP')) {
            supplier.currentBalance -= amount;
        }
    });

    console.log(`โ ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุฑุตูุฏ ุงูููุฑุฏ ${supplier.name}:`, {
        balances: supplier.balances,
        currentBalance: supplier.currentBalance,
        totalPurchases: supplier.totalPurchases,
        totalPayments: supplier.totalPayments,
        transactionCount: supplier.transactionCount
    });
}

/**
 * ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูุฃุฑุตุฏุฉ
 */
function recalculateAllBalances() {
    console.log('๐ ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูุฃุฑุตุฏุฉ...');

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุนููุงุก
    if (appData.customers) {
        appData.customers.forEach(customer => {
            recalculateCustomerBalance(customer.id);
        });
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    if (appData.suppliers) {
        appData.suppliers.forEach(supplier => {
            recalculateSupplierBalance(supplier.id);
        });
    }

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();

    console.log('โ ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงูุฃุฑุตุฏุฉ ุจูุฌุงุญ');
}

/**
 * ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ
 */
function updateBalancesForInvoice(invoice) {
    console.log(`๐ฐ ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ูููุงุชูุฑุฉ: ${invoice.invoiceNumber}`);

    const currency = invoice.currency || 'SYP';
    const amount = invoice.totalAmount || 0;

    if (invoice.invoiceType === 'sale' && invoice.customerId) {
        // ูุงุชูุฑุฉ ูุจูุนุงุช - ุฒูุงุฏุฉ ุฑุตูุฏ ุงูุนููู (ูุฏูู)
        const customer = appData.customers.find(c => c.id === invoice.customerId);
        if (customer) {
            if (!customer.balances) customer.balances = {};
            customer.balances[currency] = (customer.balances[currency] || 0) + amount;

            // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
            if (currency === (appData.settings.currency || 'SYP')) {
                customer.currentBalance = (customer.currentBalance || 0) + amount;
            }

            customer.totalSales = (customer.totalSales || 0) + amount;
            customer.transactionCount = (customer.transactionCount || 0) + 1;
            customer.lastTransactionDate = invoice.invoiceDate;

            console.log(`โ ุชู ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู ${customer.name}: +${amount} ${currency}`);
        }
    } else if (invoice.invoiceType === 'purchase' && invoice.supplierId) {
        // ูุงุชูุฑุฉ ูุดุชุฑูุงุช - ุฒูุงุฏุฉ ุฑุตูุฏ ุงูููุฑุฏ (ุฏุงุฆู)
        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
        if (supplier) {
            if (!supplier.balances) supplier.balances = {};
            supplier.balances[currency] = (supplier.balances[currency] || 0) + amount;

            // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
            if (currency === (appData.settings.currency || 'SYP')) {
                supplier.currentBalance = (supplier.currentBalance || 0) + amount;
            }

            supplier.totalPurchases = (supplier.totalPurchases || 0) + amount;
            supplier.transactionCount = (supplier.transactionCount || 0) + 1;
            supplier.lastTransactionDate = invoice.invoiceDate;

            console.log(`โ ุชู ุชุญุฏูุซ ุฑุตูุฏ ุงูููุฑุฏ ${supplier.name}: +${amount} ${currency}`);
        }
    }
}
function filterReceipts() { alert('ูุธููุฉ ุชุตููุฉ ุณูุฏุงุช ุงููุจุถ ููุฏ ุงูุชุทููุฑ'); }
function clearReceiptFilters() { alert('ูุธููุฉ ูุณุญ ููุงุชุฑ ุณูุฏุงุช ุงููุจุถ ููุฏ ุงูุชุทููุฑ'); }
function filterPayments() { alert('ูุธููุฉ ุชุตููุฉ ุณูุฏุงุช ุงูุฏูุน ููุฏ ุงูุชุทููุฑ'); }
function clearPaymentFilters() { alert('ูุธููุฉ ูุณุญ ููุงุชุฑ ุณูุฏุงุช ุงูุฏูุน ููุฏ ุงูุชุทููุฑ'); }
function filterJournalEntries() { alert('ูุธููุฉ ุชุตููุฉ ุฏูุชุฑ ุงูููููุฉ ููุฏ ุงูุชุทููุฑ'); }
function clearJournalFilters() {
    clearJournalFilter();
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ - ููุน ุงูุชูุฑุงุฑ ูุญุณุงุจ ุฏููู
 */
function updateCurrencyBalancesTable() {
    console.log('๐ ุจุฏุก ุชุญุฏูุซ ุฌุฏูู ุงูุฃุฑุตุฏุฉ...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุนูููุฉ ุญุณุงุจ ุฌุงุฑูุฉ ูููุน ุงูุชูุฑุงุฑ
    if (window.isCalculatingBalances) {
        console.log('โ๏ธ ุนูููุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุฌุงุฑูุฉ ุจุงููุนู - ุชู ุชุฌุงูู ุงูุทูุจ');
        return Promise.resolve();
    }

    // ุชุนููู ุนูุงูุฉ ุงูุญุณุงุจ ุงูุฌุงุฑู
    window.isCalculatingBalances = true;

    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    const tableBody = document.getElementById('currencyBalancesTable');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary me-2" role="status">
                        <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                    </div>
                    <strong>ุฌุงุฑู ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุจุฏูุฉ...</strong>
                </td>
            </tr>
        `;
    }

    try {
        console.log('๐ ุจุฏุก ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงูุฏูููุฉ...');

        // ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ูุฑุฉ ูุงุญุฏุฉ ููุท ูุน ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช
        const balanceData = calculateAccurateBalances();

        if (!balanceData || typeof balanceData !== 'object') {
            throw new Error('ูุดู ูู ุญุณุงุจ ุงูุฃุฑุตุฏุฉ - ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ');
        }

        console.log(`๐ฐ ุชู ุญุณุงุจ ุฃุฑุตุฏุฉ ${balanceData.currencies.size} ุนููุฉ ุจูุฌุงุญ`);

        // ุชุญุฏูุซ ุงูููุฎุต
        updateCurrencyBalancesSummary(balanceData);

        // ุชุญุฏูุซ ุงูุฌุฏูู
        const tableBody = document.getElementById('currencyBalancesTable');
        if (!tableBody) {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฌุฏูู ุงูุฃุฑุตุฏุฉ');
            return;
        }

        if (balanceData.currencies.size === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-coins fa-3x mb-3"></i>
                        <h5>ูุง ุชูุฌุฏ ุนููุงุช ูุฏุฎูุฉ</h5>
                        <p>ุงุจุฏุฃ ุจุฅุถุงูุฉ ููุงุชูุฑ ุฃู ุณูุฏุงุช ูุฑุคูุฉ ุงูุฃุฑุตุฏุฉ</p>
                    </td>
                </tr>
            `;
            return;
        }

        const currencySymbols = {
            'SYP': 'ู.ุณ',
            'USD': '$',
            'EUR': 'โฌ',
            'TRY': 'โบ',
            'SAR': 'ุฑ.ุณ',
            'AED': 'ุฏ.ุฅ'
        };

        const currencyNames = {
            'SYP': 'ุงูููุฑุฉ ุงูุณูุฑูุฉ',
            'USD': 'ุงูุฏููุงุฑ ุงูุฃูุฑููู',
            'EUR': 'ุงูููุฑู',
            'TRY': 'ุงูููุฑุฉ ุงูุชุฑููุฉ',
            'SAR': 'ุงูุฑูุงู ุงูุณุนูุฏู',
            'AED': 'ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู'
        };

        let tableHTML = '';

        Array.from(balanceData.currencies).forEach(currency => {
            const totals = balanceData.totals[currency];
            const symbol = currencySymbols[currency] || currency;
            const name = currencyNames[currency] || currency;

            // ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุตูุฏูู ูุงูุจูู (ูููู ุชุทููุฑูุง ูุงุญูุงู)
            const cashBalance = 0; // ูููู ุญุณุงุจูุง ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน ุงูููุฏูุฉ
            const bankBalance = 0; // ูููู ุญุณุงุจูุง ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน ุงูุจูููุฉ

            const netBalance = totals.net;
            const balanceClass = netBalance > 0 ? 'text-success' : netBalance < 0 ? 'text-danger' : 'text-muted';
            const statusClass = netBalance > 0 ? 'bg-success' : netBalance < 0 ? 'bg-danger' : 'bg-secondary';
            const statusText = netBalance > 0 ? 'ููุฌุจ' : netBalance < 0 ? 'ุณุงูุจ' : 'ูุชูุงุฒู';

            tableHTML += `
                <tr>
                    <td>
                        <strong>${name}</strong>
                        <br><small class="text-muted">${currency}</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-primary">${symbol}</span>
                    </td>
                    <td class="text-end">
                        <div class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>
                            ${formatCurrency(totals.customerInflows)} ${symbol}
                        </div>
                        <small class="text-muted">ููุงุชูุฑ</small>
                    </td>
                    <td class="text-end">
                        <div class="text-danger">
                            <i class="fas fa-arrow-down me-1"></i>
                            ${formatCurrency(totals.customerOutflows)} ${symbol}
                        </div>
                        <small class="text-muted">ูุฏููุนุงุช</small>
                    </td>
                    <td class="text-end">
                        <div class="text-danger">
                            <i class="fas fa-arrow-up me-1"></i>
                            ${formatCurrency(totals.supplierInflows)} ${symbol}
                        </div>
                        <small class="text-muted">ูุฏููุนุงุช</small>
                    </td>
                    <td class="text-end">
                        <div class="text-success">
                            <i class="fas fa-arrow-down me-1"></i>
                            ${formatCurrency(totals.supplierOutflows)} ${symbol}
                        </div>
                        <small class="text-muted">ููุงุชูุฑ</small>
                    </td>
                    <td class="text-end">
                        <strong class="${balanceClass}">
                            ${formatCurrency(netBalance)} ${symbol}
                        </strong>
                    </td>
                    <td class="text-center">
                        <span class="badge ${statusClass}">${statusText}</span>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = tableHTML;

        // ุชุญุฏูุซ ููุช ุขุฎุฑ ุชุญุฏูุซ
        const lastUpdateElement = document.getElementById('lastUpdateTime');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = formatDateTime(new Date());
        }

        console.log('โ ุชู ุชุญุฏูุซ ุฌุฏูู ุงูุฃุฑุตุฏุฉ ุจูุฌุงุญ');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฌุฏูู ุงูุฃุฑุตุฏุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ: ' + error.message);
    } finally {
        // ุฅููุงุก ุนูููุฉ ุงูุญุณุงุจ
        window.isCalculatingBalances = false;
    }
}

/**
 * ุชุญุฏูุซ ููุฎุต ุงูุฃุฑุตุฏุฉ
 */
function updateCurrencyBalancesSummary(balanceData) {
    const summaryContainer = document.getElementById('currencyBalancesSummary');
    if (!summaryContainer) return;

    const totalCurrencies = balanceData.currencies.size;
    let positiveCurrencies = 0;
    let negativeCurrencies = 0;

    Array.from(balanceData.currencies).forEach(currency => {
        const netBalance = balanceData.totals[currency].net;
        if (netBalance > 0) positiveCurrencies++;
        else if (netBalance < 0) negativeCurrencies++;
    });

    summaryContainer.innerHTML = `
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ุฅุฌูุงูู ุงูุนููุงุช</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${totalCurrencies}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุฃุฑุตุฏุฉ ููุฌุจุฉ</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${positiveCurrencies}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">ุฃุฑุตุฏุฉ ุณุงูุจุฉ</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${negativeCurrencies}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-arrow-down fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ุนููุงุช ูุชูุงุฒูุฉ</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${totalCurrencies - positiveCurrencies - negativeCurrencies}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุณุฑูุนุฉ
    const totalCurrenciesElement = document.getElementById('totalCurrencies');
    const positiveCurrenciesElement = document.getElementById('positiveCurrencies');
    const negativeCurrenciesElement = document.getElementById('negativeCurrencies');

    if (totalCurrenciesElement) totalCurrenciesElement.textContent = totalCurrencies;
    if (positiveCurrenciesElement) positiveCurrenciesElement.textContent = positiveCurrencies;
    if (negativeCurrenciesElement) negativeCurrenciesElement.textContent = negativeCurrencies;
}

/**
 * ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ
 */
function refreshCurrencyBalances() {
    console.log('๐ ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ...');

    try {
        // ุฅุนุงุฏุฉ ุญุณุงุจ ูุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ
        updateCurrencyBalancesTable();

        console.log('โ ุชู ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ุจูุฌุงุญ');

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessToast('ุชู ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุทุจุงุนุฉ ุฏูุชุฑ ุงูููููุฉ
 */
function printJournal() {
    printContent('journal', 'ุฏูุชุฑ ุงูููููุฉ ุงูุนุงูุฉ');
}

/**
 * ุทุจุงุนุฉ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ
 */
function printFilteredJournal() {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ...');

    // ุงูุญุตูู ุนูู ุงููููุฏ ุงููููุชุฑุฉ
    const filteredEntries = getFilteredJournalEntries();

    if (filteredEntries.length === 0) {
        alert('ูุง ุชูุฌุฏ ูููุฏ ุชุทุงุจู ุงูููุงุชุฑ ุงููุญุฏุฏุฉ ููุทุจุงุนุฉ');
        return;
    }

    // ุฅูุดุงุก ูุญุชูู ุงูุทุจุงุนุฉ
    const printContent = generateJournalPrintContent(filteredEntries, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

    // ูุชุญ ูุงูุฐุฉ ุทุจุงุนุฉ
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();

    console.log(`โ ุชู ุฅุนุฏุงุฏ ุทุจุงุนุฉ ${filteredEntries.length} ููุฏ ูููุชุฑ`);
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ
 */
function exportFilteredJournal(format) {
    console.log(`๐ค ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุจุตูุบุฉ: ${format}`);

    // ุงูุญุตูู ุนูู ุงููููุฏ ุงููููุชุฑุฉ
    const filteredEntries = getFilteredJournalEntries();

    if (filteredEntries.length === 0) {
        alert('ูุง ุชูุฌุฏ ูููุฏ ุชุทุงุจู ุงูููุงุชุฑ ุงููุญุฏุฏุฉ ููุชุตุฏูุฑ');
        return;
    }

    try {
        if (format === 'excel') {
            exportFilteredJournalToExcel(filteredEntries);
        } else {
            printFilteredJournal();
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}



/**
 * ุงูุญุตูู ุนูู ุงููููุฏ ุงููููุชุฑุฉ
 */
function getFilteredJournalEntries() {
    const typeFilter = document.getElementById('journalTypeFilter')?.value || '';
    const fromDate = document.getElementById('journalFromDate')?.value || '';
    const toDate = document.getElementById('journalToDate')?.value || '';
    const searchText = document.getElementById('journalSearch')?.value.toLowerCase() || '';

    let filteredEntries = appData.journalEntries || [];

    // ุชุทุจูู ููุชุฑ ููุน ุงูุนูููุฉ
    if (typeFilter) {
        filteredEntries = filteredEntries.filter(entry => {
            if (typeFilter === 'invoice') {
                return entry.invoiceId;
            } else if (typeFilter === 'payment') {
                return entry.paymentId;
            } else if (typeFilter === 'adjustment') {
                return !entry.invoiceId && !entry.paymentId;
            }
            return true;
        });
    }

    // ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ
    if (fromDate) {
        filteredEntries = filteredEntries.filter(entry => (entry.entryDate || entry.date) >= fromDate);
    }
    if (toDate) {
        filteredEntries = filteredEntries.filter(entry => (entry.entryDate || entry.date) <= toDate);
    }

    // ุชุทุจูู ููุชุฑ ุงูุจุญุซ ุงููุตู
    if (searchText) {
        filteredEntries = filteredEntries.filter(entry => {
            const description = (entry.description || '').toLowerCase();
            const debitAccount = (entry.debitAccount || '').toLowerCase();
            const creditAccount = (entry.creditAccount || '').toLowerCase();
            const reference = (entry.reference || '').toLowerCase();

            return description.includes(searchText) ||
                   debitAccount.includes(searchText) ||
                   creditAccount.includes(searchText) ||
                   reference.includes(searchText);
        });
    }

    return filteredEntries;
}

/**
 * ุฅูุดุงุก ูุญุชูู ุทุจุงุนุฉ ุฏูุชุฑ ุงูููููุฉ
 */
function generateJournalPrintContent(entries, title) {
    const currentDate = formatDateTime(new Date());
    let totalDebit = 0;
    let totalCredit = 0;

    const entriesHtml = entries.map(entry => {
        totalDebit += entry.debitAmount || 0;
        totalCredit += entry.creditAmount || 0;

        const entryTypeInfo = getEntryTypeInfo(entry);

        return `
            <tr>
                <td>${formatDate(entry.entryDate || entry.date)}</td>
                <td>${entryTypeInfo.text}</td>
                <td>${entry.description || ''}</td>
                <td>${entry.debitAccount || ''}</td>
                <td>${entry.creditAccount || ''}</td>
                <td class="text-end">${formatCurrency(entry.debitAmount || 0)}</td>
                <td class="text-end">${formatCurrency(entry.creditAmount || 0)}</td>
                <td>${entry.reference || ''}</td>
            </tr>
        `;
    }).join('');

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>${title}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .company-name { font-size: 24px; font-weight: bold; color: #2c3e50; }
                .report-title { font-size: 20px; margin: 10px 0; color: #34495e; }
                .report-date { font-size: 14px; color: #7f8c8d; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f8f9fa; font-weight: bold; }
                .text-end { text-align: left; }
                .totals { background-color: #e9ecef; font-weight: bold; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #6c757d; }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">${appData.settings?.companyName || 'SAM PRO'}</div>
                <div class="report-title">${title}</div>
                <div class="report-date">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${currentDate}</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ููุน ุงูุนูููุฉ</th>
                        <th>ุงููุตู</th>
                        <th>ุงูุญุณุงุจ ุงููุฏูู</th>
                        <th>ุงูุญุณุงุจ ุงูุฏุงุฆู</th>
                        <th>ุงููุจูุบ ุงููุฏูู</th>
                        <th>ุงููุจูุบ ุงูุฏุงุฆู</th>
                        <th>ุงููุฑุฌุน</th>
                    </tr>
                </thead>
                <tbody>
                    ${entriesHtml}
                </tbody>
                <tfoot>
                    <tr class="totals">
                        <td colspan="5">ุงูุฅุฌูุงูู</td>
                        <td class="text-end">${formatCurrency(totalDebit)}</td>
                        <td class="text-end">${formatCurrency(totalCredit)}</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <div class="footer">
                <p>ุนุฏุฏ ุงููููุฏ: ${entries.length} | ุงููุฑู: ${formatCurrency(Math.abs(totalDebit - totalCredit))}</p>
                <p>ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ SAM PRO - ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel
 */
function exportFilteredJournalToExcel(entries) {
    console.log('๐ ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const headers = ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุนูููุฉ', 'ุงููุตู', 'ุงูุญุณุงุจ ุงููุฏูู', 'ุงูุญุณุงุจ ุงูุฏุงุฆู', 'ุงููุจูุบ ุงููุฏูู', 'ุงููุจูุบ ุงูุฏุงุฆู', 'ุงููุฑุฌุน'];

        const data = entries.map(entry => [
            formatDate(entry.entryDate || entry.date),
            getEntryTypeInfo(entry).text,
            entry.description || '',
            entry.debitAccount || '',
            entry.creditAccount || '',
            entry.debitAmount || 0,
            entry.creditAmount || 0,
            entry.reference || ''
        ]);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        const totalDebit = entries.reduce((sum, entry) => sum + (entry.debitAmount || 0), 0);
        const totalCredit = entries.reduce((sum, entry) => sum + (entry.creditAmount || 0), 0);
        data.push(['', '', '', '', 'ุงูุฅุฌูุงูู', totalDebit, totalCredit, '']);

        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);

        // ุชุญุณูู ุนุฑุถ ุงูุฃุนูุฏุฉ
        const colWidths = [
            { wch: 12 }, // ุงูุชุงุฑูุฎ
            { wch: 15 }, // ููุน ุงูุนูููุฉ
            { wch: 30 }, // ุงููุตู
            { wch: 20 }, // ุงูุญุณุงุจ ุงููุฏูู
            { wch: 20 }, // ุงูุญุณุงุจ ุงูุฏุงุฆู
            { wch: 15 }, // ุงููุจูุบ ุงููุฏูู
            { wch: 15 }, // ุงููุจูุบ ุงูุฏุงุฆู
            { wch: 15 }  // ุงููุฑุฌุน
        ];
        worksheet['!cols'] = colWidths;

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

        // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ
        const infoSheet = XLSX.utils.aoa_to_sheet([
            ['ูุนูููุงุช ุงูุชูุฑูุฑ'],
            ['ุงูุนููุงู', 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ'],
            ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', formatDateTime(new Date().toISOString())],
            ['ุนุฏุฏ ุงููููุฏ', entries.length],
            ['ุฅุฌูุงูู ุงููุฏูู', totalDebit],
            ['ุฅุฌูุงูู ุงูุฏุงุฆู', totalCredit],
            ['ุงููุฑู', Math.abs(totalDebit - totalCredit)],
            [''],
            ['ูุนูููุงุช ุงููุทูุฑ'],
            ['ุงูุงุณู', 'MOHANNAD AHMAD'],
            ['ุงููุงุชู', '+963-998-171-954'],
            ['ุงูุจุฑูุงูุฌ', 'SAM PRO - ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู'],
            ['ุงูุณูุฉ', 'ยฉ 2025']
        ]);
        XLSX.utils.book_append_sheet(workbook, infoSheet, 'ูุนูููุงุช');

        const fileName = `ุฏูุชุฑ_ุงูููููุฉ_ุงููููุชุฑ_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ Excel ุจูุฌุงุญ:', fileName);
        showSuccessToast('ุชู ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}



/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel
 */
function exportFilteredJournalToExcel(entries) {
    console.log('๐ ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const headers = ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุนูููุฉ', 'ุงููุตู', 'ุงูุญุณุงุจ ุงููุฏูู', 'ุงูุญุณุงุจ ุงูุฏุงุฆู', 'ุงููุจูุบ ุงููุฏูู', 'ุงููุจูุบ ุงูุฏุงุฆู', 'ุงููุฑุฌุน'];

        const data = entries.map(entry => [
            formatDate(entry.entryDate || entry.date),
            getEntryTypeInfo(entry).text,
            entry.description || '',
            entry.debitAccount || '',
            entry.creditAccount || '',
            entry.debitAmount || 0,
            entry.creditAmount || 0,
            entry.reference || ''
        ]);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        const totalDebit = entries.reduce((sum, entry) => sum + (entry.debitAmount || 0), 0);
        const totalCredit = entries.reduce((sum, entry) => sum + (entry.creditAmount || 0), 0);
        data.push(['', '', '', '', 'ุงูุฅุฌูุงูู', totalDebit, totalCredit, '']);

        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

        const fileName = `ุฏูุชุฑ_ุงูููููุฉ_ุงููููุชุฑ_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ Excel ุจูุฌุงุญ:', fileName);
        showSuccessToast('ุชู ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู PDF
 */
function exportFilteredJournalToPDF(entries) {
    console.log('๐ ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู PDF...');

    try {
        const printContent = generateJournalPrintContent(entries, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();

        setTimeout(() => {
            alert('ุณูุชู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ุงุฎุชุฑ "ุญูุธ ูู PDF" ูู ุฎูุงุฑุงุช ุงูุทุงุจุนุฉ ูุญูุธ ุงูููู.');
            printWindow.print();
        }, 500);

        console.log('โ ุชู ุฅุนุฏุงุฏ ุชุตุฏูุฑ PDF');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ PDF: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel
 */
function exportFilteredJournalToExcel(entries) {
    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const headers = ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุนูููุฉ', 'ุงููุตู', 'ุงูุญุณุงุจ ุงููุฏูู', 'ุงูุญุณุงุจ ุงูุฏุงุฆู', 'ุงููุจูุบ ุงููุฏูู', 'ุงููุจูุบ ุงูุฏุงุฆู', 'ุงููุฑุฌุน'];

        const data = entries.map(entry => [
            formatDate(entry.entryDate || entry.date),
            getEntryTypeInfo(entry).text,
            entry.description || '',
            entry.debitAccount || '',
            entry.creditAccount || '',
            entry.debitAmount || 0,
            entry.creditAmount || 0,
            entry.reference || ''
        ]);

        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

        const fileName = `ุฏูุชุฑ_ุงูููููุฉ_ุงููููุชุฑ_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        showSuccessToast('ุชู ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู Excel ุจูุฌุงุญ!');
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ ุฅูู PDF
 */
function exportFilteredJournalToPDF(entries) {
    try {
        const printContent = generateJournalPrintContent(entries, 'ุฏูุชุฑ ุงูููููุฉ ุงููููุชุฑ');

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();

        setTimeout(() => {
            alert('ุณูุชู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ุงุฎุชุฑ "ุญูุธ ูู PDF" ูู ุฎูุงุฑุงุช ุงูุทุงุจุนุฉ.');
            printWindow.print();
        }, 500);
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ PDF: ' + error.message);
    }
}

/**
 * ุฅุถุงูุฉ ููุฏ ูุฏูู
 */
function addManualJournalEntry() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addManualEntryModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅุถุงูุฉ ููุฏ ูุฏูู</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="manualEntryForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุชุงุฑูุฎ ุงูููุฏ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="entryDate" value="${getCurrentDateForInput()}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="entryReference" placeholder="ุฑูู ุงููุฑุฌุน ุฃู ุงููุซููุฉ">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ูุตู ุงูููุฏ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="entryDescription" rows="2" placeholder="ูุตู ููุตู ููููุฏ ุงููุญุงุณุจู" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุญุณุงุจ ุงููุฏูู <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="debitAccount" placeholder="ุงุณู ุงูุญุณุงุจ ุงููุฏูู" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงูุญุณุงุจ ุงูุฏุงุฆู <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="creditAccount" placeholder="ุงุณู ุงูุญุณุงุจ ุงูุฏุงุฆู" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููุจูุบ ุงููุฏูู <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="debitAmount" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ุงููุจูุบ ุงูุฏุงุฆู <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="creditAmount" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            ูุฌุจ ุฃู ูููู ุงููุจูุบ ุงููุฏูู ูุณุงููุงู ูููุจูุบ ุงูุฏุงุฆู ูุถูุงู ุชูุงุฒู ุงูููุฏ
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveManualJournalEntry()">
                        <i class="fas fa-save me-2"></i>ุญูุธ ุงูููุฏ
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุงูููุฏ ุงููุฏูู
 */
function saveManualJournalEntry() {
    const entryDate = document.getElementById('entryDate').value;
    const entryReference = document.getElementById('entryReference').value;
    const entryDescription = document.getElementById('entryDescription').value;
    const debitAccount = document.getElementById('debitAccount').value;
    const creditAccount = document.getElementById('creditAccount').value;
    const debitAmount = parseFloat(document.getElementById('debitAmount').value) || 0;
    const creditAmount = parseFloat(document.getElementById('creditAmount').value) || 0;

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!entryDate || !entryDescription || !debitAccount || !creditAccount) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    if (debitAmount <= 0 || creditAmount <= 0) {
        alert('ูุฌุจ ุฃู ุชููู ุงููุจุงูุบ ุฃูุจุฑ ูู ุงูุตูุฑ');
        return;
    }

    if (Math.abs(debitAmount - creditAmount) > 0.01) {
        alert('ูุฌุจ ุฃู ูููู ุงููุจูุบ ุงููุฏูู ูุณุงููุงู ูููุจูุบ ุงูุฏุงุฆู');
        return;
    }

    try {
        // ุฅูุดุงุก ุงูููุฏ ุงูุฌุฏูุฏ
        const newEntry = {
            id: Date.now(),
            entryDate: entryDate,
            date: entryDate, // ููุชูุงูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงููุฏููุฉ
            description: entryDescription,
            debitAccount: debitAccount,
            creditAccount: creditAccount,
            debitAmount: debitAmount,
            creditAmount: creditAmount,
            reference: entryReference || `ููุฏ ูุฏูู ${Date.now()}`,
            entryType: 'manual',
            currency: appData.settings?.currency || 'SYP',
            createdAt: new Date().toISOString(),
            createdBy: 'manual'
        };

        // ุฅุถุงูุฉ ุงูููุฏ ุฅูู ุงูุจูุงูุงุช
        if (!appData.journalEntries) {
            appData.journalEntries = [];
        }
        appData.journalEntries.push(newEntry);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addManualEntryModal'));
        modal.hide();

        // ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ
        updateJournalTable(appData.journalEntries || []);

        // ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessToast('ุชู ุฅุถุงูุฉ ุงูููุฏ ุงููุฏูู ุจูุฌุงุญ!');

        console.log('โ ุชู ุฅุถุงูุฉ ููุฏ ูุฏูู ุฌุฏูุฏ:', newEntry);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุฏ ุงููุฏูู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูููุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุญูุธ ุงูููุฏ ุงููุฏูู
 */
function saveManualJournalEntry() {
    const entryDate = document.getElementById('entryDate').value;
    const entryDescription = document.getElementById('entryDescription').value;
    const debitAccount = document.getElementById('debitAccount').value;
    const creditAccount = document.getElementById('creditAccount').value;
    const debitAmount = parseFloat(document.getElementById('debitAmount').value) || 0;
    const creditAmount = parseFloat(document.getElementById('creditAmount').value) || 0;

    // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    if (!entryDate || !entryDescription || !debitAccount || !creditAccount) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    if (debitAmount <= 0 || creditAmount <= 0) {
        alert('ูุฌุจ ุฃู ุชููู ุงููุจุงูุบ ุฃูุจุฑ ูู ุงูุตูุฑ');
        return;
    }

    if (Math.abs(debitAmount - creditAmount) > 0.01) {
        alert('ูุฌุจ ุฃู ูููู ุงููุจูุบ ุงููุฏูู ูุณุงููุงู ูููุจูุบ ุงูุฏุงุฆู');
        return;
    }

    try {
        // ุฅูุดุงุก ุงูููุฏ ุงูุฌุฏูุฏ
        const newEntry = {
            id: Date.now(),
            entryDate: entryDate,
            description: entryDescription,
            debitAccount: debitAccount,
            creditAccount: creditAccount,
            debitAmount: debitAmount,
            creditAmount: creditAmount,
            reference: document.getElementById('entryReference').value || `ููุฏ ูุฏูู ${Date.now()}`,
            entryType: 'manual',
            currency: appData.settings?.currency || 'SYP',
            createdAt: new Date().toISOString()
        };

        // ุฅุถุงูุฉ ุงูููุฏ ุฅูู ุงูุจูุงูุงุช
        if (!appData.journalEntries) {
            appData.journalEntries = [];
        }
        appData.journalEntries.push(newEntry);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addManualEntryModal'));
        modal.hide();

        // ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ
        updateJournalTable(appData.journalEntries || []);

        // ุฑุณุงูุฉ ูุฌุงุญ
        showSuccessToast('ุชู ุฅุถุงูุฉ ุงูููุฏ ุงููุฏูู ุจูุฌุงุญ!');

        console.log('โ ุชู ุฅุถุงูุฉ ููุฏ ูุฏูู ุฌุฏูุฏ:', newEntry);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููุฏ ุงููุฏูู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูููุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ - ูุญุณู ูุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงููููุฏ
 */
function refreshJournal() {
    console.log('๐ ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ูุฅุนุงุฏุฉ ุญุณุงุจ ุฌููุน ุงููููุฏ...');

    try {
        // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
        showLoadingIndicator('ุฌุงุฑู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ูุฅุนุงุฏุฉ ุญุณุงุจ ุงููููุฏ...');

        // ุฅุนุงุฏุฉ ุชุนููู ุฏูุชุฑ ุงูููููุฉ
        appData.journalEntries = [];

        // ุฅุนุงุฏุฉ ุฅูุดุงุก ุงููููุฏ ูู ุฌููุน ุงููุตุงุฏุฑ
        regenerateAllJournalEntries();

        // ุชุญุฏูุซ ุงูุฌุฏูู ูุน ุงููููุฏ ุงูุฌุฏูุฏุฉ
        updateJournalTable(appData.journalEntries || []);

        // ูุณุญ ุงูููุงุชุฑ
        clearJournalFilter();

        // ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู
        hideLoadingIndicator();

        console.log('โ ุชู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ุจูุฌุงุญ - ุฅุฌูุงูู ุงููููุฏ:', appData.journalEntries.length);

        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ููุตูุฉ
        const totalEntries = appData.journalEntries.length;
        const totalDebit = appData.journalEntries.reduce((sum, entry) => sum + (entry.debitAmount || 0), 0);
        const totalCredit = appData.journalEntries.reduce((sum, entry) => sum + (entry.creditAmount || 0), 0);

        showSuccessToast(`ุชู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ ุจูุฌุงุญ!
        ุนุฏุฏ ุงููููุฏ: ${totalEntries}
        ุฅุฌูุงูู ุงููุฏูู: ${formatCurrency(totalDebit)}
        ุฅุฌูุงูู ุงูุฏุงุฆู: ${formatCurrency(totalCredit)}`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ:', error);
        hideLoadingIndicator();
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุฏูุชุฑ ุงูููููุฉ: ' + error.message);
    }
}

/**
 * ุฅุนุงุฏุฉ ุฅูุดุงุก ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ูู ุงููุตุงุฏุฑ ุงููุฎุชููุฉ
 */
function regenerateAllJournalEntries() {
    console.log('๐ ุฅุนุงุฏุฉ ุฅูุดุงุก ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ...');

    let entriesCount = 0;

    // 1. ุฅูุดุงุก ูููุฏ ูู ุงูููุงุชูุฑ ุงููุคูุฏุฉ
    if (appData.invoices && appData.invoices.length > 0) {
        appData.invoices.forEach(invoice => {
            if (invoice.status === 'confirmed') {
                try {
                    if (invoice.invoiceType === 'sale') {
                        // ููุฏ ูุงุชูุฑุฉ ูุจูุนุงุช
                        const customer = appData.customers.find(c => c.id === invoice.customerId);
                        addJournalEntry({
                            entryDate: invoice.invoiceDate,
                            entryType: 'invoice',
                            description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber} - ${customer ? customer.name : 'ุนููู ุบูุฑ ูุญุฏุฏ'}`,
                            debitAccount: customer ? customer.name : 'ุนููู ุบูุฑ ูุญุฏุฏ',
                            creditAccount: 'ุงููุจูุนุงุช',
                            debitAmount: invoice.totalAmount || 0,
                            creditAmount: invoice.totalAmount || 0,
                            reference: invoice.invoiceNumber,
                            currency: invoice.currency || 'SYP'
                        });
                        entriesCount++;
                    } else if (invoice.invoiceType === 'purchase') {
                        // ููุฏ ูุงุชูุฑุฉ ูุดุชุฑูุงุช
                        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
                        addJournalEntry({
                            entryDate: invoice.invoiceDate,
                            entryType: 'invoice',
                            description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber} - ${supplier ? supplier.name : 'ููุฑุฏ ุบูุฑ ูุญุฏุฏ'}`,
                            debitAccount: 'ุงููุดุชุฑูุงุช',
                            creditAccount: supplier ? supplier.name : 'ููุฑุฏ ุบูุฑ ูุญุฏุฏ',
                            debitAmount: invoice.totalAmount || 0,
                            creditAmount: invoice.totalAmount || 0,
                            reference: invoice.invoiceNumber,
                            currency: invoice.currency || 'SYP'
                        });
                        entriesCount++;
                    }
                } catch (error) {
                    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ููุฏ ูููุงุชูุฑุฉ:', invoice.invoiceNumber, error);
                }
            }
        });
    }

    // 2. ุฅูุดุงุก ูููุฏ ูู ุณูุฏุงุช ุงููุจุถ ูุงูุฏูุน ุงููุคูุฏุฉ
    if (appData.payments && appData.payments.length > 0) {
        appData.payments.forEach(payment => {
            if (payment.status === 'confirmed') {
                try {
                    if (payment.paymentType === 'receipt') {
                        // ููุฏ ุณูุฏ ูุจุถ
                        const customer = appData.customers.find(c => c.id === payment.customerId);
                        const paymentMethodAccount = getPaymentMethodAccount(payment.paymentMethod);

                        addJournalEntry({
                            entryDate: payment.paymentDate,
                            entryType: 'payment',
                            description: `ุณูุฏ ูุจุถ ุฑูู ${payment.paymentNumber} - ${customer ? customer.name : 'ุนููู ุบูุฑ ูุญุฏุฏ'}`,
                            debitAccount: paymentMethodAccount,
                            creditAccount: customer ? customer.name : 'ุนููู ุบูุฑ ูุญุฏุฏ',
                            debitAmount: payment.amount || 0,
                            creditAmount: payment.amount || 0,
                            reference: payment.paymentNumber,
                            currency: payment.currency || 'SYP'
                        });
                        entriesCount++;
                    } else if (payment.paymentType === 'payment') {
                        // ููุฏ ุณูุฏ ุฏูุน
                        const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
                        const paymentMethodAccount = getPaymentMethodAccount(payment.paymentMethod);

                        addJournalEntry({
                            entryDate: payment.paymentDate,
                            entryType: 'payment',
                            description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber} - ${supplier ? supplier.name : 'ููุฑุฏ ุบูุฑ ูุญุฏุฏ'}`,
                            debitAccount: supplier ? supplier.name : 'ููุฑุฏ ุบูุฑ ูุญุฏุฏ',
                            creditAccount: paymentMethodAccount,
                            debitAmount: payment.amount || 0,
                            creditAmount: payment.amount || 0,
                            reference: payment.paymentNumber,
                            currency: payment.currency || 'SYP'
                        });
                        entriesCount++;
                    }
                } catch (error) {
                    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ููุฏ ููุณูุฏ:', payment.paymentNumber, error);
                }
            }
        });
    }

    // 3. ุฅุถุงูุฉ ุงููููุฏ ุงููุฏููุฉ ุงููุญููุธุฉ ูุณุจูุงู (ุฅู ูุฌุฏุช)
    const manualEntries = JSON.parse(localStorage.getItem('manualJournalEntries') || '[]');
    manualEntries.forEach(entry => {
        try {
            addJournalEntry(entry);
            entriesCount++;
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ููุฏ ูุฏูู:', error);
        }
    });

    console.log(`โ ุชู ุฅูุดุงุก ${entriesCount} ููุฏ ูุญุงุณุจู ูู ุฌููุน ุงููุตุงุฏุฑ`);
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุญุณุงุจ ุทุฑููุฉ ุงูุฏูุน
 */
function getPaymentMethodAccount(paymentMethod) {
    const accounts = {
        'cash': 'ุงูุตูุฏูู',
        'bank': 'ุงูุจูู',
        'check': 'ุงูุดููุงุช',
        'card': 'ุงูุจุทุงูุงุช ุงูุงุฆุชูุงููุฉ',
        'transfer': 'ุงูุชุญูููุงุช ุงูุจูููุฉ'
    };
    return accounts[paymentMethod] || 'ุงูุตูุฏูู';
}

/**
 * ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
 */
function showLoadingIndicator(message = 'ุฌุงุฑู ุงูุชุญููู...') {
    // ุฅุฒุงูุฉ ุฃู ูุคุดุฑ ุชุญููู ููุฌูุฏ
    hideLoadingIndicator();

    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingIndicator';
    loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingDiv.style.zIndex = '9999';
    loadingDiv.innerHTML = `
        <div class="card shadow-lg">
            <div class="card-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="card-title">${message}</h5>
                <p class="card-text text-muted">ูุฑุฌู ุงูุงูุชุธุงุฑ...</p>
            </div>
        </div>
    `;

    document.body.appendChild(loadingDiv);
}

/**
 * ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู
 */
function hideLoadingIndicator() {
    const loadingDiv = document.getElementById('loadingIndicator');
    if (loadingDiv) {
        document.body.removeChild(loadingDiv);
    }
}

// ูุธุงุฆู ุงูุชูุงุฑูุฑ
function generateSalesReport() {
    const fromDate = document.getElementById('salesReportFromDate')?.value;
    const toDate = document.getElementById('salesReportToDate')?.value;
    const customerId = document.getElementById('salesReportCustomer')?.value;
    const productId = document.getElementById('salesReportProduct')?.value;

    if (!fromDate || !toDate) {
        alert('ูุฑุฌู ุชุญุฏูุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ');
        return;
    }

    if (fromDate > toDate) {
        alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
        return;
    }

    // ุชุตููุฉ ุงูููุงุชูุฑ
    let salesInvoices = appData.invoices.filter(inv =>
        inv.invoiceType === 'sale' &&
        inv.status === 'confirmed' &&
        inv.invoiceDate >= fromDate &&
        inv.invoiceDate <= toDate
    );

    // ุชุตููุฉ ุญุณุจ ุงูุนููู
    if (customerId) {
        salesInvoices = salesInvoices.filter(inv => inv.customerId == customerId);
    }

    // ุชุตููุฉ ุญุณุจ ุงูููุชุฌ
    if (productId) {
        salesInvoices = salesInvoices.filter(inv =>
            inv.items && inv.items.some(item => item.productId == productId)
        );
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalSales = salesInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
    const totalInvoices = salesInvoices.length;
    const averageInvoice = totalInvoices > 0 ? totalSales / totalInvoices : 0;
    const pendingAmount = salesInvoices.reduce((sum, inv) => sum + (inv.remainingAmount || inv.totalAmount || 0), 0);

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    const totalSalesElement = document.getElementById('totalSalesAmount');
    const totalInvoicesElement = document.getElementById('totalSalesInvoicesCount');
    const averageElement = document.getElementById('averageInvoiceAmount');
    const pendingElement = document.getElementById('pendingSalesAmount');

    if (totalSalesElement) totalSalesElement.textContent = formatCurrency(totalSales);
    if (totalInvoicesElement) totalInvoicesElement.textContent = totalInvoices;
    if (averageElement) averageElement.textContent = formatCurrency(averageInvoice);
    if (pendingElement) pendingElement.textContent = formatCurrency(pendingAmount);

    // ุชุญุฏูุซ ุงูุฌุฏูู
    const tableBody = document.getElementById('salesReportTable');
    if (tableBody) {
        if (salesInvoices.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ูุง ุชูุฌุฏ ูุจูุนุงุช ูู ูุฐู ุงููุชุฑุฉ</td></tr>';
        } else {
            tableBody.innerHTML = salesInvoices.map(invoice => {
                const customer = appData.customers.find(c => c.id === invoice.customerId);
                return `
                    <tr>
                        <td><strong>${invoice.invoiceNumber || 'ุบูุฑ ูุญุฏุฏ'}</strong></td>
                        <td>${invoice.invoiceDate || 'ุบูุฑ ูุญุฏุฏ'}</td>
                        <td>${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                        <td>${formatCurrency(invoice.totalAmount || 0)}</td>
                        <td>${formatCurrency(invoice.paidAmount || 0)}</td>
                        <td>${formatCurrency(invoice.remainingAmount || invoice.totalAmount || 0)}</td>
                        <td><span class="badge bg-${getStatusColor(invoice.status)}">${getStatusText(invoice.status)}</span></td>
                    </tr>
                `;
            }).join('');
        }
    }

    // ุฅุธูุงุฑ ุงููุชุงุฆุฌ
    const summaryElement = document.getElementById('salesReportSummary');
    const noDataElement = document.getElementById('noSalesData');

    if (summaryElement) {
        summaryElement.style.display = 'block';
    }
    if (noDataElement) {
        noDataElement.style.display = 'none';
    }

    // ุฅุถุงูุฉ ุฑุณุงูุฉ ูุฌุงุญ
    console.log(`ุชู ุฅูุดุงุก ุชูุฑูุฑ ุงููุจูุนุงุช: ${totalInvoices} ูุงุชูุฑุฉุ ุฅุฌูุงูู ${formatCurrency(totalSales)}`);
}

function clearSalesReportFilters() {
    document.getElementById('salesReportFromDate').value = '';
    document.getElementById('salesReportToDate').value = '';
    document.getElementById('salesReportCustomer').value = '';
    document.getElementById('salesReportProduct').value = '';

    document.getElementById('salesReportSummary').style.display = 'none';
    document.getElementById('noSalesData').style.display = 'block';
}

function generatePurchaseReport() {
    const fromDate = document.getElementById('purchaseReportFromDate').value;
    const toDate = document.getElementById('purchaseReportToDate').value;
    const supplierId = document.getElementById('purchaseReportSupplier').value;
    const productId = document.getElementById('purchaseReportProduct').value;

    if (!fromDate || !toDate) {
        alert('ูุฑุฌู ุชุญุฏูุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ');
        return;
    }

    // ุชุตููุฉ ุงูููุงุชูุฑ
    let purchaseInvoices = appData.invoices.filter(inv =>
        inv.invoiceType === 'purchase' &&
        inv.status === 'confirmed' &&
        inv.invoiceDate >= fromDate &&
        inv.invoiceDate <= toDate
    );

    // ุชุตููุฉ ุญุณุจ ุงูููุฑุฏ
    if (supplierId) {
        purchaseInvoices = purchaseInvoices.filter(inv => inv.supplierId == supplierId);
    }

    // ุชุตููุฉ ุญุณุจ ุงูููุชุฌ
    if (productId) {
        purchaseInvoices = purchaseInvoices.filter(inv =>
            inv.items.some(item => item.productId == productId)
        );
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalPurchases = purchaseInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);
    const totalInvoices = purchaseInvoices.length;
    const averageInvoice = totalInvoices > 0 ? totalPurchases / totalInvoices : 0;
    const pendingAmount = purchaseInvoices.reduce((sum, inv) => sum + inv.remainingAmount, 0);

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    document.getElementById('totalPurchaseAmount').textContent = formatCurrency(totalPurchases);
    document.getElementById('totalPurchaseInvoicesCount').textContent = totalInvoices;
    document.getElementById('averagePurchaseAmount').textContent = formatCurrency(averageInvoice);
    document.getElementById('pendingPurchaseAmount').textContent = formatCurrency(pendingAmount);

    // ุชุญุฏูุซ ุงูุฌุฏูู
    const tableBody = document.getElementById('purchaseReportTable');
    if (tableBody) {
        if (purchaseInvoices.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูู ูุฐู ุงููุชุฑุฉ</td></tr>';
        } else {
            tableBody.innerHTML = purchaseInvoices.map(invoice => {
                const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
                return `
                    <tr>
                        <td><strong>${invoice.invoiceNumber}</strong></td>
                        <td>${invoice.invoiceDate}</td>
                        <td>${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                        <td>${formatCurrency(invoice.totalAmount)}</td>
                        <td>${formatCurrency(invoice.paidAmount || 0)}</td>
                        <td>${formatCurrency(invoice.remainingAmount || invoice.totalAmount)}</td>
                        <td><span class="badge bg-${getStatusColor(invoice.status)}">${getStatusText(invoice.status)}</span></td>
                    </tr>
                `;
            }).join('');
        }
    }

    // ุฅุธูุงุฑ ุงููุชุงุฆุฌ
    const summaryElement = document.getElementById('purchaseReportSummary');
    const noDataElement = document.getElementById('noPurchaseData');

    if (summaryElement) {
        summaryElement.style.display = 'block';
    }
    if (noDataElement) {
        noDataElement.style.display = 'none';
    }
}

function clearPurchaseReportFilters() {
    document.getElementById('purchaseReportFromDate').value = '';
    document.getElementById('purchaseReportToDate').value = '';
    document.getElementById('purchaseReportSupplier').value = '';
    document.getElementById('purchaseReportProduct').value = '';

    document.getElementById('purchaseReportSummary').style.display = 'none';
    document.getElementById('noPurchaseData').style.display = 'block';
}

// ูุธุงุฆู ุงูุชุตุฏูุฑ ูุงูุทุจุงุนุฉ
function exportJournal(format) {
    console.log(`๐ค ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุจุตูุบุฉ: ${format}`);

    if (format === 'excel') {
        exportToExcel('journal', 'ุฏูุชุฑ ุงูููููุฉ ุงูุนุงูุฉ');
    } else {
        printContent('journal', 'ุฏูุชุฑ ุงูููููุฉ ุงูุนุงูุฉ');
    }
}

/**
 * ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุฅูู PDF
 */
function exportJournalToPDF() {
    console.log('๐ ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุฅูู PDF...');

    try {
        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุญุฏุฏุฉ
        const currency = document.getElementById('journalCurrencyFilter')?.value || 'all';
        const entryType = document.getElementById('journalTypeFilter')?.value || 'all';
        const dateFrom = document.getElementById('journalDateFrom')?.value || '';
        const dateTo = document.getElementById('journalDateTo')?.value || '';

        // ุฅูุดุงุก URL ููุชุตุฏูุฑ ูุน ุงููุนุงููุงุช
        const params = new URLSearchParams({
            currency: currency,
            type: entryType,
            date_from: dateFrom,
            date_to: dateTo
        });

        const exportUrl = `/api/export/journal-pdf?${params.toString()}`;

        // ูุชุญ ุฑุงุจุท ุงูุชุญููู
        window.open(exportUrl, '_blank');

        console.log('โ ุชู ุจุฏุก ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุฅูู PDF');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุฅูู PDF:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุฏูุชุฑ ุงูููููุฉ ุฅูู PDF. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

function exportStatement(format) {
    if (format === 'excel') {
        exportCustomerStatementToExcel();
    } else {
        printContent('customer-statement', 'ูุดู ุญุณุงุจ ุงูุนููู');
    }
}

/**
 * ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูุนููู ุฅูู Excel
 */
function exportCustomerStatementToExcel() {
    console.log('๐ ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูุนููู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const customerId = document.getElementById('statementCustomer').value;
        const fromDate = document.getElementById('statementFromDate').value;
        const toDate = document.getElementById('statementToDate').value;

        if (!customerId) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ุฃููุงู');
            return;
        }

        const customer = appData.customers.find(c => c.id == customerId);
        if (!customer) {
            alert('ุงูุนููู ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุฌูุน ุงูุญุฑูุงุช ุงููุงููุฉ
        const transactions = [];

        // ุฅุถุงูุฉ ุงูููุงุชูุฑ
        const customerInvoices = appData.invoices.filter(inv =>
            inv.customerId == customerId &&
            inv.status === 'confirmed' &&
            (!fromDate || inv.invoiceDate >= fromDate) &&
            (!toDate || inv.invoiceDate <= toDate)
        );

        customerInvoices.forEach(invoice => {
            transactions.push({
                date: invoice.invoiceDate,
                description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber}`,
                reference: invoice.invoiceNumber,
                debit: invoice.totalAmount || 0,
                credit: 0,
                type: 'invoice'
            });
        });

        // ุฅุถุงูุฉ ุณูุฏุงุช ุงููุจุถ
        const customerReceipts = appData.payments.filter(payment =>
            payment.customerId == customerId &&
            payment.paymentType === 'receipt' &&
            payment.status === 'confirmed' &&
            (!fromDate || payment.paymentDate >= fromDate) &&
            (!toDate || payment.paymentDate <= toDate)
        );

        customerReceipts.forEach(receipt => {
            transactions.push({
                date: receipt.paymentDate,
                description: `ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber} - ${getPaymentMethodText(receipt.paymentMethod)}`,
                reference: receipt.paymentNumber,
                debit: 0,
                credit: receipt.amount || 0,
                type: 'receipt'
            });
        });

        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

        // ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงููุชุฑุงููุฉ
        let balance = 0;
        transactions.forEach(transaction => {
            balance += transaction.debit - transaction.credit;
            transaction.balance = balance;
        });

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุงูุชุงุฑูุฎ',
            'ุงููุตู',
            'ุงููุฑุฌุน',
            'ูุฏูู',
            'ุฏุงุฆู',
            'ุงูุฑุตูุฏ'
        ];

        const data = transactions.map(transaction => [
            transaction.date,
            transaction.description,
            transaction.reference,
            transaction.debit > 0 ? transaction.debit : '',
            transaction.credit > 0 ? transaction.credit : '',
            transaction.balance
        ]);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        const totalDebits = transactions.reduce((sum, t) => sum + t.debit, 0);
        const totalCredits = transactions.reduce((sum, t) => sum + t.credit, 0);
        const finalBalance = totalDebits - totalCredits;

        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            totalDebits,
            totalCredits,
            finalBalance
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, `ูุดู ุญุณุงุจ ${customer.name}`);

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ูุดู ุงูุญุณุงุจ');

        // ุฅุถุงูุฉ ูุฑูุฉ ูุนูููุงุช ุงูุนููู
        const customerInfoSheet = createCustomerInfoSheet(customer, fromDate, toDate, totalDebits, totalCredits, finalBalance);
        XLSX.utils.book_append_sheet(workbook, customerInfoSheet, 'ูุนูููุงุช ุงูุนููู');

        // ุญูุธ ุงูููู
        const fileName = `ูุดู_ุญุณุงุจ_${customer.name}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูุนููู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูุนููู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูุนููู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

function exportSalesReport(format) {
    console.log(`๐ค ุชุตุฏูุฑ ุชูุฑูุฑ ุงููุจูุนุงุช ุจุตูุบุฉ: ${format}`);

    const summarySection = document.getElementById('salesReportSummary');
    if (!summarySection || summarySection.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    try {
        if (format === 'excel') {
            exportToExcel('sales-report', 'ุชูุฑูุฑ ุงููุจูุนุงุช');
        } else {
            printContent('sales-report', 'ุชูุฑูุฑ ุงููุจูุนุงุช');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุงููุจูุนุงุช:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

function exportPurchaseReport(format) {
    console.log(`๐ค ุชุตุฏูุฑ ุชูุฑูุฑ ุงููุดุชุฑูุงุช ุจุตูุบุฉ: ${format}`);

    const summarySection = document.getElementById('purchaseReportSummary');
    if (!summarySection || summarySection.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    try {
        if (format === 'excel') {
            exportToExcel('purchase-report', 'ุชูุฑูุฑ ุงููุดุชุฑูุงุช');
        } else {
            printContent('purchase-report', 'ุชูุฑูุฑ ุงููุดุชุฑูุงุช');
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุงููุดุชุฑูุงุช:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function printSalesReport() {
    const fromDate = document.getElementById('salesReportFromDate')?.value;
    const toDate = document.getElementById('salesReportToDate')?.value;
    const customerId = document.getElementById('salesReportCustomer')?.value;
    const productId = document.getElementById('salesReportProduct')?.value;

    if (!fromDate || !toDate) {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    // ุชุตููุฉ ุงูููุงุชูุฑ
    let salesInvoices = appData.invoices.filter(inv =>
        inv.invoiceType === 'sale' &&
        inv.status === 'confirmed' &&
        inv.invoiceDate >= fromDate &&
        inv.invoiceDate <= toDate
    );

    // ุชุทุจูู ุงูููุงุชุฑ
    if (customerId) {
        salesInvoices = salesInvoices.filter(inv => inv.customerId == customerId);
    }
    if (productId) {
        salesInvoices = salesInvoices.filter(inv =>
            inv.items.some(item => item.productId == productId)
        );
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalSales = salesInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);
    const totalInvoices = salesInvoices.length;
    const averageInvoice = totalInvoices > 0 ? totalSales / totalInvoices : 0;
    const pendingAmount = salesInvoices.reduce((sum, inv) => sum + inv.remainingAmount, 0);

    // ุฅูุดุงุก HTML ููุทุจุงุนุฉ
    const printContent = generateSalesReportPrintHTML(salesInvoices, {
        fromDate,
        toDate,
        totalSales,
        totalInvoices,
        averageInvoice,
        pendingAmount,
        customerId,
        productId
    });

    printDocument(printContent, 'ุชูุฑูุฑ ุงููุจูุนุงุช');
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงููุดุชุฑูุงุช
 */
function printPurchaseReport() {
    const fromDate = document.getElementById('purchaseReportFromDate')?.value;
    const toDate = document.getElementById('purchaseReportToDate')?.value;
    const supplierId = document.getElementById('purchaseReportSupplier')?.value;
    const productId = document.getElementById('purchaseReportProduct')?.value;

    if (!fromDate || !toDate) {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    // ุชุตููุฉ ุงูููุงุชูุฑ
    let purchaseInvoices = appData.invoices.filter(inv =>
        inv.invoiceType === 'purchase' &&
        inv.status === 'confirmed' &&
        inv.invoiceDate >= fromDate &&
        inv.invoiceDate <= toDate
    );

    // ุชุทุจูู ุงูููุงุชุฑ
    if (supplierId) {
        purchaseInvoices = purchaseInvoices.filter(inv => inv.supplierId == supplierId);
    }
    if (productId) {
        purchaseInvoices = purchaseInvoices.filter(inv =>
            inv.items.some(item => item.productId == productId)
        );
    }

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalPurchases = purchaseInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);
    const totalInvoices = purchaseInvoices.length;
    const averageInvoice = totalInvoices > 0 ? totalPurchases / totalInvoices : 0;
    const pendingAmount = purchaseInvoices.reduce((sum, inv) => sum + inv.remainingAmount, 0);

    // ุฅูุดุงุก HTML ููุทุจุงุนุฉ
    const printContent = generatePurchaseReportPrintHTML(purchaseInvoices, {
        fromDate,
        toDate,
        totalPurchases,
        totalInvoices,
        averageInvoice,
        pendingAmount,
        supplierId,
        productId
    });

    printDocument(printContent, 'ุชูุฑูุฑ ุงููุดุชุฑูุงุช');
}

function printStatement() {
    printContent('customer-statement', 'ูุดู ุญุณุงุจ ุงูุนููู');
}

function printInvoice(id) {
    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงุชูุฑุฉ');
        return;
    }

    const customer = appData.customers.find(c => c.id === invoice.customerId);
    const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
    const client = customer || supplier;

    const printContent = generateInvoicePrintHTML(invoice, client);
    printDocument(printContent, `ูุงุชูุฑุฉ ุฑูู ${invoice.invoiceNumber}`);
}

function printReceipt(id) {
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงููุจุถ');
        return;
    }

    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const printContent = generateReceiptPrintHTML(receipt, customer);
    printDocument(printContent, `ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber}`);
}







function printPayment(id) {
    const payment = appData.payments.find(p => p.id === id && p.paymentType === 'payment');
    if (!payment) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงูุฏูุน');
        return;
    }

    const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
    const printContent = generatePaymentPrintHTML(payment, supplier);
    printDocument(printContent, `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber}`);
}







/**
 * ุชุตุฏูุฑ ูุงุฆูุฉ ุณูุฏุงุช ุงููุจุถ ุฅูู Excel
 */
function exportReceiptsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุณูุฏุงุช ุงููุจุถ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฌูุน ุจูุงูุงุช ุณูุฏุงุช ุงููุจุถ
        const receipts = (appData.payments || []).filter(p => p.paymentType === 'receipt');

        if (receipts.length === 0) {
            alert('ูุง ุชูุฌุฏ ุณูุฏุงุช ูุจุถ ููุชุตุฏูุฑ');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุนูุงููู
        const headers = [
            'ุฑูู ุงูุณูุฏ',
            'ุงูุชุงุฑูุฎ',
            'ุงูุนููู',
            'ุงููุจูุบ',
            'ุงูุนููุฉ',
            'ุทุฑููุฉ ุงูุฏูุน',
            'ุฑูู ุงููุฑุฌุน',
            'ุงูุจูู',
            'ููุงุญุธุงุช'
        ];

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช
        const data = receipts.map(receipt => {
            const customer = appData.customers?.find(c => c.id === receipt.customerId);
            return [
                receipt.paymentNumber || '',
                receipt.paymentDate || '',
                customer ? customer.name : 'ุนููู ูุญุฐูู',
                receipt.amount || 0,
                receipt.currency || 'SYP',
                getPaymentMethodText(receipt.paymentMethod) || '',
                receipt.referenceNumber || '',
                receipt.bankName || '',
                receipt.notes || ''
            ];
        });

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู ูุน ุงูุชูุณูู ุงููุญุณู
        const worksheet = createFormattedWorksheet(headers, data, 'ุณูุฏุงุช ุงููุจุถ');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุณูุฏุงุช ุงููุจุถ');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูุฅุญุตุงุฆูุงุช
        const statsSheet = createReceiptsStatsSheet(receipts);
        XLSX.utils.book_append_sheet(workbook, statsSheet, 'ุงูุฅุญุตุงุฆูุงุช');

        // ุญูุธ ุงูููู
        const fileName = `ุณูุฏุงุช_ุงููุจุถ_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุณูุฏุงุช ุงููุจุถ ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุณูุฏุงุช ุงููุจุถ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุณูุฏุงุช ุงููุจุถ ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ูุงุฆูุฉ ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel
 */
function exportPaymentsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฌูุน ุจูุงูุงุช ุณูุฏุงุช ุงูุฏูุน
        const payments = (appData.payments || []).filter(p => p.paymentType === 'payment');

        if (payments.length === 0) {
            alert('ูุง ุชูุฌุฏ ุณูุฏุงุช ุฏูุน ููุชุตุฏูุฑ');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุนูุงููู
        const headers = [
            'ุฑูู ุงูุณูุฏ',
            'ุงูุชุงุฑูุฎ',
            'ุงูููุฑุฏ',
            'ุงููุจูุบ',
            'ุงูุนููุฉ',
            'ุทุฑููุฉ ุงูุฏูุน',
            'ุฑูู ุงููุฑุฌุน',
            'ุงูุจูู',
            'ููุงุญุธุงุช'
        ];

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช
        const data = payments.map(payment => {
            const supplier = appData.suppliers?.find(s => s.id === payment.supplierId);
            return [
                payment.paymentNumber || '',
                payment.paymentDate || '',
                supplier ? supplier.name : 'ููุฑุฏ ูุญุฐูู',
                payment.amount || 0,
                payment.currency || 'SYP',
                getPaymentMethodText(payment.paymentMethod) || '',
                payment.referenceNumber || '',
                payment.bankName || '',
                payment.notes || ''
            ];
        });

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู ูุน ุงูุชูุณูู ุงููุญุณู
        const worksheet = createFormattedWorksheet(headers, data, 'ุณูุฏุงุช ุงูุฏูุน');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุณูุฏุงุช ุงูุฏูุน');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูุฅุญุตุงุฆูุงุช
        const statsSheet = createPaymentsStatsSheet(payments);
        XLSX.utils.book_append_sheet(workbook, statsSheet, 'ุงูุฅุญุตุงุฆูุงุช');

        // ุญูุธ ุงูููู
        const fileName = `ุณูุฏุงุช_ุงูุฏูุน_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุนูู ููุณูุฉ
 */
function createFormattedWorksheet(headers, data, title) {
    // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);

    // ุชุญุณูู ุนุฑุถ ุงูุฃุนูุฏุฉ
    const colWidths = headers.map((header, index) => {
        let maxLength = header.length;

        data.forEach(row => {
            if (row[index] && row[index].toString().length > maxLength) {
                maxLength = row[index].toString().length;
            }
        });

        return { wch: Math.min(Math.max(maxLength + 2, 12), 25) };
    });
    worksheet['!cols'] = colWidths;

    // ุชูุณูู ุงูุฎูุงูุง
    const range = XLSX.utils.decode_range(worksheet['!ref']);

    // ุชูุณูู ุฑุฃุณ ุงูุฌุฏูู
    for (let col = range.s.c; col <= range.e.c; col++) {
        const headerCell = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[headerCell]) continue;

        worksheet[headerCell].s = {
            font: { bold: true, color: { rgb: "FFFFFF" }, size: 12 },
            fill: { fgColor: { rgb: "2E75B6" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "medium", color: { rgb: "000000" } },
                bottom: { style: "medium", color: { rgb: "000000" } },
                left: { style: "medium", color: { rgb: "000000" } },
                right: { style: "medium", color: { rgb: "000000" } }
            }
        };
    }

    // ุชูุณูู ุฎูุงูุง ุงูุจูุงูุงุช
    for (let row = range.s.r + 1; row <= range.e.r; row++) {
        for (let col = range.s.c; col <= range.e.c; col++) {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            if (!worksheet[cellAddress]) continue;

            // ุชูุณูู ุฃุณุงุณู
            worksheet[cellAddress].s = {
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "CCCCCC" } },
                    bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                    left: { style: "thin", color: { rgb: "CCCCCC" } },
                    right: { style: "thin", color: { rgb: "CCCCCC" } }
                }
            };

            // ุชูุณูู ุฎุงุต ููุฃุฑูุงู (ุนููุฏ ุงููุจูุบ)
            if (col === 3 && typeof worksheet[cellAddress].v === 'number') {
                worksheet[cellAddress].s.numFmt = '#,##0.00';
                worksheet[cellAddress].s.font = { color: { rgb: "0066CC" }, bold: true };
            }

            // ุชูููู ุงูุตููู ุจุงูุชูุงูุจ
            if (row % 2 === 0) {
                worksheet[cellAddress].s.fill = { fgColor: { rgb: "F8F9FA" } };
            }
        }
    }

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงููุจุถ
 */
function createReceiptsStatsSheet(receipts) {
    const stats = calculateReceiptsStats(receipts);

    const data = [
        ['ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงููุจุถ'],
        [''],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุณูุฏุงุช', receipts.length],
        ['ุฅุฌูุงูู ุงููุจุงูุบ ุญุณุจ ุงูุนููุฉ'],
        [''],
        ...Object.entries(stats.totalsByCurrency).map(([currency, amount]) => [
            getCurrencyName(currency),
            `${formatCurrency(amount)} ${getCurrencySymbol(currency)}`
        ]),
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน'],
        [''],
        ...Object.entries(stats.paymentMethods).map(([method, count]) => [
            getPaymentMethodText(method),
            `${count} ุณูุฏ`
        ]),
        [''],
        ['ูุนูููุงุช ุงูุชุตุฏูุฑ'],
        ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')],
        ['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')],
        ['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']
    ];

    const worksheet = XLSX.utils.aoa_to_sheet(data);

    // ุชูุณูู ูุฑูุฉ ุงูุฅุญุตุงุฆูุงุช
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงูุฏูุน
 */
function createPaymentsStatsSheet(payments) {
    const stats = calculatePaymentsStats(payments);

    const data = [
        ['ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงูุฏูุน'],
        [''],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุณูุฏุงุช', payments.length],
        ['ุฅุฌูุงูู ุงููุจุงูุบ ุญุณุจ ุงูุนููุฉ'],
        [''],
        ...Object.entries(stats.totalsByCurrency).map(([currency, amount]) => [
            getCurrencyName(currency),
            `${formatCurrency(amount)} ${getCurrencySymbol(currency)}`
        ]),
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน'],
        [''],
        ...Object.entries(stats.paymentMethods).map(([method, count]) => [
            getPaymentMethodText(method),
            `${count} ุณูุฏ`
        ]),
        [''],
        ['ูุนูููุงุช ุงูุชุตุฏูุฑ'],
        ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')],
        ['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')],
        ['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']
    ];

    const worksheet = XLSX.utils.aoa_to_sheet(data);

    // ุชูุณูู ูุฑูุฉ ุงูุฅุญุตุงุฆูุงุช
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงููุจุถ
 */
function calculateReceiptsStats(receipts) {
    const stats = {
        totalsByCurrency: {},
        paymentMethods: {}
    };

    receipts.forEach(receipt => {
        const currency = receipt.currency || 'SYP';
        const amount = receipt.amount || 0;
        const method = receipt.paymentMethod || 'cash';

        // ุชุฌููุน ุญุณุจ ุงูุนููุฉ
        if (!stats.totalsByCurrency[currency]) {
            stats.totalsByCurrency[currency] = 0;
        }
        stats.totalsByCurrency[currency] += amount;

        // ุชุฌููุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน
        if (!stats.paymentMethods[method]) {
            stats.paymentMethods[method] = 0;
        }
        stats.paymentMethods[method]++;
    });

    return stats;
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุณูุฏุงุช ุงูุฏูุน
 */
function calculatePaymentsStats(payments) {
    const stats = {
        totalsByCurrency: {},
        paymentMethods: {}
    };

    payments.forEach(payment => {
        const currency = payment.currency || 'SYP';
        const amount = payment.amount || 0;
        const method = payment.paymentMethod || 'cash';

        // ุชุฌููุน ุญุณุจ ุงูุนููุฉ
        if (!stats.totalsByCurrency[currency]) {
            stats.totalsByCurrency[currency] = 0;
        }
        stats.totalsByCurrency[currency] += amount;

        // ุชุฌููุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน
        if (!stats.paymentMethods[method]) {
            stats.paymentMethods[method] = 0;
        }
        stats.paymentMethods[method]++;
    });

    return stats;
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุงูุนููุฉ
 */
function getCurrencyName(currency) {
    const names = {
        'SYP': 'ุงูููุฑุฉ ุงูุณูุฑูุฉ',
        'USD': 'ุงูุฏููุงุฑ ุงูุฃูุฑููู',
        'EUR': 'ุงูููุฑู',
        'TRY': 'ุงูููุฑุฉ ุงูุชุฑููุฉ',
        'SAR': 'ุงูุฑูุงู ุงูุณุนูุฏู',
        'AED': 'ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู',
        'LBP': 'ุงูููุฑุฉ ุงููุจูุงููุฉ',
        'GBP': 'ุงูุฌููู ุงูุฅุณุชุฑูููู'
    };
    return names[currency] || currency;
}

/**
 * ุงูุญุตูู ุนูู ุฑูุฒ ุงูุนููุฉ
 */
function getCurrencySymbol(currency) {
    const symbols = {
        'SYP': 'ู.ุณ',
        'USD': '$',
        'EUR': 'โฌ',
        'TRY': 'โบ',
        'SAR': 'ุฑ.ุณ',
        'AED': 'ุฏ.ุฅ',
        'LBP': 'ู.ู',
        'GBP': 'ยฃ'
    };
    return symbols[currency] || currency;
}

/**
 * ุทุจุงุนุฉ ูุญุชูู ุนุงู
 */
function printContent(pageType, title) {
    const content = document.getElementById('main-content').innerHTML;
    const printContent = generatePrintHTML(content, title);
    printDocument(printContent, title);
}

/**
 * ุฅูุดุงุก HTML ููุทุจุงุนุฉ
 */
function generatePrintHTML(content, title) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>${title}</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    margin: 20px;
                    direction: rtl;
                    font-size: 14px;
                }
                .header {
                    text-align: center;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .company-info {
                    margin-bottom: 20px;
                }
                .logo {
                    margin-bottom: 10px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: right;
                }
                th {
                    background-color: #f5f5f5;
                    font-weight: bold;
                }
                .footer {
                    margin-top: 50px;
                    text-align: center;
                    font-size: 12px;
                    color: #666;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <div class="company-info">
                    <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                    ${settings.companyAddress ? `<p>${settings.companyAddress}</p>` : ''}
                    ${settings.companyPhone ? `<p>ูุงุชู: ${settings.companyPhone}</p>` : ''}
                    ${settings.companyEmail ? `<p>ุจุฑูุฏ ุฅููุชุฑููู: ${settings.companyEmail}</p>` : ''}
                </div>
                <h3>${title}</h3>
            </div>

            <div class="content">
                ${content}
            </div>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุงููุงุชูุฑุฉ
 */
function generateInvoicePrintHTML(invoice, client) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    const itemsHtml = invoice.items ? invoice.items.map(item => {
        const product = appData.products.find(p => p.id === item.productId);
        return `
            <tr>
                <td>
                    <strong>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</strong>
                    ${item.specifications ? `<br><small style="color: #666;">${item.specifications}</small>` : ''}
                </td>
                <td>${item.quantity}</td>
                <td>${formatCurrency(item.unitPrice)}</td>
                <td>${formatCurrency(item.totalAmount)}</td>
            </tr>
        `;
    }).join('') : '';

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ูุงุชูุฑุฉ ุฑูู ${invoice.invoiceNumber}</title>
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                .client-info { width: 48%; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .totals { margin-top: 20px; text-align: left; }
                .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                <h3>ูุงุชูุฑุฉ ${invoice.invoiceType === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'}</h3>
            </div>

            <div class="invoice-info">
                <div class="client-info">
                    <h4>${invoice.invoiceType === 'sale' ? 'ุจูุงูุงุช ุงูุนููู' : 'ุจูุงูุงุช ุงูููุฑุฏ'}</h4>
                    <p><strong>ุงูุงุณู:</strong> ${client ? client.name : 'ุบูุฑ ูุญุฏุฏ'}</p>
                    <p><strong>ุงููุงุชู:</strong> ${client ? client.phone || 'ุบูุฑ ูุญุฏุฏ' : 'ุบูุฑ ูุญุฏุฏ'}</p>
                    <p><strong>ุงูุนููุงู:</strong> ${client ? client.address || 'ุบูุฑ ูุญุฏุฏ' : 'ุบูุฑ ูุญุฏุฏ'}</p>
                </div>
                <div class="invoice-details">
                    <p><strong>ุฑูู ุงููุงุชูุฑุฉ:</strong> ${invoice.invoiceNumber}</p>
                    <p><strong>ุงูุชุงุฑูุฎ:</strong> ${invoice.invoiceDate}</p>
                    <p><strong>ุงูุญุงูุฉ:</strong> ${getStatusText(invoice.status)}</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ุงูุตูู</th>
                        <th>ุงููููุฉ</th>
                        <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                        <th>ุงููุฌููุน</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
                </tbody>
            </table>

            <div class="totals">
                <p><strong>ุงููุฌููุน ุงููุฑุนู:</strong> ${formatCurrency(invoice.subtotal)}</p>
                <p><strong>ุงูุฎุตู:</strong> ${formatCurrency(invoice.discountAmount)}</p>
                <p><strong>ุงูุถุฑูุจุฉ:</strong> ${formatCurrency(invoice.taxAmount)}</p>
                <h3><strong>ุงููุฌููุน ุงูููุงุฆู:</strong> ${formatCurrency(invoice.totalAmount)}</h3>
                <p><strong>ุงููุฏููุน:</strong> ${formatCurrency(invoice.paidAmount)}</p>
                <p><strong>ุงููุชุจูู:</strong> ${formatCurrency(invoice.remainingAmount)}</p>
            </div>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุณูุฏ ุงููุจุถ
 */
function generateReceiptPrintHTML(receipt, customer) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    const methodText = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber}</title>
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                .receipt-info { margin-bottom: 30px; }
                .amount-box { border: 2px solid #333; padding: 20px; text-align: center; margin: 20px 0; }
                .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
                .signature-area { margin-top: 50px; display: flex; justify-content: space-between; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                <h3>ุณูุฏ ูุจุถ</h3>
            </div>

            <div class="receipt-info">
                <p><strong>ุฑูู ุงูุณูุฏ:</strong> ${receipt.paymentNumber}</p>
                <p><strong>ุงูุชุงุฑูุฎ:</strong> ${receipt.paymentDate}</p>
                <p><strong>ุงูุนููู:</strong> ${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</p>
                <p><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${methodText[receipt.paymentMethod] || receipt.paymentMethod}</p>
                ${receipt.referenceNumber ? `<p><strong>ุฑูู ุงููุฑุฌุน:</strong> ${receipt.referenceNumber}</p>` : ''}
                ${receipt.bankName ? `<p><strong>ุงูุจูู:</strong> ${receipt.bankName}</p>` : ''}
            </div>

            <div class="amount-box">
                <h2>ุงููุจูุบ ุงูููุจูุถ: ${formatCurrency(receipt.amount)}</h2>
            </div>

            ${receipt.notes ? `<p><strong>ููุงุญุธุงุช:</strong> ${receipt.notes}</p>` : ''}

            <div class="signature-area">
                <div>
                    <p>ุชูููุน ุงููุญุงุณุจ</p>
                    <p>_________________</p>
                </div>
                <div>
                    <p>ุชูููุน ุงูุนููู</p>
                    <p>_________________</p>
                </div>
            </div>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุณูุฏ ุงูุฏูุน
 */
function generatePaymentPrintHTML(payment, supplier) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    const methodText = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber}</title>
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                .payment-info { margin-bottom: 30px; }
                .amount-box { border: 2px solid #333; padding: 20px; text-align: center; margin: 20px 0; }
                .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
                .signature-area { margin-top: 50px; display: flex; justify-content: space-between; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                <h3>ุณูุฏ ุฏูุน</h3>
            </div>

            <div class="payment-info">
                <p><strong>ุฑูู ุงูุณูุฏ:</strong> ${payment.paymentNumber}</p>
                <p><strong>ุงูุชุงุฑูุฎ:</strong> ${payment.paymentDate}</p>
                <p><strong>ุงูููุฑุฏ:</strong> ${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</p>
                <p><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${methodText[payment.paymentMethod] || payment.paymentMethod}</p>
                ${payment.referenceNumber ? `<p><strong>ุฑูู ุงููุฑุฌุน:</strong> ${payment.referenceNumber}</p>` : ''}
                ${payment.bankName ? `<p><strong>ุงูุจูู:</strong> ${payment.bankName}</p>` : ''}
            </div>

            <div class="amount-box">
                <h2>ุงููุจูุบ ุงููุฏููุน: ${formatCurrency(payment.amount)}</h2>
            </div>

            ${payment.notes ? `<p><strong>ููุงุญุธุงุช:</strong> ${payment.notes}</p>` : ''}

            <div class="signature-area">
                <div>
                    <p>ุชูููุน ุงููุญุงุณุจ</p>
                    <p>_________________</p>
                </div>
                <div>
                    <p>ุชูููุน ุงูููุฑุฏ</p>
                    <p>_________________</p>
                </div>
            </div>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function generateSalesReportPrintHTML(invoices, stats) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    const customerFilter = stats.customerId ? appData.customers.find(c => c.id == stats.customerId) : null;
    const productFilter = stats.productId ? appData.products.find(p => p.id == stats.productId) : null;

    const invoicesHtml = invoices.map(invoice => {
        const customer = appData.customers.find(c => c.id === invoice.customerId);
        return `
            <tr>
                <td>${invoice.invoiceNumber}</td>
                <td>${invoice.invoiceDate}</td>
                <td>${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${formatCurrency(invoice.totalAmount)}</td>
                <td>${formatCurrency(invoice.paidAmount)}</td>
                <td>${formatCurrency(invoice.remainingAmount)}</td>
                <td>${getStatusText(invoice.status)}</td>
            </tr>
        `;
    }).join('');

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุฑูุฑ ุงููุจูุนุงุช</title>
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; font-size: 14px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                .logo { margin-bottom: 10px; }
                .company-info { margin-bottom: 20px; }
                .report-info { margin-bottom: 30px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
                .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                .stat-box { text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
                @media print { body { margin: 0; } .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <div class="company-info">
                    <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                    ${settings.companyAddress ? `<p>${settings.companyAddress}</p>` : ''}
                    ${settings.companyPhone ? `<p>ูุงุชู: ${settings.companyPhone}</p>` : ''}
                </div>
                <h3>ุชูุฑูุฑ ุงููุจูุนุงุช</h3>
            </div>

            <div class="report-info">
                <h4>ูุนูููุงุช ุงูุชูุฑูุฑ</h4>
                <p><strong>ุงููุชุฑุฉ:</strong> ูู ${stats.fromDate} ุฅูู ${stats.toDate}</p>
                ${customerFilter ? `<p><strong>ุงูุนููู:</strong> ${customerFilter.name}</p>` : ''}
                ${productFilter ? `<p><strong>ุงูููุชุฌ:</strong> ${productFilter.name}</p>` : ''}
                <p><strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong> ${formatDateTime(new Date())}</p>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <h4>${formatCurrency(stats.totalSales)}</h4>
                    <p>ุฅุฌูุงูู ุงููุจูุนุงุช</p>
                </div>
                <div class="stat-box">
                    <h4>${stats.totalInvoices}</h4>
                    <p>ุนุฏุฏ ุงูููุงุชูุฑ</p>
                </div>
                <div class="stat-box">
                    <h4>${formatCurrency(stats.averageInvoice)}</h4>
                    <p>ูุชูุณุท ุงููุงุชูุฑุฉ</p>
                </div>
                <div class="stat-box">
                    <h4>${formatCurrency(stats.pendingAmount)}</h4>
                    <p>ุงููุจุงูุบ ุงููุนููุฉ</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุนููู</th>
                        <th>ุงููุฌููุน</th>
                        <th>ุงููุฏููุน</th>
                        <th>ุงููุชุจูู</th>
                        <th>ุงูุญุงูุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoicesHtml}
                </tbody>
            </table>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก HTML ูุทุจุงุนุฉ ุชูุฑูุฑ ุงููุดุชุฑูุงุช
 */
function generatePurchaseReportPrintHTML(invoices, stats) {
    const settings = appData.settings;
    const logoHtml = settings.logoUrl ? `<img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 80px;">` : '';

    const supplierFilter = stats.supplierId ? appData.suppliers.find(s => s.id == stats.supplierId) : null;
    const productFilter = stats.productId ? appData.products.find(p => p.id == stats.productId) : null;

    const invoicesHtml = invoices.map(invoice => {
        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
        return `
            <tr>
                <td>${invoice.invoiceNumber}</td>
                <td>${invoice.invoiceDate}</td>
                <td>${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${formatCurrency(invoice.totalAmount)}</td>
                <td>${formatCurrency(invoice.paidAmount)}</td>
                <td>${formatCurrency(invoice.remainingAmount)}</td>
                <td>${getStatusText(invoice.status)}</td>
            </tr>
        `;
    }).join('');

    return `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุฑูุฑ ุงููุดุชุฑูุงุช</title>
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; direction: rtl; font-size: 14px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                .logo { margin-bottom: 10px; }
                .company-info { margin-bottom: 20px; }
                .report-info { margin-bottom: 30px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
                .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                .stat-box { text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f5f5f5; font-weight: bold; }
                .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
                @media print { body { margin: 0; } .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">${logoHtml}</div>
                <div class="company-info">
                    <h2>${settings.companyName || 'ุดุฑูุฉ SAM PRO'}</h2>
                    ${settings.companyAddress ? `<p>${settings.companyAddress}</p>` : ''}
                    ${settings.companyPhone ? `<p>ูุงุชู: ${settings.companyPhone}</p>` : ''}
                </div>
                <h3>ุชูุฑูุฑ ุงููุดุชุฑูุงุช</h3>
            </div>

            <div class="report-info">
                <h4>ูุนูููุงุช ุงูุชูุฑูุฑ</h4>
                <p><strong>ุงููุชุฑุฉ:</strong> ูู ${stats.fromDate} ุฅูู ${stats.toDate}</p>
                ${supplierFilter ? `<p><strong>ุงูููุฑุฏ:</strong> ${supplierFilter.name}</p>` : ''}
                ${productFilter ? `<p><strong>ุงูููุชุฌ:</strong> ${productFilter.name}</p>` : ''}
                <p><strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong> ${formatDateTime(new Date())}</p>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <h4>${formatCurrency(stats.totalPurchases)}</h4>
                    <p>ุฅุฌูุงูู ุงููุดุชุฑูุงุช</p>
                </div>
                <div class="stat-box">
                    <h4>${stats.totalInvoices}</h4>
                    <p>ุนุฏุฏ ุงูููุงุชูุฑ</p>
                </div>
                <div class="stat-box">
                    <h4>${formatCurrency(stats.averageInvoice)}</h4>
                    <p>ูุชูุณุท ุงููุงุชูุฑุฉ</p>
                </div>
                <div class="stat-box">
                    <h4>${formatCurrency(stats.pendingAmount)}</h4>
                    <p>ุงููุจุงูุบ ุงููุนููุฉ</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูููุฑุฏ</th>
                        <th>ุงููุฌููุน</th>
                        <th>ุงููุฏููุน</th>
                        <th>ุงููุชุจูู</th>
                        <th>ุงูุญุงูุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoicesHtml}
                </tbody>
            </table>

            <div class="footer">
                <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${formatDateTime(new Date())}</p>
                <p>ุชุทููุฑ: MOHANNAD AHMAD - ูุงุชู: +963-998-171-954</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * ุทุจุงุนุฉ ุงููุณุชูุฏ
 */
function printDocument(htmlContent, title) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// ูุธุงุฆู ุงูุณูุฏุงุช ุงูุฅุถุงููุฉ
function viewReceipt(id) {
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงููุจุถ');
        return;
    }

    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const methodText = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'viewReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>ุงูุนููู:</strong> ${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</div>
                        <div class="col-md-6"><strong>ุงูุชุงุฑูุฎ:</strong> ${receipt.paymentDate}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>ุงููุจูุบ:</strong> ${formatCurrency(receipt.amount)}</div>
                        <div class="col-md-6"><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${methodText[receipt.paymentMethod] || receipt.paymentMethod}</div>
                    </div>
                    ${receipt.referenceNumber ? `<div class="row mb-3"><div class="col-12"><strong>ุฑูู ุงููุฑุฌุน:</strong> ${receipt.referenceNumber}</div></div>` : ''}
                    ${receipt.bankName ? `<div class="row mb-3"><div class="col-12"><strong>ุงูุจูู:</strong> ${receipt.bankName}</div></div>` : ''}
                    ${receipt.notes ? `<div class="row mb-3"><div class="col-12"><strong>ููุงุญุธุงุช:</strong> ${receipt.notes}</div></div>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="printReceipt(${receipt.id})">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function editReceipt(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('receipts')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุณูุฏุงุช ุงููุจุถ');
        return;
    }

    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงููุจุถ');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editReceiptModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุณูุฏ ุงููุจุถ - ${receipt.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReceiptForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCustomer" required>
                                    <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                                    ${appData.customers.map(c => `<option value="${c.id}" ${c.id === receipt.customerId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editReceiptDate" value="${receipt.paymentDate}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editReceiptAmount" value="${receipt.amount}" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptCurrency" required>
                                    <option value="SYP" ${receipt.currency === 'SYP' ? 'selected' : ''}>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD" ${receipt.currency === 'USD' ? 'selected' : ''}>ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR" ${receipt.currency === 'EUR' ? 'selected' : ''}>ููุฑู (โฌ)</option>
                                    <option value="TRY" ${receipt.currency === 'TRY' ? 'selected' : ''}>ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR" ${receipt.currency === 'SAR' ? 'selected' : ''}>ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED" ${receipt.currency === 'AED' ? 'selected' : ''}>ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editReceiptMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="editReceiptMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash" ${receipt.paymentMethod === 'cash' ? 'selected' : ''}>ููุฏู</option>
                                    <option value="bank" ${receipt.paymentMethod === 'bank' ? 'selected' : ''}>ุชุญููู ุจููู</option>
                                    <option value="check" ${receipt.paymentMethod === 'check' ? 'selected' : ''}>ุดูู</option>
                                    <option value="card" ${receipt.paymentMethod === 'card' ? 'selected' : ''}>ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="editReceiptReference" value="${receipt.referenceNumber || ''}" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editReceiptBank" class="form-label">ุงุณู ุงูุจูู</label>
                                <input type="text" class="form-control" id="editReceiptBank" value="${receipt.bankName || ''}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editReceiptNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveReceiptEdit(${id})">
                        <i class="fas fa-save me-1"></i>
                        ุญูุธ ุงูุชุนุฏููุงุช
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุชุนุฏููุงุช ุณูุฏ ุงููุจุถ
 */
function saveReceiptEdit(id) {
    try {
        const customerId = parseInt(document.getElementById('editReceiptCustomer').value);
        const date = document.getElementById('editReceiptDate').value;
        const amount = parseFloat(document.getElementById('editReceiptAmount').value);
        const currency = document.getElementById('editReceiptCurrency').value;
        const method = document.getElementById('editReceiptMethod').value;
        const reference = document.getElementById('editReceiptReference').value.trim();
        const bank = document.getElementById('editReceiptBank').value.trim();
        const notes = document.getElementById('editReceiptNotes').value.trim();

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (!customerId || !date || !amount || !currency || !method || amount <= 0) {
            alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
            return;
        }

        // ุงูุนุซูุฑ ุนูู ุงูุณูุฏ
        const receiptIndex = appData.payments.findIndex(p => p.id === id && p.paymentType === 'receipt');
        if (receiptIndex === -1) {
            alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
            return;
        }

        const oldReceipt = appData.payments[receiptIndex];
        const customer = appData.customers.find(c => c.id === customerId);
        if (!customer) {
            alert('ุงูุนููู ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุงููุฏูู ุนูู ุงูุนููู
        if (oldReceipt.customerId) {
            const oldCustomer = appData.customers.find(c => c.id === oldReceipt.customerId);
            if (oldCustomer) {
                oldCustomer.totalPayments = (oldCustomer.totalPayments || 0) - oldReceipt.amount;
                if (oldCustomer.balances && oldCustomer.balances[oldReceipt.currency]) {
                    oldCustomer.balances[oldReceipt.currency] += oldReceipt.amount;
                }
                if (oldReceipt.currency === (appData.settings.currency || 'SYP')) {
                    oldCustomer.currentBalance = (oldCustomer.currentBalance || 0) + oldReceipt.amount;
                }
            }
        }

        // ุชุญุฏูุซ ุงูุณูุฏ
        appData.payments[receiptIndex] = {
            ...oldReceipt,
            customerId: customerId,
            paymentDate: date,
            amount: amount,
            currency: currency,
            paymentMethod: method,
            referenceNumber: reference,
            bankName: bank,
            notes: notes,
            updatedAt: new Date().toISOString()
        };

        // ุชุทุจูู ุชุฃุซูุฑ ุงูุณูุฏ ุงูุฌุฏูุฏ ุนูู ุงูุนููู
        updateCustomerPayment(customerId, amount, currency, date);

        // ุชุญุฏูุซ ุงูููุฏ ุงููุญุงุณุจู
        const journalEntryIndex = appData.journalEntries.findIndex(entry => entry.paymentId === id);
        if (journalEntryIndex !== -1) {
            appData.journalEntries[journalEntryIndex] = {
                ...appData.journalEntries[journalEntryIndex],
                entryDate: date,
                description: `ุณูุฏ ูุจุถ ุฑูู ${oldReceipt.paymentNumber} - ${customer.name} (ูุนุฏู)`,
                debitAccount: method === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                creditAccount: 'ุงูุนููุงุก',
                debitAmount: amount,
                creditAmount: amount,
                currency: currency,
                customerId: customerId,
                updatedAt: new Date().toISOString()
            };
        }

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editReceiptModal'));
        if (modal) {
            modal.hide();
        }

        alert('ุชู ุชุญุฏูุซ ุณูุฏ ุงููุจุถ ุจูุฌุงุญ');
        showPage('receipts');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุนุฏูู ุณูุฏ ุงููุจุถ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุณูุฏ ุงููุจุถ: ' + error.message);
    }
}

/**
 * ุญุฐู ุณูุฏ ูุจุถ
 */
function deleteReceipt(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('receipts')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุณูุฏุงุช ุงููุจุถ');
        return;
    }

    console.log('๐๏ธ ุทูุจ ุญุฐู ุณูุฏ ุงููุจุถ:', id);

    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุณูุฏ
    const receipt = appData.payments.find(p => p.id === id && p.paymentType === 'receipt');
    if (!receipt) {
        alert('ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ');
        console.error('โ ุณูุฏ ุงููุจุถ ุบูุฑ ููุฌูุฏ:', id);
        return;
    }

    // ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุนููู
    const customer = appData.customers.find(c => c.id === receipt.customerId);
    const clientName = customer?.name || 'ุนููู ูุญุฐูู';
    const currencySymbol = getCurrencySymbol(receipt.currency || 'SYP');
    const currencyName = getCurrencyName(receipt.currency || 'SYP');

    // ุฑุณุงูุฉ ุชุฃููุฏ ููุตูุฉ
    const confirmMessage = `โ๏ธ ุชุฃููุฏ ุญุฐู ุณูุฏ ุงููุจุถ

๐ ุฑูู ุงูุณูุฏ: ${receipt.paymentNumber}
๐ค ุงูุนููู: ${clientName}
๐ฐ ุงููุจูุบ: ${formatCurrency(receipt.amount, receipt.currency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ ุงูุชุงุฑูุฎ: ${receipt.paymentDate}

โ๏ธ ุชุญุฐูุฑ: ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุคุซุฑ ุนูู:
โข ุฃุฑุตุฏุฉ ุงูุนููุงุก
โข ุงููููุฏ ุงููุญุงุณุจูุฉ
โข ุชูุงุฑูุฑ ุงูุญุณุงุจุงุช

ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุชุงุจุนุฉุ`;

    if (confirm(confirmMessage)) {

        try {
            console.log('๐๏ธ ุจุฏุก ุญุฐู ุณูุฏ ุงููุจุถ:', receipt.paymentNumber);

            // ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุนูู ุฃุฑุตุฏุฉ ุงูุนููุงุก
            const currency = receipt.currency || appData.settings.currency || 'SYP';

            if (receipt.customerId && customer) {
                console.log('๐ค ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุนูู ุงูุนููู:', customer.name);

                // ุทุฑุญ ุงููุจูุบ ูู ุฅุฌูุงูู ุงููุฏููุนุงุช ูุฅุถุงูุชู ููุฑุตูุฏ
                const oldTotalPayments = customer.totalPayments || 0;
                customer.totalPayments = Math.max(0, oldTotalPayments - receipt.amount);
                customer.transactionCount = Math.max(0, (customer.transactionCount || 1) - 1);

                // ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ
                if (!customer.balances) customer.balances = {};
                if (!customer.balances[currency]) customer.balances[currency] = 0;
                customer.balances[currency] += receipt.amount; // ุฅุฑุฌุงุน ุงููุจูุบ ููุฑุตูุฏ

                // ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู ููุนููุฉ ุงูุฃุณุงุณูุฉ
                if (currency === (appData.settings.currency || 'SYP')) {
                    customer.currentBalance = (customer.currentBalance || 0) + receipt.amount;
                }

                console.log(`โ ุชู ุชุนุฏูู ุฑุตูุฏ ุงูุนููู ${customer.name} - ุงููุจูุบ ุงููุณุชุฑุฏ: ${receipt.amount} ${getCurrencySymbol(currency)}`);
            } else if (receipt.customerId) {
                console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู ูุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ');
            }

            // ุญุฐู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฑุชุจุทุฉ
            if (appData.journalEntries) {
                const entriesCountBefore = appData.journalEntries.length;
                appData.journalEntries = appData.journalEntries.filter(entry =>
                    entry.paymentId !== id && entry.referenceId !== id
                );
                const entriesCountAfter = appData.journalEntries.length;
                const deletedEntries = entriesCountBefore - entriesCountAfter;
                if (deletedEntries > 0) {
                    console.log(`๐ ุชู ุญุฐู ${deletedEntries} ููุฏ ูุญุงุณุจู`);
                } else {
                    console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฏ ูุญุงุณุจูุฉ ูุฑุชุจุทุฉ ุจุงูุณูุฏ');
                }
            }

            // ุญุฐู ุงูุณูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            const paymentsCountBefore = appData.payments.length;
            appData.payments = appData.payments.filter(p => p.id !== id);
            const paymentsCountAfter = appData.payments.length;

            if (paymentsCountBefore === paymentsCountAfter) {
                throw new Error('ูุดู ูู ุญุฐู ุงูุณูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
            }

            // ุญูุธ ุงูุจูุงูุงุช
            try {
                saveData();
                console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุงูุญุฐู');
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);
                throw new Error('ูุดู ูู ุญูุธ ุงูุจูุงูุงุช ุจุนุฏ ุงูุญุฐู');
            }

            console.log('โ ุชู ุญุฐู ุณูุฏ ุงููุจุถ ุจูุฌุงุญ');

            // ุฑุณุงูุฉ ูุฌุงุญ ููุตูุฉ
            const successMessage = `โ ุชู ุญุฐู ุณูุฏ ุงููุจุถ ุจูุฌุงุญ!

๐ ุฑูู ุงูุณูุฏ: ${receipt.paymentNumber}
๐ค ุงูุนููู: ${clientName}
๐ฐ ุงููุจูุบ ุงููุณุชุฑุฏ: ${formatCurrency(receipt.amount, receipt.currency)}

ุชู ุชุญุฏูุซ:
โข ุฑุตูุฏ ุงูุนููู
โข ุงููููุฏ ุงููุญุงุณุจูุฉ
โข ูุงุนุฏุฉ ุงูุจูุงูุงุช`;

            alert(successMessage);

            // ุชุญุฏูุซ ุงูุตูุญุฉ ุงูุญุงููุฉ
            showPage('receipts');

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญุฐู ุณูุฏ ุงููุจุถ:', error);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุณูุฏ ุงููุจุถ: ' + error.message);
        }
    }
}

function viewPayment(id) {
    const payment = appData.payments.find(p => p.id === id && p.paymentType === 'payment');
    if (!payment) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงูุฏูุน');
        return;
    }

    const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
    const methodText = {
        'cash': 'ููุฏู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู'
    };

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'viewPaymentModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>ุงูููุฑุฏ:</strong> ${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</div>
                        <div class="col-md-6"><strong>ุงูุชุงุฑูุฎ:</strong> ${payment.paymentDate}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>ุงููุจูุบ:</strong> ${formatCurrency(payment.amount)}</div>
                        <div class="col-md-6"><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${methodText[payment.paymentMethod] || payment.paymentMethod}</div>
                    </div>
                    ${payment.referenceNumber ? `<div class="row mb-3"><div class="col-12"><strong>ุฑูู ุงููุฑุฌุน:</strong> ${payment.referenceNumber}</div></div>` : ''}
                    ${payment.bankName ? `<div class="row mb-3"><div class="col-12"><strong>ุงูุจูู:</strong> ${payment.bankName}</div></div>` : ''}
                    ${payment.notes ? `<div class="row mb-3"><div class="col-12"><strong>ููุงุญุธุงุช:</strong> ${payment.notes}</div></div>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="printPayment(${payment.id})">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function editPayment(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('payments')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุณูุฏุงุช ุงูุฏูุน');
        return;
    }

    const payment = appData.payments.find(p => p.id === id && p.paymentType === 'payment');
    if (!payment) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุณูุฏ ุงูุฏูุน');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editPaymentModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุณูุฏ ุงูุฏูุน - ${payment.paymentNumber}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPaymentForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPaymentSupplier" class="form-label">ุงูููุฑุฏ <span class="text-danger">*</span></label>
                                <select class="form-select" id="editPaymentSupplier" required>
                                    <option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>
                                    ${appData.suppliers.map(s => `<option value="${s.id}" ${s.id === payment.supplierId ? 'selected' : ''}>${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editPaymentDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editPaymentDate" value="${payment.paymentDate}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editPaymentAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editPaymentAmount" value="${payment.amount}" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPaymentCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                <select class="form-select" id="editPaymentCurrency" required>
                                    <option value="SYP" ${payment.currency === 'SYP' ? 'selected' : ''}>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                    <option value="USD" ${payment.currency === 'USD' ? 'selected' : ''}>ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                    <option value="EUR" ${payment.currency === 'EUR' ? 'selected' : ''}>ููุฑู (โฌ)</option>
                                    <option value="TRY" ${payment.currency === 'TRY' ? 'selected' : ''}>ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                    <option value="SAR" ${payment.currency === 'SAR' ? 'selected' : ''}>ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                    <option value="AED" ${payment.currency === 'AED' ? 'selected' : ''}>ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editPaymentMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                <select class="form-select" id="editPaymentMethod" required>
                                    <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                    <option value="cash" ${payment.paymentMethod === 'cash' ? 'selected' : ''}>ููุฏู</option>
                                    <option value="bank" ${payment.paymentMethod === 'bank' ? 'selected' : ''}>ุชุญููู ุจููู</option>
                                    <option value="check" ${payment.paymentMethod === 'check' ? 'selected' : ''}>ุดูู</option>
                                    <option value="card" ${payment.paymentMethod === 'card' ? 'selected' : ''}>ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPaymentReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                <input type="text" class="form-control" id="editPaymentReference" value="${payment.referenceNumber || ''}" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editPaymentBank" class="form-label">ุงุณู ุงูุจูู</label>
                                <input type="text" class="form-control" id="editPaymentBank" value="${payment.bankName || ''}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editPaymentNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="editPaymentNotes" rows="3">${payment.notes || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="savePaymentEdit(${id})">
                        <i class="fas fa-save me-1"></i>
                        ุญูุธ ุงูุชุนุฏููุงุช
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุชุนุฏููุงุช ุณูุฏ ุงูุฏูุน
 */
function savePaymentEdit(id) {
    try {
        const supplierId = parseInt(document.getElementById('editPaymentSupplier').value);
        const date = document.getElementById('editPaymentDate').value;
        const amount = parseFloat(document.getElementById('editPaymentAmount').value);
        const currency = document.getElementById('editPaymentCurrency').value;
        const method = document.getElementById('editPaymentMethod').value;
        const reference = document.getElementById('editPaymentReference').value.trim();
        const bank = document.getElementById('editPaymentBank').value.trim();
        const notes = document.getElementById('editPaymentNotes').value.trim();

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (!supplierId || !date || !amount || !currency || !method || amount <= 0) {
            alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
            return;
        }

        // ุงูุนุซูุฑ ุนูู ุงูุณูุฏ
        const paymentIndex = appData.payments.findIndex(p => p.id === id && p.paymentType === 'payment');
        if (paymentIndex === -1) {
            alert('ุณูุฏ ุงูุฏูุน ุบูุฑ ููุฌูุฏ');
            return;
        }

        const oldPayment = appData.payments[paymentIndex];
        const supplier = appData.suppliers.find(s => s.id === supplierId);
        if (!supplier) {
            alert('ุงูููุฑุฏ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุงููุฏูู ุนูู ุงูููุฑุฏ
        if (oldPayment.supplierId) {
            const oldSupplier = appData.suppliers.find(s => s.id === oldPayment.supplierId);
            if (oldSupplier) {
                oldSupplier.totalPayments = (oldSupplier.totalPayments || 0) - oldPayment.amount;
                if (oldSupplier.balances && oldSupplier.balances[oldPayment.currency]) {
                    oldSupplier.balances[oldPayment.currency] += oldPayment.amount;
                }
                if (oldPayment.currency === (appData.settings.currency || 'SYP')) {
                    oldSupplier.currentBalance = (oldSupplier.currentBalance || 0) + oldPayment.amount;
                }
            }
        }

        // ุชุญุฏูุซ ุงูุณูุฏ
        appData.payments[paymentIndex] = {
            ...oldPayment,
            supplierId: supplierId,
            paymentDate: date,
            amount: amount,
            currency: currency,
            paymentMethod: method,
            referenceNumber: reference,
            bankName: bank,
            notes: notes,
            updatedAt: new Date().toISOString()
        };

        // ุชุทุจูู ุชุฃุซูุฑ ุงูุณูุฏ ุงูุฌุฏูุฏ ุนูู ุงูููุฑุฏ
        updateSupplierPayment(supplierId, amount, currency, date);

        // ุชุญุฏูุซ ุงูููุฏ ุงููุญุงุณุจู
        const journalEntryIndex = appData.journalEntries.findIndex(entry => entry.paymentId === id);
        if (journalEntryIndex !== -1) {
            appData.journalEntries[journalEntryIndex] = {
                ...appData.journalEntries[journalEntryIndex],
                entryDate: date,
                description: `ุณูุฏ ุฏูุน ุฑูู ${oldPayment.paymentNumber} - ${supplier.name} (ูุนุฏู)`,
                debitAccount: 'ุงูููุฑุฏูู',
                creditAccount: method === 'cash' ? 'ุงูุตูุฏูู' : 'ุงูุจูู',
                debitAmount: amount,
                creditAmount: amount,
                currency: currency,
                supplierId: supplierId,
                updatedAt: new Date().toISOString()
            };
        }

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentModal'));
        if (modal) {
            modal.hide();
        }

        alert('ุชู ุชุญุฏูุซ ุณูุฏ ุงูุฏูุน ุจูุฌุงุญ');
        showPage('payments');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุนุฏูู ุณูุฏ ุงูุฏูุน:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุณูุฏ ุงูุฏูุน: ' + error.message);
    }
}

/**
 * ุชุณุฌูู ุงูุฏุฎูู
 */
function login(event) {
    event.preventDefault();

    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    console.log('๐ ูุญุงููุฉ ุชุณุฌูู ุฏุฎูู:', username);

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!username || !password) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ');
        return;
    }

    // ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู
    const user = appData.users.find(u => u.username === username && u.password === password);

    if (user) {
        if (!user.isActive) {
            alert('ุญุณุงุจู ูุนุทู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุฏูุฑ');
            return;
        }

        // ุชุญุฏูุซ ุขุฎุฑ ุชุณุฌูู ุฏุฎูู
        user.lastLogin = new Date().toISOString();
        saveData();

        // ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ุงูุชุฎุฒูู ุงููุญูู
        localStorage.setItem('samProLoggedIn', 'true');
        localStorage.setItem('samProCurrentUser', JSON.stringify({
            id: user.id,
            username: user.username,
            fullName: user.fullName,
            role: user.role,
            permissions: user.permissions
        }));

        console.log('โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ:', user.fullName);
        showPage('dashboard');
        alert(`ูุฑุญุจุงู ${user.fullName}!\nุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ`);
    } else {
        console.log('โ ูุดู ุชุณุฌูู ุงูุฏุฎูู');
        alert('ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ');
    }
}

/**
 * ุชุณุฌูู ุงูุฎุฑูุฌ
 */
function logout() {
    const currentUser = getCurrentUser();
    const userName = currentUser ? currentUser.fullName : 'ุงููุณุชุฎุฏู';

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌ ูุง ${userName}ุ`)) {
        console.log('๐ช ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู:', userName);
        localStorage.removeItem('samProLoggedIn');
        localStorage.removeItem('samProCurrentUser');
        showPage('login');
        alert('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ');
    }
}

/**
 * ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
 */
function checkLogin() {
    const isLoggedIn = localStorage.getItem('samProLoggedIn');
    const currentUser = getCurrentUser();

    // ุงูุชุญูู ุงูุฃุณุงุณู ูู ูุฌูุฏ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู
    if (!isLoggedIn || !currentUser) {
        console.log('๐ ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุณุฌูู ุฏุฎูู ุตุญูุญุฉ');
        clearLoginData();
        showPage('login');
        return false;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู
    if (!appData.users || appData.users.length === 0) {
        console.log('๐ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุบูุฑ ููุฌูุฏุฉ');
        clearLoginData();
        showPage('login');
        alert('ุฎุทุฃ ูู ุงููุธุงู: ูุงุนุฏุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุบูุฑ ููุฌูุฏุฉ');
        return false;
    }

    // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุง ุฒุงู ููุฌูุฏุงู ููุดุทุงู
    const user = appData.users.find(u => u.id === currentUser.id);
    if (!user) {
        console.log('๐ ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
        clearLoginData();
        showPage('login');
        alert('ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู');
        return false;
    }

    if (!user.isActive) {
        console.log('๐ ุงููุณุชุฎุฏู ูุนุทู');
        clearLoginData();
        showPage('login');
        alert('ุชู ุชุนุทูู ุญุณุงุจู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุฏูุฑ');
        return false;
    }

    // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญููุธุฉ
    if (currentUser.username !== user.username || currentUser.role !== user.role) {
        console.log('๐ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญููุธุฉ ุบูุฑ ูุชุทุงุจูุฉ');
        clearLoginData();
        showPage('login');
        alert('ุชู ุชุบููุฑ ุจูุงูุงุช ุญุณุงุจู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู');
        return false;
    }

    console.log('โ ุชู ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ ูููุณุชุฎุฏู:', user.fullName);
    return true;
}

/**
 * ูุณุญ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู
 */
function clearLoginData() {
    localStorage.removeItem('samProLoggedIn');
    localStorage.removeItem('samProCurrentUser');
    console.log('๐งน ุชู ูุณุญ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู');
}

/**
 * ุงูุญุตูู ุนูู ุงููุณุชุฎุฏู ุงูุญุงูู
 */
function getCurrentUser() {
    try {
        const userStr = localStorage.getItem('samProCurrentUser');
        return userStr ? JSON.parse(userStr) : null;
    } catch (error) {
        console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู:', error);
        return null;
    }
}

/**
 * ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู
 */
function hasPermission(permission) {
    const currentUser = getCurrentUser();

    // ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏู ูุณุฌู ุฏุฎููุ ุงูุณูุงุญ ุจุงูุนูููุงุช ุงูุฃุณุงุณูุฉ
    if (!currentUser) {
        // ุงูุณูุงุญ ุจุงูุนูููุงุช ุงูุฃุณุงุณูุฉ ููุชุทุจูู
        const basicPermissions = ['receipts', 'payments', 'customers', 'suppliers', 'products', 'invoices', 'dashboard'];
        return basicPermissions.includes(permission);
    }

    // ุงููุฏูุฑ ูู ุฌููุน ุงูุตูุงุญูุงุช
    if (currentUser.role === 'admin') return true;

    // ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ุงููุญุฏุฏุฉ
    return currentUser.permissions && currentUser.permissions[permission] === true;
}

/**
 * ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุตูู ููุตูุญุฉ
 */
function checkPagePermission(pageName) {
    const currentUser = getCurrentUser();
    if (!currentUser) return false;

    // ุงููุฏูุฑ ูู ุตูุงุญูุฉ ุงููุตูู ูุฌููุน ุงูุตูุญุงุช
    if (currentUser.role === 'admin') return true;

    // ุชุญุฏูุฏ ุงูุตูุงุญูุฉ ุงููุทููุจุฉ ููู ุตูุญุฉ
    const pagePermissions = {
        'dashboard': 'dashboard',
        'customers': 'customers',
        'add-customer': 'customers',
        'suppliers': 'suppliers',
        'add-supplier': 'suppliers',
        'products': 'products',
        'add-product': 'products',
        'warehouses': 'warehouses',
        'add-warehouse': 'warehouses',
        'sales-invoices': 'salesInvoices',
        'purchase-invoices': 'purchaseInvoices',
        'create-invoice': 'salesInvoices', // ูููู ุชุฎุตูุตูุง ุญุณุจ ููุน ุงููุงุชูุฑุฉ
        'receipts': 'receipts',
        'payments': 'payments',
        'inventory': 'inventory',
        'reports': 'reports',
        'journal': 'journal',
        'settings': 'settings',
        'backup': 'backup',
        'users': 'users',
        'login': true // ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ูุชุงุญุฉ ููุฌููุน
    };

    const requiredPermission = pagePermissions[pageName];

    // ุฅุฐุง ูู ุชูู ุงูุตูุญุฉ ูุญุฏุฏุฉ ูู ุงููุงุฆูุฉุ ููู ูุญููุฉ ุจุดูู ุงูุชุฑุงุถู
    if (requiredPermission === undefined) {
        console.log('โ๏ธ ุตูุญุฉ ุบูุฑ ูุญุฏุฏุฉ ูู ูุงุฆูุฉ ุงูุตูุงุญูุงุช:', pageName);
        return false;
    }

    // ุฅุฐุง ูุงูุช ุงูุตูุญุฉ ูุชุงุญุฉ ููุฌููุน
    if (requiredPermission === true) {
        return true;
    }

    // ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ุงููุทููุจุฉ
    return hasPermission(requiredPermission);
}

/**
 * ุงูุญุตูู ุนูู ุฑูุฒ ุงูุนููุฉ
 */
function getCurrencySymbol(currencyCode) {
    const currencies = {
        'SYP': 'ู.ุณ',
        'USD': '$',
        'EUR': 'โฌ',
        'TRY': 'โบ',
        'SAR': 'ุฑ.ุณ',
        'AED': 'ุฏ.ุฅ',
        'EGP': 'ุฌ.ู',
        'JOD': 'ุฏ.ุฃ',
        'LBP': 'ู.ู',
        'GBP': 'ยฃ'
    };
    return currencies[currencyCode] || 'ู.ุณ';
}

/**
 * ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ ูู ุงููุงุชูุฑุฉ
 */
function updateCurrencyDisplay() {
    const currencySelect = document.getElementById('invoiceCurrency');
    const conversionSection = document.getElementById('currencyConversionSection');
    const currentCurrencyDisplay = document.getElementById('currentCurrencyDisplay');
    const exchangeRateOptional = document.getElementById('exchangeRateOptional');
    const currencySymbolDisplay = document.getElementById('currencySymbolDisplay');
    const defaultRateHint = document.getElementById('defaultRateHint');

    if (!currencySelect) return;

    const selectedCurrency = currencySelect.value;
    const currencySymbol = getCurrencySymbol(selectedCurrency);
    const currencyName = getCurrencyName(selectedCurrency);

    console.log(`๐ฑ ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ: ${currencyName} (${currencySymbol})`);

    // ุชุญุฏูุซ ุฑูุฒ ุงูุนููุฉ ูู ุงูุชุณููุฉ
    if (currencySymbolDisplay) {
        currencySymbolDisplay.textContent = currencySymbol;
        currencySymbolDisplay.className = `badge bg-info ms-1`;
    }

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ ุงูุญุงููุฉ
    if (currentCurrencyDisplay) {
        currentCurrencyDisplay.value = `${currencyName} (${currencySymbol})`;
    }

    // ุชุญุฏูุซ ุชูููุญ ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
    if (defaultRateHint && selectedCurrency !== 'SYP') {
        const defaultRate = getExchangeRate('SYP', selectedCurrency);
        defaultRateHint.textContent = `(ุงูุงูุชุฑุงุถู: ${defaultRate})`;
    } else if (defaultRateHint) {
        defaultRateHint.textContent = '';
    }

    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุณุนุฑ ุงูุตุฑู ุงูุงุฎุชูุงุฑู
    if (exchangeRateOptional) {
        if (selectedCurrency !== 'SYP') {
            exchangeRateOptional.style.display = 'block';
            // ุนุฑุถ ุงูุณุนุฑ ุงูุงูุชุฑุงุถู ูู placeholder
            const defaultRate = getExchangeRate('SYP', selectedCurrency);
            exchangeRateOptional.placeholder = `ุงุฎุชูุงุฑู - ุงูุณุนุฑ ุงูุงูุชุฑุงุถู: ${defaultRate}`;
            exchangeRateOptional.title = 'ุณุนุฑ ุงูุตุฑู ุงุฎุชูุงุฑู - ุฅุฐุง ุชูุฑู ูุงุฑุบุงู ุณูุชู ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู';
            // ุฅุฒุงูุฉ ุงููููุฉ ุงููุทููุจุฉ
            exchangeRateOptional.removeAttribute('required');
        } else {
            exchangeRateOptional.style.display = 'none';
            exchangeRateOptional.value = '';
        }
    }

    // ุฅุธูุงุฑ ูุณู ุชุญููู ุงูุนููุฉ ุฅุฐุง ูู ุชูู ุงูููุฑุฉ ุงูุณูุฑูุฉ
    if (conversionSection) {
        if (selectedCurrency !== 'SYP') {
            conversionSection.style.display = 'block';
        } else {
            conversionSection.style.display = 'none';
        }
    }

    // ุชุญุฏูุซ ุฌููุน ุนุฑูุถ ุงูุนููุฉ ูู ุงููุงุชูุฑุฉ
    updateInvoiceCurrencyDisplay(selectedCurrency, currencySymbol);

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    calculateInvoiceTotals();
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุตุฑู ุงููุฎุตุต
 */
function updateCustomExchangeRate() {
    const exchangeRateOptional = document.getElementById('exchangeRateOptional');
    const selectedCurrency = document.getElementById('invoiceCurrency')?.value;

    if (!exchangeRateOptional || !selectedCurrency) return;

    const customRate = parseFloat(exchangeRateOptional.value);

    if (customRate && customRate > 0) {
        // ุญูุธ ุงูุณุนุฑ ุงููุฎุตุต ูุคูุชุงู
        if (!window.customExchangeRates) {
            window.customExchangeRates = {};
        }
        window.customExchangeRates[selectedCurrency] = customRate;

        console.log(`๐ฑ ุชู ุชุนููู ุณุนุฑ ุตุฑู ูุฎุตุต ูู ${selectedCurrency}: ${customRate}`);

        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช ูุน ุงูุณุนุฑ ุงูุฌุฏูุฏ
        calculateInvoiceTotals();

        // ุชุญุฏูุซ ูุณู ุงูุชุญููู ุฅุฐุง ูุงู ููุชูุญุงู
        calculateCurrencyConversion();
    } else {
        // ุฅุฒุงูุฉ ุงูุณุนุฑ ุงููุฎุตุต
        if (window.customExchangeRates && window.customExchangeRates[selectedCurrency]) {
            delete window.customExchangeRates[selectedCurrency];
            console.log(`๐ฑ ุชู ุฅุฒุงูุฉ ุงูุณุนุฑ ุงููุฎุตุต ูู ${selectedCurrency}`);
        }
    }
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุงูุนููุฉ
 */
function getCurrencyName(currencyCode) {
    const currencyNames = {
        'SYP': 'ููุฑุฉ ุณูุฑูุฉ',
        'USD': 'ุฏููุงุฑ ุฃูุฑููู',
        'EUR': 'ููุฑู',
        'TRY': 'ููุฑุฉ ุชุฑููุฉ',
        'SAR': 'ุฑูุงู ุณุนูุฏู',
        'AED': 'ุฏุฑูู ุฅูุงุฑุงุชู',
        'EGP': 'ุฌููู ูุตุฑู',
        'JOD': 'ุฏููุงุฑ ุฃุฑุฏูู',
        'LBP': 'ููุฑุฉ ูุจูุงููุฉ',
        'GBP': 'ุฌููู ุฅุณุชุฑูููู'
    };
    return currencyNames[currencyCode] || 'ููุฑุฉ ุณูุฑูุฉ';
}

/**
 * ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ ูู ุฌููุน ุฃูุญุงุก ุงููุงุชูุฑุฉ
 */
function updateInvoiceCurrencyDisplay(currencyCode, currencySymbol) {
    // ุชุญุฏูุซ ุนุฑูุถ ุงููุจุงูุบ
    const amountElements = [
        'subtotalAmount',
        'discountAmount',
        'taxAmount',
        'totalAmount'
    ];

    amountElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            const currentText = element.textContent;
            const numericValue = parseFloat(currentText.replace(/[^\d.-]/g, '')) || 0;
            element.textContent = `${formatCurrency(numericValue)} ${currencySymbol}`;
        }
    });

    // ุชุญุฏูุซ ุนุฑูุถ ุงููุจุงูุบ ูู ุฌุฏูู ุงูุนูุงุตุฑ
    const itemTotalElements = document.querySelectorAll('[id^="itemTotal_"]');
    itemTotalElements.forEach(element => {
        const currentText = element.textContent;
        const numericValue = parseFloat(currentText.replace(/[^\d.-]/g, '')) || 0;
        element.textContent = `${formatCurrency(numericValue)} ${currencySymbol}`;
    });
}

/**
 * ุญุณุงุจ ุชุญููู ุงูุนููุฉ
 */
function calculateCurrencyConversion() {
    const currentCurrency = document.getElementById('invoiceCurrency')?.value;
    const targetCurrency = document.getElementById('targetCurrency')?.value;
    const exchangeRateInput = document.getElementById('exchangeRate');
    const convertedAmountInput = document.getElementById('convertedAmount');
    const totalAmountElement = document.getElementById('totalAmount');

    if (!currentCurrency || !targetCurrency || !exchangeRateInput || !convertedAmountInput) {
        return;
    }

    // ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงููุฏุฎู ุฃู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
    let exchangeRate = parseFloat(exchangeRateInput.value);
    if (!exchangeRate || exchangeRate <= 0) {
        // ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
        exchangeRate = getExchangeRate(currentCurrency, targetCurrency);
        exchangeRateInput.placeholder = `ุงูุณุนุฑ ุงูุงูุชุฑุงุถู: ${exchangeRate}`;
    }

    // ุญุณุงุจ ุงููุจูุบ ุงููุญูู
    const currentTotal = parseFloat(totalAmountElement?.textContent?.replace(/[^\d.-]/g, '')) || 0;
    const convertedTotal = currentTotal * exchangeRate;

    const targetCurrencySymbol = getCurrencySymbol(targetCurrency);
    convertedAmountInput.value = `${formatCurrency(convertedTotal)} ${targetCurrencySymbol}`;

    console.log('๐ฑ ุชู ุญุณุงุจ ุชุญููู ุงูุนููุฉ:', {
        from: currentCurrency,
        to: targetCurrency,
        rate: exchangeRate,
        isDefault: !parseFloat(exchangeRateInput.value),
        originalAmount: currentTotal,
        convertedAmount: convertedTotal
    });
}

/**
 * ุงูุญุตูู ุนูู ุณุนุฑ ุงูุตุฑู ุจูู ุนููุชูู
 */
function getExchangeRate(fromCurrency, toCurrency) {
    if (fromCurrency === toCurrency) {
        return 1.0;
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุณุนุฑ ุตุฑู ูุฎุตุต ูููุงุชูุฑุฉ ุงูุญุงููุฉ
    if (window.customExchangeRates && window.customExchangeRates[toCurrency]) {
        console.log(`๐ฑ ุงุณุชุฎุฏุงู ุณุนุฑ ุตุฑู ูุฎุตุต ูู ${toCurrency}: ${window.customExchangeRates[toCurrency]}`);
        return window.customExchangeRates[toCurrency];
    }

    // ุฃุณุนุงุฑ ุงูุตุฑู ุงูุงูุชุฑุงุถูุฉ (ูููู ุชุญุฏูุซูุง ูู ุงูุฅุนุฏุงุฏุงุช)
    const defaultRates = {
        'SYP_USD': 0.0004,
        'SYP_EUR': 0.00037,
        'SYP_TRY': 0.011,
        'SYP_SAR': 0.0015,
        'SYP_AED': 0.0015,
        'SYP_EGP': 0.012,
        'SYP_JOD': 0.00028,
        'SYP_LBP': 0.6,
        'SYP_GBP': 0.00032,
        'USD_SYP': 2500,
        'EUR_SYP': 2700,
        'TRY_SYP': 91,
        'SAR_SYP': 667,
        'AED_SYP': 680,
        'EGP_SYP': 83,
        'JOD_SYP': 3521,
        'LBP_SYP': 1.67,
        'GBP_SYP': 3125
    };

    // ุงูุจุญุซ ูู ุฅุนุฏุงุฏุงุช ุฃุณุนุงุฑ ุงูุตุฑู ุงููุญููุธุฉ
    if (appData.settings && appData.settings.exchangeRates) {
        const rateKey = `${fromCurrency}_${toCurrency}`;
        if (appData.settings.exchangeRates[rateKey]) {
            return appData.settings.exchangeRates[rateKey];
        }
    }

    // ุงุณุชุฎุฏุงู ุงูุฃุณุนุงุฑ ุงูุงูุชุฑุงุถูุฉ
    const rateKey = `${fromCurrency}_${toCurrency}`;
    return defaultRates[rateKey] || 1.0;
}

/**
 * ุชุทุจูู ุชุญููู ุงูุนููุฉ ุนูู ุงููุงุชูุฑุฉ
 */
function applyCurrencyConversion() {
    const currentCurrency = document.getElementById('invoiceCurrency')?.value;
    const targetCurrency = document.getElementById('targetCurrency')?.value;
    const exchangeRateInput = document.getElementById('exchangeRate');

    // ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงููุฏุฎู ุฃู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
    let exchangeRate = parseFloat(exchangeRateInput?.value);
    if (!exchangeRate || exchangeRate <= 0) {
        exchangeRate = getExchangeRate(currentCurrency, targetCurrency);
    }

    if (!currentCurrency || !targetCurrency) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ ุงููุณุชูุฏูุฉ');
        return;
    }

    if (currentCurrency === targetCurrency) {
        alert('ุงูุนููุฉ ุงูุญุงููุฉ ูุงููุณุชูุฏูุฉ ูุชุทุงุจูุชุงู');
        return;
    }

    // ุชุฃููุฏ ุงูุชุญููู
    const targetCurrencyName = getCurrencyName(targetCurrency);
    const currentCurrencyName = getCurrencyName(currentCurrency);

    if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุญููู ุงููุงุชูุฑุฉ ูู ${currentCurrencyName} ุฅูู ${targetCurrencyName}ุ\n\nุณุนุฑ ุงูุตุฑู: ${exchangeRate}\n\nุณูุชู ุชุญููู ุฌููุน ุงููุจุงูุบ ูู ุงููุงุชูุฑุฉ.`)) {
        return;
    }

    // ุชุญููู ุฃุณุนุงุฑ ุงูุนูุงุตุฑ
    const itemRows = document.querySelectorAll('#invoiceItemsTable tr');
    itemRows.forEach(row => {
        const priceInput = row.querySelector('input[id^="itemPrice_"]');
        if (priceInput) {
            const currentPrice = parseFloat(priceInput.value) || 0;
            const convertedPrice = currentPrice * exchangeRate;
            priceInput.value = convertedPrice.toFixed(4);

            // ุฅุนุงุฏุฉ ุญุณุงุจ ุฅุฌูุงูู ุงูุนูุตุฑ
            const itemId = priceInput.id.split('_')[1];
            calculateItemTotal(itemId);
        }
    });

    // ุชุญุฏูุซ ุนููุฉ ุงููุงุชูุฑุฉ
    document.getElementById('invoiceCurrency').value = targetCurrency;

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    calculateInvoiceTotals();

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ
    updateCurrencyDisplay();

    // ุฅุฎูุงุก ูุณู ุงูุชุญููู
    document.getElementById('currencyConversionSection').style.display = 'none';

    // ุฑุณุงูุฉ ูุฌุงุญ
    const targetCurrencySymbol = getCurrencySymbol(targetCurrency);
    alert(`โ ุชู ุชุญููู ุงููุงุชูุฑุฉ ุจูุฌุงุญ ุฅูู ${targetCurrencyName} (${targetCurrencySymbol})`);

    console.log(`โ ุชู ุชุญููู ุงููุงุชูุฑุฉ ูู ${currentCurrency} ุฅูู ${targetCurrency} ุจุณุนุฑ ุตุฑู ${exchangeRate}`);
}

/**
 * ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ
 */
function saveCompanySettings(event) {
    event.preventDefault();

    console.log('๐พ ุจุฏุก ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ...');

    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        console.log('๐ ูุญุต ุงูุนูุงุตุฑ ุงููุทููุจุฉ...');

        const requiredElements = [
            'companyName', 'companyAddress', 'companyPhone', 'companyEmail',
            'taxNumber', 'currency', 'taxRate'
        ];

        const missingElements = [];
        requiredElements.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (!element) {
                missingElements.push(elementId);
            }
        });

        if (missingElements.length > 0) {
            console.error('โ ุนูุงุตุฑ ููููุฏุฉ:', missingElements);
            alert(`ุฎุทุฃ: ุงูุนูุงุตุฑ ุงูุชุงููุฉ ููููุฏุฉ ูู ุงููููุฐุฌ:\n${missingElements.join(', ')}`);
            return;
        }

        // ุงูุชุญูู ูู ุชููุฆุฉ appData.settings
        if (!appData.settings) {
            console.log('๐ง ุฅูุดุงุก ูุงุฆู ุงูุฅุนุฏุงุฏุงุช...');
            appData.settings = {};
        }

        // ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุน ุงูุชุญูู
        console.log('๐ ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ...');

        const companyName = document.getElementById('companyName').value.trim();
        const companyAddress = document.getElementById('companyAddress').value.trim();
        const companyPhone = document.getElementById('companyPhone').value.trim();
        const companyEmail = document.getElementById('companyEmail').value.trim();
        const taxNumber = document.getElementById('taxNumber').value.trim();
        const currency = document.getElementById('currency').value;
        const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (!companyName) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุดุฑูุฉ');
            return;
        }

        if (!currency) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ');
            return;
        }

        // ุญูุธ ุงูุจูุงูุงุช
        appData.settings.companyName = companyName;
        appData.settings.companyAddress = companyAddress;
        appData.settings.companyPhone = companyPhone;
        appData.settings.companyEmail = companyEmail;
        appData.settings.taxNumber = taxNumber;
        appData.settings.currency = currency;
        appData.settings.currencySymbol = getCurrencySymbol(currency);
        appData.settings.taxRate = taxRate;

        console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:', {
            companyName, currency, taxRate
        });

        // ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
        console.log('๐ฑ ูุญุต ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุงููุชุนุฏุฏุฉ...');

        const enableMultiCurrencyElement = document.getElementById('enableMultiCurrency');
        if (enableMultiCurrencyElement) {
            const wasEnabled = appData.settings.enableMultiCurrency;
            appData.settings.enableMultiCurrency = enableMultiCurrencyElement.checked;

            console.log(`๐ฑ ุงูุนููุงุช ุงููุชุนุฏุฏุฉ: ${wasEnabled ? 'ูุงูุช ููุนูุฉ' : 'ูุงูุช ูุนุทูุฉ'} โ ${appData.settings.enableMultiCurrency ? 'ููุนูุฉ ุงูุขู' : 'ูุนุทูุฉ ุงูุขู'}`);

            // ุฅุฐุง ุชู ุชูุนูู ุงูุนููุงุช ุงููุชุนุฏุฏุฉุ ุญูุธ ุฃุณุนุงุฑ ุงูุตุฑู
            if (appData.settings.enableMultiCurrency) {
                console.log('๐ฐ ุญูุธ ุฃุณุนุงุฑ ุงูุตุฑู...');

                if (!appData.settings.exchangeRates) {
                    appData.settings.exchangeRates = {};
                }

                const currencies = ['USD', 'EUR', 'SAR', 'AED', 'EGP', 'JOD', 'LBP', 'TRY', 'GBP'];
                const baseCurrency = currency;
                let savedRates = 0;

                currencies.forEach(currencyCode => {
                    if (currencyCode !== baseCurrency) {
                        const rateInput = document.getElementById(`rate_${currencyCode}`);
                        if (rateInput) {
                            const rate = parseFloat(rateInput.value) || 1;
                            appData.settings.exchangeRates[currencyCode] = rate;
                            appData.settings.exchangeRates[`${currencyCode}_updated`] = new Date().toISOString();
                            savedRates++;
                            console.log(`๐ฑ ุณุนุฑ ุตุฑู ${currencyCode}: ${rate}`);
                        } else {
                            console.warn(`โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญูู ุณุนุฑ ุงูุตุฑู ูู ${currencyCode}`);
                        }
                    }
                });

                console.log(`โ ุชู ุญูุธ ${savedRates} ุณุนุฑ ุตุฑู`);
            } else {
                console.log('โน๏ธ ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ูุนุทูุฉุ ูู ูุชู ุญูุธ ุฃุณุนุงุฑ ุงูุตุฑู');
            }
        } else {
            console.warn('โ๏ธ ุนูุตุฑ ุชูุนูู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ุบูุฑ ููุฌูุฏ');
        }

        // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
        console.log('๐พ ุญูุธ ุงูุจูุงูุงุช ูู localStorage...');

        try {
            saveData();
            console.log('โ ุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage ุจูุฌุงุญ');

            // ุงูุชุญูู ูู ุงูุญูุธ
            const savedData = localStorage.getItem('samProData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (parsedData.settings && parsedData.settings.companyName === companyName) {
                    console.log('โ ุชู ุงูุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ');
                } else {
                    console.error('โ ูุดู ูู ุงูุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช');
                }
            }
        } catch (saveError) {
            console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', saveError);
            alert('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช: ' + saveError.message);
            return;
        }

        // ุฑุณุงูุฉ ุงููุฌุงุญ
        const successMessage = `โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ ุจูุฌุงุญ!

๐ ุงูุฅุนุฏุงุฏุงุช ุงููุญููุธุฉ:
โข ุงุณู ุงูุดุฑูุฉ: ${companyName}
โข ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ: ${getCurrencyName(currency)} (${getCurrencySymbol(currency)})
โข ูุนุฏู ุงูุถุฑูุจุฉ: ${taxRate}%
โข ุงูุนููุงุช ุงููุชุนุฏุฏุฉ: ${appData.settings.enableMultiCurrency ? 'ููุนูุฉ' : 'ูุนุทูุฉ'}

ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช.`;

        alert(successMessage);
        console.log('๐ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ ุจูุฌุงุญ');

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช
        setTimeout(() => {
            console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช...');
            showPage('settings');
        }, 1000);

    } catch (error) {
        console.error('โ ุฎุทุฃ ุนุงู ูู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ:', error);
        console.error('โ ุชูุงุตูู ุงูุฎุทุฃ:', error.stack);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ: ' + error.message);
    }
}

/**
 * ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู
 */
function saveSystemSettings(event) {
    event.preventDefault();

    appData.settings.password = document.getElementById('systemPassword').value;
    appData.settings.autoBackup = document.getElementById('autoBackup').value;

    saveData();
    alert('ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ุจูุฌุงุญ');
}

/**
 * ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
 */
function savePrintSettings(event) {
    event.preventDefault();
    console.log('๐พ ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ...');

    // ุชููุฆุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ ุฅุฐุง ูู ุชูุฌุฏ
    if (!appData.settings.printSettings) {
        appData.settings.printSettings = {};
    }

    // ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุนุฑุถ
    appData.settings.printSettings.showAppName = document.getElementById('showAppName').checked;
    appData.settings.printSettings.showCompanyLogo = document.getElementById('showCompanyLogo').checked;
    appData.settings.printSettings.showPrintDate = document.getElementById('showPrintDate').checked;
    appData.settings.printSettings.showPageNumbers = document.getElementById('showPageNumbers').checked;

    // ุญูุธ ุงููุตูุต ุงููุฎุตุตุฉ
    appData.settings.printSettings.headerText = document.getElementById('printHeaderText').value.trim();
    appData.settings.printSettings.footerText = document.getElementById('printFooterText').value.trim();

    // ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
    appData.settings.printSettings.orientation = document.getElementById('printOrientation').value;
    appData.settings.printSettings.pageSize = document.getElementById('printPageSize').value;

    saveData();
    console.log('โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ:', appData.settings.printSettings);
    alert('ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ ุจูุฌุงุญ');
}

/**
 * ูุนุงููุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
 */
function previewPrintSettings() {
    console.log('๐๏ธ ูุนุงููุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ...');

    // ุฌูุน ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
    const settings = {
        showAppName: document.getElementById('showAppName').checked,
        showCompanyLogo: document.getElementById('showCompanyLogo').checked,
        showPrintDate: document.getElementById('showPrintDate').checked,
        showPageNumbers: document.getElementById('showPageNumbers').checked,
        headerText: document.getElementById('printHeaderText').value.trim(),
        footerText: document.getElementById('printFooterText').value.trim(),
        orientation: document.getElementById('printOrientation').value,
        pageSize: document.getElementById('printPageSize').value
    };

    // ุฅูุดุงุก ูุงูุฐุฉ ูุนุงููุฉ
    const previewWindow = window.open('', '_blank', 'width=800,height=600');
    previewWindow.document.write(generatePrintPreview(settings));
    previewWindow.document.close();
}

/**
 * ุฅูุดุงุก ูุนุงููุฉ ุงูุทุจุงุนุฉ
 */
function generatePrintPreview(settings) {
    const currentDate = formatDate(new Date());
    const companyName = appData.settings.companyName || 'ุงุณู ุงูุดุฑูุฉ';
    const logoUrl = appData.settings.logoUrl || '';

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ูุนุงููุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ</title>
            <style>
                @page {
                    size: ${settings.pageSize} ${settings.orientation};
                    margin: 2cm;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: rtl;
                    text-align: right;
                    margin: 0;
                    padding: 20px;
                    background: #f8f9fa;
                }

                .preview-container {
                    background: white;
                    padding: 30px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    max-width: 800px;
                    margin: 0 auto;
                }

                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }

                .company-logo {
                    max-height: 80px;
                    margin-bottom: 10px;
                }

                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    color: #333;
                    margin: 10px 0;
                }

                .header-text {
                    font-size: 18px;
                    color: #666;
                    margin: 10px 0;
                }

                .print-date {
                    font-size: 14px;
                    color: #888;
                    margin-top: 10px;
                }

                .content-area {
                    min-height: 400px;
                    padding: 20px 0;
                    border: 2px dashed #ddd;
                    text-align: center;
                    color: #666;
                    font-size: 18px;
                }

                .print-footer {
                    text-align: center;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                    margin-top: 30px;
                    font-size: 14px;
                    color: #666;
                }

                .app-name {
                    font-weight: bold;
                    color: #007bff;
                }

                .page-number {
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    font-size: 12px;
                    color: #888;
                }

                .settings-info {
                    background: #e3f2fd;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    font-size: 14px;
                }

                .settings-info h4 {
                    margin: 0 0 10px 0;
                    color: #1976d2;
                }

                .setting-item {
                    margin: 5px 0;
                }

                .enabled {
                    color: #4caf50;
                    font-weight: bold;
                }

                .disabled {
                    color: #f44336;
                }

                @media print {
                    body {
                        background: white;
                    }
                    .preview-container {
                        box-shadow: none;
                        border: none;
                    }
                    .settings-info {
                        display: none;
                    }
                }
            </style>
        </head>
        <body>
            <div class="preview-container">
                <!-- ูุนูููุงุช ุงูุฅุนุฏุงุฏุงุช -->
                <div class="settings-info">
                    <h4>ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ ุงูุญุงููุฉ:</h4>
                    <div class="setting-item">ุงุณู ุงูุชุทุจูู: <span class="${settings.showAppName ? 'enabled' : 'disabled'}">${settings.showAppName ? 'ููุนู' : 'ูุนุทู'}</span></div>
                    <div class="setting-item">ุดุนุงุฑ ุงูุดุฑูุฉ: <span class="${settings.showCompanyLogo ? 'enabled' : 'disabled'}">${settings.showCompanyLogo ? 'ููุนู' : 'ูุนุทู'}</span></div>
                    <div class="setting-item">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <span class="${settings.showPrintDate ? 'enabled' : 'disabled'}">${settings.showPrintDate ? 'ููุนู' : 'ูุนุทู'}</span></div>
                    <div class="setting-item">ุฃุฑูุงู ุงูุตูุญุงุช: <span class="${settings.showPageNumbers ? 'enabled' : 'disabled'}">${settings.showPageNumbers ? 'ููุนู' : 'ูุนุทู'}</span></div>
                    <div class="setting-item">ุงุชุฌุงู ุงูุทุจุงุนุฉ: <strong>${settings.orientation === 'portrait' ? 'ุนููุฏู' : 'ุฃููู'}</strong></div>
                    <div class="setting-item">ุญุฌู ุงููุฑู: <strong>${settings.pageSize}</strong></div>
                </div>

                <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
                <div class="print-header">
                    ${settings.showCompanyLogo && logoUrl ? `<img src="${logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" class="company-logo">` : ''}
                    <div class="company-name">${companyName}</div>
                    ${settings.headerText ? `<div class="header-text">${settings.headerText}</div>` : ''}
                    ${settings.showPrintDate ? `<div class="print-date">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${currentDate}</div>` : ''}
                </div>

                <!-- ููุทูุฉ ุงููุญุชูู -->
                <div class="content-area">
                    <p>ูุฐู ูุนุงููุฉ ูุดูู ุงููููุงุช ุงููุทุจูุนุฉ</p>
                    <p>ุณูุธูุฑ ูุญุชูู ุงูุชูุงุฑูุฑ ูุงูููุงุชูุฑ ููุง</p>
                </div>

                <!-- ุชุฐููู ุงูุตูุญุฉ -->
                <div class="print-footer">
                    ${settings.footerText ? `<div>${settings.footerText}</div>` : ''}
                    ${settings.showAppName ? `<div class="app-name">ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ SAM PRO</div>` : ''}
                </div>

                <!-- ุฑูู ุงูุตูุญุฉ -->
                ${settings.showPageNumbers ? `<div class="page-number">ุตูุญุฉ 1</div>` : ''}
            </div>

            <script>
                // ุฅุถุงูุฉ ุฒุฑ ุทุจุงุนุฉ
                document.addEventListener('DOMContentLoaded', function() {
                    const printBtn = document.createElement('button');
                    printBtn.innerHTML = '๐จ๏ธ ุทุจุงุนุฉ ุงููุนุงููุฉ';
                    printBtn.style.cssText = 'position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1000;';
                    printBtn.onclick = () => window.print();
                    document.body.appendChild(printBtn);
                });
            </script>
        </body>
        </html>
    `;
}

/**
 * ุทุจุงุนุฉ ูุชูุฏูุฉ ูุน ุชุญุฏูุฏ ุงููุญุชูู
 */
function advancedPrint(contentType, data = null) {
    console.log('๐จ๏ธ ุจุฏุก ุงูุทุจุงุนุฉ ุงููุชูุฏูุฉ...', { contentType, data });

    // ุฅูุดุงุก ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงููุญุชูู
    showPrintSelectionDialog(contentType, data);
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุงุฎุชูุงุฑ ูุญุชูู ุงูุทุจุงุนุฉ
 */
function showPrintSelectionDialog(contentType, data) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'printSelectionModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-print me-2"></i>
                        ุฎูุงุฑุงุช ุงูุทุจุงุนุฉ ุงููุชูุฏูุฉ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-list-check me-2"></i>
                                ุงุฎุชุฑ ุงููุญุชูู ุงููุฑุงุฏ ุทุจุงุนุชู:
                            </h6>
                            <div id="printContentOptions">
                                ${generatePrintContentOptions(contentType, data)}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-cogs me-2"></i>
                                ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ:
                            </h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="printShowAppName" ${appData.settings.printSettings?.showAppName !== false ? 'checked' : ''}>
                                    <label class="form-check-label" for="printShowAppName">
                                        ุฅุธูุงุฑ ุงุณู ุงูุชุทุจูู
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="printShowDate" ${appData.settings.printSettings?.showPrintDate !== false ? 'checked' : ''}>
                                    <label class="form-check-label" for="printShowDate">
                                        ุฅุธูุงุฑ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="printShowPageNumbers" ${appData.settings.printSettings?.showPageNumbers !== false ? 'checked' : ''}>
                                    <label class="form-check-label" for="printShowPageNumbers">
                                        ุฅุธูุงุฑ ุฃุฑูุงู ุงูุตูุญุงุช
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="printOrientation" class="form-label">ุงุชุฌุงู ุงูุทุจุงุนุฉ:</label>
                                <select class="form-select" id="printOrientation">
                                    <option value="portrait">ุนููุฏู</option>
                                    <option value="landscape">ุฃููู</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        ุฅูุบุงุก
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="previewSelectedContent()">
                        <i class="fas fa-eye me-2"></i>
                        ูุนุงููุฉ
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printSelectedContent()">
                        <i class="fas fa-print me-2"></i>
                        ุทุจุงุนุฉ
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงูููุฏุงู ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

/**
 * ุฅูุดุงุก ุฎูุงุฑุงุช ูุญุชูู ุงูุทุจุงุนุฉ
 */
function generatePrintContentOptions(contentType, data) {
    let options = '';

    switch (contentType) {
        case 'invoice':
            options = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printInvoiceHeader" checked>
                    <label class="form-check-label" for="printInvoiceHeader">
                        ุฑุฃุณ ุงููุงุชูุฑุฉ (ูุนูููุงุช ุงูุดุฑูุฉ ูุงูุนููู)
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printInvoiceItems" checked>
                    <label class="form-check-label" for="printInvoiceItems">
                        ุนูุงุตุฑ ุงููุงุชูุฑุฉ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printInvoiceTotals" checked>
                    <label class="form-check-label" for="printInvoiceTotals">
                        ุงูุฅุฌูุงููุงุช ูุงูุถุฑุงุฆุจ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printInvoiceNotes">
                    <label class="form-check-label" for="printInvoiceNotes">
                        ุงูููุงุญุธุงุช
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printInvoiceSignature">
                    <label class="form-check-label" for="printInvoiceSignature">
                        ููุงู ุงูุชูููุน
                    </label>
                </div>
            `;
            break;

        case 'report':
            options = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printReportTitle" checked>
                    <label class="form-check-label" for="printReportTitle">
                        ุนููุงู ุงูุชูุฑูุฑ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printReportSummary" checked>
                    <label class="form-check-label" for="printReportSummary">
                        ููุฎุต ุงูุชูุฑูุฑ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printReportDetails" checked>
                    <label class="form-check-label" for="printReportDetails">
                        ุชูุงุตูู ุงูุชูุฑูุฑ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printReportCharts">
                    <label class="form-check-label" for="printReportCharts">
                        ุงูุฑุณูู ุงูุจูุงููุฉ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printReportFooter">
                    <label class="form-check-label" for="printReportFooter">
                        ุชุฐููู ุงูุชูุฑูุฑ
                    </label>
                </div>
            `;
            break;

        case 'list':
            options = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printListHeader" checked>
                    <label class="form-check-label" for="printListHeader">
                        ุฑุฃุณ ุงููุงุฆูุฉ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printListItems" checked>
                    <label class="form-check-label" for="printListItems">
                        ุนูุงุตุฑ ุงููุงุฆูุฉ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printListSummary">
                    <label class="form-check-label" for="printListSummary">
                        ููุฎุต ุงููุงุฆูุฉ
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printListNumbers" checked>
                    <label class="form-check-label" for="printListNumbers">
                        ุฃุฑูุงู ุงูุนูุงุตุฑ
                    </label>
                </div>
            `;
            break;

        default:
            options = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printFullContent" checked>
                    <label class="form-check-label" for="printFullContent">
                        ุงููุญุชูู ูุงููุงู
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="printSelectedOnly">
                    <label class="form-check-label" for="printSelectedOnly">
                        ุงููุญุชูู ุงููุญุฏุฏ ููุท
                    </label>
                </div>
            `;
    }

    return options;
}

/**
 * ูุนุงููุฉ ุงููุญุชูู ุงููุญุฏุฏ
 */
function previewSelectedContent() {
    console.log('๐๏ธ ูุนุงููุฉ ุงููุญุชูู ุงููุญุฏุฏ...');

    const selectedOptions = getSelectedPrintOptions();
    const printSettings = getCurrentPrintSettings();

    // ุฅูุดุงุก ูุงูุฐุฉ ูุนุงููุฉ
    const previewWindow = window.open('', '_blank', 'width=900,height=700');
    previewWindow.document.write(generateSelectedContentPreview(selectedOptions, printSettings));
    previewWindow.document.close();
}

/**
 * ุทุจุงุนุฉ ุงููุญุชูู ุงููุญุฏุฏ
 */
function printSelectedContent() {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุงููุญุชูู ุงููุญุฏุฏ...');

    const selectedOptions = getSelectedPrintOptions();
    const printSettings = getCurrentPrintSettings();

    // ุฅูุดุงุก ูุงูุฐุฉ ุทุจุงุนุฉ
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.write(generatePrintableContent(selectedOptions, printSettings));
    printWindow.document.close();

    // ุทุจุงุนุฉ ุชููุงุฆูุฉ
    printWindow.onload = function() {
        printWindow.print();
        setTimeout(() => {
            printWindow.close();
        }, 1000);
    };

    // ุฅุบูุงู ููุฏุงู ุงูุฎูุงุฑุงุช
    const modal = bootstrap.Modal.getInstance(document.getElementById('printSelectionModal'));
    if (modal) {
        modal.hide();
    }
}

/**
 * ุงูุญุตูู ุนูู ุฎูุงุฑุงุช ุงูุทุจุงุนุฉ ุงููุญุฏุฏุฉ
 */
function getSelectedPrintOptions() {
    const options = {};
    const checkboxes = document.querySelectorAll('#printSelectionModal input[type="checkbox"]');

    checkboxes.forEach(checkbox => {
        options[checkbox.id] = checkbox.checked;
    });

    return options;
}

/**
 * ุงูุญุตูู ุนูู ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ ุงูุญุงููุฉ
 */
function getCurrentPrintSettings() {
    return {
        showAppName: document.getElementById('printShowAppName')?.checked || false,
        showDate: document.getElementById('printShowDate')?.checked || false,
        showPageNumbers: document.getElementById('printShowPageNumbers')?.checked || false,
        orientation: document.getElementById('printOrientation')?.value || 'portrait',
        headerText: appData.settings.printSettings?.headerText || '',
        footerText: appData.settings.printSettings?.footerText || '',
        pageSize: appData.settings.printSettings?.pageSize || 'A4'
    };
}

/**
 * ุฅูุดุงุก ูุญุชูู ูุงุจู ููุทุจุงุนุฉ
 */
function generatePrintableContent(selectedOptions, printSettings) {
    const currentDate = formatDate(new Date());
    const companyName = appData.settings.companyName || 'ุงุณู ุงูุดุฑูุฉ';

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ุทุจุงุนุฉ - ${companyName}</title>
            <style>
                @page {
                    size: ${printSettings.pageSize} ${printSettings.orientation};
                    margin: 1.5cm;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: rtl;
                    text-align: right;
                    margin: 0;
                    padding: 0;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #333;
                }

                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 15px;
                    margin-bottom: 20px;
                }

                .company-name {
                    font-size: 22px;
                    font-weight: bold;
                    color: #333;
                    margin: 10px 0;
                }

                .header-text {
                    font-size: 16px;
                    color: #666;
                    margin: 5px 0;
                }

                .print-date {
                    font-size: 12px;
                    color: #888;
                    margin-top: 10px;
                }

                .content-section {
                    margin: 20px 0;
                    page-break-inside: avoid;
                }

                .section-title {
                    font-size: 18px;
                    font-weight: bold;
                    color: #007bff;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 5px;
                    margin-bottom: 15px;
                }

                .invoice-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                }

                .invoice-info div {
                    flex: 1;
                }

                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }

                .items-table th,
                .items-table td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: center;
                }

                .items-table th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                }

                .totals-section {
                    margin-top: 20px;
                    text-align: left;
                }

                .total-row {
                    display: flex;
                    justify-content: space-between;
                    margin: 5px 0;
                    padding: 5px 0;
                }

                .total-row.final {
                    border-top: 2px solid #007bff;
                    font-weight: bold;
                    font-size: 16px;
                }

                .print-footer {
                    text-align: center;
                    border-top: 1px solid #ddd;
                    padding-top: 15px;
                    margin-top: 30px;
                    font-size: 12px;
                    color: #666;
                }

                .app-name {
                    font-weight: bold;
                    color: #007bff;
                }

                .page-number {
                    position: fixed;
                    bottom: 10px;
                    left: 10px;
                    font-size: 10px;
                    color: #888;
                }

                .signature-area {
                    margin-top: 40px;
                    display: flex;
                    justify-content: space-between;
                }

                .signature-box {
                    text-align: center;
                    width: 200px;
                }

                .signature-line {
                    border-top: 1px solid #333;
                    margin-top: 50px;
                    padding-top: 5px;
                }

                @media print {
                    body {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                    }

                    .no-print {
                        display: none !important;
                    }
                }
            </style>
        </head>
        <body>
            ${generatePrintHeader(printSettings, companyName, currentDate)}
            ${generatePrintContent(selectedOptions)}
            ${generatePrintFooter(printSettings)}
            ${printSettings.showPageNumbers ? '<div class="page-number">ุตูุญุฉ 1</div>' : ''}
        </body>
        </html>
    `;
}

/**
 * ุฅูุดุงุก ุฑุฃุณ ุงูุทุจุงุนุฉ
 */
function generatePrintHeader(printSettings, companyName, currentDate) {
    let header = '';

    if (printSettings.showDate || printSettings.headerText || companyName) {
        header = `
            <div class="print-header">
                <div class="company-name">${companyName}</div>
                ${printSettings.headerText ? `<div class="header-text">${printSettings.headerText}</div>` : ''}
                ${printSettings.showDate ? `<div class="print-date">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${currentDate}</div>` : ''}
            </div>
        `;
    }

    return header;
}

/**
 * ุฅูุดุงุก ุชุฐููู ุงูุทุจุงุนุฉ
 */
function generatePrintFooter(printSettings) {
    let footer = '';

    if (printSettings.showAppName || printSettings.footerText) {
        footer = `
            <div class="print-footer">
                ${printSettings.footerText ? `<div>${printSettings.footerText}</div>` : ''}
                ${printSettings.showAppName ? `<div class="app-name">ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ SAM PRO</div>` : ''}
            </div>
        `;
    }

    return footer;
}

/**
 * ุฅูุดุงุก ูุญุชูู ุงูุทุจุงุนุฉ ุญุณุจ ุงูุฎูุงุฑุงุช ุงููุญุฏุฏุฉ
 */
function generatePrintContent(selectedOptions) {
    let content = '<div class="content-section">';

    // ูุญุชูู ุชุฌุฑูุจู - ูููู ุชุฎุตูุตู ุญุณุจ ููุน ุงููุญุชูู
    if (selectedOptions.printInvoiceHeader || selectedOptions.printListHeader || selectedOptions.printReportTitle) {
        content += `
            <div class="section-title">ูุนูููุงุช ุงููุงุชูุฑุฉ</div>
            <div class="invoice-info">
                <div>
                    <strong>ุฑูู ุงููุงุชูุฑุฉ:</strong> INV-001<br>
                    <strong>ุงูุชุงุฑูุฎ:</strong> ${formatDate(new Date())}
                </div>
                <div>
                    <strong>ุงูุนููู:</strong> ุฃุญูุฏ ูุญูุฏ<br>
                    <strong>ุงููุงุชู:</strong> 0991234567
                </div>
            </div>
        `;
    }

    if (selectedOptions.printInvoiceItems || selectedOptions.printListItems || selectedOptions.printReportDetails) {
        content += `
            <div class="section-title">ุงูุนูุงุตุฑ</div>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>ุงูุฑูู</th>
                        <th>ุงูุตูู</th>
                        <th>ุงููููุฉ</th>
                        <th>ุงูุณุนุฑ</th>
                        <th>ุงููุฌููุน</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>ูุงุจุชูุจ ุฏูู</td>
                        <td>1</td>
                        <td>1,000.00 ู.ุณ</td>
                        <td>1,000.00 ู.ุณ</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>ูุงูุณ ูุงุณููู</td>
                        <td>2</td>
                        <td>25.00 ู.ุณ</td>
                        <td>50.00 ู.ุณ</td>
                    </tr>
                </tbody>
            </table>
        `;
    }

    if (selectedOptions.printInvoiceTotals || selectedOptions.printListSummary || selectedOptions.printReportSummary) {
        content += `
            <div class="totals-section">
                <div class="total-row">
                    <span>ุงููุฌููุน ุงููุฑุนู:</span>
                    <span>1,050.00 ู.ุณ</span>
                </div>
                <div class="total-row">
                    <span>ุงูุฎุตู:</span>
                    <span>0.00 ู.ุณ</span>
                </div>
                <div class="total-row">
                    <span>ุงูุถุฑูุจุฉ:</span>
                    <span>0.00 ู.ุณ</span>
                </div>
                <div class="total-row final">
                    <span>ุงููุฌููุน ุงูุฅุฌูุงูู:</span>
                    <span>1,050.00 ู.ุณ</span>
                </div>
            </div>
        `;
    }

    if (selectedOptions.printInvoiceSignature) {
        content += `
            <div class="signature-area">
                <div class="signature-box">
                    <div class="signature-line">ุชูููุน ุงูุนููู</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">ุชูููุน ุงูููุฏูุจ</div>
                </div>
            </div>
        `;
    }

    if (selectedOptions.printInvoiceNotes) {
        content += `
            <div class="section-title">ููุงุญุธุงุช</div>
            <div style="min-height: 60px; border: 1px dashed #ddd; padding: 10px;">
                ุดูุฑุงู ูุชุนุงูููู ูุนูุง
            </div>
        `;
    }

    content += '</div>';
    return content;
}

/**
 * ุฅูุดุงุก ูุนุงููุฉ ูููุญุชูู ุงููุญุฏุฏ
 */
function generateSelectedContentPreview(selectedOptions, printSettings) {
    const currentDate = formatDate(new Date());
    const companyName = appData.settings.companyName || 'ุงุณู ุงูุดุฑูุฉ';

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ูุนุงููุฉ ุงูุทุจุงุนุฉ - ${companyName}</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: rtl;
                    text-align: right;
                    margin: 0;
                    padding: 20px;
                    background: #f8f9fa;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #333;
                }

                .preview-container {
                    background: white;
                    padding: 30px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    max-width: 800px;
                    margin: 0 auto;
                    min-height: 600px;
                }

                .preview-header {
                    background: #e3f2fd;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    text-align: center;
                }

                .preview-title {
                    font-size: 18px;
                    font-weight: bold;
                    color: #1976d2;
                    margin: 0;
                }

                .selected-options {
                    background: #f1f8e9;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    font-size: 12px;
                }

                .selected-options h6 {
                    margin: 0 0 10px 0;
                    color: #388e3c;
                }

                .option-item {
                    display: inline-block;
                    background: #4caf50;
                    color: white;
                    padding: 2px 8px;
                    border-radius: 3px;
                    margin: 2px;
                    font-size: 11px;
                }

                .print-controls {
                    position: fixed;
                    top: 20px;
                    left: 20px;
                    z-index: 1000;
                }

                .print-controls button {
                    margin: 5px;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                }

                .btn-print {
                    background: #007bff;
                    color: white;
                }

                .btn-close {
                    background: #6c757d;
                    color: white;
                }

                /* ุงุณุชูุฑุงุฏ ุฃููุงุท ุงูุทุจุงุนุฉ */
                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 15px;
                    margin-bottom: 20px;
                }

                .company-name {
                    font-size: 22px;
                    font-weight: bold;
                    color: #333;
                    margin: 10px 0;
                }

                .header-text {
                    font-size: 16px;
                    color: #666;
                    margin: 5px 0;
                }

                .print-date {
                    font-size: 12px;
                    color: #888;
                    margin-top: 10px;
                }

                .content-section {
                    margin: 20px 0;
                }

                .section-title {
                    font-size: 18px;
                    font-weight: bold;
                    color: #007bff;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 5px;
                    margin-bottom: 15px;
                }

                .invoice-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                }

                .invoice-info div {
                    flex: 1;
                }

                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }

                .items-table th,
                .items-table td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: center;
                }

                .items-table th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                }

                .totals-section {
                    margin-top: 20px;
                    text-align: left;
                }

                .total-row {
                    display: flex;
                    justify-content: space-between;
                    margin: 5px 0;
                    padding: 5px 0;
                }

                .total-row.final {
                    border-top: 2px solid #007bff;
                    font-weight: bold;
                    font-size: 16px;
                }

                .print-footer {
                    text-align: center;
                    border-top: 1px solid #ddd;
                    padding-top: 15px;
                    margin-top: 30px;
                    font-size: 12px;
                    color: #666;
                }

                .app-name {
                    font-weight: bold;
                    color: #007bff;
                }

                .signature-area {
                    margin-top: 40px;
                    display: flex;
                    justify-content: space-between;
                }

                .signature-box {
                    text-align: center;
                    width: 200px;
                }

                .signature-line {
                    border-top: 1px solid #333;
                    margin-top: 50px;
                    padding-top: 5px;
                }

                @media print {
                    body {
                        background: white;
                    }
                    .preview-container {
                        box-shadow: none;
                        border: none;
                    }
                    .preview-header,
                    .selected-options,
                    .print-controls {
                        display: none !important;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-controls">
                <button class="btn-print" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ</button>
                <button class="btn-close" onclick="window.close()">โ๏ธ ุฅุบูุงู</button>
            </div>

            <div class="preview-container">
                <div class="preview-header">
                    <h3 class="preview-title">ูุนุงููุฉ ุงูุทุจุงุนุฉ</h3>
                    <p>ูุฐู ูุนุงููุฉ ูููุญุชูู ุงูุฐู ุณูุชู ุทุจุงุนุชู</p>
                </div>

                <div class="selected-options">
                    <h6>ุงูุฎูุงุฑุงุช ุงููุญุฏุฏุฉ:</h6>
                    ${generateSelectedOptionsDisplay(selectedOptions)}
                </div>

                ${generatePrintHeader(printSettings, companyName, currentDate)}
                ${generatePrintContent(selectedOptions)}
                ${generatePrintFooter(printSettings)}
            </div>
        </body>
        </html>
    `;
}

/**
 * ุนุฑุถ ุงูุฎูุงุฑุงุช ุงููุญุฏุฏุฉ
 */
function generateSelectedOptionsDisplay(selectedOptions) {
    let display = '';

    Object.keys(selectedOptions).forEach(key => {
        if (selectedOptions[key]) {
            const optionName = getOptionDisplayName(key);
            display += `<span class="option-item">${optionName}</span>`;
        }
    });

    return display || '<span class="option-item">ูุง ุชูุฌุฏ ุฎูุงุฑุงุช ูุญุฏุฏุฉ</span>';
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุงูุฎูุงุฑ ููุนุฑุถ
 */
function getOptionDisplayName(optionKey) {
    const names = {
        'printInvoiceHeader': 'ุฑุฃุณ ุงููุงุชูุฑุฉ',
        'printInvoiceItems': 'ุนูุงุตุฑ ุงููุงุชูุฑุฉ',
        'printInvoiceTotals': 'ุงูุฅุฌูุงููุงุช',
        'printInvoiceNotes': 'ุงูููุงุญุธุงุช',
        'printInvoiceSignature': 'ุงูุชูููุน',
        'printReportTitle': 'ุนููุงู ุงูุชูุฑูุฑ',
        'printReportSummary': 'ููุฎุต ุงูุชูุฑูุฑ',
        'printReportDetails': 'ุชูุงุตูู ุงูุชูุฑูุฑ',
        'printReportCharts': 'ุงูุฑุณูู ุงูุจูุงููุฉ',
        'printReportFooter': 'ุชุฐููู ุงูุชูุฑูุฑ',
        'printListHeader': 'ุฑุฃุณ ุงููุงุฆูุฉ',
        'printListItems': 'ุนูุงุตุฑ ุงููุงุฆูุฉ',
        'printListSummary': 'ููุฎุต ุงููุงุฆูุฉ',
        'printListNumbers': 'ุฃุฑูุงู ุงูุนูุงุตุฑ',
        'printShowAppName': 'ุงุณู ุงูุชุทุจูู',
        'printShowDate': 'ุชุงุฑูุฎ ุงูุทุจุงุนุฉ',
        'printShowPageNumbers': 'ุฃุฑูุงู ุงูุตูุญุงุช'
    };

    return names[optionKey] || optionKey;
}

/**
 * ุตูุญุฉ ูุดู ุฏูุนุงุช ุงูุนููู
 */
function getCustomerPaymentsReportHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        ูุดู ุฏูุนุงุช ุงูุนููู
                    </h1>
                    <div>
                        <button class="btn btn-outline-info me-2" onclick="advancedPrint('report')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ูุชูุฏูุฉ
                        </button>
                        <button class="btn btn-success me-2" onclick="exportCustomerPaymentsReport('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportCustomerPaymentsReport('print')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุชูุฑูุฑ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุชูุฑูุฑ
                </h6>
            </div>
            <div class="card-body">
                <form id="customerPaymentsReportForm" onsubmit="generateCustomerPaymentsReport(event)">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="customerPaymentsFromDate" class="form-label">ูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="customerPaymentsFromDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="customerPaymentsToDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="customerPaymentsToDate" required>
                        </div>
                        <div class="col-md-4">
                            <label for="customerPaymentsCustomer" class="form-label">ุงูุนููู</label>
                            <select class="form-select" id="customerPaymentsCustomer">
                                <option value="">ุฌููุน ุงูุนููุงุก</option>
                                ${appData.customers.map(customer =>
                                    `<option value="${customer.id}">${customer.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    ุฅูุดุงุก ุงูุชูุฑูุฑ
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ูุชุงุฆุฌ ุงูุชูุฑูุฑ -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-table me-2"></i>
                    ูุชุงุฆุฌ ูุดู ุฏูุนุงุช ุงูุนููู
                </h6>
            </div>
            <div class="card-body">
                <div id="customerPaymentsReportResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>ุงุฎุชุฑ ุงูููุงุชุฑ ุงููุทููุจุฉ ูุงุถุบุท "ุฅูุดุงุก ุงูุชูุฑูุฑ" ูุนุฑุถ ุงููุชุงุฆุฌ</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ูุดู ุฏูุนุงุช ุงูููุฑุฏ
 */
function getSupplierPaymentsReportHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        ูุดู ุฏูุนุงุช ุงูููุฑุฏ
                    </h1>
                    <div>
                        <button class="btn btn-outline-info me-2" onclick="advancedPrint('report')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ูุชูุฏูุฉ
                        </button>
                        <button class="btn btn-success me-2" onclick="exportSupplierPaymentsReport('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportSupplierPaymentsReport('print')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุชูุฑูุฑ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุชูุฑูุฑ
                </h6>
            </div>
            <div class="card-body">
                <form id="supplierPaymentsReportForm" onsubmit="generateSupplierPaymentsReport(event)">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="supplierPaymentsFromDate" class="form-label">ูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="supplierPaymentsFromDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="supplierPaymentsToDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="supplierPaymentsToDate" required>
                        </div>
                        <div class="col-md-4">
                            <label for="supplierPaymentsSupplier" class="form-label">ุงูููุฑุฏ</label>
                            <select class="form-select" id="supplierPaymentsSupplier">
                                <option value="">ุฌููุน ุงูููุฑุฏูู</option>
                                ${appData.suppliers.map(supplier =>
                                    `<option value="${supplier.id}">${supplier.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    ุฅูุดุงุก ุงูุชูุฑูุฑ
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ูุชุงุฆุฌ ุงูุชูุฑูุฑ -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-table me-2"></i>
                    ูุชุงุฆุฌ ูุดู ุฏูุนุงุช ุงูููุฑุฏ
                </h6>
            </div>
            <div class="card-body">
                <div id="supplierPaymentsReportResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>ุงุฎุชุฑ ุงูููุงุชุฑ ุงููุทููุจุฉ ูุงุถุบุท "ุฅูุดุงุก ุงูุชูุฑูุฑ" ูุนุฑุถ ุงููุชุงุฆุฌ</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ูุดู ุญุณุงุจ ุงูููุฑุฏ
 */
function getSupplierStatementHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-file-invoice me-2"></i>
                        ูุดู ุญุณุงุจ ุงูููุฑุฏ
                    </h1>
                    <div>
                        <button class="btn btn-outline-info me-2" onclick="advancedPrint('report')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ูุชูุฏูุฉ
                        </button>
                        <button class="btn btn-success me-2" onclick="exportSupplierStatement('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportSupplierStatement('print')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุดู
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุงุฎุชูุงุฑ ุงูููุฑุฏ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-user-tie me-2"></i>
                    ุงุฎุชูุงุฑ ุงูููุฑุฏ ูุงููุชุฑุฉ
                </h6>
            </div>
            <div class="card-body">
                <form id="supplierStatementForm" onsubmit="generateSupplierStatement(event)">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="supplierStatementSupplier" class="form-label">ุงูููุฑุฏ *</label>
                            <select class="form-select" id="supplierStatementSupplier" required>
                                <option value="">ุงุฎุชุฑ ุงูููุฑุฏ</option>
                                ${appData.suppliers.map(supplier =>
                                    `<option value="${supplier.id}">${supplier.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="supplierStatementFromDate" class="form-label">ูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="supplierStatementFromDate">
                        </div>
                        <div class="col-md-3">
                            <label for="supplierStatementToDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                            <input type="date" class="form-control" id="supplierStatementToDate">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-file-alt me-2"></i>
                                    ุฅูุดุงุก ุงููุดู
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ูุชุงุฆุฌ ูุดู ุงูุญุณุงุจ -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-table me-2"></i>
                    ูุดู ุญุณุงุจ ุงูููุฑุฏ
                </h6>
            </div>
            <div class="card-body">
                <div id="supplierStatementResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>ุงุฎุชุฑ ุงูููุฑุฏ ูุงุถุบุท "ุฅูุดุงุก ุงููุดู" ูุนุฑุถ ูุดู ุงูุญุณุงุจ</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููู
 */
function generateCustomerPaymentsReport(event) {
    event.preventDefault();
    console.log('๐ ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููู...');

    const fromDate = document.getElementById('customerPaymentsFromDate').value;
    const toDate = document.getElementById('customerPaymentsToDate').value;
    const customerId = document.getElementById('customerPaymentsCustomer').value;

    // ููุชุฑุฉ ุงูุจูุงูุงุช
    let payments = appData.payments || [];

    // ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ
    if (fromDate) {
        payments = payments.filter(payment => payment.paymentDate >= fromDate);
    }
    if (toDate) {
        payments = payments.filter(payment => payment.paymentDate <= toDate);
    }

    // ููุชุฑุฉ ุญุณุจ ุงูุนููู
    if (customerId) {
        payments = payments.filter(payment => payment.customerId == customerId);
    }

    // ููุชุฑุฉ ุฏูุนุงุช ุงูุนููุงุก ููุท
    payments = payments.filter(payment => payment.customerId);

    // ุฅูุดุงุก HTML ูููุชุงุฆุฌ
    const resultsHTML = generateCustomerPaymentsReportHTML(payments, fromDate, toDate, customerId);
    document.getElementById('customerPaymentsReportResults').innerHTML = resultsHTML;

    console.log('โ ุชู ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููู');
}

/**
 * ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏ
 */
function generateSupplierPaymentsReport(event) {
    event.preventDefault();
    console.log('๐ ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏ...');

    const fromDate = document.getElementById('supplierPaymentsFromDate').value;
    const toDate = document.getElementById('supplierPaymentsToDate').value;
    const supplierId = document.getElementById('supplierPaymentsSupplier').value;

    // ููุชุฑุฉ ุงูุจูุงูุงุช
    let payments = appData.payments || [];

    // ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ
    if (fromDate) {
        payments = payments.filter(payment => payment.paymentDate >= fromDate);
    }
    if (toDate) {
        payments = payments.filter(payment => payment.paymentDate <= toDate);
    }

    // ููุชุฑุฉ ุญุณุจ ุงูููุฑุฏ
    if (supplierId) {
        payments = payments.filter(payment => payment.supplierId == supplierId);
    }

    // ููุชุฑุฉ ุฏูุนุงุช ุงูููุฑุฏูู ููุท
    payments = payments.filter(payment => payment.supplierId);

    // ุฅูุดุงุก HTML ูููุชุงุฆุฌ
    const resultsHTML = generateSupplierPaymentsReportHTML(payments, fromDate, toDate, supplierId);
    document.getElementById('supplierPaymentsReportResults').innerHTML = resultsHTML;

    console.log('โ ุชู ุฅูุดุงุก ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏ');
}

/**
 * ุฅูุดุงุก ูุดู ุญุณุงุจ ุงูููุฑุฏ
 */
function generateSupplierStatement(event) {
    event.preventDefault();
    console.log('๐ ุฅูุดุงุก ูุดู ุญุณุงุจ ุงูููุฑุฏ...');

    const supplierId = document.getElementById('supplierStatementSupplier').value;
    const fromDate = document.getElementById('supplierStatementFromDate').value;
    const toDate = document.getElementById('supplierStatementToDate').value;

    if (!supplierId) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูููุฑุฏ');
        return;
    }

    const supplier = appData.suppliers.find(s => s.id == supplierId);
    if (!supplier) {
        alert('ุงูููุฑุฏ ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุฌูุน ุงููุนุงููุงุช
    let transactions = [];

    // ุฅุถุงูุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช
    const purchaseInvoices = appData.invoices.filter(inv =>
        inv.invoiceType === 'purchase' &&
        inv.supplierId == supplierId &&
        (!fromDate || inv.invoiceDate >= fromDate) &&
        (!toDate || inv.invoiceDate <= toDate)
    );

    purchaseInvoices.forEach(invoice => {
        transactions.push({
            date: invoice.invoiceDate,
            type: 'invoice',
            description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber}`,
            debit: invoice.totalAmount,
            credit: 0,
            balance: 0,
            reference: invoice.id
        });
    });

    // ุฅุถุงูุฉ ุงููุฏููุนุงุช
    const supplierPayments = (appData.payments || []).filter(payment =>
        payment.supplierId == supplierId &&
        (!fromDate || payment.paymentDate >= fromDate) &&
        (!toDate || payment.paymentDate <= toDate)
    );

    supplierPayments.forEach(payment => {
        transactions.push({
            date: payment.paymentDate,
            type: 'payment',
            description: `ุฏูุนุฉ ุฑูู ${payment.paymentNumber || payment.id}`,
            debit: 0,
            credit: payment.amount,
            balance: 0,
            reference: payment.id
        });
    });

    // ุชุฑุชูุจ ุงููุนุงููุงุช ุญุณุจ ุงูุชุงุฑูุฎ
    transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

    // ุญุณุงุจ ุงูุฃุฑุตุฏุฉ
    let runningBalance = 0;
    transactions.forEach(transaction => {
        runningBalance += transaction.debit - transaction.credit;
        transaction.balance = runningBalance;
    });

    // ุฅูุดุงุก HTML ูููุชุงุฆุฌ
    const resultsHTML = generateSupplierStatementHTML(supplier, transactions, fromDate, toDate);
    document.getElementById('supplierStatementResults').innerHTML = resultsHTML;

    console.log('โ ุชู ุฅูุดุงุก ูุดู ุญุณุงุจ ุงูููุฑุฏ');
}

/**
 * ุฅูุดุงุก HTML ูุชูุฑูุฑ ุฏูุนุงุช ุงูุนููู
 */
function generateCustomerPaymentsReportHTML(payments, fromDate, toDate, customerId) {
    const selectedCustomer = customerId ? appData.customers.find(c => c.id == customerId) : null;
    const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);

    let html = `
        <div class="report-header mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h5>ูุดู ุฏูุนุงุช ุงูุนููู</h5>
                    <p class="text-muted mb-0">
                        ${selectedCustomer ? `ุงูุนููู: ${selectedCustomer.name}` : 'ุฌููุน ุงูุนููุงุก'}
                    </p>
                    ${fromDate || toDate ? `<p class="text-muted mb-0">ุงููุชุฑุฉ: ${fromDate || 'ุงูุจุฏุงูุฉ'} - ${toDate || 'ุงูููุงูุฉ'}</p>` : ''}
                </div>
                <div class="col-md-6 text-end">
                    <div class="alert alert-info">
                        <strong>ุฅุฌูุงูู ุงูุฏูุนุงุช: ${formatCurrency(totalAmount)}</strong><br>
                        <small>ุนุฏุฏ ุงูุฏูุนุงุช: ${payments.length}</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (payments.length === 0) {
        html += `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>ูุง ุชูุฌุฏ ุฏูุนุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>
            </div>
        `;
    } else {
        html += `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงูุฏูุนุฉ</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุนููู</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุทุฑููุฉ ุงูุฏูุน</th>
                            <th>ุงูููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        payments.forEach(payment => {
            const customer = appData.customers.find(c => c.id === payment.customerId);
            html += `
                <tr>
                    <td>${payment.paymentNumber || payment.id}</td>
                    <td>${payment.paymentDate}</td>
                    <td>${customer ? customer.name : '-'}</td>
                    <td class="text-end">${formatCurrency(payment.amount)}</td>
                    <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                    <td>${payment.notes || '-'}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3">ุงูุฅุฌูุงูู</th>
                            <th class="text-end">${formatCurrency(totalAmount)}</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
    }

    return html;
}

/**
 * ุฅูุดุงุก HTML ูุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏ
 */
function generateSupplierPaymentsReportHTML(payments, fromDate, toDate, supplierId) {
    const selectedSupplier = supplierId ? appData.suppliers.find(s => s.id == supplierId) : null;
    const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);

    let html = `
        <div class="report-header mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h5>ูุดู ุฏูุนุงุช ุงูููุฑุฏ</h5>
                    <p class="text-muted mb-0">
                        ${selectedSupplier ? `ุงูููุฑุฏ: ${selectedSupplier.name}` : 'ุฌููุน ุงูููุฑุฏูู'}
                    </p>
                    ${fromDate || toDate ? `<p class="text-muted mb-0">ุงููุชุฑุฉ: ${fromDate || 'ุงูุจุฏุงูุฉ'} - ${toDate || 'ุงูููุงูุฉ'}</p>` : ''}
                </div>
                <div class="col-md-6 text-end">
                    <div class="alert alert-warning">
                        <strong>ุฅุฌูุงูู ุงูุฏูุนุงุช: ${formatCurrency(totalAmount)}</strong><br>
                        <small>ุนุฏุฏ ุงูุฏูุนุงุช: ${payments.length}</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (payments.length === 0) {
        html += `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>ูุง ุชูุฌุฏ ุฏูุนุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>
            </div>
        `;
    } else {
        html += `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงูุฏูุนุฉ</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุฑุฏ</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุทุฑููุฉ ุงูุฏูุน</th>
                            <th>ุงูููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        payments.forEach(payment => {
            const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
            html += `
                <tr>
                    <td>${payment.paymentNumber || payment.id}</td>
                    <td>${payment.paymentDate}</td>
                    <td>${supplier ? supplier.name : '-'}</td>
                    <td class="text-end">${formatCurrency(payment.amount)}</td>
                    <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                    <td>${payment.notes || '-'}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3">ุงูุฅุฌูุงูู</th>
                            <th class="text-end">${formatCurrency(totalAmount)}</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
    }

    return html;
}

/**
 * ุฅูุดุงุก HTML ููุดู ุญุณุงุจ ุงูููุฑุฏ
 */
function generateSupplierStatementHTML(supplier, transactions, fromDate, toDate) {
    const finalBalance = transactions.length > 0 ? transactions[transactions.length - 1].balance : 0;
    const totalDebits = transactions.reduce((sum, t) => sum + t.debit, 0);
    const totalCredits = transactions.reduce((sum, t) => sum + t.credit, 0);

    let html = `
        <div class="report-header mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h5>ูุดู ุญุณุงุจ ุงูููุฑุฏ</h5>
                    <div class="supplier-info">
                        <p class="mb-1"><strong>ุงุณู ุงูููุฑุฏ:</strong> ${supplier.name}</p>
                        <p class="mb-1"><strong>ุงููุงุชู:</strong> ${supplier.phone || '-'}</p>
                        <p class="mb-1"><strong>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</strong> ${supplier.email || '-'}</p>
                        ${fromDate || toDate ? `<p class="mb-1"><strong>ุงููุชุฑุฉ:</strong> ${fromDate || 'ุงูุจุฏุงูุฉ'} - ${toDate || 'ุงูููุงูุฉ'}</p>` : ''}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-${finalBalance > 0 ? 'danger' : finalBalance < 0 ? 'success' : 'secondary'}">
                        <h6>ููุฎุต ุงูุญุณุงุจ</h6>
                        <p class="mb-1"><strong>ุฅุฌูุงูู ุงููุดุชุฑูุงุช:</strong> ${formatCurrency(totalDebits)}</p>
                        <p class="mb-1"><strong>ุฅุฌูุงูู ุงููุฏููุนุงุช:</strong> ${formatCurrency(totalCredits)}</p>
                        <hr>
                        <p class="mb-0"><strong>ุงูุฑุตูุฏ ุงูููุงุฆู:</strong>
                            ${formatCurrency(Math.abs(finalBalance))}
                            ${finalBalance > 0 ? '(ูุฏูู ููุง)' : finalBalance < 0 ? '(ุฏุงุฆู ููุง)' : '(ูุชูุงุฒู)'}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (transactions.length === 0) {
        html += `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>ูุง ุชูุฌุฏ ูุนุงููุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>
            </div>
        `;
    } else {
        html += `
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุจูุงู</th>
                            <th>ูุฏูู</th>
                            <th>ุฏุงุฆู</th>
                            <th>ุงูุฑุตูุฏ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        transactions.forEach(transaction => {
            html += `
                <tr>
                    <td>${transaction.date}</td>
                    <td>${transaction.description}</td>
                    <td class="text-end">${transaction.debit > 0 ? formatCurrency(transaction.debit) : '-'}</td>
                    <td class="text-end">${transaction.credit > 0 ? formatCurrency(transaction.credit) : '-'}</td>
                    <td class="text-end">
                        <span class="badge bg-${transaction.balance > 0 ? 'danger' : transaction.balance < 0 ? 'success' : 'secondary'}">
                            ${formatCurrency(Math.abs(transaction.balance))}
                            ${transaction.balance > 0 ? ' ูุฏูู' : transaction.balance < 0 ? ' ุฏุงุฆู' : ' ูุชูุงุฒู'}
                        </span>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="2">ุงูุฅุฌูุงูู</th>
                            <th class="text-end">${formatCurrency(totalDebits)}</th>
                            <th class="text-end">${formatCurrency(totalCredits)}</th>
                            <th class="text-end">
                                <span class="badge bg-${finalBalance > 0 ? 'danger' : finalBalance < 0 ? 'success' : 'secondary'}">
                                    ${formatCurrency(Math.abs(finalBalance))}
                                    ${finalBalance > 0 ? ' ูุฏูู' : finalBalance < 0 ? ' ุฏุงุฆู' : ' ูุชูุงุฒู'}
                                </span>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
    }

    return html;
}

/**
 * ูุธุงุฆู ุงูุทุจุงุนุฉ ููุชูุงุฑูุฑ ุงูุฌุฏูุฏุฉ
 */
function exportCustomerPaymentsReport(format) {
    if (format === 'excel') {
        exportCustomerPaymentsToExcel();
    } else if (format === 'print') {
        const reportContent = document.getElementById('customerPaymentsReportResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุงุชุฑ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
            return;
        }
        printReportContent('ูุดู ุฏูุนุงุช ุงูุนููู', reportContent);
    } else {
        const reportContent = document.getElementById('customerPaymentsReportResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุงุชุฑ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
            return;
        }
        advancedPrint('report', { title: 'ูุดู ุฏูุนุงุช ุงูุนููู', content: reportContent });
    }
}

/**
 * ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก ุฅูู Excel
 */
function exportCustomerPaymentsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const customerId = document.getElementById('customerPaymentsCustomer')?.value;
        const fromDate = document.getElementById('customerPaymentsFromDate')?.value;
        const toDate = document.getElementById('customerPaymentsToDate')?.value;
        const currency = document.getElementById('customerPaymentsCurrency')?.value || 'all';

        // ููุชุฑุฉ ุณูุฏุงุช ุงููุจุถ
        let receipts = appData.payments.filter(payment =>
            payment.paymentType === 'receipt' &&
            payment.status === 'confirmed'
        );

        if (customerId) {
            receipts = receipts.filter(receipt => receipt.customerId == customerId);
        }

        if (fromDate) {
            receipts = receipts.filter(receipt => receipt.paymentDate >= fromDate);
        }

        if (toDate) {
            receipts = receipts.filter(receipt => receipt.paymentDate <= toDate);
        }

        if (currency !== 'all') {
            receipts = receipts.filter(receipt => receipt.currency === currency);
        }

        if (receipts.length === 0) {
            alert('ูุง ุชูุฌุฏ ุณูุฏุงุช ูุจุถ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุฑูู ุงูุณูุฏ',
            'ุงูุชุงุฑูุฎ',
            'ุงูุนููู',
            'ุงููุจูุบ',
            'ุงูุนููุฉ',
            'ุทุฑููุฉ ุงูุฏูุน',
            'ุฑูู ุงููุฑุฌุน',
            'ุงูุจูู',
            'ููุงุญุธุงุช'
        ];

        const data = receipts.map(receipt => {
            const customer = appData.customers.find(c => c.id === receipt.customerId);
            return [
                receipt.paymentNumber,
                receipt.paymentDate,
                customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ',
                receipt.amount,
                getCurrencyName(receipt.currency),
                getPaymentMethodText(receipt.paymentMethod),
                receipt.referenceNumber || '',
                receipt.bankName || '',
                receipt.notes || ''
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalAmount = receipts.reduce((sum, receipt) => sum + receipt.amount, 0);
        const totalCount = receipts.length;

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            '',
            'ุงูุฅุฌูุงููุงุช',
            totalAmount,
            '',
            '',
            '',
            '',
            `ุนุฏุฏ ุงูุณูุฏุงุช: ${totalCount}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฏูุนุงุช ุงูุนููุงุก');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createPaymentsSummarySheet(receipts, 'ุงูุนููุงุก', fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุฑูุฑ_ุฏูุนุงุช_ุงูุนููุงุก_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูุนููุงุก ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

function exportSupplierPaymentsReport(format) {
    if (format === 'excel') {
        exportSupplierPaymentsToExcel();
    } else if (format === 'print') {
        const reportContent = document.getElementById('supplierPaymentsReportResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุงุชุฑ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
            return;
        }
        printReportContent('ูุดู ุฏูุนุงุช ุงูููุฑุฏ', reportContent);
    } else {
        const reportContent = document.getElementById('supplierPaymentsReportResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุงุชุฑ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
            return;
        }
        advancedPrint('report', { title: 'ูุดู ุฏูุนุงุช ุงูููุฑุฏ', content: reportContent });
    }
}

/**
 * ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู ุฅูู Excel
 */
function exportSupplierPaymentsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const supplierId = document.getElementById('supplierPaymentsSupplier')?.value;
        const fromDate = document.getElementById('supplierPaymentsFromDate')?.value;
        const toDate = document.getElementById('supplierPaymentsToDate')?.value;
        const currency = document.getElementById('supplierPaymentsCurrency')?.value || 'all';

        // ููุชุฑุฉ ุณูุฏุงุช ุงูุฏูุน
        let payments = appData.payments.filter(payment =>
            payment.paymentType === 'payment' &&
            payment.status === 'confirmed'
        );

        if (supplierId) {
            payments = payments.filter(payment => payment.supplierId == supplierId);
        }

        if (fromDate) {
            payments = payments.filter(payment => payment.paymentDate >= fromDate);
        }

        if (toDate) {
            payments = payments.filter(payment => payment.paymentDate <= toDate);
        }

        if (currency !== 'all') {
            payments = payments.filter(payment => payment.currency === currency);
        }

        if (payments.length === 0) {
            alert('ูุง ุชูุฌุฏ ุณูุฏุงุช ุฏูุน ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุฑูู ุงูุณูุฏ',
            'ุงูุชุงุฑูุฎ',
            'ุงูููุฑุฏ',
            'ุงููุจูุบ',
            'ุงูุนููุฉ',
            'ุทุฑููุฉ ุงูุฏูุน',
            'ุฑูู ุงููุฑุฌุน',
            'ุงูุจูู',
            'ููุงุญุธุงุช'
        ];

        const data = payments.map(payment => {
            const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
            return [
                payment.paymentNumber,
                payment.paymentDate,
                supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ',
                payment.amount,
                getCurrencyName(payment.currency),
                getPaymentMethodText(payment.paymentMethod),
                payment.referenceNumber || '',
                payment.bankName || '',
                payment.notes || ''
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
        const totalCount = payments.length;

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            '',
            'ุงูุฅุฌูุงููุงุช',
            totalAmount,
            '',
            '',
            '',
            '',
            `ุนุฏุฏ ุงูุณูุฏุงุช: ${totalCount}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุฏูุนุงุช ุงูููุฑุฏูู');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createPaymentsSummarySheet(payments, 'ุงูููุฑุฏูู', fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุฑูุฑ_ุฏูุนุงุช_ุงูููุฑุฏูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุฏูุนุงุช ุงูููุฑุฏูู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

function exportSupplierStatement(format) {
    if (format === 'excel') {
        exportSupplierStatementToExcel();
    } else if (format === 'print') {
        const reportContent = document.getElementById('supplierStatementResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุฑุฏ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ูุดู ุงูุญุณุงุจ ุฃููุงู');
            return;
        }
        printReportContent('ูุดู ุญุณุงุจ ุงูููุฑุฏ', reportContent);
    } else {
        const reportContent = document.getElementById('supplierStatementResults').innerHTML;
        if (!reportContent || reportContent.includes('ุงุฎุชุฑ ุงูููุฑุฏ')) {
            alert('ูุฑุฌู ุฅูุดุงุก ูุดู ุงูุญุณุงุจ ุฃููุงู');
            return;
        }
        advancedPrint('report', { title: 'ูุดู ุญุณุงุจ ุงูููุฑุฏ', content: reportContent });
    }
}

/**
 * ุทุจุงุนุฉ ูุญุชูู ุงูุชูุฑูุฑ
 */
function printReportContent(title, content) {
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    const companyName = appData.settings.companyName || 'ุงุณู ุงูุดุฑูุฉ';
    const currentDate = formatDate(new Date());
    const printSettings = appData.settings.printSettings || {};

    printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${title} - ${companyName}</title>
            <style>
                @page {
                    size: A4 portrait;
                    margin: 1.5cm;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    direction: rtl;
                    text-align: right;
                    margin: 0;
                    padding: 0;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #333;
                }

                .print-header {
                    text-align: center;
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 15px;
                    margin-bottom: 20px;
                }

                .company-name {
                    font-size: 22px;
                    font-weight: bold;
                    color: #333;
                    margin: 10px 0;
                }

                .report-title {
                    font-size: 18px;
                    color: #007bff;
                    margin: 10px 0;
                }

                .print-date {
                    font-size: 12px;
                    color: #888;
                    margin-top: 10px;
                }

                .report-content {
                    margin: 20px 0;
                }

                .table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }

                .table th,
                .table td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: center;
                }

                .table th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                }

                .table-light th {
                    background-color: #f8f9fa;
                }

                .text-end {
                    text-align: left;
                }

                .alert {
                    padding: 15px;
                    margin-bottom: 20px;
                    border: 1px solid transparent;
                    border-radius: 4px;
                }

                .alert-info {
                    color: #0c5460;
                    background-color: #d1ecf1;
                    border-color: #bee5eb;
                }

                .alert-warning {
                    color: #856404;
                    background-color: #fff3cd;
                    border-color: #ffeaa7;
                }

                .alert-danger {
                    color: #721c24;
                    background-color: #f8d7da;
                    border-color: #f5c6cb;
                }

                .alert-success {
                    color: #155724;
                    background-color: #d4edda;
                    border-color: #c3e6cb;
                }

                .alert-secondary {
                    color: #383d41;
                    background-color: #e2e3e5;
                    border-color: #d6d8db;
                }

                .badge {
                    display: inline-block;
                    padding: 0.25em 0.4em;
                    font-size: 75%;
                    font-weight: 700;
                    line-height: 1;
                    text-align: center;
                    white-space: nowrap;
                    vertical-align: baseline;
                    border-radius: 0.25rem;
                }

                .bg-danger { background-color: #dc3545; color: white; }
                .bg-success { background-color: #28a745; color: white; }
                .bg-secondary { background-color: #6c757d; color: white; }

                .print-footer {
                    text-align: center;
                    border-top: 1px solid #ddd;
                    padding-top: 15px;
                    margin-top: 30px;
                    font-size: 12px;
                    color: #666;
                }

                .app-name {
                    font-weight: bold;
                    color: #007bff;
                }

                @media print {
                    body {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <div class="company-name">${companyName}</div>
                <div class="report-title">${title}</div>
                ${printSettings.showPrintDate !== false ? `<div class="print-date">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${currentDate}</div>` : ''}
            </div>

            <div class="report-content">
                ${content}
            </div>

            <div class="print-footer">
                ${printSettings.footerText ? `<div>${printSettings.footerText}</div>` : ''}
                ${printSettings.showAppName !== false ? `<div class="app-name">ุชู ุงูุฅูุดุงุก ุจูุงุณุทุฉ SAM PRO</div>` : ''}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();

    printWindow.onload = function() {
        printWindow.print();
        setTimeout(() => {
            printWindow.close();
        }, 1000);
    };
}

/**
 * ุงูุญุตูู ุนูู ูุต ุทุฑููุฉ ุงูุฏูุน
 */
function getPaymentMethodText(method) {
    const methods = {
        'cash': 'ููุฏุงู',
        'bank': 'ุชุญููู ุจููู',
        'check': 'ุดูู',
        'card': 'ุจุทุงูุฉ ุงุฆุชูุงู',
        'other': 'ุฃุฎุฑู'
    };
    return methods[method] || method || '-';
}

/**
 * ุฑูุน ุดุนุงุฑ ุงูุดุฑูุฉ
 */
function uploadLogo(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            appData.settings.logoUrl = e.target.result;
            saveData();
            alert('ุชู ุฑูุน ุงูุดุนุงุฑ ุจูุฌุงุญ');
            showPage('settings'); // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุนุฑุถ ุงูุดุนุงุฑ
        };
        reader.readAsDataURL(file);
    }
}

/**
 * ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
 */
function createBackup() {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('backup')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅูุดุงุก ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ');
        return;
    }

    console.log('๐พ ุจุฏุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');

    try {
        const backupName = document.getElementById('backupName').value.trim() || 'backup';
        const includeSettings = document.getElementById('includeSettings').checked;
        const includeData = document.getElementById('includeData').checked;

        if (!includeSettings && !includeData) {
            alert('ูุฌุจ ุงุฎุชูุงุฑ ููุน ูุงุญุฏ ุนูู ุงูุฃูู ูู ุงูุจูุงูุงุช ูููุณุฎ ุงูุงุญุชูุงุทู');
            return;
        }

        const currentUser = getCurrentUser();
        const backup = {
            name: backupName,
            date: new Date().toISOString(),
            version: '2.0.0',
            createdBy: currentUser ? currentUser.fullName : 'ุบูุฑ ูุนุฑูู',
            systemInfo: {
                userAgent: navigator.userAgent,
                timestamp: Date.now(),
                dataSize: 0
            },
            data: {}
        };

        let totalRecords = 0;

        if (includeSettings) {
            backup.data.settings = appData.settings;
            console.log('โ ุชู ุชุถููู ุงูุฅุนุฏุงุฏุงุช');
        }

        if (includeData) {
            // ุชุถููู ุฌููุน ุงูุจูุงูุงุช ูุน ุฅุญุตุงุฆูุงุช
            const dataTypes = [
                'customers', 'suppliers', 'products', 'warehouses',
                'invoices', 'payments', 'journalEntries', 'inventoryMovements', 'users'
            ];

            dataTypes.forEach(type => {
                if (appData[type]) {
                    backup.data[type] = appData[type];
                    totalRecords += Array.isArray(appData[type]) ? appData[type].length : 1;
                    console.log(`โ ุชู ุชุถููู ${type}: ${Array.isArray(appData[type]) ? appData[type].length : 1} ุนูุตุฑ`);
                }
            });
        }

        // ุญุณุงุจ ุญุฌู ุงูุจูุงูุงุช
        const dataStr = JSON.stringify(backup, null, 2);
        backup.systemInfo.dataSize = new Blob([dataStr]).size;
        backup.systemInfo.totalRecords = totalRecords;

        // ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุฅุถุงูุฉ ูุนูููุงุช ุงูุญุฌู
        const finalDataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([finalDataStr], {type: 'application/json'});

        // ุชุญููู ุงูููู
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        const fileName = `${backupName}_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
        link.download = fileName;
        link.click();

        // ุชูุธูู ุงูุฐุงูุฑุฉ
        URL.revokeObjectURL(link.href);

        console.log('โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');

        const sizeInKB = (backup.systemInfo.dataSize / 1024).toFixed(2);
        const successMessage = `โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!

๐ ุงุณู ุงูููู: ${fileName}
๐ ุฅุฌูุงูู ุงูุณุฌูุงุช: ${totalRecords}
๐พ ุญุฌู ุงูููู: ${sizeInKB} KB
๐ ุงูุชุงุฑูุฎ: ${formatDateTime(new Date())}

ุชู ุชุญููู ุงูููู ุชููุงุฆูุงู.`;

        alert(successMessage);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: ' + error.message);
    }
}

/**
 * ุงูุชุญูู ูู ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
 */
function validateBackupFile(input) {
    const file = input.files[0];
    const restoreBtn = document.getElementById('restoreBtn');
    const confirmRestore = document.getElementById('confirmRestore');
    const backupFileInfo = document.getElementById('backupFileInfo');
    const backupDetails = document.getElementById('backupDetails');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backup = JSON.parse(e.target.result);

                // ุนุฑุถ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                backupDetails.innerHTML = `
                    <strong>ุงุณู ุงููุณุฎุฉ:</strong> ${backup.name || 'ุบูุฑ ูุญุฏุฏ'}<br>
                    <strong>ุงูุชุงุฑูุฎ:</strong> ${backup.date ? formatDateTime(backup.date) : 'ุบูุฑ ูุญุฏุฏ'}<br>
                    <strong>ุงูุฅุตุฏุงุฑ:</strong> ${backup.version || 'ุบูุฑ ูุญุฏุฏ'}<br>
                    <strong>ุงูุจูุงูุงุช ุงููุชุถููุฉ:</strong> ${Object.keys(backup.data || {}).join(', ')}
                `;

                backupFileInfo.style.display = 'block';

                // ุชูุนูู ุฒุฑ ุงูุงุณุชุนุงุฏุฉ ุนูุฏ ุชุฃููุฏ ุงููุณุชุฎุฏู
                confirmRestore.addEventListener('change', function() {
                    restoreBtn.disabled = !this.checked;
                });

            } catch (error) {
                alert('ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุงูุญ');
                input.value = '';
                backupFileInfo.style.display = 'none';
                restoreBtn.disabled = true;
            }
        };
        reader.readAsText(file);
    } else {
        backupFileInfo.style.display = 'none';
        restoreBtn.disabled = true;
    }
}

/**
 * ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
 */
function restoreBackup() {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('backup')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุงุณุชุนุงุฏุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ');
        return;
    }

    const fileInput = document.getElementById('backupFile');
    const file = fileInput.files[0];
    const confirmRestore = document.getElementById('confirmRestore');

    if (!file) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
        return;
    }

    if (!confirmRestore.checked) {
        alert('ูุฌุจ ุชุฃููุฏ ุงูุงุณุชุนุงุฏุฉ ุฃููุงู');
        return;
    }

    const finalConfirm = confirm(`โ๏ธ ุชุญุฐูุฑ ููู โ๏ธ

ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ

ุณูุชู:
โข ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
โข ุญุฐู ุฌููุน ุงูููุงุชูุฑ ูุงูุณูุฏุงุช ุงูุญุงููุฉ
โข ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงูุฅุนุฏุงุฏุงุช
โข ุชุณุฌูู ุฎุฑูุฌ ุฌููุน ุงููุณุชุฎุฏููู

ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!

ุงุถุบุท "ููุงูู" ูููุชุงุจุนุฉ ุฃู "ุฅูุบุงุก" ููุชููู.`);

    if (!finalConfirm) {
        return;
    }

    console.log('๐ ุจุฏุก ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);

            console.log('๐ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', {
                name: backup.name,
                date: backup.date,
                version: backup.version,
                createdBy: backup.createdBy
            });

            // ุงูุชุญูู ูู ุตุญุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
            if (!backup.data || typeof backup.data !== 'object') {
                throw new Error('ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูุง ูุญุชูู ุนูู ุจูุงูุงุช ุตุญูุญุฉ');
            }

            // ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุฑูุนุฉ ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุจู ุงูุงุณุชุนุงุฏุฉ
            const currentBackup = {
                name: 'auto_backup_before_restore',
                date: new Date().toISOString(),
                version: '2.0.0',
                data: { ...appData }
            };

            // ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงูุณุฑูุนุฉ ูู localStorage ูุคูุชุงู
            localStorage.setItem('samProEmergencyBackup', JSON.stringify(currentBackup));
            console.log('๐พ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุทุงุฑุฆุฉ');

            let restoredItems = 0;
            const restoredTypes = [];

            // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
            if (backup.data) {
                Object.keys(backup.data).forEach(key => {
                    if (backup.data[key] !== null && backup.data[key] !== undefined) {
                        appData[key] = backup.data[key];
                        restoredTypes.push(key);

                        if (Array.isArray(backup.data[key])) {
                            restoredItems += backup.data[key].length;
                        } else {
                            restoredItems += 1;
                        }

                        console.log(`โ ุชู ุงุณุชุนุงุฏุฉ ${key}: ${Array.isArray(backup.data[key]) ? backup.data[key].length : 1} ุนูุตุฑ`);
                    }
                });
            }

            // ุญูุธ ุงูุจูุงูุงุช ุงููุณุชุนุงุฏุฉ
            saveData();
            console.log('๐พ ุชู ุญูุธ ุงูุจูุงูุงุช ุงููุณุชุนุงุฏุฉ');

            // ูุณุญ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ูุฅุฌุจุงุฑ ุงููุณุชุฎุฏููู ุนูู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
            clearLoginData();

            const successMessage = `โ ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!

๐ ุงุณู ุงููุณุฎุฉ: ${backup.name || 'ุบูุฑ ูุญุฏุฏ'}
๐ ุชุงุฑูุฎ ุงููุณุฎุฉ: ${backup.date ? formatDateTime(backup.date) : 'ุบูุฑ ูุญุฏุฏ'}
๐ค ููุดุฆ ุงููุณุฎุฉ: ${backup.createdBy || 'ุบูุฑ ูุญุฏุฏ'}
๐ ุฅุฌูุงูู ุงูุนูุงุตุฑ ุงููุณุชุนุงุฏุฉ: ${restoredItems}
๐ง ุฃููุงุน ุงูุจูุงูุงุช: ${restoredTypes.join(', ')}

ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุงูุขู.`;

            alert(successMessage);

            // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
            window.location.reload();

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', error);

            const errorMessage = `โ ูุดู ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ

ุงูุณุจุจ: ${error.message}

ูุฑุฌู ุงูุชุญูู ูู:
โข ุตุญุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
โข ุฃู ุงูููู ุจุตูุบุฉ JSON ุตุญูุญุฉ
โข ุฃู ุงููุณุฎุฉ ูุชูุงููุฉ ูุน ูุฐุง ุงูุฅุตุฏุงุฑ

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ูุฑุฌู ุงูุงุชุตุงู ุจุงูุฏุนู ุงูููู.`;

            alert(errorMessage);
        }
    };
    reader.readAsText(file);
}

/**
 * ุนุฑุถ ูุงูุฐุฉ ุงูุชุญููู ุจูู ุงููุฎุงุฒู
 */
function showTransferModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'transferModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุญููู ุจูู ุงููุฎุงุฒู</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transferForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transferProduct" class="form-label">ุงูููุชุฌ <span class="text-danger">*</span></label>
                                <select class="form-select" id="transferProduct" required>
                                    <option value="">ุงุฎุชุฑ ุงูููุชุฌ</option>
                                    ${appData.products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transferQuantity" class="form-label">ุงููููุฉ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="transferQuantity" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fromWarehouse" class="form-label">ูู ุงููุฎุฒู <span class="text-danger">*</span></label>
                                <select class="form-select" id="fromWarehouse" required>
                                    <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
                                    ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="toWarehouse" class="form-label">ุฅูู ุงููุฎุฒู <span class="text-danger">*</span></label>
                                <select class="form-select" id="toWarehouse" required>
                                    <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
                                    ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transferNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="transferNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransfer()">ุชูููุฐ ุงูุชุญููู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุงูุชุญููู ุจูู ุงููุฎุงุฒู
 */
function saveTransfer() {
    const productId = parseInt(document.getElementById('transferProduct').value);
    const quantity = parseFloat(document.getElementById('transferQuantity').value);
    const fromWarehouseId = parseInt(document.getElementById('fromWarehouse').value);
    const toWarehouseId = parseInt(document.getElementById('toWarehouse').value);
    const notes = document.getElementById('transferNotes').value.trim();

    if (!productId || !quantity || !fromWarehouseId || !toWarehouseId || quantity <= 0) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
        return;
    }

    if (fromWarehouseId === toWarehouseId) {
        alert('ูุง ูููู ุงูุชุญููู ุฅูู ููุณ ุงููุฎุฒู');
        return;
    }

    // ุงูุชุญูู ูู ุชููุฑ ุงููููุฉ ูู ุงููุฎุฒู ุงููุตุฏุฑ
    const product = appData.products.find(p => p.id === productId);
    if (product && product.quantity < quantity) {
        alert(`ุงููููุฉ ุงููุชุงุญุฉ: ${product.quantity} ${product.unit}`);
        return;
    }

    // ุฅุถุงูุฉ ุญุฑูุฉ ุฅุฎุฑุงุฌ ูู ุงููุฎุฒู ุงููุตุฏุฑ
    addInventoryMovement({
        productId: productId,
        warehouseId: fromWarehouseId,
        movementType: 'out',
        quantity: quantity,
        reference: 'ุชุญููู ูุฎุฒู',
        notes: `ุชุญููู ุฅูู ${appData.warehouses.find(w => w.id === toWarehouseId)?.name || 'ูุฎุฒู ุขุฎุฑ'} - ${notes}`
    });

    // ุฅุถุงูุฉ ุญุฑูุฉ ุฅุฏุฎุงู ูููุฎุฒู ุงููุณุชูุฏู
    addInventoryMovement({
        productId: productId,
        warehouseId: toWarehouseId,
        movementType: 'in',
        quantity: quantity,
        reference: 'ุชุญููู ูุฎุฒู',
        notes: `ุชุญููู ูู ${appData.warehouses.find(w => w.id === fromWarehouseId)?.name || 'ูุฎุฒู ุขุฎุฑ'} - ${notes}`
    });

    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
    modal.hide();

    alert('ุชู ุชูููุฐ ุงูุชุญููู ุจูุฌุงุญ');
    showPage('inventory');
}

/**
 * ุตูุญุฉ ุฅุถุงูุฉ ููุฑุฏ
 */
function getAddSupplierHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-truck-loading me-2"></i>
                        ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ
                    </h1>
                    <button class="btn btn-outline-secondary" onclick="showPage('suppliers')">
                        <i class="fas fa-arrow-right me-2"></i>
                        ุงูุนูุฏุฉ ูููุงุฆูุฉ
                    </button>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-truck me-2"></i>
                            ุจูุงูุงุช ุงูููุฑุฏ
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="addSupplierForm" onsubmit="addSupplier(event)">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="supplierName" class="form-label">
                                        <i class="fas fa-building me-1"></i>
                                        ุงุณู ุงูููุฑุฏ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="supplierName" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="supplierPhone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>
                                        ุฑูู ุงููุงุชู
                                    </label>
                                    <input type="tel" class="form-control" id="supplierPhone">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="supplierEmail" class="form-label">
                                        <i class="fas fa-envelope me-1"></i>
                                        ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
                                    </label>
                                    <input type="email" class="form-control" id="supplierEmail">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="supplierTaxNumber" class="form-label">
                                        <i class="fas fa-receipt me-1"></i>
                                        ุงูุฑูู ุงูุถุฑูุจู
                                    </label>
                                    <input type="text" class="form-control" id="supplierTaxNumber">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="supplierAddress" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    ุงูุนููุงู
                                </label>
                                <textarea class="form-control" id="supplierAddress" rows="3"></textarea>
                            </div>

                            <div class="row" ${appData.settings.enableMultiCurrency ? '' : 'style="display: none;"'}>
                                <div class="col-md-6 mb-3">
                                    <label for="supplierCurrency" class="form-label">
                                        <i class="fas fa-coins me-1"></i>
                                        ุงูุนููุฉ
                                    </label>
                                    <select class="form-select" id="supplierCurrency">
                                        <option value="${appData.settings.currency || 'SYP'}">${getCurrencySymbol(appData.settings.currency || 'SYP')}</option>
                                        ${appData.settings.enableMultiCurrency ? `
                                            <option value="USD">$ (ุงูุฏููุงุฑ ุงูุฃูุฑููู)</option>
                                            <option value="EUR">โฌ (ุงูููุฑู)</option>
                                            <option value="SAR">ุฑ.ุณ (ุงูุฑูุงู ุงูุณุนูุฏู)</option>
                                            <option value="AED">ุฏ.ุฅ (ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู)</option>
                                            <option value="EGP">ุฌ.ู (ุงูุฌููู ุงููุตุฑู)</option>
                                            <option value="JOD">ุฏ.ุฃ (ุงูุฏููุงุฑ ุงูุฃุฑุฏูู)</option>
                                            <option value="LBP">ู.ู (ุงูููุฑุฉ ุงููุจูุงููุฉ)</option>
                                            <option value="TRY">โบ (ุงูููุฑุฉ ุงูุชุฑููุฉ)</option>
                                            <option value="GBP">ยฃ (ุงูุฌููู ุงูุฅุณุชุฑูููู)</option>
                                        ` : ''}
                                    </select>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="showPage('suppliers')">
                                    <i class="fas fa-times me-2"></i>
                                    ุฅูุบุงุก
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุงูููุฑุฏ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุงููุฎุงุฒู
 */
function getWarehousesHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-warehouse me-2"></i>
                        ุฅุฏุงุฑุฉ ุงููุฎุงุฒู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddWarehouseModal()">
                            <i class="fas fa-plus me-2"></i>
                            ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportWarehousesToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printContent('warehouses', 'ูุงุฆูุฉ ุงููุฎุงุฒู')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุงุฆูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ุงุณู ุงููุฎุฒู</th>
                                <th>ุงููููุน</th>
                                <th>ุงููุฏูุฑ</th>
                                <th>ุงููุงุชู</th>
                                <th>ุนุฏุฏ ุงูุฃุตูุงู</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${getWarehousesTableRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal ุฅุถุงูุฉ ูุฎุฒู -->
        <div class="modal fade" id="addWarehouseModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addWarehouseForm">
                            <div class="mb-3">
                                <label for="warehouseName" class="form-label">ุงุณู ุงููุฎุฒู <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="warehouseName" required>
                            </div>
                            <div class="mb-3">
                                <label for="warehouseLocation" class="form-label">ุงููููุน</label>
                                <input type="text" class="form-control" id="warehouseLocation">
                            </div>
                            <div class="mb-3">
                                <label for="warehouseManager" class="form-label">ุงููุฏูุฑ</label>
                                <input type="text" class="form-control" id="warehouseManager">
                            </div>
                            <div class="mb-3">
                                <label for="warehousePhone" class="form-label">ุงููุงุชู</label>
                                <input type="tel" class="form-control" id="warehousePhone">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                        <button type="button" class="btn btn-primary" onclick="addWarehouse()">ุญูุธ ุงููุฎุฒู</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุงููุญุณูุฉ
 */
function getInventoryDetailsHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-list-alt me-2"></i>
                        ุชูุงุตูู ุญุฑูุฉ ุงูุฃุตูุงู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="showPage('inventory')">
                            <i class="fas fa-arrow-left me-2"></i>
                            ุงูุนูุฏุฉ ูุญุฑูุฉ ุงููุฎุฒูู
                        </button>
                        <button class="btn btn-outline-success" onclick="exportInventoryDetailsToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-primary" onclick="printInventoryDetails()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช</h6>
                                <h4 id="totalInMovements">0</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-arrow-up fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช</h6>
                                <h4 id="totalOutMovements">0</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-arrow-down fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">ุงูุชุญูููุงุช</h6>
                                <h4 id="totalTransferMovements">0</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exchange-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">ุงูุชุณููุงุช</h6>
                                <h4 id="totalAdjustmentMovements">0</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-balance-scale fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ ุงููุญุณูุฉ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุจุญุซ ูุงูุชุตููุฉ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">ููุน ุงูุญุฑูุฉ</label>
                        <select class="form-select" id="detailsMovementTypeFilter" onchange="applyInventoryDetailsFilter()">
                            <option value="">ุฌููุน ุงูุญุฑูุงุช</option>
                            <option value="in">ุฅุฏุฎุงู</option>
                            <option value="out">ุฅุฎุฑุงุฌ</option>
                            <option value="transfer">ุชุญููู</option>
                            <option value="adjustment">ุชุณููุฉ</option>
                            <option value="sale">ูุจูุนุงุช</option>
                            <option value="purchase">ูุดุชุฑูุงุช</option>
                            <option value="return">ูุฑุชุฌุนุงุช</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุตูู</label>
                        <select class="form-select" id="detailsProductFilter" onchange="applyInventoryDetailsFilter()">
                            <option value="">ุฌููุน ุงูุฃุตูุงู</option>
                            ${appData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงููุฎุฒู</label>
                        <select class="form-select" id="detailsWarehouseFilter" onchange="applyInventoryDetailsFilter()">
                            <option value="">ุฌููุน ุงููุฎุงุฒู</option>
                            ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="detailsFromDate" onchange="applyInventoryDetailsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="detailsToDate" onchange="applyInventoryDetailsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="detailsMovementSearch" placeholder="ุงููุฑุฌุน ุฃู ุงูููุงุญุธุงุช" onkeyup="applyInventoryDetailsFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyInventoryDetailsFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearInventoryDetailsFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-info" onclick="showOnlyOutMovements()">
                            <i class="fas fa-arrow-down me-2"></i>
                            ุนุฑุถ ุงูุฅุฎุฑุงุฌุงุช ููุท
                        </button>
                        <button class="btn btn-outline-success" onclick="showOnlyInMovements()">
                            <i class="fas fa-arrow-up me-2"></i>
                            ุนุฑุถ ุงูุฅุฏุฎุงูุงุช ููุท
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูุชูุงุตูู ุงููุญุณู -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-table me-2"></i>
                    ุชูุงุตูู ุญุฑูุฉ ุงูุฃุตูุงู
                    <span class="badge bg-primary ms-2" id="movementsCount">0</span>
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 8%">ุงูุชุงุฑูุฎ</th>
                                <th style="width: 10%">ููุน ุงูุญุฑูุฉ</th>
                                <th style="width: 15%">ุงูุตูู</th>
                                <th style="width: 10%">ุงููุฎุฒู</th>
                                <th style="width: 8%">ุงููููุฉ</th>
                                <th style="width: 6%">ุงููุญุฏุฉ</th>
                                <th style="width: 10%">ุณุนุฑ ุงููุญุฏุฉ</th>
                                <th style="width: 10%">ุงููุฌููุน</th>
                                <th style="width: 10%">ุงููุฑุฌุน/ุงูุณุจุจ</th>
                                <th style="width: 8%">ุงููุณุชุฎุฏู</th>
                                <th style="width: 15%">ููุงุญุธุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryDetailsTable">
                            ${getInventoryDetailsRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
            setTimeout(() => {
                updateInventoryDetailsStats();
            }, 100);
        </script>
    `;
}

/**
 * ุตูุญุฉ ุญุฑูุฉ ุงููุฎุฒูู
 */
function getInventoryHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-exchange-alt me-2"></i>
                        ุญุฑูุฉ ุงููุฎุฒูู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddMovementModal()">
                            <i class="fas fa-plus me-2"></i>
                            ุฅุถุงูุฉ ุญุฑูุฉ
                        </button>
                        <button class="btn btn-success" onclick="showTransferModal()">
                            <i class="fas fa-exchange-alt me-2"></i>
                            ุชุญููู ุจูู ุงููุฎุงุฒู
                        </button>
                        <button class="btn btn-warning" onclick="refreshInventoryCalculations()" title="ุชุญุฏูุซ ุญุณุงุจุงุช ุงููุฎุฒูู">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ ุงูุญุณุงุจุงุช
                        </button>
                        <button class="btn btn-outline-success me-2" onclick="exportInventoryToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-primary" onclick="printContent('inventory', 'ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">ููุน ุงูุญุฑูุฉ</label>
                        <select class="form-select" id="movementTypeFilter" onchange="applyInventoryMovementsFilter()">
                            <option value="">ุฌููุน ุงูุญุฑูุงุช</option>
                            <option value="in">ุฅุฏุฎุงู</option>
                            <option value="out">ุฅุฎุฑุงุฌ</option>
                            <option value="transfer">ุชุญููู</option>
                            <option value="adjustment">ุชุณููุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุตูู</label>
                        <select class="form-select" id="productFilter" onchange="applyInventoryMovementsFilter()">
                            <option value="">ุฌููุน ุงูุฃุตูุงู</option>
                            ${appData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงููุฎุฒู</label>
                        <select class="form-select" id="warehouseFilter" onchange="applyInventoryMovementsFilter()">
                            <option value="">ุฌููุน ุงููุฎุงุฒู</option>
                            ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="fromDate" onchange="applyInventoryMovementsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="toDate" onchange="applyInventoryMovementsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="movementSearch" placeholder="ุงููุฑุฌุน ุฃู ุงูููุงุญุธุงุช" onkeyup="applyInventoryMovementsFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary" onclick="applyInventoryMovementsFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearInventoryMovementsFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูุญุฑูุงุช -->
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ููุน ุงูุญุฑูุฉ</th>
                                <th>ุงูุตูู</th>
                                <th>ุงููุฎุฒู</th>
                                <th>ุงููููุฉ</th>
                                <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                <th>ุงููุฌููุน</th>
                                <th>ุงููุฑุฌุน</th>
                                <th>ููุงุญุธุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryMovementsTable">
                            ${getInventoryMovementsRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุฅูุดุงุก ูุงุชูุฑุฉ
 */
function getCreateInvoiceHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-file-invoice-dollar me-2"></i>
                    ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
                </h1>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <form id="createInvoiceForm" onsubmit="createInvoice(event)">
                    <!-- ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุณุงุณูุฉ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="invoiceType" class="form-label">ููุน ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                            <select class="form-select" id="invoiceType" required onchange="updateClientOptions()">
                                <option value="">ุงุฎุชุฑ ููุน ุงููุงุชูุฑุฉ</option>
                                <option value="sale">ูุงุชูุฑุฉ ูุจูุนุงุช</option>
                                <option value="purchase">ูุงุชูุฑุฉ ูุดุชุฑูุงุช</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="invoiceNumber" class="form-label">ุฑูู ุงููุงุชูุฑุฉ</label>
                            <input type="text" class="form-control" id="invoiceNumber" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="invoiceDate" class="form-label">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="invoiceDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="dueDate" class="form-label">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input type="date" class="form-control" id="dueDate">
                        </div>
                    </div>

                    <!-- ุงูุนููู/ุงูููุฑุฏ ูุงูุนููุฉ -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="clientSelect" class="form-label">
                                <span id="clientLabel">ุงูุนููู/ุงูููุฑุฏ</span> <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="clientSelect" required onchange="updateClientInfo()">
                                <option value="">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="invoiceCurrency" class="form-label">ุนููุฉ ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                            <select class="form-select" id="invoiceCurrency" required onchange="updateCurrencyDisplay()">
                                <option value="SYP" selected>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                <option value="EUR">ููุฑู (โฌ)</option>
                                <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                                <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="exchangeRateOptional" class="form-label">
                                ุณุนุฑ ุงูุตุฑู (ุงุฎุชูุงุฑู)
                                <span id="currencySymbolDisplay" class="badge bg-info ms-1">ู.ุณ</span>
                            </label>
                            <input type="number" class="form-control" id="exchangeRateOptional"
                                   step="0.0001" placeholder="ุณุนุฑ ุตุฑู ูุฎุตุต"
                                   onchange="updateCustomExchangeRate()">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ุงุชุฑูู ูุงุฑุบุงู ูุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
                                <span id="defaultRateHint" class="text-primary"></span>
                            </small>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ</label>
                            <div id="clientInfo" class="form-control-plaintext text-muted">
                                ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ ูุนุฑุถ ุงููุนูููุงุช
                            </div>
                        </div>
                    </div>

                    <!-- ุฎูุงุฑุงุช ุชุญููู ุงูุนููุฉ -->
                    <div class="row mb-4" id="currencyConversionSection" style="display: none;">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exchange-alt me-2"></i>
                                        ุชุญููู ุงูุนููุฉ
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">ุงูุนููุฉ ุงูุญุงููุฉ</label>
                                            <input type="text" class="form-control" id="currentCurrencyDisplay" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="targetCurrency" class="form-label">ุชุญููู ุฅูู</label>
                                            <select class="form-select" id="targetCurrency" onchange="calculateCurrencyConversion()">
                                                <option value="">ุงุฎุชุฑ ุงูุนููุฉ ุงููุณุชูุฏูุฉ</option>
                                                <option value="SYP">ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                                <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                                <option value="EUR">ููุฑู (โฌ)</option>
                                                <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                                <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                                <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                                <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                                                <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                                <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                                <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">ุณุนุฑ ุงูุตุฑู</label>
                                            <input type="number" class="form-control" id="exchangeRate" step="0.0001" readonly>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">ุงููุจูุบ ุงููุญูู</label>
                                            <input type="text" class="form-control" id="convertedAmount" readonly>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success d-block" onclick="applyCurrencyConversion()">
                                                <i class="fas fa-check me-1"></i>
                                                ุชุทุจูู ุงูุชุญููู
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                ุณูุชู ุชุญููู ุฌููุน ุงููุจุงูุบ ูู ุงููุงุชูุฑุฉ ุฅูู ุงูุนููุฉ ุงููุณุชูุฏูุฉ ุจูุงุกู ุนูู ุณุนุฑ ุงูุตุฑู ุงููุญุฏุฏ
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุนูุงุตุฑ ุงููุงุชูุฑุฉ -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>ุนูุงุตุฑ ุงููุงุชูุฑุฉ</h5>
                            <button type="button" class="btn btn-success" onclick="addInvoiceItem()">
                                <i class="fas fa-plus me-2"></i>
                                ุฅุถุงูุฉ ุตูู
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">ุงูุตูู</th>
                                        <th style="width: 20%">ุงูููุงุตูุงุช</th>
                                        <th style="width: 10%">ุงููููุฉ</th>
                                        <th style="width: 12%">ุณุนุฑ ุงููุญุฏุฉ</th>
                                        <th style="width: 8%">ุฎุตู %</th>
                                        <th style="width: 15%">ุงููุฌููุน</th>
                                        <th style="width: 10%">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceItemsTable">
                                    <!-- ุณูุชู ุฅุถุงูุฉ ุงูุนูุงุตุฑ ููุง -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงููุฌููุน ุงููุฑุนู:</span>
                                        <span id="subtotalAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงูุฎุตู:</span>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="discountPercentage"
                                                   min="0" max="100" step="0.01" value="0" onchange="calculateInvoiceTotals()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ูุจูุบ ุงูุฎุตู:</span>
                                        <span id="discountAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงูุถุฑูุจุฉ:</span>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="taxPercentage"
                                                   min="0" max="100" step="0.01" value="0" onchange="calculateInvoiceTotals()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ูุจูุบ ุงูุถุฑูุจุฉ:</span>
                                        <span id="taxAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>ุงููุฌููุน ุงูููุงุฆู:</strong>
                                        <strong id="totalAmount">0.00 ู.ุณ</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ููุงุญุธุงุช -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <label for="invoiceNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- ุฃุฒุฑุงุฑ ุงูุญูุธ -->
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <button type="button" class="btn btn-outline-warning" onclick="fixInvoiceSaving()">
                                <i class="fas fa-tools me-2"></i>
                                ุฅุตูุงุญ ูุดููุฉ ุงูุญูุธ
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="testInvoiceSave()">
                                <i class="fas fa-vial me-2"></i>
                                ุงุฎุชุจุงุฑ ุงููุธุงู
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="quickTest()">
                                <i class="fas fa-rocket me-2"></i>
                                ุงุฎุชุจุงุฑ ุณุฑูุน
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" onclick="showPage('dashboard')">
                                <i class="fas fa-times me-2"></i>
                                ุฅูุบุงุก
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportCurrentInvoiceToExcel()">
                                <i class="fas fa-file-excel me-2"></i>
                                ุชุตุฏูุฑ Excel
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="saveInvoiceAsDraft()">
                                <i class="fas fa-save me-2"></i>
                                ุญูุธ ููุณูุฏุฉ
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>
                                ุญูุธ ูุชุฃููุฏ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุฅูุดุงุก ูุงุชูุฑุฉ ุฎุงุตุฉ
 */
function getCreateCustomInvoiceHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-star me-2 text-warning"></i>
                    ุฅูุดุงุก ูุงุชูุฑุฉ ุฎุงุตุฉ
                </h1>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ:</strong> ุชุชูุญ ูู ุฅุฏุฎุงู ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ ูุฏููุงู ุฃู ุงุฎุชูุงุฑู ูู ุงููุงุฆูุฉุ ูุน ูุฑููุฉ ุฃูุจุฑ ูู ุงูุชุญูู ุจุงูุนููุฉ ูุฃุณุนุงุฑ ุงูุตุฑู.
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <form id="createCustomInvoiceForm" onsubmit="createCustomInvoice(event)">
                    <!-- ูุนูููุงุช ุงููุงุชูุฑุฉ ุงูุฃุณุงุณูุฉ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="customInvoiceType" class="form-label">ููุน ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                            <select class="form-select" id="customInvoiceType" required onchange="updateCustomClientOptions()">
                                <option value="">ุงุฎุชุฑ ููุน ุงููุงุชูุฑุฉ</option>
                                <option value="sale">ูุงุชูุฑุฉ ูุจูุนุงุช ุฎุงุตุฉ</option>
                                <option value="purchase">ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฎุงุตุฉ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customInvoiceNumber" class="form-label">ุฑูู ุงููุงุชูุฑุฉ</label>
                            <input type="text" class="form-control" id="customInvoiceNumber" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="customInvoiceDate" class="form-label">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="customInvoiceDate" required>
                        </div>
                        <div class="col-md-3">
                            <label for="customDueDate" class="form-label">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
                            <input type="date" class="form-control" id="customDueDate">
                        </div>
                    </div>

                    <!-- ุฎูุงุฑุงุช ุงูุนููู/ุงูููุฑุฏ -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-user-cog me-2"></i>
                                ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="clientInputType" id="existingClient" value="existing" checked onchange="toggleClientInputType()">
                                        <label class="form-check-label" for="existingClient">
                                            <i class="fas fa-list me-1"></i>ุงุฎุชูุงุฑ ูู ุงููุงุฆูุฉ
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="clientInputType" id="manualClient" value="manual" onchange="toggleClientInputType()">
                                        <label class="form-check-label" for="manualClient">
                                            <i class="fas fa-keyboard me-1"></i>ุฅุฏุฎุงู ูุฏูู
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- ุงุฎุชูุงุฑ ูู ุงููุงุฆูุฉ -->
                            <div id="existingClientSection">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="customClientSelect" class="form-label">
                                            <span id="customClientLabel">ุงูุนููู/ุงูููุฑุฏ</span> <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="customClientSelect" onchange="updateCustomClientInfo()">
                                            <option value="">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ</label>
                                        <div id="customClientInfo" class="form-control-plaintext text-muted">
                                            ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ ูุนุฑุถ ุงููุนูููุงุช
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ุงูุฅุฏุฎุงู ุงููุฏูู -->
                            <div id="manualClientSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="manualClientName" class="form-label">ุงูุงุณู <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="manualClientName" placeholder="ุงุณู ุงูุนููู/ุงูููุฑุฏ">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="manualClientPhone" class="form-label">ุฑูู ุงููุงุชู</label>
                                        <input type="tel" class="form-control" id="manualClientPhone" placeholder="ุฑูู ุงููุงุชู">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="manualClientEmail" class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                        <input type="email" class="form-control" id="manualClientEmail" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="manualClientAddress" class="form-label">ุงูุนููุงู</label>
                                        <textarea class="form-control" id="manualClientAddress" rows="2" placeholder="ุงูุนููุงู ุงููุงูู"></textarea>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="manualClientTaxNumber" class="form-label">ุงูุฑูู ุงูุถุฑูุจู</label>
                                        <input type="text" class="form-control" id="manualClientTaxNumber" placeholder="ุงูุฑูู ุงูุถุฑูุจู">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="manualClientCurrency" class="form-label">ุงูุนููุฉ ุงูููุถูุฉ</label>
                                        <select class="form-select" id="manualClientCurrency">
                                            <option value="SYP">ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                            <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                            <option value="EUR">ููุฑู (โฌ)</option>
                                            <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                            <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                            <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                            <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                                            <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                            <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                            <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุฅุนุฏุงุฏุงุช ุงูุนููุฉ ุงููุชูุฏูุฉ -->
                    <div class="card border-warning mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-coins me-2"></i>
                                ุฅุนุฏุงุฏุงุช ุงูุนููุฉ ุงููุชูุฏูุฉ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="customInvoiceCurrency" class="form-label">ุนููุฉ ุงููุงุชูุฑุฉ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="customInvoiceCurrency" required onchange="updateCustomCurrencyDisplay()">
                                        <option value="SYP" selected>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                        <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                        <option value="EUR">ููุฑู (โฌ)</option>
                                        <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                        <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                        <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                        <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                                        <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                        <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                        <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="customExchangeRate" class="form-label">ุณุนุฑ ุงูุตุฑู (ุงุฎุชูุงุฑู)</label>
                                    <input type="number" class="form-control" id="customExchangeRate"
                                           step="0.0001" placeholder="ุณุนุฑ ุตุฑู ูุฎุตุต"
                                           onchange="updateCustomInvoiceExchangeRate()">
                                    <small class="text-muted">ุงุชุฑูู ูุงุฑุบุงู ูุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ุงูุณุนุฑ ุงูุงูุชุฑุงุถู</label>
                                    <input type="text" class="form-control" id="defaultExchangeRateDisplay" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ุงูุณุนุฑ ุงููุณุชุฎุฏู</label>
                                    <input type="text" class="form-control" id="usedExchangeRateDisplay" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุนูุงุตุฑ ุงููุงุชูุฑุฉ -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>ุนูุงุตุฑ ุงููุงุชูุฑุฉ</h5>
                            <button type="button" class="btn btn-success" onclick="addCustomInvoiceItem()">
                                <i class="fas fa-plus me-2"></i>
                                ุฅุถุงูุฉ ุตูู
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">ุงูุตูู</th>
                                        <th style="width: 20%">ุงูููุงุตูุงุช</th>
                                        <th style="width: 10%">ุงููููุฉ</th>
                                        <th style="width: 12%">ุณุนุฑ ุงููุญุฏุฉ</th>
                                        <th style="width: 8%">ุฎุตู %</th>
                                        <th style="width: 15%">ุงููุฌููุน</th>
                                        <th style="width: 10%">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="customInvoiceItemsTable">
                                    <!-- ุณูุชู ุฅุถุงูุฉ ุงูุนูุงุตุฑ ููุง -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงููุฌููุน ุงููุฑุนู:</span>
                                        <span id="customSubtotalAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงูุฎุตู:</span>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="customDiscountPercentage"
                                                   min="0" max="100" step="0.01" value="0" onchange="calculateCustomInvoiceTotals()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ูุจูุบ ุงูุฎุตู:</span>
                                        <span id="customDiscountAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ุงูุถุฑูุจุฉ:</span>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="customTaxPercentage"
                                                   min="0" max="100" step="0.01" value="0" onchange="calculateCustomInvoiceTotals()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>ูุจูุบ ุงูุถุฑูุจุฉ:</span>
                                        <span id="customTaxAmount">0.00 ู.ุณ</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>ุงููุฌููุน ุงูููุงุฆู:</strong>
                                        <strong id="customTotalAmount">0.00 ู.ุณ</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ููุงุญุธุงุช -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <label for="customInvoiceNotes" class="form-label">ููุงุญุธุงุช</label>
                            <textarea class="form-control" id="customInvoiceNotes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- ุฃุฒุฑุงุฑ ุงูุญูุธ -->
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <button type="button" class="btn btn-outline-info" onclick="previewCustomInvoice()">
                                <i class="fas fa-eye me-2"></i>
                                ูุนุงููุฉ ุงููุงุชูุฑุฉ
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" onclick="showPage('dashboard')">
                                <i class="fas fa-times me-2"></i>
                                ุฅูุบุงุก
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportCurrentCustomInvoiceToExcel()">
                                <i class="fas fa-file-excel me-2"></i>
                                ุชุตุฏูุฑ Excel
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="saveCustomInvoiceAsDraft()">
                                <i class="fas fa-save me-2"></i>
                                ุญูุธ ููุณูุฏุฉ
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>
                                ุญูุธ ูุชุฃููุฏ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ููุงุชูุฑ ุงููุจูุนุงุช
 */
function getSalesInvoicesHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-file-invoice me-2"></i>
                        ููุงุชูุฑ ุงููุจูุนุงุช
                    </h1>
                    <div>
                        <button class="btn btn-outline-info me-2" onclick="advancedPrint('invoice')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ูุชูุฏูุฉ
                        </button>
                        <button class="btn btn-primary" onclick="showPage('create-invoice')">
                            <i class="fas fa-plus me-2"></i>
                            ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ุงูุนููู</label>
                        <select class="form-select" id="customerFilter" onchange="applySalesInvoicesFilter()">
                            <option value="">ุฌููุน ุงูุนููุงุก</option>
                            ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุญุงูุฉ</label>
                        <select class="form-select" id="statusFilter" onchange="applySalesInvoicesFilter()">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="draft">ูุณูุฏุฉ</option>
                            <option value="confirmed">ูุคูุฏุฉ</option>
                            <option value="paid">ูุฏููุนุฉ</option>
                            <option value="cancelled">ููุบูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="salesFromDate" onchange="applySalesInvoicesFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="salesToDate" onchange="applySalesInvoicesFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="salesSearch" placeholder="ุฑูู ุงููุงุชูุฑุฉ ุฃู ุงุณู ุงูุนููู" onkeyup="applySalesInvoicesFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary" onclick="applySalesInvoicesFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSalesInvoicesFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportSalesInvoicesToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูููุงุชูุฑ -->
        <div class="card shadow">
            <div class="card-body" id="salesInvoicesTableContainer">
                <!-- ุณูุชู ุชุญููู ุงูุฌุฏูู ููุง -->
            </div>
        </div>

        <script>
            // ุชุญููู ุฌููุน ููุงุชูุฑ ุงููุจูุนุงุช ุนูุฏ ุนุฑุถ ุงูุตูุญุฉ
            setTimeout(() => {
                const salesInvoices = appData.invoices.filter(inv => inv.invoiceType === 'sale');
                updateSalesInvoicesTable(salesInvoices);
            }, 100);
        </script>
    `;
}

/**
 * ุตูุญุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช
 */
function getPurchaseInvoicesHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-shopping-cart me-2"></i>
                        ููุงุชูุฑ ุงููุดุชุฑูุงุช
                    </h1>
                    <button class="btn btn-primary" onclick="showPage('create-invoice')">
                        <i class="fas fa-plus me-2"></i>
                        ุฅูุดุงุก ูุงุชูุฑุฉ ูุดุชุฑูุงุช
                    </button>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ุงูููุฑุฏ</label>
                        <select class="form-select" id="supplierFilter" onchange="applyPurchaseInvoicesFilter()">
                            <option value="">ุฌููุน ุงูููุฑุฏูู</option>
                            ${appData.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุญุงูุฉ</label>
                        <select class="form-select" id="purchaseStatusFilter" onchange="applyPurchaseInvoicesFilter()">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="draft">ูุณูุฏุฉ</option>
                            <option value="confirmed">ูุคูุฏุฉ</option>
                            <option value="paid">ูุฏููุนุฉ</option>
                            <option value="cancelled">ููุบูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="purchaseFromDate" onchange="applyPurchaseInvoicesFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="purchaseToDate" onchange="applyPurchaseInvoicesFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="purchaseSearch" placeholder="ุฑูู ุงููุงุชูุฑุฉ ุฃู ุงุณู ุงูููุฑุฏ" onkeyup="applyPurchaseInvoicesFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary" onclick="applyPurchaseInvoicesFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearPurchaseInvoicesFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportPurchaseInvoicesToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูููุงุชูุฑ -->
        <div class="card shadow">
            <div class="card-body" id="purchaseInvoicesTableContainer">
                <!-- ุณูุชู ุชุญููู ุงูุฌุฏูู ููุง -->
            </div>
        </div>

        <script>
            // ุชุญููู ุฌููุน ููุงุชูุฑ ุงููุดุชุฑูุงุช ุนูุฏ ุนุฑุถ ุงูุตูุญุฉ
            setTimeout(() => {
                const purchaseInvoices = appData.invoices.filter(inv => inv.invoiceType === 'purchase');
                updatePurchaseInvoicesTable(purchaseInvoices);
            }, 100);
        </script>
    `;
}

/**
 * ุตูุญุฉ ุณูุฏุงุช ุงููุจุถ
 */
function getReceiptsHTML() {
    const receipts = appData.payments.filter(p => p.paymentType === 'receipt');

    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        ุณูุฏุงุช ุงููุจุถ
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddReceiptModal()">
                            <i class="fas fa-plus me-2"></i>
                            ุฅูุดุงุก ุณูุฏ ูุจุถ
                        </button>
                        <button class="btn btn-outline-warning" onclick="refreshReceiptsData()">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ ุงูุจูุงูุงุช
                        </button>
                        <button class="btn btn-outline-danger" onclick="fixReceiptDataIssues()" title="ุฅุตูุงุญ ูุดุงูู ุงูุจูุงูุงุช">
                            <i class="fas fa-tools me-2"></i>
                            ุฅุตูุงุญ ุงููุดุงูู
                        </button>
                        <button class="btn btn-outline-secondary" onclick="diagnoseCustomerIssues()" title="ุชุดุฎูุต ูุดุงูู ุงูุนููุงุก">
                            <i class="fas fa-stethoscope me-2"></i>
                            ุชุดุฎูุต
                        </button>
                        <button class="btn btn-success" onclick="exportReceiptsToExcel()" title="ุชุตุฏูุฑ ุฌููุน ุณูุฏุงุช ุงููุจุถ ุฅูู Excel">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printReceiptsList()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ ุงููุงุฆูุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ุงูุนููู</label>
                        <select class="form-select" id="receiptCustomerFilter" onchange="applyReceiptsFilter()">
                            <option value="">ุฌููุน ุงูุนููุงุก</option>
                            ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุทุฑููุฉ ุงูุฏูุน</label>
                        <select class="form-select" id="receiptMethodFilter" onchange="applyReceiptsFilter()">
                            <option value="">ุฌููุน ุงูุทุฑู</option>
                            <option value="cash">ููุฏู</option>
                            <option value="bank">ุชุญููู ุจููู</option>
                            <option value="check">ุดูู</option>
                            <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="receiptFromDate" onchange="applyReceiptsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="receiptToDate" onchange="applyReceiptsFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="receiptSearch" placeholder="ุฑูู ุงูุณูุฏ ุฃู ุงุณู ุงูุนููู" onkeyup="applyReceiptsFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary" onclick="applyReceiptsFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearReceiptsFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุณูุฏุงุช ุงููุจุถ -->
        <div class="card shadow">
            <div class="card-body">
                ${receipts.length > 0 ? `
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ุฑูู ุงูุณูุฏ</th>
                                    <th>ุงูุนููู</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงููุจูุบ</th>
                                    <th>ุทุฑููุฉ ุงูุฏูุน</th>
                                    <th>ุฑูู ุงููุฑุฌุน</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getReceiptsRows(receipts)}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="text-center py-5">
                        <i class="fas fa-hand-holding-usd fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">ูุง ุชูุฌุฏ ุณูุฏุงุช ูุจุถ</h5>
                        <p class="text-muted">ุงุจุฏุฃ ุจุฅูุดุงุก ุณูุฏ ูุจุถ ุฌุฏูุฏ</p>
                        ${appData.customers && appData.customers.length > 0 ? `
                            <button class="btn btn-primary" onclick="showAddReceiptModal()">
                                <i class="fas fa-plus me-2"></i>
                                ุฅูุดุงุก ุณูุฏ ูุจุถ
                            </button>
                        ` : `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ูุง ุชูุฌุฏ ุนููุงุก ูู ุงููุธุงู. ูุฌุจ ุฅุถุงูุฉ ุนููู ุฃููุงู ูุจู ุฅูุดุงุก ุณูุฏ ูุจุถ.
                            </div>
                            <button class="btn btn-outline-primary me-2" onclick="showPage('customers')">
                                <i class="fas fa-users me-2"></i>
                                ุฅุฏุงุฑุฉ ุงูุนููุงุก
                            </button>
                            <button class="btn btn-outline-danger" onclick="fixReceiptDataIssues()">
                                <i class="fas fa-tools me-2"></i>
                                ุฅุตูุงุญ ุงููุดุงูู
                            </button>
                            <button class="btn btn-outline-success" onclick="createTestData()">
                                <i class="fas fa-database me-2"></i>
                                ุจูุงูุงุช ุชุฌุฑูุจูุฉ
                            </button>
                            <button class="btn btn-outline-info" onclick="quickReceiptTest()">
                                <i class="fas fa-vial me-2"></i>
                                ุงุฎุชุจุงุฑ ุณุฑูุน
                            </button>
                            <button class="btn btn-outline-primary" onclick="testDirectSave()">
                                <i class="fas fa-rocket me-2"></i>
                                ุงุฎุชุจุงุฑ ูุจุงุดุฑ
                            </button>
                            <button class="btn btn-outline-dark" onclick="debugReceiptIssue()">
                                <i class="fas fa-search me-2"></i>
                                ูุญุต ุดุงูู
                            </button>
                        `}
                    </div>
                `}
            </div>
        </div>

        <!-- Modal ุฅุถุงูุฉ ุณูุฏ ูุจุถ -->
        <div class="modal fade" id="addReceiptModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ุฅูุดุงุก ุณูุฏ ูุจุถ ุฌุฏูุฏ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addReceiptForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="receiptNumber" class="form-label">ุฑูู ุงูุณูุฏ</label>
                                    <input type="text" class="form-control" id="receiptNumber" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="receiptDate" class="form-label">ุงูุชุงุฑูุฎ <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="receiptDate" value="${new Date().toISOString().split('T')[0]}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="receiptCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                                    <select class="form-select" id="receiptCustomer" required>
                                        <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                                        ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="receiptAmount" class="form-label">ุงููุจูุบ <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="receiptAmount" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="receiptMethod" class="form-label">ุทุฑููุฉ ุงูุฏูุน <span class="text-danger">*</span></label>
                                    <select class="form-select" id="receiptMethod" required>
                                        <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                                        <option value="cash">ููุฏู</option>
                                        <option value="bank">ุชุญููู ุจููู</option>
                                        <option value="check">ุดูู</option>
                                        <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="receiptCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="receiptCurrency" required>
                                        <option value="SYP" selected>ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                                        <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                                        <option value="EUR">ููุฑู (โฌ)</option>
                                        <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                                        <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                                        <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                        <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                                        <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="receiptReference" class="form-label">ุฑูู ุงููุฑุฌุน</label>
                                    <input type="text" class="form-control" id="receiptReference" placeholder="ุฑูู ุงูุดูู ุฃู ุงูุญูุงูุฉ">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="receiptBankName" class="form-label">ุงุณู ุงูุจูู</label>
                                <input type="text" class="form-control" id="receiptBankName">
                            </div>
                            <div class="mb-3">
                                <label for="receiptNotes" class="form-label">ููุงุญุธุงุช</label>
                                <textarea class="form-control" id="receiptNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                        <button type="button" class="btn btn-primary" onclick="addReceipt()">ุญูุธ ุงูุณูุฏ</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุณูุฏุงุช ุงูุฏูุน
 */
function getPaymentsHTML() {
    const payments = appData.payments.filter(p => p.paymentType === 'payment');

    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        ุณูุฏุงุช ุงูุฏูุน
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddPaymentModal()">
                            <i class="fas fa-plus me-2"></i>
                            ุฅูุดุงุก ุณูุฏ ุฏูุน
                        </button>
                        <button class="btn btn-success" onclick="exportPaymentsToExcel()" title="ุชุตุฏูุฑ ุฌููุน ุณูุฏุงุช ุงูุฏูุน ุฅูู Excel">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ุงูููุฑุฏ</label>
                        <select class="form-select" id="paymentSupplierFilter" onchange="applyPaymentsFilter()">
                            <option value="">ุฌููุน ุงูููุฑุฏูู</option>
                            ${appData.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุทุฑููุฉ ุงูุฏูุน</label>
                        <select class="form-select" id="paymentMethodFilter" onchange="applyPaymentsFilter()">
                            <option value="">ุฌููุน ุงูุทุฑู</option>
                            <option value="cash">ููุฏู</option>
                            <option value="bank">ุชุญููู ุจููู</option>
                            <option value="check">ุดูู</option>
                            <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="paymentFromDate" onchange="applyPaymentsFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="paymentToDate" onchange="applyPaymentsFilter()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="paymentSearch" placeholder="ุฑูู ุงูุณูุฏ ุฃู ุงุณู ุงูููุฑุฏ" onkeyup="applyPaymentsFilter()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-primary" onclick="applyPaymentsFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearPaymentsFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุณูุฏุงุช ุงูุฏูุน -->
        <div class="card shadow">
            <div class="card-body">
                ${payments.length > 0 ? `
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ุฑูู ุงูุณูุฏ</th>
                                    <th>ุงูููุฑุฏ</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงููุจูุบ</th>
                                    <th>ุทุฑููุฉ ุงูุฏูุน</th>
                                    <th>ุฑูู ุงููุฑุฌุน</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getPaymentsRows(payments)}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="text-center py-5">
                        <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">ูุง ุชูุฌุฏ ุณูุฏุงุช ุฏูุน</h5>
                        <p class="text-muted">ุงุจุฏุฃ ุจุฅูุดุงุก ุณูุฏ ุฏูุน ุฌุฏูุฏ</p>
                        <button class="btn btn-primary" onclick="showAddPaymentModal()">
                            <i class="fas fa-plus me-2"></i>
                            ุฅูุดุงุก ุณูุฏ ุฏูุน
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}



/**
 * ุตูุญุฉ ุฏูุชุฑ ุงูููููุฉ
 */
function getJournalHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-book me-2"></i>
                        ุฏูุชุฑ ุงูููููุฉ ุงูุนุงูุฉ - ูุชุนุฏุฏ ุงูุนููุงุช
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="refreshJournalEntries()" title="ุชุญุฏูุซ ุดุงูู ูุฏูุชุฑ ุงูููููุฉ ูู ุงูููุงุชูุฑ ูุงูุณูุฏุงุช">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ ุดุงูู
                        </button>
                        <button class="btn btn-outline-success" onclick="exportJournal('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printJournal()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                        <button class="btn btn-primary" onclick="refreshJournal()">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ ุนุงุฏู
                        </button>
                        <button class="btn btn-outline-warning" onclick="calculateJournalSummary()">
                            <i class="fas fa-calculator me-2"></i>
                            ุญุณุงุจ ุงูููุฎุต
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุนููุงุช -->
        <div class="row mb-4" id="currencySummary">
            <!-- ุณูุชู ุชุญููู ููุฎุต ุงูุนููุงุช ููุง -->
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ ุงููุญุณูุฉ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุจุญุซ ูุงูุชุญููู
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">ููุน ุงูุนูููุฉ</label>
                        <select class="form-select" id="journalTypeFilter" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงูุนูููุงุช</option>
                            <optgroup label="ุงูููุงุชูุฑ">
                                <option value="sale_invoice">ููุงุชูุฑ ุงููุจูุนุงุช</option>
                                <option value="purchase_invoice">ููุงุชูุฑ ุงููุดุชุฑูุงุช</option>
                                <option value="invoice">ุฌููุน ุงูููุงุชูุฑ</option>
                            </optgroup>
                            <optgroup label="ุงููุฏููุนุงุช">
                                <option value="receipt">ุณูุฏุงุช ุงููุจุถ</option>
                                <option value="payment">ุณูุฏุงุช ุงูุฏูุน</option>
                                <option value="all_payments">ุฌููุน ุงููุฏููุนุงุช</option>
                            </optgroup>
                            <optgroup label="ุญุฑูุฉ ุงููุฎุฒูู">
                                <option value="inventory_in">ุฅุฏุฎุงู ูุฎุฒูู</option>
                                <option value="inventory_out">ุฅุฎุฑุงุฌ ูุฎุฒูู</option>
                                <option value="inventory_transfer">ุชุญููู ูุฎุฒูู</option>
                                <option value="inventory_adjustment">ุชุณููุฉ ูุฎุฒูู</option>
                            </optgroup>
                            <optgroup label="ุฃุฎุฑู">
                                <option value="adjustment">ุชุณููุงุช ุนุงูุฉ</option>
                                <option value="opening">ุฃุฑุตุฏุฉ ุงูุชุชุงุญูุฉ</option>
                                <option value="closing">ุฃุฑุตุฏุฉ ุฎุชุงููุฉ</option>
                                <option value="manual">ูููุฏ ูุฏููุฉ</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="journalFromDate" onchange="applyJournalFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="journalToDate" onchange="applyJournalFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุนููุฉ</label>
                        <select class="form-select" id="journalCurrencyFilter" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงูุนููุงุช</option>
                            ${getAvailableCurrencies().map(currency =>
                                `<option value="${currency}">${getCurrencyName(currency)} (${getCurrencySymbol(currency)})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุญุณุงุจ</label>
                        <select class="form-select" id="journalAccountFilter" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงูุญุณุงุจุงุช</option>
                            ${getAvailableAccounts().map(account =>
                                `<option value="${account}">${account}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุจุญุซ</label>
                        <input type="text" class="form-control" id="journalSearch" placeholder="ุงูุจุญุซ ูู ุงููุตู" onkeyup="applyJournalFilter()">
                    </div>
                </div>

                <!-- ุตู ุฅุถุงูู ููููุงุชุฑ ุงููุชูุฏูุฉ -->
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label class="form-label">ูุทุงู ุงููุจูุบ</label>
                        <select class="form-select" id="journalAmountRange" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงููุจุงูุบ</option>
                            <option value="0-100">0 - 100</option>
                            <option value="100-500">100 - 500</option>
                            <option value="500-1000">500 - 1,000</option>
                            <option value="1000-5000">1,000 - 5,000</option>
                            <option value="5000-10000">5,000 - 10,000</option>
                            <option value="10000+">ุฃูุซุฑ ูู 10,000</option>
                            <option value="custom">ูุทุงู ูุฎุตุต</option>
                        </select>
                    </div>
                    <div class="col-md-2" id="customAmountRange" style="display: none;">
                        <label class="form-label">ูู - ุฅูู</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="minAmount" placeholder="ูู" onchange="applyJournalFilter()">
                            <input type="number" class="form-control" id="maxAmount" placeholder="ุฅูู" onchange="applyJournalFilter()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุญุงูุฉ ุงูุชูุงุฒู</label>
                        <select class="form-select" id="journalBalanceFilter" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงููููุฏ</option>
                            <option value="balanced">ูุชูุงุฒูุฉ</option>
                            <option value="unbalanced">ุบูุฑ ูุชูุงุฒูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงูุนููู/ุงูููุฑุฏ</label>
                        <select class="form-select" id="journalClientFilter" onchange="applyJournalFilter()">
                            <option value="">ุฌููุน ุงูุนููุงุก ูุงูููุฑุฏูู</option>
                            <optgroup label="ุงูุนููุงุก">
                                ${appData.customers ? appData.customers.map(c => `<option value="customer_${c.id}">${c.name}</option>`).join('') : ''}
                            </optgroup>
                            <optgroup label="ุงูููุฑุฏูู">
                                ${appData.suppliers ? appData.suppliers.map(s => `<option value="supplier_${s.id}">${s.name}</option>`).join('') : ''}
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุงููุฑุฌุน</label>
                        <input type="text" class="form-control" id="journalReferenceFilter" placeholder="ุฑูู ุงููุฑุฌุน" onkeyup="applyJournalFilter()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ุชุฑุชูุจ ุงููุชุงุฆุฌ</label>
                        <select class="form-select" id="journalSortOrder" onchange="applyJournalFilter()">
                            <option value="date_desc">ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู)</option>
                            <option value="date_asc">ุงูุชุงุฑูุฎ (ุงูุฃูุฏู ุฃููุงู)</option>
                            <option value="amount_desc">ุงููุจูุบ (ุงูุฃูุจุฑ ุฃููุงู)</option>
                            <option value="amount_asc">ุงููุจูุบ (ุงูุฃุตุบุฑ ุฃููุงู)</option>
                            <option value="type">ููุน ุงูุนูููุฉ</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary" onclick="applyJournalFilter()">
                            <i class="fas fa-search me-2"></i>
                            ุชุทุจูู ุงูููุชุฑ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearJournalFilter()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-info" onclick="showJournalAnalysis()">
                            <i class="fas fa-chart-pie me-2"></i>
                            ุชุญููู ููุตู
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm" onclick="exportFilteredJournal('excel')">
                                <i class="fas fa-file-excel me-1"></i>
                                ุชุตุฏูุฑ ุงููููุชุฑ
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="printFilteredJournal()">
                                <i class="fas fa-print me-1"></i>
                                ุทุจุงุนุฉ ุงููููุชุฑ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูููุชุฑุฉ -->
        <div class="card shadow mb-4" id="journalFilterStats">
            <!-- ุณูุชู ุชุญููู ุงูุฅุญุตุงุฆูุงุช ููุง -->
        </div>

        <!-- ุฌุฏูู ุฏูุชุฑ ุงูููููุฉ ุงููุญุณู -->
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    ุงููููุฏ ุงููุญุงุณุจูุฉ
                </h5>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm" onclick="addManualJournalEntry()">
                        <i class="fas fa-plus me-1"></i>
                        ุฅุถุงูุฉ ููุฏ ูุฏูู
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="validateJournalBalance()">
                        <i class="fas fa-balance-scale me-1"></i>
                        ุงูุชุญูู ูู ุงูุชูุงุฒู
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="8%">ุงูุชุงุฑูุฎ</th>
                                <th width="10%">ููุน ุงูุนูููุฉ</th>
                                <th width="20%">ุงููุตู</th>
                                <th width="15%">ุงูุญุณุงุจ ุงููุฏูู</th>
                                <th width="15%">ุงูุญุณุงุจ ุงูุฏุงุฆู</th>
                                <th width="10%">ุงููุจูุบ ุงููุฏูู</th>
                                <th width="10%">ุงููุจูุบ ุงูุฏุงุฆู</th>
                                <th width="7%">ุงูุนููุฉ</th>
                                <th width="5%">ุงููุฑุฌุน</th>
                            </tr>
                        </thead>
                        <tbody id="journalTableBody">
                            ${getJournalEntriesRows()}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="5">ุงูุฅุฌูุงูู</th>
                                <th id="totalDebit">0.00</th>
                                <th id="totalCredit">0.00</th>
                                <th id="currencyMix">ูุชุนุฏุฏ</th>
                                <th id="balanceStatus">
                                    <span class="badge bg-success">ูุชูุงุฒู</span>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- ุฅุญุตุงุฆูุงุช ููุตูุฉ -->
                <div class="row mt-3" id="detailedStats">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ุฅุฌูุงูู ุงููููุฏ:</strong> <span id="totalEntries">0</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงูุนููุงุช ุงููุณุชุฎุฏูุฉ:</strong> <span id="usedCurrencies">0</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงููุชุฑุฉ:</strong> <span id="periodRange">ุบูุฑ ูุญุฏุฏ</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุญุงูุฉ ุงูุชูุงุฒู:</strong> <span id="balanceStatusText">ูุชูุงุฒู</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ูุดู ุญุณุงุจ ุงูุนููู
 */
function getCustomerStatementHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-user-check me-2"></i>
                        ูุดู ุญุณุงุจ ุงูุนููู
                    </h1>
                    <div class="btn-group">

                        <button class="btn btn-outline-success" onclick="exportStatement('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-primary" onclick="printStatement()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุงุฎุชูุงุฑ ุงูุนููู ูุงููุชุฑุฉ -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="statementCustomer" class="form-label">ุงูุนููู <span class="text-danger">*</span></label>
                        <select class="form-select" id="statementCustomer" onchange="loadCustomerStatement()">
                            <option value="">ุงุฎุชุฑ ุงูุนููู</option>
                            ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statementFromDate" class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="statementFromDate" onchange="loadCustomerStatement()">
                    </div>
                    <div class="col-md-3">
                        <label for="statementToDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="statementToDate" onchange="loadCustomerStatement()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="loadCustomerStatement()">
                                <i class="fas fa-search me-2"></i>
                                ุนุฑุถ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ูุนูููุงุช ุงูุนููู -->
        <div id="customerInfo" style="display: none;">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 id="customerName"></h5>
                            <p class="mb-1" id="customerAddress"></p>
                            <p class="mb-1" id="customerPhone"></p>
                            <p class="mb-0" id="customerEmail"></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="row">
                                <div class="col-6">
                                    <div class="border p-3 rounded">
                                        <h6 class="text-muted mb-1">ุงูุฑุตูุฏ ุงูุณุงุจู</h6>
                                        <h4 id="previousBalance" class="mb-0">0.00 ู.ุณ</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border p-3 rounded">
                                        <h6 class="text-muted mb-1">ุงูุฑุตูุฏ ุงูุญุงูู</h6>
                                        <h4 id="currentBalance" class="mb-0">0.00 ู.ุณ</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุฌุฏูู ูุดู ุงูุญุณุงุจ -->
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ุชูุงุตูู ุงูุญุณุงุจ</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="printStatement()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportStatement('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูุจูุงู</th>
                                    <th>ุฑูู ุงููุฑุฌุน</th>
                                    <th>ูุฏูู</th>
                                    <th>ุฏุงุฆู</th>
                                    <th>ุงูุฑุตูุฏ</th>
                                </tr>
                            </thead>
                            <tbody id="statementTable">
                                <!-- ุณูุชู ุชุญููู ุงูุจูุงูุงุช ููุง -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุนุฏู ุงุฎุชูุงุฑ ุนููู -->
        <div id="noCustomerSelected" class="text-center py-5">
            <i class="fas fa-user-check fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">ุงุฎุชุฑ ุนูููุงู ูุนุฑุถ ูุดู ุงูุญุณุงุจ</h5>
            <p class="text-muted">ููููู ุฃูุถุงู ุชุญุฏูุฏ ูุชุฑุฉ ุฒูููุฉ ูุนููุฉ</p>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function getSalesReportHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-chart-line me-2"></i>
                        ุชูุฑูุฑ ุงููุจูุนุงุช
                    </h1>
                    <div class="btn-group">

                        <button class="btn btn-outline-success" onclick="exportSalesReport('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="exportSalesReport('print')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุชูุฑูุฑ ุงููุญุณูุฉ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุชูุฑูุฑ - ูุชุนุฏุฏ ุงูุนููุงุช
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label for="salesReportFromDate" class="form-label">ูู ุชุงุฑูุฎ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="salesReportFromDate" required>
                    </div>
                    <div class="col-md-2">
                        <label for="salesReportToDate" class="form-label">ุฅูู ุชุงุฑูุฎ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="salesReportToDate" required>
                    </div>
                    <div class="col-md-2">
                        <label for="salesReportCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                        <select class="form-select" id="salesReportCurrency" onchange="updateSalesReportCurrency()" required>
                            <option value="">ุงุฎุชุฑ ุงูุนููุฉ</option>
                            <option value="ALL">ุฌููุน ุงูุนููุงุช</option>
                            ${getAvailableCurrencies().map(currency =>
                                `<option value="${currency}">${getCurrencyName(currency)} (${getCurrencySymbol(currency)})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="salesReportCustomer" class="form-label">ุงูุนููู</label>
                        <select class="form-select" id="salesReportCustomer">
                            <option value="">ุฌููุน ุงูุนููุงุก</option>
                            ${appData.customers ? appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('') : ''}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="salesReportProduct" class="form-label">ุงูุตูู</label>
                        <select class="form-select" id="salesReportProduct">
                            <option value="">ุฌููุน ุงูุฃุตูุงู</option>
                            ${appData.products ? appData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('') : ''}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="salesReportStatus" class="form-label">ุงูุญุงูุฉ</label>
                        <select class="form-select" id="salesReportStatus">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="paid">ูุฏููุนุฉ</option>
                            <option value="partial">ูุฏููุนุฉ ุฌุฒุฆูุงู</option>
                            <option value="pending">ูุนููุฉ</option>
                        </select>
                    </div>
                </div>

                <!-- ุฎูุงุฑุงุช ุชุญููู ุงูุนููุฉ -->
                <div class="row mt-3" id="currencyConversionOptions" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <label for="convertToCurrency" class="form-label mb-0">ุชุญููู ุฌููุน ุงููุจุงูุบ ุฅูู:</label>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="convertToCurrency" onchange="updateConversionRate()">
                                        <option value="">ุจุฏูู ุชุญููู</option>
                                        ${getAvailableCurrencies().map(currency =>
                                            `<option value="${currency}">${getCurrencyName(currency)} (${getCurrencySymbol(currency)})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="conversionRate" placeholder="ุณุนุฑ ุงูุตุฑู" step="0.0001" readonly>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateExchangeRates()">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        ุชุญุฏูุซ ุงูุฃุณุนุงุฑ
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">ุณูุชู ุชุญููู ุฌููุน ุงููุจุงูุบ ููุนููุฉ ุงููุญุฏุฏุฉ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="generateAdvancedSalesReport()">
                            <i class="fas fa-chart-bar me-2"></i>
                            ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุชูุฏู
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSalesReportFilters()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-info" onclick="previewSalesReport()">
                            <i class="fas fa-eye me-2"></i>
                            ูุนุงููุฉ
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm" onclick="exportSalesReport('excel')">
                                <i class="fas fa-file-excel me-1"></i>
                                Excel
                            </button>

                            <button class="btn btn-outline-primary btn-sm" onclick="printSalesReport()">
                                <i class="fas fa-print me-1"></i>
                                ุทุจุงุนุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุชูุฑูุฑ ุงููุญุณู -->
        <div id="salesReportSummary" style="display: none;">
            <!-- ููุฎุต ุงูุนููุงุช -->
            <div class="row mb-4" id="salesCurrencySummary">
                <!-- ุณูุชู ุชุญููู ููุฎุต ุงูุนููุงุช ููุง -->
            </div>

            <!-- ุงูุฅุญุตุงุฆูุงุช ุงูุฑุฆูุณูุฉ -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ุฅุฌูุงูู ุงููุจูุนุงุช</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="totalSalesAmount">0.00</div>
                                    <small class="text-muted" id="totalSalesCurrency">ูุชุนุฏุฏ ุงูุนููุงุช</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุนุฏุฏ ุงูููุงุชูุฑ</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="totalInvoicesCount">0</div>
                                    <small class="text-muted" id="invoicesDateRange">-</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ูุชูุณุท ุงููุงุชูุฑุฉ</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="averageInvoiceAmount">0.00</div>
                                    <small class="text-muted" id="averageCurrency">-</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calculator fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุงููุจูุบ ุงููุนูู</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="pendingSalesAmount">0.00</div>
                                    <small class="text-muted" id="pendingCurrency">-</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">ุงููุฏููุน</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="paidSalesAmount">0.00</div>
                                    <small class="text-muted" id="paidCurrency">-</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-left-secondary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">ุงูุนููุงุช</div>
                                    <div class="h6 mb-0 font-weight-bold text-gray-800" id="currenciesCount">0</div>
                                    <small class="text-muted">ุนููุฉ ูุดุทุฉ</small>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-coins fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุฌุฏูู ุชูุงุตูู ุงููุจูุนุงุช ุงููุญุณู -->
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ุชูุงุตูู ุงููุจูุนุงุช</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleSalesReportView('summary')">
                            <i class="fas fa-chart-pie me-1"></i>
                            ููุฎุต
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="toggleSalesReportView('detailed')">
                            <i class="fas fa-list me-1"></i>
                            ุชูุตููู
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="groupSalesReportBy('currency')">
                            <i class="fas fa-coins me-1"></i>
                            ุชุฌููุน ุจุงูุนููุฉ
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="10%">ุฑูู ุงููุงุชูุฑุฉ</th>
                                    <th width="10%">ุงูุชุงุฑูุฎ</th>
                                    <th width="15%">ุงูุนููู</th>
                                    <th width="12%">ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                                    <th width="8%">ุงูุนููุฉ</th>
                                    <th width="12%">ุงููุฏููุน</th>
                                    <th width="12%">ุงููุชุจูู</th>
                                    <th width="8%">ุงูุญุงูุฉ</th>
                                    <th width="13%">ุงููุจูุบ ุงููุญูู</th>
                                </tr>
                            </thead>
                            <tbody id="salesReportTable">
                                <!-- ุณูุชู ุชุญููู ุงูุจูุงูุงุช ููุง -->
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="3">ุงูุฅุฌูุงูู</th>
                                    <th id="salesTableTotalAmount">0.00</th>
                                    <th id="salesTableCurrencyMix">ูุชุนุฏุฏ</th>
                                    <th id="salesTableTotalPaid">0.00</th>
                                    <th id="salesTableTotalRemaining">0.00</th>
                                    <th id="salesTableStatusSummary">-</th>
                                    <th id="salesTableConvertedTotal">0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">ูุนูููุงุช ุงูุชูุฑูุฑ</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small><strong>ุงููุชุฑุฉ:</strong> <span id="reportPeriod">-</span></small><br>
                                        <small><strong>ุงูุนููุฉ ุงููุญุฏุฏุฉ:</strong> <span id="selectedCurrency">-</span></small>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>ุนุฏุฏ ุงูููุงุชูุฑ:</strong> <span id="reportInvoicesCount">0</span></small><br>
                                        <small><strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> <span id="reportLastUpdate">-</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning" id="conversionInfo" style="display: none;">
                                <h6 class="alert-heading">ูุนูููุงุช ุงูุชุญููู</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small><strong>ุงูุนููุฉ ุงููุณุชูุฏูุฉ:</strong> <span id="targetCurrencyInfo">-</span></small><br>
                                        <small><strong>ุณุนุฑ ุงูุตุฑู:</strong> <span id="exchangeRateInfo">-</span></small>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>ุชุงุฑูุฎ ุงูุณุนุฑ:</strong> <span id="rateDate">-</span></small><br>
                                        <small class="text-muted">ุงููุจุงูุบ ุงููุญููุฉ ุชูุฑูุจูุฉ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช -->
        <div id="noSalesData" class="text-center py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">ุญุฏุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ ูุฅูุดุงุก ุชูุฑูุฑ ุงููุจูุนุงุช</h5>
            <p class="text-muted">ููููู ุฃูุถุงู ุชุตููุฉ ุงููุชุงุฆุฌ ุญุณุจ ุงูุนููู ุฃู ุงูุตูู</p>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุชูุฑูุฑ ุงููุดุชุฑูุงุช
 */
function getPurchaseReportHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-shopping-cart me-2"></i>
                        ุชูุฑูุฑ ุงููุดุชุฑูุงุช
                    </h1>
                    <div class="btn-group">

                        <button class="btn btn-outline-success" onclick="exportPurchaseReport('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="exportPurchaseReport('print')">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุชูุฑูุฑ ุงููุญุณูุฉ -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุชูุฑูุฑ - ูุชุนุฏุฏ ุงูุนููุงุช
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label for="purchaseReportFromDate" class="form-label">ูู ุชุงุฑูุฎ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="purchaseReportFromDate" required>
                    </div>
                    <div class="col-md-2">
                        <label for="purchaseReportToDate" class="form-label">ุฅูู ุชุงุฑูุฎ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="purchaseReportToDate" required>
                    </div>
                    <div class="col-md-2">
                        <label for="purchaseReportCurrency" class="form-label">ุงูุนููุฉ <span class="text-danger">*</span></label>
                        <select class="form-select" id="purchaseReportCurrency" onchange="updatePurchaseReportCurrency()" required>
                            <option value="">ุงุฎุชุฑ ุงูุนููุฉ</option>
                            <option value="ALL">ุฌููุน ุงูุนููุงุช</option>
                            ${getAvailableCurrencies().map(currency =>
                                `<option value="${currency}">${getCurrencyName(currency)} (${getCurrencySymbol(currency)})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="purchaseReportSupplier" class="form-label">ุงูููุฑุฏ</label>
                        <select class="form-select" id="purchaseReportSupplier">
                            <option value="">ุฌููุน ุงูููุฑุฏูู</option>
                            ${appData.suppliers ? appData.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('') : ''}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="purchaseReportProduct" class="form-label">ุงูุตูู</label>
                        <select class="form-select" id="purchaseReportProduct">
                            <option value="">ุฌููุน ุงูุฃุตูุงู</option>
                            ${appData.products ? appData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('') : ''}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="purchaseReportStatus" class="form-label">ุงูุญุงูุฉ</label>
                        <select class="form-select" id="purchaseReportStatus">
                            <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                            <option value="paid">ูุฏููุนุฉ</option>
                            <option value="partial">ูุฏููุนุฉ ุฌุฒุฆูุงู</option>
                            <option value="pending">ูุนููุฉ</option>
                        </select>
                    </div>
                </div>

                <!-- ุฎูุงุฑุงุช ุชุญููู ุงูุนููุฉ -->
                <div class="row mt-3" id="purchaseCurrencyConversionOptions" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <label for="purchaseConvertToCurrency" class="form-label mb-0">ุชุญููู ุฌููุน ุงููุจุงูุบ ุฅูู:</label>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="purchaseConvertToCurrency" onchange="updatePurchaseConversionRate()">
                                        <option value="">ุจุฏูู ุชุญููู</option>
                                        ${getAvailableCurrencies().map(currency =>
                                            `<option value="${currency}">${getCurrencyName(currency)} (${getCurrencySymbol(currency)})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="purchaseConversionRate" placeholder="ุณุนุฑ ุงูุตุฑู" step="0.0001" readonly>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateExchangeRates()">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        ุชุญุฏูุซ ุงูุฃุณุนุงุฑ
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">ุณูุชู ุชุญููู ุฌููุน ุงููุจุงูุบ ููุนููุฉ ุงููุญุฏุฏุฉ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="generateAdvancedPurchaseReport()">
                            <i class="fas fa-chart-bar me-2"></i>
                            ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุชูุฏู
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearPurchaseReportFilters()">
                            <i class="fas fa-times me-2"></i>
                            ูุณุญ ุงูููุงุชุฑ
                        </button>
                        <button class="btn btn-outline-info" onclick="previewPurchaseReport()">
                            <i class="fas fa-eye me-2"></i>
                            ูุนุงููุฉ
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm" onclick="exportPurchaseReport('excel')">
                                <i class="fas fa-file-excel me-1"></i>
                                Excel
                            </button>

                            <button class="btn btn-outline-primary btn-sm" onclick="printPurchaseReport()">
                                <i class="fas fa-print me-1"></i>
                                ุทุจุงุนุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุชูุฑูุฑ -->
        <div id="purchaseReportSummary" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-right-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">ุฅุฌูุงูู ุงููุดุชุฑูุงุช</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPurchaseAmount">0.00 ู.ุณ</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-right-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ุนุฏุฏ ุงูููุงุชูุฑ</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPurchaseInvoicesCount">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-right-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ูุชูุณุท ุงููุงุชูุฑุฉ</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="averagePurchaseAmount">0.00 ู.ุณ</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calculator fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-right-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col me-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุงููุจูุบ ุงููุนูู</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingPurchaseAmount">0.00 ู.ุณ</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุฌุฏูู ุชูุงุตูู ุงููุดุชุฑูุงุช -->
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">ุชูุงุตูู ุงููุดุชุฑูุงุช</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ุฑูู ุงููุงุชูุฑุฉ</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูููุฑุฏ</th>
                                    <th>ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                                    <th>ุงููุฏููุน</th>
                                    <th>ุงููุชุจูู</th>
                                    <th>ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseReportTable">
                                <!-- ุณูุชู ุชุญููู ุงูุจูุงูุงุช ููุง -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช -->
        <div id="noPurchaseData" class="text-center py-5">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">ุญุฏุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ ูุฅูุดุงุก ุชูุฑูุฑ ุงููุดุชุฑูุงุช</h5>
            <p class="text-muted">ููููู ุฃูุถุงู ุชุตููุฉ ุงููุชุงุฆุฌ ุญุณุจ ุงูููุฑุฏ ุฃู ุงูุตูู</p>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ
 */
function getCurrencyBalancesHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-coins me-2"></i>
                        ุงูุฃุฑุตุฏุฉ ุงูุฅุฌูุงููุฉ ููุนููุงุช
                    </h1>
                    <div class="btn-group">

                        <button class="btn btn-outline-success" onclick="exportCurrencyBalances('excel')">
                            <i class="fas fa-file-excel me-2"></i>
                            ุชุตุฏูุฑ Excel
                        </button>
                        <button class="btn btn-outline-info" onclick="printCurrencyBalances()">
                            <i class="fas fa-print me-2"></i>
                            ุทุจุงุนุฉ
                        </button>
                        <button class="btn btn-primary" onclick="refreshCurrencyBalances()">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุฃุฑุตุฏุฉ -->
        <div class="row mb-4" id="currencyBalancesSummary">
            <!-- ุณูุชู ุชุญููู ุงูุจูุงูุงุช ููุง -->
        </div>

        <!-- ุฌุฏูู ุชูุงุตูู ุงูุฃุฑุตุฏุฉ -->
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ุชูุงุตูู ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ</h5>
                <small class="text-muted">ุขุฎุฑ ุชุญุฏูุซ: <span id="lastUpdateTime">ุฌุงุฑู ุงูุชุญููู...</span></small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ุงูุนููุฉ</th>
                                <th>ุงูุฑูุฒ</th>
                                <th>ุฅุฏุฎุงูุงุช ุงูุนููุงุก</th>
                                <th>ุฅุฎุฑุงุฌุงุช ุงูุนููุงุก</th>
                                <th>ุฅุฏุฎุงูุงุช ุงูููุฑุฏูู</th>
                                <th>ุฅุฎุฑุงุฌุงุช ุงูููุฑุฏูู</th>
                                <th>ุตุงูู ุงูุฑุตูุฏ</th>
                                <th>ุงูุญุงูุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="currencyBalancesTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                                    </div>
                                    <div class="mt-2">ุฌุงุฑู ุชุญููู ุงูุฃุฑุตุฏุฉ...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ููุงุญุธุงุช ูููุฉ</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-info-circle text-info me-2"></i>ุงูุฃุฑุตุฏุฉ ูุญุณูุจุฉ ุจูุงุกู ุนูู ุงูููุงุชูุฑ ูุงูุฏูุนุงุช ุงููุคูุฏุฉ</li>
                            <li><i class="fas fa-clock text-warning me-2"></i>ูุชู ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุชููุงุฆูุงู ูุน ูู ุนูููุฉ</li>
                            <li><i class="fas fa-shield-alt text-success me-2"></i>ุฌููุน ุงููุจุงูุบ ูุนุฑูุถุฉ ุจุงูุนููุฉ ุงูุฃุตููุฉ</li>
                            <li><i class="fas fa-sync-alt text-primary me-2"></i>ุงุณุชุฎุฏู ุฒุฑ "ุชุญุฏูุซ" ูุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-primary mb-1" id="totalCurrencies">0</h4>
                                    <small class="text-muted">ุนููุงุช ูุดุทุฉ</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-success mb-1" id="positiveCurrencies">0</h4>
                                    <small class="text-muted">ุฃุฑุตุฏุฉ ููุฌุจุฉ</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <h4 class="text-danger mb-1" id="negativeCurrencies">0</h4>
                                <small class="text-muted">ุฃุฑุตุฏุฉ ุณุงูุจุฉ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
 */
function getUsersHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-users me-2"></i>
                        ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-user-plus me-2"></i>
                            ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
                        </button>
                        <button class="btn btn-outline-info" onclick="refreshUsers()">
                            <i class="fas fa-sync-alt me-2"></i>
                            ุชุญุฏูุซ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">${appData.users ? appData.users.length : 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุงููุณุชุฎุฏููู ุงููุดุทูู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeUsers">${appData.users ? appData.users.filter(u => u.isActive).length : 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-check fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ุงููุฏูุฑูู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="adminUsers">${appData.users ? appData.users.filter(u => u.role === 'admin').length : 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุงููุณุชุฎุฏููู ุงูุนุงุฏููู</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="regularUsers">${appData.users ? appData.users.filter(u => u.role === 'user').length : 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงููุณุชุฎุฏููู -->
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ูุงุฆูุฉ ุงููุณุชุฎุฏููู</h5>
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="userSearch" placeholder="ุงูุจุญุซ ุนู ูุณุชุฎุฏู..." onkeyup="filterUsers()">
                    <button class="btn btn-outline-secondary" onclick="clearUserSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ุงุณู ุงููุณุชุฎุฏู</th>
                                <th>ุงูุงุณู ุงููุงูู</th>
                                <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                <th>ุงูุฏูุฑ</th>
                                <th>ุงูุญุงูุฉ</th>
                                <th>ุขุฎุฑ ุชุณุฌูู ุฏุฎูู</th>
                                <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            ${getUsersTableRows()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุงูุญุตูู ุนูู ุตููู ุฌุฏูู ุงููุณุชุฎุฏููู
 */
function getUsersTableRows() {
    if (!appData.users || appData.users.length === 0) {
        return '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-users fa-3x mb-3"></i><h5>ูุง ููุฌุฏ ูุณุชุฎุฏููู</h5></td></tr>';
    }

    return appData.users.map(user => {
        const roleText = user.role === 'admin' ? 'ูุฏูุฑ' : 'ูุณุชุฎุฏู ุนุงุฏู';
        const roleBadge = user.role === 'admin' ? 'bg-danger' : 'bg-primary';
        const statusBadge = user.isActive ? 'bg-success' : 'bg-secondary';
        const statusText = user.isActive ? 'ูุดุท' : 'ูุนุทู';
        const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : 'ูู ูุณุฌู ุฏุฎูู';

        return `
            <tr>
                <td>
                    <strong>${user.username}</strong>
                    ${user.role === 'admin' ? '<i class="fas fa-crown text-warning ms-1" title="ูุฏูุฑ"></i>' : ''}
                </td>
                <td>${user.fullName}</td>
                <td>${user.email || '-'}</td>
                <td><span class="badge ${roleBadge}">${roleText}</span></td>
                <td><span class="badge ${statusBadge}">${statusText}</span></td>
                <td>${lastLogin}</td>
                <td>${formatDate(user.createdAt)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="ุชุนุฏูู">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewUserPermissions(${user.id})" title="ุงูุตูุงุญูุงุช">
                            <i class="fas fa-key"></i>
                        </button>
                        ${user.id !== 1 ? `
                            <button class="btn btn-outline-${user.isActive ? 'warning' : 'success'}" onclick="toggleUserStatus(${user.id})" title="${user.isActive ? 'ุชุนุทูู' : 'ุชูุนูู'}">
                                <i class="fas fa-${user.isActive ? 'user-slash' : 'user-check'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="ุญุฐู">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู
 */
function updateUserStats() {
    if (!appData.users) return;

    const totalUsers = appData.users.length;
    const activeUsers = appData.users.filter(u => u.isActive).length;
    const adminUsers = appData.users.filter(u => u.role === 'admin').length;
    const regularUsers = appData.users.filter(u => u.role === 'user').length;

    const totalElement = document.getElementById('totalUsers');
    const activeElement = document.getElementById('activeUsers');
    const adminElement = document.getElementById('adminUsers');
    const regularElement = document.getElementById('regularUsers');

    if (totalElement) totalElement.textContent = totalUsers;
    if (activeElement) activeElement.textContent = activeUsers;
    if (adminElement) adminElement.textContent = adminUsers;
    if (regularElement) regularElement.textContent = regularUsers;
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุงููุณุชุฎุฏููู
 */
function refreshUsers() {
    const tableBody = document.getElementById('usersTable');
    if (tableBody) {
        tableBody.innerHTML = getUsersTableRows();
    }
    updateUserStats();
}

/**
 * ุชุตููุฉ ุงููุณุชุฎุฏููู
 */
function filterUsers() {
    const searchText = document.getElementById('userSearch').value.toLowerCase();
    const tableBody = document.getElementById('usersTable');

    if (!searchText) {
        tableBody.innerHTML = getUsersTableRows();
        return;
    }

    const filteredUsers = appData.users.filter(user =>
        user.username.toLowerCase().includes(searchText) ||
        user.fullName.toLowerCase().includes(searchText) ||
        (user.email && user.email.toLowerCase().includes(searchText))
    );

    if (filteredUsers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-search fa-3x mb-3"></i><h5>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</h5></td></tr>';
    } else {
        tableBody.innerHTML = filteredUsers.map(user => {
            const roleText = user.role === 'admin' ? 'ูุฏูุฑ' : 'ูุณุชุฎุฏู ุนุงุฏู';
            const roleBadge = user.role === 'admin' ? 'bg-danger' : 'bg-primary';
            const statusBadge = user.isActive ? 'bg-success' : 'bg-secondary';
            const statusText = user.isActive ? 'ูุดุท' : 'ูุนุทู';
            const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : 'ูู ูุณุฌู ุฏุฎูู';

            return `
                <tr>
                    <td>
                        <strong>${user.username}</strong>
                        ${user.role === 'admin' ? '<i class="fas fa-crown text-warning ms-1" title="ูุฏูุฑ"></i>' : ''}
                    </td>
                    <td>${user.fullName}</td>
                    <td>${user.email || '-'}</td>
                    <td><span class="badge ${roleBadge}">${roleText}</span></td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td>${lastLogin}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="ุชุนุฏูู">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="viewUserPermissions(${user.id})" title="ุงูุตูุงุญูุงุช">
                                <i class="fas fa-key"></i>
                            </button>
                            ${user.id !== 1 ? `
                                <button class="btn btn-outline-${user.isActive ? 'warning' : 'success'}" onclick="toggleUserStatus(${user.id})" title="${user.isActive ? 'ุชุนุทูู' : 'ุชูุนูู'}">
                                    <i class="fas fa-${user.isActive ? 'user-slash' : 'user-check'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="ุญุฐู">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
}

/**
 * ูุณุญ ุงูุจุญุซ
 */
function clearUserSearch() {
    document.getElementById('userSearch').value = '';
    refreshUsers();
}

/**
 * ุฅุธูุงุฑ ูุงูุฐุฉ ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
 */
function showAddUserModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addUserModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงุณู ุงููุณุชุฎุฏู <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newUsername" required>
                                    <small class="form-text text-muted">ูุฌุจ ุฃู ูููู ูุฑูุฏุงู ููุง ูุญุชูู ุนูู ูุณุงูุงุช</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ูููุฉ ุงููุฑูุฑ <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                    <small class="form-text text-muted">ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุงุณู ุงููุงูู <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newFullName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                    <input type="email" class="form-control" id="newEmail">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฏูุฑ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="newRole" required onchange="togglePermissionsSection()">
                                        <option value="">ุงุฎุชุฑ ุงูุฏูุฑ</option>
                                        <option value="admin">ูุฏูุฑ</option>
                                        <option value="user">ูุณุชุฎุฏู ุนุงุฏู</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุญุงูุฉ</label>
                                    <select class="form-select" id="newStatus">
                                        <option value="true">ูุดุท</option>
                                        <option value="false">ูุนุทู</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ูุณู ุงูุตูุงุญูุงุช -->
                        <div id="permissionsSection" style="display: none;">
                            <hr>
                            <h6>ุงูุตูุงุญูุงุช</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_dashboard" checked>
                                        <label class="form-check-label" for="perm_dashboard">ููุญุฉ ุงูุชุญูู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_customers">
                                        <label class="form-check-label" for="perm_customers">ุงูุนููุงุก</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_suppliers">
                                        <label class="form-check-label" for="perm_suppliers">ุงูููุฑุฏูู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_products">
                                        <label class="form-check-label" for="perm_products">ุงูุฃุตูุงู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_warehouses">
                                        <label class="form-check-label" for="perm_warehouses">ุงููุฎุงุฒู</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_salesInvoices">
                                        <label class="form-check-label" for="perm_salesInvoices">ููุงุชูุฑ ุงููุจูุนุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_purchaseInvoices">
                                        <label class="form-check-label" for="perm_purchaseInvoices">ููุงุชูุฑ ุงููุดุชุฑูุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_receipts">
                                        <label class="form-check-label" for="perm_receipts">ุณูุฏุงุช ุงููุจุถ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_payments">
                                        <label class="form-check-label" for="perm_payments">ุณูุฏุงุช ุงูุฏูุน</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_inventory">
                                        <label class="form-check-label" for="perm_inventory">ุงููุฎุฒูู</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_reports">
                                        <label class="form-check-label" for="perm_reports">ุงูุชูุงุฑูุฑ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_journal">
                                        <label class="form-check-label" for="perm_journal">ุฏูุชุฑ ุงูููููุฉ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_settings">
                                        <label class="form-check-label" for="perm_settings">ุงูุฅุนุฏุงุฏุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_backup">
                                        <label class="form-check-label" for="perm_backup">ุงููุณุฎ ุงูุงุญุชูุงุทู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="perm_users">
                                        <label class="form-check-label" for="perm_users">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewUser()">ุญูุธ ุงููุณุชุฎุฏู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชุจุฏูู ุนุฑุถ ูุณู ุงูุตูุงุญูุงุช
 */
function togglePermissionsSection() {
    const role = document.getElementById('newRole').value;
    const permissionsSection = document.getElementById('permissionsSection');

    if (role === 'user') {
        permissionsSection.style.display = 'block';
    } else {
        permissionsSection.style.display = 'none';
    }
}

/**
 * ุชุจุฏูู ุนุฑุถ ูุณู ุงูุตูุงุญูุงุช ูู ุชุนุฏูู ุงููุณุชุฎุฏู
 */
function toggleEditPermissionsSection() {
    const role = document.getElementById('editRole').value;
    const permissionsSection = document.getElementById('editPermissionsSection');

    if (role === 'user') {
        permissionsSection.style.display = 'block';
    } else {
        permissionsSection.style.display = 'none';
    }
}

/**
 * ุญูุธ ุชุนุฏููุงุช ุงููุณุชุฎุฏู
 */
function saveEditedUser(userId) {
    console.log('๐ค ุญูุธ ุชุนุฏููุงุช ุงููุณุชุฎุฏู...', userId);

    try {
        // ุฌูุน ุงูุจูุงูุงุช
        const username = document.getElementById('editUsername').value.trim();
        const password = document.getElementById('editPassword').value;
        const fullName = document.getElementById('editFullName').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const role = document.getElementById('editRole').value;
        const isActive = document.getElementById('editStatus').value === 'true';

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (!username || !fullName || !role) {
            alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
            return;
        }

        if (password && password.length < 6) {
            alert('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู');
            return;
        }

        // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงุณู ุงููุณุชุฎุฏู (ุฅุฐุง ุชู ุชุบููุฑู)
        const existingUser = appData.users.find(u => u.username === username && u.id !== userId);
        if (existingUser) {
            alert('ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ูุณุจูุงู');
            return;
        }

        // ุงูุนุซูุฑ ุนูู ุงููุณุชุฎุฏู
        const user = appData.users.find(u => u.id === userId);
        if (!user) {
            alert('ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุฌูุน ุงูุตูุงุญูุงุช
        let permissions = {};
        if (role === 'admin') {
            // ุงููุฏูุฑ ูู ุฌููุน ุงูุตูุงุญูุงุช
            permissions = {
                dashboard: true,
                customers: true,
                suppliers: true,
                products: true,
                warehouses: true,
                salesInvoices: true,
                purchaseInvoices: true,
                receipts: true,
                payments: true,
                inventory: true,
                reports: true,
                journal: true,
                settings: true,
                backup: true,
                users: true
            };
        } else {
            // ุฌูุน ุงูุตูุงุญูุงุช ุงููุญุฏุฏุฉ ูููุณุชุฎุฏู ุงูุนุงุฏู
            const permissionsList = [
                'dashboard', 'customers', 'suppliers', 'products', 'warehouses',
                'salesInvoices', 'purchaseInvoices', 'receipts', 'payments',
                'inventory', 'reports', 'journal', 'settings', 'backup', 'users'
            ];

            permissionsList.forEach(perm => {
                const checkbox = document.getElementById(`edit_perm_${perm}`);
                permissions[perm] = checkbox ? checkbox.checked : false;
            });
        }

        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
        user.username = username;
        if (password) {
            user.password = password; // ูู ุงูุชุทุจูู ุงูุญูููู ูุฌุจ ุชุดููุฑ ูููุฉ ุงููุฑูุฑ
        }
        user.fullName = fullName;
        user.email = email || null;
        user.role = role;
        user.permissions = permissions;
        user.isActive = isActive;
        user.updatedAt = new Date().toISOString().split('T')[0];

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
        modal.hide();

        // ุชุญุฏูุซ ุงูุฌุฏูู
        refreshUsers();

        alert(`ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู "${fullName}" ุจูุฌุงุญ!`);
        console.log('โ ุชู ุชุญุฏูุซ ุงููุณุชุฎุฏู:', user);

        // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุงูุญุงูู ูุนุฏู ููุณูุ ุชุญุฏูุซ ุจูุงูุงุช ุงูุฌูุณุฉ
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.id === userId) {
            localStorage.setItem('samProCurrentUser', JSON.stringify({
                id: user.id,
                username: user.username,
                fullName: user.fullName,
                role: user.role,
                permissions: user.permissions
            }));
            console.log('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฌูุณุฉ ุงูุญุงููุฉ');
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุณุชุฎุฏู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุณุชุฎุฏู');
    }
}

/**
 * ุญูุธ ูุณุชุฎุฏู ุฌุฏูุฏ
 */
function saveNewUser() {
    console.log('๐ค ุญูุธ ูุณุชุฎุฏู ุฌุฏูุฏ...');

    try {
        // ุฌูุน ุงูุจูุงูุงุช
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value;
        const fullName = document.getElementById('newFullName').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const role = document.getElementById('newRole').value;
        const isActive = document.getElementById('newStatus').value === 'true';

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        if (!username || !password || !fullName || !role) {
            alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
            return;
        }

        if (password.length < 6) {
            alert('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู');
            return;
        }

        // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงุณู ุงููุณุชุฎุฏู
        if (appData.users.some(u => u.username === username)) {
            alert('ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ูุณุจูุงู');
            return;
        }

        // ุฌูุน ุงูุตูุงุญูุงุช
        let permissions = {};
        if (role === 'admin') {
            // ุงููุฏูุฑ ูู ุฌููุน ุงูุตูุงุญูุงุช
            permissions = {
                dashboard: true,
                customers: true,
                suppliers: true,
                products: true,
                warehouses: true,
                salesInvoices: true,
                purchaseInvoices: true,
                receipts: true,
                payments: true,
                inventory: true,
                reports: true,
                journal: true,
                settings: true,
                backup: true,
                users: true
            };
        } else {
            // ุฌูุน ุงูุตูุงุญูุงุช ุงููุญุฏุฏุฉ ูููุณุชุฎุฏู ุงูุนุงุฏู
            const permissionsList = [
                'dashboard', 'customers', 'suppliers', 'products', 'warehouses',
                'salesInvoices', 'purchaseInvoices', 'receipts', 'payments',
                'inventory', 'reports', 'journal', 'settings', 'backup', 'users'
            ];

            permissionsList.forEach(perm => {
                const checkbox = document.getElementById(`perm_${perm}`);
                permissions[perm] = checkbox ? checkbox.checked : false;
            });
        }

        // ุฅูุดุงุก ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
        const newUser = {
            id: Date.now(),
            username,
            password, // ูู ุงูุชุทุจูู ุงูุญูููู ูุฌุจ ุชุดููุฑ ูููุฉ ุงููุฑูุฑ
            fullName,
            email: email || null,
            role,
            permissions,
            isActive,
            createdAt: new Date().toISOString().split('T')[0],
            lastLogin: null
        };

        // ุฅุถุงูุฉ ุงููุณุชุฎุฏู
        if (!appData.users) appData.users = [];
        appData.users.push(newUser);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฅุบูุงู ุงููุงูุฐุฉ
        const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
        modal.hide();

        // ุชุญุฏูุซ ุงูุฌุฏูู
        refreshUsers();

        alert(`ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู "${fullName}" ุจูุฌุงุญ!`);
        console.log('โ ุชู ุญูุธ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ:', newUser);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุณุชุฎุฏู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุณุชุฎุฏู');
    }
}

/**
 * ุชุนุฏูู ูุณุชุฎุฏู
 */
function editUser(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('users')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุงููุณุชุฎุฏููู');
        return;
    }

    const user = appData.users.find(u => u.id === id);
    if (!user) {
        alert('ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editUserModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุชุนุฏูู ุงููุณุชุฎุฏู: ${user.fullName}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงุณู ุงููุณุชุฎุฏู <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editUsername" value="${user.username}" required ${user.id === 1 ? 'readonly' : ''}>
                                    <small class="form-text text-muted">ูุฌุจ ุฃู ูููู ูุฑูุฏุงู ููุง ูุญุชูู ุนูู ูุณุงูุงุช</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
                                    <input type="password" class="form-control" id="editPassword" placeholder="ุงุชุฑูู ูุงุฑุบุงู ูุนุฏู ุงูุชุบููุฑ">
                                    <small class="form-text text-muted">ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุงุณู ุงููุงูู <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editFullName" value="${user.fullName}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                    <input type="email" class="form-control" id="editEmail" value="${user.email || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุฏูุฑ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editRole" required onchange="toggleEditPermissionsSection()" ${user.id === 1 ? 'disabled' : ''}>
                                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ูุฏูุฑ</option>
                                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>ูุณุชุฎุฏู ุนุงุฏู</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ุงูุญุงูุฉ</label>
                                    <select class="form-select" id="editStatus" ${user.id === 1 ? 'disabled' : ''}>
                                        <option value="true" ${user.isActive ? 'selected' : ''}>ูุดุท</option>
                                        <option value="false" ${!user.isActive ? 'selected' : ''}>ูุนุทู</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ูุณู ุงูุตูุงุญูุงุช -->
                        <div id="editPermissionsSection" style="display: ${user.role === 'user' ? 'block' : 'none'};">
                            <hr>
                            <h6>ุงูุตูุงุญูุงุช</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_dashboard" ${user.permissions?.dashboard ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_dashboard">ููุญุฉ ุงูุชุญูู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_customers" ${user.permissions?.customers ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_customers">ุงูุนููุงุก</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_suppliers" ${user.permissions?.suppliers ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_suppliers">ุงูููุฑุฏูู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_products" ${user.permissions?.products ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_products">ุงูุฃุตูุงู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_warehouses" ${user.permissions?.warehouses ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_warehouses">ุงููุฎุงุฒู</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_salesInvoices" ${user.permissions?.salesInvoices ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_salesInvoices">ููุงุชูุฑ ุงููุจูุนุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_purchaseInvoices" ${user.permissions?.purchaseInvoices ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_purchaseInvoices">ููุงุชูุฑ ุงููุดุชุฑูุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_receipts" ${user.permissions?.receipts ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_receipts">ุณูุฏุงุช ุงููุจุถ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_payments" ${user.permissions?.payments ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_payments">ุณูุฏุงุช ุงูุฏูุน</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_inventory" ${user.permissions?.inventory ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_inventory">ุงููุฎุฒูู</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_reports" ${user.permissions?.reports ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_reports">ุงูุชูุงุฑูุฑ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_journal" ${user.permissions?.journal ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_journal">ุฏูุชุฑ ุงูููููุฉ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_settings" ${user.permissions?.settings ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_settings">ุงูุฅุนุฏุงุฏุงุช</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_backup" ${user.permissions?.backup ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_backup">ุงููุณุฎ ุงูุงุญุชูุงุทู</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="edit_perm_users" ${user.permissions?.users ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit_perm_users">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedUser(${id})">ุญูุธ ุงูุชุนุฏููุงุช</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุนุฑุถ ุตูุงุญูุงุช ุงููุณุชุฎุฏู
 */
function viewUserPermissions(id) {
    const user = appData.users.find(u => u.id === id);
    if (!user) return;

    const permissionNames = {
        dashboard: 'ููุญุฉ ุงูุชุญูู',
        customers: 'ุงูุนููุงุก',
        suppliers: 'ุงูููุฑุฏูู',
        products: 'ุงูุฃุตูุงู',
        warehouses: 'ุงููุฎุงุฒู',
        salesInvoices: 'ููุงุชูุฑ ุงููุจูุนุงุช',
        purchaseInvoices: 'ููุงุชูุฑ ุงููุดุชุฑูุงุช',
        receipts: 'ุณูุฏุงุช ุงููุจุถ',
        payments: 'ุณูุฏุงุช ุงูุฏูุน',
        inventory: 'ุงููุฎุฒูู',
        reports: 'ุงูุชูุงุฑูุฑ',
        journal: 'ุฏูุชุฑ ุงูููููุฉ',
        settings: 'ุงูุฅุนุฏุงุฏุงุช',
        backup: 'ุงููุณุฎ ุงูุงุญุชูุงุทู',
        users: 'ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู'
    };

    const permissionsList = Object.entries(user.permissions || {})
        .map(([key, value]) => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${permissionNames[key] || key}
                <span class="badge bg-${value ? 'success' : 'danger'}">${value ? 'ูุณููุญ' : 'ููููุน'}</span>
            </li>
        `).join('');

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'userPermissionsModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุตูุงุญูุงุช ุงููุณุชุฎุฏู: ${user.fullName}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>ุงุณู ุงููุณุชุฎุฏู:</strong> ${user.username}<br>
                        <strong>ุงูุฏูุฑ:</strong> <span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'}">${user.role === 'admin' ? 'ูุฏูุฑ' : 'ูุณุชุฎุฏู ุนุงุฏู'}</span><br>
                        <strong>ุงูุญุงูุฉ:</strong> <span class="badge bg-${user.isActive ? 'success' : 'secondary'}">${user.isActive ? 'ูุดุท' : 'ูุนุทู'}</span>
                    </div>
                    <h6>ุงูุตูุงุญูุงุช:</h6>
                    <ul class="list-group">
                        ${permissionsList}
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชุจุฏูู ุญุงูุฉ ุงููุณุชุฎุฏู
 */
function toggleUserStatus(id) {
    const user = appData.users.find(u => u.id === id);
    if (!user || user.id === 1) return; // ูุง ูููู ุชุนุทูู ุงููุฏูุฑ ุงูุฑุฆูุณู

    const newStatus = !user.isActive;
    const action = newStatus ? 'ุชูุนูู' : 'ุชุนุทูู';

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ${action} ุงููุณุชุฎุฏู "${user.fullName}"ุ`)) {
        user.isActive = newStatus;
        saveData();
        refreshUsers();
        alert(`ุชู ${action} ุงููุณุชุฎุฏู ุจูุฌุงุญ`);
    }
}

/**
 * ุญุฐู ูุณุชุฎุฏู
 */
function deleteUser(id) {
    const user = appData.users.find(u => u.id === id);
    if (!user || user.id === 1) return; // ูุง ูููู ุญุฐู ุงููุฏูุฑ ุงูุฑุฆูุณู

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุณุชุฎุฏู "${user.fullName}"ุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.`)) {
        appData.users = appData.users.filter(u => u.id !== id);
        saveData();
        refreshUsers();
        alert('ุชู ุญุฐู ุงููุณุชุฎุฏู ุจูุฌุงุญ');
    }
}

/**
 * ุญุฐู ูุงุชูุฑุฉ
 */
function deleteInvoice(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('salesInvoices') && !hasPermission('purchaseInvoices')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูููุงุชูุฑ');
        return;
    }

    const invoice = appData.invoices.find(inv => inv.id === id);
    if (!invoice) {
        alert('ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ');
        return;
    }

    const invoiceTypeText = invoice.invoiceType === 'sale' ? 'ุงููุจูุนุงุช' : 'ุงููุดุชุฑูุงุช';
    const clientName = getClientName(invoice);

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุงุชูุฑุฉ ${invoiceTypeText} ุฑูู ${invoice.invoiceNumber}ุ\n\nุงูุนููู/ุงูููุฑุฏ: ${clientName}\nุงููุจูุบ: ${formatCurrency(invoice.totalAmount)}\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุคุซุฑ ุนูู:\n- ุฃุฑุตุฏุฉ ุงูุนููุงุก/ุงูููุฑุฏูู\n- ุญุฑูุฉ ุงููุฎุฒูู\n- ุงููููุฏ ุงููุญุงุณุจูุฉ`)) {

        try {
            console.log('๐๏ธ ุจุฏุก ุญุฐู ุงููุงุชูุฑุฉ:', invoice.invoiceNumber);

            // ุนูุณ ุชุฃุซูุฑ ุงููุงุชูุฑุฉ ุนูู ุงููุฎุฒูู (ุฅุฐุง ูุงูุช ูุคูุฏุฉ)
            if (invoice.status === 'confirmed') {
                invoice.items.forEach(item => {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        // ุนูุณ ุญุฑูุฉ ุงููุฎุฒูู
                        if (invoice.invoiceType === 'sale') {
                            product.quantity += item.quantity; // ุฅุฑุฌุงุน ุงููููุฉ
                        } else {
                            product.quantity -= item.quantity; // ุทุฑุญ ุงููููุฉ
                        }
                        console.log(`๐ฆ ุชู ุชุนุฏูู ูุฎุฒูู ${product.name}: ${product.quantity}`);
                    }
                });

                // ุญุฐู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฑุชุจุทุฉ
                if (appData.journalEntries) {
                    const entriesCountBefore = appData.journalEntries.length;
                    appData.journalEntries = appData.journalEntries.filter(entry => entry.invoiceId !== id);
                    const entriesCountAfter = appData.journalEntries.length;
                    console.log(`๐ ุชู ุญุฐู ${entriesCountBefore - entriesCountAfter} ููุฏ ูุญุงุณุจู`);
                }

                // ุญุฐู ุญุฑูุงุช ุงููุฎุฒูู ุงููุฑุชุจุทุฉ
                if (appData.inventoryMovements) {
                    const movementsCountBefore = appData.inventoryMovements.length;
                    appData.inventoryMovements = appData.inventoryMovements.filter(movement =>
                        movement.reference !== invoice.invoiceNumber
                    );
                    const movementsCountAfter = appData.inventoryMovements.length;
                    console.log(`๐ฆ ุชู ุญุฐู ${movementsCountBefore - movementsCountAfter} ุญุฑูุฉ ูุฎุฒูู`);
                }
            }

            // ุนูุณ ุชุฃุซูุฑ ุงููุงุชูุฑุฉ ุนูู ุฃุฑุตุฏุฉ ุงูุนููุงุก/ุงูููุฑุฏูู
            const currency = invoice.currency || appData.settings.currency || 'SYP';
            if (invoice.invoiceType === 'sale' && invoice.customerId) {
                const customer = appData.customers.find(c => c.id === invoice.customerId);
                if (customer) {
                    // ุทุฑุญ ุงููุจูุบ ูู ุฅุฌูุงูู ุงููุจูุนุงุช
                    customer.totalSales = (customer.totalSales || 0) - invoice.totalAmount;
                    customer.transactionCount = Math.max(0, (customer.transactionCount || 1) - 1);

                    // ุชุนุฏูู ุงูุฑุตูุฏ
                    if (customer.balances && customer.balances[currency]) {
                        customer.balances[currency] -= invoice.totalAmount;
                    }
                    if (currency === (appData.settings.currency || 'SYP')) {
                        customer.currentBalance = (customer.currentBalance || 0) - invoice.totalAmount;
                    }
                    console.log(`๐ค ุชู ุชุนุฏูู ุฑุตูุฏ ุงูุนููู ${customer.name}`);
                }
            } else if (invoice.invoiceType === 'purchase' && invoice.supplierId) {
                const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
                if (supplier) {
                    // ุทุฑุญ ุงููุจูุบ ูู ุฅุฌูุงูู ุงููุดุชุฑูุงุช
                    supplier.totalPurchases = (supplier.totalPurchases || 0) - invoice.totalAmount;
                    supplier.transactionCount = Math.max(0, (supplier.transactionCount || 1) - 1);

                    // ุชุนุฏูู ุงูุฑุตูุฏ
                    if (supplier.balances && supplier.balances[currency]) {
                        supplier.balances[currency] -= invoice.totalAmount;
                    }
                    if (currency === (appData.settings.currency || 'SYP')) {
                        supplier.currentBalance = (supplier.currentBalance || 0) - invoice.totalAmount;
                    }
                    console.log(`๐ข ุชู ุชุนุฏูู ุฑุตูุฏ ุงูููุฑุฏ ${supplier.name}`);
                }
            }

            // ุญุฐู ุงููุงุชูุฑุฉ
            appData.invoices = appData.invoices.filter(inv => inv.id !== id);

            // ุญูุธ ุงูุจูุงูุงุช
            saveData();

            console.log('โ ุชู ุญุฐู ุงููุงุชูุฑุฉ ุจูุฌุงุญ');
            alert('ุชู ุญุฐู ุงููุงุชูุฑุฉ ุจูุฌุงุญ');

            // ุชุญุฏูุซ ุงูุตูุญุฉ ุงูุญุงููุฉ
            const currentPage = document.querySelector('.nav-link.active')?.getAttribute('onclick')?.match(/showPage\('([^']+)'\)/)?.[1];
            if (currentPage) {
                showPage(currentPage);
            }

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญุฐู ุงููุงุชูุฑุฉ:', error);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุงุชูุฑุฉ: ' + error.message);
        }
    }
}

/**
 * ุงูุญุตูู ุนูู ุงุณู ุงูุนููู/ุงูููุฑุฏ ูู ุงููุงุชูุฑุฉ
 */
function getClientName(invoice) {
    if (invoice.invoiceType === 'sale' && invoice.customerId) {
        const customer = appData.customers.find(c => c.id === invoice.customerId);
        return customer ? customer.name : 'ุนููู ูุญุฐูู';
    } else if (invoice.invoiceType === 'purchase' && invoice.supplierId) {
        const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
        return supplier ? supplier.name : 'ููุฑุฏ ูุญุฐูู';
    }
    return 'ุบูุฑ ูุญุฏุฏ';
}

/**
 * ุญุฐู ุณูุฏ ูุจุถ ุฃู ุฏูุน
 */
function deletePayment(id) {
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    if (!hasPermission('receipts') && !hasPermission('payments')) {
        alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูุณูุฏุงุช');
        return;
    }

    const payment = appData.payments.find(p => p.id === id);
    if (!payment) {
        alert('ุงูุณูุฏ ุบูุฑ ููุฌูุฏ');
        return;
    }

    const paymentTypeText = payment.type === 'receipt' ? 'ุงููุจุถ' : 'ุงูุฏูุน';
    const clientName = payment.type === 'receipt' ?
        (appData.customers.find(c => c.id === payment.customerId)?.name || 'ุนููู ูุญุฐูู') :
        (appData.suppliers.find(s => s.id === payment.supplierId)?.name || 'ููุฑุฏ ูุญุฐูู');

    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุณูุฏ ${paymentTypeText} ุฑูู ${payment.number}ุ\n\nุงูุนููู/ุงูููุฑุฏ: ${clientName}\nุงููุจูุบ: ${formatCurrency(payment.amount)}\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุคุซุฑ ุนูู:\n- ุฃุฑุตุฏุฉ ุงูุนููุงุก/ุงูููุฑุฏูู\n- ุงููููุฏ ุงููุญุงุณุจูุฉ`)) {

        try {
            console.log('๐๏ธ ุจุฏุก ุญุฐู ุงูุณูุฏ:', payment.number);

            // ุนูุณ ุชุฃุซูุฑ ุงูุณูุฏ ุนูู ุฃุฑุตุฏุฉ ุงูุนููุงุก/ุงูููุฑุฏูู
            const currency = payment.currency || appData.settings.currency || 'SYP';

            if (payment.type === 'receipt' && payment.customerId) {
                const customer = appData.customers.find(c => c.id === payment.customerId);
                if (customer) {
                    // ุทุฑุญ ุงููุจูุบ ูู ุฅุฌูุงูู ุงููุฏููุนุงุช ูุฅุถุงูุชู ููุฑุตูุฏ
                    customer.totalPayments = (customer.totalPayments || 0) - payment.amount;
                    customer.transactionCount = Math.max(0, (customer.transactionCount || 1) - 1);

                    if (customer.balances && customer.balances[currency]) {
                        customer.balances[currency] += payment.amount; // ุฅุฑุฌุงุน ุงููุจูุบ ููุฑุตูุฏ
                    }
                    if (currency === (appData.settings.currency || 'SYP')) {
                        customer.currentBalance = (customer.currentBalance || 0) + payment.amount;
                    }
                    console.log(`๐ค ุชู ุชุนุฏูู ุฑุตูุฏ ุงูุนููู ${customer.name}`);
                }
            } else if (payment.type === 'payment' && payment.supplierId) {
                const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
                if (supplier) {
                    // ุทุฑุญ ุงููุจูุบ ูู ุฅุฌูุงูู ุงููุฏููุนุงุช ูุฅุถุงูุชู ููุฑุตูุฏ
                    supplier.totalPayments = (supplier.totalPayments || 0) - payment.amount;
                    supplier.transactionCount = Math.max(0, (supplier.transactionCount || 1) - 1);

                    if (supplier.balances && supplier.balances[currency]) {
                        supplier.balances[currency] += payment.amount; // ุฅุฑุฌุงุน ุงููุจูุบ ููุฑุตูุฏ
                    }
                    if (currency === (appData.settings.currency || 'SYP')) {
                        supplier.currentBalance = (supplier.currentBalance || 0) + payment.amount;
                    }
                    console.log(`๐ข ุชู ุชุนุฏูู ุฑุตูุฏ ุงูููุฑุฏ ${supplier.name}`);
                }
            }

            // ุญุฐู ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฑุชุจุทุฉ
            if (appData.journalEntries) {
                const entriesCountBefore = appData.journalEntries.length;
                appData.journalEntries = appData.journalEntries.filter(entry => entry.paymentId !== id);
                const entriesCountAfter = appData.journalEntries.length;
                console.log(`๐ ุชู ุญุฐู ${entriesCountBefore - entriesCountAfter} ููุฏ ูุญุงุณุจู`);
            }

            // ุญุฐู ุงูุณูุฏ
            appData.payments = appData.payments.filter(p => p.id !== id);

            // ุญูุธ ุงูุจูุงูุงุช
            saveData();

            console.log('โ ุชู ุญุฐู ุงูุณูุฏ ุจูุฌุงุญ');
            alert('ุชู ุญุฐู ุงูุณูุฏ ุจูุฌุงุญ');

            // ุชุญุฏูุซ ุงูุตูุญุฉ ุงูุญุงููุฉ
            const currentPage = document.querySelector('.nav-link.active')?.getAttribute('onclick')?.match(/showPage\('([^']+)'\)/)?.[1];
            if (currentPage) {
                showPage(currentPage);
            }

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุญุฐู ุงูุณูุฏ:', error);
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุณูุฏ: ' + error.message);
        }
    }
}

/**
 * ุตูุญุฉ ุฅุถุงูุฉ ููุชุฌ
 */
function getAddProductHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">
                        <i class="fas fa-box-open me-2"></i>
                        ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
                    </h1>
                    <button class="btn btn-outline-secondary" onclick="showPage('products')">
                        <i class="fas fa-arrow-right me-2"></i>
                        ุงูุนูุฏุฉ ูููุงุฆูุฉ
                    </button>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-box me-2"></i>
                            ุจูุงูุงุช ุงูููุชุฌ
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="addProductForm" onsubmit="addNewProduct(event)">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productCode" class="form-label">
                                        <i class="fas fa-barcode me-1"></i>
                                        ููุฏ ุงูููุชุฌ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="productCode" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="productName" class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        ุงุณู ุงูููุชุฌ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="productDescription" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>
                                    ุงููุตู
                                </label>
                                <textarea class="form-control" id="productDescription" rows="3"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="productUnit" class="form-label">
                                        <i class="fas fa-weight me-1"></i>
                                        ุงููุญุฏุฉ <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="productUnit" required>
                                        <option value="">ุงุฎุชุฑ ุงููุญุฏุฉ</option>
                                        <option value="ูุทุนุฉ">ูุทุนุฉ</option>
                                        <option value="ูููู">ูููู</option>
                                        <option value="ูุชุฑ">ูุชุฑ</option>
                                        <option value="ูุชุฑ">ูุชุฑ</option>
                                        <option value="ุนูุจุฉ">ุนูุจุฉ</option>
                                        <option value="ูุฑุชูู">ูุฑุชูู</option>
                                        <option value="ุทู">ุทู</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="productCategory" class="form-label">
                                        <i class="fas fa-list me-1"></i>
                                        ุงููุฆุฉ
                                    </label>
                                    <select class="form-select" id="productCategory">
                                        <option value="">ุงุฎุชุฑ ุงููุฆุฉ</option>
                                        <option value="ุฅููุชุฑูููุงุช">ุฅููุชุฑูููุงุช</option>
                                        <option value="ุฅูุณุณูุงุฑุงุช">ุฅูุณุณูุงุฑุงุช</option>
                                        <option value="ุฃุฌูุฒุฉ">ุฃุฌูุฒุฉ</option>
                                        <option value="ูุทุน ุบูุงุฑ">ูุทุน ุบูุงุฑ</option>
                                        <option value="ููุงุฏ ุบุฐุงุฆูุฉ">ููุงุฏ ุบุฐุงุฆูุฉ</option>
                                        <option value="ููุงุจุณ">ููุงุจุณ</option>
                                        <option value="ุฃุฎุฑู">ุฃุฎุฑู</option>
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="productWarehouse" class="form-label">
                                        <i class="fas fa-warehouse me-1"></i>
                                        ุงููุฎุฒู <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="productWarehouse" required>
                                        <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
                                        ${appData.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productCostPrice" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        ุณุนุฑ ุงูุชูููุฉ (ู.ุณ) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="productCostPrice" min="0" step="0.01" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="productSellingPrice" class="form-label">
                                        <i class="fas fa-money-bill me-1"></i>
                                        ุณุนุฑ ุงูุจูุน (ู.ุณ) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="productSellingPrice" min="0" step="0.01" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productQuantity" class="form-label">
                                        <i class="fas fa-cubes me-1"></i>
                                        ุงููููุฉ ุงูุญุงููุฉ <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="productQuantity" min="0" step="0.01" required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="productMinQuantity" class="form-label">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="productMinQuantity" min="0" step="0.01" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="productBarcode" class="form-label">
                                    <i class="fas fa-qrcode me-1"></i>
                                    ุงูุจุงุฑููุฏ
                                </label>
                                <input type="text" class="form-control" id="productBarcode">
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="showPage('products')">
                                    <i class="fas fa-times me-2"></i>
                                    ุฅูุบุงุก
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุงูููุชุฌ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
 */
function getLoginHTML() {
    return `
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-calculator fa-3x text-primary mb-3"></i>
                            <h3>ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู</h3>
                            <h5 class="text-muted">SAM PRO</h5>
                        </div>

                        <form id="loginForm" onsubmit="login(event)">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label">
                                    <i class="fas fa-user me-1"></i>
                                    ุงุณู ุงููุณุชุฎุฏู
                                </label>
                                <input type="text" class="form-control" id="loginUsername" required placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู">
                            </div>

                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">
                                    <i class="fas fa-lock me-1"></i>
                                    ูููุฉ ุงููุฑูุฑ
                                </label>
                                <input type="password" class="form-control" id="loginPassword" required placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ">
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    ุชุณุฌูู ุงูุฏุฎูู
                                </button>
                            </div>
                        </form>

                        <div class="text-center mt-4">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ุงูุฎุงุตุฉ ุจู
                            </small>
                        </div>

                        <div class="text-center mt-4">
                            <small class="text-muted">
                                ุชุทููุฑ: <strong>MOHANNAD AHMAD</strong><br>
                                ูุงุชู: +963-998-171-954
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
 */
function getSettingsHTML() {
    const settings = appData.settings;
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-cog me-2"></i>
                    ุฅุนุฏุงุฏุงุช ุงููุธุงู
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-building me-2"></i>
                            ูุนูููุงุช ุงูุดุฑูุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="companySettingsForm" onsubmit="saveCompanySettings(event)">
                            <div class="mb-3">
                                <label for="companyName" class="form-label">ุงุณู ุงูุดุฑูุฉ</label>
                                <input type="text" class="form-control" id="companyName" value="${settings.companyName || ''}">
                            </div>

                            <div class="mb-3">
                                <label for="companyAddress" class="form-label">ุนููุงู ุงูุดุฑูุฉ</label>
                                <textarea class="form-control" id="companyAddress" rows="3">${settings.companyAddress || ''}</textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="companyPhone" class="form-label">ูุงุชู ุงูุดุฑูุฉ</label>
                                    <input type="tel" class="form-control" id="companyPhone" value="${settings.companyPhone || ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="companyEmail" class="form-label">ุจุฑูุฏ ุงูุดุฑูุฉ</label>
                                    <input type="email" class="form-control" id="companyEmail" value="${settings.companyEmail || ''}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="taxNumber" class="form-label">ุงูุฑูู ุงูุถุฑูุจู</label>
                                    <input type="text" class="form-control" id="taxNumber" value="${settings.taxNumber || ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="currency" class="form-label">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ</label>
                                    <select class="form-select" id="currency" onchange="updateCurrencySymbol()">
                                        <option value="SYP" ${settings.currency === 'SYP' ? 'selected' : ''}>ุงูููุฑุฉ ุงูุณูุฑูุฉ (ู.ุณ)</option>
                                        <option value="USD" ${settings.currency === 'USD' ? 'selected' : ''}>ุงูุฏููุงุฑ ุงูุฃูุฑููู ($)</option>
                                        <option value="EUR" ${settings.currency === 'EUR' ? 'selected' : ''}>ุงูููุฑู (โฌ)</option>
                                        <option value="SAR" ${settings.currency === 'SAR' ? 'selected' : ''}>ุงูุฑูุงู ุงูุณุนูุฏู (ุฑ.ุณ)</option>
                                        <option value="AED" ${settings.currency === 'AED' ? 'selected' : ''}>ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                                        <option value="EGP" ${settings.currency === 'EGP' ? 'selected' : ''}>ุงูุฌููู ุงููุตุฑู (ุฌ.ู)</option>
                                        <option value="JOD" ${settings.currency === 'JOD' ? 'selected' : ''}>ุงูุฏููุงุฑ ุงูุฃุฑุฏูู (ุฏ.ุฃ)</option>
                                        <option value="LBP" ${settings.currency === 'LBP' ? 'selected' : ''}>ุงูููุฑุฉ ุงููุจูุงููุฉ (ู.ู)</option>
                                        <option value="TRY" ${settings.currency === 'TRY' ? 'selected' : ''}>ุงูููุฑุฉ ุงูุชุฑููุฉ (โบ)</option>
                                        <option value="GBP" ${settings.currency === 'GBP' ? 'selected' : ''}>ุงูุฌููู ุงูุฅุณุชุฑูููู (ยฃ)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- ุฅุนุฏุงุฏุงุช ุงูุนููุงุช ุงููุชุนุฏุฏุฉ -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableMultiCurrency" ${settings.enableMultiCurrency ? 'checked' : ''} onchange="toggleMultiCurrency()">
                                    <label class="form-check-label" for="enableMultiCurrency">
                                        <i class="fas fa-coins me-2"></i>
                                        ุชูุนูู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
                                    </label>
                                </div>
                                <small class="text-muted">ูุณูุญ ุจุฅุฏุงุฑุฉ ุงูุนููุงุก ูุงูููุฑุฏูู ุจุนููุงุช ูุฎุชููุฉ</small>
                            </div>

                            <!-- ุฌุฏูู ุฃุณุนุงุฑ ุงูุตุฑู -->
                            <div id="exchangeRatesSection" style="display: ${settings.enableMultiCurrency ? 'block' : 'none'};">
                                <label class="form-label">ุฃุณุนุงุฑ ุงูุตุฑู (ููุงุจู ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ)</label>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ุงูุนููุฉ</th>
                                                <th>ุงูุฑูุฒ</th>
                                                <th>ุณุนุฑ ุงูุตุฑู</th>
                                                <th>ุขุฎุฑ ุชุญุฏูุซ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="exchangeRatesTable">
                                            ${getExchangeRatesHTML(settings)}
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateExchangeRates()">
                                    <i class="fas fa-sync me-2"></i>ุชุญุฏูุซ ุฃุณุนุงุฑ ุงูุตุฑู
                                </button>
                            </div>

                            <div class="mb-3">
                                <label for="taxRate" class="form-label">ูุนุฏู ุงูุถุฑูุจุฉ (%)</label>
                                <input type="number" class="form-control" id="taxRate" min="0" max="100" step="0.01" value="${settings.taxRate || 0}">
                            </div>

                            <div class="d-flex justify-content-between">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-warning" onclick="diagnoseCurrencySettings()">
                                        <i class="fas fa-stethoscope me-2"></i>
                                        ุชุดุฎูุต ุงููุดุงูู
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="fixCurrencySettings()">
                                        <i class="fas fa-wrench me-2"></i>
                                        ุฅุตูุงุญ ุงูุจูุงูุงุช
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="testCurrencySettingsSave()">
                                        <i class="fas fa-vial me-2"></i>
                                        ุงุฎุชุจุงุฑ ุงูุญูุธ
                                    </button>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ุฅุนุฏุงุฏุงุช ุงููุธุงู -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            ุฅุนุฏุงุฏุงุช ุงููุธุงู
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="systemSettingsForm" onsubmit="saveSystemSettings(event)">
                            <div class="mb-3">
                                <label for="systemPassword" class="form-label">ูููุฉ ูุฑูุฑ ุงููุธุงู</label>
                                <input type="password" class="form-control" id="systemPassword" value="${settings.password || '123'}">
                            </div>

                            <div class="mb-3">
                                <label for="companyLogo" class="form-label">ุดุนุงุฑ ุงูุดุฑูุฉ</label>
                                <input type="file" class="form-control" id="companyLogo" accept="image/*" onchange="uploadLogo(this)">
                                <small class="text-muted">ูููุถู ุตูุฑุฉ ุจุญุฌู 200x100 ุจูุณู</small>
                                ${settings.logoUrl ? `<div class="mt-2"><img src="${settings.logoUrl}" alt="ุดุนุงุฑ ุงูุดุฑูุฉ" style="max-height: 100px;"></div>` : ''}
                            </div>

                            <div class="mb-3">
                                <label for="autoBackup" class="form-label">ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู</label>
                                <select class="form-select" id="autoBackup">
                                    <option value="disabled" ${settings.autoBackup === 'disabled' ? 'selected' : ''}>ูุนุทู</option>
                                    <option value="daily" ${settings.autoBackup === 'daily' ? 'selected' : ''}>ูููู</option>
                                    <option value="weekly" ${settings.autoBackup === 'weekly' ? 'selected' : ''}>ุฃุณุจูุนู</option>
                                    <option value="monthly" ${settings.autoBackup === 'monthly' ? 'selected' : ''}>ุดูุฑู</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-print me-2"></i>
                            ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="printSettingsForm" onsubmit="savePrintSettings(event)">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="fas fa-eye me-2"></i>
                                        ุนุฑุถ ุงููุนูููุงุช
                                    </h6>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showAppName" ${settings.printSettings?.showAppName !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showAppName">
                                                <i class="fas fa-tag me-2"></i>
                                                ุฅุธูุงุฑ ุงุณู ุงูุชุทุจูู ูู ุงููููุงุช ุงููุทุจูุนุฉ
                                            </label>
                                        </div>
                                        <small class="text-muted">ุนุฑุถ "SAM PRO" ูู ุฃุณูู ุงููููุงุช ุงููุทุจูุนุฉ</small>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showCompanyLogo" ${settings.printSettings?.showCompanyLogo !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showCompanyLogo">
                                                <i class="fas fa-image me-2"></i>
                                                ุฅุธูุงุฑ ุดุนุงุฑ ุงูุดุฑูุฉ
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showPrintDate" ${settings.printSettings?.showPrintDate !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showPrintDate">
                                                <i class="fas fa-calendar me-2"></i>
                                                ุฅุธูุงุฑ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showPageNumbers" ${settings.printSettings?.showPageNumbers !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showPageNumbers">
                                                <i class="fas fa-list-ol me-2"></i>
                                                ุฅุธูุงุฑ ุฃุฑูุงู ุงูุตูุญุงุช
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="fas fa-cogs me-2"></i>
                                        ุฅุนุฏุงุฏุงุช ุงูุชุฎุตูุต
                                    </h6>

                                    <div class="mb-3">
                                        <label for="printHeaderText" class="form-label">ูุต ุฑุฃุณ ุงูุตูุญุฉ (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" class="form-control" id="printHeaderText" value="${settings.printSettings?.headerText || ''}" placeholder="ูุซุงู: ุชูุฑูุฑ ุดูุฑู">
                                    </div>

                                    <div class="mb-3">
                                        <label for="printFooterText" class="form-label">ูุต ุชุฐููู ุงูุตูุญุฉ (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" class="form-control" id="printFooterText" value="${settings.printSettings?.footerText || ''}" placeholder="ูุซุงู: ุดูุฑุงู ูุชุนุงูููู ูุนูุง">
                                    </div>

                                    <div class="mb-3">
                                        <label for="printOrientation" class="form-label">ุงุชุฌุงู ุงูุทุจุงุนุฉ</label>
                                        <select class="form-select" id="printOrientation">
                                            <option value="portrait" ${settings.printSettings?.orientation === 'portrait' ? 'selected' : ''}>ุนููุฏู (Portrait)</option>
                                            <option value="landscape" ${settings.printSettings?.orientation === 'landscape' ? 'selected' : ''}>ุฃููู (Landscape)</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="printPageSize" class="form-label">ุญุฌู ุงููุฑู</label>
                                        <select class="form-select" id="printPageSize">
                                            <option value="A4" ${settings.printSettings?.pageSize === 'A4' ? 'selected' : ''}>A4</option>
                                            <option value="A3" ${settings.printSettings?.pageSize === 'A3' ? 'selected' : ''}>A3</option>
                                            <option value="Letter" ${settings.printSettings?.pageSize === 'Letter' ? 'selected' : ''}>Letter</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-info" onclick="previewPrintSettings()">
                                    <i class="fas fa-eye me-2"></i>
                                    ูุนุงููุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-print me-2"></i>
                            ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="printSettingsForm" onsubmit="savePrintSettings(event)">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="fas fa-eye me-2"></i>
                                        ุนุฑุถ ุงููุนูููุงุช
                                    </h6>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showAppName" ${settings.printSettings?.showAppName !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showAppName">
                                                <i class="fas fa-tag me-2"></i>
                                                ุฅุธูุงุฑ ุงุณู ุงูุชุทุจูู ูู ุงููููุงุช ุงููุทุจูุนุฉ
                                            </label>
                                        </div>
                                        <small class="text-muted">ุนุฑุถ "SAM PRO" ูู ุฃุณูู ุงููููุงุช ุงููุทุจูุนุฉ</small>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showCompanyLogo" ${settings.printSettings?.showCompanyLogo !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showCompanyLogo">
                                                <i class="fas fa-image me-2"></i>
                                                ุฅุธูุงุฑ ุดุนุงุฑ ุงูุดุฑูุฉ
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showPrintDate" ${settings.printSettings?.showPrintDate !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showPrintDate">
                                                <i class="fas fa-calendar me-2"></i>
                                                ุฅุธูุงุฑ ุชุงุฑูุฎ ุงูุทุจุงุนุฉ
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="showPageNumbers" ${settings.printSettings?.showPageNumbers !== false ? 'checked' : ''}>
                                            <label class="form-check-label" for="showPageNumbers">
                                                <i class="fas fa-list-ol me-2"></i>
                                                ุฅุธูุงุฑ ุฃุฑูุงู ุงูุตูุญุงุช
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="fas fa-cogs me-2"></i>
                                        ุฅุนุฏุงุฏุงุช ุงูุชุฎุตูุต
                                    </h6>

                                    <div class="mb-3">
                                        <label for="printHeaderText" class="form-label">ูุต ุฑุฃุณ ุงูุตูุญุฉ (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" class="form-control" id="printHeaderText" value="${settings.printSettings?.headerText || ''}" placeholder="ูุซุงู: ุชูุฑูุฑ ุดูุฑู">
                                    </div>

                                    <div class="mb-3">
                                        <label for="printFooterText" class="form-label">ูุต ุชุฐููู ุงูุตูุญุฉ (ุงุฎุชูุงุฑู)</label>
                                        <input type="text" class="form-control" id="printFooterText" value="${settings.printSettings?.footerText || ''}" placeholder="ูุซุงู: ุดูุฑุงู ูุชุนุงูููู ูุนูุง">
                                    </div>

                                    <div class="mb-3">
                                        <label for="printOrientation" class="form-label">ุงุชุฌุงู ุงูุทุจุงุนุฉ</label>
                                        <select class="form-select" id="printOrientation">
                                            <option value="portrait" ${settings.printSettings?.orientation === 'portrait' ? 'selected' : ''}>ุนููุฏู (Portrait)</option>
                                            <option value="landscape" ${settings.printSettings?.orientation === 'landscape' ? 'selected' : ''}>ุฃููู (Landscape)</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="printPageSize" class="form-label">ุญุฌู ุงููุฑู</label>
                                        <select class="form-select" id="printPageSize">
                                            <option value="A4" ${settings.printSettings?.pageSize === 'A4' ? 'selected' : ''}>A4</option>
                                            <option value="A3" ${settings.printSettings?.pageSize === 'A3' ? 'selected' : ''}>A3</option>
                                            <option value="Letter" ${settings.printSettings?.pageSize === 'Letter' ? 'selected' : ''}>Letter</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-info" onclick="previewPrintSettings()">
                                    <i class="fas fa-eye me-2"></i>
                                    ูุนุงููุฉ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ูุนูููุงุช ุงููุทูุฑ -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-tie me-2"></i>
                            ูุนูููุงุช ุงููุทูุฑ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user me-2"></i>ุงููุทูุฑ</h6>
                                <p class="mb-2"><strong>MOHANNAD AHMAD</strong></p>

                                <h6><i class="fas fa-phone me-2"></i>ุฑูู ุงููุงุชู</h6>
                                <p class="mb-2">+963-998-171-954</p>

                                <h6><i class="fas fa-code me-2"></i>ุงูุชุฎุตุต</h6>
                                <p class="mb-2">ุชุทููุฑ ุชุทุจููุงุช ุงูููุจ ูุงููุญุงุณุจุฉ</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-calendar me-2"></i>ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ</h6>
                                <p class="mb-2">ููุงูุฑ 2025</p>

                                <h6><i class="fas fa-tag me-2"></i>ุฅุตุฏุงุฑ ุงูุจุฑูุงูุฌ</h6>
                                <p class="mb-2">SAM PRO v1.0.0</p>

                                <h6><i class="fas fa-tools me-2"></i>ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ</h6>
                                <p class="mb-2">HTML5, CSS3, JavaScript, Bootstrap</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุงูุญุตูู ุนูู HTML ุฃุณุนุงุฑ ุงูุตุฑู
 */
function getExchangeRatesHTML(settings) {
    const currencies = [
        { code: 'USD', name: 'ุงูุฏููุงุฑ ุงูุฃูุฑููู', symbol: '$' },
        { code: 'EUR', name: 'ุงูููุฑู', symbol: 'โฌ' },
        { code: 'SAR', name: 'ุงูุฑูุงู ุงูุณุนูุฏู', symbol: 'ุฑ.ุณ' },
        { code: 'AED', name: 'ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู', symbol: 'ุฏ.ุฅ' },
        { code: 'EGP', name: 'ุงูุฌููู ุงููุตุฑู', symbol: 'ุฌ.ู' },
        { code: 'JOD', name: 'ุงูุฏููุงุฑ ุงูุฃุฑุฏูู', symbol: 'ุฏ.ุฃ' },
        { code: 'LBP', name: 'ุงูููุฑุฉ ุงููุจูุงููุฉ', symbol: 'ู.ู' },
        { code: 'TRY', name: 'ุงูููุฑุฉ ุงูุชุฑููุฉ', symbol: 'โบ' },
        { code: 'GBP', name: 'ุงูุฌููู ุงูุฅุณุชุฑูููู', symbol: 'ยฃ' }
    ];

    const baseCurrency = settings.currency || 'SYP';
    const exchangeRates = settings.exchangeRates || {};

    return currencies
        .filter(curr => curr.code !== baseCurrency)
        .map(currency => {
            const rate = exchangeRates[currency.code] || 1;
            const lastUpdate = exchangeRates[`${currency.code}_updated`] || 'ูู ูุญุฏุซ';

            return `
                <tr>
                    <td>${currency.name}</td>
                    <td>${currency.symbol}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm"
                               id="rate_${currency.code}"
                               value="${rate}"
                               min="0" step="0.0001"
                               onchange="updateSingleExchangeRate('${currency.code}', this.value)">
                    </td>
                    <td><small class="text-muted">${lastUpdate}</small></td>
                </tr>
            `;
        }).join('');
}

/**
 * ุชูุนูู/ุฅูุบุงุก ุชูุนูู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
 */
function toggleMultiCurrency() {
    const checkbox = document.getElementById('enableMultiCurrency');
    const section = document.getElementById('exchangeRatesSection');

    if (checkbox.checked) {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

/**
 * ุชุญุฏูุซ ุฑูุฒ ุงูุนููุฉ
 */
function updateCurrencySymbol() {
    const currencySelect = document.getElementById('currency');
    const selectedOption = currencySelect.options[currencySelect.selectedIndex];
    const currencyText = selectedOption.textContent;
    const symbol = currencyText.match(/\(([^)]+)\)/)?.[1] || '';

    // ุชุญุฏูุซ ุฑูุฒ ุงูุนููุฉ ูู ุงูุฅุนุฏุงุฏุงุช ูุคูุชุงู
    if (!appData.settings.currencySymbols) {
        appData.settings.currencySymbols = {};
    }
    appData.settings.currencySymbols[currencySelect.value] = symbol;
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุตุฑู ูุงุญุฏ
 */
function updateSingleExchangeRate(currencyCode, rate) {
    if (!appData.settings.exchangeRates) {
        appData.settings.exchangeRates = {};
    }

    appData.settings.exchangeRates[currencyCode] = parseFloat(rate) || 1;
    appData.settings.exchangeRates[`${currencyCode}_updated`] = formatDateTime(new Date());

    console.log(`ุชู ุชุญุฏูุซ ุณุนุฑ ุตุฑู ${currencyCode}: ${rate}`);
}

/**
 * ุชุญุฏูุซ ุฌููุน ุฃุณุนุงุฑ ุงูุตุฑู
 */
function updateExchangeRates() {
    const currencies = ['USD', 'EUR', 'SAR', 'AED', 'EGP', 'JOD', 'LBP', 'TRY', 'GBP'];
    const baseCurrency = appData.settings.currency || 'SYP';

    if (!appData.settings.exchangeRates) {
        appData.settings.exchangeRates = {};
    }

    currencies.forEach(currency => {
        if (currency !== baseCurrency) {
            const input = document.getElementById(`rate_${currency}`);
            if (input) {
                const rate = parseFloat(input.value) || 1;
                appData.settings.exchangeRates[currency] = rate;
                appData.settings.exchangeRates[`${currency}_updated`] = formatDateTime(new Date());
            }
        }
    });

    saveData();
    alert('ุชู ุชุญุฏูุซ ุฃุณุนุงุฑ ุงูุตุฑู ุจูุฌุงุญ');
}

/**
 * ุงูุญุตูู ุนูู ุฑูุฒ ุงูุนููุฉ
 */
function getCurrencySymbol(currencyCode) {
    const symbols = {
        'SYP': 'ู.ุณ',
        'USD': '$',
        'EUR': 'โฌ',
        'SAR': 'ุฑ.ุณ',
        'AED': 'ุฏ.ุฅ',
        'EGP': 'ุฌ.ู',
        'JOD': 'ุฏ.ุฃ',
        'LBP': 'ู.ู',
        'TRY': 'โบ',
        'GBP': 'ยฃ'
    };

    return symbols[currencyCode] || currencyCode;
}

/**
 * ุชุญููู ุงููุจูุบ ุจูู ุงูุนููุงุช
 */
function convertCurrency(amount, fromCurrency, toCurrency) {
    if (fromCurrency === toCurrency) {
        return amount;
    }

    const baseCurrency = appData.settings.currency || 'SYP';
    const exchangeRates = appData.settings.exchangeRates || {};

    let amountInBase = amount;

    // ุชุญููู ุฅูู ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ ุฃููุงู
    if (fromCurrency !== baseCurrency) {
        const fromRate = exchangeRates[fromCurrency] || 1;
        amountInBase = amount / fromRate;
    }

    // ุชุญููู ูู ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ ุฅูู ุงูุนููุฉ ุงููุทููุจุฉ
    if (toCurrency !== baseCurrency) {
        const toRate = exchangeRates[toCurrency] || 1;
        return amountInBase * toRate;
    }

    return amountInBase;
}

/**
 * ุชูุณูู ุงููุจูุบ ูุน ุงูุนููุฉ
 */
function formatCurrencyWithCode(amount, currencyCode) {
    const symbol = getCurrencySymbol(currencyCode);
    return `${parseFloat(amount).toFixed(2)} ${symbol}`;
}

/**
 * ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู
 */
function getBackupHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-database me-2"></i>
                    ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-download me-2"></i>
                            ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            ูู ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุฌููุน ุจูุงูุงุช ุงููุธุงู ูุญูุธูุง ูู ููุงู ุขูู.
                        </p>

                        <div class="mb-3">
                            <label for="backupName" class="form-label">ุงุณู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</label>
                            <input type="text" class="form-control" id="backupName" value="backup_${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeSettings" checked>
                                <label class="form-check-label" for="includeSettings">
                                    ุชุถููู ุฅุนุฏุงุฏุงุช ุงููุธุงู
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeData" checked>
                                <label class="form-check-label" for="includeData">
                                    ุชุถููู ุฌููุน ุงูุจูุงูุงุช
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-download me-2"></i>
                            ุฅูุดุงุก ูุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                        </button>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ุณูุชู ุชุญููู ููู JSON ูุญุชูู ุนูู ุฌููุน ุงูุจูุงูุงุช
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>
                            ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            ูู ุจุฑูุน ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช.
                        </p>

                        <div class="mb-3">
                            <label for="backupFile" class="form-label">ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</label>
                            <input type="file" class="form-control" id="backupFile" accept=".json" onchange="validateBackupFile(this)">
                            <small class="text-muted">ูุฌุจ ุฃู ูููู ุงูููู ุจุตูุบุฉ JSON</small>
                        </div>

                        <div class="mb-3" id="backupFileInfo" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</h6>
                                <div id="backupDetails"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmRestore">
                                <label class="form-check-label" for="confirmRestore">
                                    ุฃุคูุฏ ุฃููู ุฃุฑูุฏ ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn btn-warning" onclick="restoreBackup()" disabled id="restoreBtn">
                            <i class="fas fa-upload me-2"></i>
                            ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                        </button>

                        <div class="mt-3">
                            <small class="text-danger">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                ุชุญุฐูุฑ: ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช ุงูุญุงููุฉ -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช ุงูุญุงููุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-primary">${appData.customers.length}</h4>
                                    <small class="text-muted">ุงูุนููุงุก</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-success">${appData.suppliers.length}</h4>
                                    <small class="text-muted">ุงูููุฑุฏูู</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-info">${appData.products.length}</h4>
                                    <small class="text-muted">ุงูุฃุตูุงู</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-warning">${appData.warehouses.length}</h4>
                                    <small class="text-muted">ุงููุฎุงุฒู</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-danger">${appData.invoices.length}</h4>
                                    <small class="text-muted">ุงูููุงุชูุฑ</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="border p-3 rounded">
                                    <h4 class="text-secondary">${appData.payments.length}</h4>
                                    <small class="text-muted">ุงูุณูุฏุงุช</small>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center">
                            <small class="text-muted">
                                ุขุฎุฑ ุชุญุฏูุซ: ${formatDateTime(new Date())}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุชุตุฏูุฑ ุฅูู PDF ูุน ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุญุณู
 */
function exportToPDF(pageType, title) {
    console.log('๐ ุจุฏุก ุชุตุฏูุฑ PDF ูุญุณู:', title);

    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ููุชุจุงุช PDF
        if (typeof window.jsPDF === 'undefined' && typeof html2canvas === 'undefined') {
            console.warn('โ๏ธ ููุชุจุงุช PDF ุบูุฑ ูุชููุฑุฉ - ุงุณุชุฎุฏุงู ุงูุทุจุงุนุฉ ูุจุฏูู');
            printContent(pageType, title);
            return;
        }

        // ุฅูุดุงุก ูุญุชูู ูุญุณู ููุชุตุฏูุฑ
        const exportContent = document.createElement('div');
        exportContent.style.cssText = `
            font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            padding: 20px;
            background: white;
            color: black;
            width: 800px;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
        `;

        // ุฅุถุงูุฉ ุฑุฃุณ ุงูุชูุฑูุฑ ุงููุญุณู
        const header = document.createElement('div');
        header.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h1 style="margin: 0; font-size: 28px; font-weight: bold;">${title}</h1>
                    <p style="margin: 5px 0; font-size: 16px; opacity: 0.9;">ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู - SAM PRO</p>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <p style="margin: 0; color: #666; font-size: 14px;">ุชุงุฑูุฎ ุงูุชุตุฏูุฑ: ${formatDateTime(new Date().toISOString())}</p>
                    <p style="margin: 0; color: #666; font-size: 14px;">ุงูุตูุญุฉ: 1</p>
                </div>
            </div>
        `;
        exportContent.appendChild(header);

        // ุฅุถุงูุฉ ูุญุชูู ุงูุตูุญุฉ
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            const contentClone = mainContent.cloneNode(true);

            // ุฅุฒุงูุฉ ุงูุฃุฒุฑุงุฑ ูุงูุนูุงุตุฑ ุบูุฑ ุงููุทููุจุฉ
            const buttonsToRemove = contentClone.querySelectorAll('button, .btn, .dropdown, .pagination, .modal');
            buttonsToRemove.forEach(btn => btn.remove());

            // ุชุญุณูู ุงูุฌุฏุงูู ููุทุจุงุนุฉ ูุน ุชุตููู ุฃูุถู
            const tables = contentClone.querySelectorAll('table');
            tables.forEach((table, index) => {
                table.style.cssText = `
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    font-size: 11px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border-radius: 8px;
                    overflow: hidden;
                `;

                const cells = table.querySelectorAll('th, td');
                cells.forEach(cell => {
                    cell.style.cssText = `
                        border: 1px solid #e0e0e0;
                        padding: 10px 8px;
                        text-align: right;
                        vertical-align: middle;
                        line-height: 1.4;
                    `;
                });

                const headers = table.querySelectorAll('th');
                headers.forEach(header => {
                    header.style.cssText += `
                        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                        font-weight: bold;
                        color: #495057;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    `;
                });

                // ุชูููู ุงูุตููู ุจุงูุชูุงูุจ
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, rowIndex) => {
                    if (rowIndex % 2 === 1) {
                        row.style.backgroundColor = '#f8f9fa';
                    }
                });
            });

            exportContent.appendChild(contentClone);
        }

        // ุฅุถุงูุฉ ุชุฐููู ูุญุณู
        const footer = document.createElement('div');
        footer.innerHTML = `
            <div style="text-align: center; margin-top: 40px; padding: 20px; border-top: 2px solid #007bff; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="text-align: right;">
                        <p style="margin: 0; font-size: 12px; color: #666;">ุชุทููุฑ: MOHANNAD AHMAD</p>
                        <p style="margin: 0; font-size: 12px; color: #666;">ูุงุชู: +963-998-171-954</p>
                    </div>
                    <div style="text-align: left;">
                        <p style="margin: 0; font-size: 12px; color: #666;">SAM PRO - ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู</p>
                        <p style="margin: 0; font-size: 12px; color: #666;">ยฉ 2025 ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
                    </div>
                </div>
                <div style="text-align: center; padding-top: 10px; border-top: 1px solid #dee2e6;">
                    <p style="margin: 0; font-size: 10px; color: #999;">ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู SAM PRO</p>
                </div>
            </div>
        `;
        exportContent.appendChild(footer);

        // ุฅุถุงูุฉ ุงููุญุชูู ููุตูุญุฉ ูุคูุชุงู
        exportContent.style.position = 'absolute';
        exportContent.style.left = '-9999px';
        document.body.appendChild(exportContent);

        // ุชุตุฏูุฑ PDF ุจุงุณุชุฎุฏุงู html2canvas ู jsPDF ูุน ุฅุนุฏุงุฏุงุช ูุญุณูุฉ
        if (typeof html2canvas !== 'undefined' && typeof window.jsPDF !== 'undefined') {
            console.log('๐ธ ุจุฏุก ุชุญููู ุงููุญุชูู ุฅูู ุตูุฑุฉ...');

            html2canvas(exportContent, {
                scale: 2, // ุฌูุฏุฉ ุฃุนูู
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: 800,
                height: exportContent.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                windowWidth: 800,
                windowHeight: exportContent.scrollHeight,
                logging: false, // ุชูููู ุงูุฑุณุงุฆู
                imageTimeout: 15000, // ูููุฉ ุฒูููุฉ ุฃุทูู
                removeContainer: true
            }).then(canvas => {
                console.log('โ ุชู ุชุญููู ุงููุญุชูู ุฅูู ุตูุฑุฉ ุจูุฌุงุญ');
                console.log('๐ ุจุฏุก ุฅูุดุงุก ููู PDF...');

                const imgData = canvas.toDataURL('image/png', 0.95); // ุฌูุฏุฉ ุฃูุถู
                const { jsPDF } = window.jsPDF;

                // ุฅูุดุงุก PDF ุจุญุฌู A4
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const pageWidth = 210; // ุนุฑุถ A4
                const pageHeight = 297; // ุงุฑุชูุงุน A4
                const margin = 10; // ูุงูุด
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let heightLeft = imgHeight;
                let position = margin;
                let pageNumber = 1;

                // ุฅุถุงูุฉ ุงูุตูุญุฉ ุงูุฃููู
                pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - margin * 2);

                // ุฅุถุงูุฉ ุตูุญุงุช ุฅุถุงููุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + margin;
                    pdf.addPage();
                    pageNumber++;
                    pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - margin * 2);
                }

                console.log(`๐ ุชู ุฅูุดุงุก PDF ุจู ${pageNumber} ุตูุญุฉ`);

                // ุญูุธ ุงูููู ูุน ุงุณู ูุญุณู
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const fileName = `${title.replace(/[^\w\u0600-\u06FF\s]/g, '').replace(/\s+/g, '_')}_${timestamp}.pdf`;

                try {
                    pdf.save(fileName);
                    console.log('โ ุชู ุญูุธ PDF ุจูุฌุงุญ:', fileName);

                    // ุฅุฒุงูุฉ ุงููุญุชูู ุงููุคูุช
                    if (document.body.contains(exportContent)) {
                        document.body.removeChild(exportContent);
                    }

                    showSuccessToast(`ุชู ุชุตุฏูุฑ PDF ุจูุฌุงุญ! ุงูููู: ${fileName}`);

                } catch (saveError) {
                    console.error('โ ุฎุทุฃ ูู ุญูุธ PDF:', saveError);
                    throw saveError;
                }

            }).catch(error => {
                console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF:', error);

                // ุฅุฒุงูุฉ ุงููุญุชูู ุงููุคูุช
                if (document.body.contains(exportContent)) {
                    document.body.removeChild(exportContent);
                }

                // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ููุตูุฉ
                const errorMessage = error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
                alert(`ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ PDF:\n${errorMessage}\n\nุณูุชู ุงุณุชุฎุฏุงู ุงูุทุจุงุนุฉ ูุจุฏูู.`);

                // ุงุณุชุฎุฏุงู ุงูุทุจุงุนุฉ ูุจุฏูู
                setTimeout(() => printContent(pageType, title), 500);
            });
        } else {
            // ุงุณุชุฎุฏุงู window.print ูุจุฏูู
            console.warn('โ๏ธ ููุชุจุงุช PDF ุบูุฑ ูุชููุฑุฉ - ุงุณุชุฎุฏุงู ุงูุทุจุงุนุฉ');
            if (document.body.contains(exportContent)) {
                document.body.removeChild(exportContent);
            }
            printContent(pageType, title);
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ PDF: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ุฅูู Excel ูุน ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ
 */
function exportToExcel(pageType, title) {
    console.log('๐ ุจุฏุก ุชุตุฏูุฑ Excel:', title);

    try {
        // ุงูุชุญูู ูู ูุฌูุฏ XLSX
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        let data = [];
        let headers = [];

        // ุฌูุน ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุตูุญุฉ
        if (pageType === 'journal') {
            headers = ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุนูููุฉ', 'ุงููุตู', 'ุงูุญุณุงุจ ุงููุฏูู', 'ุงูุญุณุงุจ ุงูุฏุงุฆู', 'ุงููุจูุบ ุงููุฏูู', 'ุงููุจูุบ ุงูุฏุงุฆู', 'ุงููุฑุฌุน'];

            const entries = (appData.journalEntries || []).filter(entry => !entry.currency || entry.currency === (appData.settings.currency || 'SYP'));
            data = entries.map(entry => [
                formatDate(entry.entryDate || entry.date),
                getEntryTypeInfo(entry).text,
                entry.description || '',
                entry.debitAccount || '',
                entry.creditAccount || '',
                entry.debitAmount || 0,
                entry.creditAmount || 0,
                entry.reference || ''
            ]);
        } else if (pageType === 'currency-balances') {
            headers = ['ุงูุนููุฉ', 'ุงูุฑูุฒ', 'ุฅุฏุฎุงูุงุช ุงูุนููุงุก', 'ุฅุฎุฑุงุฌุงุช ุงูุนููุงุก', 'ุฅุฏุฎุงูุงุช ุงูููุฑุฏูู', 'ุฅุฎุฑุงุฌุงุช ุงูููุฑุฏูู', 'ุตุงูู ุงูุฑุตูุฏ', 'ุงูุญุงูุฉ'];

            const balanceData = calculateAccurateBalances();
            const currencySymbols = {
                'SYP': 'ู.ุณ', 'USD': '$', 'EUR': 'โฌ', 'TRY': 'โบ', 'SAR': 'ุฑ.ุณ', 'AED': 'ุฏ.ุฅ'
            };
            const currencyNames = {
                'SYP': 'ุงูููุฑุฉ ุงูุณูุฑูุฉ', 'USD': 'ุงูุฏููุงุฑ ุงูุฃูุฑููู', 'EUR': 'ุงูููุฑู',
                'TRY': 'ุงูููุฑุฉ ุงูุชุฑููุฉ', 'SAR': 'ุงูุฑูุงู ุงูุณุนูุฏู', 'AED': 'ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู'
            };

            data = Array.from(balanceData.currencies).map(currency => {
                const totals = balanceData.totals[currency];
                const symbol = currencySymbols[currency] || currency;
                const name = currencyNames[currency] || currency;
                const netBalance = totals.net;
                const statusText = netBalance > 0 ? 'ููุฌุจ' : netBalance < 0 ? 'ุณุงูุจ' : 'ูุชูุงุฒู';

                return [
                    name,
                    symbol,
                    totals.customerInflows,
                    totals.customerOutflows,
                    totals.supplierInflows,
                    totals.supplierOutflows,
                    netBalance,
                    statusText
                ];
            });
        } else if (pageType === 'sales-report') {
            headers = ['ุฑูู ุงููุงุชูุฑุฉ', 'ุงูุชุงุฑูุฎ', 'ุงูุนููู', 'ุงููุจูุบ ุงูุฅุฌูุงูู', 'ุงูุนููุฉ', 'ุงููุจูุบ ุงููุฏููุน', 'ุงููุจูุบ ุงููุชุจูู', 'ุงูุญุงูุฉ'];

            // ุงูุญุตูู ุนูู ููุงุชูุฑ ุงููุจูุนุงุช ุงููููุชุฑุฉ
            const fromDate = document.getElementById('salesReportFromDate')?.value;
            const toDate = document.getElementById('salesReportToDate')?.value;
            const customerId = document.getElementById('salesReportCustomer')?.value;

            let salesInvoices = (appData.invoices || []).filter(inv =>
                inv.invoiceType === 'sale' &&
                inv.status === 'confirmed'
            );

            if (fromDate && toDate) {
                salesInvoices = salesInvoices.filter(inv =>
                    inv.invoiceDate >= fromDate && inv.invoiceDate <= toDate
                );
            }

            if (customerId) {
                salesInvoices = salesInvoices.filter(inv => inv.customerId == customerId);
            }

            data = salesInvoices.map(invoice => {
                const customer = appData.customers?.find(c => c.id === invoice.customerId);
                const currency = invoice.currency || 'SYP';
                const total = invoice.totalAmount || 0;
                const paid = invoice.paidAmount || 0;
                const remaining = total - paid;
                const status = getInvoiceStatus(invoice);
                const statusText = status === 'paid' ? 'ูุฏููุนุฉ' : status === 'partial' ? 'ุฌุฒุฆูุฉ' : 'ูุนููุฉ';

                return [
                    invoice.invoiceNumber || '',
                    formatDate(invoice.invoiceDate),
                    customer ? customer.name : 'ุนููู ูุญุฐูู',
                    total,
                    currency,
                    paid,
                    remaining,
                    statusText
                ];
            });
        } else if (pageType === 'purchase-report') {
            headers = ['ุฑูู ุงููุงุชูุฑุฉ', 'ุงูุชุงุฑูุฎ', 'ุงูููุฑุฏ', 'ุงููุจูุบ ุงูุฅุฌูุงูู', 'ุงูุนููุฉ', 'ุงููุจูุบ ุงููุฏููุน', 'ุงููุจูุบ ุงููุชุจูู', 'ุงูุญุงูุฉ'];

            // ุงูุญุตูู ุนูู ููุงุชูุฑ ุงููุดุชุฑูุงุช ุงููููุชุฑุฉ
            const fromDate = document.getElementById('purchaseReportFromDate')?.value;
            const toDate = document.getElementById('purchaseReportToDate')?.value;
            const supplierId = document.getElementById('purchaseReportSupplier')?.value;

            let purchaseInvoices = (appData.invoices || []).filter(inv =>
                inv.invoiceType === 'purchase' &&
                inv.status === 'confirmed'
            );

            if (fromDate && toDate) {
                purchaseInvoices = purchaseInvoices.filter(inv =>
                    inv.invoiceDate >= fromDate && inv.invoiceDate <= toDate
                );
            }

            if (supplierId) {
                purchaseInvoices = purchaseInvoices.filter(inv => inv.supplierId == supplierId);
            }

            data = purchaseInvoices.map(invoice => {
                const supplier = appData.suppliers?.find(s => s.id === invoice.supplierId);
                const currency = invoice.currency || 'SYP';
                const total = invoice.totalAmount || 0;
                const paid = invoice.paidAmount || 0;
                const remaining = total - paid;
                const status = getInvoiceStatus(invoice);
                const statusText = status === 'paid' ? 'ูุฏููุนุฉ' : status === 'partial' ? 'ุฌุฒุฆูุฉ' : 'ูุนููุฉ';

                return [
                    invoice.invoiceNumber || '',
                    formatDate(invoice.invoiceDate),
                    supplier ? supplier.name : 'ููุฑุฏ ูุญุฐูู',
                    total,
                    currency,
                    paid,
                    remaining,
                    statusText
                ];
            });
        }

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);

        // ุชุญุณูู ุนุฑุถ ุงูุฃุนูุฏุฉ ุจูุงุกู ุนูู ุงููุญุชูู
        const colWidths = headers.map((header, index) => {
            let maxLength = header.length;

            // ูุญุต ุทูู ุงูุจูุงูุงุช ูู ูู ุนููุฏ
            data.forEach(row => {
                if (row[index] && row[index].toString().length > maxLength) {
                    maxLength = row[index].toString().length;
                }
            });

            // ุชุญุฏูุฏ ุนุฑุถ ููุงุณุจ (ุจุญุฏ ุฃุฏูู 10 ูุญุฏ ุฃูุตู 30)
            return { wch: Math.min(Math.max(maxLength + 2, 10), 30) };
        });
        worksheet['!cols'] = colWidths;

        // ุชูุณูู ุงูุฎูุงูุง
        const range = XLSX.utils.decode_range(worksheet['!ref']);

        // ุชูุณูู ุฑุฃุณ ุงูุฌุฏูู
        for (let col = range.s.c; col <= range.e.c; col++) {
            const headerCell = XLSX.utils.encode_cell({ r: 0, c: col });
            if (!worksheet[headerCell]) continue;

            worksheet[headerCell].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "366092" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
        }

        // ุชูุณูู ุฎูุงูุง ุงูุจูุงูุงุช
        for (let row = range.s.r + 1; row <= range.e.r; row++) {
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                if (!worksheet[cellAddress]) continue;

                worksheet[cellAddress].s = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "CCCCCC" } },
                        bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                        left: { style: "thin", color: { rgb: "CCCCCC" } },
                        right: { style: "thin", color: { rgb: "CCCCCC" } }
                    }
                };

                // ุชูุณูู ุฎุงุต ููุฃุฑูุงู
                if (typeof worksheet[cellAddress].v === 'number') {
                    worksheet[cellAddress].s.numFmt = '#,##0.00';
                }
            }
        }

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, title);

        // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ
        const infoSheet = XLSX.utils.aoa_to_sheet([
            ['ูุนูููุงุช ุงูุชูุฑูุฑ'],
            ['ุงูุนููุงู', title],
            ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', formatDateTime(new Date().toISOString())],
            ['ุนุฏุฏ ุงูุณุฌูุงุช', data.length],
            [''],
            ['ูุนูููุงุช ุงููุทูุฑ'],
            ['ุงูุงุณู', 'MOHANNAD AHMAD'],
            ['ุงููุงุชู', '+963-998-171-954'],
            ['ุงูุจุฑูุงูุฌ', 'SAM PRO - ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู'],
            ['ุงูุณูุฉ', 'ยฉ 2025']
        ]);
        XLSX.utils.book_append_sheet(workbook, infoSheet, 'ูุนูููุงุช');

        // ุญูุธ ุงูููู
        const fileName = `${title.replace(/\s+/g, '_')}_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ Excel ุจูุฌุงุญ:', fileName);
        showSuccessToast('ุชู ุชุตุฏูุฑ Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุญุณูุฉ
 */
function showErrorToast(message) {
    console.error('โ ุฎุทุฃ:', message);

    // ุฅูุดุงุก ุนูุตุฑ ุงูุชูุจูู
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);

    // ุฅุธูุงุฑ ุงูุชูุจูู
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    bsToast.show();

    // ุฅุฒุงูุฉ ุงูุนูุตุฑ ุจุนุฏ ุงูุฅุฎูุงุก
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}

/**
 * ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑ ูุญุณูุฉ
 */
function showWarningToast(message) {
    console.warn('โ๏ธ ุชุญุฐูุฑ:', message);

    // ุฅูุดุงุก ุนูุตุฑ ุงูุชูุจูู
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-dark bg-warning border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);

    // ุฅุธูุงุฑ ุงูุชูุจูู
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
    });
    bsToast.show();

    // ุฅุฒุงูุฉ ุงูุนูุตุฑ ุจุนุฏ ุงูุฅุฎูุงุก
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}

/**
 * ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุญุณูุฉ
 */
function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    setTimeout(() => {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 5000);
}

/**
 * ุฅุธูุงุฑ ุฑุณุงูุฉ ูุนูููุงุช ูุญุณูุฉ
 */
function showInfoToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-info border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    setTimeout(() => {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 5000);
}

/**
 * ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููุฉ ูู ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function updateSalesReportCurrency() {
    const currencySelect = document.getElementById('salesReportCurrency');
    const conversionOptions = document.getElementById('currencyConversionOptions');

    if (!currencySelect || !conversionOptions) return;

    const selectedCurrency = currencySelect.value;

    if (selectedCurrency === 'ALL') {
        // ุฅุธูุงุฑ ุฎูุงุฑุงุช ุงูุชุญููู ุนูุฏ ุงุฎุชูุงุฑ ุฌููุน ุงูุนููุงุช
        conversionOptions.style.display = 'block';
    } else {
        // ุฅุฎูุงุก ุฎูุงุฑุงุช ุงูุชุญููู ุนูุฏ ุงุฎุชูุงุฑ ุนููุฉ ูุญุฏุฏุฉ
        conversionOptions.style.display = 'none';

        // ูุณุญ ุฎูุงุฑุงุช ุงูุชุญููู
        const convertToCurrency = document.getElementById('convertToCurrency');
        const conversionRate = document.getElementById('conversionRate');
        if (convertToCurrency) convertToCurrency.value = '';
        if (conversionRate) conversionRate.value = '';
    }
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุตุฑู ููุชุญููู
 */
function updateConversionRate() {
    const convertToCurrency = document.getElementById('convertToCurrency');
    const conversionRate = document.getElementById('conversionRate');
    const salesReportCurrency = document.getElementById('salesReportCurrency');

    if (!convertToCurrency || !conversionRate || !salesReportCurrency) return;

    const targetCurrency = convertToCurrency.value;
    const sourceCurrency = salesReportCurrency.value;

    if (!targetCurrency || sourceCurrency !== 'ALL') {
        conversionRate.value = '';
        return;
    }

    // ุงูุญุตูู ุนูู ุณุนุฑ ุงูุตุฑู ูู ุงูููุฑุฉ ุงูุณูุฑูุฉ ุฅูู ุงูุนููุฉ ุงููุณุชูุฏูุฉ
    const rate = getExchangeRate('SYP', targetCurrency);
    conversionRate.value = rate;
}

/**
 * ุฅูุดุงุก ุชูุฑูุฑ ุงููุจูุนุงุช ุงููุชูุฏู
 */
function generateAdvancedSalesReport() {
    console.log('๐ ุฅูุดุงุก ุชูุฑูุฑ ุงููุจูุนุงุช ุงููุชูุฏู...');

    // ุฌูุน ูุนุงููุฑ ุงูููุชุฑุฉ
    const fromDate = document.getElementById('salesReportFromDate')?.value;
    const toDate = document.getElementById('salesReportToDate')?.value;
    const currency = document.getElementById('salesReportCurrency')?.value;
    const customerId = document.getElementById('salesReportCustomer')?.value;
    const productId = document.getElementById('salesReportProduct')?.value;
    const status = document.getElementById('salesReportStatus')?.value;
    const convertToCurrency = document.getElementById('convertToCurrency')?.value;
    const conversionRate = parseFloat(document.getElementById('conversionRate')?.value) || 1;

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!fromDate || !toDate || !currency) {
        alert('ูุฑุฌู ุชุญุฏูุฏ ุงูุชุงุฑูุฎ ูุงูุนููุฉ');
        return;
    }

    if (new Date(fromDate) > new Date(toDate)) {
        alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
        return;
    }

    // ููุชุฑุฉ ุงูููุงุชูุฑ
    let filteredInvoices = [];

    if (appData.invoices) {
        filteredInvoices = appData.invoices.filter(invoice => {
            // ููุชุฑุฉ ุจุงูุชุงุฑูุฎ
            const invoiceDate = new Date(invoice.invoiceDate);
            const from = new Date(fromDate);
            const to = new Date(toDate);

            if (invoiceDate < from || invoiceDate > to) return false;

            // ููุชุฑุฉ ุจููุน ุงููุงุชูุฑุฉ (ูุจูุนุงุช ููุท)
            if (invoice.invoiceType !== 'sale') return false;

            // ููุชุฑุฉ ุจุงูุนููุฉ
            if (currency !== 'ALL' && invoice.currency !== currency) return false;

            // ููุชุฑุฉ ุจุงูุนููู
            if (customerId && invoice.customerId !== parseInt(customerId)) return false;

            // ููุชุฑุฉ ุจุงูุตูู
            if (productId) {
                const hasProduct = invoice.items && invoice.items.some(item =>
                    item.productId === parseInt(productId)
                );
                if (!hasProduct) return false;
            }

            // ููุชุฑุฉ ุจุงูุญุงูุฉ
            if (status) {
                const invoiceStatus = getInvoiceStatus(invoice);
                if (invoiceStatus !== status) return false;
            }

            return true;
        });
    }

    console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${filteredInvoices.length} ูุงุชูุฑุฉ`);

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const stats = calculateSalesStatistics(filteredInvoices, convertToCurrency, conversionRate);

    // ุนุฑุถ ุงููุชุงุฆุฌ
    displaySalesReport(filteredInvoices, stats, {
        fromDate, toDate, currency, convertToCurrency, conversionRate
    });

    console.log('โ ุชู ุฅูุดุงุก ุชูุฑูุฑ ุงููุจูุนุงุช ุงููุชูุฏู');
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงููุจูุนุงุช
 */
function calculateSalesStatistics(invoices, convertToCurrency, conversionRate) {
    const stats = {
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalInvoices: invoices.length,
        currencyBreakdown: {},
        statusBreakdown: { paid: 0, partial: 0, pending: 0 },
        convertedTotals: { total: 0, paid: 0, remaining: 0 }
    };

    invoices.forEach(invoice => {
        const currency = invoice.currency || 'SYP';
        const total = invoice.totalAmount || 0;
        const paid = invoice.paidAmount || 0;
        const remaining = total - paid;

        // ุชุฌููุน ุญุณุจ ุงูุนููุฉ
        if (!stats.currencyBreakdown[currency]) {
            stats.currencyBreakdown[currency] = {
                total: 0, paid: 0, remaining: 0, count: 0
            };
        }

        stats.currencyBreakdown[currency].total += total;
        stats.currencyBreakdown[currency].paid += paid;
        stats.currencyBreakdown[currency].remaining += remaining;
        stats.currencyBreakdown[currency].count++;

        // ุชุฌููุน ุญุณุจ ุงูุญุงูุฉ
        const status = getInvoiceStatus(invoice);
        stats.statusBreakdown[status]++;

        // ุงูุชุญููู ุฅุฐุง ูุงู ูุทููุจุงู
        if (convertToCurrency && conversionRate > 0) {
            let convertedTotal = total;
            let convertedPaid = paid;
            let convertedRemaining = remaining;

            if (currency !== convertToCurrency) {
                // ุชุญููู ูู ุงูุนููุฉ ุงูุฃุตููุฉ ุฅูู ุงูููุฑุฉ ุงูุณูุฑูุฉ ุซู ุฅูู ุงูุนููุฉ ุงููุณุชูุฏูุฉ
                const toSyp = getExchangeRate(currency, 'SYP');
                const toTarget = getExchangeRate('SYP', convertToCurrency);
                const finalRate = toSyp * toTarget;

                convertedTotal = total * finalRate;
                convertedPaid = paid * finalRate;
                convertedRemaining = remaining * finalRate;
            }

            stats.convertedTotals.total += convertedTotal;
            stats.convertedTotals.paid += convertedPaid;
            stats.convertedTotals.remaining += convertedRemaining;
        }
    });

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุงูุนุงูุฉ
    Object.values(stats.currencyBreakdown).forEach(breakdown => {
        stats.totalAmount += breakdown.total;
        stats.totalPaid += breakdown.paid;
        stats.totalRemaining += breakdown.remaining;
    });

    return stats;
}

/**
 * ุนุฑุถ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function displaySalesReport(invoices, stats, filters) {
    // ุฅุธูุงุฑ ูุณู ุงูุชูุฑูุฑ
    const summarySection = document.getElementById('salesReportSummary');
    const noDataSection = document.getElementById('noSalesData');

    if (summarySection) summarySection.style.display = 'block';
    if (noDataSection) noDataSection.style.display = 'none';

    // ุชุญุฏูุซ ููุฎุต ุงูุนููุงุช
    updateSalesCurrencySummary(stats.currencyBreakdown);

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุฑุฆูุณูุฉ
    updateSalesMainStats(stats, filters);

    // ุชุญุฏูุซ ุฌุฏูู ุงูุชูุงุตูู
    updateSalesReportTable(invoices, filters);

    // ุชุญุฏูุซ ูุนูููุงุช ุงูุชูุฑูุฑ
    updateSalesReportInfo(filters, stats);
}

/**
 * ุชุญุฏูุซ ููุฎุต ุงูุนููุงุช ูู ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function updateSalesCurrencySummary(currencyBreakdown) {
    const container = document.getElementById('salesCurrencySummary');
    if (!container) return;

    const currencies = Object.keys(currencyBreakdown);
    if (currencies.length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุนุฑุถ</div></div>';
        return;
    }

    let html = '';
    currencies.forEach(currency => {
        const data = currencyBreakdown[currency];
        const symbol = getCurrencySymbol(currency);
        const name = getCurrencyName(currency);

        html += `
            <div class="col-md-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body text-center">
                        <h6 class="card-title text-primary">${name}</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">ุฅุฌูุงูู</small>
                                <div class="fw-bold">${formatCurrency(data.total)} ${symbol}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ููุงุชูุฑ</small>
                                <div class="fw-bold text-primary">${data.count}</div>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-success">ูุฏููุน: ${formatCurrency(data.paid)} ${symbol}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-danger">ูุชุจูู: ${formatCurrency(data.remaining)} ${symbol}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

/**
 * ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุฑุฆูุณูุฉ
 */
function updateSalesMainStats(stats, filters) {
    // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุจูุนุงุช
    const totalSalesElement = document.getElementById('totalSalesAmount');
    const totalCurrencyElement = document.getElementById('totalSalesCurrency');

    if (filters.convertToCurrency && stats.convertedTotals.total > 0) {
        if (totalSalesElement) totalSalesElement.textContent = formatCurrency(stats.convertedTotals.total);
        if (totalCurrencyElement) totalCurrencyElement.textContent = getCurrencySymbol(filters.convertToCurrency);
    } else if (filters.currency !== 'ALL') {
        const currencyData = stats.currencyBreakdown[filters.currency];
        if (currencyData && totalSalesElement) {
            totalSalesElement.textContent = formatCurrency(currencyData.total);
            if (totalCurrencyElement) totalCurrencyElement.textContent = getCurrencySymbol(filters.currency);
        }
    } else {
        if (totalSalesElement) totalSalesElement.textContent = 'ูุชุนุฏุฏ ุงูุนููุงุช';
        if (totalCurrencyElement) totalCurrencyElement.textContent = 'ูุชุนุฏุฏ';
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูููุงุชูุฑ
    const invoicesCountElement = document.getElementById('totalInvoicesCount');
    const invoicesDateRangeElement = document.getElementById('invoicesDateRange');
    if (invoicesCountElement) invoicesCountElement.textContent = stats.totalInvoices;
    if (invoicesDateRangeElement) {
        invoicesDateRangeElement.textContent = `${filters.fromDate} - ${filters.toDate}`;
    }

    // ุชุญุฏูุซ ูุชูุณุท ุงููุงุชูุฑุฉ
    const averageElement = document.getElementById('averageInvoiceAmount');
    const averageCurrencyElement = document.getElementById('averageCurrency');
    if (stats.totalInvoices > 0) {
        if (filters.convertToCurrency && stats.convertedTotals.total > 0) {
            const average = stats.convertedTotals.total / stats.totalInvoices;
            if (averageElement) averageElement.textContent = formatCurrency(average);
            if (averageCurrencyElement) averageCurrencyElement.textContent = getCurrencySymbol(filters.convertToCurrency);
        } else {
            if (averageElement) averageElement.textContent = 'ูุชุนุฏุฏ ุงูุนููุงุช';
            if (averageCurrencyElement) averageCurrencyElement.textContent = '-';
        }
    }

    // ุชุญุฏูุซ ุงููุจูุบ ุงููุนูู ูุงููุฏููุน
    const pendingElement = document.getElementById('pendingSalesAmount');
    const paidElement = document.getElementById('paidSalesAmount');
    const pendingCurrencyElement = document.getElementById('pendingCurrency');
    const paidCurrencyElement = document.getElementById('paidCurrency');

    if (filters.convertToCurrency && stats.convertedTotals.total > 0) {
        if (pendingElement) pendingElement.textContent = formatCurrency(stats.convertedTotals.remaining);
        if (paidElement) paidElement.textContent = formatCurrency(stats.convertedTotals.paid);
        if (pendingCurrencyElement) pendingCurrencyElement.textContent = getCurrencySymbol(filters.convertToCurrency);
        if (paidCurrencyElement) paidCurrencyElement.textContent = getCurrencySymbol(filters.convertToCurrency);
    } else {
        if (pendingElement) pendingElement.textContent = 'ูุชุนุฏุฏ';
        if (paidElement) paidElement.textContent = 'ูุชุนุฏุฏ';
        if (pendingCurrencyElement) pendingCurrencyElement.textContent = 'ุนููุงุช';
        if (paidCurrencyElement) paidCurrencyElement.textContent = 'ุนููุงุช';
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูุนููุงุช
    const currenciesCountElement = document.getElementById('currenciesCount');
    if (currenciesCountElement) {
        currenciesCountElement.textContent = Object.keys(stats.currencyBreakdown).length;
    }
}

/**
 * ุชุญุฏูุซ ุฌุฏูู ุชูุงุตูู ุงููุจูุนุงุช
 */
function updateSalesReportTable(invoices, filters) {
    const tableBody = document.getElementById('salesReportTable');
    if (!tableBody) return;

    if (invoices.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">ูุง ุชูุฌุฏ ููุงุชูุฑ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</td></tr>';
        return;
    }

    let html = '';
    let totalAmount = 0;
    let totalPaid = 0;
    let totalRemaining = 0;
    let totalConverted = 0;

    invoices.forEach(invoice => {
        const customer = appData.customers?.find(c => c.id === invoice.customerId);
        const currency = invoice.currency || 'SYP';
        const total = invoice.totalAmount || 0;
        const paid = invoice.paidAmount || 0;
        const remaining = total - paid;
        const status = getInvoiceStatus(invoice);

        // ุญุณุงุจ ุงููุจูุบ ุงููุญูู
        let convertedAmount = total;
        if (filters.convertToCurrency && currency !== filters.convertToCurrency) {
            const rate = getExchangeRate(currency, filters.convertToCurrency);
            convertedAmount = total * rate;
        }

        totalAmount += total;
        totalPaid += paid;
        totalRemaining += remaining;
        totalConverted += convertedAmount;

        const statusClass = status === 'paid' ? 'success' : status === 'partial' ? 'warning' : 'danger';
        const statusText = status === 'paid' ? 'ูุฏููุนุฉ' : status === 'partial' ? 'ุฌุฒุฆูุฉ' : 'ูุนููุฉ';

        html += `
            <tr>
                <td><strong>${invoice.invoiceNumber}</strong></td>
                <td>${formatDate(invoice.invoiceDate)}</td>
                <td>${customer ? customer.name : 'ุนููู ูุญุฐูู'}</td>
                <td>${formatCurrency(total)}</td>
                <td><span class="badge bg-primary">${getCurrencySymbol(currency)}</span></td>
                <td class="text-success">${formatCurrency(paid)}</td>
                <td class="text-danger">${formatCurrency(remaining)}</td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                <td class="text-info">${filters.convertToCurrency ? formatCurrency(convertedAmount) + ' ' + getCurrencySymbol(filters.convertToCurrency) : '-'}</td>
            </tr>
        `;
    });

    tableBody.innerHTML = html;

    // ุชุญุฏูุซ ุงูุฅุฌูุงููุงุช ูู ุงูุชุฐููู
    const totalAmountElement = document.getElementById('salesTableTotalAmount');
    const totalPaidElement = document.getElementById('salesTableTotalPaid');
    const totalRemainingElement = document.getElementById('salesTableTotalRemaining');
    const convertedTotalElement = document.getElementById('salesTableConvertedTotal');
    const currencyMixElement = document.getElementById('salesTableCurrencyMix');
    const statusSummaryElement = document.getElementById('salesTableStatusSummary');

    if (totalAmountElement) totalAmountElement.textContent = formatCurrency(totalAmount);
    if (totalPaidElement) totalPaidElement.textContent = formatCurrency(totalPaid);
    if (totalRemainingElement) totalRemainingElement.textContent = formatCurrency(totalRemaining);
    if (convertedTotalElement) {
        convertedTotalElement.textContent = filters.convertToCurrency ?
            formatCurrency(totalConverted) + ' ' + getCurrencySymbol(filters.convertToCurrency) : '-';
    }
    if (currencyMixElement) {
        const currencies = [...new Set(invoices.map(inv => inv.currency || 'SYP'))];
        currencyMixElement.textContent = currencies.length === 1 ? getCurrencySymbol(currencies[0]) : 'ูุชุนุฏุฏ';
    }
    if (statusSummaryElement) {
        statusSummaryElement.textContent = `${invoices.length} ูุงุชูุฑุฉ`;
    }
}

/**
 * ุชุญุฏูุซ ูุนูููุงุช ุงูุชูุฑูุฑ
 */
function updateSalesReportInfo(filters, stats) {
    // ุชุญุฏูุซ ูุนูููุงุช ุงููุชุฑุฉ
    const reportPeriodElement = document.getElementById('reportPeriod');
    if (reportPeriodElement) {
        reportPeriodElement.textContent = `${filters.fromDate} ุฅูู ${filters.toDate}`;
    }

    // ุชุญุฏูุซ ุงูุนููุฉ ุงููุญุฏุฏุฉ
    const selectedCurrencyElement = document.getElementById('selectedCurrency');
    if (selectedCurrencyElement) {
        if (filters.currency === 'ALL') {
            selectedCurrencyElement.textContent = 'ุฌููุน ุงูุนููุงุช';
        } else {
            selectedCurrencyElement.textContent = getCurrencyName(filters.currency);
        }
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงูููุงุชูุฑ
    const reportInvoicesCountElement = document.getElementById('reportInvoicesCount');
    if (reportInvoicesCountElement) {
        reportInvoicesCountElement.textContent = stats.totalInvoices;
    }

    // ุชุญุฏูุซ ููุช ุงูุชุญุฏูุซ
    const reportLastUpdateElement = document.getElementById('reportLastUpdate');
    if (reportLastUpdateElement) {
        reportLastUpdateElement.textContent = formatDateTime(new Date());
    }

    // ุชุญุฏูุซ ูุนูููุงุช ุงูุชุญููู
    const conversionInfo = document.getElementById('conversionInfo');
    const targetCurrencyInfo = document.getElementById('targetCurrencyInfo');
    const exchangeRateInfo = document.getElementById('exchangeRateInfo');
    const rateDate = document.getElementById('rateDate');

    if (filters.convertToCurrency && conversionInfo) {
        conversionInfo.style.display = 'block';
        if (targetCurrencyInfo) {
            targetCurrencyInfo.textContent = getCurrencyName(filters.convertToCurrency);
        }
        if (exchangeRateInfo) {
            exchangeRateInfo.textContent = filters.conversionRate;
        }
        if (rateDate) {
            rateDate.textContent = formatDate(new Date());
        }
    } else if (conversionInfo) {
        conversionInfo.style.display = 'none';
    }
}

/**
 * ุงูุญุตูู ุนูู ุญุงูุฉ ุงููุงุชูุฑุฉ
 */
function getInvoiceStatus(invoice) {
    const total = invoice.totalAmount || 0;
    const paid = invoice.paidAmount || 0;

    if (paid >= total) return 'paid';
    if (paid > 0) return 'partial';
    return 'pending';
}

/**
 * ูุณุญ ููุงุชุฑ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function clearSalesReportFilters() {
    const elements = [
        'salesReportFromDate', 'salesReportToDate', 'salesReportCurrency',
        'salesReportCustomer', 'salesReportProduct', 'salesReportStatus',
        'convertToCurrency', 'conversionRate'
    ];

    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = '';
        }
    });

    // ุฅุฎูุงุก ุฎูุงุฑุงุช ุงูุชุญููู
    const conversionOptions = document.getElementById('currencyConversionOptions');
    if (conversionOptions) {
        conversionOptions.style.display = 'none';
    }

    // ุฅุฎูุงุก ุงูุชูุฑูุฑ
    const summarySection = document.getElementById('salesReportSummary');
    const noDataSection = document.getElementById('noSalesData');

    if (summarySection) summarySection.style.display = 'none';
    if (noDataSection) noDataSection.style.display = 'block';
}

/**
 * ูุนุงููุฉ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function previewSalesReport() {
    const summarySection = document.getElementById('salesReportSummary');
    if (!summarySection || summarySection.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ูุนุงููุฉ
    const previewWindow = window.open('', '_blank', 'width=1200,height=800');
    const reportContent = summarySection.innerHTML;

    previewWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ูุนุงููุฉ ุชูุฑูุฑ ุงููุจูุนุงุช</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .print-header { text-align: center; margin-bottom: 30px; }
                @media print {
                    .no-print { display: none !important; }
                }
            </style>
        </head>
        <body>
            <div class="container-fluid">
                <div class="print-header">
                    <h2>ุชูุฑูุฑ ุงููุจูุนุงุช ุงููุชูุฏู</h2>
                    <p class="text-muted">ุชู ุฅูุดุงุคู ูู: ${formatDateTime(new Date())}</p>
                </div>
                ${reportContent}
                <div class="no-print mt-4 text-center">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>
                    <button class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-times me-2"></i>ุฅุบูุงู
                    </button>
                </div>
            </div>
        </body>
        </html>
    `);

    previewWindow.document.close();
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function printSalesReport() {
    previewSalesReport();
}

/**
 * ุชุตุฏูุฑ ุชูุฑูุฑ ุงููุจูุนุงุช
 */
function exportSalesReport(format) {
    const summarySection = document.getElementById('salesReportSummary');
    if (!summarySection || summarySection.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    if (format === 'excel') {
        exportSalesReportToExcel();
    } else if (format === 'pdf') {
        exportSalesReportToPDF();
    } else if (format === 'print') {
        printSalesReport();
    }
}



/**
 * ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููุฉ ูู ุชูุฑูุฑ ุงููุดุชุฑูุงุช
 */
function updatePurchaseReportCurrency() {
    const currencySelect = document.getElementById('purchaseReportCurrency');
    const conversionOptions = document.getElementById('purchaseCurrencyConversionOptions');

    if (!currencySelect || !conversionOptions) return;

    const selectedCurrency = currencySelect.value;

    if (selectedCurrency === 'ALL') {
        conversionOptions.style.display = 'block';
    } else {
        conversionOptions.style.display = 'none';

        const convertToCurrency = document.getElementById('purchaseConvertToCurrency');
        const conversionRate = document.getElementById('purchaseConversionRate');
        if (convertToCurrency) convertToCurrency.value = '';
        if (conversionRate) conversionRate.value = '';
    }
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุตุฑู ููุชุญููู ูู ุชูุฑูุฑ ุงููุดุชุฑูุงุช
 */
function updatePurchaseConversionRate() {
    const convertToCurrency = document.getElementById('purchaseConvertToCurrency');
    const conversionRate = document.getElementById('purchaseConversionRate');
    const purchaseReportCurrency = document.getElementById('purchaseReportCurrency');

    if (!convertToCurrency || !conversionRate || !purchaseReportCurrency) return;

    const targetCurrency = convertToCurrency.value;
    const sourceCurrency = purchaseReportCurrency.value;

    if (!targetCurrency || sourceCurrency !== 'ALL') {
        conversionRate.value = '';
        return;
    }

    const rate = getExchangeRate('SYP', targetCurrency);
    conversionRate.value = rate;
}

/**
 * ุฅูุดุงุก ุชูุฑูุฑ ุงููุดุชุฑูุงุช ุงููุชูุฏู
 */
function generateAdvancedPurchaseReport() {
    console.log('๐ ุฅูุดุงุก ุชูุฑูุฑ ุงููุดุชุฑูุงุช ุงููุชูุฏู...');

    // ุฌูุน ูุนุงููุฑ ุงูููุชุฑุฉ
    const fromDate = document.getElementById('purchaseReportFromDate')?.value;
    const toDate = document.getElementById('purchaseReportToDate')?.value;
    const currency = document.getElementById('purchaseReportCurrency')?.value;
    const supplierId = document.getElementById('purchaseReportSupplier')?.value;
    const productId = document.getElementById('purchaseReportProduct')?.value;
    const status = document.getElementById('purchaseReportStatus')?.value;
    const convertToCurrency = document.getElementById('purchaseConvertToCurrency')?.value;
    const conversionRate = parseFloat(document.getElementById('purchaseConversionRate')?.value) || 1;

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!fromDate || !toDate || !currency) {
        alert('ูุฑุฌู ุชุญุฏูุฏ ุงูุชุงุฑูุฎ ูุงูุนููุฉ');
        return;
    }

    if (new Date(fromDate) > new Date(toDate)) {
        alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
        return;
    }

    // ููุชุฑุฉ ุงูููุงุชูุฑ
    let filteredInvoices = [];

    if (appData.invoices) {
        filteredInvoices = appData.invoices.filter(invoice => {
            // ููุชุฑุฉ ุจุงูุชุงุฑูุฎ
            const invoiceDate = new Date(invoice.invoiceDate);
            const from = new Date(fromDate);
            const to = new Date(toDate);

            if (invoiceDate < from || invoiceDate > to) return false;

            // ููุชุฑุฉ ุจููุน ุงููุงุชูุฑุฉ (ูุดุชุฑูุงุช ููุท)
            if (invoice.invoiceType !== 'purchase') return false;

            // ููุชุฑุฉ ุจุงูุนููุฉ
            if (currency !== 'ALL' && invoice.currency !== currency) return false;

            // ููุชุฑุฉ ุจุงูููุฑุฏ
            if (supplierId && invoice.supplierId !== parseInt(supplierId)) return false;

            // ููุชุฑุฉ ุจุงูุตูู
            if (productId) {
                const hasProduct = invoice.items && invoice.items.some(item =>
                    item.productId === parseInt(productId)
                );
                if (!hasProduct) return false;
            }

            // ููุชุฑุฉ ุจุงูุญุงูุฉ
            if (status) {
                const invoiceStatus = getInvoiceStatus(invoice);
                if (invoiceStatus !== status) return false;
            }

            return true;
        });
    }

    console.log(`๐ ุชู ุงูุนุซูุฑ ุนูู ${filteredInvoices.length} ูุงุชูุฑุฉ ูุดุชุฑูุงุช`);

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const stats = calculatePurchaseStatistics(filteredInvoices, convertToCurrency, conversionRate);

    // ุนุฑุถ ุงููุชุงุฆุฌ
    displayPurchaseReport(filteredInvoices, stats, {
        fromDate, toDate, currency, convertToCurrency, conversionRate
    });

    console.log('โ ุชู ุฅูุดุงุก ุชูุฑูุฑ ุงููุดุชุฑูุงุช ุงููุชูุฏู');
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงููุดุชุฑูุงุช
 */
function calculatePurchaseStatistics(invoices, convertToCurrency, conversionRate) {
    const stats = {
        totalAmount: 0,
        totalPaid: 0,
        totalRemaining: 0,
        totalInvoices: invoices.length,
        currencyBreakdown: {},
        statusBreakdown: { paid: 0, partial: 0, pending: 0 },
        convertedTotals: { total: 0, paid: 0, remaining: 0 }
    };

    invoices.forEach(invoice => {
        const currency = invoice.currency || 'SYP';
        const total = invoice.totalAmount || 0;
        const paid = invoice.paidAmount || 0;
        const remaining = total - paid;

        // ุชุฌููุน ุญุณุจ ุงูุนููุฉ
        if (!stats.currencyBreakdown[currency]) {
            stats.currencyBreakdown[currency] = {
                total: 0, paid: 0, remaining: 0, count: 0
            };
        }

        stats.currencyBreakdown[currency].total += total;
        stats.currencyBreakdown[currency].paid += paid;
        stats.currencyBreakdown[currency].remaining += remaining;
        stats.currencyBreakdown[currency].count++;

        // ุชุฌููุน ุญุณุจ ุงูุญุงูุฉ
        const status = getInvoiceStatus(invoice);
        stats.statusBreakdown[status]++;

        // ุงูุชุญููู ุฅุฐุง ูุงู ูุทููุจุงู
        if (convertToCurrency && conversionRate > 0) {
            let convertedTotal = total;
            let convertedPaid = paid;
            let convertedRemaining = remaining;

            if (currency !== convertToCurrency) {
                const toSyp = getExchangeRate(currency, 'SYP');
                const toTarget = getExchangeRate('SYP', convertToCurrency);
                const finalRate = toSyp * toTarget;

                convertedTotal = total * finalRate;
                convertedPaid = paid * finalRate;
                convertedRemaining = remaining * finalRate;
            }

            stats.convertedTotals.total += convertedTotal;
            stats.convertedTotals.paid += convertedPaid;
            stats.convertedTotals.remaining += convertedRemaining;
        }
    });

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุงูุนุงูุฉ
    Object.values(stats.currencyBreakdown).forEach(breakdown => {
        stats.totalAmount += breakdown.total;
        stats.totalPaid += breakdown.paid;
        stats.totalRemaining += breakdown.remaining;
    });

    return stats;
}

/**
 * ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ ูุน ุงูุชุญูู ูู ุงูุจูุงูุงุช
 */
function addWarehouseWithValidation() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addWarehouseModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-warehouse me-2"></i>
                        ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addWarehouseForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-tag me-2"></i>
                                ุงุณู ุงููุฎุฒู *
                            </label>
                            <input type="text" class="form-control" id="newWarehouseName" required>
                            <div class="form-text">ูุฌุจ ุฃู ูููู ุงูุงุณู ูุฑูุฏุงู</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                ุงููููุน
                            </label>
                            <input type="text" class="form-control" id="newWarehouseLocation">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>
                                ุงููุฏูุฑ
                            </label>
                            <input type="text" class="form-control" id="newWarehouseManager">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-phone me-2"></i>
                                ุฑูู ุงููุงุชู
                            </label>
                            <input type="tel" class="form-control" id="newWarehousePhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-sticky-note me-2"></i>
                                ููุงุญุธุงุช
                            </label>
                            <textarea class="form-control" id="newWarehouseNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ุฅูุบุงุก
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveNewWarehouse()">
                        <i class="fas fa-save me-2"></i>ุญูุธ ุงููุฎุฒู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุญูุธ ุงููุฎุฒู ุงูุฌุฏูุฏ
 */
function saveNewWarehouse() {
    const name = document.getElementById('newWarehouseName').value.trim();
    const location = document.getElementById('newWarehouseLocation').value.trim();
    const manager = document.getElementById('newWarehouseManager').value.trim();
    const phone = document.getElementById('newWarehousePhone').value.trim();
    const notes = document.getElementById('newWarehouseNotes').value.trim();

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!name) {
        alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุฎุฒู');
        return;
    }

    // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
    const existingWarehouse = appData.warehouses.find(w => w.name.toLowerCase() === name.toLowerCase());
    if (existingWarehouse) {
        alert('ููุฌุฏ ูุฎุฒู ุขุฎุฑ ุจููุณ ุงูุงุณู');
        return;
    }

    // ุฅูุดุงุก ุงููุฎุฒู ุงูุฌุฏูุฏ
    const newWarehouse = {
        id: Date.now(),
        name: name,
        location: location,
        manager: manager,
        phone: phone,
        notes: notes,
        isActive: true,
        createdAt: new Date().toISOString()
    };

    // ุฅุถุงูุฉ ุงููุฎุฒู
    if (!appData.warehouses) {
        appData.warehouses = [];
    }
    appData.warehouses.push(newWarehouse);

    // ุญูุธ ุงูุจูุงูุงุช
    saveData();

    // ุฅุบูุงู ุงููุงูุฐุฉ
    const modal = bootstrap.Modal.getInstance(document.getElementById('addWarehouseModal'));
    modal.hide();

    // ุชุญุฏูุซ ุงูุตูุญุฉ
    showPage('warehouses');

    // ุฑุณุงูุฉ ูุฌุงุญ
    alert(`โ ุชู ุฅุถุงูุฉ ุงููุฎุฒู "${name}" ุจูุฌุงุญ!`);
    console.log(`๐ฆ ุชู ุฅุถุงูุฉ ูุฎุฒู ุฌุฏูุฏ: ${name} (ID: ${newWarehouse.id})`);
}

/**
 * ุนุฑุถ ุชูุงุตูู ุงููุฎุฒู
 */
function viewWarehouseDetails(warehouseId) {
    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุฎุฒู');
        return;
    }

    const relatedProducts = appData.products ? appData.products.filter(p => p.warehouseId === warehouseId) : [];
    const relatedMovements = appData.inventoryMovements ?
        appData.inventoryMovements.filter(mov => mov.warehouseId === warehouseId) : [];

    const totalValue = relatedProducts.reduce((sum, product) =>
        sum + ((product.quantity || 0) * (product.costPrice || 0)), 0);

    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'warehouseDetailsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-warehouse me-2"></i>
                        ุชูุงุตูู ุงููุฎุฒู: ${warehouse.name}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h6>
                            <table class="table table-sm">
                                <tr><td><strong>ุงูุงุณู:</strong></td><td>${warehouse.name}</td></tr>
                                <tr><td><strong>ุงููููุน:</strong></td><td>${warehouse.location || 'ุบูุฑ ูุญุฏุฏ'}</td></tr>
                                <tr><td><strong>ุงููุฏูุฑ:</strong></td><td>${warehouse.manager || 'ุบูุฑ ูุญุฏุฏ'}</td></tr>
                                <tr><td><strong>ุงููุงุชู:</strong></td><td>${warehouse.phone || 'ุบูุฑ ูุญุฏุฏ'}</td></tr>
                                <tr><td><strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong></td><td>${formatDate(warehouse.createdAt)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-bar me-2"></i>ุงูุฅุญุตุงุฆูุงุช</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                                            <h5 class="text-primary">${relatedProducts.length}</h5>
                                            <small>ุตูู</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                                            <h5 class="text-success">${formatCurrency(totalValue)}</h5>
                                            <small>ูููุฉ ุงููุฎุฒูู</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${warehouse.notes ? `
                    <div class="mb-3">
                        <h6><i class="fas fa-sticky-note me-2"></i>ุงูููุงุญุธุงุช</h6>
                        <div class="alert alert-light">${warehouse.notes}</div>
                    </div>
                    ` : ''}

                    <div class="mb-3">
                        <h6><i class="fas fa-boxes me-2"></i>ุงูุฃุตูุงู ูู ุงููุฎุฒู (${relatedProducts.length})</h6>
                        ${relatedProducts.length > 0 ? `
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ุงูุตูู</th>
                                        <th>ุงููููุฉ</th>
                                        <th>ุงููุญุฏุฉ</th>
                                        <th>ุณุนุฑ ุงูุชูููุฉ</th>
                                        <th>ุงููููุฉ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${relatedProducts.map(product => `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${product.quantity || 0}</td>
                                        <td>${product.unit || 'ูุทุนุฉ'}</td>
                                        <td>${formatCurrency(product.costPrice || 0)}</td>
                                        <td>${formatCurrency((product.quantity || 0) * (product.costPrice || 0))}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : '<div class="alert alert-info">ูุง ุชูุฌุฏ ุฃุตูุงู ูู ูุฐุง ุงููุฎุฒู</div>'}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ุฅุบูุงู
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editWarehouse(${warehouseId}); bootstrap.Modal.getInstance(document.getElementById('warehouseDetailsModal')).hide();">
                        <i class="fas fa-edit me-2"></i>ุชุนุฏูู
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function initializeCreateCustomInvoicePage() {
    console.log('๐ ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ...');

    // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู
    const today = new Date().toISOString().split('T')[0];
    const invoiceDateInput = document.getElementById('customInvoiceDate');
    if (invoiceDateInput) {
        invoiceDateInput.value = today;
    }

    // ุชุนููู ุชุงุฑูุฎ ุงูุงุณุชุญูุงู (30 ููู ูู ุงูููู)
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    const dueDateInput = document.getElementById('customDueDate');
    if (dueDateInput) {
        dueDateInput.value = dueDate.toISOString().split('T')[0];
    }

    // ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ
    updateCustomCurrencyDisplay();

    console.log('โ ุชู ุชููุฆุฉ ุตูุญุฉ ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ');
}

/**
 * ุชุจุฏูู ููุน ุฅุฏุฎุงู ุงูุนููู/ุงูููุฑุฏ
 */
function toggleClientInputType() {
    const existingClientRadio = document.getElementById('existingClient');
    const manualClientRadio = document.getElementById('manualClient');
    const existingClientSection = document.getElementById('existingClientSection');
    const manualClientSection = document.getElementById('manualClientSection');

    if (existingClientRadio && existingClientRadio.checked) {
        existingClientSection.style.display = 'block';
        manualClientSection.style.display = 'none';

        // ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ
        clearManualClientData();
    } else if (manualClientRadio && manualClientRadio.checked) {
        existingClientSection.style.display = 'none';
        manualClientSection.style.display = 'block';

        // ูุณุญ ุงุฎุชูุงุฑ ุงูุนููู ูู ุงููุงุฆูุฉ
        const customClientSelect = document.getElementById('customClientSelect');
        if (customClientSelect) {
            customClientSelect.value = '';
        }

        // ูุณุญ ูุนูููุงุช ุงูุนููู
        const customClientInfo = document.getElementById('customClientInfo');
        if (customClientInfo) {
            customClientInfo.innerHTML = 'ุณูุชู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ ูุฏููุงู';
        }
    }
}

/**
 * ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ ููุนููู
 */
function clearManualClientData() {
    const fields = [
        'manualClientName', 'manualClientPhone', 'manualClientEmail',
        'manualClientAddress', 'manualClientTaxNumber'
    ];

    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });

    // ุฅุนุงุฏุฉ ุชุนููู ุงูุนููุฉ ุฅูู ุงูุงูุชุฑุงุถูุฉ
    const manualClientCurrency = document.getElementById('manualClientCurrency');
    if (manualClientCurrency) {
        manualClientCurrency.value = 'SYP';
    }
}

/**
 * ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูุนููู/ุงูููุฑุฏ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function updateCustomClientOptions() {
    const invoiceType = document.getElementById('customInvoiceType')?.value;
    const clientSelect = document.getElementById('customClientSelect');
    const clientLabel = document.getElementById('customClientLabel');

    if (!clientSelect || !clientLabel) return;

    // ุชุญุฏูุซ ุงูุชุณููุฉ
    if (invoiceType === 'sale') {
        clientLabel.textContent = 'ุงูุนููู';
    } else if (invoiceType === 'purchase') {
        clientLabel.textContent = 'ุงูููุฑุฏ';
    } else {
        clientLabel.textContent = 'ุงูุนููู/ุงูููุฑุฏ';
    }

    // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ
    clientSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ</option>';

    // ุฅุถุงูุฉ ุงูุฎูุงุฑุงุช ุงูููุงุณุจุฉ
    if (invoiceType === 'sale' && appData.customers) {
        appData.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            clientSelect.appendChild(option);
        });
    } else if (invoiceType === 'purchase' && appData.suppliers) {
        appData.suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier.id;
            option.textContent = supplier.name;
            clientSelect.appendChild(option);
        });
    }

    // ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ
    updateCustomInvoiceNumber();
}

/**
 * ุชุญุฏูุซ ุฑูู ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function updateCustomInvoiceNumber() {
    const invoiceType = document.getElementById('customInvoiceType')?.value;
    const invoiceNumberInput = document.getElementById('customInvoiceNumber');

    if (!invoiceNumberInput || !invoiceType) return;

    // ุฅูุดุงุก ุฑูู ูุงุชูุฑุฉ ุฎุงุต
    const prefix = invoiceType === 'sale' ? 'CS' : 'CP'; // Custom Sale / Custom Purchase
    const timestamp = Date.now();
    const randomNum = Math.floor(Math.random() * 1000);

    const invoiceNumber = `${prefix}-${timestamp}-${randomNum}`;
    invoiceNumberInput.value = invoiceNumber;
}

/**
 * ุชุญุฏูุซ ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function updateCustomClientInfo() {
    const invoiceType = document.getElementById('customInvoiceType')?.value;
    const clientSelect = document.getElementById('customClientSelect');
    const clientInfo = document.getElementById('customClientInfo');
    const customInvoiceCurrency = document.getElementById('customInvoiceCurrency');

    if (!clientSelect || !clientInfo) return;

    const clientId = parseInt(clientSelect.value);
    if (!clientId) {
        clientInfo.innerHTML = 'ุงุฎุชุฑ ุงูุนููู/ุงูููุฑุฏ ูุนุฑุถ ุงููุนูููุงุช';
        return;
    }

    // ุงูุจุญุซ ุนู ุงูุนููู/ุงูููุฑุฏ
    let client = null;
    if (invoiceType === 'sale') {
        client = appData.customers?.find(c => c.id === clientId);
    } else if (invoiceType === 'purchase') {
        client = appData.suppliers?.find(s => s.id === clientId);
    }

    if (!client) {
        clientInfo.innerHTML = '<span class="text-danger">ุงูุนููู/ุงูููุฑุฏ ุบูุฑ ููุฌูุฏ</span>';
        return;
    }

    // ุชุญุฏูุซ ุนููุฉ ุงููุงุชูุฑุฉ ุฅูู ุนููุฉ ุงูุนููู/ุงูููุฑุฏ ุงูุงูุชุฑุงุถูุฉ
    if (client.currency && customInvoiceCurrency) {
        customInvoiceCurrency.value = client.currency;
        updateCustomCurrencyDisplay();
    }

    // ุนุฑุถ ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ
    const balance = client.currentBalance || 0;
    const balanceText = balance > 0 ?
        `<span class="text-danger">${formatCurrency(Math.abs(balance))} ${getCurrencySymbol(client.currency || 'SYP')} (ูุฏูู)</span>` :
        balance < 0 ?
        `<span class="text-success">${formatCurrency(Math.abs(balance))} ${getCurrencySymbol(client.currency || 'SYP')} (ุฏุงุฆู)</span>` :
        `<span class="text-muted">${formatCurrency(0)} ${getCurrencySymbol(client.currency || 'SYP')} (ูุชูุงุฒู)</span>`;

    const creditLimit = client.creditLimit || 0;
    const creditLimitText = creditLimit > 0 ?
        `<span class="text-info">ุญุฏ ุงูุงุฆุชูุงู: ${formatCurrency(creditLimit)} ${getCurrencySymbol(client.currency || 'SYP')}</span>` : '';

    clientInfo.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">ุงููุงุชู:</small> ${client.phone || 'ุบูุฑ ูุญุฏุฏ'}<br>
                <small class="text-muted">ุงูุจุฑูุฏ:</small> ${client.email || 'ุบูุฑ ูุญุฏุฏ'}
            </div>
            <div class="col-md-6">
                <small class="text-muted">ุงูุฑุตูุฏ ุงูุญุงูู:</small> ${balanceText}<br>
                ${creditLimitText}
            </div>
        </div>
        ${client.currency && client.currency !== 'SYP' ?
            `<div class="mt-2"><span class="badge bg-info">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ: ${getCurrencyName(client.currency)} (${getCurrencySymbol(client.currency)})</span></div>` :
            ''
        }
    `;

    console.log(`โ ุชู ุชุญุฏูุซ ูุนูููุงุช ${invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'}:`, client.name);
}

/**
 * ุชุญุฏูุซ ุนุฑุถ ุงูุนููุฉ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function updateCustomCurrencyDisplay() {
    const currencySelect = document.getElementById('customInvoiceCurrency');
    const exchangeRateInput = document.getElementById('customExchangeRate');
    const defaultRateDisplay = document.getElementById('defaultExchangeRateDisplay');
    const usedRateDisplay = document.getElementById('usedExchangeRateDisplay');

    if (!currencySelect) return;

    const selectedCurrency = currencySelect.value;
    const currencySymbol = getCurrencySymbol(selectedCurrency);

    // ุชุญุฏูุซ placeholder ูุณุนุฑ ุงูุตุฑู
    if (exchangeRateInput) {
        if (selectedCurrency !== 'SYP') {
            const defaultRate = getExchangeRate('SYP', selectedCurrency);
            exchangeRateInput.placeholder = `ุงูุณุนุฑ ุงูุงูุชุฑุงุถู: ${defaultRate}`;

            // ุนุฑุถ ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
            if (defaultRateDisplay) {
                defaultRateDisplay.value = `${defaultRate} ${currencySymbol}`;
            }
        } else {
            exchangeRateInput.placeholder = 'ุบูุฑ ูุทููุจ ููุนููุฉ ุงูุฃุณุงุณูุฉ';
            if (defaultRateDisplay) {
                defaultRateDisplay.value = '1.00 ู.ุณ';
            }
        }
    }

    // ุชุญุฏูุซ ุงูุณุนุฑ ุงููุณุชุฎุฏู
    updateCustomInvoiceExchangeRate();

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    calculateCustomInvoiceTotals();
}

/**
 * ุชุญุฏูุซ ุณุนุฑ ุงูุตุฑู ุงููุฎุตุต ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function updateCustomInvoiceExchangeRate() {
    const currencySelect = document.getElementById('customInvoiceCurrency');
    const exchangeRateInput = document.getElementById('customExchangeRate');
    const usedRateDisplay = document.getElementById('usedExchangeRateDisplay');

    if (!currencySelect || !usedRateDisplay) return;

    const selectedCurrency = currencySelect.value;
    const currencySymbol = getCurrencySymbol(selectedCurrency);
    const customRate = parseFloat(exchangeRateInput?.value);

    let usedRate;
    if (customRate && customRate > 0) {
        usedRate = customRate;
        // ุญูุธ ุงูุณุนุฑ ุงููุฎุตุต
        if (!window.customInvoiceExchangeRates) {
            window.customInvoiceExchangeRates = {};
        }
        window.customInvoiceExchangeRates[selectedCurrency] = customRate;
    } else {
        // ุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
        usedRate = selectedCurrency !== 'SYP' ? getExchangeRate('SYP', selectedCurrency) : 1;
        // ุฅุฒุงูุฉ ุงูุณุนุฑ ุงููุฎุตุต
        if (window.customInvoiceExchangeRates && window.customInvoiceExchangeRates[selectedCurrency]) {
            delete window.customInvoiceExchangeRates[selectedCurrency];
        }
    }

    usedRateDisplay.value = `${usedRate} ${currencySymbol}`;

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    calculateCustomInvoiceTotals();
}

/**
 * ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function addCustomInvoiceItem() {
    const tableBody = document.getElementById('customInvoiceItemsTable');
    if (!tableBody) return;

    const itemId = Date.now();
    const row = document.createElement('tr');
    row.id = `customItem_${itemId}`;

    row.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm"
                   placeholder="ุงุณู ุงูุตูู"
                   onchange="calculateCustomItemTotal(${itemId})">
        </td>
        <td>
            <textarea class="form-control form-control-sm"
                      rows="2"
                      placeholder="ุงูููุงุตูุงุช ูุงูุชูุงุตูู"></textarea>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm"
                   min="0" step="0.01" value="1"
                   onchange="calculateCustomItemTotal(${itemId})">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm"
                   min="0" step="0.01" value="0"
                   onchange="calculateCustomItemTotal(${itemId})">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm"
                   min="0" max="100" step="0.01" value="0"
                   onchange="calculateCustomItemTotal(${itemId})">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm"
                   readonly id="customItemTotal_${itemId}" value="0.00">
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm"
                    onclick="removeCustomInvoiceItem(${itemId})"
                    title="ุญุฐู ุงูุนูุตุฑ">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tableBody.appendChild(row);
    console.log(`โ ุชู ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ (ID: ${itemId})`);
}

/**
 * ุญุฐู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function removeCustomInvoiceItem(itemId) {
    const row = document.getElementById(`customItem_${itemId}`);
    if (row) {
        row.remove();
        calculateCustomInvoiceTotals();
        console.log(`๐๏ธ ุชู ุญุฐู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ (ID: ${itemId})`);
    }
}

/**
 * ุญุณุงุจ ุฅุฌูุงูู ุนูุตุฑ ูู ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function calculateCustomItemTotal(itemId) {
    const row = document.getElementById(`customItem_${itemId}`);
    if (!row) return;

    const inputs = row.querySelectorAll('input');
    const quantity = parseFloat(inputs[2].value) || 0;
    const unitPrice = parseFloat(inputs[3].value) || 0;
    const discountPercent = parseFloat(inputs[4].value) || 0;

    // ุญุณุงุจ ุงููุฌููุน ูุจู ุงูุฎุตู
    const subtotal = quantity * unitPrice;

    // ุญุณุงุจ ุงูุฎุตู
    const discountAmount = subtotal * (discountPercent / 100);

    // ุงููุฌููุน ุงูููุงุฆู
    const total = subtotal - discountAmount;

    // ุชุญุฏูุซ ุนุฑุถ ุงููุฌููุน
    const totalInput = document.getElementById(`customItemTotal_${itemId}`);
    if (totalInput) {
        const currencySymbol = getCurrencySymbol(document.getElementById('customInvoiceCurrency')?.value || 'SYP');
        totalInput.value = `${formatNumber(total)} ${currencySymbol}`;
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ
    calculateCustomInvoiceTotals();
}

/**
 * ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุจุฏูุฉ ูุญุณูุฉ
 */
function calculateCustomInvoiceTotals() {
    const tableBody = document.getElementById('customInvoiceItemsTable');
    const currencySelect = document.getElementById('customInvoiceCurrency');

    if (!tableBody || !currencySelect) return;

    const currency = currencySelect.value || 'SYP';
    const currencySymbol = getCurrencySymbol(currency);

    let subtotalItems = [];

    // ุญุณุงุจ ุงููุฌููุน ุงููุฑุนู ูู ุฌููุน ุงูุนูุงุตุฑ ุจุงุณุชุฎุฏุงู ุญุณุงุจุงุช ุฏูููุฉ
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 5) {
            const quantity = parseFloat(inputs[2].value) || 0;
            const unitPrice = parseFloat(inputs[3].value) || 0;
            const discountPercent = parseFloat(inputs[4].value) || 0;

            // ุญุณุงุจ ุฏููู ููู ุนูุตุฑ
            const itemSubtotal = preciseMultiply(quantity, unitPrice);
            const itemDiscountAmount = calculateDiscount(itemSubtotal, discountPercent);
            const itemTotal = preciseSubtract(itemSubtotal, itemDiscountAmount);

            subtotalItems.push(itemTotal);

            // ุชุญุฏูุซ ุนุฑุถ ุงููุฌููุน ููุนูุตุฑ
            const totalInput = inputs[5]; // ุญูู ุงููุฌููุน
            if (totalInput) {
                totalInput.value = `${formatCurrency(itemTotal)} ${currencySymbol}`;
            }
        }
    });

    // ุญุณุงุจ ุงููุฌููุน ุงููุฑุนู ุงูุฅุฌูุงูู
    const subtotal = preciseAdd(...subtotalItems);

    // ุญุณุงุจ ุงูุฎุตู ุงูุนุงู ูุงูุถุฑูุจุฉ ุจุงุณุชุฎุฏุงู ุงููุธุงุฆู ุงูุฏูููุฉ
    const discountPercentage = parseFloat(document.getElementById('customDiscountPercentage')?.value) || 0;
    const discountAmount = calculateDiscount(subtotal, discountPercentage);

    const taxPercentage = parseFloat(document.getElementById('customTaxPercentage')?.value) || 0;
    const taxableAmount = preciseSubtract(subtotal, discountAmount);
    const taxAmount = calculateTax(taxableAmount, taxPercentage);

    // ุงููุฌููุน ุงูููุงุฆู
    const totalAmount = preciseAdd(taxableAmount, taxAmount);

    // ุชุญุฏูุซ ุงูุนุฑูุถ ูุน ุงูุชูุณูู ุงููุญุณู
    const subtotalElement = document.getElementById('customSubtotalAmount');
    const discountElement = document.getElementById('customDiscountAmount');
    const taxElement = document.getElementById('customTaxAmount');
    const totalElement = document.getElementById('customTotalAmount');

    if (subtotalElement) {
        subtotalElement.textContent = formatCurrency(subtotal, currency);
    }
    if (discountElement) {
        discountElement.textContent = formatCurrency(discountAmount, currency);
    }
    if (taxElement) {
        taxElement.textContent = formatCurrency(taxAmount, currency);
    }
    if (totalElement) {
        totalElement.textContent = formatCurrency(totalAmount, currency);
    }

    console.log(`๐ฐ ุชู ุญุณุงุจ ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุจุฏูุฉ:`, {
        subtotal: formatNumber(subtotal),
        discountAmount: formatNumber(discountAmount),
        taxAmount: formatNumber(taxAmount),
        totalAmount: formatNumber(totalAmount),
        currency,
        itemsCount: subtotalItems.length
    });

    return {
        subtotal,
        discountAmount,
        taxAmount,
        totalAmount,
        currency,
        itemsCount: subtotalItems.length
    };
}

/**
 * ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function createCustomInvoice(event) {
    event.preventDefault();

    console.log('๐พ ุฅูุดุงุก ูุงุชูุฑุฉ ุฎุงุตุฉ...');

    // ุฌูุน ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    const invoiceData = collectCustomInvoiceData();

    if (!invoiceData) {
        return; // ุฎุทุฃ ูู ุงูุจูุงูุงุช
    }

    try {
        // ุฅุถุงูุฉ ุงููุงุชูุฑุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        if (!appData.invoices) {
            appData.invoices = [];
        }

        // ุชุนููู ูุนุฑู ูุฑูุฏ
        invoiceData.id = Date.now();
        invoiceData.createdAt = new Date().toISOString();
        invoiceData.isCustomInvoice = true; // ุนูุงูุฉ ููููุงุชูุฑ ุงูุฎุงุตุฉ

        appData.invoices.push(invoiceData);

        // ุญูุธ ุงูุจูุงูุงุช
        saveData();

        // ุฑุณุงูุฉ ูุฌุงุญ ูุน ุนุฑุถ ุฑูุฒ ุงูุนููุฉ ุจูุถูุญ
        const currencyName = getCurrencyName(invoiceData.currency);
        const currencySymbol = getCurrencySymbol(invoiceData.currency);
        alert(`โ ุชู ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุจูุฌุงุญ!

๐ ุฑูู ุงููุงุชูุฑุฉ: ${invoiceData.invoiceNumber}
๐ฐ ุงููุจูุบ ุงูุฅุฌูุงูู: ${formatCurrency(invoiceData.totalAmount, invoiceData.currency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})
๐ค ${invoiceData.invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ'}: ${invoiceData.clientName}`);

        // ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุงูููุงุชูุฑ
        if (invoiceData.invoiceType === 'sale') {
            showPage('sales-invoices');
        } else {
            showPage('purchase-invoices');
        }

        console.log('โ ุชู ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุจูุฌุงุญ:', invoiceData);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุงุชูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function collectCustomInvoiceData() {
    // ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    const invoiceType = document.getElementById('customInvoiceType')?.value;
    const invoiceNumber = document.getElementById('customInvoiceNumber')?.value;
    const invoiceDate = document.getElementById('customInvoiceDate')?.value;
    const dueDate = document.getElementById('customDueDate')?.value;
    const currency = document.getElementById('customInvoiceCurrency')?.value;
    const notes = document.getElementById('customInvoiceNotes')?.value;

    // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    if (!invoiceType || !invoiceNumber || !invoiceDate || !currency) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ');
        return null;
    }

    // ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
    const clientInputType = document.querySelector('input[name="clientInputType"]:checked')?.value;
    let clientData = {};

    if (clientInputType === 'existing') {
        // ุนููู/ููุฑุฏ ูู ุงููุงุฆูุฉ
        const clientId = parseInt(document.getElementById('customClientSelect')?.value);
        if (!clientId) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู/ุงูููุฑุฏ');
            return null;
        }

        let client = null;
        if (invoiceType === 'sale') {
            client = appData.customers?.find(c => c.id === clientId);
        } else {
            client = appData.suppliers?.find(s => s.id === clientId);
        }

        if (!client) {
            alert('ุงูุนููู/ุงูููุฑุฏ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return null;
        }

        clientData = {
            clientId: clientId,
            clientName: client.name,
            clientPhone: client.phone,
            clientEmail: client.email,
            clientAddress: client.address,
            clientTaxNumber: client.taxNumber,
            isExistingClient: true
        };

    } else if (clientInputType === 'manual') {
        // ุจูุงูุงุช ูุฏููุฉ
        const clientName = document.getElementById('manualClientName')?.value?.trim();
        if (!clientName) {
            alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู/ุงูููุฑุฏ');
            return null;
        }

        clientData = {
            clientId: null,
            clientName: clientName,
            clientPhone: document.getElementById('manualClientPhone')?.value?.trim(),
            clientEmail: document.getElementById('manualClientEmail')?.value?.trim(),
            clientAddress: document.getElementById('manualClientAddress')?.value?.trim(),
            clientTaxNumber: document.getElementById('manualClientTaxNumber')?.value?.trim(),
            clientCurrency: document.getElementById('manualClientCurrency')?.value,
            isExistingClient: false
        };
    } else {
        alert('ูุฑุฌู ุชุญุฏูุฏ ููุน ุฅุฏุฎุงู ุงูุนููู/ุงูููุฑุฏ');
        return null;
    }

    // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ
    const items = collectCustomInvoiceItems();
    if (!items || items.length === 0) {
        alert('ูุฑุฌู ุฅุถุงูุฉ ุนูุตุฑ ูุงุญุฏ ุนูู ุงูุฃูู ูููุงุชูุฑุฉ');
        return null;
    }

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    const totals = calculateCustomInvoiceFinalTotals(items);

    // ุณุนุฑ ุงูุตุฑู ุงููุณุชุฎุฏู
    const customExchangeRate = parseFloat(document.getElementById('customExchangeRate')?.value);
    const exchangeRate = customExchangeRate && customExchangeRate > 0 ?
        customExchangeRate :
        (currency !== 'SYP' ? getExchangeRate('SYP', currency) : 1);

    // ุฅูุดุงุก ูุงุฆู ุงููุงุชูุฑุฉ
    const invoiceData = {
        invoiceType: invoiceType,
        invoiceNumber: invoiceNumber,
        invoiceDate: invoiceDate,
        dueDate: dueDate,
        currency: currency,
        exchangeRate: exchangeRate,
        isCustomExchangeRate: !!(customExchangeRate && customExchangeRate > 0),

        // ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
        ...clientData,

        // ุงูุนูุงุตุฑ
        items: items,

        // ุงูุฅุฌูุงููุงุช
        subtotal: totals.subtotal,
        discountRate: totals.discountRate,
        discountAmount: totals.discountAmount,
        taxRate: totals.taxRate,
        taxAmount: totals.taxAmount,
        totalAmount: totals.totalAmount,

        // ุญุงูุฉ ุงูุฏูุน
        paidAmount: 0,
        remainingAmount: totals.totalAmount,
        paymentStatus: 'pending',

        // ููุงุญุธุงุช
        notes: notes,

        // ูุนูููุงุช ุฅุถุงููุฉ
        status: 'active',
        createdBy: 'system', // ูููู ุชุญุฏูุซูุง ูุงุญูุงู ููุธุงู ุงููุณุชุฎุฏููู
        lastModified: new Date().toISOString()
    };

    return invoiceData;
}

/**
 * ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function collectCustomInvoiceItems() {
    const tableBody = document.getElementById('customInvoiceItemsTable');
    if (!tableBody) return [];

    const items = [];
    const rows = tableBody.querySelectorAll('tr');

    rows.forEach((row, index) => {
        const inputs = row.querySelectorAll('input, textarea');
        if (inputs.length >= 5) {
            const productName = inputs[0].value?.trim();
            const description = inputs[1].value?.trim();
            const quantity = parseFloat(inputs[2].value) || 0;
            const unitPrice = parseFloat(inputs[3].value) || 0;
            const discountPercent = parseFloat(inputs[4].value) || 0;

            if (productName && quantity > 0 && unitPrice >= 0) {
                const itemSubtotal = quantity * unitPrice;
                const itemDiscountAmount = itemSubtotal * (discountPercent / 100);
                const itemTotal = itemSubtotal - itemDiscountAmount;

                items.push({
                    id: Date.now() + index,
                    productName: productName,
                    description: description,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    discountPercent: discountPercent,
                    discountAmount: itemDiscountAmount,
                    totalAmount: itemTotal,
                    isCustomItem: true // ุนูุงูุฉ ููุนูุงุตุฑ ุงููุฎุตุตุฉ
                });
            }
        }
    });

    return items;
}

/**
 * ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุงูููุงุฆูุฉ ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function calculateCustomInvoiceFinalTotals(items) {
    // ุงููุฌููุน ุงููุฑุนู
    const subtotal = items.reduce((sum, item) => sum + item.totalAmount, 0);

    // ุงูุฎุตู ุงูุนุงู
    const discountRate = parseFloat(document.getElementById('customDiscountPercentage')?.value) || 0;
    const discountAmount = subtotal * (discountRate / 100);

    // ุงูุถุฑูุจุฉ
    const taxRate = parseFloat(document.getElementById('customTaxPercentage')?.value) || 0;
    const taxableAmount = subtotal - discountAmount;
    const taxAmount = taxableAmount * (taxRate / 100);

    // ุงููุฌููุน ุงูููุงุฆู
    const totalAmount = taxableAmount + taxAmount;

    return {
        subtotal,
        discountRate,
        discountAmount,
        taxRate,
        taxAmount,
        totalAmount
    };
}

/**
 * ุญูุธ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ููุณูุฏุฉ
 */
function saveCustomInvoiceAsDraft() {
    console.log('๐ ุญูุธ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ููุณูุฏุฉ...');

    const invoiceData = collectCustomInvoiceData();
    if (!invoiceData) {
        return;
    }

    try {
        // ุชุนุฏูู ุญุงูุฉ ุงููุงุชูุฑุฉ ุฅูู ูุณูุฏุฉ
        invoiceData.status = 'draft';
        invoiceData.isDraft = true;

        // ุฅุถุงูุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        if (!appData.invoices) {
            appData.invoices = [];
        }

        invoiceData.id = Date.now();
        invoiceData.createdAt = new Date().toISOString();
        invoiceData.isCustomInvoice = true;

        appData.invoices.push(invoiceData);
        saveData();

        // ุฑุณุงูุฉ ูุฌุงุญ ูุน ุนุฑุถ ุฑูุฒ ุงูุนููุฉ ุจูุถูุญ
        const currencyName = getCurrencyName(invoiceData.currency);
        const currencySymbol = getCurrencySymbol(invoiceData.currency);
        alert(`โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ููุณูุฏุฉ ุจูุฌุงุญ!

๐ ุฑูู ุงููุงุชูุฑุฉ: ${invoiceData.invoiceNumber}
๐ฐ ุงููุจูุบ ุงูุฅุฌูุงูู: ${formatCurrency(invoiceData.totalAmount, invoiceData.currency)}
๐ฑ ุงูุนููุฉ: ${currencyName} (${currencySymbol})

ููููู ุงูุนูุฏุฉ ูุชุนุฏูููุง ูุชุฃููุฏูุง ูุงุญูุงู.`);

        // ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุงูููุงุชูุฑ
        if (invoiceData.invoiceType === 'sale') {
            showPage('sales-invoices');
        } else {
            showPage('purchase-invoices');
        }

        console.log('โ ุชู ุญูุธ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ููุณูุฏุฉ:', invoiceData);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุณูุฏุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุณูุฏุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ูุนุงููุฉ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function previewCustomInvoice() {
    console.log('๐๏ธ ูุนุงููุฉ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ...');

    const invoiceData = collectCustomInvoiceData();
    if (!invoiceData) {
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ูุนุงููุฉ
    const previewWindow = window.open('', '_blank', 'width=800,height=600');

    const currencySymbol = getCurrencySymbol(invoiceData.currency);
    const invoiceTypeText = invoiceData.invoiceType === 'sale' ? 'ูุงุชูุฑุฉ ูุจูุนุงุช ุฎุงุตุฉ' : 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฎุงุตุฉ';
    const clientTypeText = invoiceData.invoiceType === 'sale' ? 'ุงูุนููู' : 'ุงูููุฑุฏ';

    previewWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ูุนุงููุฉ ${invoiceTypeText}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .invoice-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                .custom-badge { background: linear-gradient(45deg, #ff6b6b, #feca57); }
                @media print {
                    .no-print { display: none !important; }
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            <div class="container-fluid p-4">
                <!-- ุฑุฃุณ ุงููุงุชูุฑุฉ -->
                <div class="invoice-header p-4 rounded mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-star me-2"></i>
                                ${invoiceTypeText}
                            </h2>
                            <span class="badge custom-badge fs-6">ูุงุชูุฑุฉ ุฎุงุตุฉ</span>
                        </div>
                        <div class="col-md-4 text-end">
                            <h4>ุฑูู ุงููุงุชูุฑุฉ</h4>
                            <p class="mb-0 fs-5">${invoiceData.invoiceNumber}</p>
                        </div>
                    </div>
                </div>

                <!-- ูุนูููุงุช ุงููุงุชูุฑุฉ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    ุจูุงูุงุช ${clientTypeText}
                                </h6>
                            </div>
                            <div class="card-body">
                                <p><strong>ุงูุงุณู:</strong> ${invoiceData.clientName}</p>
                                ${invoiceData.clientPhone ? `<p><strong>ุงููุงุชู:</strong> ${invoiceData.clientPhone}</p>` : ''}
                                ${invoiceData.clientEmail ? `<p><strong>ุงูุจุฑูุฏ:</strong> ${invoiceData.clientEmail}</p>` : ''}
                                ${invoiceData.clientAddress ? `<p><strong>ุงูุนููุงู:</strong> ${invoiceData.clientAddress}</p>` : ''}
                                ${invoiceData.clientTaxNumber ? `<p><strong>ุงูุฑูู ุงูุถุฑูุจู:</strong> ${invoiceData.clientTaxNumber}</p>` : ''}
                                ${!invoiceData.isExistingClient ? '<span class="badge bg-info">ุจูุงูุงุช ูุฏุฎูุฉ ูุฏููุงู</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar me-2"></i>
                                    ุชูุงุตูู ุงููุงุชูุฑุฉ
                                </h6>
                            </div>
                            <div class="card-body">
                                <p><strong>ุชุงุฑูุฎ ุงููุงุชูุฑุฉ:</strong> ${formatDate(invoiceData.invoiceDate)}</p>
                                ${invoiceData.dueDate ? `<p><strong>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู:</strong> ${formatDate(invoiceData.dueDate)}</p>` : ''}
                                <p><strong>ุงูุนููุฉ:</strong> ${getCurrencyName(invoiceData.currency)} (${currencySymbol})</p>
                                ${invoiceData.isCustomExchangeRate ?
                                    `<p><strong>ุณุนุฑ ุงูุตุฑู:</strong> ${invoiceData.exchangeRate} <span class="badge bg-warning">ูุฎุตุต</span></p>` :
                                    invoiceData.currency !== 'SYP' ? `<p><strong>ุณุนุฑ ุงูุตุฑู:</strong> ${invoiceData.exchangeRate} <span class="badge bg-secondary">ุงูุชุฑุงุถู</span></p>` : ''
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุนูุงุตุฑ ุงููุงุชูุฑุฉ -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            ุนูุงุตุฑ ุงููุงุชูุฑุฉ
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>ุงูุตูู</th>
                                        <th>ุงูููุงุตูุงุช</th>
                                        <th>ุงููููุฉ</th>
                                        <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                        <th>ุฎุตู %</th>
                                        <th>ุงููุฌููุน</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoiceData.items.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${item.productName}</strong></td>
                                        <td>${item.description || '-'}</td>
                                        <td>${formatNumber(item.quantity)}</td>
                                        <td>${formatNumber(item.unitPrice)} ${currencySymbol}</td>
                                        <td>${item.discountPercent}%</td>
                                        <td><strong>${formatNumber(item.totalAmount)} ${currencySymbol}</strong></td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ -->
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0">ุฅุฌูุงููุงุช ุงููุงุชูุฑุฉ</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ุงููุฌููุน ุงููุฑุนู:</span>
                                    <span>${formatNumber(invoiceData.subtotal)} ${currencySymbol}</span>
                                </div>
                                ${invoiceData.discountRate > 0 ? `
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ุงูุฎุตู (${invoiceData.discountRate}%):</span>
                                    <span class="text-danger">-${formatNumber(invoiceData.discountAmount)} ${currencySymbol}</span>
                                </div>
                                ` : ''}
                                ${invoiceData.taxRate > 0 ? `
                                <div class="d-flex justify-content-between mb-2">
                                    <span>ุงูุถุฑูุจุฉ (${invoiceData.taxRate}%):</span>
                                    <span class="text-info">+${formatNumber(invoiceData.taxAmount)} ${currencySymbol}</span>
                                </div>
                                ` : ''}
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>ุงููุฌููุน ุงูููุงุฆู:</strong>
                                    <strong class="text-primary fs-5">${formatNumber(invoiceData.totalAmount)} ${currencySymbol}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${invoiceData.notes ? `
                <!-- ุงูููุงุญุธุงุช -->
                <div class="card mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i>
                            ููุงุญุธุงุช
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${invoiceData.notes}</p>
                    </div>
                </div>
                ` : ''}

                <!-- ุฃุฒุฑุงุฑ ุงูุทุจุงุนุฉ -->
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>
                    <button class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-times me-2"></i>ุฅุบูุงู
                    </button>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
        </body>
        </html>
    `);

    previewWindow.document.close();
    console.log('โ ุชู ูุชุญ ูุนุงููุฉ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ');
}

/**
 * ุตูุญุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
 */
function getCustomerSupplierBalancesHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-balance-scale me-2 text-primary"></i>
                    ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
                </h1>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ุนุฑุถ ุดุงูู:</strong> ุฌููุน ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู ููุตูุฉ ุญุณุจ ุงูุนููุฉ ูุน ุฅููุงููุฉ ุงูููุชุฑุฉ ูุงูุจุญุซ.
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุจุญุซ -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุจุญุซ ูุงูุนุฑุถ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="balanceFilterCurrency" class="form-label">ููุชุฑุฉ ุญุณุจ ุงูุนููุฉ</label>
                        <select class="form-select" id="balanceFilterCurrency" onchange="filterBalancesByCurrency()">
                            <option value="ALL">ุฌููุน ุงูุนููุงุช</option>
                            <option value="SYP">ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</option>
                            <option value="USD">ุฏููุงุฑ ุฃูุฑููู ($)</option>
                            <option value="EUR">ููุฑู (โฌ)</option>
                            <option value="TRY">ููุฑุฉ ุชุฑููุฉ (โบ)</option>
                            <option value="SAR">ุฑูุงู ุณุนูุฏู (ุฑ.ุณ)</option>
                            <option value="AED">ุฏุฑูู ุฅูุงุฑุงุชู (ุฏ.ุฅ)</option>
                            <option value="EGP">ุฌููู ูุตุฑู (ุฌ.ู)</option>
                            <option value="JOD">ุฏููุงุฑ ุฃุฑุฏูู (ุฏ.ุฃ)</option>
                            <option value="LBP">ููุฑุฉ ูุจูุงููุฉ (ู.ู)</option>
                            <option value="GBP">ุฌููู ุฅุณุชุฑูููู (ยฃ)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="balanceFilterType" class="form-label">ููุน ุงูุญุณุงุจ</label>
                        <select class="form-select" id="balanceFilterType" onchange="filterBalancesByType()">
                            <option value="ALL">ุงูุนููุงุก ูุงูููุฑุฏูู</option>
                            <option value="customers">ุงูุนููุงุก ููุท</option>
                            <option value="suppliers">ุงูููุฑุฏูู ููุท</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="balanceFilterStatus" class="form-label">ุญุงูุฉ ุงูุฑุตูุฏ</label>
                        <select class="form-select" id="balanceFilterStatus" onchange="filterBalancesByStatus()">
                            <option value="ALL">ุฌููุน ุงูุฃุฑุตุฏุฉ</option>
                            <option value="positive">ุฃุฑุตุฏุฉ ููุฌุจุฉ (ูุฏูู)</option>
                            <option value="negative">ุฃุฑุตุฏุฉ ุณุงูุจุฉ (ุฏุงุฆู)</option>
                            <option value="zero">ุฃุฑุตุฏุฉ ูุชูุงุฒูุฉ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="balanceSearchInput" class="form-label">ุงูุจุญุซ</label>
                        <input type="text" class="form-control" id="balanceSearchInput"
                               placeholder="ุงุจุญุซ ุจุงูุงุณู..." onkeyup="searchInBalances()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-success me-2" onclick="refreshAllBalances()">
                            <i class="fas fa-sync-alt me-2"></i>ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ
                        </button>
                        <button type="button" class="btn btn-info me-2" onclick="exportBalancesToExcel()">
                            <i class="fas fa-file-excel me-2"></i>ุชุตุฏูุฑ Excel
                        </button>
                        <button type="button" class="btn btn-danger me-2" onclick="exportBalancesToPDF()">
                            <i class="fas fa-file-pdf me-2"></i>ุชุตุฏูุฑ PDF
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printBalancesReport()">
                            <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุฃุฑุตุฏุฉ -->
        <div class="row mb-4" id="balancesSummarySection">
            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
        </div>

        <!-- ุฌุฏุงูู ุงูุฃุฑุตุฏุฉ -->
        <div class="row">
            <!-- ุฃุฑุตุฏุฉ ุงูุนููุงุก -->
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            ุฃุฑุตุฏุฉ ุงูุนููุงุก
                            <span class="badge bg-light text-dark ms-2" id="customersCount">0</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>ุงูุนููู</th>
                                        <th>ุงูุนููุฉ</th>
                                        <th>ุงูุฑุตูุฏ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                        <th>ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="customersBalancesTable">
                                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุฃุฑุตุฏุฉ ุงูููุฑุฏูู -->
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-truck me-2"></i>
                            ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
                            <span class="badge bg-dark text-light ms-2" id="suppliersCount">0</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>ุงูููุฑุฏ</th>
                                        <th>ุงูุนููุฉ</th>
                                        <th>ุงูุฑุตูุฏ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                        <th>ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="suppliersBalancesTable">
                                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุชูุงุตูู ุฅุถุงููุฉ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            ุชุญููู ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="currencyAnalysisSection">
                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุชูุงุตูู ุงูุฑุตูุฏ -->
        <div class="modal fade" id="balanceDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle me-2"></i>
                            ุชูุงุตูู ุงูุฑุตูุฏ
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="balanceDetailsContent">
                        <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>ุฅุบูุงู
                        </button>
                        <button type="button" class="btn btn-primary" onclick="printBalanceDetails()">
                            <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุชููุฆุฉ ุตูุญุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
 */
function initializeCustomerSupplierBalancesPage() {
    console.log('๐ ุชููุฆุฉ ุตูุญุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู...');

    // ุชุญุฏูุซ ุฌููุน ุงูุฃุฑุตุฏุฉ
    refreshAllBalances();

    console.log('โ ุชู ุชููุฆุฉ ุตูุญุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู');
}

/**
 * ุชุญุฏูุซ ุฌููุน ุงูุฃุฑุตุฏุฉ
 */
function refreshAllBalances() {
    console.log('๐ ุชุญุฏูุซ ุฌููุน ุงูุฃุฑุตุฏุฉ...');

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูุนููุงุก
    if (appData.customers) {
        appData.customers.forEach(customer => {
            recalculateCustomerBalance(customer.id);
        });
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    if (appData.suppliers) {
        appData.suppliers.forEach(supplier => {
            recalculateSupplierBalance(supplier.id);
        });
    }

    // ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุงููุญุฏุซุฉ
    displayCustomerSupplierBalances();

    console.log('โ ุชู ุชุญุฏูุซ ุฌููุน ุงูุฃุฑุตุฏุฉ');
}

/**
 * ุนุฑุถ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
 */
function displayCustomerSupplierBalances() {
    console.log('๐ ุนุฑุถ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู...');

    // ุนุฑุถ ููุฎุต ุงูุฃุฑุตุฏุฉ
    displayBalancesSummary();

    // ุนุฑุถ ุฃุฑุตุฏุฉ ุงูุนููุงุก
    displayCustomersBalances();

    // ุนุฑุถ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    displaySuppliersBalances();

    // ุนุฑุถ ุชุญููู ุงูุนููุงุช
    displayCurrencyAnalysis();

    console.log('โ ุชู ุนุฑุถ ุฌููุน ุงูุฃุฑุตุฏุฉ');
}

/**
 * ุนุฑุถ ููุฎุต ุงูุฃุฑุตุฏุฉ
 */
function displayBalancesSummary() {
    const summarySection = document.getElementById('balancesSummarySection');
    if (!summarySection) return;

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const stats = calculateBalancesStatistics();

    summarySection.innerHTML = `
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h4 class="text-primary">${stats.totalCustomers}</h4>
                    <p class="mb-0">ุฅุฌูุงูู ุงูุนููุงุก</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-truck fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning">${stats.totalSuppliers}</h4>
                    <p class="mb-0">ุฅุฌูุงูู ุงูููุฑุฏูู</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-arrow-up fa-2x text-success mb-2"></i>
                    <h4 class="text-success">${stats.totalPositiveBalances}</h4>
                    <p class="mb-0">ุฃุฑุตุฏุฉ ููุฌุจุฉ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <i class="fas fa-arrow-down fa-2x text-danger mb-2"></i>
                    <h4 class="text-danger">${stats.totalNegativeBalances}</h4>
                    <p class="mb-0">ุฃุฑุตุฏุฉ ุณุงูุจุฉ</p>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูุฃุฑุตุฏุฉ
 */
function calculateBalancesStatistics() {
    let totalCustomers = 0;
    let totalSuppliers = 0;
    let totalPositiveBalances = 0;
    let totalNegativeBalances = 0;

    // ุฅุญุตุงุฆูุงุช ุงูุนููุงุก
    if (appData.customers) {
        totalCustomers = appData.customers.length;
        appData.customers.forEach(customer => {
            const balance = customer.currentBalance || 0;
            if (balance > 0) totalPositiveBalances++;
            else if (balance < 0) totalNegativeBalances++;
        });
    }

    // ุฅุญุตุงุฆูุงุช ุงูููุฑุฏูู
    if (appData.suppliers) {
        totalSuppliers = appData.suppliers.length;
        appData.suppliers.forEach(supplier => {
            const balance = supplier.currentBalance || 0;
            if (balance > 0) totalPositiveBalances++;
            else if (balance < 0) totalNegativeBalances++;
        });
    }

    return {
        totalCustomers,
        totalSuppliers,
        totalPositiveBalances,
        totalNegativeBalances
    };
}

/**
 * ุนุฑุถ ุฃุฑุตุฏุฉ ุงูุนููุงุก
 */
function displayCustomersBalances() {
    const tableBody = document.getElementById('customersBalancesTable');
    const countElement = document.getElementById('customersCount');

    if (!tableBody || !countElement) return;

    let html = '';
    let count = 0;

    if (appData.customers && appData.customers.length > 0) {
        appData.customers.forEach(customer => {
            // ุนุฑุถ ุฑุตูุฏ ููู ุนููุฉ ูููุตูุฉ
            if (customer.balances && Object.keys(customer.balances).length > 0) {
                Object.keys(customer.balances).forEach(currency => {
                    const balance = customer.balances[currency] || 0;
                    if (balance !== 0) { // ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุบูุฑ ุงูุตูุฑูุฉ ููุท
                        const currencySymbol = getCurrencySymbol(currency);

                        let balanceClass = 'text-muted';
                        let balanceStatus = 'ูุชูุงุฒู';

                        if (balance > 0) {
                            balanceClass = 'text-danger';
                            balanceStatus = 'ูุฏูู';
                        } else if (balance < 0) {
                            balanceClass = 'text-success';
                            balanceStatus = 'ุฏุงุฆู';
                        }

                        html += `
                            <tr data-customer-id="${customer.id}" data-currency="${currency}" data-balance="${balance}">
                                <td>
                                    <strong>${customer.name}</strong>
                                    ${customer.phone ? `<br><small class="text-muted">${customer.phone}</small>` : ''}
                                </td>
                                <td>
                                    <span class="badge bg-info">${getCurrencyName(currency)}</span>
                                </td>
                                <td class="${balanceClass}">
                                    <strong>${formatCurrency(Math.abs(balance))} ${currencySymbol}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-${balance > 0 ? 'danger' : balance < 0 ? 'success' : 'secondary'}">
                                        ${balanceStatus}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info"
                                                onclick="showBalanceDetails('customer', ${customer.id})"
                                                title="ุชูุงุตูู ุงูุฑุตูุฏ">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="showCustomerStatement(${customer.id})"
                                                title="ูุดู ุงูุญุณุงุจ">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        count++;
                    }
                });
            } else {
                // ุนุฑุถ ุงูุฑุตูุฏ ุงูุญุงูู ุฅุฐุง ูู ุชูู ููุงู ุฃุฑุตุฏุฉ ูุชุนุฏุฏุฉ ุงูุนููุงุช
                const balance = customer.currentBalance || 0;
                if (balance !== 0) {
                    const currency = 'SYP';
                    const currencySymbol = getCurrencySymbol(currency);

                    let balanceClass = 'text-muted';
                    let balanceStatus = 'ูุชูุงุฒู';

                    if (balance > 0) {
                        balanceClass = 'text-danger';
                        balanceStatus = 'ูุฏูู';
                    } else if (balance < 0) {
                        balanceClass = 'text-success';
                        balanceStatus = 'ุฏุงุฆู';
                    }

                    html += `
                        <tr data-customer-id="${customer.id}" data-currency="${currency}" data-balance="${balance}">
                            <td>
                                <strong>${customer.name}</strong>
                                ${customer.phone ? `<br><small class="text-muted">${customer.phone}</small>` : ''}
                            </td>
                            <td>
                                <span class="badge bg-info">${getCurrencyName(currency)}</span>
                            </td>
                            <td class="${balanceClass}">
                                <strong>${formatCurrency(Math.abs(balance))} ${currencySymbol}</strong>
                            </td>
                            <td>
                                <span class="badge bg-${balance > 0 ? 'danger' : balance < 0 ? 'success' : 'secondary'}">
                                    ${balanceStatus}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-info"
                                            onclick="showBalanceDetails('customer', ${customer.id})"
                                            title="ุชูุงุตูู ุงูุฑุตูุฏ">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="showCustomerStatement(${customer.id})"
                                            title="ูุดู ุงูุญุณุงุจ">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    count++;
                }
            }
        });
    }

    if (html === '') {
        html = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <br>ูุง ุชูุฌุฏ ุนููุงุก
                </td>
            </tr>
        `;
    }

    tableBody.innerHTML = html;
    countElement.textContent = count;
}

/**
 * ุนุฑุถ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
 */
function displaySuppliersBalances() {
    const tableBody = document.getElementById('suppliersBalancesTable');
    const countElement = document.getElementById('suppliersCount');

    if (!tableBody || !countElement) return;

    let html = '';
    let count = 0;

    if (appData.suppliers && appData.suppliers.length > 0) {
        appData.suppliers.forEach(supplier => {
            // ุนุฑุถ ุฑุตูุฏ ููู ุนููุฉ ูููุตูุฉ
            if (supplier.balances && Object.keys(supplier.balances).length > 0) {
                Object.keys(supplier.balances).forEach(currency => {
                    const balance = supplier.balances[currency] || 0;
                    if (balance !== 0) { // ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุบูุฑ ุงูุตูุฑูุฉ ููุท
                        const currencySymbol = getCurrencySymbol(currency);

                        let balanceClass = 'text-muted';
                        let balanceStatus = 'ูุชูุงุฒู';

                        if (balance > 0) {
                            balanceClass = 'text-success';
                            balanceStatus = 'ุฏุงุฆู';
                        } else if (balance < 0) {
                            balanceClass = 'text-danger';
                            balanceStatus = 'ูุฏูู';
                        }

                        html += `
                            <tr data-supplier-id="${supplier.id}" data-currency="${currency}" data-balance="${balance}">
                                <td>
                                    <strong>${supplier.name}</strong>
                                    ${supplier.phone ? `<br><small class="text-muted">${supplier.phone}</small>` : ''}
                                </td>
                                <td>
                                    <span class="badge bg-info">${getCurrencyName(currency)}</span>
                                </td>
                                <td class="${balanceClass}">
                                    <strong>${formatCurrency(Math.abs(balance))} ${currencySymbol}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-${balance > 0 ? 'success' : balance < 0 ? 'danger' : 'secondary'}">
                                        ${balanceStatus}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info"
                                                onclick="showBalanceDetails('supplier', ${supplier.id})"
                                                title="ุชูุงุตูู ุงูุฑุตูุฏ">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="showSupplierStatement(${supplier.id})"
                                                title="ูุดู ุงูุญุณุงุจ">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        count++;
                    }
                });
            } else {
                // ุนุฑุถ ุงูุฑุตูุฏ ุงูุญุงูู ุฅุฐุง ูู ุชูู ููุงู ุฃุฑุตุฏุฉ ูุชุนุฏุฏุฉ ุงูุนููุงุช
                const balance = supplier.currentBalance || 0;
                if (balance !== 0) {
                    const currency = 'SYP';
                    const currencySymbol = getCurrencySymbol(currency);

                    let balanceClass = 'text-muted';
                    let balanceStatus = 'ูุชูุงุฒู';

                    if (balance > 0) {
                        balanceClass = 'text-success';
                        balanceStatus = 'ุฏุงุฆู';
                    } else if (balance < 0) {
                        balanceClass = 'text-danger';
                        balanceStatus = 'ูุฏูู';
                    }

                    html += `
                        <tr data-supplier-id="${supplier.id}" data-currency="${currency}" data-balance="${balance}">
                            <td>
                                <strong>${supplier.name}</strong>
                                ${supplier.phone ? `<br><small class="text-muted">${supplier.phone}</small>` : ''}
                            </td>
                            <td>
                                <span class="badge bg-info">${getCurrencyName(currency)}</span>
                            </td>
                            <td class="${balanceClass}">
                                <strong>${formatCurrency(Math.abs(balance))} ${currencySymbol}</strong>
                            </td>
                            <td>
                                <span class="badge bg-${balance > 0 ? 'success' : balance < 0 ? 'danger' : 'secondary'}">
                                    ${balanceStatus}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-info"
                                            onclick="showBalanceDetails('supplier', ${supplier.id})"
                                            title="ุชูุงุตูู ุงูุฑุตูุฏ">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="showSupplierStatement(${supplier.id})"
                                            title="ูุดู ุงูุญุณุงุจ">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    count++;
                }
            }
        });
    }

    if (html === '') {
        html = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-truck fa-2x mb-2"></i>
                    <br>ูุง ุชูุฌุฏ ููุฑุฏูู
                </td>
            </tr>
        `;
    }

    tableBody.innerHTML = html;
    countElement.textContent = count;
}

/**
 * ุนุฑุถ ุชุญููู ุงูุนููุงุช - ูุญุณู ูุน ุฏุนู ุงูููุชุฑุฉ
 */
function displayCurrencyAnalysis(filterCurrency = null) {
    const analysisSection = document.getElementById('currencyAnalysisSection');
    if (!analysisSection) return;

    console.log(`๐ ุนุฑุถ ุชุญููู ุงูุนููุงุช${filterCurrency ? ` ููุนููุฉ: ${filterCurrency}` : ''}`);

    const currencyStats = calculateCurrencyStatistics(filterCurrency);

    let html = '<div class="row">';

    // ุฅุฐุง ูุงู ููุงู ููุชุฑ ุนููุฉ ูุญุฏุฏุ ุนุฑุถ ุชูู ุงูุนููุฉ ููุท
    const currenciesToShow = filterCurrency && filterCurrency !== 'ALL'
        ? [filterCurrency]
        : Object.keys(currencyStats);

    if (currenciesToShow.length === 0) {
        html += `
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <h5>ูุง ุชูุฌุฏ ุฃุฑุตุฏุฉ ููุนููุฉ ุงููุญุฏุฏุฉ</h5>
                    <p class="mb-0">ุงุฎุชุฑ ุนููุฉ ุฃุฎุฑู ุฃู ุงุฎุชุฑ "ุฌููุน ุงูุนููุงุช" ูุนุฑุถ ุฌููุน ุงูุฃุฑุตุฏุฉ</p>
                </div>
            </div>
        `;
    } else {
        currenciesToShow.forEach(currency => {
            const stats = currencyStats[currency];
            if (!stats) return;

            const currencySymbol = getCurrencySymbol(currency);
            const currencyName = getCurrencyName(currency);

            html += `
                <div class="col-md-${currenciesToShow.length === 1 ? '12' : '4'} mb-3">
                    <div class="card border-info shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-coins me-2"></i>
                                ${currencyName} (${currencySymbol})
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <h6 class="text-success">
                                            <i class="fas fa-users me-1"></i>ุงูุนููุงุก
                                        </h6>
                                        <p class="mb-1"><strong>${stats.customersCount}</strong> ุนููู</p>
                                        <small class="text-muted">${formatCurrency(Math.abs(stats.customersTotal))} ${currencySymbol}</small>
                                        <br><small class="badge bg-${stats.customersTotal >= 0 ? 'success' : 'danger'} mt-1">
                                            ${stats.customersTotal >= 0 ? 'ูุฏูู' : 'ุฏุงุฆู'}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 class="text-warning">
                                        <i class="fas fa-truck me-1"></i>ุงูููุฑุฏูู
                                    </h6>
                                    <p class="mb-1"><strong>${stats.suppliersCount}</strong> ููุฑุฏ</p>
                                    <small class="text-muted">${formatCurrency(Math.abs(stats.suppliersTotal))} ${currencySymbol}</small>
                                    <br><small class="badge bg-${stats.suppliersTotal >= 0 ? 'danger' : 'success'} mt-1">
                                        ${stats.suppliersTotal >= 0 ? 'ูุฏูู' : 'ุฏุงุฆู'}
                                    </small>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <h6 class="text-primary">
                                    <i class="fas fa-balance-scale me-1"></i>ุงูุฑุตูุฏ ุงูุตุงูู
                                </h6>
                                <h5 class="mb-2 ${stats.netBalance >= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(Math.abs(stats.netBalance))} ${currencySymbol}
                                </h5>
                                <span class="badge bg-${stats.netBalance >= 0 ? 'success' : 'danger'} fs-6">
                                    ${stats.netBalance >= 0 ? 'ุฑุตูุฏ ููุฌุจ' : 'ุฑุตูุฏ ุณุงูุจ'}
                                </span>
                            </div>
                            ${currenciesToShow.length === 1 ? `
                                <hr>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">ุฅุฌูุงูู ุงููุนุงููุงุช</small>
                                        <br><strong>${stats.totalTransactions || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">ูุชูุณุท ุงูุฑุตูุฏ</small>
                                        <br><strong>${formatCurrency(stats.averageBalance || 0)} ${currencySymbol}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">ุฃุนูู ุฑุตูุฏ</small>
                                        <br><strong>${formatCurrency(stats.maxBalance || 0)} ${currencySymbol}</strong>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
    }

    html += '</div>';

    if (Object.keys(currencyStats).length === 0) {
        html = `
            <div class="text-center py-4">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุญููู</h5>
                <p class="text-muted">ุฃุถู ุนููุงุก ูููุฑุฏูู ูุนุฑุถ ุชุญููู ุงูุนููุงุช</p>
            </div>
        `;
    }

    analysisSection.innerHTML = html;
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูุนููุงุช - ูุญุณู ูุน ุฏุนู ุงูููุชุฑุฉ ูุงูุนููุงุช ุงููุชุนุฏุฏุฉ
 */
function calculateCurrencyStatistics(filterCurrency = null) {
    const stats = {};

    console.log(`๐ ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูุนููุงุช${filterCurrency ? ` ููุนููุฉ: ${filterCurrency}` : ''}`);

    // ุฅุญุตุงุฆูุงุช ุงูุนููุงุก
    if (appData.customers) {
        appData.customers.forEach(customer => {
            // ุงูุชุนุงูู ูุน ุงูุฃุฑุตุฏุฉ ูุชุนุฏุฏุฉ ุงูุนููุงุช
            if (customer.balances && Object.keys(customer.balances).length > 0) {
                Object.keys(customer.balances).forEach(currency => {
                    const balance = customer.balances[currency] || 0;

                    // ุชุทุจูู ุงูููุชุฑ ุฅุฐุง ูุงู ูุญุฏุฏ
                    if (filterCurrency && filterCurrency !== 'ALL' && currency !== filterCurrency) {
                        return;
                    }

                    if (balance !== 0) { // ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุบูุฑ ุงูุตูุฑูุฉ ููุท
                        if (!stats[currency]) {
                            stats[currency] = {
                                customersCount: 0,
                                customersTotal: 0,
                                suppliersCount: 0,
                                suppliersTotal: 0,
                                netBalance: 0,
                                totalTransactions: 0,
                                averageBalance: 0,
                                maxBalance: 0,
                                minBalance: 0
                            };
                        }

                        stats[currency].customersCount++;
                        stats[currency].customersTotal += balance;
                        stats[currency].totalTransactions++;

                        // ุชุญุฏูุซ ุฃุนูู ูุฃูู ุฑุตูุฏ
                        if (Math.abs(balance) > Math.abs(stats[currency].maxBalance)) {
                            stats[currency].maxBalance = balance;
                        }
                        if (stats[currency].minBalance === 0 || Math.abs(balance) < Math.abs(stats[currency].minBalance)) {
                            stats[currency].minBalance = balance;
                        }
                    }
                });
            } else {
                // ุงูุชุนุงูู ูุน ุงูุฑุตูุฏ ุงูุญุงูู (ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ)
                const currency = customer.currency || 'SYP';
                const balance = customer.currentBalance || 0;

                // ุชุทุจูู ุงูููุชุฑ ุฅุฐุง ูุงู ูุญุฏุฏ
                if (filterCurrency && filterCurrency !== 'ALL' && currency !== filterCurrency) {
                    return;
                }

                if (balance !== 0) {
                    if (!stats[currency]) {
                        stats[currency] = {
                            customersCount: 0,
                            customersTotal: 0,
                            suppliersCount: 0,
                            suppliersTotal: 0,
                            netBalance: 0,
                            totalTransactions: 0,
                            averageBalance: 0,
                            maxBalance: 0,
                            minBalance: 0
                        };
                    }

                    stats[currency].customersCount++;
                    stats[currency].customersTotal += balance;
                    stats[currency].totalTransactions++;

                    // ุชุญุฏูุซ ุฃุนูู ูุฃูู ุฑุตูุฏ
                    if (Math.abs(balance) > Math.abs(stats[currency].maxBalance)) {
                        stats[currency].maxBalance = balance;
                    }
                    if (stats[currency].minBalance === 0 || Math.abs(balance) < Math.abs(stats[currency].minBalance)) {
                        stats[currency].minBalance = balance;
                    }
                }
            }
        });
    }

    // ุฅุญุตุงุฆูุงุช ุงูููุฑุฏูู
    if (appData.suppliers) {
        appData.suppliers.forEach(supplier => {
            // ุงูุชุนุงูู ูุน ุงูุฃุฑุตุฏุฉ ูุชุนุฏุฏุฉ ุงูุนููุงุช
            if (supplier.balances && Object.keys(supplier.balances).length > 0) {
                Object.keys(supplier.balances).forEach(currency => {
                    const balance = supplier.balances[currency] || 0;

                    // ุชุทุจูู ุงูููุชุฑ ุฅุฐุง ูุงู ูุญุฏุฏ
                    if (filterCurrency && filterCurrency !== 'ALL' && currency !== filterCurrency) {
                        return;
                    }

                    if (balance !== 0) { // ุนุฑุถ ุงูุฃุฑุตุฏุฉ ุบูุฑ ุงูุตูุฑูุฉ ููุท
                        if (!stats[currency]) {
                            stats[currency] = {
                                customersCount: 0,
                                customersTotal: 0,
                                suppliersCount: 0,
                                suppliersTotal: 0,
                                netBalance: 0,
                                totalTransactions: 0,
                                averageBalance: 0,
                                maxBalance: 0,
                                minBalance: 0
                            };
                        }

                        stats[currency].suppliersCount++;
                        stats[currency].suppliersTotal += balance;
                        stats[currency].totalTransactions++;

                        // ุชุญุฏูุซ ุฃุนูู ูุฃูู ุฑุตูุฏ
                        if (Math.abs(balance) > Math.abs(stats[currency].maxBalance)) {
                            stats[currency].maxBalance = balance;
                        }
                        if (stats[currency].minBalance === 0 || Math.abs(balance) < Math.abs(stats[currency].minBalance)) {
                            stats[currency].minBalance = balance;
                        }
                    }
                });
            } else {
                // ุงูุชุนุงูู ูุน ุงูุฑุตูุฏ ุงูุญุงูู (ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ)
                const currency = supplier.currency || 'SYP';
                const balance = supplier.currentBalance || 0;

                // ุชุทุจูู ุงูููุชุฑ ุฅุฐุง ูุงู ูุญุฏุฏ
                if (filterCurrency && filterCurrency !== 'ALL' && currency !== filterCurrency) {
                    return;
                }

                if (balance !== 0) {
                    if (!stats[currency]) {
                        stats[currency] = {
                            customersCount: 0,
                            customersTotal: 0,
                            suppliersCount: 0,
                            suppliersTotal: 0,
                            netBalance: 0,
                            totalTransactions: 0,
                            averageBalance: 0,
                            maxBalance: 0,
                            minBalance: 0
                        };
                    }

                    stats[currency].suppliersCount++;
                    stats[currency].suppliersTotal += balance;
                    stats[currency].totalTransactions++;

                    // ุชุญุฏูุซ ุฃุนูู ูุฃูู ุฑุตูุฏ
                    if (Math.abs(balance) > Math.abs(stats[currency].maxBalance)) {
                        stats[currency].maxBalance = balance;
                    }
                    if (stats[currency].minBalance === 0 || Math.abs(balance) < Math.abs(stats[currency].minBalance)) {
                        stats[currency].minBalance = balance;
                    }
                }
            }
        });
    }

    // ุญุณุงุจ ุงูุตุงูู ูุงููุชูุณุท ููู ุนููุฉ
    Object.keys(stats).forEach(currency => {
        const currencyStats = stats[currency];
        currencyStats.netBalance = currencyStats.customersTotal + currencyStats.suppliersTotal;

        // ุญุณุงุจ ุงููุชูุณุท
        const totalAccounts = currencyStats.customersCount + currencyStats.suppliersCount;
        if (totalAccounts > 0) {
            currencyStats.averageBalance = (currencyStats.customersTotal + currencyStats.suppliersTotal) / totalAccounts;
        }
    });

    console.log(`โ ุชู ุญุณุงุจ ุฅุญุตุงุฆูุงุช ${Object.keys(stats).length} ุนููุฉ`);
    return stats;
}

/**
 * ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ
 */
function filterBalancesByCurrency() {
    const selectedCurrency = document.getElementById('balanceFilterCurrency')?.value;
    if (!selectedCurrency) return;

    const customerRows = document.querySelectorAll('#customersBalancesTable tr[data-customer-id]');
    const supplierRows = document.querySelectorAll('#suppliersBalancesTable tr[data-supplier-id]');

    let visibleCustomers = 0;
    let visibleSuppliers = 0;

    // ููุชุฑุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุน ุฏูุฉ ุฃูุจุฑ
    customerRows.forEach(row => {
        const customer = appData.customers.find(c => c.id == row.getAttribute('data-customer-id'));
        let showRow = false;

        if (selectedCurrency === 'ALL') {
            showRow = true;
        } else if (customer && customer.balances) {
            // ุงูุจุญุซ ูู ุฌููุน ุฃุฑุตุฏุฉ ุงูุนููุงุช ููุนููู
            showRow = customer.balances[selectedCurrency] && customer.balances[selectedCurrency] !== 0;
        } else if (customer && selectedCurrency === 'SYP') {
            // ุฅุธูุงุฑ ุงูุนููุงุก ุงูุฐูู ูุฏููู ุฑุตูุฏ ุจุงูููุฑุฉ ุงูุณูุฑูุฉ
            showRow = customer.currentBalance && customer.currentBalance !== 0;
        }

        if (showRow) {
            row.style.display = '';
            visibleCustomers++;
        } else {
            row.style.display = 'none';
        }
    });

    // ููุชุฑุฉ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู ูุน ุฏูุฉ ุฃูุจุฑ
    supplierRows.forEach(row => {
        const supplier = appData.suppliers.find(s => s.id == row.getAttribute('data-supplier-id'));
        let showRow = false;

        if (selectedCurrency === 'ALL') {
            showRow = true;
        } else if (supplier && supplier.balances) {
            // ุงูุจุญุซ ูู ุฌููุน ุฃุฑุตุฏุฉ ุงูุนููุงุช ููููุฑุฏ
            showRow = supplier.balances[selectedCurrency] && supplier.balances[selectedCurrency] !== 0;
        } else if (supplier && selectedCurrency === 'SYP') {
            // ุฅุธูุงุฑ ุงูููุฑุฏูู ุงูุฐูู ูุฏููู ุฑุตูุฏ ุจุงูููุฑุฉ ุงูุณูุฑูุฉ
            showRow = supplier.currentBalance && supplier.currentBalance !== 0;
        }

        if (showRow) {
            row.style.display = '';
            visibleSuppliers++;
        } else {
            row.style.display = 'none';
        }
    });

    // ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงููุชุงุฆุฌ
    const customersCount = document.getElementById('customersCount');
    const suppliersCount = document.getElementById('suppliersCount');

    if (customersCount) customersCount.textContent = visibleCustomers;
    if (suppliersCount) suppliersCount.textContent = visibleSuppliers;

    console.log(`๐ ุชู ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุนููุฉ: ${selectedCurrency} - ุนููุงุก: ${visibleCustomers}, ููุฑุฏูู: ${visibleSuppliers}`);
}

/**
 * ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูููุน
 */
function filterBalancesByType() {
    const selectedType = document.getElementById('balanceFilterType')?.value;
    if (!selectedType) return;

    const customersCard = document.querySelector('#customersBalancesTable').closest('.card');
    const suppliersCard = document.querySelector('#suppliersBalancesTable').closest('.card');

    if (selectedType === 'ALL') {
        customersCard.style.display = '';
        suppliersCard.style.display = '';
        // ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฑุถ ููุฃุนูุฏุฉ
        customersCard.parentElement.className = 'col-md-6';
        suppliersCard.parentElement.className = 'col-md-6';
    } else if (selectedType === 'customers') {
        customersCard.style.display = '';
        suppliersCard.style.display = 'none';
        customersCard.parentElement.className = 'col-12';
    } else if (selectedType === 'suppliers') {
        customersCard.style.display = 'none';
        suppliersCard.style.display = '';
        suppliersCard.parentElement.className = 'col-12';
    }

    console.log(`๐ ุชู ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูููุน: ${selectedType}`);
}

/**
 * ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุญุงูุฉ
 */
function filterBalancesByStatus() {
    const selectedStatus = document.getElementById('balanceFilterStatus')?.value;
    if (!selectedStatus) return;

    const customerRows = document.querySelectorAll('#customersBalancesTable tr[data-customer-id]');
    const supplierRows = document.querySelectorAll('#suppliersBalancesTable tr[data-supplier-id]');

    // ููุชุฑุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก
    customerRows.forEach(row => {
        const balance = parseFloat(row.getAttribute('data-balance'));
        let showRow = false;

        if (selectedStatus === 'ALL') {
            showRow = true;
        } else if (selectedStatus === 'positive' && balance > 0) {
            showRow = true;
        } else if (selectedStatus === 'negative' && balance < 0) {
            showRow = true;
        } else if (selectedStatus === 'zero' && balance === 0) {
            showRow = true;
        }

        row.style.display = showRow ? '' : 'none';
    });

    // ููุชุฑุฉ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    supplierRows.forEach(row => {
        const balance = parseFloat(row.getAttribute('data-balance'));
        let showRow = false;

        if (selectedStatus === 'ALL') {
            showRow = true;
        } else if (selectedStatus === 'positive' && balance > 0) {
            showRow = true;
        } else if (selectedStatus === 'negative' && balance < 0) {
            showRow = true;
        } else if (selectedStatus === 'zero' && balance === 0) {
            showRow = true;
        }

        row.style.display = showRow ? '' : 'none';
    });

    console.log(`๐ ุชู ููุชุฑุฉ ุงูุฃุฑุตุฏุฉ ุญุณุจ ุงูุญุงูุฉ: ${selectedStatus}`);
}

/**
 * ุงูุจุญุซ ูู ุงูุฃุฑุตุฏุฉ
 */
function searchInBalances() {
    const searchTerm = document.getElementById('balanceSearchInput')?.value?.toLowerCase() || '';

    const customerRows = document.querySelectorAll('#customersBalancesTable tr[data-customer-id]');
    const supplierRows = document.querySelectorAll('#suppliersBalancesTable tr[data-supplier-id]');

    // ุงูุจุญุซ ูู ุฃุฑุตุฏุฉ ุงูุนููุงุก
    customerRows.forEach(row => {
        const customerName = row.querySelector('td:first-child strong')?.textContent?.toLowerCase() || '';
        const customerPhone = row.querySelector('td:first-child small')?.textContent?.toLowerCase() || '';

        if (searchTerm === '' || customerName.includes(searchTerm) || customerPhone.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // ุงูุจุญุซ ูู ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    supplierRows.forEach(row => {
        const supplierName = row.querySelector('td:first-child strong')?.textContent?.toLowerCase() || '';
        const supplierPhone = row.querySelector('td:first-child small')?.textContent?.toLowerCase() || '';

        if (searchTerm === '' || supplierName.includes(searchTerm) || supplierPhone.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    console.log(`๐ ุชู ุงูุจุญุซ ูู ุงูุฃุฑุตุฏุฉ: "${searchTerm}"`);
}

/**
 * ุนุฑุถ ุชูุงุตูู ุงูุฑุตูุฏ
 */
function showBalanceDetails(type, id) {
    console.log(`๐ ุนุฑุถ ุชูุงุตูู ุงูุฑุตูุฏ: ${type} - ${id}`);

    let entity = null;
    let entityType = '';

    if (type === 'customer') {
        entity = appData.customers?.find(c => c.id === id);
        entityType = 'ุงูุนููู';
    } else if (type === 'supplier') {
        entity = appData.suppliers?.find(s => s.id === id);
        entityType = 'ุงูููุฑุฏ';
    }

    if (!entity) {
        alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุจูุงูุงุช');
        return;
    }

    // ุญุณุงุจ ุชูุงุตูู ุงูุฑุตูุฏ
    const balanceDetails = calculateDetailedBalance(type, id);

    const modal = document.getElementById('balanceDetailsModal');
    const content = document.getElementById('balanceDetailsContent');

    if (!modal || !content) return;

    const balance = entity.currentBalance || 0;
    const currency = entity.currency || 'SYP';
    const currencySymbol = getCurrencySymbol(currency);

    content.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>ูุนูููุงุช ${entityType}</h6>
                <table class="table table-sm">
                    <tr><td><strong>ุงูุงุณู:</strong></td><td>${entity.name}</td></tr>
                    <tr><td><strong>ุงููุงุชู:</strong></td><td>${entity.phone || 'ุบูุฑ ูุญุฏุฏ'}</td></tr>
                    <tr><td><strong>ุงูุจุฑูุฏ:</strong></td><td>${entity.email || 'ุบูุฑ ูุญุฏุฏ'}</td></tr>
                    <tr><td><strong>ุงูุนููุฉ:</strong></td><td>${getCurrencyName(currency)} (${currencySymbol})</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-calculator me-2"></i>ุชูุงุตูู ุงูุฑุตูุฏ</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="text-center">
                            <h4 class="${balance >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(Math.abs(balance))} ${currencySymbol}
                            </h4>
                            <p class="mb-0">
                                <span class="badge bg-${balance > 0 ? (type === 'customer' ? 'danger' : 'success') : balance < 0 ? (type === 'customer' ? 'success' : 'danger') : 'secondary'}">
                                    ${balance > 0 ? (type === 'customer' ? 'ูุฏูู' : 'ุฏุงุฆู') : balance < 0 ? (type === 'customer' ? 'ุฏุงุฆู' : 'ูุฏูู') : 'ูุชูุงุฒู'}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h6><i class="fas fa-list me-2"></i>ุชูุงุตูู ุงูุญุฑูุงุช</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>ุงูููุน</th>
                                <th>ุงูุนุฏุฏ</th>
                                <th>ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                                <th>ุงููุฏููุน</th>
                                <th>ุงููุชุจูู</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fas fa-file-invoice me-2"></i>ุงูููุงุชูุฑ</td>
                                <td>${balanceDetails.invoicesCount}</td>
                                <td>${formatCurrency(balanceDetails.invoicesTotal)} ${currencySymbol}</td>
                                <td>${formatCurrency(balanceDetails.invoicesPaid)} ${currencySymbol}</td>
                                <td>${formatCurrency(balanceDetails.invoicesRemaining)} ${currencySymbol}</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-money-bill me-2"></i>ุงูุฏูุนุงุช</td>
                                <td>${balanceDetails.paymentsCount}</td>
                                <td colspan="3">${formatCurrency(balanceDetails.paymentsTotal)} ${currencySymbol}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

/**
 * ุญุณุงุจ ุชูุงุตูู ุงูุฑุตูุฏ
 */
function calculateDetailedBalance(type, id) {
    let invoicesCount = 0;
    let invoicesTotal = 0;
    let invoicesPaid = 0;
    let invoicesRemaining = 0;
    let paymentsCount = 0;
    let paymentsTotal = 0;

    // ุญุณุงุจ ุงูููุงุชูุฑ
    if (appData.invoices) {
        const relevantInvoices = appData.invoices.filter(invoice => {
            if (type === 'customer') {
                return invoice.invoiceType === 'sale' && invoice.customerId === id;
            } else {
                return invoice.invoiceType === 'purchase' && invoice.supplierId === id;
            }
        });

        invoicesCount = relevantInvoices.length;
        relevantInvoices.forEach(invoice => {
            invoicesTotal += invoice.totalAmount || 0;
            invoicesPaid += invoice.paidAmount || 0;
            invoicesRemaining += invoice.remainingAmount || 0;
        });
    }

    // ุญุณุงุจ ุงูุฏูุนุงุช
    if (appData.payments) {
        const relevantPayments = appData.payments.filter(payment => {
            if (type === 'customer') {
                return payment.paymentType === 'receipt' && payment.customerId === id;
            } else {
                return payment.paymentType === 'payment' && payment.supplierId === id;
            }
        });

        paymentsCount = relevantPayments.length;
        relevantPayments.forEach(payment => {
            paymentsTotal += payment.amount || 0;
        });
    }

    return {
        invoicesCount,
        invoicesTotal,
        invoicesPaid,
        invoicesRemaining,
        paymentsCount,
        paymentsTotal
    };
}

/**
 * ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู Excel
 */
function exportBalancesToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู Excel...');

    try {
        const workbook = XLSX.utils.book_new();

        // ูุฑูุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก
        const customersData = [];
        customersData.push(['ุงุณู ุงูุนููู', 'ุงููุงุชู', 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', 'ุงูุนููุฉ', 'ุงูุฑุตูุฏ', 'ุงูุญุงูุฉ']);

        if (appData.customers) {
            appData.customers.forEach(customer => {
                const balance = customer.currentBalance || 0;
                const currency = customer.currency || 'SYP';
                const status = balance > 0 ? 'ูุฏูู' : balance < 0 ? 'ุฏุงุฆู' : 'ูุชูุงุฒู';

                customersData.push([
                    customer.name,
                    customer.phone || '',
                    customer.email || '',
                    getCurrencyName(currency),
                    balance,
                    status
                ]);
            });
        }

        const customersSheet = XLSX.utils.aoa_to_sheet(customersData);
        XLSX.utils.book_append_sheet(workbook, customersSheet, 'ุฃุฑุตุฏุฉ ุงูุนููุงุก');

        // ูุฑูุฉ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
        const suppliersData = [];
        suppliersData.push(['ุงุณู ุงูููุฑุฏ', 'ุงููุงุชู', 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', 'ุงูุนููุฉ', 'ุงูุฑุตูุฏ', 'ุงูุญุงูุฉ']);

        if (appData.suppliers) {
            appData.suppliers.forEach(supplier => {
                const balance = supplier.currentBalance || 0;
                const currency = supplier.currency || 'SYP';
                const status = balance > 0 ? 'ุฏุงุฆู' : balance < 0 ? 'ูุฏูู' : 'ูุชูุงุฒู';

                suppliersData.push([
                    supplier.name,
                    supplier.phone || '',
                    supplier.email || '',
                    getCurrencyName(currency),
                    balance,
                    status
                ]);
            });
        }

        const suppliersSheet = XLSX.utils.aoa_to_sheet(suppliersData);
        XLSX.utils.book_append_sheet(workbook, suppliersSheet, 'ุฃุฑุตุฏุฉ ุงูููุฑุฏูู');

        // ูุฑูุฉ ููุฎุต ุงูุนููุงุช
        const currencyStats = calculateCurrencyStatistics();
        const summaryData = [];
        summaryData.push(['ุงูุนููุฉ', 'ุนุฏุฏ ุงูุนููุงุก', 'ุฅุฌูุงูู ุฃุฑุตุฏุฉ ุงูุนููุงุก', 'ุนุฏุฏ ุงูููุฑุฏูู', 'ุฅุฌูุงูู ุฃุฑุตุฏุฉ ุงูููุฑุฏูู', 'ุงูุตุงูู']);

        Object.keys(currencyStats).forEach(currency => {
            const stats = currencyStats[currency];
            summaryData.push([
                getCurrencyName(currency),
                stats.customersCount,
                stats.customersTotal,
                stats.suppliersCount,
                stats.suppliersTotal,
                stats.netBalance
            ]);
        });

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุนููุงุช');

        // ุญูุธ ุงูููู
        const fileName = `ุฃุฑุตุฏุฉ_ุงูุนููุงุก_ูุงูููุฑุฏูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        alert('โ ุชู ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู Excel ุจูุฌุงุญ!');
        console.log('โ ุชู ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู Excel');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู PDF
 */
function exportBalancesToPDF() {
    console.log('๐ ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู PDF...');

    try {
        // ุงูุญุตูู ุนูู ุงูุนููุฉ ุงููุญุฏุฏุฉ ูู ุงูููุชุฑ
        const selectedCurrency = document.getElementById('balanceFilterCurrency')?.value || 'ALL';

        // ุฅูุดุงุก URL ููุชุตุฏูุฑ
        const exportUrl = `/api/export/balances-pdf?currency=${selectedCurrency}`;

        // ูุชุญ ุฑุงุจุท ุงูุชุญููู
        window.open(exportUrl, '_blank');

        console.log('โ ุชู ุจุฏุก ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู PDF');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู PDF:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุฃุฑุตุฏุฉ ุฅูู PDF. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุตูุญุฉ ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ
 */
function getUSDBalancesReportHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-dollar-sign me-2 text-success"></i>
                    ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ ุงูุฃูุฑููู
                </h1>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ุชูุฑูุฑ ุดุงูู:</strong> ุฌููุน ุญุฑูุงุช ุงูุฏููุงุฑ ุงูุฃูุฑููู ูู ุงููุธุงู ูู ููุงุชูุฑ ูุณูุฏุงุช ูุจุถ ูุฏูุน.
                </div>
            </div>
        </div>

        <!-- ููุงุชุฑ ุงูุชูุฑูุฑ -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    ููุงุชุฑ ุงูุชูุฑูุฑ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="usdFromDate" class="form-label">ูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="usdFromDate">
                    </div>
                    <div class="col-md-3">
                        <label for="usdToDate" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
                        <input type="date" class="form-control" id="usdToDate">
                    </div>
                    <div class="col-md-3">
                        <label for="usdTransactionType" class="form-label">ููุน ุงููุนุงููุฉ</label>
                        <select class="form-select" id="usdTransactionType">
                            <option value="">ุฌููุน ุงููุนุงููุงุช</option>
                            <option value="sales">ููุงุชูุฑ ูุจูุนุงุช</option>
                            <option value="purchases">ููุงุชูุฑ ูุดุชุฑูุงุช</option>
                            <option value="receipts">ุณูุฏุงุช ูุจุถ</option>
                            <option value="payments">ุณูุฏุงุช ุฏูุน</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-success" onclick="generateUSDReport()">
                                <i class="fas fa-chart-line me-2"></i>
                                ุฅูุดุงุก ุงูุชูุฑูุฑ
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearUSDFilters()">
                                <i class="fas fa-times me-2"></i>
                                ูุณุญ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ููุฎุต ุงูุฃุฑุตุฏุฉ -->
        <div class="row mb-4" id="usdSummaryCards" style="display: none;">
            <div class="col-md-3">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUSDRevenue">$0.00</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">ุฅุฌูุงูู ุงููุตุฑููุงุช</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUSDExpenses">$0.00</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-arrow-down fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ุตุงูู ุงูุฑุตูุฏ</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="netUSDBalance">$0.00</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col me-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ุนุฏุฏ ุงููุนุงููุงุช</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUSDTransactions">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-list fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูุชูุงุตูู -->
        <div class="card shadow" id="usdDetailsCard" style="display: none;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    ุชูุงุตูู ุญุฑูุงุช ุงูุฏููุงุฑ
                </h6>
                <div>
                    <button class="btn btn-sm btn-light" onclick="exportUSDReport('excel')">
                        <i class="fas fa-file-excel me-1"></i>
                        Excel
                    </button>
                    <button class="btn btn-sm btn-light ms-2" onclick="printUSDReport()">
                        <i class="fas fa-print me-1"></i>
                        ุทุจุงุนุฉ
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ููุน ุงููุนุงููุฉ</th>
                                <th>ุฑูู ุงููุณุชูุฏ</th>
                                <th>ุงูุนููู/ุงูููุฑุฏ</th>
                                <th>ุงููุจูุบ</th>
                                <th>ููุน ุงูุญุฑูุฉ</th>
                                <th>ุงููุตู</th>
                            </tr>
                        </thead>
                        <tbody id="usdTransactionsTable">
                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช -->
        <div class="card shadow text-center py-5" id="noUSDData">
            <div class="card-body">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช</h5>
                <p class="text-muted">ูุฑุฌู ุชุญุฏูุฏ ุงูููุงุชุฑ ูุฅูุดุงุก ุงูุชูุฑูุฑ ูุนุฑุถ ุงููุชุงุฆุฌ</p>
            </div>
        </div>
    `;
}

/**
 * ุชููุฆุฉ ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ
 */
function initializeUSDBalancesReport() {
    console.log('๐ ุชููุฆุฉ ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ...');

    // ุชุนููู ุงูุชุงุฑูุฎ ุงูุงูุชุฑุงุถู (ุขุฎุฑ 30 ููู)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

    document.getElementById('usdFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('usdToDate').value = today.toISOString().split('T')[0];

    console.log('โ ุชู ุชููุฆุฉ ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ');
}

/**
 * ุฅูุดุงุก ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ
 */
function generateUSDReport() {
    console.log('๐ ุฅูุดุงุก ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ...');

    const fromDate = document.getElementById('usdFromDate').value;
    const toDate = document.getElementById('usdToDate').value;
    const transactionType = document.getElementById('usdTransactionType').value;

    if (!fromDate || !toDate) {
        alert('ูุฑุฌู ุชุญุฏูุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ');
        return;
    }

    if (new Date(fromDate) > new Date(toDate)) {
        alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
        return;
    }

    // ุฌูุน ุฌููุน ุงููุนุงููุงุช ุจุงูุฏููุงุฑ
    const usdTransactions = collectUSDTransactions(fromDate, toDate, transactionType);

    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const stats = calculateUSDStats(usdTransactions);

    // ุนุฑุถ ุงููุชุงุฆุฌ
    displayUSDReport(usdTransactions, stats);

    console.log('โ ุชู ุฅูุดุงุก ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ');
}

/**
 * ุฌูุน ุงููุนุงููุงุช ุจุงูุฏููุงุฑ
 */
function collectUSDTransactions(fromDate, toDate, transactionType) {
    const transactions = [];

    // ููุงุชูุฑ ุงููุจูุนุงุช
    if (!transactionType || transactionType === 'sales') {
        const salesInvoices = (appData.invoices || []).filter(inv =>
            inv.invoiceType === 'sale' &&
            inv.currency === 'USD' &&
            inv.status === 'confirmed' &&
            inv.invoiceDate >= fromDate &&
            inv.invoiceDate <= toDate
        );

        salesInvoices.forEach(invoice => {
            const customer = appData.customers.find(c => c.id === invoice.customerId);
            transactions.push({
                date: invoice.invoiceDate,
                type: 'sales',
                typeText: 'ูุงุชูุฑุฉ ูุจูุนุงุช',
                documentNumber: invoice.invoiceNumber,
                clientName: customer ? customer.name : 'ุนููู ูุญุฐูู',
                amount: invoice.totalAmount,
                movementType: 'in',
                movementText: 'ุฅูุฑุงุฏ',
                description: `ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู ${invoice.invoiceNumber}`
            });
        });
    }

    // ููุงุชูุฑ ุงููุดุชุฑูุงุช
    if (!transactionType || transactionType === 'purchases') {
        const purchaseInvoices = (appData.invoices || []).filter(inv =>
            inv.invoiceType === 'purchase' &&
            inv.currency === 'USD' &&
            inv.status === 'confirmed' &&
            inv.invoiceDate >= fromDate &&
            inv.invoiceDate <= toDate
        );

        purchaseInvoices.forEach(invoice => {
            const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
            transactions.push({
                date: invoice.invoiceDate,
                type: 'purchases',
                typeText: 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช',
                documentNumber: invoice.invoiceNumber,
                clientName: supplier ? supplier.name : 'ููุฑุฏ ูุญุฐูู',
                amount: invoice.totalAmount,
                movementType: 'out',
                movementText: 'ูุตุฑูู',
                description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber}`
            });
        });
    }

    // ุณูุฏุงุช ุงููุจุถ
    if (!transactionType || transactionType === 'receipts') {
        const receipts = (appData.payments || []).filter(payment =>
            payment.paymentType === 'receipt' &&
            payment.currency === 'USD' &&
            payment.status === 'confirmed' &&
            payment.paymentDate >= fromDate &&
            payment.paymentDate <= toDate
        );

        receipts.forEach(receipt => {
            const customer = appData.customers.find(c => c.id === receipt.customerId);
            transactions.push({
                date: receipt.paymentDate,
                type: 'receipts',
                typeText: 'ุณูุฏ ูุจุถ',
                documentNumber: receipt.paymentNumber,
                clientName: customer ? customer.name : 'ุนููู ูุญุฐูู',
                amount: receipt.amount,
                movementType: 'in',
                movementText: 'ุฅูุฑุงุฏ',
                description: `ุณูุฏ ูุจุถ ุฑูู ${receipt.paymentNumber}`
            });
        });
    }

    // ุณูุฏุงุช ุงูุฏูุน
    if (!transactionType || transactionType === 'payments') {
        const payments = (appData.payments || []).filter(payment =>
            payment.paymentType === 'payment' &&
            payment.currency === 'USD' &&
            payment.status === 'confirmed' &&
            payment.paymentDate >= fromDate &&
            payment.paymentDate <= toDate
        );

        payments.forEach(payment => {
            const supplier = appData.suppliers.find(s => s.id === payment.supplierId);
            transactions.push({
                date: payment.paymentDate,
                type: 'payments',
                typeText: 'ุณูุฏ ุฏูุน',
                documentNumber: payment.paymentNumber,
                clientName: supplier ? supplier.name : 'ููุฑุฏ ูุญุฐูู',
                amount: payment.amount,
                movementType: 'out',
                movementText: 'ูุตุฑูู',
                description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber}`
            });
        });
    }

    // ุชุฑุชูุจ ุงููุนุงููุงุช ุญุณุจ ุงูุชุงุฑูุฎ
    return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
}

/**
 * ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูุฏููุงุฑ
 */
function calculateUSDStats(transactions) {
    let totalRevenue = 0;
    let totalExpenses = 0;

    transactions.forEach(transaction => {
        if (transaction.movementType === 'in') {
            totalRevenue += transaction.amount;
        } else {
            totalExpenses += transaction.amount;
        }
    });

    return {
        totalRevenue,
        totalExpenses,
        netBalance: totalRevenue - totalExpenses,
        totalTransactions: transactions.length
    };
}

/**
 * ุนุฑุถ ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ
 */
function displayUSDReport(transactions, stats) {
    // ุฅุฎูุงุก ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุช
    document.getElementById('noUSDData').style.display = 'none';

    // ุฅุธูุงุฑ ุงูููุฎุต ูุงูุชูุงุตูู
    document.getElementById('usdSummaryCards').style.display = 'flex';
    document.getElementById('usdDetailsCard').style.display = 'block';

    // ุชุญุฏูุซ ุจุทุงูุงุช ุงูููุฎุต
    document.getElementById('totalUSDRevenue').textContent = `$${formatCurrency(stats.totalRevenue)}`;
    document.getElementById('totalUSDExpenses').textContent = `$${formatCurrency(stats.totalExpenses)}`;
    document.getElementById('netUSDBalance').textContent = `$${formatCurrency(stats.netBalance)}`;
    document.getElementById('totalUSDTransactions').textContent = stats.totalTransactions;

    // ุชุญุฏูุซ ุฌุฏูู ุงูุชูุงุตูู
    const tableBody = document.getElementById('usdTransactionsTable');
    let html = '';

    if (transactions.length === 0) {
        html = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <br>ูุง ุชูุฌุฏ ูุนุงููุงุช ุจุงูุฏููุงุฑ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
                </td>
            </tr>
        `;
    } else {
        transactions.forEach(transaction => {
            const amountClass = transaction.movementType === 'in' ? 'text-success' : 'text-danger';
            const movementIcon = transaction.movementType === 'in' ? 'fa-arrow-up' : 'fa-arrow-down';

            html += `
                <tr>
                    <td>${transaction.date}</td>
                    <td>
                        <span class="badge bg-${transaction.type === 'sales' || transaction.type === 'receipts' ? 'success' : 'danger'}">
                            ${transaction.typeText}
                        </span>
                    </td>
                    <td><strong>${transaction.documentNumber}</strong></td>
                    <td>${transaction.clientName}</td>
                    <td class="${amountClass}">
                        <i class="fas ${movementIcon} me-1"></i>
                        <strong>$${formatCurrency(transaction.amount)}</strong>
                    </td>
                    <td>
                        <span class="badge bg-${transaction.movementType === 'in' ? 'success' : 'danger'}">
                            ${transaction.movementText}
                        </span>
                    </td>
                    <td>${transaction.description}</td>
                </tr>
            `;
        });
    }

    tableBody.innerHTML = html;
}

/**
 * ูุณุญ ููุงุชุฑ ุชูุฑูุฑ ุงูุฏููุงุฑ
 */
function clearUSDFilters() {
    document.getElementById('usdFromDate').value = '';
    document.getElementById('usdToDate').value = '';
    document.getElementById('usdTransactionType').value = '';

    // ุฅุฎูุงุก ุงููุชุงุฆุฌ
    document.getElementById('usdSummaryCards').style.display = 'none';
    document.getElementById('usdDetailsCard').style.display = 'none';
    document.getElementById('noUSDData').style.display = 'block';
}

/**
 * ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุฏููุงุฑ ุฅูู Excel
 */
function exportUSDReport(format) {
    const summaryCards = document.getElementById('usdSummaryCards');
    if (!summaryCards || summaryCards.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    try {
        const fromDate = document.getElementById('usdFromDate').value;
        const toDate = document.getElementById('usdToDate').value;
        const transactionType = document.getElementById('usdTransactionType').value;

        // ุฌูุน ุงูุจูุงูุงุช
        const transactions = collectUSDTransactions(fromDate, toDate, transactionType);
        const stats = calculateUSDStats(transactions);

        const workbook = XLSX.utils.book_new();

        // ูุฑูุฉ ุงูููุฎุต
        const summaryData = [
            ['ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ ุงูุฃูุฑููู'],
            ['ุงููุชุฑุฉ:', `ูู ${fromDate} ุฅูู ${toDate}`],
            ['ููุน ุงููุนุงููุฉ:', transactionType ? getTransactionTypeText(transactionType) : 'ุฌููุน ุงููุนุงููุงุช'],
            [''],
            ['ุงูููุฎุต ุงููุงูู'],
            ['ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช', `$${formatCurrency(stats.totalRevenue)}`],
            ['ุฅุฌูุงูู ุงููุตุฑููุงุช', `$${formatCurrency(stats.totalExpenses)}`],
            ['ุตุงูู ุงูุฑุตูุฏ', `$${formatCurrency(stats.netBalance)}`],
            ['ุนุฏุฏ ุงููุนุงููุงุช', stats.totalTransactions]
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต');

        // ูุฑูุฉ ุงูุชูุงุตูู
        const detailsData = [
            ['ุงูุชุงุฑูุฎ', 'ููุน ุงููุนุงููุฉ', 'ุฑูู ุงููุณุชูุฏ', 'ุงูุนููู/ุงูููุฑุฏ', 'ุงููุจูุบ', 'ููุน ุงูุญุฑูุฉ', 'ุงููุตู']
        ];

        transactions.forEach(transaction => {
            detailsData.push([
                transaction.date,
                transaction.typeText,
                transaction.documentNumber,
                transaction.clientName,
                transaction.amount,
                transaction.movementText,
                transaction.description
            ]);
        });

        const detailsSheet = XLSX.utils.aoa_to_sheet(detailsData);
        XLSX.utils.book_append_sheet(workbook, detailsSheet, 'ุงูุชูุงุตูู');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุฑูุฑ_ุฃุฑุตุฏุฉ_ุงูุฏููุงุฑ_${fromDate}_${toDate}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        alert('โ ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุชูุฑูุฑ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุชูุฑูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
    }
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฏููุงุฑ
 */
function printUSDReport() {
    const summaryCards = document.getElementById('usdSummaryCards');
    if (!summaryCards || summaryCards.style.display === 'none') {
        alert('ูุฑุฌู ุฅูุดุงุก ุงูุชูุฑูุฑ ุฃููุงู');
        return;
    }

    const fromDate = document.getElementById('usdFromDate').value;
    const toDate = document.getElementById('usdToDate').value;
    const transactionType = document.getElementById('usdTransactionType').value;

    // ุฌูุน ุงูุจูุงูุงุช
    const transactions = collectUSDTransactions(fromDate, toDate, transactionType);
    const stats = calculateUSDStats(transactions);

    // ุฅูุดุงุก ูุงูุฐุฉ ุงูุทุจุงุนุฉ
    const printWindow = window.open('', '_blank', 'width=1200,height=800');

    printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ ุงูุฃูุฑููู</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .report-header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
                @media print {
                    .no-print { display: none !important; }
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            <div class="container-fluid p-4">
                <div class="report-header p-4 rounded mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-dollar-sign me-2"></i>
                                ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุฏููุงุฑ ุงูุฃูุฑููู
                            </h2>
                            <p class="mb-0">ุงููุชุฑุฉ: ูู ${fromDate} ุฅูู ${toDate}</p>
                            ${transactionType ? `<p class="mb-0">ููุน ุงููุนุงููุฉ: ${getTransactionTypeText(transactionType)}</p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <h4>SAM PRO</h4>
                            <p class="mb-0">ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู</p>
                        </div>
                    </div>
                </div>

                <!-- ุงูููุฎุต ุงููุงูู -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</h5>
                                <h3 class="text-success">$${formatCurrency(stats.totalRevenue)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">ุฅุฌูุงูู ุงููุตุฑููุงุช</h5>
                                <h3 class="text-danger">$${formatCurrency(stats.totalExpenses)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h5 class="card-title text-info">ุตุงูู ุงูุฑุตูุฏ</h5>
                                <h3 class="${stats.netBalance >= 0 ? 'text-success' : 'text-danger'}">$${formatCurrency(stats.netBalance)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">ุนุฏุฏ ุงููุนุงููุงุช</h5>
                                <h3 class="text-warning">${stats.totalTransactions}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุฌุฏูู ุงูุชูุงุตูู -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">ุชูุงุตูู ุงููุนุงููุงุช</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>ุงูุชุงุฑูุฎ</th>
                                        <th>ููุน ุงููุนุงููุฉ</th>
                                        <th>ุฑูู ุงููุณุชูุฏ</th>
                                        <th>ุงูุนููู/ุงูููุฑุฏ</th>
                                        <th>ุงููุจูุบ</th>
                                        <th>ููุน ุงูุญุฑูุฉ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactions.map((transaction, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${transaction.date}</td>
                                            <td>${transaction.typeText}</td>
                                            <td>${transaction.documentNumber}</td>
                                            <td>${transaction.clientName}</td>
                                            <td class="${transaction.movementType === 'in' ? 'text-success' : 'text-danger'}">
                                                $${formatCurrency(transaction.amount)}
                                            </td>
                                            <td>${transaction.movementText}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4 no-print">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>
                        ุทุจุงุนุฉ
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="window.close()">
                        <i class="fas fa-times me-2"></i>
                        ุฅุบูุงู
                    </button>
                </div>
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    console.log('โ ุชู ูุชุญ ูุนุงููุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฏููุงุฑ');
}

/**
 * ุงูุญุตูู ุนูู ูุต ููุน ุงููุนุงููุฉ
 */
function getTransactionTypeText(type) {
    const types = {
        'sales': 'ููุงุชูุฑ ูุจูุนุงุช',
        'purchases': 'ููุงุชูุฑ ูุดุชุฑูุงุช',
        'receipts': 'ุณูุฏุงุช ูุจุถ',
        'payments': 'ุณูุฏุงุช ุฏูุน'
    };
    return types[type] || type;
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ
 */
function printBalancesReport() {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ...');

    const printWindow = window.open('', '_blank', 'width=800,height=600');

    const currencyStats = calculateCurrencyStatistics();
    const balanceStats = calculateBalancesStatistics();

    printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .report-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                @media print {
                    .no-print { display: none !important; }
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            <div class="container-fluid p-4">
                <!-- ุฑุฃุณ ุงูุชูุฑูุฑ -->
                <div class="report-header p-4 rounded mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-balance-scale me-2"></i>
                                ุชูุฑูุฑ ุฃุฑุตุฏุฉ ุงูุนููุงุก ูุงูููุฑุฏูู
                            </h2>
                            <p class="mb-0">ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${formatDate(new Date())}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <h4>SAM PRO</h4>
                            <p class="mb-0">ุจุฑูุงูุฌ ุงููุญุงุณุจ ุงูุฐูู</p>
                        </div>
                    </div>
                </div>

                <!-- ููุฎุต ุงูุฅุญุตุงุฆูุงุช -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                <h4 class="text-primary">${balanceStats.totalCustomers}</h4>
                                <p class="mb-0">ุฅุฌูุงูู ุงูุนููุงุก</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <i class="fas fa-truck fa-2x text-warning mb-2"></i>
                                <h4 class="text-warning">${balanceStats.totalSuppliers}</h4>
                                <p class="mb-0">ุฅุฌูุงูู ุงูููุฑุฏูู</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-arrow-up fa-2x text-success mb-2"></i>
                                <h4 class="text-success">${balanceStats.totalPositiveBalances}</h4>
                                <p class="mb-0">ุฃุฑุตุฏุฉ ููุฌุจุฉ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <i class="fas fa-arrow-down fa-2x text-danger mb-2"></i>
                                <h4 class="text-danger">${balanceStats.totalNegativeBalances}</h4>
                                <p class="mb-0">ุฃุฑุตุฏุฉ ุณุงูุจุฉ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุฃุฑุตุฏุฉ ุงูุนููุงุก -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            ุฃุฑุตุฏุฉ ุงูุนููุงุก
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>ุงุณู ุงูุนููู</th>
                                        <th>ุงููุงุชู</th>
                                        <th>ุงูุนููุฉ</th>
                                        <th>ุงูุฑุตูุฏ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appData.customers ? appData.customers.map((customer, index) => {
                                        const balance = customer.currentBalance || 0;
                                        const currency = customer.currency || 'SYP';
                                        const currencySymbol = getCurrencySymbol(currency);
                                        const status = balance > 0 ? 'ูุฏูู' : balance < 0 ? 'ุฏุงุฆู' : 'ูุชูุงุฒู';

                                        return `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td><strong>${customer.name}</strong></td>
                                            <td>${customer.phone || '-'}</td>
                                            <td>${getCurrencyName(currency)}</td>
                                            <td>${formatCurrency(Math.abs(balance))} ${currencySymbol}</td>
                                            <td><span class="badge bg-${balance > 0 ? 'danger' : balance < 0 ? 'success' : 'secondary'}">${status}</span></td>
                                        </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="6" class="text-center">ูุง ุชูุฌุฏ ุนููุงุก</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ุฃุฑุตุฏุฉ ุงูููุฑุฏูู -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-truck me-2"></i>
                            ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>ุงุณู ุงูููุฑุฏ</th>
                                        <th>ุงููุงุชู</th>
                                        <th>ุงูุนููุฉ</th>
                                        <th>ุงูุฑุตูุฏ</th>
                                        <th>ุงูุญุงูุฉ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appData.suppliers ? appData.suppliers.map((supplier, index) => {
                                        const balance = supplier.currentBalance || 0;
                                        const currency = supplier.currency || 'SYP';
                                        const currencySymbol = getCurrencySymbol(currency);
                                        const status = balance > 0 ? 'ุฏุงุฆู' : balance < 0 ? 'ูุฏูู' : 'ูุชูุงุฒู';

                                        return `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td><strong>${supplier.name}</strong></td>
                                            <td>${supplier.phone || '-'}</td>
                                            <td>${getCurrencyName(currency)}</td>
                                            <td>${formatCurrency(Math.abs(balance))} ${currencySymbol}</td>
                                            <td><span class="badge bg-${balance > 0 ? 'success' : balance < 0 ? 'danger' : 'secondary'}">${status}</span></td>
                                        </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="6" class="text-center">ูุง ุชูุฌุฏ ููุฑุฏูู</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุทุจุงุนุฉ -->
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>ุทุจุงุนุฉ
                    </button>
                    <button class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-times me-2"></i>ุฅุบูุงู
                    </button>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
        </body>
        </html>
    `);

    printWindow.document.close();
    console.log('โ ุชู ูุชุญ ูุงูุฐุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ุงูุฃุฑุตุฏุฉ');
}

/**
 * ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
 */
function getBackupRestoreHTML() {
    return `
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-shield-alt me-2 text-primary"></i>
                    ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
                </h1>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ุญูุงูุฉ ุจูุงูุงุชู:</strong> ูู ุจุฅูุดุงุก ูุณุฎ ุงุญุชูุงุทูุฉ ููุชุธูุฉ ูุญูุงูุฉ ุจูุงูุงุชู ูู ุงูููุฏุงูุ ูุงุณุชุนุฏ ุงูุจูุงูุงุช ุนูุฏ ุงูุญุงุฌุฉ.
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ุงููุณุฎ ุงูุงุญุชูุงุทู -->
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-download me-2"></i>
                            ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            ูู ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ูู ุฌููุน ุจูุงูุงุชู ุจูุง ูู ุฐูู:
                        </p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>ุงูุนููุงุก ูุงูููุฑุฏูู</li>
                            <li><i class="fas fa-check text-success me-2"></i>ุงูุฃุตูุงู ูุงููุฎุงุฒู</li>
                            <li><i class="fas fa-check text-success me-2"></i>ุงูููุงุชูุฑ ูุงููุจูุนุงุช</li>
                            <li><i class="fas fa-check text-success me-2"></i>ุงููุดุชุฑูุงุช ูุงูุฏูุนุงุช</li>
                            <li><i class="fas fa-check text-success me-2"></i>ุงูุฅุนุฏุงุฏุงุช ูุงูุชููููุงุช</li>
                        </ul>

                        <div class="mb-3">
                            <label for="backupType" class="form-label">ููุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</label>
                            <select class="form-select" id="backupType">
                                <option value="full">ูุณุฎุฉ ูุงููุฉ (ุฌููุน ุงูุจูุงูุงุช)</option>
                                <option value="data-only">ุงูุจูุงูุงุช ููุท (ุจุฏูู ุฅุนุฏุงุฏุงุช)</option>
                                <option value="settings-only">ุงูุฅุนุฏุงุฏุงุช ููุท</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="backupFormat" class="form-label">ุชูุณูู ุงูููู</label>
                            <select class="form-select" id="backupFormat">
                                <option value="json">JSON (ููุตู ุจู)</option>
                                <option value="csv">CSV (ููุงุณุชูุฑุงุฏ ูู Excel)</option>
                                <option value="sql">SQL (ูุงุนุฏุฉ ุจูุงูุงุช)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeImages" checked>
                                <label class="form-check-label" for="includeImages">
                                    ุชุถููู ุงูุตูุฑ ูุงููููุงุช ุงููุฑููุฉ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="compressBackup" checked>
                                <label class="form-check-label" for="compressBackup">
                                    ุถุบุท ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="createBackup()">
                                <i class="fas fa-download me-2"></i>
                                ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="scheduleAutoBackup()">
                                <i class="fas fa-clock me-2"></i>
                                ุฌุฏููุฉ ุงููุณุฎ ุงูุชููุงุฆู
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุงุณุชุนุงุฏุฉ -->
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>
                            ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>ุชุญุฐูุฑ:</strong> ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุณุชุณุชุจุฏู ุงูุจูุงูุงุช ุงูุญุงููุฉ. ุชุฃูุฏ ูู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃููุงู.
                        </div>

                        <div class="mb-3">
                            <label for="restoreFile" class="form-label">ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</label>
                            <input type="file" class="form-control" id="restoreFile"
                                   accept=".json,.csv,.sql,.zip" onchange="validateRestoreFile()">
                            <div class="form-text">
                                ุงููููุงุช ุงููุฏุนููุฉ: JSON, CSV, SQL, ZIP
                            </div>
                        </div>

                        <div class="mb-3" id="restoreOptions" style="display: none;">
                            <label class="form-label">ุฎูุงุฑุงุช ุงูุงุณุชุนุงุฏุฉ</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="restoreMode" id="restoreReplace" value="replace" checked>
                                <label class="form-check-label" for="restoreReplace">
                                    ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="restoreMode" id="restoreMerge" value="merge">
                                <label class="form-check-label" for="restoreMerge">
                                    ุฏูุฌ ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="restoreMode" id="restorePreview" value="preview">
                                <label class="form-check-label" for="restorePreview">
                                    ูุนุงููุฉ ููุท (ุจุฏูู ุชุทุจูู)
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-warning btn-lg" id="restoreButton"
                                    onclick="restoreBackup()" disabled>
                                <i class="fas fa-upload me-2"></i>
                                ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="validateBackupFile()">
                                <i class="fas fa-check-circle me-2"></i>
                                ุงูุชุญูู ูู ุตุญุฉ ุงูููู
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ุงูุชุงุฑูุฎ ูุงูููุช</th>
                                        <th>ุงูููุน</th>
                                        <th>ุงูุญุฌู</th>
                                        <th>ุงูุญุงูุฉ</th>
                                        <th>ุงูููุงุญุธุงุช</th>
                                        <th>ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="backupHistoryTable">
                                    <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="autoBackupEnabled" class="form-label">ุชูุนูู ุงููุณุฎ ุงูุชููุงุฆู</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoBackupEnabled"
                                               onchange="toggleAutoBackup()">
                                        <label class="form-check-label" for="autoBackupEnabled">
                                            ููุนู
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="autoBackupFrequency" class="form-label">ุชูุฑุงุฑ ุงููุณุฎ</label>
                                    <select class="form-select" id="autoBackupFrequency">
                                        <option value="daily">ููููุงู</option>
                                        <option value="weekly">ุฃุณุจูุนูุงู</option>
                                        <option value="monthly">ุดูุฑูุงู</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="autoBackupTime" class="form-label">ููุช ุงููุณุฎ</label>
                                    <input type="time" class="form-control" id="autoBackupTime" value="02:00">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxBackupFiles" class="form-label">ุนุฏุฏ ุงููุณุฎ ุงููุญููุธุฉ</label>
                                    <input type="number" class="form-control" id="maxBackupFiles"
                                           min="1" max="50" value="10">
                                    <div class="form-text">
                                        ุณูุชู ุญุฐู ุงููุณุฎ ุงูุฃูุฏู ุชููุงุฆูุงู
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="backupLocation" class="form-label">ูุฌูุฏ ุงูุญูุธ</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="backupLocation"
                                               value="Downloads/SAM_Backups" readonly>
                                        <button class="btn btn-outline-secondary" type="button"
                                                onclick="selectBackupLocation()">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" onclick="saveAutoBackupSettings()">
                                <i class="fas fa-save me-2"></i>
                                ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุชูุฏู ุงูุนูููุฉ -->
        <div class="modal fade" id="backupProgressModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            ุฌุงุฑู ุงููุนุงูุฌุฉ...
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="backupProgressBar" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <p id="backupProgressText">ุฌุงุฑู ุงูุชุญุถูุฑ...</p>
                        <div class="text-center">
                            <small class="text-muted" id="backupProgressDetails"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * ุชููุฆุฉ ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
 */
function initializeBackupRestorePage() {
    console.log('๐ ุชููุฆุฉ ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ...');

    // ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู
    loadAutoBackupSettings();

    // ุชุญููู ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
    loadBackupHistory();

    console.log('โ ุชู ุชููุฆุฉ ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ');
}

/**
 * ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
 */
function createBackup() {
    console.log('๐พ ุจุฏุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');

    const backupType = document.getElementById('backupType')?.value || 'full';
    const backupFormat = document.getElementById('backupFormat')?.value || 'json';
    const includeImages = document.getElementById('includeImages')?.checked || false;
    const compressBackup = document.getElementById('compressBackup')?.checked || false;

    // ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุชูุฏู
    showBackupProgress('ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ', 'ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุงูุงุช...');

    try {
        // ุฌูุน ุงูุจูุงูุงุช ุญุณุจ ุงูููุน ุงููุญุฏุฏ
        let backupData = {};

        if (backupType === 'full' || backupType === 'data-only') {
            updateBackupProgress(10, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงูุนููุงุก...');
            backupData.customers = appData.customers || [];

            updateBackupProgress(20, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงูููุฑุฏูู...');
            backupData.suppliers = appData.suppliers || [];

            updateBackupProgress(30, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงูุฃุตูุงู...');
            backupData.products = appData.products || [];

            updateBackupProgress(40, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงููุฎุงุฒู...');
            backupData.warehouses = appData.warehouses || [];

            updateBackupProgress(50, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงูููุงุชูุฑ...');
            backupData.invoices = appData.invoices || [];

            updateBackupProgress(60, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงูุฏูุนุงุช...');
            backupData.payments = appData.payments || [];

            updateBackupProgress(70, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงููุจูุนุงุช...');
            backupData.sales = appData.sales || [];

            updateBackupProgress(80, 'ุฌุงุฑู ุฌูุน ุจูุงูุงุช ุงููุดุชุฑูุงุช...');
            backupData.purchases = appData.purchases || [];
        }

        if (backupType === 'full' || backupType === 'settings-only') {
            updateBackupProgress(85, 'ุฌุงุฑู ุฌูุน ุงูุฅุนุฏุงุฏุงุช...');
            backupData.settings = appData.settings || {};
        }

        // ุฅุถุงูุฉ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
        backupData.backupInfo = {
            version: '1.0',
            createdAt: new Date().toISOString(),
            type: backupType,
            format: backupFormat,
            includeImages: includeImages,
            compressed: compressBackup,
            appVersion: 'SAM PRO v1.0',
            dataCount: {
                customers: backupData.customers?.length || 0,
                suppliers: backupData.suppliers?.length || 0,
                products: backupData.products?.length || 0,
                warehouses: backupData.warehouses?.length || 0,
                invoices: backupData.invoices?.length || 0,
                payments: backupData.payments?.length || 0,
                sales: backupData.sales?.length || 0,
                purchases: backupData.purchases?.length || 0
            }
        };

        updateBackupProgress(90, 'ุฌุงุฑู ุชุญุถูุฑ ุงูููู ููุชุญููู...');

        // ุชุญููู ุงูุจูุงูุงุช ุญุณุจ ุงูุชูุณูู ุงููุทููุจ
        let fileContent, fileName, mimeType;

        if (backupFormat === 'json') {
            fileContent = JSON.stringify(backupData, null, 2);
            fileName = `SAM_Backup_${backupType}_${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
        } else if (backupFormat === 'csv') {
            fileContent = convertToCSV(backupData);
            fileName = `SAM_Backup_${backupType}_${new Date().toISOString().split('T')[0]}.csv`;
            mimeType = 'text/csv';
        } else if (backupFormat === 'sql') {
            fileContent = convertToSQL(backupData);
            fileName = `SAM_Backup_${backupType}_${new Date().toISOString().split('T')[0]}.sql`;
            mimeType = 'application/sql';
        }

        updateBackupProgress(95, 'ุฌุงุฑู ุชุญููู ุงูููู...');

        // ุชุญููู ุงูููู
        downloadFile(fileContent, fileName, mimeType);

        // ุชุณุฌูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู ุงูุณุฌู
        addToBackupHistory({
            date: new Date().toISOString(),
            type: backupType,
            format: backupFormat,
            size: formatFileSize(fileContent.length),
            status: 'success',
            fileName: fileName,
            notes: `ูุณุฎุฉ ุงุญุชูุงุทูุฉ ${backupType === 'full' ? 'ูุงููุฉ' : backupType === 'data-only' ? 'ููุจูุงูุงุช ููุท' : 'ููุฅุนุฏุงุฏุงุช ููุท'}`
        });

        updateBackupProgress(100, 'ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!');

        setTimeout(() => {
            hideBackupProgress();
            alert(`โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!

๐ ุงุณู ุงูููู: ${fileName}
๐ ููุน ุงููุณุฎุฉ: ${backupType === 'full' ? 'ูุงููุฉ' : backupType === 'data-only' ? 'ุงูุจูุงูุงุช ููุท' : 'ุงูุฅุนุฏุงุฏุงุช ููุท'}
๐พ ุงูุชูุณูู: ${backupFormat.toUpperCase()}
๐ ุงูุญุฌู: ${formatFileSize(fileContent.length)}

ุชู ุญูุธ ุงูููู ูู ูุฌูุฏ ุงูุชุญูููุงุช.`);

            // ุชุญุฏูุซ ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
            loadBackupHistory();
        }, 1000);

        console.log('โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ:', fileName);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', error);
        hideBackupProgress();
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');

        // ุชุณุฌูู ุงูุฎุทุฃ ูู ุงูุณุฌู
        addToBackupHistory({
            date: new Date().toISOString(),
            type: backupType,
            format: backupFormat,
            size: '0 KB',
            status: 'error',
            fileName: 'ูุดู',
            notes: `ุฎุทุฃ: ${error.message}`
        });
    }
}

/**
 * ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
 */
function restoreBackup() {
    console.log('๐ฅ ุจุฏุก ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...');

    const fileInput = document.getElementById('restoreFile');
    const restoreMode = document.querySelector('input[name="restoreMode"]:checked')?.value || 'replace';

    if (!fileInput.files || fileInput.files.length === 0) {
        alert('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุฃููุงู');
        return;
    }

    const file = fileInput.files[0];

    // ุชุฃููุฏ ุงูุนูููุฉ
    const confirmMessage = restoreMode === 'replace' ?
        'ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.' :
        restoreMode === 'merge' ?
        'ูู ุฃูุช ูุชุฃูุฏ ูู ุฏูุฌ ุงูุจูุงูุงุช ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉุ' :
        'ุณูุชู ุนุฑุถ ูุนุงููุฉ ููุจูุงูุงุช ููุท ุจุฏูู ุชุทุจูู ุงูุชุบููุฑุงุช.';

    if (!confirm(confirmMessage)) {
        return;
    }

    // ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุชูุฏู
    showBackupProgress('ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ', 'ุฌุงุฑู ูุฑุงุกุฉ ุงูููู...');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            updateBackupProgress(20, 'ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...');

            let backupData;
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'json') {
                backupData = JSON.parse(e.target.result);
            } else if (fileExtension === 'csv') {
                backupData = parseCSVBackup(e.target.result);
            } else if (fileExtension === 'sql') {
                backupData = parseSQLBackup(e.target.result);
            } else {
                throw new Error('ุชูุณูู ุงูููู ุบูุฑ ูุฏุนูู');
            }

            updateBackupProgress(40, 'ุฌุงุฑู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช...');

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
            if (!validateBackupData(backupData)) {
                throw new Error('ุงูุจูุงูุงุช ูู ุงูููู ุบูุฑ ุตุญูุญุฉ ุฃู ุชุงููุฉ');
            }

            updateBackupProgress(60, 'ุฌุงุฑู ุชุทุจูู ุงูุจูุงูุงุช...');

            if (restoreMode === 'preview') {
                // ูุนุงููุฉ ููุท
                showBackupPreview(backupData);
                hideBackupProgress();
                return;
            }

            // ุชุทุจูู ุงูุจูุงูุงุช
            applyBackupData(backupData, restoreMode);

            updateBackupProgress(90, 'ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช...');

            // ุญูุธ ุงูุจูุงูุงุช
            saveData();

            updateBackupProgress(100, 'ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!');

            // ุชุณุฌูู ุงูุนูููุฉ ูู ุงูุณุฌู
            addToBackupHistory({
                date: new Date().toISOString(),
                type: 'restore',
                format: fileExtension,
                size: formatFileSize(file.size),
                status: 'success',
                fileName: file.name,
                notes: `ุงุณุชุนุงุฏุฉ ุจูุฌุงุญ - ูุถุน: ${restoreMode}`
            });

            setTimeout(() => {
                hideBackupProgress();
                alert(`โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!

๐ ุงูููู: ${file.name}
๐ ุงููุถุน: ${restoreMode === 'replace' ? 'ุงุณุชุจุฏุงู' : 'ุฏูุฌ'}
๐ ุงูุจูุงูุงุช ุงููุณุชุนุงุฏุฉ:
โข ุงูุนููุงุก: ${backupData.customers?.length || 0}
โข ุงูููุฑุฏูู: ${backupData.suppliers?.length || 0}
โข ุงูุฃุตูุงู: ${backupData.products?.length || 0}
โข ุงูููุงุชูุฑ: ${backupData.invoices?.length || 0}

ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช.`);

                // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
                location.reload();
            }, 1000);

            console.log('โ ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ');

        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:', error);
            hideBackupProgress();
            alert(`ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:

${error.message}

ูุฑุฌู ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูููู ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.`);

            // ุชุณุฌูู ุงูุฎุทุฃ ูู ุงูุณุฌู
            addToBackupHistory({
                date: new Date().toISOString(),
                type: 'restore',
                format: file.name.split('.').pop(),
                size: formatFileSize(file.size),
                status: 'error',
                fileName: file.name,
                notes: `ุฎุทุฃ: ${error.message}`
            });
        }
    };

    reader.onerror = function() {
        hideBackupProgress();
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู');
    };

    reader.readAsText(file);
}

/**
 * ุงูุชุญูู ูู ุตุญุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
 */
function validateRestoreFile() {
    const fileInput = document.getElementById('restoreFile');
    const restoreOptions = document.getElementById('restoreOptions');
    const restoreButton = document.getElementById('restoreButton');

    if (fileInput.files && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileExtension = file.name.split('.').pop().toLowerCase();
        const supportedFormats = ['json', 'csv', 'sql', 'zip'];

        if (supportedFormats.includes(fileExtension)) {
            restoreOptions.style.display = 'block';
            restoreButton.disabled = false;

            // ุนุฑุถ ูุนูููุงุช ุงูููู
            const fileInfo = `
                <div class="alert alert-info mt-2">
                    <strong>ูุนูููุงุช ุงูููู:</strong><br>
                    ุงูุงุณู: ${file.name}<br>
                    ุงูุญุฌู: ${formatFileSize(file.size)}<br>
                    ุงูููุน: ${fileExtension.toUpperCase()}
                </div>
            `;

            if (!document.getElementById('fileInfo')) {
                const fileInfoDiv = document.createElement('div');
                fileInfoDiv.id = 'fileInfo';
                fileInfoDiv.innerHTML = fileInfo;
                fileInput.parentNode.appendChild(fileInfoDiv);
            } else {
                document.getElementById('fileInfo').innerHTML = fileInfo;
            }
        } else {
            restoreOptions.style.display = 'none';
            restoreButton.disabled = true;
            alert('ุชูุณูู ุงูููู ุบูุฑ ูุฏุนูู. ุงููููุงุช ุงููุฏุนููุฉ: JSON, CSV, SQL, ZIP');
        }
    } else {
        restoreOptions.style.display = 'none';
        restoreButton.disabled = true;

        // ุฅุฒุงูุฉ ูุนูููุงุช ุงูููู
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) {
            fileInfo.remove();
        }
    }
}

/**
 * ุฅุธูุงุฑ ูุงูุฐุฉ ุชูุฏู ุงูุนูููุฉ
 */
function showBackupProgress(title, message) {
    const modal = document.getElementById('backupProgressModal');
    const titleElement = modal.querySelector('.modal-title');
    const textElement = document.getElementById('backupProgressText');

    titleElement.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${title}`;
    textElement.textContent = message;

    const progressBar = document.getElementById('backupProgressBar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';

    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

/**
 * ุชุญุฏูุซ ุชูุฏู ุงูุนูููุฉ
 */
function updateBackupProgress(percentage, message, details = '') {
    const progressBar = document.getElementById('backupProgressBar');
    const textElement = document.getElementById('backupProgressText');
    const detailsElement = document.getElementById('backupProgressDetails');

    progressBar.style.width = `${percentage}%`;
    progressBar.textContent = `${percentage}%`;
    textElement.textContent = message;
    detailsElement.textContent = details;
}

/**
 * ุฅุฎูุงุก ูุงูุฐุฉ ุชูุฏู ุงูุนูููุฉ
 */
function hideBackupProgress() {
    const modal = document.getElementById('backupProgressModal');
    const bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (bootstrapModal) {
        bootstrapModal.hide();
    }
}

/**
 * ุชุญููู ููู
 */
function downloadFile(content, fileName, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.style.display = 'none';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);
}

/**
 * ุชูุณูู ุญุฌู ุงูููู
 */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * ุชุญููู ุงูุจูุงูุงุช ุฅูู CSV
 */
function convertToCSV(data) {
    let csv = '';

    // ุฅุถุงูุฉ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
    csv += 'SAM PRO Backup File\n';
    csv += `Created: ${data.backupInfo.createdAt}\n`;
    csv += `Type: ${data.backupInfo.type}\n\n`;

    // ุชุญููู ูู ุฌุฏูู ุฅูู CSV
    Object.keys(data).forEach(tableName => {
        if (tableName === 'backupInfo') return;

        const tableData = data[tableName];
        if (Array.isArray(tableData) && tableData.length > 0) {
            csv += `\n--- ${tableName.toUpperCase()} ---\n`;

            // ุฑุคูุณ ุงูุฃุนูุฏุฉ
            const headers = Object.keys(tableData[0]);
            csv += headers.join(',') + '\n';

            // ุงูุจูุงูุงุช
            tableData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                });
                csv += values.join(',') + '\n';
            });
        }
    });

    return csv;
}

/**
 * ุชุญููู ุงูุจูุงูุงุช ุฅูู SQL
 */
function convertToSQL(data) {
    let sql = '';

    // ุฅุถุงูุฉ ุชุนูููุงุช
    sql += `-- SAM PRO Database Backup\n`;
    sql += `-- Created: ${data.backupInfo.createdAt}\n`;
    sql += `-- Type: ${data.backupInfo.type}\n\n`;

    // ุฅูุดุงุก ุงูุฌุฏุงูู ูุงูุจูุงูุงุช
    Object.keys(data).forEach(tableName => {
        if (tableName === 'backupInfo') return;

        const tableData = data[tableName];
        if (Array.isArray(tableData) && tableData.length > 0) {
            sql += `-- Table: ${tableName}\n`;
            sql += `DROP TABLE IF EXISTS ${tableName};\n`;

            // ุฅูุดุงุก ุงูุฌุฏูู
            const firstRow = tableData[0];
            const columns = Object.keys(firstRow).map(key => {
                const value = firstRow[key];
                const type = typeof value === 'number' ? 'DECIMAL(15,2)' : 'TEXT';
                return `${key} ${type}`;
            });

            sql += `CREATE TABLE ${tableName} (\n`;
            sql += `  ${columns.join(',\n  ')}\n`;
            sql += `);\n\n`;

            // ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช
            tableData.forEach(row => {
                const values = Object.values(row).map(value => {
                    if (value === null || value === undefined) return 'NULL';
                    if (typeof value === 'string') return `'${value.replace(/'/g, "''")}'`;
                    return value;
                });

                sql += `INSERT INTO ${tableName} VALUES (${values.join(', ')});\n`;
            });

            sql += '\n';
        }
    });

    return sql;
}

/**
 * ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
 */
function validateBackupData(data) {
    try {
        // ุงูุชุญูู ูู ูุฌูุฏ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
        if (!data.backupInfo) {
            console.warn('โ๏ธ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ููููุฏุฉ');
        }

        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        const requiredTables = ['customers', 'suppliers', 'products', 'warehouses'];
        let hasValidData = false;

        requiredTables.forEach(table => {
            if (data[table] && Array.isArray(data[table])) {
                hasValidData = true;
                console.log(`โ ุฌุฏูู ${table}: ${data[table].length} ุนูุตุฑ`);
            }
        });

        if (!hasValidData) {
            throw new Error('ูุง ุชูุฌุฏ ุจูุงูุงุช ุตุญูุญุฉ ูู ุงูููู');
        }

        return true;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุจูุงูุงุช:', error);
        return false;
    }
}

/**
 * ุชุทุจูู ุจูุงูุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
 */
function applyBackupData(backupData, mode) {
    console.log(`๐ ุชุทุจูู ุงูุจูุงูุงุช - ุงููุถุน: ${mode}`);

    if (mode === 'replace') {
        // ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช
        Object.keys(backupData).forEach(key => {
            if (key !== 'backupInfo') {
                appData[key] = backupData[key] || [];
            }
        });
    } else if (mode === 'merge') {
        // ุฏูุฌ ุงูุจูุงูุงุช
        Object.keys(backupData).forEach(key => {
            if (key !== 'backupInfo' && Array.isArray(backupData[key])) {
                if (!appData[key]) {
                    appData[key] = [];
                }

                // ุฏูุฌ ุงูุจูุงูุงุช ูุน ุชุฌูุจ ุงูุชูุฑุงุฑ
                backupData[key].forEach(item => {
                    const existingIndex = appData[key].findIndex(existing =>
                        existing.id === item.id || existing.name === item.name
                    );

                    if (existingIndex >= 0) {
                        // ุชุญุฏูุซ ุงูุนูุตุฑ ุงูููุฌูุฏ
                        appData[key][existingIndex] = { ...appData[key][existingIndex], ...item };
                    } else {
                        // ุฅุถุงูุฉ ุนูุตุฑ ุฌุฏูุฏ
                        appData[key].push(item);
                    }
                });
            }
        });
    }

    console.log('โ ุชู ุชุทุจูู ุงูุจูุงูุงุช ุจูุฌุงุญ');
}

/**
 * ุฅุถุงูุฉ ุนูููุฉ ุฅูู ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
 */
function addToBackupHistory(entry) {
    if (!appData.backupHistory) {
        appData.backupHistory = [];
    }

    appData.backupHistory.unshift(entry); // ุฅุถุงูุฉ ูู ุงูููุฏูุฉ

    // ุงูุงุญุชูุงุธ ุจุขุฎุฑ 50 ุนูููุฉ ููุท
    if (appData.backupHistory.length > 50) {
        appData.backupHistory = appData.backupHistory.slice(0, 50);
    }

    saveData();
}

/**
 * ุชุญููู ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
 */
function loadBackupHistory() {
    const tableBody = document.getElementById('backupHistoryTable');
    if (!tableBody) return;

    const history = appData.backupHistory || [];

    if (history.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-history fa-2x mb-2"></i>
                    <br>ูุง ุชูุฌุฏ ุนูููุงุช ูุณุฎ ุงุญุชูุงุทู ูุณุฌูุฉ
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    history.forEach((entry, index) => {
        const date = new Date(entry.date);
        const statusClass = entry.status === 'success' ? 'success' : 'danger';
        const statusIcon = entry.status === 'success' ? 'check-circle' : 'exclamation-circle';
        const statusText = entry.status === 'success' ? 'ูุฌุญ' : 'ูุดู';

        html += `
            <tr>
                <td>
                    <div>${formatDate(date)}</div>
                    <small class="text-muted">${date.toLocaleTimeString('ar-SA')}</small>
                </td>
                <td>
                    <span class="badge bg-info">
                        ${entry.type === 'full' ? 'ูุงููุฉ' :
                          entry.type === 'data-only' ? 'ุงูุจูุงูุงุช ููุท' :
                          entry.type === 'settings-only' ? 'ุงูุฅุนุฏุงุฏุงุช ููุท' :
                          entry.type === 'restore' ? 'ุงุณุชุนุงุฏุฉ' : entry.type}
                    </span>
                </td>
                <td>${entry.size}</td>
                <td>
                    <span class="badge bg-${statusClass}">
                        <i class="fas fa-${statusIcon} me-1"></i>
                        ${statusText}
                    </span>
                </td>
                <td>
                    <div>${entry.fileName}</div>
                    ${entry.notes ? `<small class="text-muted">${entry.notes}</small>` : ''}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        ${entry.status === 'success' && entry.type !== 'restore' ? `
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="downloadBackupAgain('${entry.fileName}')"
                                    title="ุชุญููู ูุฑุฉ ุฃุฎุฑู">
                                <i class="fas fa-download"></i>
                            </button>
                        ` : ''}
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="removeFromBackupHistory(${index})"
                                title="ุญุฐู ูู ุงูุณุฌู">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tableBody.innerHTML = html;
}

/**
 * ุญุฐู ุนูููุฉ ูู ุณุฌู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
 */
function removeFromBackupHistory(index) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุนูููุฉ ูู ุงูุณุฌูุ')) {
        appData.backupHistory.splice(index, 1);
        saveData();
        loadBackupHistory();
    }
}

/**
 * ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู
 */
function loadAutoBackupSettings() {
    const settings = appData.settings?.autoBackup || {};

    const enabledCheckbox = document.getElementById('autoBackupEnabled');
    const frequencySelect = document.getElementById('autoBackupFrequency');
    const timeInput = document.getElementById('autoBackupTime');
    const maxFilesInput = document.getElementById('maxBackupFiles');
    const locationInput = document.getElementById('backupLocation');

    if (enabledCheckbox) enabledCheckbox.checked = settings.enabled || false;
    if (frequencySelect) frequencySelect.value = settings.frequency || 'weekly';
    if (timeInput) timeInput.value = settings.time || '02:00';
    if (maxFilesInput) maxFilesInput.value = settings.maxFiles || 10;
    if (locationInput) locationInput.value = settings.location || 'Downloads/SAM_Backups';
}

/**
 * ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู
 */
function saveAutoBackupSettings() {
    const enabled = document.getElementById('autoBackupEnabled')?.checked || false;
    const frequency = document.getElementById('autoBackupFrequency')?.value || 'weekly';
    const time = document.getElementById('autoBackupTime')?.value || '02:00';
    const maxFiles = parseInt(document.getElementById('maxBackupFiles')?.value) || 10;
    const location = document.getElementById('backupLocation')?.value || 'Downloads/SAM_Backups';

    if (!appData.settings) {
        appData.settings = {};
    }

    appData.settings.autoBackup = {
        enabled,
        frequency,
        time,
        maxFiles,
        location,
        lastBackup: appData.settings.autoBackup?.lastBackup || null,
        nextBackup: calculateNextBackupTime(frequency, time)
    };

    saveData();

    alert(`โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู!

๐ ุงูุญุงูุฉ: ${enabled ? 'ููุนู' : 'ูุนุทู'}
๐ ุงูุชูุฑุงุฑ: ${frequency === 'daily' ? 'ููููุงู' : frequency === 'weekly' ? 'ุฃุณุจูุนูุงู' : 'ุดูุฑูุงู'}
โฐ ุงูููุช: ${time}
๐ ุงููุฌูุฏ: ${location}
๐๏ธ ุนุฏุฏ ุงููุณุฎ ุงููุญููุธุฉ: ${maxFiles}

${enabled ? `ุงููุณุฎุฉ ุงูุชุงููุฉ: ${formatDateTime(appData.settings.autoBackup.nextBackup)}` : ''}`);

    console.log('โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุณุฎ ุงูุชููุงุฆู:', appData.settings.autoBackup);
}

/**
 * ุญุณุงุจ ููุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงูุชุงููุฉ
 */
function calculateNextBackupTime(frequency, time) {
    const now = new Date();
    const [hours, minutes] = time.split(':').map(Number);

    let nextBackup = new Date();
    nextBackup.setHours(hours, minutes, 0, 0);

    // ุฅุฐุง ูุงู ุงูููุช ูุฏ ูุถู ุงููููุ ุงุจุฏุฃ ูู ุงูุบุฏ
    if (nextBackup <= now) {
        nextBackup.setDate(nextBackup.getDate() + 1);
    }

    // ุชุนุฏูู ุญุณุจ ุงูุชูุฑุงุฑ
    if (frequency === 'weekly') {
        // ุงูุจุญุซ ุนู ููู ุงูุฃุญุฏ ุงููุงุฏู
        const daysUntilSunday = (7 - nextBackup.getDay()) % 7;
        if (daysUntilSunday > 0) {
            nextBackup.setDate(nextBackup.getDate() + daysUntilSunday);
        }
    } else if (frequency === 'monthly') {
        // ุฃูู ููู ูู ุงูุดูุฑ ุงููุงุฏู
        nextBackup.setMonth(nextBackup.getMonth() + 1, 1);
    }

    return nextBackup.toISOString();
}

/**
 * ุชูุนูู/ุฅูุบุงุก ุชูุนูู ุงููุณุฎ ุงูุชููุงุฆู
 */
function toggleAutoBackup() {
    const enabled = document.getElementById('autoBackupEnabled')?.checked || false;

    if (enabled) {
        // ุชุญุฐูุฑ ุงููุณุชุฎุฏู
        const confirmed = confirm(`ูู ุชุฑูุฏ ุชูุนูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆูุ

โ๏ธ ููุงุญุธุฉ: ูุฐู ุงูููุฒุฉ ุชุนูู ููุท ุนูุฏูุง ูููู ุงูุจุฑูุงูุฌ ููุชูุญุงู ูู ุงููุชุตูุญ.

ููุญุตูู ุนูู ูุณุฎ ุงุญุชูุงุทูุฉ ุญููููุฉ ุชููุงุฆูุฉุ ูููุตุญ ุจู:
โข ุฅุนุฏุงุฏ ูููุฉ ูุฌุฏููุฉ ูู ูุธุงู ุงูุชุดุบูู
โข ุงุณุชุฎุฏุงู ุฎุฏูุฉ ุชุฎุฒูู ุณุญุงุจูุฉ
โข ุฅุนุฏุงุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ุนูู ุงูุฎุงุฏู`);

        if (!confirmed) {
            document.getElementById('autoBackupEnabled').checked = false;
            return;
        }

        // ุจุฏุก ุฌุฏููุฉ ุงููุณุฎ ุงูุชููุงุฆู
        scheduleAutoBackup();
    } else {
        // ุฅููุงู ุงููุณุฎ ุงูุชููุงุฆู
        if (window.autoBackupInterval) {
            clearInterval(window.autoBackupInterval);
            window.autoBackupInterval = null;
        }
    }
}

/**
 * ุฌุฏููุฉ ุงููุณุฎ ุงูุชููุงุฆู
 */
function scheduleAutoBackup() {
    console.log('โฐ ุฌุฏููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู...');

    // ุฅููุงู ุฃู ุฌุฏููุฉ ุณุงุจูุฉ
    if (window.autoBackupInterval) {
        clearInterval(window.autoBackupInterval);
    }

    // ูุญุต ูู ุฏูููุฉ
    window.autoBackupInterval = setInterval(() => {
        const settings = appData.settings?.autoBackup;
        if (!settings || !settings.enabled) {
            clearInterval(window.autoBackupInterval);
            return;
        }

        const now = new Date();
        const nextBackup = new Date(settings.nextBackup);

        if (now >= nextBackup) {
            console.log('๐ ุชุดุบูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู...');

            // ุชูููุฐ ุงููุณุฎ ุงูุงุญุชูุงุทู
            performAutoBackup();

            // ุญุณุงุจ ุงูููุช ุงูุชุงูู
            settings.nextBackup = calculateNextBackupTime(settings.frequency, settings.time);
            settings.lastBackup = now.toISOString();
            saveData();
        }
    }, 60000); // ูุญุต ูู ุฏูููุฉ

    console.log('โ ุชู ุฌุฏููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู');
}

/**
 * ุชูููุฐ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู
 */
function performAutoBackup() {
    console.log('๐ค ุชูููุฐ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู...');

    try {
        // ุฅุนุฏุงุฏ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุงูุชููุงุฆูุฉ
        const backupData = {
            customers: appData.customers || [],
            suppliers: appData.suppliers || [],
            products: appData.products || [],
            warehouses: appData.warehouses || [],
            invoices: appData.invoices || [],
            payments: appData.payments || [],
            sales: appData.sales || [],
            purchases: appData.purchases || [],
            settings: appData.settings || {},
            backupInfo: {
                version: '1.0',
                createdAt: new Date().toISOString(),
                type: 'auto',
                format: 'json',
                isAutomatic: true,
                appVersion: 'SAM PRO v1.0'
            }
        };

        const fileContent = JSON.stringify(backupData, null, 2);
        const fileName = `SAM_Auto_Backup_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;

        // ุชุญููู ุงูููู
        downloadFile(fileContent, fileName, 'application/json');

        // ุชุณุฌูู ูู ุงูุณุฌู
        addToBackupHistory({
            date: new Date().toISOString(),
            type: 'auto',
            format: 'json',
            size: formatFileSize(fileContent.length),
            status: 'success',
            fileName: fileName,
            notes: 'ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุชููุงุฆูุฉ'
        });

        console.log('โ ุชู ุชูููุฐ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู ุจูุฌุงุญ');

        // ุฅุดุนุงุฑ ุงููุณุชุฎุฏู (ุงุฎุชูุงุฑู)
        if (Notification.permission === 'granted') {
            new Notification('SAM PRO', {
                body: 'ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุชููุงุฆูุฉ ุจูุฌุงุญ',
                icon: '/favicon.ico'
            });
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู:', error);

        // ุชุณุฌูู ุงูุฎุทุฃ
        addToBackupHistory({
            date: new Date().toISOString(),
            type: 'auto',
            format: 'json',
            size: '0 KB',
            status: 'error',
            fileName: 'ูุดู ุชููุงุฆู',
            notes: `ุฎุทุฃ ุชููุงุฆู: ${error.message}`
        });
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ูุนูููุงุช ุงูุนููู
 */
function createCustomerInfoSheet(customer, fromDate, toDate, totalDebits, totalCredits, finalBalance) {
    const data = [
        ['ูุดู ุญุณุงุจ ุงูุนููู - ูุนูููุงุช ุชูุตูููุฉ'],
        [''],
        ['ูุนูููุงุช ุงูุนููู'],
        ['ุงุณู ุงูุนููู', customer.name],
        ['ุงูุนููุงู', customer.address || 'ุบูุฑ ูุญุฏุฏ'],
        ['ุงููุงุชู', customer.phone || 'ุบูุฑ ูุญุฏุฏ'],
        ['ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', customer.email || 'ุบูุฑ ูุญุฏุฏ'],
        [''],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ'],
        ['ูู ุชุงุฑูุฎ', fromDate || 'ุงูุจุฏุงูุฉ'],
        ['ุฅูู ุชุงุฑูุฎ', toDate || 'ุงูููุงูุฉ'],
        [''],
        ['ููุฎุต ุงูุญุณุงุจ'],
        ['ุฅุฌูุงูู ุงููุฏูู', totalDebits],
        ['ุฅุฌูุงูู ุงูุฏุงุฆู', totalCredits],
        ['ุงูุฑุตูุฏ ุงูููุงุฆู', finalBalance],
        ['ุญุงูุฉ ุงูุญุณุงุจ', finalBalance > 0 ? 'ูุฏูู' : finalBalance < 0 ? 'ุฏุงุฆู' : 'ูุชูุงุฒู'],
        [''],
        ['ูุนูููุงุช ุงูุชุตุฏูุฑ'],
        ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')],
        ['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')],
        ['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']
    ];

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 30 }];

    return worksheet;
}

/**
 * ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุฅูู Excel
 */
function exportSupplierStatementToExcel() {
    console.log('๐ ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const supplierId = document.getElementById('supplierStatementSupplier')?.value;
        const fromDate = document.getElementById('supplierStatementFromDate')?.value;
        const toDate = document.getElementById('supplierStatementToDate')?.value;

        if (!supplierId) {
            alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูููุฑุฏ ุฃููุงู');
            return;
        }

        const supplier = appData.suppliers.find(s => s.id == supplierId);
        if (!supplier) {
            alert('ุงูููุฑุฏ ุงููุญุฏุฏ ุบูุฑ ููุฌูุฏ');
            return;
        }

        // ุฌูุน ุงูุญุฑูุงุช ุงููุงููุฉ
        const transactions = [];

        // ุฅุถุงูุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช
        const supplierInvoices = appData.invoices.filter(inv =>
            inv.supplierId == supplierId &&
            inv.status === 'confirmed' &&
            (!fromDate || inv.invoiceDate >= fromDate) &&
            (!toDate || inv.invoiceDate <= toDate)
        );

        supplierInvoices.forEach(invoice => {
            transactions.push({
                date: invoice.invoiceDate,
                description: `ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฑูู ${invoice.invoiceNumber}`,
                reference: invoice.invoiceNumber,
                debit: 0,
                credit: invoice.totalAmount || 0,
                type: 'invoice'
            });
        });

        // ุฅุถุงูุฉ ุณูุฏุงุช ุงูุฏูุน
        const supplierPayments = appData.payments.filter(payment =>
            payment.supplierId == supplierId &&
            payment.paymentType === 'payment' &&
            payment.status === 'confirmed' &&
            (!fromDate || payment.paymentDate >= fromDate) &&
            (!toDate || payment.paymentDate <= toDate)
        );

        supplierPayments.forEach(payment => {
            transactions.push({
                date: payment.paymentDate,
                description: `ุณูุฏ ุฏูุน ุฑูู ${payment.paymentNumber} - ${getPaymentMethodText(payment.paymentMethod)}`,
                reference: payment.paymentNumber,
                debit: payment.amount || 0,
                credit: 0,
                type: 'payment'
            });
        });

        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

        // ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงููุชุฑุงููุฉ
        let balance = 0;
        transactions.forEach(transaction => {
            balance += transaction.credit - transaction.debit;
            transaction.balance = balance;
        });

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุงูุชุงุฑูุฎ',
            'ุงููุตู',
            'ุงููุฑุฌุน',
            'ูุฏูู',
            'ุฏุงุฆู',
            'ุงูุฑุตูุฏ'
        ];

        const data = transactions.map(transaction => [
            transaction.date,
            transaction.description,
            transaction.reference,
            transaction.debit > 0 ? transaction.debit : '',
            transaction.credit > 0 ? transaction.credit : '',
            transaction.balance
        ]);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        const totalDebits = transactions.reduce((sum, t) => sum + t.debit, 0);
        const totalCredits = transactions.reduce((sum, t) => sum + t.credit, 0);
        const finalBalance = totalCredits - totalDebits;

        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            totalDebits,
            totalCredits,
            finalBalance
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, `ูุดู ุญุณุงุจ ${supplier.name}`);

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ูุดู ุงูุญุณุงุจ');

        // ุฅุถุงูุฉ ูุฑูุฉ ูุนูููุงุช ุงูููุฑุฏ
        const supplierInfoSheet = createSupplierInfoSheet(supplier, fromDate, toDate, totalDebits, totalCredits, finalBalance);
        XLSX.utils.book_append_sheet(workbook, supplierInfoSheet, 'ูุนูููุงุช ุงูููุฑุฏ');

        // ุญูุธ ุงูููู
        const fileName = `ูุดู_ุญุณุงุจ_${supplier.name}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ูุดู ุญุณุงุจ ุงูููุฑุฏ ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ูุนูููุงุช ุงูููุฑุฏ
 */
function createSupplierInfoSheet(supplier, fromDate, toDate, totalDebits, totalCredits, finalBalance) {
    const data = [
        ['ูุดู ุญุณุงุจ ุงูููุฑุฏ - ูุนูููุงุช ุชูุตูููุฉ'],
        [''],
        ['ูุนูููุงุช ุงูููุฑุฏ'],
        ['ุงุณู ุงูููุฑุฏ', supplier.name],
        ['ุงูุนููุงู', supplier.address || 'ุบูุฑ ูุญุฏุฏ'],
        ['ุงููุงุชู', supplier.phone || 'ุบูุฑ ูุญุฏุฏ'],
        ['ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', supplier.email || 'ุบูุฑ ูุญุฏุฏ'],
        [''],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ'],
        ['ูู ุชุงุฑูุฎ', fromDate || 'ุงูุจุฏุงูุฉ'],
        ['ุฅูู ุชุงุฑูุฎ', toDate || 'ุงูููุงูุฉ'],
        [''],
        ['ููุฎุต ุงูุญุณุงุจ'],
        ['ุฅุฌูุงูู ุงููุฏูู', totalDebits],
        ['ุฅุฌูุงูู ุงูุฏุงุฆู', totalCredits],
        ['ุงูุฑุตูุฏ ุงูููุงุฆู', finalBalance],
        ['ุญุงูุฉ ุงูุญุณุงุจ', finalBalance > 0 ? 'ุฏุงุฆู' : finalBalance < 0 ? 'ูุฏูู' : 'ูุชูุงุฒู'],
        [''],
        ['ูุนูููุงุช ุงูุชุตุฏูุฑ'],
        ['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')],
        ['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')],
        ['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']
    ];

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 30 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ููุฎุต ุงูุฏูุนุงุช
 */
function createPaymentsSummarySheet(payments, type, fromDate, toDate) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalAmount = payments.reduce((sum, payment) => sum + payment.amount, 0);
    const totalCount = payments.length;

    // ุชุฌููุน ุญุณุจ ุงูุนููุฉ
    const currencyGroups = {};
    payments.forEach(payment => {
        const currency = payment.currency || 'SYP';
        if (!currencyGroups[currency]) {
            currencyGroups[currency] = { count: 0, amount: 0 };
        }
        currencyGroups[currency].count++;
        currencyGroups[currency].amount += payment.amount;
    });

    // ุชุฌููุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน
    const methodGroups = {};
    payments.forEach(payment => {
        const method = getPaymentMethodText(payment.paymentMethod);
        if (!methodGroups[method]) {
            methodGroups[method] = { count: 0, amount: 0 };
        }
        methodGroups[method].count++;
        methodGroups[method].amount += payment.amount;
    });

    const data = [
        [`ููุฎุต ุชูุฑูุฑ ุฏูุนุงุช ${type}`],
        [''],
        ['ูุนูููุงุช ุนุงูุฉ'],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ', `ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}`],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุณูุฏุงุช', totalCount],
        ['ุฅุฌูุงูู ุงููุจูุบ', totalAmount],
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ุงูุนููุฉ'],
        ['ุงูุนููุฉ', 'ุนุฏุฏ ุงูุณูุฏุงุช', 'ุงููุจูุบ']
    ];

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุนููุงุช
    Object.keys(currencyGroups).forEach(currency => {
        const group = currencyGroups[currency];
        data.push([
            getCurrencyName(currency),
            group.count,
            group.amount
        ]);
    });

    data.push(['']);
    data.push(['ุงูุชูุฒูุน ุญุณุจ ุทุฑููุฉ ุงูุฏูุน']);
    data.push(['ุทุฑููุฉ ุงูุฏูุน', 'ุนุฏุฏ ุงูุณูุฏุงุช', 'ุงููุจูุบ']);

    // ุฅุถุงูุฉ ุจูุงูุงุช ุทุฑู ุงูุฏูุน
    Object.keys(methodGroups).forEach(method => {
        const group = methodGroups[method];
        data.push([
            method,
            group.count,
            group.amount
        ]);
    });

    data.push(['']);
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุชุตุฏูุฑ ุญุฑูุฉ ูุฎุฒู ูุนูู ุฅูู Excel
 */
function exportWarehouseMovementsToExcel(warehouseId) {
    console.log(`๐ ุชุตุฏูุฑ ุญุฑูุฉ ุงููุฎุฒู ID: ${warehouseId} ุฅูู Excel...`);

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        const warehouse = appData.warehouses.find(w => w.id === warehouseId);
        if (!warehouse) {
            alert('ุงููุฎุฒู ุบูุฑ ููุฌูุฏ');
            return;
        }

        const warehouseProducts = appData.products.filter(p => p.warehouseId === warehouseId);
        const warehouseMovements = (appData.inventoryMovements || []).filter(m => m.warehouseId === warehouseId);

        // ุฅูุดุงุก ูุชุงุจ ุงูุนูู
        const workbook = XLSX.utils.book_new();

        // ูุฑูุฉ ูุนูููุงุช ุงููุฎุฒู
        const warehouseInfo = [
            ['ูุนูููุงุช ุงููุฎุฒู'],
            ['ุงุณู ุงููุฎุฒู', warehouse.name],
            ['ุงููููุน', warehouse.location || '-'],
            ['ุงููุฏูุฑ', warehouse.manager || '-'],
            ['ุงููุงุชู', warehouse.phone || '-'],
            ['ุนุฏุฏ ุงูุฃุตูุงู', warehouseProducts.length],
            ['ุชุงุฑูุฎ ุงูุชูุฑูุฑ', new Date().toLocaleDateString('ar-SY')]
        ];

        const warehouseSheet = XLSX.utils.aoa_to_sheet(warehouseInfo);
        XLSX.utils.book_append_sheet(workbook, warehouseSheet, 'ูุนูููุงุช ุงููุฎุฒู');

        // ูุฑูุฉ ุฅุญุตุงุฆูุงุช ุงููุฎุฒู
        const totalIn = warehouseMovements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
        const totalOut = warehouseMovements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
        const totalTransfers = warehouseMovements.filter(m => m.movementType === 'transfer').length;
        const totalAdjustments = warehouseMovements.filter(m => m.movementType === 'adjustment').length;

        const statsData = [
            ['ุฅุญุตุงุฆูุงุช ุงููุฎุฒู'],
            ['ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช', totalIn],
            ['ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช', totalOut],
            ['ุงูุตุงูู', totalIn - totalOut],
            ['ุนุฏุฏ ุงูุชุญูููุงุช', totalTransfers],
            ['ุนุฏุฏ ุงูุชุณููุงุช', totalAdjustments],
            ['ุฅุฌูุงูู ุงูุญุฑูุงุช', warehouseMovements.length]
        ];

        const statsSheet = XLSX.utils.aoa_to_sheet(statsData);
        XLSX.utils.book_append_sheet(workbook, statsSheet, 'ุฅุญุตุงุฆูุงุช ุงููุฎุฒู');

        // ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
        if (warehouseProducts.length > 0) {
            const productsData = [
                ['ููุฏ ุงูุตูู', 'ุงุณู ุงูุตูู', 'ุงููุญุฏุฉ', 'ุงููููุฉ ุงูุญุงููุฉ', 'ุงูุญุฏ ุงูุฃุฏูู', 'ุฅุฌูุงูู ุงูุฅุฏุฎุงู', 'ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌ', 'ุงูุตุงูู']
            ];

            warehouseProducts.forEach(product => {
                const productMovements = warehouseMovements.filter(m => m.productId === product.id);
                const productIn = productMovements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
                const productOut = productMovements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);

                productsData.push([
                    product.code,
                    product.name,
                    product.unit || 'ูุทุนุฉ',
                    product.quantity,
                    product.minQuantity || 0,
                    productIn,
                    productOut,
                    productIn - productOut
                ]);
            });

            const productsSheet = XLSX.utils.aoa_to_sheet(productsData);
            XLSX.utils.book_append_sheet(workbook, productsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');
        }

        // ูุฑูุฉ ุฌููุน ุงูุญุฑูุงุช
        if (warehouseMovements.length > 0) {
            const movementsData = [
                ['ุงูุชุงุฑูุฎ', 'ููุน ุงูุญุฑูุฉ', 'ุงูุตูู', 'ุงููููุฉ', 'ุณุนุฑ ุงููุญุฏุฉ', 'ุงููุฌููุน', 'ุงููุฑุฌุน', 'ููุงุญุธุงุช']
            ];

            warehouseMovements.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(movement => {
                const product = appData.products.find(p => p.id === movement.productId);
                const typeText = {
                    'in': 'ุฅุฏุฎุงู',
                    'out': 'ุฅุฎุฑุงุฌ',
                    'transfer': 'ุชุญููู',
                    'adjustment': 'ุชุณููุฉ'
                };

                movementsData.push([
                    movement.date,
                    typeText[movement.movementType] || movement.movementType,
                    product ? product.name : 'ููุชุฌ ูุญุฐูู',
                    movement.quantity,
                    movement.unitPrice || 0,
                    movement.totalAmount || 0,
                    movement.reference || '-',
                    movement.notes || '-'
                ]);
            });

            const movementsSheet = XLSX.utils.aoa_to_sheet(movementsData);
            XLSX.utils.book_append_sheet(workbook, movementsSheet, 'ุฌููุน ุงูุญุฑูุงุช');
        }

        // ุญูุธ ุงูููู
        const fileName = `ุชูุฑูุฑ_ุญุฑูุฉ_ุงููุฎุฒู_${warehouse.name}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log(`โ ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒู: ${fileName}`);
        alert(`ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุจูุฌุงุญ: ${fileName}`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุชูุฑูุฑ');
    }
}

/**
 * ุทุจุงุนุฉ ุชูุฑูุฑ ุญุฑูุฉ ูุฎุฒู ูุนูู
 */
function printWarehouseMovements(warehouseId) {
    console.log(`๐จ๏ธ ุทุจุงุนุฉ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒู ID: ${warehouseId}`);

    const warehouse = appData.warehouses.find(w => w.id === warehouseId);
    if (!warehouse) {
        alert('ุงููุฎุฒู ุบูุฑ ููุฌูุฏ');
        return;
    }

    // ุฅูุดุงุก ูุงูุฐุฉ ุทุจุงุนุฉ ุฌุฏูุฏุฉ
    const printWindow = window.open('', '_blank');
    const warehouseProducts = appData.products.filter(p => p.warehouseId === warehouseId);
    const warehouseMovements = (appData.inventoryMovements || []).filter(m => m.warehouseId === warehouseId);

    const printContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒู - ${warehouse.name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .info-table th, .info-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                .info-table th { background-color: #f5f5f5; }
                .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                .stat-box { text-align: center; padding: 15px; border: 1px solid #ddd; }
                .movements-table { width: 100%; border-collapse: collapse; font-size: 12px; }
                .movements-table th, .movements-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
                .movements-table th { background-color: #f5f5f5; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒู ุงูููุตู</h1>
                <h2>${warehouse.name}</h2>
                <p>ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SY')}</p>
            </div>

            <table class="info-table">
                <tr><th>ุงุณู ุงููุฎุฒู</th><td>${warehouse.name}</td></tr>
                <tr><th>ุงููููุน</th><td>${warehouse.location || '-'}</td></tr>
                <tr><th>ุงููุฏูุฑ</th><td>${warehouse.manager || '-'}</td></tr>
                <tr><th>ุงููุงุชู</th><td>${warehouse.phone || '-'}</td></tr>
                <tr><th>ุนุฏุฏ ุงูุฃุตูุงู</th><td>${warehouseProducts.length}</td></tr>
            </table>

            <div class="stats">
                <div class="stat-box">
                    <h3>ุฅุฌูุงูู ุงูุฅุฏุฎุงูุงุช</h3>
                    <p>${warehouseMovements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0)}</p>
                </div>
                <div class="stat-box">
                    <h3>ุฅุฌูุงูู ุงูุฅุฎุฑุงุฌุงุช</h3>
                    <p>${warehouseMovements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0)}</p>
                </div>
                <div class="stat-box">
                    <h3>ุนุฏุฏ ุงูุชุญูููุงุช</h3>
                    <p>${warehouseMovements.filter(m => m.movementType === 'transfer').length}</p>
                </div>
                <div class="stat-box">
                    <h3>ุนุฏุฏ ุงูุชุณููุงุช</h3>
                    <p>${warehouseMovements.filter(m => m.movementType === 'adjustment').length}</p>
                </div>
            </div>

            ${warehouseMovements.length > 0 ? `
                <h3>ุชูุงุตูู ุงูุญุฑูุงุช</h3>
                <table class="movements-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ููุน ุงูุญุฑูุฉ</th>
                            <th>ุงูุตูู</th>
                            <th>ุงููููุฉ</th>
                            <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                            <th>ุงููุฌููุน</th>
                            <th>ุงููุฑุฌุน</th>
                            <th>ููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${warehouseMovements.sort((a, b) => new Date(b.date) - new Date(a.date)).map(movement => {
                            const product = appData.products.find(p => p.id === movement.productId);
                            const typeText = {
                                'in': 'ุฅุฏุฎุงู',
                                'out': 'ุฅุฎุฑุงุฌ',
                                'transfer': 'ุชุญููู',
                                'adjustment': 'ุชุณููุฉ'
                            };
                            return `
                                <tr>
                                    <td>${movement.date}</td>
                                    <td>${typeText[movement.movementType] || movement.movementType}</td>
                                    <td>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</td>
                                    <td>${movement.quantity}</td>
                                    <td>${movement.unitPrice || 0}</td>
                                    <td>${movement.totalAmount || 0}</td>
                                    <td>${movement.reference || '-'}</td>
                                    <td>${movement.notes || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p>ูุง ุชูุฌุฏ ุญุฑูุงุช ูู ูุฐุง ุงููุฎุฒู</p>'}
        </body>
        </html>
    `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

/**
 * ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel
 */
function exportInventoryDetailsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
        const productFilter = document.getElementById('detailsProductFilter')?.value || '';
        const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
        const fromDate = document.getElementById('detailsFromDate')?.value || '';
        const toDate = document.getElementById('detailsToDate')?.value || '';

        // ููุชุฑุฉ ุญุฑูุงุช ุงููุฎุฒูู
        let movements = appData.inventoryMovements || [];

        if (typeFilter) {
            movements = movements.filter(movement => movement.movementType === typeFilter);
        }

        if (productFilter) {
            movements = movements.filter(movement => movement.productId == productFilter);
        }

        if (warehouseFilter) {
            movements = movements.filter(movement => movement.warehouseId == warehouseFilter);
        }

        if (fromDate) {
            movements = movements.filter(movement => movement.date >= fromDate);
        }

        if (toDate) {
            movements = movements.filter(movement => movement.date <= toDate);
        }

        if (movements.length === 0) {
            alert('ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
        movements.sort((a, b) => new Date(b.date) - new Date(a.date));

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุงูุชุงุฑูุฎ',
            'ููุน ุงูุญุฑูุฉ',
            'ุงูุตูู',
            'ููุฏ ุงูุตูู',
            'ุงููุฎุฒู',
            'ุงููููุฉ',
            'ุงููุญุฏุฉ',
            'ุณุนุฑ ุงููุญุฏุฉ',
            'ุงููุฌููุน',
            'ุงููุฑุฌุน/ุงูุณุจุจ',
            'ุงููุณุชุฎุฏู',
            'ููุงุญุธุงุช'
        ];

        const data = movements.map(movement => {
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

            const typeText = {
                'in': 'ุฅุฏุฎุงู',
                'out': 'ุฅุฎุฑุงุฌ',
                'transfer': 'ุชุญููู',
                'adjustment': 'ุชุณููุฉ',
                'sale': 'ูุจูุนุงุช',
                'purchase': 'ูุดุชุฑูุงุช',
                'return': 'ูุฑุชุฌุนุงุช'
            };

            const total = movement.quantity * (movement.unitPrice || 0);
            const user = movement.userId ? 'ูุณุชุฎุฏู ' + movement.userId : 'ุงููุธุงู';

            return [
                movement.date,
                typeText[movement.movementType] || movement.movementType,
                product ? product.name : 'ููุชุฌ ูุญุฐูู',
                product ? product.code : '-',
                warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู',
                movement.quantity,
                product ? product.unit : '-',
                movement.unitPrice || 0,
                total,
                movement.reference || '-',
                user,
                movement.notes || '-'
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalQuantityIn = movements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
        const totalQuantityOut = movements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
        const totalValue = movements.reduce((sum, m) => sum + (m.quantity * (m.unitPrice || 0)), 0);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            '',
            '',
            `ุฅุฏุฎุงู: ${totalQuantityIn} | ุฅุฎุฑุงุฌ: ${totalQuantityOut}`,
            '',
            '',
            totalValue,
            '',
            '',
            `ุนุฏุฏ ุงูุญุฑูุงุช: ${movements.length}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุชูุงุตูู ุงูุญุฑูุงุช');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createInventoryDetailsSummarySheet(movements, fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุงุตูู_ุญุฑูุฉ_ุงููุฎุฒูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log(`โ ุชู ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู: ${fileName}`);
        alert(`ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุจูุฌุงุญ: ${fileName}`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุชูุฑูุฑ: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ููุฎุต ุชูุงุตูู ุงููุฎุฒูู
 */
function createInventoryDetailsSummarySheet(movements, fromDate, toDate) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalMovements = movements.length;
    const totalIn = movements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
    const totalOut = movements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
    const totalTransfer = movements.filter(m => m.movementType === 'transfer').length;
    const totalAdjustment = movements.filter(m => m.movementType === 'adjustment').length;
    const totalValue = movements.reduce((sum, m) => sum + (m.quantity * (m.unitPrice || 0)), 0);

    // ุชุฌููุน ุญุณุจ ููุน ุงูุญุฑูุฉ
    const typeGroups = {};
    movements.forEach(movement => {
        const typeText = {
            'in': 'ุฅุฏุฎุงู',
            'out': 'ุฅุฎุฑุงุฌ',
            'transfer': 'ุชุญููู',
            'adjustment': 'ุชุณููุฉ',
            'sale': 'ูุจูุนุงุช',
            'purchase': 'ูุดุชุฑูุงุช',
            'return': 'ูุฑุชุฌุนุงุช'
        };

        const type = typeText[movement.movementType] || movement.movementType;
        if (!typeGroups[type]) {
            typeGroups[type] = { count: 0, quantity: 0, value: 0 };
        }
        typeGroups[type].count++;
        typeGroups[type].quantity += movement.quantity;
        typeGroups[type].value += movement.quantity * (movement.unitPrice || 0);
    });

    const data = [
        ['ููุฎุต ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู'],
        [''],
        ['ูุนูููุงุช ุนุงูุฉ'],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ', `ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}`],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุญุฑูุงุช', totalMovements],
        ['ุฅุฌูุงูู ุงููููุฉ ุงูุฏุงุฎูุฉ', totalIn],
        ['ุฅุฌูุงูู ุงููููุฉ ุงูุฎุงุฑุฌุฉ', totalOut],
        ['ุตุงูู ุงูุญุฑูุฉ', totalIn - totalOut],
        ['ุนุฏุฏ ุงูุชุญูููุงุช', totalTransfer],
        ['ุนุฏุฏ ุงูุชุณููุงุช', totalAdjustment],
        ['ุฅุฌูุงูู ุงููููุฉ', totalValue],
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ููุน ุงูุญุฑูุฉ'],
        ['ููุน ุงูุญุฑูุฉ', 'ุนุฏุฏ ุงูุญุฑูุงุช', 'ุงููููุฉ', 'ุงููููุฉ']
    ];

    // ุฅุถุงูุฉ ุจูุงูุงุช ุฃููุงุน ุงูุญุฑูุงุช
    Object.keys(typeGroups).forEach(type => {
        const group = typeGroups[type];
        data.push([
            type,
            group.count,
            group.quantity,
            group.value
        ]);
    });

    data.push(['']);
    data.push(['ุชุงุฑูุฎ ุงูุชูุฑูุฑ', new Date().toLocaleDateString('ar-SY')]);
    data.push(['ููุช ุงูุชูุฑูุฑ', new Date().toLocaleTimeString('ar-SY')]);

    return XLSX.utils.aoa_to_sheet(data);
}

/**
 * ุทุจุงุนุฉ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function printInventoryDetails() {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู');

    // ุฅูุดุงุก ูุงูุฐุฉ ุทุจุงุนุฉ ุฌุฏูุฏุฉ
    const printWindow = window.open('', '_blank');

    // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงููููุชุฑุฉ
    const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
    const productFilter = document.getElementById('detailsProductFilter')?.value || '';
    const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
    const fromDate = document.getElementById('detailsFromDate')?.value || '';
    const toDate = document.getElementById('detailsToDate')?.value || '';

    let movements = appData.inventoryMovements || [];

    // ุชุทุจูู ุงูููุงุชุฑ
    if (typeFilter) movements = movements.filter(m => m.movementType === typeFilter);
    if (productFilter) movements = movements.filter(m => m.productId == productFilter);
    if (warehouseFilter) movements = movements.filter(m => m.warehouseId == warehouseFilter);
    if (fromDate) movements = movements.filter(m => m.date >= fromDate);
    if (toDate) movements = movements.filter(m => m.date <= toDate);

    movements.sort((a, b) => new Date(b.date) - new Date(a.date));

    const printContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .info-table th, .info-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                .info-table th { background-color: #f5f5f5; }
                .movements-table { width: 100%; border-collapse: collapse; font-size: 11px; }
                .movements-table th, .movements-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
                .movements-table th { background-color: #f5f5f5; }
                .badge { padding: 2px 6px; border-radius: 3px; color: white; font-size: 10px; }
                .bg-success { background-color: #28a745; }
                .bg-danger { background-color: #dc3545; }
                .bg-info { background-color: #17a2b8; }
                .bg-warning { background-color: #ffc107; color: black; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู</h1>
                <p>ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SY')}</p>
                ${fromDate || toDate ? `<p>ุงููุชุฑุฉ: ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}</p>` : ''}
            </div>

            ${movements.length > 0 ? `
                <table class="movements-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ููุน ุงูุญุฑูุฉ</th>
                            <th>ุงูุตูู</th>
                            <th>ุงููุฎุฒู</th>
                            <th>ุงููููุฉ</th>
                            <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                            <th>ุงููุฌููุน</th>
                            <th>ุงููุฑุฌุน</th>
                            <th>ููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${movements.map(movement => {
                            const product = appData.products.find(p => p.id === movement.productId);
                            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
                            const typeText = {
                                'in': 'ุฅุฏุฎุงู',
                                'out': 'ุฅุฎุฑุงุฌ',
                                'transfer': 'ุชุญููู',
                                'adjustment': 'ุชุณููุฉ'
                            };
                            return `
                                <tr>
                                    <td>${movement.date}</td>
                                    <td><span class="badge bg-${movement.movementType === 'in' ? 'success' : movement.movementType === 'out' ? 'danger' : movement.movementType === 'transfer' ? 'info' : 'warning'}">${typeText[movement.movementType] || movement.movementType}</span></td>
                                    <td>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</td>
                                    <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                                    <td>${movement.quantity}</td>
                                    <td>${movement.unitPrice || 0}</td>
                                    <td>${movement.totalAmount || 0}</td>
                                    <td>${movement.reference || '-'}</td>
                                    <td>${movement.notes || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p>ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>'}
        </body>
        </html>
    `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

/**
 * ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel
 */
function exportInventoryDetailsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
        const productFilter = document.getElementById('detailsProductFilter')?.value || '';
        const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
        const fromDate = document.getElementById('detailsFromDate')?.value || '';
        const toDate = document.getElementById('detailsToDate')?.value || '';

        // ููุชุฑุฉ ุญุฑูุงุช ุงููุฎุฒูู
        let movements = appData.inventoryMovements || [];

        if (typeFilter) {
            movements = movements.filter(movement => movement.movementType === typeFilter);
        }

        if (productFilter) {
            movements = movements.filter(movement => movement.productId == productFilter);
        }

        if (warehouseFilter) {
            movements = movements.filter(movement => movement.warehouseId == warehouseFilter);
        }

        if (fromDate) {
            movements = movements.filter(movement => movement.date >= fromDate);
        }

        if (toDate) {
            movements = movements.filter(movement => movement.date <= toDate);
        }

        if (movements.length === 0) {
            alert('ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
        movements.sort((a, b) => new Date(b.date) - new Date(a.date));

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุงูุชุงุฑูุฎ',
            'ููุน ุงูุญุฑูุฉ',
            'ุงูุตูู',
            'ููุฏ ุงูุตูู',
            'ุงููุฎุฒู',
            'ุงููููุฉ',
            'ุงููุญุฏุฉ',
            'ุณุนุฑ ุงููุญุฏุฉ',
            'ุงููุฌููุน',
            'ุงููุฑุฌุน/ุงูุณุจุจ',
            'ุงููุณุชุฎุฏู',
            'ููุงุญุธุงุช'
        ];

        const data = movements.map(movement => {
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);

            const typeText = {
                'in': 'ุฅุฏุฎุงู',
                'out': 'ุฅุฎุฑุงุฌ',
                'transfer': 'ุชุญููู',
                'adjustment': 'ุชุณููุฉ',
                'sale': 'ูุจูุนุงุช',
                'purchase': 'ูุดุชุฑูุงุช',
                'return': 'ูุฑุชุฌุนุงุช'
            };

            const total = movement.quantity * (movement.unitPrice || 0);
            const user = movement.userId ? 'ูุณุชุฎุฏู ' + movement.userId : 'ุงููุธุงู';

            return [
                movement.date,
                typeText[movement.movementType] || movement.movementType,
                product ? product.name : 'ููุชุฌ ูุญุฐูู',
                product ? product.code : '-',
                warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู',
                movement.quantity,
                product ? product.unit : '-',
                movement.unitPrice || 0,
                total,
                movement.reference || '-',
                user,
                movement.notes || '-'
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalQuantityIn = movements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
        const totalQuantityOut = movements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
        const totalValue = movements.reduce((sum, m) => sum + (m.quantity * (m.unitPrice || 0)), 0);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            '',
            '',
            `ุฅุฏุฎุงู: ${totalQuantityIn} | ุฅุฎุฑุงุฌ: ${totalQuantityOut}`,
            '',
            '',
            totalValue,
            '',
            '',
            `ุนุฏุฏ ุงูุญุฑูุงุช: ${movements.length}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุชูุงุตูู ุงูุญุฑูุงุช');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุงุตูู_ุญุฑูุฉ_ุงููุฎุฒูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log(`โ ุชู ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู: ${fileName}`);
        alert(`ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุจูุฌุงุญ: ${fileName}`);

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงูุชูุฑูุฑ: ' + error.message);
    }
}

/**
 * ุนุฑุถ ุชูุงุตูู ุญุฑูุฉ ูุฎุฒูู ูุญุฏุฏุฉ
 */
function viewMovementDetails(movementId) {
    console.log(`๐ ุนุฑุถ ุชูุงุตูู ุงูุญุฑูุฉ ID: ${movementId}`);

    const movement = appData.inventoryMovements.find(m => m.id === movementId);
    if (!movement) {
        alert('ุงูุญุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
        return;
    }

    const product = appData.products.find(p => p.id === movement.productId);
    const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
    const toWarehouse = movement.toWarehouseId ?
        appData.warehouses.find(w => w.id === movement.toWarehouseId) : null;

    const typeInfo = getMovementTypeInfo(movement.movementType);
    const totalAmount = (movement.quantity || 0) * (movement.unitPrice || 0);

    // ุฅูุดุงุก ูุงูุฐุฉ ููุจุซูุฉ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'movementDetailsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="${typeInfo.icon} me-2"></i>
                        ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">ูุนูููุงุช ุงูุญุฑูุฉ</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>ุฑูู ุงูุญุฑูุฉ:</strong></td>
                                            <td>${movement.id}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ููุน ุงูุญุฑูุฉ:</strong></td>
                                            <td>
                                                <span class="badge bg-${typeInfo.color}">
                                                    <i class="${typeInfo.icon} me-1"></i>
                                                    ${typeInfo.text}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูุชุงุฑูุฎ:</strong></td>
                                            <td>${movement.date}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงูููุช:</strong></td>
                                            <td>${movement.createdAt ? new Date(movement.createdAt).toLocaleString('ar-SY') : '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงููุณุชุฎุฏู:</strong></td>
                                            <td>${movement.userId || 'ุงููุธุงู'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">ูุนูููุงุช ุงูููุชุฌ ูุงููุฎุฒู</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>ุงูููุชุฌ:</strong></td>
                                            <td>
                                                ${product ? product.name : 'ููุชุฌ ูุญุฐูู'}
                                                ${product ? `<br><small class="text-muted">ููุฏ: ${product.code}</small>` : ''}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุงููุฎุฒู:</strong></td>
                                            <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                                        </tr>
                                        ${toWarehouse ? `
                                        <tr>
                                            <td><strong>ุฅูู ุงููุฎุฒู:</strong></td>
                                            <td>${toWarehouse.name}</td>
                                        </tr>
                                        ` : ''}
                                        <tr>
                                            <td><strong>ุงููููุฉ:</strong></td>
                                            <td>
                                                <span class="badge bg-${movement.quantity >= 0 ? 'success' : 'danger'} fs-6">
                                                    ${Math.abs(movement.quantity)} ${product ? product.unit : 'ูุญุฏุฉ'}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุณุนุฑ ุงููุญุฏุฉ:</strong></td>
                                            <td>${formatCurrency(movement.unitPrice || 0)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ุฅุฌูุงูู ุงููููุฉ:</strong></td>
                                            <td><strong>${formatCurrency(totalAmount)}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${movement.reference || movement.referenceNumber || movement.notes ? `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ูุนูููุงุช ุฅุถุงููุฉ</h6>
                        </div>
                        <div class="card-body">
                            ${movement.reference ? `
                            <div class="mb-2">
                                <strong>ุงููุฑุฌุน:</strong> ${movement.reference}
                            </div>
                            ` : ''}
                            ${movement.referenceNumber ? `
                            <div class="mb-2">
                                <strong>ุฑูู ุงููุฑุฌุน:</strong> <span class="text-primary">#${movement.referenceNumber}</span>
                            </div>
                            ` : ''}
                            ${movement.notes ? `
                            <div class="mb-2">
                                <strong>ุงูููุงุญุธุงุช:</strong> ${movement.notes}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="editMovement(${movement.id})">
                        <i class="fas fa-edit me-2"></i>
                        ุชุนุฏูู
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteMovement(${movement.id})">
                        <i class="fas fa-trash me-2"></i>
                        ุญุฐู
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // ุฅุฒุงูุฉ ุงููุงูุฐุฉ ุนูุฏ ุงูุฅุบูุงู
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

/**
 * ุทุจุงุนุฉ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู
 */
function printInventoryDetails() {
    console.log('๐จ๏ธ ุทุจุงุนุฉ ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู');

    // ุฅูุดุงุก ูุงูุฐุฉ ุทุจุงุนุฉ ุฌุฏูุฏุฉ
    const printWindow = window.open('', '_blank');

    // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงููููุชุฑุฉ
    const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
    const productFilter = document.getElementById('detailsProductFilter')?.value || '';
    const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
    const fromDate = document.getElementById('detailsFromDate')?.value || '';
    const toDate = document.getElementById('detailsToDate')?.value || '';

    let movements = appData.inventoryMovements || [];

    // ุชุทุจูู ุงูููุงุชุฑ
    if (typeFilter) movements = movements.filter(m => m.movementType === typeFilter);
    if (productFilter) movements = movements.filter(m => m.productId == productFilter);
    if (warehouseFilter) movements = movements.filter(m => m.warehouseId == warehouseFilter);
    if (fromDate) movements = movements.filter(m => m.date >= fromDate);
    if (toDate) movements = movements.filter(m => m.date <= toDate);

    movements.sort((a, b) => new Date(b.date) - new Date(a.date));

    const printContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .movements-table { width: 100%; border-collapse: collapse; font-size: 11px; }
                .movements-table th, .movements-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
                .movements-table th { background-color: #f5f5f5; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ุชูุงุตูู ุญุฑูุฉ ุงููุฎุฒูู</h1>
                <p>ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SY')}</p>
                ${fromDate || toDate ? `<p>ุงููุชุฑุฉ: ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}</p>` : ''}
            </div>

            ${movements.length > 0 ? `
                <table class="movements-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ููุน ุงูุญุฑูุฉ</th>
                            <th>ุงูุตูู</th>
                            <th>ุงููุฎุฒู</th>
                            <th>ุงููููุฉ</th>
                            <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                            <th>ุงููุฌููุน</th>
                            <th>ุงููุฑุฌุน</th>
                            <th>ููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${movements.map(movement => {
                            const product = appData.products.find(p => p.id === movement.productId);
                            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
                            const typeText = {
                                'in': 'ุฅุฏุฎุงู',
                                'out': 'ุฅุฎุฑุงุฌ',
                                'transfer': 'ุชุญููู',
                                'adjustment': 'ุชุณููุฉ'
                            };
                            return `
                                <tr>
                                    <td>${movement.date}</td>
                                    <td>${typeText[movement.movementType] || movement.movementType}</td>
                                    <td>${product ? product.name : 'ููุชุฌ ูุญุฐูู'}</td>
                                    <td>${warehouse ? warehouse.name : 'ูุฎุฒู ูุญุฐูู'}</td>
                                    <td>${movement.quantity}</td>
                                    <td>${movement.unitPrice || 0}</td>
                                    <td>${movement.totalAmount || 0}</td>
                                    <td>${movement.reference || '-'}</td>
                                    <td>${movement.notes || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p>ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</p>'}
        </body>
        </html>
    `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

/**
 * ุชุตุฏูุฑ ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel
 */
function exportInventoryToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const typeFilter = document.getElementById('movementTypeFilter')?.value || '';
        const productFilter = document.getElementById('productFilter')?.value || '';
        const warehouseFilter = document.getElementById('warehouseFilter')?.value || '';
        const fromDate = document.getElementById('fromDate')?.value || '';
        const toDate = document.getElementById('toDate')?.value || '';

        // ููุชุฑุฉ ุญุฑูุงุช ุงููุฎุฒูู
        let movements = appData.inventoryMovements || [];

        if (typeFilter) {
            movements = movements.filter(movement => movement.movementType === typeFilter);
        }

        if (productFilter) {
            movements = movements.filter(movement => movement.productId == productFilter);
        }

        if (warehouseFilter) {
            movements = movements.filter(movement => movement.warehouseId == warehouseFilter);
        }

        if (fromDate) {
            movements = movements.filter(movement => movement.date >= fromDate);
        }

        if (toDate) {
            movements = movements.filter(movement => movement.date <= toDate);
        }

        if (movements.length === 0) {
            alert('ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุชุฑุชูุจ ุงูุญุฑูุงุช ุญุณุจ ุงูุชุงุฑูุฎ
        movements.sort((a, b) => new Date(b.date) - new Date(a.date));

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุงูุชุงุฑูุฎ',
            'ููุน ุงูุญุฑูุฉ',
            'ุงูุตูู',
            'ุงููุฎุฒู',
            'ุงููููุฉ',
            'ุงููุญุฏุฉ',
            'ุณุนุฑ ุงููุญุฏุฉ',
            'ุงููุฌููุน',
            'ุงููุฑุฌุน',
            'ููุงุญุธุงุช'
        ];

        const data = movements.map(movement => {
            const product = appData.products.find(p => p.id === movement.productId);
            const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
            const movementTypeText = getMovementTypeText(movement.movementType);
            const total = movement.quantity * (movement.unitPrice || 0);

            return [
                movement.date,
                movementTypeText,
                product ? product.name : 'ุบูุฑ ูุญุฏุฏ',
                warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ',
                movement.quantity,
                product ? product.unit : '',
                movement.unitPrice || 0,
                total,
                movement.reference || '',
                movement.notes || ''
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalQuantityIn = movements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
        const totalQuantityOut = movements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
        const totalValue = movements.reduce((sum, m) => sum + (m.quantity * (m.unitPrice || 0)), 0);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            '',
            `ุฅุฏุฎุงู: ${totalQuantityIn} | ุฅุฎุฑุงุฌ: ${totalQuantityOut}`,
            '',
            '',
            totalValue,
            '',
            `ุนุฏุฏ ุงูุญุฑูุงุช: ${movements.length}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุญุฑูุฉ ุงููุฎุฒูู');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createInventorySummarySheet(movements, fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุฅุถุงูุฉ ูุฑูุฉ ุฃุฑุตุฏุฉ ุงููุฎุฒูู
        const stockSheet = createStockBalanceSheet();
        XLSX.utils.book_append_sheet(workbook, stockSheet, 'ุฃุฑุตุฏุฉ ุงููุฎุฒูู');

        // ุญูุธ ุงูููู
        const fileName = `ุชูุฑูุฑ_ุญุฑูุฉ_ุงููุฎุฒูู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุงูุญุตูู ุนูู ูุต ููุน ุงูุญุฑูุฉ
 */
function getMovementTypeText(type) {
    const types = {
        'in': 'ุฅุฏุฎุงู',
        'out': 'ุฅุฎุฑุงุฌ',
        'transfer': 'ุชุญููู',
        'adjustment': 'ุชุณููุฉ',
        'sale': 'ูุจูุนุงุช',
        'purchase': 'ูุดุชุฑูุงุช',
        'return_sale': 'ูุฑุชุฌุน ูุจูุนุงุช',
        'return_purchase': 'ูุฑุชุฌุน ูุดุชุฑูุงุช',
        'transfer_in': 'ุชุญููู ุฏุงุฎู',
        'transfer_out': 'ุชุญููู ุฎุงุฑุฌ',
        'damage': 'ุชุงูู'
    };
    return types[type] || type;
}

/**
 * ุงูุญุตูู ุนูู ูุนูููุงุช ููุน ุงูุญุฑูุฉ (ูุตุ ูููุ ุฃููููุฉ)
 */
function getMovementTypeInfo(type) {
    const typeInfo = {
        'in': { text: 'ุฅุฏุฎุงู', color: 'success', icon: 'fas fa-arrow-up' },
        'out': { text: 'ุฅุฎุฑุงุฌ', color: 'danger', icon: 'fas fa-arrow-down' },
        'transfer': { text: 'ุชุญููู', color: 'info', icon: 'fas fa-exchange-alt' },
        'adjustment': { text: 'ุชุณููุฉ', color: 'warning', icon: 'fas fa-balance-scale' },
        'sale': { text: 'ูุจูุนุงุช', color: 'primary', icon: 'fas fa-shopping-cart' },
        'purchase': { text: 'ูุดุชุฑูุงุช', color: 'secondary', icon: 'fas fa-shopping-bag' },
        'return_sale': { text: 'ูุฑุชุฌุน ูุจูุนุงุช', color: 'info', icon: 'fas fa-undo' },
        'return_purchase': { text: 'ูุฑุชุฌุน ูุดุชุฑูุงุช', color: 'dark', icon: 'fas fa-undo-alt' },
        'transfer_in': { text: 'ุชุญููู ุฏุงุฎู', color: 'success', icon: 'fas fa-arrow-circle-up' },
        'transfer_out': { text: 'ุชุญููู ุฎุงุฑุฌ', color: 'danger', icon: 'fas fa-arrow-circle-down' },
        'damage': { text: 'ุชุงูู', color: 'danger', icon: 'fas fa-exclamation-triangle' }
    };

    return typeInfo[type] || { text: type, color: 'secondary', icon: 'fas fa-question' };
}

/**
 * ุงูุญุตูู ุนูู ุญุฑูุงุช ุงููุฎุฒูู ุงููููุชุฑุฉ
 */
function getFilteredInventoryMovements() {
    try {
        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const typeFilter = document.getElementById('detailsMovementTypeFilter')?.value || '';
        const productFilter = document.getElementById('detailsProductFilter')?.value || '';
        const warehouseFilter = document.getElementById('detailsWarehouseFilter')?.value || '';
        const fromDate = document.getElementById('detailsFromDate')?.value || '';
        const toDate = document.getElementById('detailsToDate')?.value || '';

        // ููุชุฑุฉ ุญุฑูุงุช ุงููุฎุฒูู
        let movements = appData.inventoryMovements || [];

        if (typeFilter) {
            movements = movements.filter(movement => movement.movementType === typeFilter);
        }

        if (productFilter) {
            movements = movements.filter(movement => movement.productId == productFilter);
        }

        if (warehouseFilter) {
            movements = movements.filter(movement => movement.warehouseId == warehouseFilter);
        }

        if (fromDate) {
            movements = movements.filter(movement => movement.date >= fromDate);
        }

        if (toDate) {
            movements = movements.filter(movement => movement.date <= toDate);
        }

        return movements;

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ููุชุฑุฉ ุญุฑูุงุช ุงููุฎุฒูู:', error);
        return [];
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ููุฎุต ุงููุฎุฒูู
 */
function createInventorySummarySheet(movements, fromDate, toDate) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalMovements = movements.length;
    const totalIn = movements.filter(m => m.movementType === 'in').reduce((sum, m) => sum + m.quantity, 0);
    const totalOut = movements.filter(m => m.movementType === 'out').reduce((sum, m) => sum + m.quantity, 0);
    const totalValue = movements.reduce((sum, m) => sum + (m.quantity * (m.unitPrice || 0)), 0);

    // ุชุฌููุน ุญุณุจ ููุน ุงูุญุฑูุฉ
    const typeGroups = {};
    movements.forEach(movement => {
        const type = getMovementTypeText(movement.movementType);
        if (!typeGroups[type]) {
            typeGroups[type] = { count: 0, quantity: 0, value: 0 };
        }
        typeGroups[type].count++;
        typeGroups[type].quantity += movement.quantity;
        typeGroups[type].value += movement.quantity * (movement.unitPrice || 0);
    });

    // ุชุฌููุน ุญุณุจ ุงููุฎุฒู
    const warehouseGroups = {};
    movements.forEach(movement => {
        const warehouse = appData.warehouses.find(w => w.id === movement.warehouseId);
        const warehouseName = warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ';
        if (!warehouseGroups[warehouseName]) {
            warehouseGroups[warehouseName] = { count: 0, quantity: 0, value: 0 };
        }
        warehouseGroups[warehouseName].count++;
        warehouseGroups[warehouseName].quantity += movement.quantity;
        warehouseGroups[warehouseName].value += movement.quantity * (movement.unitPrice || 0);
    });

    const data = [
        ['ููุฎุต ุชูุฑูุฑ ุญุฑูุฉ ุงููุฎุฒูู'],
        [''],
        ['ูุนูููุงุช ุนุงูุฉ'],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ', `ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}`],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุญุฑูุงุช', totalMovements],
        ['ุฅุฌูุงูู ุงููููุฉ ุงูุฏุงุฎูุฉ', totalIn],
        ['ุฅุฌูุงูู ุงููููุฉ ุงูุฎุงุฑุฌุฉ', totalOut],
        ['ุตุงูู ุงูุญุฑูุฉ', totalIn - totalOut],
        ['ุฅุฌูุงูู ุงููููุฉ', totalValue],
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ููุน ุงูุญุฑูุฉ'],
        ['ููุน ุงูุญุฑูุฉ', 'ุนุฏุฏ ุงูุญุฑูุงุช', 'ุงููููุฉ', 'ุงููููุฉ']
    ];

    // ุฅุถุงูุฉ ุจูุงูุงุช ุฃููุงุน ุงูุญุฑูุงุช
    Object.keys(typeGroups).forEach(type => {
        const group = typeGroups[type];
        data.push([
            type,
            group.count,
            group.quantity,
            group.value
        ]);
    });

    data.push(['']);
    data.push(['ุงูุชูุฒูุน ุญุณุจ ุงููุฎุฒู']);
    data.push(['ุงููุฎุฒู', 'ุนุฏุฏ ุงูุญุฑูุงุช', 'ุงููููุฉ', 'ุงููููุฉ']);

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงููุฎุงุฒู
    Object.keys(warehouseGroups).forEach(warehouse => {
        const group = warehouseGroups[warehouse];
        data.push([
            warehouse,
            group.count,
            group.quantity,
            group.value
        ]);
    });

    data.push(['']);
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 15 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุฃุฑุตุฏุฉ ุงููุฎุฒูู
 */
function createStockBalanceSheet() {
    const headers = [
        'ููุฏ ุงูุตูู',
        'ุงุณู ุงูุตูู',
        'ุงููุฎุฒู',
        'ุงููููุฉ ุงูุญุงููุฉ',
        'ุงููุญุฏุฉ',
        'ุงูุญุฏ ุงูุฃุฏูู',
        'ุณุนุฑ ุงูุชูููุฉ',
        'ุณุนุฑ ุงูุจูุน',
        'ูููุฉ ุงููุฎุฒูู',
        'ุญุงูุฉ ุงููุฎุฒูู'
    ];

    const data = appData.products.map(product => {
        const warehouse = appData.warehouses.find(w => w.id === product.warehouseId);
        const stockValue = product.quantity * product.costPrice;
        const isLowStock = product.quantity <= product.minQuantity;
        const stockStatus = product.quantity === 0 ? 'ููุฏ ุงููุฎุฒูู' :
                           isLowStock ? 'ูุฎุฒูู ููุฎูุถ' : 'ูุฎุฒูู ุขูู';

        return [
            product.code,
            product.name,
            warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ',
            product.quantity,
            product.unit,
            product.minQuantity,
            product.costPrice,
            product.sellingPrice,
            stockValue,
            stockStatus
        ];
    });

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    const totalQuantity = appData.products.reduce((sum, p) => sum + p.quantity, 0);
    const totalValue = appData.products.reduce((sum, p) => sum + (p.quantity * p.costPrice), 0);
    const lowStockCount = appData.products.filter(p => p.quantity <= p.minQuantity).length;
    const outOfStockCount = appData.products.filter(p => p.quantity === 0).length;

    // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
    data.push([
        '',
        'ุงูุฅุฌูุงููุงุช',
        '',
        totalQuantity,
        '',
        '',
        '',
        '',
        totalValue,
        `ููุฎูุถ: ${lowStockCount} | ููุฏ: ${outOfStockCount}`
    ]);

    const worksheet = createFormattedWorksheet(headers, data, 'ุฃุฑุตุฏุฉ ุงููุฎุฒูู');
    return worksheet;
}

/**
 * ุชุตุฏูุฑ ููุงุชูุฑ ุงููุจูุนุงุช ุฅูู Excel
 */
function exportSalesInvoicesToExcel() {
    console.log('๐ ุชุตุฏูุฑ ููุงุชูุฑ ุงููุจูุนุงุช ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const customerFilter = document.getElementById('customerFilter')?.value || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const fromDate = document.getElementById('salesFromDate')?.value || '';
        const toDate = document.getElementById('salesToDate')?.value || '';

        // ููุชุฑุฉ ููุงุชูุฑ ุงููุจูุนุงุช
        let invoices = appData.invoices.filter(inv => inv.invoiceType === 'sale');

        if (customerFilter) {
            invoices = invoices.filter(inv => inv.customerId == customerFilter);
        }

        if (statusFilter) {
            invoices = invoices.filter(inv => inv.status === statusFilter);
        }

        if (fromDate) {
            invoices = invoices.filter(inv => inv.invoiceDate >= fromDate);
        }

        if (toDate) {
            invoices = invoices.filter(inv => inv.invoiceDate <= toDate);
        }

        if (invoices.length === 0) {
            alert('ูุง ุชูุฌุฏ ููุงุชูุฑ ูุจูุนุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุชุฑุชูุจ ุงูููุงุชูุฑ ุญุณุจ ุงูุชุงุฑูุฎ
        invoices.sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุฑูู ุงููุงุชูุฑุฉ',
            'ุงูุชุงุฑูุฎ',
            'ุงูุนููู',
            'ุงููุจูุบ ุงููุฑุนู',
            'ุงูุฎุตู %',
            'ูุจูุบ ุงูุฎุตู',
            'ุงูุถุฑูุจุฉ %',
            'ูุจูุบ ุงูุถุฑูุจุฉ',
            'ุงููุจูุบ ุงูุฅุฌูุงูู',
            'ุงููุฏููุน',
            'ุงููุชุจูู',
            'ุงูุญุงูุฉ',
            'ููุงุญุธุงุช'
        ];

        const data = invoices.map(invoice => {
            const customer = appData.customers.find(c => c.id === invoice.customerId);
            const statusText = getInvoiceStatusText(invoice.status);

            return [
                invoice.invoiceNumber,
                invoice.invoiceDate,
                customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ',
                invoice.subtotal || 0,
                invoice.discountRate || 0,
                invoice.discountAmount || 0,
                invoice.taxRate || 0,
                invoice.taxAmount || 0,
                invoice.totalAmount || 0,
                invoice.paidAmount || 0,
                invoice.remainingAmount || 0,
                statusText,
                invoice.notes || ''
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalSubtotal = invoices.reduce((sum, inv) => sum + (inv.subtotal || 0), 0);
        const totalDiscount = invoices.reduce((sum, inv) => sum + (inv.discountAmount || 0), 0);
        const totalTax = invoices.reduce((sum, inv) => sum + (inv.taxAmount || 0), 0);
        const totalAmount = invoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const totalPaid = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
        const totalRemaining = invoices.reduce((sum, inv) => sum + (inv.remainingAmount || 0), 0);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            totalSubtotal,
            '',
            totalDiscount,
            '',
            totalTax,
            totalAmount,
            totalPaid,
            totalRemaining,
            '',
            `ุนุฏุฏ ุงูููุงุชูุฑ: ${invoices.length}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ููุงุชูุฑ ุงููุจูุนุงุช');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ููุงุชูุฑ ุงููุจูุนุงุช');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createInvoicesSummarySheet(invoices, 'ุงููุจูุนุงุช', fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุฅุถุงูุฉ ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
        const itemsSheet = createInvoiceItemsSheet(invoices, 'ุงููุจูุนุงุช');
        XLSX.utils.book_append_sheet(workbook, itemsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');

        // ุญูุธ ุงูููู
        const fileName = `ููุงุชูุฑ_ุงููุจูุนุงุช_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุจูุนุงุช ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุจูุนุงุช ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุจูุนุงุช ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุฅูู Excel
 */
function exportPurchaseInvoicesToExcel() {
    console.log('๐ ุชุตุฏูุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const supplierFilter = document.getElementById('supplierFilter')?.value || '';
        const statusFilter = document.getElementById('purchaseStatusFilter')?.value || '';
        const fromDate = document.getElementById('purchaseFromDate')?.value || '';
        const toDate = document.getElementById('purchaseToDate')?.value || '';

        // ููุชุฑุฉ ููุงุชูุฑ ุงููุดุชุฑูุงุช
        let invoices = appData.invoices.filter(inv => inv.invoiceType === 'purchase');

        if (supplierFilter) {
            invoices = invoices.filter(inv => inv.supplierId == supplierFilter);
        }

        if (statusFilter) {
            invoices = invoices.filter(inv => inv.status === statusFilter);
        }

        if (fromDate) {
            invoices = invoices.filter(inv => inv.invoiceDate >= fromDate);
        }

        if (toDate) {
            invoices = invoices.filter(inv => inv.invoiceDate <= toDate);
        }

        if (invoices.length === 0) {
            alert('ูุง ุชูุฌุฏ ููุงุชูุฑ ูุดุชุฑูุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ');
            return;
        }

        // ุชุฑุชูุจ ุงูููุงุชูุฑ ุญุณุจ ุงูุชุงุฑูุฎ
        invoices.sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ุฑูู ุงููุงุชูุฑุฉ',
            'ุงูุชุงุฑูุฎ',
            'ุงูููุฑุฏ',
            'ุงููุจูุบ ุงููุฑุนู',
            'ุงูุฎุตู %',
            'ูุจูุบ ุงูุฎุตู',
            'ุงูุถุฑูุจุฉ %',
            'ูุจูุบ ุงูุถุฑูุจุฉ',
            'ุงููุจูุบ ุงูุฅุฌูุงูู',
            'ุงููุฏููุน',
            'ุงููุชุจูู',
            'ุงูุญุงูุฉ',
            'ููุงุญุธุงุช'
        ];

        const data = invoices.map(invoice => {
            const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
            const statusText = getInvoiceStatusText(invoice.status);

            return [
                invoice.invoiceNumber,
                invoice.invoiceDate,
                supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ',
                invoice.subtotal || 0,
                invoice.discountRate || 0,
                invoice.discountAmount || 0,
                invoice.taxRate || 0,
                invoice.taxAmount || 0,
                invoice.totalAmount || 0,
                invoice.paidAmount || 0,
                invoice.remainingAmount || 0,
                statusText,
                invoice.notes || ''
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalSubtotal = invoices.reduce((sum, inv) => sum + (inv.subtotal || 0), 0);
        const totalDiscount = invoices.reduce((sum, inv) => sum + (inv.discountAmount || 0), 0);
        const totalTax = invoices.reduce((sum, inv) => sum + (inv.taxAmount || 0), 0);
        const totalAmount = invoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const totalPaid = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
        const totalRemaining = invoices.reduce((sum, inv) => sum + (inv.remainingAmount || 0), 0);

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            totalSubtotal,
            '',
            totalDiscount,
            '',
            totalTax,
            totalAmount,
            totalPaid,
            totalRemaining,
            '',
            `ุนุฏุฏ ุงูููุงุชูุฑ: ${invoices.length}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ููุงุชูุฑ ุงููุดุชุฑูุงุช');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ููุงุชูุฑ ุงููุดุชุฑูุงุช');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createInvoicesSummarySheet(invoices, 'ุงููุดุชุฑูุงุช', fromDate, toDate);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุชูุฑูุฑ');

        // ุฅุถุงูุฉ ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
        const itemsSheet = createInvoiceItemsSheet(invoices, 'ุงููุดุชุฑูุงุช');
        XLSX.utils.book_append_sheet(workbook, itemsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');

        // ุญูุธ ุงูููู
        const fileName = `ููุงุชูุฑ_ุงููุดุชุฑูุงุช_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ููุงุชูุฑ ุงููุดุชุฑูุงุช ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุงูุญุตูู ุนูู ูุต ุญุงูุฉ ุงููุงุชูุฑุฉ
 */
function getInvoiceStatusText(status) {
    const statuses = {
        'draft': 'ูุณูุฏุฉ',
        'confirmed': 'ูุคูุฏุฉ',
        'cancelled': 'ููุบูุฉ',
        'paid': 'ูุฏููุนุฉ'
    };
    return statuses[status] || status;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ููุฎุต ุงูููุงุชูุฑ
 */
function createInvoicesSummarySheet(invoices, type, fromDate, toDate) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalInvoices = invoices.length;
    const totalAmount = invoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
    const totalPaid = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
    const totalRemaining = invoices.reduce((sum, inv) => sum + (inv.remainingAmount || 0), 0);
    const totalDiscount = invoices.reduce((sum, inv) => sum + (inv.discountAmount || 0), 0);
    const totalTax = invoices.reduce((sum, inv) => sum + (inv.taxAmount || 0), 0);

    // ุชุฌููุน ุญุณุจ ุงูุญุงูุฉ
    const statusGroups = {};
    invoices.forEach(invoice => {
        const status = getInvoiceStatusText(invoice.status);
        if (!statusGroups[status]) {
            statusGroups[status] = { count: 0, amount: 0 };
        }
        statusGroups[status].count++;
        statusGroups[status].amount += invoice.totalAmount || 0;
    });

    // ุชุฌููุน ุญุณุจ ุงูุนููู/ุงูููุฑุฏ
    const clientGroups = {};
    invoices.forEach(invoice => {
        let clientName = 'ุบูุฑ ูุญุฏุฏ';
        if (type === 'ุงููุจูุนุงุช') {
            const customer = appData.customers.find(c => c.id === invoice.customerId);
            clientName = customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ';
        } else {
            const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
            clientName = supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ';
        }

        if (!clientGroups[clientName]) {
            clientGroups[clientName] = { count: 0, amount: 0 };
        }
        clientGroups[clientName].count++;
        clientGroups[clientName].amount += invoice.totalAmount || 0;
    });

    const data = [
        [`ููุฎุต ุชูุฑูุฑ ููุงุชูุฑ ${type}`],
        [''],
        ['ูุนูููุงุช ุนุงูุฉ'],
        ['ูุชุฑุฉ ุงูุชูุฑูุฑ', `ูู ${fromDate || 'ุงูุจุฏุงูุฉ'} ุฅูู ${toDate || 'ุงูููุงูุฉ'}`],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูููุงุชูุฑ', totalInvoices],
        ['ุฅุฌูุงูู ุงููุจูุบ', totalAmount],
        ['ุฅุฌูุงูู ุงููุฏููุน', totalPaid],
        ['ุฅุฌูุงูู ุงููุชุจูู', totalRemaining],
        ['ุฅุฌูุงูู ุงูุฎุตููุงุช', totalDiscount],
        ['ุฅุฌูุงูู ุงูุถุฑุงุฆุจ', totalTax],
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ุงูุญุงูุฉ'],
        ['ุงูุญุงูุฉ', 'ุนุฏุฏ ุงูููุงุชูุฑ', 'ุงููุจูุบ']
    ];

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุญุงูุงุช
    Object.keys(statusGroups).forEach(status => {
        const group = statusGroups[status];
        data.push([
            status,
            group.count,
            group.amount
        ]);
    });

    data.push(['']);
    data.push([`ุงูุชูุฒูุน ุญุณุจ ${type === 'ุงููุจูุนุงุช' ? 'ุงูุนููุงุก' : 'ุงูููุฑุฏูู'}`]);
    data.push([type === 'ุงููุจูุนุงุช' ? 'ุงูุนููู' : 'ุงูููุฑุฏ', 'ุนุฏุฏ ุงูููุงุชูุฑ', 'ุงููุจูุบ']);

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุนููุงุก/ุงูููุฑุฏูู
    Object.keys(clientGroups).forEach(client => {
        const group = clientGroups[client];
        data.push([
            client,
            group.count,
            group.amount
        ]);
    });

    data.push(['']);
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
 */
function createInvoiceItemsSheet(invoices, type) {
    const headers = [
        'ุฑูู ุงููุงุชูุฑุฉ',
        'ุงูุชุงุฑูุฎ',
        type === 'ุงููุจูุนุงุช' ? 'ุงูุนููู' : 'ุงูููุฑุฏ',
        'ููุฏ ุงูุตูู',
        'ุงุณู ุงูุตูู',
        'ุงููููุฉ',
        'ุงููุญุฏุฉ',
        'ุณุนุฑ ุงููุญุฏุฉ',
        'ุงููุฌููุน'
    ];

    const data = [];

    invoices.forEach(invoice => {
        let clientName = 'ุบูุฑ ูุญุฏุฏ';
        if (type === 'ุงููุจูุนุงุช') {
            const customer = appData.customers.find(c => c.id === invoice.customerId);
            clientName = customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ';
        } else {
            const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
            clientName = supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ';
        }

        if (invoice.items && invoice.items.length > 0) {
            invoice.items.forEach(item => {
                const product = appData.products.find(p => p.id === item.productId);
                data.push([
                    invoice.invoiceNumber,
                    invoice.invoiceDate,
                    clientName,
                    product ? product.code : 'ุบูุฑ ูุญุฏุฏ',
                    product ? product.name : 'ุบูุฑ ูุญุฏุฏ',
                    item.quantity,
                    product ? product.unit : '',
                    item.unitPrice,
                    item.totalAmount || (item.quantity * item.unitPrice)
                ]);
            });
        }
    });

    // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    const totalQuantity = data.reduce((sum, row) => sum + (row[5] || 0), 0);
    const totalAmount = data.reduce((sum, row) => sum + (row[8] || 0), 0);

    // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
    data.push([
        '',
        '',
        'ุงูุฅุฌูุงููุงุช',
        '',
        '',
        totalQuantity,
        '',
        '',
        totalAmount
    ]);

    const worksheet = createFormattedWorksheet(headers, data, `ุชูุงุตูู ุฃุตูุงู ${type}`);
    return worksheet;
}

/**
 * ุชุตุฏูุฑ ุงูุฃุตูุงู ุฅูู Excel
 */
function exportProductsToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุงูุฃุตูุงู ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุงูุญุตูู ุนูู ุงูููุงุชุฑ ุงููุทุจูุฉ
        const searchText = document.getElementById('productSearch')?.value.toLowerCase() || '';
        const categoryFilter = document.getElementById('productCategoryFilter')?.value || '';
        const warehouseFilter = document.getElementById('productWarehouseFilter')?.value || '';
        const stockFilter = document.getElementById('productStockFilter')?.value || '';

        // ููุชุฑุฉ ุงูุฃุตูุงู
        let products = appData.products;

        if (searchText) {
            products = products.filter(product => {
                const name = product.name.toLowerCase();
                const code = product.code.toLowerCase();
                const description = (product.description || '').toLowerCase();
                return name.includes(searchText) || code.includes(searchText) || description.includes(searchText);
            });
        }

        if (categoryFilter) {
            products = products.filter(product => product.category === categoryFilter);
        }

        if (warehouseFilter) {
            products = products.filter(product => product.warehouseId == warehouseFilter);
        }

        if (stockFilter) {
            products = products.filter(product => {
                const quantity = product.quantity || 0;
                const minQuantity = product.minQuantity || 0;
                switch (stockFilter) {
                    case 'low': return quantity <= minQuantity && quantity > 0;
                    case 'normal': return quantity > minQuantity;
                    case 'out': return quantity === 0;
                    default: return true;
                }
            });
        }

        if (products.length === 0) {
            alert('ูุง ุชูุฌุฏ ุฃุตูุงู ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ');
            return;
        }

        // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
        const headers = [
            'ููุฏ ุงูุตูู',
            'ุงุณู ุงูุตูู',
            'ุงููุตู',
            'ุงููุฆุฉ',
            'ุงููุฎุฒู',
            'ุงููุญุฏุฉ',
            'ุณุนุฑ ุงูุชูููุฉ',
            'ุณุนุฑ ุงูุจูุน',
            'ุงููููุฉ ุงูุญุงููุฉ',
            'ุงูุญุฏ ุงูุฃุฏูู',
            'ูููุฉ ุงููุฎุฒูู',
            'ูุงูุด ุงูุฑุจุญ %',
            'ุญุงูุฉ ุงููุฎุฒูู'
        ];

        const data = products.map(product => {
            const warehouse = appData.warehouses.find(w => w.id === product.warehouseId);
            const stockValue = product.quantity * product.costPrice;
            const profitMargin = product.sellingPrice > 0 ?
                ((product.sellingPrice - product.costPrice) / product.sellingPrice * 100).toFixed(2) : 0;
            const isLowStock = product.quantity <= product.minQuantity;
            const stockStatus = product.quantity === 0 ? 'ููุฏ ุงููุฎุฒูู' :
                               isLowStock ? 'ูุฎุฒูู ููุฎูุถ' : 'ูุฎุฒูู ุขูู';

            return [
                product.code,
                product.name,
                product.description || '',
                product.category || '',
                warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ',
                product.unit,
                product.costPrice,
                product.sellingPrice,
                product.quantity,
                product.minQuantity,
                stockValue,
                profitMargin,
                stockStatus
            ];
        });

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
        const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.costPrice), 0);
        const lowStockCount = products.filter(p => p.quantity <= p.minQuantity).length;
        const outOfStockCount = products.filter(p => p.quantity === 0).length;

        // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงููุงุช
        data.push([
            '',
            'ุงูุฅุฌูุงููุงุช',
            '',
            '',
            '',
            '',
            '',
            '',
            totalQuantity,
            '',
            totalValue,
            '',
            `ููุฎูุถ: ${lowStockCount} | ููุฏ: ${outOfStockCount}`
        ]);

        // ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
        const worksheet = createFormattedWorksheet(headers, data, 'ูุงุฆูุฉ ุงูุฃุตูุงู');

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ุงูุฃุตูุงู');

        // ุฅุถุงูุฉ ูุฑูุฉ ุงูููุฎุต
        const summarySheet = createProductsSummarySheet(products);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ููุฎุต ุงูุฃุตูุงู');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุฆูุฉ_ุงูุฃุตูุงู_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุงูุฃุตูุงู ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุงูุฃุตูุงู ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุฃุตูุงู ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ููุฎุต ุงูุฃุตูุงู
 */
function createProductsSummarySheet(products) {
    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
    const totalProducts = products.length;
    const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.costPrice), 0);
    const lowStockCount = products.filter(p => p.quantity <= p.minQuantity).length;
    const outOfStockCount = products.filter(p => p.quantity === 0).length;
    const normalStockCount = products.filter(p => p.quantity > p.minQuantity).length;

    // ุชุฌููุน ุญุณุจ ุงููุฆุฉ
    const categoryGroups = {};
    products.forEach(product => {
        const category = product.category || 'ุจุฏูู ูุฆุฉ';
        if (!categoryGroups[category]) {
            categoryGroups[category] = { count: 0, value: 0 };
        }
        categoryGroups[category].count++;
        categoryGroups[category].value += product.quantity * product.costPrice;
    });

    // ุชุฌููุน ุญุณุจ ุงููุฎุฒู
    const warehouseGroups = {};
    products.forEach(product => {
        const warehouse = appData.warehouses.find(w => w.id === product.warehouseId);
        const warehouseName = warehouse ? warehouse.name : 'ุบูุฑ ูุญุฏุฏ';
        if (!warehouseGroups[warehouseName]) {
            warehouseGroups[warehouseName] = { count: 0, value: 0 };
        }
        warehouseGroups[warehouseName].count++;
        warehouseGroups[warehouseName].value += product.quantity * product.costPrice;
    });

    const data = [
        ['ููุฎุต ุชูุฑูุฑ ุงูุฃุตูุงู'],
        [''],
        ['ูุนูููุงุช ุนุงูุฉ'],
        ['ุฅุฌูุงูู ุนุฏุฏ ุงูุฃุตูุงู', totalProducts],
        ['ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู', totalValue],
        ['ุฃุตูุงู ุจูุฎุฒูู ุขูู', normalStockCount],
        ['ุฃุตูุงู ุจูุฎุฒูู ููุฎูุถ', lowStockCount],
        ['ุฃุตูุงู ููุฏ ูุฎุฒูููุง', outOfStockCount],
        [''],
        ['ุงูุชูุฒูุน ุญุณุจ ุงููุฆุฉ'],
        ['ุงููุฆุฉ', 'ุนุฏุฏ ุงูุฃุตูุงู', 'ูููุฉ ุงููุฎุฒูู']
    ];

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงููุฆุงุช
    Object.keys(categoryGroups).forEach(category => {
        const group = categoryGroups[category];
        data.push([
            category,
            group.count,
            group.value
        ]);
    });

    data.push(['']);
    data.push(['ุงูุชูุฒูุน ุญุณุจ ุงููุฎุฒู']);
    data.push(['ุงููุฎุฒู', 'ุนุฏุฏ ุงูุฃุตูุงู', 'ูููุฉ ุงููุฎุฒูู']);

    // ุฅุถุงูุฉ ุจูุงูุงุช ุงููุฎุงุฒู
    Object.keys(warehouseGroups).forEach(warehouse => {
        const group = warehouseGroups[warehouse];
        data.push([
            warehouse,
            group.count,
            group.value
        ]);
    });

    data.push(['']);
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ (ุงูุนุงุฏูุฉ) ุฅูู Excel
 */
function exportCurrentInvoiceToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ูู ุงููููุฐุฌ
        const invoiceData = collectCurrentInvoiceData();

        if (!invoiceData) {
            alert('ูุฑุฌู ููุก ุจูุงูุงุช ุงููุงุชูุฑุฉ ุฃููุงู');
            return;
        }

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();

        // ูุฑูุฉ ุจูุงูุงุช ุงููุงุชูุฑุฉ
        const invoiceSheet = createCurrentInvoiceSheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, invoiceSheet, 'ุจูุงูุงุช ุงููุงุชูุฑุฉ');

        // ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
        const itemsSheet = createCurrentInvoiceItemsSheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, itemsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');

        // ูุฑูุฉ ุงูููุฎุต ุงููุงูู
        const summarySheet = createCurrentInvoiceSummarySheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต ุงููุงูู');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุชูุฑุฉ_${invoiceData.type === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุญุงููุฉ ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุงูุญุงููุฉ ุฅูู Excel
 */
function exportCurrentCustomInvoiceToExcel() {
    console.log('๐ ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุงูุญุงููุฉ ุฅูู Excel...');

    try {
        if (typeof XLSX === 'undefined') {
            alert('ููุชุจุฉ Excel ุบูุฑ ูุชููุฑุฉ. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.');
            return;
        }

        // ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ูู ุงููููุฐุฌ
        const invoiceData = collectCurrentCustomInvoiceData();

        if (!invoiceData) {
            alert('ูุฑุฌู ููุก ุจูุงูุงุช ุงููุงุชูุฑุฉ ุฃููุงู');
            return;
        }

        // ุฅูุดุงุก ุงููุตูู
        const workbook = XLSX.utils.book_new();

        // ูุฑูุฉ ุจูุงูุงุช ุงููุงุชูุฑุฉ
        const invoiceSheet = createCurrentCustomInvoiceSheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, invoiceSheet, 'ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ');

        // ูุฑูุฉ ุชูุงุตูู ุงูุฃุตูุงู
        const itemsSheet = createCurrentCustomInvoiceItemsSheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, itemsSheet, 'ุชูุงุตูู ุงูุฃุตูุงู');

        // ูุฑูุฉ ุงูููุฎุต ุงููุงูู
        const summarySheet = createCurrentCustomInvoiceSummarySheet(invoiceData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ุงูููุฎุต ุงููุงูู');

        // ุญูุธ ุงูููู
        const fileName = `ูุงุชูุฑุฉ_ุฎุงุตุฉ_${invoiceData.type === 'sale' ? 'ูุจูุนุงุช' : 'ูุดุชุฑูุงุช'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);

        console.log('โ ุชู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุงูุญุงููุฉ ุฅูู Excel ุจูุฌุงุญ');
        showSuccessToast('ุชู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุฅูู Excel ุจูุฌุงุญ!');

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุงูุญุงููุฉ ุฅูู Excel:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ Excel: ' + error.message);
    }
}

/**
 * ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุนุงุฏูุฉ ุงูุญุงููุฉ ูู ุงููููุฐุฌ
 */
function collectCurrentInvoiceData() {
    try {
        const invoiceType = document.getElementById('invoiceType')?.value;
        const clientId = document.getElementById('clientSelect')?.value;
        const invoiceDate = document.getElementById('invoiceDate')?.value;
        const dueDate = document.getElementById('dueDate')?.value;
        const notes = document.getElementById('invoiceNotes')?.value || '';

        if (!invoiceType || !clientId || !invoiceDate) {
            return null;
        }

        // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
        let client = null;
        if (invoiceType === 'sale') {
            client = appData.customers.find(c => c.id == clientId);
        } else {
            client = appData.suppliers.find(s => s.id == clientId);
        }

        if (!client) {
            return null;
        }

        // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ
        const items = [];
        const itemsTable = document.getElementById('invoiceItemsTable');
        if (itemsTable) {
            const rows = itemsTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const productSelect = cells[0].querySelector('select');
                    const quantityInput = cells[1].querySelector('input');
                    const priceInput = cells[2].querySelector('input');

                    if (productSelect && quantityInput && priceInput) {
                        const productId = productSelect.value;
                        const product = appData.products.find(p => p.id == productId);

                        if (product && quantityInput.value && priceInput.value) {
                            items.push({
                                productId: productId,
                                productName: product.name,
                                productCode: product.code || '',
                                quantity: parseFloat(quantityInput.value) || 0,
                                price: parseFloat(priceInput.value) || 0,
                                total: (parseFloat(quantityInput.value) || 0) * (parseFloat(priceInput.value) || 0),
                                unit: product.unit || 'ูุทุนุฉ'
                            });
                        }
                    }
                }
            });
        }

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const subtotal = items.reduce((sum, item) => sum + item.total, 0);
        const discountPercentage = parseFloat(document.getElementById('discountPercentage')?.value) || 0;
        const taxPercentage = parseFloat(document.getElementById('taxPercentage')?.value) || 0;

        const discountAmount = (subtotal * discountPercentage) / 100;
        const taxAmount = ((subtotal - discountAmount) * taxPercentage) / 100;
        const totalAmount = subtotal - discountAmount + taxAmount;

        return {
            type: invoiceType,
            client: client,
            date: invoiceDate,
            dueDate: dueDate,
            notes: notes,
            items: items,
            subtotal: subtotal,
            discountPercentage: discountPercentage,
            discountAmount: discountAmount,
            taxPercentage: taxPercentage,
            taxAmount: taxAmount,
            totalAmount: totalAmount
        };

    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ:', error);
        return null;
    }
}

/**
 * ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ ุงูุญุงููุฉ ูู ุงููููุฐุฌ
 */
function collectCurrentCustomInvoiceData() {
    try {
        const invoiceType = document.getElementById('customInvoiceType')?.value;
        const clientType = document.getElementById('customClientType')?.value;
        const invoiceDate = document.getElementById('customInvoiceDate')?.value;
        const dueDate = document.getElementById('customDueDate')?.value;
        const notes = document.getElementById('customInvoiceNotes')?.value || '';
        const currency = document.getElementById('customCurrency')?.value || 'SYP';

        if (!invoiceType || !clientType || !invoiceDate) {
            return null;
        }

        // ุฌูุน ุจูุงูุงุช ุงูุนููู/ุงูููุฑุฏ
        let client = {};
        if (clientType === 'existing') {
            const clientId = document.getElementById('customExistingClient')?.value;
            if (invoiceType === 'sale') {
                client = appData.customers.find(c => c.id == clientId) || {};
            } else {
                client = appData.suppliers.find(s => s.id == clientId) || {};
            }
        } else {
            // ุนููู ุฌุฏูุฏ
            client = {
                name: document.getElementById('customClientName')?.value || '',
                phone: document.getElementById('customClientPhone')?.value || '',
                email: document.getElementById('customClientEmail')?.value || '',
                address: document.getElementById('customClientAddress')?.value || ''
            };
        }

        // ุฌูุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ
        const items = [];
        const itemsTable = document.getElementById('customInvoiceItemsTable');
        if (itemsTable) {
            const rows = itemsTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const nameInput = cells[0].querySelector('input');
                    const quantityInput = cells[1].querySelector('input');
                    const priceInput = cells[2].querySelector('input');
                    const unitInput = cells[3].querySelector('input');

                    if (nameInput && quantityInput && priceInput && nameInput.value) {
                        items.push({
                            productName: nameInput.value,
                            quantity: parseFloat(quantityInput.value) || 0,
                            price: parseFloat(priceInput.value) || 0,
                            total: (parseFloat(quantityInput.value) || 0) * (parseFloat(priceInput.value) || 0),
                            unit: unitInput?.value || 'ูุทุนุฉ'
                        });
                    }
                }
            });
        }

        // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        const subtotal = items.reduce((sum, item) => sum + item.total, 0);
        const discountPercentage = parseFloat(document.getElementById('customDiscountPercentage')?.value) || 0;
        const taxPercentage = parseFloat(document.getElementById('customTaxPercentage')?.value) || 0;

        const discountAmount = (subtotal * discountPercentage) / 100;
        const taxAmount = ((subtotal - discountAmount) * taxPercentage) / 100;
        const totalAmount = subtotal - discountAmount + taxAmount;

        return {
            type: invoiceType,
            client: client,
            clientType: clientType,
            date: invoiceDate,
            dueDate: dueDate,
            notes: notes,
            currency: currency,
            items: items,
            subtotal: subtotal,
            discountPercentage: discountPercentage,
            discountAmount: discountAmount,
            taxPercentage: taxPercentage,
            taxAmount: taxAmount,
            totalAmount: totalAmount
        };

    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุน ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ:', error);
        return null;
    }
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุนุงุฏูุฉ
 */
function createCurrentInvoiceSheet(invoiceData) {
    const data = [];

    // ุงูุนููุงู
    data.push(['ุจูุงูุงุช ุงููุงุชูุฑุฉ']);
    data.push(['']);

    // ูุนูููุงุช ุงููุงุชูุฑุฉ
    data.push(['ููุน ุงููุงุชูุฑุฉ', invoiceData.type === 'sale' ? 'ูุงุชูุฑุฉ ูุจูุนุงุช' : 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช']);
    data.push(['ุงูุชุงุฑูุฎ', formatDate(invoiceData.date)]);
    data.push(['ุชุงุฑูุฎ ุงูุงุณุชุญูุงู', formatDate(invoiceData.dueDate)]);
    data.push(['']);

    // ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ
    data.push([invoiceData.type === 'sale' ? 'ุจูุงูุงุช ุงูุนููู' : 'ุจูุงูุงุช ุงูููุฑุฏ']);
    data.push(['ุงูุงุณู', invoiceData.client.name || '']);
    data.push(['ุงููุงุชู', invoiceData.client.phone || '']);
    data.push(['ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', invoiceData.client.email || '']);
    data.push(['ุงูุนููุงู', invoiceData.client.address || '']);
    data.push(['']);

    // ุงูููุฎุต ุงููุงูู
    data.push(['ุงูููุฎุต ุงููุงูู']);
    data.push(['ุงููุฌููุน ุงููุฑุนู', formatCurrency(invoiceData.subtotal)]);
    data.push(['ูุณุจุฉ ุงูุฎุตู (%)', invoiceData.discountPercentage]);
    data.push(['ูุจูุบ ุงูุฎุตู', formatCurrency(invoiceData.discountAmount)]);
    data.push(['ูุณุจุฉ ุงูุถุฑูุจุฉ (%)', invoiceData.taxPercentage]);
    data.push(['ูุจูุบ ุงูุถุฑูุจุฉ', formatCurrency(invoiceData.taxAmount)]);
    data.push(['ุงููุฌููุน ุงูููุงุฆู', formatCurrency(invoiceData.totalAmount)]);
    data.push(['']);

    // ุงูููุงุญุธุงุช
    if (invoiceData.notes) {
        data.push(['ุงูููุงุญุธุงุช', invoiceData.notes]);
        data.push(['']);
    }

    // ูุนูููุงุช ุงูุชุตุฏูุฑ
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 30 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุชูุงุตูู ุฃุตูุงู ุงููุงุชูุฑุฉ ุงูุนุงุฏูุฉ
 */
function createCurrentInvoiceItemsSheet(invoiceData) {
    const headers = ['ุงุณู ุงูุตูู', 'ููุฏ ุงูุตูู', 'ุงููููุฉ', 'ุงููุญุฏุฉ', 'ุณุนุฑ ุงููุญุฏุฉ', 'ุงููุฌููุน'];
    const data = [headers];

    invoiceData.items.forEach(item => {
        data.push([
            item.productName,
            item.productCode || '',
            item.quantity,
            item.unit,
            formatCurrency(item.price),
            formatCurrency(item.total)
        ]);
    });

    // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงูู
    data.push(['']);
    data.push(['', '', '', '', 'ุงูุฅุฌูุงูู:', formatCurrency(invoiceData.subtotal)]);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [
        { wch: 25 }, // ุงุณู ุงูุตูู
        { wch: 15 }, // ููุฏ ุงูุตูู
        { wch: 10 }, // ุงููููุฉ
        { wch: 10 }, // ุงููุญุฏุฉ
        { wch: 15 }, // ุณุนุฑ ุงููุญุฏุฉ
        { wch: 15 }  // ุงููุฌููุน
    ];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุงูููุฎุต ุงููุงูู ูููุงุชูุฑุฉ ุงูุนุงุฏูุฉ
 */
function createCurrentInvoiceSummarySheet(invoiceData) {
    const data = [];

    data.push(['ุงูููุฎุต ุงููุงูู ูููุงุชูุฑุฉ']);
    data.push(['']);

    data.push(['ุงูุจูุงู', 'ุงููููุฉ']);
    data.push(['ุนุฏุฏ ุงูุฃุตูุงู', invoiceData.items.length]);
    data.push(['ุฅุฌูุงูู ุงููููุฉ', invoiceData.items.reduce((sum, item) => sum + item.quantity, 0)]);
    data.push(['ุงููุฌููุน ุงููุฑุนู', formatCurrency(invoiceData.subtotal)]);
    data.push(['ูุณุจุฉ ุงูุฎุตู', invoiceData.discountPercentage + '%']);
    data.push(['ูุจูุบ ุงูุฎุตู', formatCurrency(invoiceData.discountAmount)]);
    data.push(['ุงููุฌููุน ุจุนุฏ ุงูุฎุตู', formatCurrency(invoiceData.subtotal - invoiceData.discountAmount)]);
    data.push(['ูุณุจุฉ ุงูุถุฑูุจุฉ', invoiceData.taxPercentage + '%']);
    data.push(['ูุจูุบ ุงูุถุฑูุจุฉ', formatCurrency(invoiceData.taxAmount)]);
    data.push(['ุงููุฌููุน ุงูููุงุฆู', formatCurrency(invoiceData.totalAmount)]);
    data.push(['']);

    // ุชุญููู ุงูุฃุตูุงู
    data.push(['ุชุญููู ุงูุฃุตูุงู']);
    data.push(['ุงูุตูู', 'ุงููููุฉ', 'ุงููุณุจุฉ ูู ุงูุฅุฌูุงูู']);

    const totalQuantity = invoiceData.items.reduce((sum, item) => sum + item.quantity, 0);
    invoiceData.items.forEach(item => {
        const percentage = totalQuantity > 0 ? ((item.quantity / totalQuantity) * 100).toFixed(2) : 0;
        data.push([item.productName, item.quantity, percentage + '%']);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function createCurrentCustomInvoiceSheet(invoiceData) {
    const data = [];

    // ุงูุนููุงู
    data.push(['ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ']);
    data.push(['']);

    // ูุนูููุงุช ุงููุงุชูุฑุฉ
    data.push(['ููุน ุงููุงุชูุฑุฉ', invoiceData.type === 'sale' ? 'ูุงุชูุฑุฉ ูุจูุนุงุช ุฎุงุตุฉ' : 'ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฎุงุตุฉ']);
    data.push(['ุงูุชุงุฑูุฎ', formatDate(invoiceData.date)]);
    data.push(['ุชุงุฑูุฎ ุงูุงุณุชุญูุงู', formatDate(invoiceData.dueDate)]);
    data.push(['ุงูุนููุฉ', getCurrencyName(invoiceData.currency)]);
    data.push(['']);

    // ูุนูููุงุช ุงูุนููู/ุงูููุฑุฏ
    data.push([invoiceData.type === 'sale' ? 'ุจูุงูุงุช ุงูุนููู' : 'ุจูุงูุงุช ุงูููุฑุฏ']);
    data.push(['ููุน ุงูุนููู', invoiceData.clientType === 'existing' ? 'ุนููู ููุฌูุฏ' : 'ุนููู ุฌุฏูุฏ']);
    data.push(['ุงูุงุณู', invoiceData.client.name || '']);
    data.push(['ุงููุงุชู', invoiceData.client.phone || '']);
    data.push(['ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', invoiceData.client.email || '']);
    data.push(['ุงูุนููุงู', invoiceData.client.address || '']);
    data.push(['']);

    // ุงูููุฎุต ุงููุงูู
    data.push(['ุงูููุฎุต ุงููุงูู']);
    data.push(['ุงููุฌููุน ุงููุฑุนู', formatCurrency(invoiceData.subtotal) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ูุณุจุฉ ุงูุฎุตู (%)', invoiceData.discountPercentage]);
    data.push(['ูุจูุบ ุงูุฎุตู', formatCurrency(invoiceData.discountAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ูุณุจุฉ ุงูุถุฑูุจุฉ (%)', invoiceData.taxPercentage]);
    data.push(['ูุจูุบ ุงูุถุฑูุจุฉ', formatCurrency(invoiceData.taxAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ุงููุฌููุน ุงูููุงุฆู', formatCurrency(invoiceData.totalAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['']);

    // ุงูููุงุญุธุงุช
    if (invoiceData.notes) {
        data.push(['ุงูููุงุญุธุงุช', invoiceData.notes]);
        data.push(['']);
    }

    // ูุนูููุงุช ุงูุชุตุฏูุฑ
    data.push(['ูุนูููุงุช ุงูุชุตุฏูุฑ']);
    data.push(['ุชุงุฑูุฎ ุงูุชุตุฏูุฑ', new Date().toLocaleDateString('ar-SA')]);
    data.push(['ููุช ุงูุชุตุฏูุฑ', new Date().toLocaleTimeString('ar-SA')]);
    data.push(['ุงููุทูุฑ', 'MOHANNAD AHMAD - SAM PRO']);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 30 }];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุชูุงุตูู ุฃุตูุงู ุงููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function createCurrentCustomInvoiceItemsSheet(invoiceData) {
    const headers = ['ุงุณู ุงูุตูู', 'ุงููููุฉ', 'ุงููุญุฏุฉ', 'ุณุนุฑ ุงููุญุฏุฉ', 'ุงููุฌููุน'];
    const data = [headers];

    invoiceData.items.forEach(item => {
        data.push([
            item.productName,
            item.quantity,
            item.unit,
            formatCurrency(item.price) + ' ' + getCurrencySymbol(invoiceData.currency),
            formatCurrency(item.total) + ' ' + getCurrencySymbol(invoiceData.currency)
        ]);
    });

    // ุฅุถุงูุฉ ุตู ุงูุฅุฌูุงูู
    data.push(['']);
    data.push(['', '', '', 'ุงูุฅุฌูุงูู:', formatCurrency(invoiceData.subtotal) + ' ' + getCurrencySymbol(invoiceData.currency)]);

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [
        { wch: 25 }, // ุงุณู ุงูุตูู
        { wch: 10 }, // ุงููููุฉ
        { wch: 10 }, // ุงููุญุฏุฉ
        { wch: 15 }, // ุณุนุฑ ุงููุญุฏุฉ
        { wch: 15 }  // ุงููุฌููุน
    ];

    return worksheet;
}

/**
 * ุฅูุดุงุก ูุฑูุฉ ุงูููุฎุต ุงููุงูู ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ
 */
function createCurrentCustomInvoiceSummarySheet(invoiceData) {
    const data = [];

    data.push(['ุงูููุฎุต ุงููุงูู ูููุงุชูุฑุฉ ุงูุฎุงุตุฉ']);
    data.push(['']);

    data.push(['ุงูุจูุงู', 'ุงููููุฉ']);
    data.push(['ุงูุนููุฉ', getCurrencyName(invoiceData.currency)]);
    data.push(['ุนุฏุฏ ุงูุฃุตูุงู', invoiceData.items.length]);
    data.push(['ุฅุฌูุงูู ุงููููุฉ', invoiceData.items.reduce((sum, item) => sum + item.quantity, 0)]);
    data.push(['ุงููุฌููุน ุงููุฑุนู', formatCurrency(invoiceData.subtotal) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ูุณุจุฉ ุงูุฎุตู', invoiceData.discountPercentage + '%']);
    data.push(['ูุจูุบ ุงูุฎุตู', formatCurrency(invoiceData.discountAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ุงููุฌููุน ุจุนุฏ ุงูุฎุตู', formatCurrency(invoiceData.subtotal - invoiceData.discountAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ูุณุจุฉ ุงูุถุฑูุจุฉ', invoiceData.taxPercentage + '%']);
    data.push(['ูุจูุบ ุงูุถุฑูุจุฉ', formatCurrency(invoiceData.taxAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['ุงููุฌููุน ุงูููุงุฆู', formatCurrency(invoiceData.totalAmount) + ' ' + getCurrencySymbol(invoiceData.currency)]);
    data.push(['']);

    // ุชุญููู ุงูุฃุตูุงู
    data.push(['ุชุญููู ุงูุฃุตูุงู']);
    data.push(['ุงูุตูู', 'ุงููููุฉ', 'ุงููุณุจุฉ ูู ุงูุฅุฌูุงูู', 'ุงููููุฉ']);

    const totalQuantity = invoiceData.items.reduce((sum, item) => sum + item.quantity, 0);
    const totalValue = invoiceData.items.reduce((sum, item) => sum + item.total, 0);

    invoiceData.items.forEach(item => {
        const quantityPercentage = totalQuantity > 0 ? ((item.quantity / totalQuantity) * 100).toFixed(2) : 0;
        const valuePercentage = totalValue > 0 ? ((item.total / totalValue) * 100).toFixed(2) : 0;
        data.push([
            item.productName,
            item.quantity,
            quantityPercentage + '%',
            valuePercentage + '%'
        ]);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    worksheet['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }, { wch: 15 }];

    return worksheet;
}
